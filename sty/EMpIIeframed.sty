% EMpIIeframed.sty by tDB (emath@nifty.com)
%
\NeedsTeXFormat{LaTeX2e}%
\def\Ps@version{0.14alpha}%
\ProvidesPackage{EMpIIeframed}[2011/12/19 v \Ps@version ]%
%
  \DeclareOption{dvips}{\def\EM@framed@opt{dvips}}%
  \DeclareOption{dvipdfm}{\def\EM@framed@opt{dvipdfm}}%
\IfFileExists{p2e-dvipdfmx.def}{%
  \DeclareOption{dvipdfmx}{\def\em@grdrv{dvipdfmx}\def\pdfmx@{}\def\EM@framed@opt{dvipdfmx}}
}{%
  \DeclareOption{dvipdfmx}{\def\em@grdrv{dvipdfmx}\def\pdfmx@{}\def\EM@framed@opt{dvipdfm}}
}%
  \DeclareOption{tpic}{\def\EMpict@tpic{}}%
  \ProcessOptions\relax
%
\@ifundefined{em@grdrv}{}{\def\EM@framed@opt{\em@grdrv}}%
\@ifundefined{EM@framed@opt}{%
  \errmessage{EMpIIeframed.sty のロードオプションが不適切です。}}{}%
%\@ifundefined{color}{}{%
%  \errmessage{graphic,color のロードは，EMpIIeframed の後で行います}}%
%
\@ifpackageloaded{EMpict2e}{}{%
  \RequirePackage[\EM@framed@opt]{EMpict2e}[2011/04/05]}%
%
\RequirePackage{emathC}
\RequirePackage{EMframed}%
%
  \edef\shade@rule{0pt}%
  \edef\shade@color{\empty}%
%
\define@key{EMframed}{LRonly}[B]{\def\rectbox@LR{#1}}%
\define@key{EMframed}{Lonly}[L]{\def\rectbox@LR{#1}}%
\define@key{EMframed}{Ronly}[R]{\def\rectbox@LR{#1}}%
%\define@key{EMframed}{tpic}[0]{\edef\by@vrule{0}}%
\define@key{EMframed}{rectboxtopsep}{\edef\rectbox@topsep{#1}}%
\define@key{EMframed}{rectboxbottomsep}{\edef\rectbox@bottomsep{#1}}%
\define@key{EMframed}{oval}[10pt]{\edef\rectbox@oval{#1}}%
\define@key{EMframed}{rectboxoval}[10pt]{\edef\rectbox@oval{#1}}%
%\define@key{EMframed}{rectboxoct}[10pt]{\edef\by@vrule{0}\edef\rectbox@oval{#1}\edef\rectbox@oct{#1}}%
%\define@key{EMframed}{rectboxcorner}[1]{\def\rect@corner{}}%
%\define@key{EMframed}{tate}{\edef\rectbox@tate{#1}}%
%\define@key{EMframed}{linewidth}{\edef\default@linewidth{#1}\edef\frame@linewidth{#1}}%
\define@key{EMframed}{linethickness}{\edef\default@linewidth{#1}\edef\frame@linewidth{#1}}%
\define@key{EMframed}{dash}{\edef\rectbox@dash{#1}}%
\define@key{EMframed}{borderwidth}{\edef\border@width{#1}}%
\define@key{EMframed}{item}{\def\rectbox@item{#1}}%
\define@key{EMframed}{preitem}{\def\rectbox@preitem{#1}}%
\define@key{EMframed}{postitem}{\def\rectbox@postitem{#1}}%
\define@key{EMframed}{bitem}{\def\rectbox@bitem{#1}}%
\define@key{EMframed}{prebitem}{\def\rectbox@prebitem{#1}}%
\define@key{EMframed}{postbitem}{\def\rectbox@postbitem{#1}}%
\define@key{EMframed}{pos}{\def\@pos{#1}}%
\define@key{EMframed}{itempos}{\def\rectbox@item@pos{#1}}%
\define@key{EMframed}{bitempos}{\def\rectbox@bitem@pos{#1}}%
\define@key{EMframed}{rectboxparindent}{\edef\rectbox@parindent{#1}}%
\define@key{EMframed}{rectboxwidth}[0pt]{\setlength{\@tempdima}{#1}\edef\rectbox@width{\the\@tempdima}}%
\define@key{EMframed}{rectboxWidth}[0pt]{\setlength{\@tempdima}{#1}\edef\rectbox@Width{\the\@tempdima}}%
%\define@key{EMframed}{AeEnv}{\EMedef\Aeprobname{#1}}%
\define@key{EMframed}{fboxsep}{\setlength\fboxsep{#1}}%
\define@key{EMframed}{hsep}{\def\h@sep{#1}}%
\define@key{EMframed}{tsep}{\def\t@sep{#1}}%
\define@key{EMframed}{bsep}{\def\b@sep{#1}}%
\define@key{EMframed}{vsep}{\def\v@sep{#1}\def\t@sep{#1}\def\b@sep{#1}}%
\define@key{EMframed}{hvsep}{\def\h@sep{#1}\def\v@sep{#1}}%
\define@key{EMframed}{lsep}{\def\l@sep{#1}}%
\define@key{EMframed}{rsep}{\def\r@sep{#1}}%
\define@key{EMframed}{fboxrule}{\setlength\fboxrule{#1}}%
%\define@key{EMframed}{pszoption}{\def\psz@option{#1}}%
%\define@key{EMframed}{waku}[1]{\def\ps@drawwaku{#1}}%
%\define@key{EMframed}{wakuhutosa}[1]{\def\waku@hutosa{#1}}%
%\def\wakusensyu{\drawline}%
%\define@key{EMframed}{sensyu}{\edef\by@vrule{0}\def\wakusensyu{#1}}%
%\define@key{EMframed}{allinethickness}{\allinethickness{#1}}%
%\define@key{EMframed}{linethickness}{\linethickness{#1}}%
\define@key{EMframed}{framelinewidth}{\edef\frame@linewidth{#1}}%
\define@key{EMframed}{framethickness}{\edef\frame@linewidth{#1}}%
\define@key{EMframed}{framecolor}{\def\frame@color{#1}}%
%\define@key{EMframed}{midasibackgroundcolor}{\def\midasi@background@color{#1}}%
\define@key{EMframed}{backgroundcolor}{\edef\background@color{#1}}%
\define@key{EMframed}{bgcolor}{\edef\background@color{#1}}%
%\define@key{EMframed}{liningcolor}{\def\lining@color{#1}}%
%\define@key{EMframed}{henvi}{\def\hen@i{#1}}%
%\define@key{EMframed}{Henvi}{%
% \vecXY{#1}\henv@x\henv@y\ukansan\henv@x\henv@x\ukansan\henv@y\henv@y
%                        \edef\hen@i{(\henv@x,\henv@y)}}%
\define@key{EMframed}{hasenLG}{%
  \edef\hasenLG@opt{#1}%
  \vecXY{(#1)}\@hasen@x\@hasen@y
  \ukansan\@hasen@x\@hasen@x@
  \ukansan\@hasen@y\@hasen@y@
  \setlength{\@tempdima}{\@hasen@x@\unitlength}\edef\@hasen@L{\the\@tempdima}%
  \setlength{\@tempdima}{\@hasen@y@\unitlength}\edef\@hasen@G{\the\@tempdima}%
%  \edef\hasen@opt{[\@hasen@x@][\@hasen@y@]}%
%\ifnum\EMps@mode=\@ne
%  \setdash{#1}%
%\else
%  \let\sensyu\hasen
%\fi
}%
%
\define@key{EMframed}{gradbegin}{\edef\grad@begin{#1}}%
\define@key{EMframed}{gradend}{\edef\grad@end{#1}}%
\define@key{EMframed}{gradangle}{\edef\grad@angle{#1}}%
\define@key{EMframed}{gradN}{\edef\grad@N{#1}}%
\define@key{EMframed}{gradF}{\edef\grad@F{#1}}%
%
%\define@key{EMframed}{mekurex}{\def\mekure@x{#1}}%
%\define@key{EMframed}{mekurey}{\def\mekure@y{#1}}%
%\define@key{EMframed}{mekurez}{\def\mekure@z{#1}}%
%\define@key{EMframed}{mekured}{\def\mekure@d{#1}}%
%\define@key{EMframed}{debeso}[1]{\def\rectbox@debeso{#1}}%
%\define@key{EMframed}{kagi}[3pt]{%\edef\by@vrule{0}%
%  \def\rectbox@kagi{#1}}%
%
%\define@key{EMframed}{brace}{\def\LB@lbrace{#1}%
%  \if (#1\def\LB@rbrace{)}%
%  \else\if [#1\def\LB@rbrace{]}%
%  \else\if |#1\def\LB@rbrace{|}%
%  \fi\fi\fi
%}%
%\define@key{EMframed}{prestr}{\def\pre@str{#1}}%
\define@key{EMframed}{framecmd}{\def\frame@cmd{#1}}%
%
%
% このスタイルファイルは，下の framed.sty を拡張したものです。
%
% framed.sty   v 0.8a   21-Jul-2003
% Copyright (C) 1992-2003 by Donald Arseneau
% These macros may be freely transmitted, reproduced, or modified
% provided that this notice is left intact.
% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Create framed or shaded regions that can break across pages using 
% \begin{framed} ... \end{framed}    -- ordinary frame box (box at margin)
% \begin{shaded} ... \end{shaded}    -- shaded background (into margin)
%    ... leftbar ...                 -- line on left side
% \begin{MakeFramed}{settings} ... \end{MakeFramed}
%                        -- generic frame (for new environments)
%
% The "framed" environment puts the text into "\fbox" with the
% settings "\fboxrule=\FrameRule" and "\fboxsep=\FrameSep".
% You can change these lengths (using "\setlength") and you
% can even change the definition of "\emFrameCommand" to use
% much fancier boxes.
%
% In fact, the "shaded" environment just redefines "\emFrameCommand"
% to use "\colorbox{shadecolor}" (and you have to define the
% color "shadecolor": \newcolor{shadecolor}...).
%
% A page break is allowed, and even encouraged, before the framed
% environment.  If you want to attach some text (a box title) to the
% frame, then the text should be inserted by \emFrameCommand
%
% The contents of the framed regions are restricted: 
% Floats, footnotes, marginpars and head-line entries will be lost.
% (Some of these may be handled in a later version.)
% This package will not work with the page breaking of multicol.sty,
% or other systems that perform column-balancing.
%
% The MakeFramed environment does the work.  Its "settings" argument
% should contain any adjustments to the text width (applied to \hsize,
% and using the "\width" of the frame itself) as well as a `restore' 
% command -- \@parboxrestore or \emFrameRestore or something similar.
% 
% Expert commands:
% \MakeFramed, \endMakeFramed: the "MakeFramed" environment
% \emFrameCommand: command to draw the frame around its argument
% \emFrameRestore: restore some text settings, but fewer than \@parboxrestore
% \FrameRule: length register; \fboxrule for default "framed".
% \FrameSep: length register; \fboxsep for default "framed".
% \FrameHeightAdjust: macro; height of frame above baseline at top of page
% 
% This is still a `pre-production' version because I can think of many
% features/improvements that should be made.  Nevertheless, starting 
% with version 0.5 it should be bug-free.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\ProvidesPackage{framed}[2003/07/21 v 0.8a: 
%   framed or shaded text with page breaks]
%
%\newenvironment{framed}% using default \emFrameCommand
%  {\edef\framed@page{0}\MakeFramed {\advance\hsize-\width \emFrameRestore}}%
%  {\endMakeFramed}
\def\rectboxparindent#1{\edef\rectbox@parindent@{#1}}%
\edef\rectbox@parindent@{0pt}%
\edef\rectbox@oval@{0pt}%
%
%\def\EMpIIeframed{%
\DeclareRobustCommand\EMpIIeframed{%
  \hsize=\linewidth
  \@ifnextchar[{\@EMpIIeframed}{\@EMpIIeframed[\empty]}}%
\def\@EMpIIeframed[#1]{%
  \edef\h@sep{\empty}%
  \edef\v@sep{\empty}%
  \edef\t@sep{\empty}%
  \edef\b@sep{\empty}%
  \edef\rectbox@item{\empty}%
  \edef\rectbox@bitem{\empty}%
  \edef\fbox@dash{}%
  \edef\rectbox@parindent{\rectbox@parindent@}%
  \topsep=\z@
%
  \ifx\empty #1\else\setkeys{EMframed}{#1}\fi
%
  \@ifundefined{frame@cmd}{%
    \@ifundefined{emFrameCommand}{%
%      \def\emFrameCommand{\EMpIIefbox<#1>}%
      \def\emFrameCommand{\expandafter\EMpIIefbox\emFrameCommand@opt}%
    }{}%
  }{%
    \frame@cmd
  }%
%
  \ifthenelse{\equal\h@sep\empty}{%
    \ifthenelse{\lengthtest{\rectbox@oval<\default@hsep}}{%
      \edef\h@sep{\default@hsep}}{\edef\h@sep{\rectbox@oval}}}{}%
  \ifthenelse{\equal\v@sep\empty}{%
    \ifthenelse{\lengthtest{\rectbox@oval<\default@vsep}}{%
      \edef\v@sep{\default@vsep}}{\edef\v@sep{\rectbox@oval}}}{}%
  \ifx\empty\t@sep\edef\t@sep{\v@sep}\fi
  \ifx\empty\b@sep\edef\b@sep{\v@sep}\fi
  \ifthenelse{\equal\rectbox@item\empty}{\def\item@ht{0pt}}{%
    \setbox\rectb@x=\hbox{\rectbox@item}%
    \edef\item@w{\strip@pt\wd\rectb@x}%
    \@Div\item@w{2}\item@w@half
    \@tempdima=\ht\rectb@x\advance\@tempdima\dp\rectb@x
    \divide\@tempdima\tw@
    \edef\item@ht{\the\@tempdima}%
  }%
  \ifthenelse{\equal\rectbox@bitem\empty}{\def\bitem@ht{0pt}}{%
    \setbox\rectb@x=\hbox{\rectbox@bitem}%
    \edef\bitem@w{\strip@pt\wd\rectb@x}%
    \@Div\bitem@w{2}\bitem@w@half
    \@tempdima=\ht\rectb@x\advance\@tempdima\dp\rectb@x
    \divide\@tempdima\tw@
    \edef\bitem@ht{\the\@tempdima}%
  }%
  \edef\framed@page{0}%
  \edef\emFrameCommand@opt{<hsep=\h@sep,vsep=\v@sep}%
  \ifx\empty #1\else\EMedefappend\emFrameCommand@opt{,#1}\fi
  \EMedefappend\emFrameCommand@opt{>}%
  \EMMakeframed {\advance\hsize-\width \emFrameRestore}}%
\def\endEMpIIeframed{\endEMMakeframed}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% \EMpIIefbox
%
\@ifundefined{ps@box}{\newbox\ps@box}{}%
\@ifundefined{psfboxW}{\newdimen\psfboxW}{}%
\@ifundefined{psfboxV}{\newdimen\psfboxV}{}%
%
%
%
%\def\EMpIIefbox{%
\DeclareRobustCommand\EMpIIefbox{%
  \@ifnextchar<{\@EMpIIefbox}{\@EMpIIefbox<\empty>}}%
\def\@EMpIIefbox<#1>#2{{%\gsave
  \setlength{\unitlength}{1pt}%
  \@ifundefined{xunitlength}{}{\setlength{\xunitlength}{1pt}}%
  \@ifundefined{yunitlength}{}{\setlength{\yunitlength}{1pt}}%
  \edef\frame@linewidth{.4pt}%
  \edef\rectbox@oval{0pt}%
  \edef\rectbox@dash{\empty}%
  \edef\hasenLG@opt{\empty}%
  \edef\rectbox@dash{\empty}%
  \edef\h@sep{\the\fboxsep}%
  \edef\v@sep{\the\fboxsep}%
  \edef\l@sep{\empty}%
  \edef\r@sep{\empty}%
  \edef\t@sep{\empty}%
  \edef\b@sep{\empty}%
  \edef\rectbox@Width{\empty}%
  \edef\rectbox@item{\empty}%
  \edef\rectbox@preitem{\empty}%
  \edef\rectbox@postitem{\empty}%
  \def\rectbox@item@pos{l}%
  \edef\rectbox@bitem{\empty}%
  \edef\rectbox@prebitem{\empty}%
  \edef\rectbox@postbitem{\empty}%
  \def\rectbox@bitem@pos{r}%
%
  \setbox\ps@box=\hbox{#2}%
%
  \@ifundefined{not@T}{}{%
    \@tempdima\ht\ps@box\advance\@tempdima \v@yohaku
    \ht\ps@box=\@tempdima
  }%
  \@ifundefined{not@B}{}{%
    \@tempdima\dp\ps@box\advance\@tempdima \v@yohaku
    \dp\ps@box=\@tempdima
  }%
%
  \edef\rectbox@width{\the\wd\ps@box}%
  \edef\fb@h{\strip@pt\ht\ps@box}%
  \edef\fb@d{\strip@pt\dp\ps@box}%
  \edef\background@color{\empty}%
  \edef\frame@color{\empty}%
  \edef\shade@color{\empty}%
  \edef\rectbox@LR{Z}%
%
  \edef\grad@angle{90}%
  \edef\grad@N{10}%
  \edef\grad@begin{\empty}%
  \edef\grad@end{\empty}%
  \def\grad@borderwidth{0pt}%
  \edef\fb@dLT{(0,0)}%
  \edef\fb@dLB{(0,0)}%
  \edef\fb@dRT{(0,0)}%
  \edef\fb@dRB{(0,0)}%
%
  \ifx\empty #1\else\setkeys{EMframed}{#1}\fi
  \@tempdima\shade@rule
  \edef\shade@w{\strip@pt\@tempdima}%
  \@Div\shade@w{2}\shade@hw
%
  \ifx\empty\t@sep\edef\t@sep{\v@sep}\fi
  \ifx\empty\b@sep\edef\b@sep{\v@sep}\fi
  \ifx\empty\l@sep\edef\l@sep{\h@sep}\fi
  \ifx\empty\r@sep\edef\r@sep{\h@sep}\fi
%  \@ifundefined{rectbox@LR}{}{%
    \if L\rectbox@LR
      \edef\r@sep{0pt}%
    \else\if R\rectbox@LR
      \edef\l@sep{0pt}%
    \fi\fi
%  }{}%
  \ifx\empty\rectbox@Width\else
    \@tempdima\rectbox@Width
    \advance\@tempdima-\frame@linewidth
    \advance\@tempdima-\frame@linewidth
    \advance\@tempdima-\l@sep
    \advance\@tempdima-\rectbox@width
    \edef\r@sep{\the\@tempdima}%
  \fi
%
  \ifthenelse{\equal\rectbox@item\empty}{\def\item@ht{0pt}}{%
    \setbox\rectbox@item@box=\hbox{%
      \rectbox@preitem\rectbox@item\rectbox@postitem}%
    \@tempdima=\ht\rectbox@item@box\advance\@tempdima\dp\rectbox@item@box
    \divide\@tempdima\tw@
    \edef\item@ht{\the\@tempdima}%
%    \setbox\rectb@x=\hbox{%
%      \rectbox@preitem\rectbox@item\rectbox@postitem}%
%    \edef\item@w{\strip@pt\wd\rectb@x}%
%    \@Div\item@w{2}\item@w@half
%    \@tempdima=\ht\rectb@x\advance\@tempdima\dp\rectb@x
%    \divide\@tempdima\tw@
%    \edef\item@ht{\the\@tempdima}%
  }%
  \ifthenelse{\equal\rectbox@bitem\empty}{\def\bitem@ht{0pt}}{%
    \setbox\rectbox@bitem@box=\hbox{%
      \rectbox@prebitem\rectbox@bitem\rectbox@postbitem}%
    \edef\bitem@w{\strip@pt\wd\rectbox@bitem@box}%
    \@Div\bitem@w{2}\bitem@w@half
    \@tempdima=\ht\rectbox@bitem@box\advance\@tempdima\dp\rectbox@bitem@box
    \divide\@tempdima\tw@
    \edef\bitem@ht{\the\@tempdima}%
  }%
%
  \@tempdima=\frame@linewidth
  \@tempdima=.5\@tempdima
  \edef\fb@xl{\strip@pt\@tempdima}%
  \setlength{\@tempdima}{%
    \rectbox@width+\l@sep+\r@sep+\frame@linewidth+\frame@linewidth}%
%  \@tempdima0.996264\@tempdima
  \edef\fb@W{\strip@pt\@tempdima}%
%  \@ifundefined{rectbox@LR}{}{%
    \if R\rectbox@LR
      \setlength{\@tempdima}{%
        \rectbox@width+\r@sep+\frame@linewidth}%
      \edef\fb@W{\strip@pt\@tempdima}%
    \fi
%  }%
  \@ifundefined{not@T}{%
    \setlength{\@tempdima}{\fb@h\p@+\frame@linewidth+\t@sep+\item@ht}%
  }{%
    \setlength{\@tempdima}{\fb@h\p@+\frame@linewidth}%
  }%
% \@tempdima0.996264\@tempdima
  \edef\fb@H{\strip@pt\@tempdima}%
  \@ifundefined{not@B}{%
    \setlength{\@tempdima}{\fb@d\p@+\frame@linewidth+\b@sep+\bitem@ht}%
  }{%
    \setlength{\@tempdima}{\fb@d\p@+\frame@linewidth}%
  }%
%  \@tempdima0.996264\@tempdima
  \edef\fb@D{\strip@pt\@tempdima}%
  \setlength{\psfboxW}{\fb@W\p@}%
  \setlength{\psfboxV}{\fb@H\p@+\fb@D\p@}%
  \Sub\fb@W\fb@xl\fb@xr
  \Sub\fb@H\fb@xl\fb@yh
  \Sub\fb@D\fb@xl\fb@yd
  \Add\fb@H\fb@D\fb@V
  \edef\fb@LT{(\fb@xl,\fb@yh)}%
  \edef\fb@LB{(\fb@xl,-\fb@yd)}%
  \edef\fb@RT{(\fb@xr,\fb@yh)}%
  \edef\fb@RB{(\fb@xr,-\fb@yd)}%
  \Addvec*\fb@LT\fb@dLT\fb@LT@
  \Addvec*\fb@LB\fb@dLB\fb@LB@
  \Addvec*\fb@RT\fb@dRT\fb@RT@
  \Addvec*\fb@RB\fb@dRB\fb@RB@
  \edef\fb@region{\fb@LT\fb@LB\fb@RB\fb@RT}%
  \setlength{\@tempdima}{\rectbox@oval+\rectbox@oval}%
  \ifdim\@tempdima>\psfboxV
    \setlength{\@tempdima}{.5\psfboxV}%
    \edef\rectbox@oval{\the\@tempdima}%
  \fi
  \ukansan{\rectbox@oval}\r@@
%
%
% 上見出し位置
  \ifx\empty\rectbox@item
    \Tyuuten\fb@LT\fb@RT\fb@MT
    \edef\fb@itemL{\fb@MT}%
    \edef\fb@itemR{\fb@MT}%
  \else
    \if l\rectbox@item@pos
      \setlength{\@tempdima}{\fb@xl\p@+10pt+\rectbox@oval}%
      \edef\item@lx{\strip@pt\@tempdima}%
      \advance\@tempdima\item@w\p@
      \edef\item@rx{\strip@pt\@tempdima}%
      \Addvec\fb@LT{(\item@lx,0)}\fb@itemL
      \Addvec\fb@LT{(\item@rx,0)}\fb@itemR
    \else\if r\rectbox@item@pos
      \setlength{\@tempdima}{\fb@xr\p@-10pt-\rectbox@oval}%
      \edef\item@rx{\strip@pt\@tempdima}%
      \advance\@tempdima-\item@w\p@
      \edef\item@lx{\strip@pt\@tempdima}%
      \Addvec\fb@LT{(\item@lx,0)}\fb@itemL
      \Addvec\fb@LT{(\item@rx,0)}\fb@itemR
    \else
      \Tyuuten\fb@LT\fb@RT\fb@MT
      \Addvec\fb@MT{(-\item@w@half,0)}\fb@itemL
        \vecXY\fb@itemL\item@lx\@dmy
      \Addvec\fb@MT{(\item@w@half,0)}\fb@itemR
        \vecXY\fb@itemR\item@rx\@dmy
    \fi\fi
  \fi
  \ifx\empty\rectbox@bitem
    \Tyuuten\fb@LB\fb@RB\fb@MB
    \edef\fb@bitemL{\fb@MB}%
    \edef\fb@bitemR{\fb@MB}%
  \else
    \if l\rectbox@bitem@pos
      \setlength{\@tempdima}{\fb@xl\p@+10pt+\rectbox@oval}%
      \edef\bitem@lx{\strip@pt\@tempdima}%
      \advance\@tempdima\bitem@w\p@
      \edef\bitem@rx{\strip@pt\@tempdima}%
      \Addvec\fb@LB{(\bitem@lx,0)}\fb@bitemL
      \Addvec\fb@LB{(\bitem@rx,0)}\fb@bitemR
    \else\if r\rectbox@bitem@pos
      \setlength{\@tempdima}{\fb@xr\p@-10pt-\rectbox@oval}%
      \edef\bitem@rx{\strip@pt\@tempdima}%
      \advance\@tempdima-\bitem@w\p@
      \edef\bitem@lx{\strip@pt\@tempdima}%
      \Addvec\fb@LB{(\bitem@lx,0)}\fb@bitemL
      \Addvec\fb@LB{(\bitem@rx,0)}\fb@bitemR
    \else
      \Tyuuten\fb@LB\fb@RB\fb@MB
      \Addvec\fb@MB{(-\bitem@w@half,0)}\fb@bitemL
        \vecXY\fb@bitemL\bitem@lx\@dmy
      \Addvec\fb@MB{(\bitem@w@half,0)}\fb@bitemR
        \vecXY\fb@bitemR\bitem@rx\@dmy
    \fi\fi
  \fi
%
% 支柱
%
  \@tempdima=\fb@H\p@
  \@ifundefined{not@T}{\advance\@tempdima\item@ht}{}%
  \edef\fb@H@{\strip@pt\@tempdima}%
  \@tempdima=\fb@D\p@
  \@ifundefined{not@B}{\advance\@tempdima\bitem@ht}{}%
  \edef\fb@D@{\strip@pt\@tempdima}%
  \vrule height \fb@H@\p@ depth \fb@D@\p@ width \z@
%
% 背景色
%
  \begin{picture}(0,0)\relax
%
% shade
%
\ifdim\shade@rule>\z@
\ifdim\rectbox@oval=\z@
\bgroup
\linethickness{\shade@rule}%
      \ifx\empty\shade@color\else\@iro{\shade@color}\fi
        \@ifundefined{not@B}{%
          \@ifundefined{not@T}{% 上あり，下あり
            \Addvec\fb@RT{(\shade@hw,-\shade@w)}\fb@RT@
            \Addvecself\fb@RT@{(\fb@xl,-\fb@xl)}%
            \Addvec\fb@RB{(\shade@hw,-\shade@hw)}\fb@RB@
            \Addvecself\fb@RB@{(\fb@xl,-\fb@xl)}%
            \Addvec\fb@LB{(\shade@w,-\shade@hw)}\fb@LB@
            \Addvecself\fb@LB@{(\fb@xl,-\fb@xl)}%
            \pIIeDrawline{\fb@LB@\fb@RB@\fb@RT@}%
          }{% 上なし，下あり
            \Addvec\fb@RT{(\shade@hw,0)}\fb@RT@
            \Addvecself\fb@RT@{(\fb@xl,0)}%
            \Addvec\fb@RB{(\shade@hw,-\shade@hw)}\fb@RB@
            \Addvecself\fb@RB@{(\fb@xl,-\fb@xl)}%
            \Addvec\fb@LB{(\shade@w,-\shade@hw)}\fb@LB@
            \Addvecself\fb@LB@{(\fb@xl,-\fb@xl)}%
            \pIIeDrawline{\fb@LB@\fb@RB@\fb@RT@}%
          }%
        }{% 
          \@ifundefined{not@T}{% 上あり，下なし
            \Addvec\fb@RT{(\shade@hw,-\shade@w)}\fb@RT@
            \Addvecself\fb@RT@{(\fb@xl,-\fb@xl)}%
            \Addvec\fb@RB{(\shade@hw,0)}\fb@RB@
            \Addvecself\fb@RB@{(\fb@xl,0)}%
            \pIIeDrawline{\fb@RB@\fb@RT@}%
          }{% 上なし，下なし
            \Addvec\fb@RT{(\shade@hw,0)}\fb@RT@
            \Addvecself\fb@RT@{(\fb@xl,0)}%
            \Addvec\fb@RB{(\shade@hw,0)}\fb@RB@
            \Addvecself\fb@RB@{(\fb@xl,0)}%
            \pIIeDrawline{\fb@RB@\fb@RT@}%
          }%
        }%
\egroup
\fi
\fi
    \Add\fb@W\shade@w\fb@W@shade
    \Add\fb@D\shade@w\fb@D@shade
    \ifx\empty\background@color\else
      \begingroup
      %
      \ifdim\rectbox@oval>\z@
%        \@ifundefined{rectbox@LR}{%
\if Z\rectbox@LR
          \Sub\fb@W\fb@xl\fb@W@\Subself\fb@W@\fb@xl
          \Sub\fb@V\fb@xl\fb@V@\Subself\fb@V@\fb@xl
          \Mul\fb@V@{2}\fb@V@@%
          \@ifundefined{not@B}{%
            \@ifundefined{not@T}{% 上あり，下あり
              \Tyuuten\fb@LT\fb@RB\fb@C
              \Put\fb@C{%
                \@iro{\background@color}%
                \oval*[\rectbox@oval](\fb@W@,\fb@V@)}%
            }{% 上なし，下あり
              \Tyuuten\fb@LT\fb@RT\fb@C
              \Put\fb@C{%
                \@iro{\background@color}%
                \oval*[\rectbox@oval](\fb@W@,\fb@V@@)[b]}%
            }%
          }{% 
            \@ifundefined{not@T}{% 上あり，下なし
              \Tyuuten\fb@LB\fb@RB\fb@C
              \edef\tmp@a{*}%
              \Put\fb@C{%
                \@iro{\background@color}%
                \oval*[\rectbox@oval](\fb@W@,\fb@V@@)[t]}%
            }{% 上なし，下なし
            }%
          }%
\else
%        }{%
          \if L\rectbox@LR
            \Sub\fb@W\fb@xl\fb@W@\Subself\fb@W@\fb@xl\Subself\fb@W@\fb@xl%\Subself\fb@W@\fb@xl
            \Sub\fb@V\fb@xl\fb@V@
            \Mul\fb@V@{2}\fb@V@@%
            \Mul\fb@W@{2}\fb@W@@%
%              \pIIeDrawline{\fb@LT\fb@LB}%
            \@ifundefined{not@B}{%
              \@ifundefined{not@T}{% 上あり，下あり
%                \Tyuuten\fb@LT\fb@LB\fb@C
%                \Addvecself\fb@C{(\rectbox@oval@@,0)}%
%                \Put\fb@C{\oval[\rectbox@oval](\rectbox@oval@@,\fb@V@)[l]}%
              }{% 上なし，下あり
                \Put\fb@RT{\@iro{\background@color}%
                 \oval*[\rectbox@oval](\fb@W@@,\fb@V@@)[bl]\relax
                 \polygon*(0,0)(0,-\fb@V@)(-\fb@W@,0)\relax}%
              }%
            }{% 
              \@ifundefined{not@T}{% 上あり，下なし
                \Mul\fb@V@{.5}\fb@V@h
                \Mul\fb@W@{.5}\fb@W@h
                \Put\fb@RB{\@iro{\background@color}%
                 \oval*[\rectbox@oval](\fb@W@@,\fb@V@@)[tl]\relax
                 \polygon*(0,0)(0,\fb@V@)(-\fb@W@h,\fb@V@)(-\fb@W@,\fb@V@h)(-\fb@W@,0)\relax
                }%
              }{% 上なし，下なし
              }%
            }%
          \else\if R\rectbox@LR
%              \pIIeDrawline{\fb@RT\fb@RB}%
          \else
%              \pIIeDrawline{\fb@LT\fb@LB}%
%              \pIIeDrawline{\fb@RT\fb@RB}%
          \fi\fi
\fi
%        }%
      \else
              \edef\tmp@a{*\fb@LT\fb@LB\fb@RB\fb@RT}%
              \put(0,0){\@iro{\background@color}%
                \expandafter\polygon\tmp@a}%
      \fi
      \endgroup
    \fi
%
    \ifdim\frame@linewidth>\z@
      \begingroup
      \linethickness{\frame@linewidth}%
      \ifthenelse{\equal\frame@color\empty}{}{\@iro{\frame@color}}%
      \ifdim\rectbox@oval>\z@
        \ukansan\rectbox@oval\rectbox@oval@@
        \Sub\fb@W\fb@xl\fb@W@\Subself\fb@W@\fb@xl
        \Sub\fb@V\fb@xl\fb@V@\Subself\fb@V@\fb@xl
        \Mul\fb@V@{2}\fb@V@@%
        \ifx\empty\rectbox@dash
                \edef\fbox@dash{}%
        \else
                \Strsep\rectbox@dash{,}\LG@a\LG@b
                \ukansan{\LG@a}\LG@a
                \ukansan{\LG@b}\LG@b
                \edef\fbox@dash{%
                  \space[\LG@a\space\LG@b]\space0\space\pIIe@setdash@op}%
        \fi
%        \@ifundefined{rectbox@LR}{%
\if Z\rectbox@LR
          \@ifundefined{not@B}{%
            \@ifundefined{not@T}{% 上あり，下あり
              \Tyuuten\fb@LT\fb@RB\fb@C
              \Put\fb@C{\oval[\rectbox@oval](\fb@W@,\fb@V@)}%
            }{% 上なし，下あり
              \Tyuuten\fb@LT\fb@RT\fb@C
              \Put\fb@C{\oval[\rectbox@oval](\fb@W@,\fb@V@@)[b]}%
            }%
          }{% 
            \@ifundefined{not@T}{% 上あり，下なし
              \Tyuuten\fb@LB\fb@RB\fb@C
              \Put\fb@C{\oval[\rectbox@oval](\fb@W@,\fb@V@@)[t]}%
            }{% 上なし，下なし
            }%
          }%
\else
%        }{%
          \if L\rectbox@LR
%              \pIIeDrawline{\fb@LT\fb@LB}%
            \@ifundefined{not@B}{%
              \@ifundefined{not@T}{% 上あり，下あり
                \Tyuuten\fb@LT\fb@LB\fb@C
                \Addvecself\fb@C{(\rectbox@oval@@,0)}%
                \Put\fb@C{\oval[\rectbox@oval](\rectbox@oval@@,\fb@V@)[l]}%
              }{% 上なし，下あり
                \Addvec\fb@LT{(\rectbox@oval@@,0)}\fb@C
                \Put\fb@C{\oval[\rectbox@oval](\rectbox@oval@@,\fb@V@@)[lb]}%
              }%
            }{% 
              \@ifundefined{not@T}{% 上あり，下なし
                \Addvec\fb@LB{(\rectbox@oval@@,0)}\fb@C
                \Put\fb@C{\oval[\rectbox@oval](\rectbox@oval@@,\fb@V@@)[lt]}%
              }{% 上なし，下なし
              }%
            }%
          \else\if R\rectbox@LR
%              \pIIeDrawline{\fb@RT\fb@RB}%
          \else
%              \pIIeDrawline{\fb@LT\fb@LB}%
%              \pIIeDrawline{\fb@RT\fb@RB}%
          \fi\fi
\fi
%        }%
      \else
%        \@ifundefined{rectbox@LR}{%
\if Z\rectbox@LR
          \@ifundefined{not@B}{%
            \@ifundefined{not@T}{% 上あり，下あり
              \ifx\empty\hasenLG@opt
                \ifx\empty\rectbox@dash
                  \edef\fbox@dash{}%
                \else
                  \Strsep\rectbox@dash{,}\LG@a\LG@b
                  \ukansan{\LG@a}\LG@a
                  \ukansan{\LG@b}\LG@b
                  \edef\fbox@dash{%
                    \space[\LG@a\space\LG@b]\space0\space\pIIe@setdash@op}%
                \fi
                \pIIeTakakkei{\fb@LT\fb@LB\fb@RB\fb@RT}%
              \else
                \Strsep\hasenLG@opt{,}\LG@a\LG@b
                \calchasenLG{\fb@W\p@}{\LG@a}{\LG@b}\h@N\h@L\h@G
                \edef\fbox@dash{%
                    \space[\h@L\space\h@G]\space0\space\pIIe@setdash@op}%
                \polyline(0,-\fb@yd)(\fb@W,-\fb@yd)\relax
                \polyline(0,\fb@yh)(\fb@W,\fb@yh)\relax
                \Add\fb@yh\fb@yd\fb@v
%\typeout{h=\fb@yh,d=\fb@yd,v=\fb@v,a=\LG@a,b=\LG@b}%
                \calchasenLG{\fb@v\p@}{\LG@a}{\LG@b}\h@N\h@L\h@G
                \edef\fbox@dash{%
                    \space[\h@L\space\h@G]\space0\space\pIIe@setdash@op}%
                \polyline(\fb@xl,-\fb@yd)(\fb@xl,\fb@yh)\relax
                \polyline(\fb@xr,-\fb@yd)(\fb@xr,\fb@yh)\relax
              \fi
            }{% 上なし，下あり
%              \pIIeDrawline{\fb@LT\fb@LB\fb@RB\fb@RT}%
              \ifx\empty\hasenLG@opt
                \ifx\empty\rectbox@dash
                  \edef\fbox@dash{}%
                \else
                  \Strsep\rectbox@dash{,}\LG@a\LG@b
                  \ukansan{\LG@a}\LG@a
                  \ukansan{\LG@b}\LG@b
                  \edef\fbox@dash{%
                    \space[\LG@a\space\LG@b]\space0\space\pIIe@setdash@op}%
                \fi
                \pIIeDrawline{\fb@LT\fb@LB\fb@RB\fb@RT}%
              \else
                \Strsep\hasenLG@opt{,}\LG@a\LG@b
                \calchasenLG{\fb@W\p@}{\LG@a}{\LG@b}\h@N\h@L\h@G
                \edef\fbox@dash{%
                    \space[\h@L\space\h@G]\space0\space\pIIe@setdash@op}%
                \polyline(0,-\fb@yd)(\fb@W,-\fb@yd)\relax
%                \polyline(0,\fb@yh)(\fb@W,\fb@yh)\relax
                \Add\fb@yh\fb@yd\fb@v
                \calchasenLG{\fb@v\p@}{\LG@a}{\LG@b}\h@N\h@L\h@G
                \edef\fbox@dash{%
                    \space[\h@L\space\h@G]\space0\space\pIIe@setdash@op}%
                \polyline(\fb@xl,-\fb@yd)(\fb@xl,\fb@yh)\relax
                \polyline(\fb@xr,-\fb@yd)(\fb@xr,\fb@yh)\relax
              \fi
            }%
          }{% 
            \@ifundefined{not@T}{% 上あり，下なし
%              \pIIeDrawline{\fb@LB\fb@LT\fb@RT\fb@RB}%
              \ifx\empty\hasenLG@opt
                \ifx\empty\rectbox@dash
                  \edef\fbox@dash{}%
                \else
                  \Strsep\rectbox@dash{,}\LG@a\LG@b
                  \ukansan{\LG@a}\LG@a
                  \ukansan{\LG@b}\LG@b
                  \edef\fbox@dash{%
                    \space[\LG@a\space\LG@b]\space0\space\pIIe@setdash@op}%
                \fi
                \pIIeDrawline{\fb@LB\fb@LT\fb@RT\fb@RB}%
              \else
                \Strsep\hasenLG@opt{,}\LG@a\LG@b
                \calchasenLG{\fb@W\p@}{\LG@a}{\LG@b}\h@N\h@L\h@G
                \edef\fbox@dash{%
                    \space[\h@L\space\h@G]\space0\space\pIIe@setdash@op}%
%               \polyline(0,-\fb@yd)(\fb@W,-\fb@yd)\relax
                \polyline(0,\fb@yh)(\fb@W,\fb@yh)\relax
                \Add\fb@yh\fb@yd\fb@v
                \calchasenLG{\fb@v\p@}{\LG@a}{\LG@b}\h@N\h@L\h@G
                \edef\fbox@dash{%
                    \space[\h@L\space\h@G]\space0\space\pIIe@setdash@op}%
                \polyline(\fb@xl,-\fb@yd)(\fb@xl,\fb@yh)\relax
                \polyline(\fb@xr,-\fb@yd)(\fb@xr,\fb@yh)\relax
              \fi
            }{% 上なし，下なし
%              \pIIeDrawline{\fb@LT\fb@LB\fb@RB\fb@RT}%
              \ifx\empty\hasenLG@opt
                \ifx\empty\rectbox@dash
                  \edef\fbox@dash{}%
                \else
                  \Strsep\rectbox@dash{,}\LG@a\LG@b
                  \ukansan{\LG@a}\LG@a
                  \ukansan{\LG@b}\LG@b
                  \edef\fbox@dash{%
                    \space[\LG@a\space\LG@b]\space0\space\pIIe@setdash@op}%
                \fi
                \pIIeDrawline{\fb@LT\fb@LB}%
                \pIIeDrawline{\fb@RB\fb@RT}%
              \else
                \Strsep\hasenLG@opt{,}\LG@a\LG@b
                \calchasenLG{\fb@W\p@}{\LG@a}{\LG@b}\h@N\h@L\h@G
                \edef\fbox@dash{%
                    \space[\h@L\space\h@G]\space0\space\pIIe@setdash@op}%
%                \polyline(0,-\fb@yd)(\fb@W,-\fb@yd)\relax
%                \polyline(0,\fb@yh)(\fb@W,\fb@yh)\relax
                \Add\fb@yh\fb@yd\fb@v
                \calchasenLG{\fb@v\p@}{\LG@a}{\LG@b}\h@N\h@L\h@G
                \edef\fbox@dash{%
                    \space[\h@L\space\h@G]\space0\space\pIIe@setdash@op}%
                \polyline(\fb@xl,-\fb@yd)(\fb@xl,\fb@yh)\relax
                \polyline(\fb@xr,-\fb@yd)(\fb@xr,\fb@yh)\relax
              \fi
            }%
          }%
\else
%        }{%
          \ifx\empty\rectbox@dash
            \ifx\empty\hasenLG@opt
              \edef\fbox@dash{}%
            \else
              \Strsep\hasenLG@opt{,}\LG@a\LG@b
              \Add\fb@yh\fb@yd\fb@v
              \calchasenLG{\fb@v\p@}{\LG@a}{\LG@b}\h@N\h@L\h@G
              \edef\fbox@dash{%
                    \space[\h@L\space\h@G]\space0\space\pIIe@setdash@op}%
            \fi
          \else
                \Strsep\rectbox@dash{,}\LG@a\LG@b
                \ukansan{\LG@a}\LG@a
                \ukansan{\LG@b}\LG@b
                \edef\fbox@dash{%
                  \space[\LG@a\space\LG@b]\space0\space\pIIe@setdash@op}%
          \fi
          \if L\rectbox@LR
              \pIIeDrawline{\fb@LT\fb@LB}%
          \else\if R\rectbox@LR
              \pIIeDrawline{\fb@RT\fb@RB}%
          \else
              \pIIeDrawline{\fb@LT\fb@LB}%
              \pIIeDrawline{\fb@RT\fb@RB}%
          \fi\fi
%        }%
\fi
      \fi
      \endgroup
    \fi
%%
%% 見出し出力
%%
      \@ifundefined{not@T}{%
        \ifx\empty\rectbox@item
        \else
          \Put\fb@itemL(0,0)[l]{{%
            \fboxsep=\z@\colorbox{white}{\box\rectbox@item@box}}}%
        \fi
      }{}%
      \@ifundefined{not@B}{%
        \ifx\empty\rectbox@bitem
        \else
          \Put\fb@bitemL(0,0)[l]{{%
            \fboxsep=\z@\colorbox{white}{\box\rectbox@bitem@box}}}%
        \fi
      }{}%
%%    \end{pszahyou*}%
  \end{picture}%
%
% テキスト
%
%
%
%  \@ifundefined{rectbox@LR}{%
\if Z\rectbox@LR
%    \hidari@keisen
    \hskip\frame@linewidth
    \hskip\l@sep
    \box\ps@box\relax
    \hskip\r@sep
    \hskip\frame@linewidth
%    \migi@keisen
\else
%  }{%
    \if L\rectbox@LR
%      \hidari@keisen
      \hskip\frame@linewidth
      \hskip\l@sep
      \box\ps@box\relax
    \else\if R\rectbox@LR
      \box\ps@box\relax
      \hskip\r@sep
      \hskip\frame@linewidth
%      \migi@keisen
    \else
%      \hidari@keisen
      \hskip\frame@linewidth
      \hskip\l@sep
      \box\ps@box\relax
      \hskip\r@sep
%      \migi@keisen
      \hskip\frame@linewidth
    \fi\fi
\fi
%  }%
  \ifdim\shade@rule>\z@
    \vspace{\shade@rule}%
    \hspace{\shade@rule}%
  \fi
}}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\let\pIIefbox\EMpIIefbox
\let\pIIeframed\EMpIIeframed
\let\endpIIeframed\endEMpIIeframed
%
%\def\EMpIIeboxed{\@ifnextchar<{\@EMpIIeboxed}{\@EMpIIeboxed<\empty>}}%
\DeclareRobustCommand\EMpIIeboxed{%
  \@ifnextchar<{\@EMpIIeboxed}{\@EMpIIeboxed<\empty>}}%
\def\@EMpIIeboxed<#1>#2{\EMpIIefbox<#1>{\m@th$\displaystyle#2$}}%
\let\pIIeboxed\EMpIIeboxed
\endinput

v 0.00α 2009/05/30
v 0.01α 2009/05/31 3ページ以上にわたる場合
v 0.03α 2009/06/08 emathPs, emathPsb を必ずしも必要としない。
         ps を使用しない場合は EMframed環境
v 0.05α 2009/07/10
         pict2e.sty v0.2w に対応
         eepic.sty との併用
v 0.06α 2010/07/31
         \HVsep
v 0.06α 2010/10/03
         \rectboxparindent
v 0.08α 2010/12/09
         \shade@rule など初期化
v 0.09α 2011/03/03
         \pIIeboxed
v 0.10α 2011/03/08 \EMpIIefbox: \rectbox@LR の初期化 (BBS #9710)
v 0.11α 2011/04/07 pict2e.sty v0.2y に対応
v 0.12α 2011/12/02 EMpsframed: [item=..] オプション処理を edef --> EMedef
v 0.13α 2011/12/02 上記のバグフィックス
v 0.14α 2011/12/19 item= の右辺値を box に入れる (BBS #10432)
