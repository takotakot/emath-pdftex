% emathPh.sty by tDB(emath@nifty.com)
%
\@ifundefined{ifpapersize}{\newif\ifpapersize\papersizefalse}{}%
%
  \NeedsTeXFormat{LaTeX2e}
  \ProvidesPackage{emathPh}[2005/11/03 v 2.46]%
  \DeclareOption{notMy}{\def\not@My{}}%
  \DeclareOption{onlyP}{\def\P@nly{}}%
% \DeclareOption{times}{\def\@times{}}%
% \DeclareOption{txfonts}{\def\@txfonts{}}%
  \DeclareOption{times}{\def\em@fonts{1}}%
  \DeclareOption{txfonts}{\def\em@fonts{2}}%
  \DeclareOption{pxfonts}{\def\em@fonts{3}}%
  \DeclareOption{mathabx}{\def\em@fonts{4}}%
  \DeclareOption{varg}{\def\@varg{}}%
  \DeclareOption{dviout}{\def\em@grdrv{dviout}}%
  \DeclareOption{dvips}{\def\em@grdrv{dvips}}%
  \DeclareOption{dvipdfm}{\def\em@grdrv{dvipdfm}}%
  \DeclareOption{dvipdfmx}{\def\em@grdrv{dvipdfmx}}%
  \DeclareOption{EMdvipsk}{\def\em@dvipsk{}}%
  \DeclareOption{EMdvipdfm}{\def\em@dvipdfm{}}%
  \DeclareOption{EMdvipdfmx}{\def\em@dvipdfmx{}}%
  \DeclareOption{papersize}{\papersizetrue}
  \ProcessOptions\relax
  \@ifundefined{P@nly}{%
    \@ifundefined{emath@Ps}{%
      \RequirePackage{epic}%
      \RequirePackage{eepic}%
    }{}%
%   \RequirePackage{fp}%
%   \FPmessagesfalse
%   \RequirePackage{array}%
    \RequirePackage{eclarith}%
%
\let\revised@For\@undefined
    \RequirePackage{emath}%
    \@ifundefined{em@grdrv}{%
      \RequirePackage{graphicx}%
      \RequirePackage{color}%
    }{%
      \RequirePackage[\em@grdrv]{graphicx}%
      \RequirePackage[\em@grdrv]{color}%
%      \RequirePackage{color}%
    }%
    \definecolor{lightgray}{gray}{.8}%
    \definecolor{darkgray}{gray}{.2}%
    \definecolor{skyblue}{rgb}{0.529412,0.807843,0.921569}%
    \definecolor{gold}{rgb}{1.000000,0.843137,0.000000}%
    \definecolor{yellowgreen}{rgb}{0.603922,0.803922,0.196078}%
    \definecolor{teal}{rgb}{0.000000,0.501961,0.501961}%
    \definecolor{forestgreen}{rgb}{0.133333,0.545098,0.133333}%
    \definecolor{seagreen}{rgb}{0.180392,0.545098,0.341176}%
    \definecolor{maroon}{rgb}{0.501961,0.000000,0.000000}%
    \definecolor{olive}{rgb}{0.501961,0.501961,0.000000}%
    \definecolor{navy}{rgb}{0.000000,0.000000,0.501961}%
    \definecolor{purple}{rgb}{0.501961,0.000000,0.501961}%
    \definecolor{royalblue}{rgb}{0.254902,0.411765,0.882353}%
    \definecolor{plum}{rgb}{0.866667,0.627451,0.866667}%
    \definecolor{lavender}{rgb}{0.901961,0.901961,0.980392}%
    \definecolor{orchid}{rgb}{0.854902,0.439216,0.839216}%
    \definecolor{violet}{rgb}{0.933333,0.509804,0.933333}%
    \definecolor{indigo}{rgb}{0.294118,0.000000,0.509804}%
    \definecolor{pink}{rgb}{1.000000,0.752941,0.796078}%
    \definecolor{linen}{rgb}{0.980392,0.941176,0.901961}%
    \definecolor{ivory}{rgb}{1.000000,1.000000,0.941176}%
    \definecolor{snow}{rgb}{1.000000,0.980392,0.980392}%
    \definecolor{silver}{rgb}{0.752941,0.752941,0.752941}%
    \definecolor{crimson}{rgb}{0.862745,0.078431,0.235294}%
    \definecolor{brown}{rgb}{0.647059,0.164706,0.164706}%
    \definecolor{salmon}{rgb}{0.980392,0.501961,0.447059}%
    \definecolor{coral}{rgb}{1.000000,0.498039,0.313725}%
    \definecolor{tomato}{rgb}{1.000000,0.388235,0.278431}%
    \definecolor{chocolate}{rgb}{0.823529,0.411765,0.117647}%
    \definecolor{orange}{rgb}{1.000000,0.647059,0.000000}%
    \definecolor{khaki}{rgb}{0.941176,0.901961,0.549020}%
    \definecolor{darkgreen}{rgb}{0.000000,0.392157,0.000000}%
    \definecolor{lightgreen}{rgb}{0.564706,0.933333,0.564706}%
    \definecolor{darkcyan}{rgb}{0.000000,0.545098,0.545098}%
%
    \definecolor{Cyan}{cmyk}{1,0,0,0}%
    \definecolor{PastelBlue}{cmyk}{0.5,0,0,0}%
    \definecolor{CobaltBlue}{cmyk}{0.88,0.43,0.20,0.11}%
    \definecolor{SailorBlue}{cmyk}{0.8,0.4,0,0}%
    \definecolor{ForgetMeNot}{cmyk}{0.56,0.11,0.05,0}%
  }{}%
%
\newif\ifdrawaxis\drawaxistrue%
\newif\ifhan@inai
\newdimen\@tempdimd%
\let\sensyu\drawline% デフォルトは実線
%
\def\arrow@headsize{1}%
\let\ltxpicture\picture
\let\endltxpicture\endpicture
\def\picture{%
  \changeArrowHeadSize{1}\def\O{(0,0)}\def\O@@{(0,0)}\ltxpicture}%
\edef\local@origin{(0,0)}%
\def\EMps@mode{0}%
%
\define@key{emP}{includeEPS}{\csname include@eps#1\endcsname}%
\define@key{emP}{debug}[1]{\def\ps@debug@{#1}}%
\define@key{emP}{EPSfilename}{\def\EMps@filename{#1}}%
\define@key{emP}{EPSclip}{\def\EMps@clip{#1}}%
\define@key{emP}{borderwidth}{\def\border@width{#1}}%
\define@key{emP}{stroke}{\def\EMps@stroke{#1}}%
\define@key{emP}{continue}{\def\EMps@continue{#1}}%
\define@key{emP}{yokozikukigou}{\def\yokozikukigou{#1}}%
\define@key{emP}{tatezikukigou}{\def\tatezikukigou{#1}}%
\define@key{emP}{gentenkigou}{\def\gentenkigou{#1}}%
\define@key{emP}{yokozikuhaiti}{\def\yokozikuhaiti{#1}}%
\define@key{emP}{tatezikuhaiti}{\def\tatezikuhaiti{#1}}%
\define@key{emP}{gentenhaiti}{\def\gentenhaiti{#1}}%
\define@key{emP}{memorinagasa}{\def\memori@nagasa{#1}}%
\define@key{emP}{ul}{\unitlength=#1}%
%\define@key{emP}{trueul}{\unitlength=#1\relax\unitlength=0.996264\unitlength}%
\define@key{emP}{haiti}{%
  \headchar{#1}\haiti@h\haiti@r
  \edef\zahyou@haiti{\haiti@h}%
  \edef\zahyou@haiti@hosei{\haiti@r}%
  }%
\define@key{emP}{ueyohaku}{\def\ue@yohaku{#1}}%
\define@key{emP}{sitayohaku}{\def\sita@yohaku{#1}}%
\define@key{emP}{migiyohaku}{\def\migi@yohaku{#1}}%
\define@key{emP}{Ueyohaku}{\setlength{\templa}{#1}\ukansan\templa\ue@yohaku}%
\define@key{emP}{Sitayohaku}{\setlength{\templa}{#1}\ukansan\templa\sita@yohaku}%
\define@key{emP}{Migiyohaku}{\setlength{\templa}{#1}\ukansan\templa\migi@yohaku}%
\define@key{emP}{Hidariyohaku}{\setlength{\templa}{#1}\ukansan\templa\hidari@yohaku}%
\define@key{emP}{hidariyohaku}{\def\hidari@yohaku{#1}}%
\define@key{emP}{Yohaku}{\setlength{\templa}{#1}\ukansan\templa\ue@yohaku\relax
                                                \edef\sita@yohaku{\ue@yohaku}%
                                                \edef\migi@yohaku{\ue@yohaku}%
                                                \edef\hidari@yohaku{\ue@yohaku}%
                        }%
\define@key{emP}{arrowheadsize}{\def\arrow@headsize{#1}}%
\define@key{emP}{arrowheadL}{\def\Arrowhead@L{#1}}%
\define@key{emP}{arrowheadW}{\def\Arrowhead@W{#1}}%
\define@key{emP}{zikusensyu}{\def\zikusensyu{#1}}%
%
\define@key{emP}{hasen}{\def\hasen@opt{#1}}%
\define@key{emP}{ten}{\def\ten@kosuu{#1}}%
\define@key{emP}{yazirusi}[a]{\def\yazirusi@opt{#1}}%
\define@key{emP}{sensyu}{\def\sensyu{#1}}%
\define@key{emP}{putoption}{\def\put@opt{#1}}%
\define@key{emP}{pos}{\def\@pos{#1}}%
\define@key{emP}{border}[y]{\def\draw@border{#1}}%
\define@key{emP}{noudo}{\def\noudo@{#1}}%
\define@key{emP}{syanurisiteiten}{\def\syanuri@siteiten{#1}%
  \Subvec\syanuri@siteiten\local@origin\syanuri@siteiten}%
\define@key{emP}{syasenkankaku}{\def\syanuri@kankaku{#1}}%
\define@key{emP}{syasenKankaku}{\ukansan{#1}\syanuri@kankaku}%
\define@key{emP}{syanurikankaku}{\def\syanuri@kankaku{#1}}%
\define@key{emP}{syanuriKankaku}{\ukansan{#1}\syanuri@kankaku}%
    \define@key{emP}{tuukaten}{\Kyori{#1}{\@tyuusin}\@hankei}%
    \define@key{emP}{hazimeten}{%
      \Subvec{#1}{\@tyuusin}\Enk@tmp\Argvec\Enk@tmp\hazime@kaku}%
    \define@key{emP}{owariten}{%
      \Subvec{#1}{\@tyuusin}\Enk@tmp\Argvec\Enk@tmp\owari@kaku
      \ifdim\owari@kaku pt<\hazime@kaku pt\Add{360}\owari@kaku\owari@kaku\fi}%
\define@key{emP}{syasentanmatu}{\def\syasen@tanmatu{#1}}%
\define@key{emP}{parindent}{\setlength\parindent{#1}}%
\define@key{emP}{allinethickness}{\allinethickness{#1}}%
\def\nuri@iro@{\empty}%
\define@key{emP}{nuriiro}{\edef\nuri@iro{#1}}%
\define@key{emP}{iro}{\edef\iro@{#1}}%
\define@key{emP}{color}{\color{#1}}%
%\define@key{emP}{iro}{\color{#1}}%
\define@key{emP}{takasa}{\def\takas@{#1}}%
\define@key{emP}{dLT}{\Addvec\LT{#1}\LT}%
\define@key{emP}{dLB}{\Addvec\LB{#1}\LB}%
\define@key{emP}{dRT}{\Addvec\RT{#1}\RT}%
\define@key{emP}{dRB}{\Addvec\RB{#1}\RB}%
\define@key{emP}{DLT}{\vecXY{#1}\emP@x\emP@y
  \ukansan\emP@x\emP@x\ukansan\emP@y\emP@y
  \Addvec\LT{(\emP@x,\emP@y)}\LT}%
\define@key{emP}{DLB}{\vecXY{#1}\emP@x\emP@y
  \ukansan\emP@x\emP@x\ukansan\emP@y\emP@y
  \Addvec\LB{(\emP@x,\emP@y)}\LB}%
\define@key{emP}{DRT}{\vecXY{#1}\emP@x\emP@y
  \ukansan\emP@x\emP@x\ukansan\emP@y\emP@y
  \Addvec\RT{(\emP@x,\emP@y)}\RT}%
\define@key{emP}{DRB}{\vecXY{#1}\emP@x\emP@y
  \ukansan\emP@x\emP@x\ukansan\emP@y\emP@y
  \Addvec\RB{(\emP@x,\emP@y)}\RB}%
\define@key{emP}{bairitu}{\def\@bairitu{#1}}%
\define@key{emP}{muki}{\def\@muki{#1}}%
\define@key{emP}{hazimekaku}{\def\@hazimekaku{#1}}%
\define@key{emP}{owarikaku}{\def\@owarikaku{#1}}%
\define@key{emP}{tyouhankei}{\def\@tyouhankei{#1}}%
\define@key{emP}{tanhankei}{\def\@tanhankei{#1}}%
\define@key{emP}{perl}[1]{\def\by@perl{#1}}%
\define@key{emP}{skip}[0]{\def\save@perldata{#1}}%
\define@key{emP}{oresen}{\def\oresen@name{#1}}%
\define@key{emP}{Henvi}{\vecXY{#1}\henvi@x\henvi@y\ukansan\henvi@x\henvi@x\ukansan\henvi@y\henvi@y
                        \edef\hen@i{(\henvi@x,\henvi@y)}}%
\define@key{emP}{Henvii}{\vecXY{#1}\henvi@x\henvi@y\ukansan\henvi@x\henvi@x\ukansan\henvi@y\henvi@y
                        \edef\hen@ii{(\henvi@x,\henvi@y)}}%
\define@key{emP}{henvi}{\def\hen@i{#1}}%
\define@key{emP}{henvii}{\def\hen@ii{#1}}%
%
\let\ltxcolor\color
%\def\color#1{\edef\nuri@iro@{#1}\ltxcolor{#1}}
\edef\iro@{\empty}%
\DeclareRobustCommand\color{%
  \@ifnextchar[\@EMundeclaredcolor\@EMdeclaredcolor}
\def\@EMundeclaredcolor[#1]#2{%
  \@ifundefined{color@#1}%
    {\c@lor@error{model `#1'}}%
    {%
      \ifthenelse{\equal{#2}{black}}{\edef\iro@{\empty}\def\nuri@iro@{\empty}}{%
        \edef\iro@{#2}\edef\nuri@iro@{#2}}%
     \csname color@#1\endcsname\current@color{#2}%
     \set@color}%
  \ignorespaces}
\def\@EMdeclaredcolor#1{%
  \@ifundefined{\string\color @#1}%
    {\c@lor@error{`#1'}}%
    {%
      \ifthenelse{\equal{#1}{black}}{\edef\iro@{\empty}\def\nuri@iro@{\empty}}{%
        \edef\iro@{#1}\edef\nuri@iro@{#1}}%
     \expandafter\let\expandafter\current@color
     \csname\string\color @#1\endcsname
     \set@color}%
  \ignorespaces}
%
% iro=... 右辺値に [named]{....} が使えるように
%
\def\@iro#1{%
  \ifx\empty #1\relax\else
    \headchar{#1}\iro@h\iro@r
    \ifthenelse{\equal\iro@h{[}}{\expandafter\color#1}{\color{#1}}\ignorespaces
  \fi
  \ignorespaces}
%
%\def\gsave{\bgroup}
%\def\grestore{\egroup}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%          for(#1=#2;#1<#3;#1+=#4){#5}
%             <#1>オプションを指定したときは，ループ変数を丸める。
%             ex. <2> としたときは，小数第2位まで（第3位を四捨五入）
%                                   fp-snap.sty が必要
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifx\revised@For\@undefined
\def\revised@For{}%
\def\For{\@ifnextchar<{\@For}{\@For<\empty>}}
\def\@For<#1>#2#3#4#5\Do#6{\@killglue\edef#2{#3}\def\fr@tmp{#5}%
  \ifx\@empty\fr@tmp\@latexerr{!! Missing Argument!
    For\string#2\string#3\string#4?Do}\@ehd\fi
  \ifdim#5\p@>\z@\def\fr@cnd{\@whiledim#2\p@<#4\p@\do}%
  \else\def\fr@cnd{\@whiledim#2\p@>#4\p@\do}\fi
  \fr@cnd{#6\Add{#2}{#5}{#2}%
    \ifx \empty#1\relax\else\FPround\fr@tmp{#2}{#1}\edef#2{\fr@tmp}\fi
  }\ignorespaces}
\fi
%
\let\ltxput\put
\def\put(#1,#2)#3{%
  \edef\old@localorigin{\local@origin}%
  \Addvec{(#1,#2)}\old@localorigin\local@origin
  \ltxput(#1,#2){#3}\edef\local@origin{\old@localorigin}%
}

\def\Nurizen{1}

% \Tyokkaku[#1](#2)<#3>#4[#5]#6
%   #1    : 補正角 90, 180, 270 など
%         : 0〜1 のときは塗りつぶしの濃さ
%   #2    : 直角記号のサイズ
%   #3    : （未使用）
%   #4    : 直角の頂点
%   #5,#6 : 直角となる2辺の一方の上の点
%
\def\Tyokkaku{\@ifnextchar[{\@Tyokkaku}{\@Tyokkaku[0]}}%
\def\@Tyokkaku[#1]{\@ifnextchar({\@@Tyokkaku[#1]}{\@@Tyokkaku[#1](5)}}%
\def\@@Tyokkaku[#1](#2){\@ifnextchar<{\@@@Tyokkaku[#1](#2)}{%
    \@@@Tyokkaku[#1](#2)<\empty>}}%
\def\@@@Tyokkaku[#1](#2)<#3>#4{\@ifnextchar[{\@@@@Tyokkaku[#1](#2)<#3>{#4}}{%
  \@@@@Tyokkaku[#1](#2)<#3>{#4}[\empty]}}%
\def\@@@@Tyokkaku[#1](#2)<#3>#4[#5]#6{%
\Kyorii{#4}{#6}\Tyokkaku@a
\ifdim\Tyokkaku@a pt>0.005pt\relax
  \Subvec{#4}{#6}\@v\vecXY\@v\Pr@x\P@y%
  \Div{#2}{\strip@pt\unitlength}\u@pt%
  \Subvec{#6}{#4}\t@x\Unitvec\t@x\t@x\Mulvec\u@pt\t@x\t@x
  \ifx\empty#5\Rotvec\t@x{-90}\t@y\else%
  \Subvec{#5}{#4}\t@y\Unitvec\t@y\t@y\Mulvec\u@pt\t@y\t@y\fi%
  \ifdim #1pt>1pt\relax\Rotvec\t@x{#1}\t@x\Rotvec\t@y{#1}\t@y\fi
  \Addvec\t@x\t@y\t@z\Addvec{#4}\t@x\t@x%
  \Addvec{#4}\t@y\t@y \Addvec{#4}\t@z\t@z%
  \ifdim #1pt>\z@\ifdim #1pt<1.1pt\relax
    \Nuritubusi[#1]{\t@x\t@z\t@y#4\t@x}\fi\fi%
  \Drawline{\t@x\t@z\t@y}%
\fi
}

\def\Tyokkakukigou{\@ifnextchar[{\@Tyokkakukigou}{\@Tyokkakukigou[0]}}
\def\@Tyokkakukigou[#1]{\@ifnextchar({\@@Tyokkakukigou[#1]}{%
  \@@Tyokkakukigou[#1](5)}}
\def\@@Tyokkakukigou[#1](#2)#3#4#5{%
\Kyorii{#3}{#4}\a@Tyokkakukigou
\Kyorii{#5}{#4}\b@Tyokkakukigou
\ifdim\a@Tyokkakukigou pt>0.005pt\relax
\ifdim\b@Tyokkakukigou pt>0.005pt\relax
  \Div{#2}{\strip@pt\unitlength}\u@pt%
  \Subvec{#3}{#4}\t@x\Unitvec\t@x\t@x\Mulvec\u@pt\t@x\t@x
  \Subvec{#5}{#4}\t@y\Unitvec\t@y\t@y\Mulvec\u@pt\t@y\t@y
  \Addvec\t@x\t@y\t@z\Addvec{#4}\t@x\t@x%
  \Addvec{#4}\t@y\t@y \Addvec{#4}\t@z\t@z%
  \ifdim #1pt>\z@\Nuritubusi[#1]{\t@x\t@z\t@y#4\t@x}\fi
  \Drawline{\t@x\t@z\t@y}%
\fi\fi
}

\let\RKAKUkigou\Tyokkakukigou
%\let\RKakukigou\Tyokkakukigou

% 複数の角に直角記号
\def\tyokkakukigou{\@ifnextchar[{\@tyokkakukigou}{\@tyokkakukigou[0]}}
\def\@tyokkakukigou[#1]{\@ifnextchar({\@@tyokkakukigou[#1]}{%
  \@@tyokkakukigou[#1](5)}}
\def\@@tyokkakukigou[#1](#2)#3{%
    \def\@@tyokkakukigou@sub(##1,##2)(##3,##4)(##5,##6){%
      \Tyokkakukigou[#1](#2){(##1,##2)}{(##3,##4)}{(##5,##6)}}%
  \Cfor{\edef\tyokkaku@a{#3}}{\not\equal\tyokkaku@a\empty}{}\do{%
    \strsep\tyokkaku@a{;}\tyokkaku@a\tyokkaku@b
    \expandafter\@@tyokkakukigou@sub\tyokkaku@a
    \edef\tyokkaku@a{\tyokkaku@b}}}

%% 角の内部に円弧を描き，その傍に記号などを置く．
\def\KAKUkigousize{1}%
%\Kakukigou[#1]<#2>#3#4#5<#6><#7>
%    #1 : 円弧の上に置く記号
%     #1=a のときは角記号に矢印をつける．
%     #1=r のときは角記号に逆向きの矢印をつける．
%     #1=b のときは角記号に両向きの矢印をつける．
%     #1=| のときは，円弧中央に円弧と垂直な短い線分(長さは\KAKUkigousize)
%    #2 : 円弧の個数
%         \Kakukigou@kankaku（デフォルト値=0.5mm）だけ小さい円弧を描画する。
%    #3#4#5 : 角BAC
%       #4 が角の頂点
%       半直線 #4#3 を 回転して #4#5 に重ねる回転を表示する．
%    #6 : 円弧と頂点の距離係数（デフォルト値 1 ）
%       hankei=（無名数） 半径の指定
%       Hankie=（単位付）     〃
%       siteiten=         円弧が指定点を通過
%       Kakukigoukankaku=（単位付） 複数の円弧を描画する際の間隔
%    #7 : 円弧の中心と角の頂点位置（デフォルト値 0 ）
%    以下，\emathPut に続く。

\def\Kakukigou{\edef\Kaku@nuri{0}\@ifstar{\Kakukigou@s}{\Kakukigou@}}
\def\Kakukigou@s{\@ifnextchar[{\Kakukigou@@}{\Kakukigou@@[.5]}}
\def\Kakukigou@@[#1]{\edef\Kaku@nuri{#1}\Kakukigou@}
\def\Kakukigou@{\@ifnextchar[{\@Kakukigou}{\@Kakukigou[\empty]}}%
\def\@Kakukigou[#1]{\@ifnextchar<{\@@Kakukigou[#1]}{%
  \@@Kakukigou[#1]<1>}}%
\def\@@Kakukigou[#1]<#2>#3#4#5{\@ifnextchar<{%
  \@@@Kakukigou[#1]<#2>{#3}{#4}{#5}}{%
  \@@@Kakukigou[#1]<#2>{#3}{#4}{#5}<1>}}%
\def\@@@Kakukigou[#1]<#2>#3#4#5<#6>{\@ifnextchar<{%
  \@@@@Kakukigou[#1]<#2>{#3}{#4}{#5}<#6>}{%
  \@@@@Kakukigou[#1]<#2>{#3}{#4}{#5}<#6><0>}}%
\def\@@@@Kakukigou[#1]<#2>#3#4#5<#6><#7>{%
    \define@key{emP}{hankei}{\def\u@pt{##1}}%
    \define@key{emP}{Hankei}{\templa=##1\relax
      \Div{\strip@pt\templa}{\strip@pt\unitlength}\u@pt}%
    \define@key{emP}{siteiten}{\Kyori{##1}{#4}\u@pt}%
    \define@key{emP}{Kakukigoukankaku}{\ukansan{##1}\Kakukigou@kankaku}%
  \Subvec{#3}{#4}\kaku@u\Unitvec\kaku@u\kaku@u%
  \Subvec{#5}{#4}\kaku@v\Unitvec\kaku@v\kaku@v%
  \edef\hasen@opt{\empty}%
  \ukansan{.5mm}\Kakukigou@kankaku%
  \edef\u@pt{\empty}%
  \Strchr{#6}{=}\Kakukigou@tmp
  \ifnum\Kakukigou@tmp>\z@
    \Div{10}{\strip@pt\unitlength}\u@pt%
    \setkeys{emP}{#6}%
  \else\ifx\u@pt\empty
    \Div{10}{\strip@pt\unitlength}\u@pt%
    \Mul{#6}\u@pt\u@pt
  \fi\fi
  \Mulvec\u@pt\kaku@u\kaku@u@
  \Mulvec\u@pt\kaku@v\kaku@v@
  \Addvec{#4}\kaku@u@\kaku@u%
  \Addvec{#4}\kaku@v@\kaku@v%
  \Bunten\kaku@u\kaku@v11\B@M
  \Subvec\B@M{#4}\@BM
  \Mulvec{#7}\@BM\@Btyuusin
  \Addvec{#4}\@Btyuusin\@tyuusin
  \Kyori\@tyuusin\kaku@u\@hankei
  \edef\Kakuki@hankei{\@hankei}%        2004/01/22
  \Subvec\kaku@u\@tyuusin\@u\Argvec\@u\kaku@s
  \Subvec\kaku@v\@tyuusin\@v\Argvec\@v\kaku@e
  \ifdim\kaku@s pt>\kaku@e pt\relax\Add\kaku@e{360}\kaku@e\fi%
%\ifnum #2=\z@\emathPut\@tyuusin{#1}\fi
  \ifnum #2>0\relax
    \ifx a#1\Enko<yazirusi=a>\@tyuusin\Kakuki@hankei\kaku@s\kaku@e\else
    \ifx r#1\Enko<yazirusi=r>\@tyuusin\Kakuki@hankei\kaku@s\kaku@e\else
    \ifx b#1\Enko<yazirusi=b>\@tyuusin\Kakuki@hankei\kaku@s\kaku@e\else
      \Enko\@tyuusin\Kakuki@hankei\kaku@s\kaku@e
    \fi\fi\fi
    \ifthenelse{\equal\hasen@opt\empty}{%
      \ifdim\Kaku@nuri pt>\z@
        \emathPut\@tyuusin{\ougigata*[\Kaku@nuri]\Kakuki@hankei\kaku@s\kaku@e}%
      \fi
    }{\emathPut\@tyuusin{%
        \expandafter\Daenko\hasen@opt\Kakuki@hankei\Kakuki@hankei\kaku@s\kaku@e}%
    }%
    \ifx |#1\Add\kaku@s\kaku@e\kaku@m\Div\kaku@m{2}\kaku@m
      \Rdef(\Kakuki@hankei,\kaku@m)\arc@M\Addvec\@tyuusin\arc@M\arc@M
      \Div{\KAKUkigousize}{\strip@pt\unitlength}\l@l\Rdef(\l@l,\kaku@m)\@@M
      \Addvec\arc@M\@@M\@P\Subvec\arc@M\@@M\@Q\Drawline{\@P\@Q}\fi
    \ifnum #2>1\relax
%      \Mul{0.85}\Kakuki@hankei\@@hankei
      \Sub\@hankei\Kakukigou@kankaku\@@hankei
      \Enko\@tyuusin\@@hankei\kaku@s\kaku@e
      \ifnum #2>2\relax
%        \Mul{0.85}\@@hankei\@@hankei
         \Sub\@@hankei\Kakukigou@kankaku\@@hankei
        \Enko\@tyuusin\@@hankei\kaku@s\kaku@e
    \fi\fi
  \fi
  \Add\kaku@s\kaku@e\kaku@m\Div\kaku@m{2}\kaku@m
  \RPut[\@tyuusin](\Kakuki@hankei,\kaku@m)\KakukigouP}
%\def\@@@@Kakukigou[#1]<#2>#3#4#5<#6><#7>{%
%    \define@key{emP}{hankei}{\def\u@pt{##1}}%
%    \define@key{emP}{Hankei}{\templa=##1\relax
%      \Div{\strip@pt\templa}{\strip@pt\unitlength}\u@pt}%
%    \define@key{emP}{siteiten}{\Kyori{##1}{#4}\u@pt}%
%  \Subvec{#3}{#4}\kaku@u\Unitvec\kaku@u\kaku@u%
%  \Subvec{#5}{#4}\kaku@v\Unitvec\kaku@v\kaku@v%
%  \edef\hasen@opt{\empty}%
% \edef\u@pt{\empty}%
%  \Strchr{#6}{=}\Kakukigou@tmp
%  \ifnum\Kakukigou@tmp>\z@\setkeys{emP}{#6}\else
%    \ifx\u@pt\empty
%      \Div{10}{\strip@pt\unitlength}\u@pt%
%      \Mul{#6}\u@pt\u@pt
%  \fi\fi
%  \Mulvec\u@pt\kaku@u\kaku@u@
%  \Mulvec\u@pt\kaku@v\kaku@v@
%  \Addvec{#4}\kaku@u@\kaku@u%
%  \Addvec{#4}\kaku@v@\kaku@v%
%  \Bunten\kaku@u\kaku@v11\B@M
%  \Subvec\B@M{#4}\@BM
%  \Mulvec{#7}\@BM\@Btyuusin
%  \Addvec{#4}\@Btyuusin\@tyuusin
%  \Kyori\@tyuusin\kaku@u\@hankei
%  \Subvec\kaku@u\@tyuusin\@u\Argvec\@u\kaku@s
%  \Subvec\kaku@v\@tyuusin\@v\Argvec\@v\kaku@e
%  \ifdim\kaku@s pt>\kaku@e pt\relax\Add\kaku@e{360}\kaku@e\fi%
%  \ifnum #2>0\relax
%    \ifx a#1\emathPut\@tyuusin{\Yenko\@hankei\kaku@s\kaku@e}\else%
%    \ifx r#1\emathPut\@tyuusin{\Yenko[r]\@hankei\kaku@s\kaku@e}\else%
%    \ifx b#1\emathPut\@tyuusin{\Yenko[b]\@hankei\kaku@s\kaku@e}%
%    \fi\fi\fi
%    \ifthenelse{\equal\hasen@opt\empty}{%
%      \emathPut\@tyuusin{\@ifundefined{arc}{\enkoo\@hankei\kaku@s\kaku@e}{%
%      \ifdim\Kaku@nuri pt>\z@\ougigata*[\Kaku@nuri]\@hankei\kaku@s\kaku@e\fi
%      \enko\@hankei\kaku@s\kaku@e}}}{\emathPut\@tyuusin{%
%        \expandafter\Daenko\hasen@opt\@hankei\@hankei\kaku@s\kaku@e}}%
%    \ifx |#1\Add\kaku@s\kaku@e\kaku@m\Div\kaku@m{2}\kaku@m
%      \Rdef(\@hankei,\kaku@m)\arc@M\Addvec\@tyuusin\arc@M\arc@M
%      \Div{1}{\strip@pt\unitlength}\l@l\Rdef(\l@l,\kaku@m)\@@M
%      \Addvec\arc@M\@@M\@P\Subvec\arc@M\@@M\@Q\Drawline{\@P\@Q}\fi
%  \ifnum #2>1\relax
%  \Mul{0.85}\@hankei\@@hankei
%  \emathPut\@tyuusin{\@ifundefined{arc}{\enkoo\@hankei\kaku@s\kaku@e}{%
%       \enko\@@hankei\kaku@s\kaku@e}}%
%  \ifnum #2>2\relax
%  \Mul{0.85}\@@hankei\@@hankei
%  \emathPut\@tyuusin{\@ifundefined{arc}{\enkoo\@hankei\kaku@s\kaku@e}{%
%       \enko\@@hankei\kaku@s\kaku@e}}%
%  \fi\fi\fi
% \Add\kaku@s\kaku@e\kaku@m\Div\kaku@m{2}\kaku@m
% \RPut[\@tyuusin](\@hankei,\kaku@m)\KakukigouP}

%% 角の内部に円弧を描き，その傍に記号などを置く．
%\KAKUkigou[#1]<#2>#3#4#5[#6]<#7>#8
%    #1 : 円弧の上に置く記号
%     #1=a のときは角記号に矢印をつける．
%     #1=r のときは角記号に逆向きの矢印をつける．
%     #1=| のときは，円弧中央に円弧と垂直な短い線分
%    #2 : 円弧の個数
%    #3#4#5 : 角BAC
%       #4 が角の頂点
%       半直線 #4#3 を 回転して #4#5 に重ねる回転を表示する．
%    #6 : 円弧と頂点の距離係数（デフォルト値 1 ）
%    #7 : 円弧の中心と角の頂点位置（デフォルト値 0 ）
%    #8 : 角内の文字列

\def\KAKUkigousize{1}
\def\KAKUkigou{\edef\KAKU@nuri{0}\@ifstar{\KAKUkigou@s}{\KAKUkigou@}}
\def\KAKUkigou@s{\@ifnextchar[{\KAKUkigou@@}{\KAKUkigou@@[.5]}}
\def\KAKUkigou@@[#1]{\edef\KAKU@nuri{#1}\KAKUkigou@}
\def\KAKUkigou@{\@ifnextchar[{\@KAKUkigou}{\@KAKUkigou[\empty]}}%
\def\@KAKUkigou[#1]{\@ifnextchar<{\@@KAKUkigou[#1]}{%
  \@@KAKUkigou[#1]<1>}}%
\def\@@KAKUkigou[#1]<#2>#3#4#5{\@ifnextchar[{%
  \@@@KAKUkigou[#1]<#2>{#3}{#4}{#5}}{%
  \@@@KAKUkigou[#1]<#2>{#3}{#4}{#5}[1]}}%
\def\@@@KAKUkigou[#1]<#2>#3#4#5[#6]{\@ifnextchar<{%
  \@@@@KAKUkigou[#1]<#2>{#3}{#4}{#5}[#6]}{%
  \@@@@KAKUkigou[#1]<#2>{#3}{#4}{#5}[#6]<0>}}%
\def\@@@@KAKUkigou[#1]<#2>#3#4#5[#6]<#7>#8{%
  \Subvec{#3}{#4}\kaku@u\Unitvec\kaku@u\kaku@u%
  \Subvec{#5}{#4}\kaku@v\Unitvec\kaku@v\kaku@v%
  \Div{10}{\strip@pt\unitlength}\u@pt%
  \Mul{#6}\u@pt\u@pt%
  \Mulvec\u@pt\kaku@u\kaku@u@
  \Mulvec\u@pt\kaku@v\kaku@v@
  \Addvec{#4}\kaku@u@\kaku@u%
  \Addvec{#4}\kaku@v@\kaku@v%
  \Bunten\kaku@u\kaku@v11\B@M
  \Subvec\B@M{#4}\@BM
  \Mulvec{#7}\@BM\@Btyuusin
  \Addvec{#4}\@Btyuusin\@tyuusin
  \Kyori\@tyuusin\kaku@u\@hankei
  \Subvec\kaku@u\@tyuusin\@u\Argvec\@u\kaku@s
  \Subvec\kaku@v\@tyuusin\@v\Argvec\@v\kaku@e
  \ifdim\kaku@s pt>\kaku@e pt\relax\Add\kaku@e{360}\kaku@e\fi%
  \ifnum #2>0\relax
    \ifx a#1\emathPut\@tyuusin{\yenko\@hankei\kaku@s\kaku@e}\else%
    \ifx r#1\emathPut\@tyuusin{\yenko[r]\@hankei\kaku@s\kaku@e}\else%
    \emathPut\@tyuusin{\@ifundefined{arc}{\enkoo\@hankei\kaku@s\kaku@e}{%
    \ifdim\KAKU@nuri pt>\z@\ougigata*[\KAKU@nuri]\@hankei\kaku@s\kaku@e\fi
    \enko\@hankei\kaku@s\kaku@e}}\fi\fi%
    \ifx |#1\Add\kaku@s\kaku@e\kaku@m\Div\kaku@m{2}\kaku@m
      \Rdef(\@hankei,\kaku@m)\arc@M\Addvec\@tyuusin\arc@M\arc@M
%\Kuromaru\arc@M
      \Div{\KAKUkigousize}{\strip@pt\unitlength}\l@l\Rdef(\l@l,\kaku@m)\@@M
      \Addvec\arc@M\@@M\@P\Subvec\arc@M\@@M\@Q\Drawline{\@P\@Q}\fi
  \ifnum #2>1\relax
  \Mul{0.85}\@hankei\@@hankei
    \emathPut\@tyuusin{\@ifundefined{arc}{\enkoo\@hankei\kaku@s\kaku@e}{%
      \enko\@@hankei\kaku@s\kaku@e}}%
  \ifnum #2>2\relax
  \Mul{0.85}\@@hankei\@@hankei
    \emathPut\@tyuusin{\@ifundefined{arc}{\enkoo\@hankei\kaku@s\kaku@e}{%
      \enko\@@hankei\kaku@s\kaku@e}}%
  \fi\fi\fi
  \Add\kaku@s\kaku@e\kaku@m\Div\kaku@m{2}\kaku@m
  \Div{2}{\strip@pt\unitlength}\@u@pt%
  \Add\@hankei\@u@pt\@@hankei
% \Rdef(\@hankei,\kaku@m)\@P\Addvec\@tyuusin\@P\@kakuP
  \Rdef[\@tyuusin](\@@hankei,\kaku@m)\KAKUkigou@P
% \Addvec\@tyuusin\KAKUkigou@P\KAKUkigou@P
  \emathPut\KAKUkigou@P{#8}%
}%
%
% 等角記号
%   \toukakukigou[#1]<#2>#3<#4><#5>
%     #1 : 記号（デフォルトは | ）
%     #2 : 個数
%     #3 : 角の列（区切子は`;'）
%     #4 : 円弧と頂点の距離係数（デフォルト値 1 ）
%        hankei=（無名数） 半径の指定
%        Hankie=（単位付）     〃
%        siteiten=         円弧が指定点を通過
%     #5 : 円弧の中心と角の頂点位置（デフォルト値 0 ）
%
\def\toukakukigou{%
  \edef\toukaku@nuri{0}\@ifstar{\toukakukigou@s}{%
  \toukakukigou@ns}}
\def\toukakukigou@s{\@ifnextchar[{\toukakukigou@@s}{\toukakukigou@@s[.5]}}
\def\toukakukigou@@s[#1]{\edef\toukaku@nuri{#1}\toukakukigou@ns}
\def\toukakukigou@ns{%
  \@ifnextchar[{\@toukakukigou}{%
    \@toukakukigou[|]}}
\def\@toukakukigou[#1]{\@ifnextchar<{\@@toukakukigou[#1]}{%
    \@@toukakukigou[#1]<\@ne>}}
\def\@@toukakukigou[#1]<#2>#3{\@ifnextchar<{\@@@toukakukigou[#1]<#2>{#3}}{%
  \@@@toukakukigou[#1]<#2>{#3}<1>}}
\def\@@@toukakukigou[#1]<#2>#3<#4>{%
  \@ifnextchar<{\@@@@toukakukigou[#1]<#2>{#3}<#4>}{%
  \@@@@toukakukigou[#1]<#2>{#3}<#4><0>}}
\def\@@@@toukakukigou[#1]<#2>#3<#4><#5>{%
    \def\toukakukigou@sub(##1,##2)(##3,##4)(##5,##6){%
      \edef\toukakukigou@a{(##1,##2)}%
      \edef\toukakukigou@b{(##3,##4)}%
      \edef\toukakukigou@c{(##5,##6)}}%
  \argsep{#3}{;}{toukakukigou@tmp}\toukakukigou@n
  \Cfor{\edef\toukakukigou@i{0}}{\toukakukigou@i<\toukakukigou@n}{}\do{%
    \Incr\toukakukigou@i
    \edef\toukakukigou@arg{%
      \csname toukakukigou@tmp\romannumeral\toukakukigou@i\endcsname}%
    \expandafter\toukakukigou@sub\toukakukigou@arg
    \ifthenelse{\equal{\toukaku@nuri}{0}}{%
      \Kakukigou[#1]<#2>\toukakukigou@a\toukakukigou@b\toukakukigou@c<#4><#5>\relax}{%
      \Kakukigou*[\toukaku@nuri][#1]<#2>\toukakukigou@a\toukakukigou@b\toukakukigou@c<#4><#5>\relax}
  }%
}
%%
%% 等角記号
%%   \toukakukigou[#1]<#2>#3
%%     #1 : 記号（デフォルトは | ）
%%     #2 : 個数
%%     #3 : 角の列（区切子は`;'）
%%
%\def\toukakukigou{%
%  \edef\toukaku@nuri{0}\@ifstar{\toukakukigou@s}{%
%  \toukakukigou@ns}}
%\def\toukakukigou@s{\@ifnextchar[{\toukakukigou@@s}{\toukakukigou@@s[.5]}}
%\def\toukakukigou@@s[#1]{\edef\toukaku@nuri{#1}\toukakukigou@ns}
%\def\toukakukigou@ns{%
%  \@ifnextchar[{\@toukakukigou}{%
%    \@toukakukigou[|]}}
%\def\@toukakukigou[#1]{\@ifnextchar<{\@@toukakukigou[#1]}{%
%    \@@toukakukigou[#1]<\@ne>}}
%\def\@@toukakukigou[#1]<#2>#3{%
%    \def\toukakukigou@sub(##1,##2)(##3,##4)(##5,##6){%
%      \edef\toukakukigou@a{(##1,##2)}%
%      \edef\toukakukigou@b{(##3,##4)}%
%      \edef\toukakukigou@c{(##5,##6)}}%
%  \argsep{#3}{;}{toukakukigou@tmp}\toukakukigou@n
%  \Cfor{\edef\toukakukigou@i{0}}{\toukakukigou@i<\toukakukigou@n}{}\do{%
%    \Incr\toukakukigou@i
%    \edef\toukakukigou@arg{%
%      \csname toukakukigou@tmp\romannumeral\toukakukigou@i\endcsname}%
%    \expandafter\toukakukigou@sub\toukakukigou@arg
%    \ifthenelse{\equal{\toukaku@nuri}{0}}{%
%      \KAKUkigou[#1]<#2>\toukakukigou@a\toukakukigou@b\toukakukigou@c}{%
%      \KAKUkigou*[\toukaku@nuri][#1]<#2>\toukakukigou@a\toukakukigou@b
%               \toukakukigou@c}
%  }%
%}
%
% 一般角
%
%\ippankaku<#1><#2>[#3](#4)#5
%        #1 : a の倍率
%        #2 : b の倍率
%        #3 : 始め角（六十分法）
%        #4 : 矢印の配置
%          e = 終端（デフォルト）
%          s = 始端
%          b = 両端
%          n = なし
%        #5 : 終り角（六十分法）
%
\def\rasenP#1#2{%
    \DegRad{#1}\@kaku
    \Mul\@kaku\@rasen@a\@rasen@r
    \Add\@rasen@r\@rasen@b\@r
    \Cos\@kaku\owariP@x\Mul\@r\owariP@x\owariP@x
    \Sin\@kaku\owariP@y\Mul\@r\owariP@y\owariP@y
    \edef#2{(\owariP@x,\owariP@y)}}
\def\rasenR#1#2{\Mul{#1}\@rasen@a\@rasen@r\Add\@rasen@r\@rasen@b#2}
\def\ippankaku{\@ifnextchar<{\@ippankaku}{\@ippankaku<\empty>}}
\def\@ippankaku<#1>{\@ifnextchar<{\@@ippankaku<#1>}{\@@ippankaku<#1><\empty>}}
\def\@@ippankaku<#1><#2>{\@ifnextchar[{\@@@ippankaku<#1><#2>}{%
  \@@@ippankaku<#1><#2>[0]}}
\def\@@@ippankaku<#1><#2>[#3]{\@ifnextchar({\@@@@ippankaku<#1><#2>[#3]}{%
  \@@@@ippankaku<#1><#2>[#3](e)}}
\def\@@@@ippankaku<#1><#2>[#3](#4)#5{%
  \ifx#1\empty\def\@rasen@a{0.02}\else\Mul{#1}{0.02}\@rasen@a\fi%
  \ifx#2\empty\def\@rasen@b{0.2}\else\Mul{#2}{0.2}\@rasen@b\fi%
  \DegRad{#3}\@kaku@s
  \DegRad{#5}\@kaku@e
  \ifdim\@kaku@e pt>\@kaku@s pt\relax
    \rGurafu\rasenR{\@kaku@s}{\@kaku@e}%
  \else
    \ifdim\@rasen@a pt>\z@\Mul{-1}\@rasen@a\@rasen@a\fi
    \rGurafu\rasenR{\@kaku@e}{\@kaku@s}%
  \fi
%\rGurafu\rasenR\@kaku@e\@kaku@e
\ifthenelse{\equal{#4}{s}\or\equal{#4}{b}}{%
  \rasenR\@kaku@s\@r
  \Cos\@kaku@s\owariP@x\Mul\@r\owariP@x\owariP@x
  \Sin\@kaku@s\owariP@y\Mul\@r\owariP@y\owariP@y
  \Div\ArrowHeadSize\@r\kaku@d
  \ifdim\@kaku@e pt>\z@
    \Add\@kaku@s\kaku@d\@kaku@rr
  \else
    \Sub\@kaku@s\kaku@d\@kaku@rr
  \fi
  \rasenR\@kaku@rr\@rr
  \Cos\@kaku@rr\owariP@xx\Mul\@rr\owariP@xx\owariP@xx
  \Sin\@kaku@rr\owariP@yy\Mul\@rr\owariP@yy\owariP@yy
  \Sub\owariP@x\owariP@xx\owariP@xx
  \Sub\owariP@y\owariP@yy\owariP@yy
  \Put{(\owariP@x,\owariP@y)}{\yaziri{(\owariP@xx,\owariP@yy)}}%
}{}%
\ifthenelse{\equal{#4}{e}\or\equal{#4}{b}}{%
  \rasenR\@kaku@e\@r
  \Cos\@kaku@e\owariP@x\Mul\@r\owariP@x\owariP@x
  \Sin\@kaku@e\owariP@y\Mul\@r\owariP@y\owariP@y
  \Div\ArrowHeadSize\@r\kaku@d
  \ifdim\@kaku@e pt>\z@
    \Sub\@kaku@e\kaku@d\@kaku@rr
  \else
    \Add\@kaku@e\kaku@d\@kaku@rr
  \fi
  \rasenR\@kaku@rr\@rr
  \Cos\@kaku@rr\owariP@xx\Mul\@rr\owariP@xx\owariP@xx
  \Sin\@kaku@rr\owariP@yy\Mul\@rr\owariP@yy\owariP@yy
  \Sub\owariP@x\owariP@xx\owariP@xx
  \Sub\owariP@y\owariP@yy\owariP@yy
  \Put{(\owariP@x,\owariP@y)}{\yaziri{(\owariP@xx,\owariP@yy)}}}{}}
%
%
%\def\ArrowHeadSize{0.06}%
%\def\ArrowHeadSize{0.1}%
\def\ArrowHeadSize{0.12}%
\def\Arr@wHeadSize{0.12}%
\def\ArrowHeadAngle{18}%
\def\ArrowHeadAxis{90}%
\def\ArrowHeadType{f}%
\def\ArrowHeadPit{0}%
%\def\changeArrowHeadSize#1{\Mul\ArrowHeadSize{#1}\ArrowHeadSize%
%  \templa=0.033\unitlength\ifdim\templa>\z@
%  \Div{\ArrowHeadSize}{\strip@pt\templa}\Arr@wHeadSize\fi}
\def\changeArrowHeadSize{\@ifnextchar[{\changeArrowHeadSize@}{%
  \changeArrowHeadSize@[\ArrowHeadAngle]}}
\def\changeArrowHeadSize@[#1]{\edef\ArrowHeadAngle{#1}%
  \@ifnextchar<{\changeArrowHeadSize@@}{\@changeArrowHeadSize}}
\def\changeArrowHeadSize@@<#1>{\edef\ArrowHeadPit{#1}%
  \@changeArrowHeadSize}%
\def\@changeArrowHeadSize#1{\Mul\ArrowHeadSize{#1}\ArrowHeadSize%
  \templa0.033\unitlength
  \ifdim\templa>\z@\relax
    \Div{\ArrowHeadSize}{\strip@pt\templa}\Arr@wHeadSize
  \fi
}
%
% 鏃のみを描く
% \yaziri#1
%   #1 : 方向ベクトル
%   置く位置は \put または \emathPut で指定する．
% \Yaziri[#1]#2#3
%   #1 : rのとき，逆向き
%   #2 : 端末の位置
%   #3 : 方向ベクトル
%
\def\yaziri{\@ifnextchar[{\@yaziri}{\@yaziri[\empty]}}%
\def\Yaziri{\@ifnextchar[{\@Yaziri}{\@Yaziri[\empty]}}%
\def\@Yaziri[#1]#2#3{\emathPut{#2}{\yaziri[#1]{#3}}}
%
\def\@yaziri[#1]#2{{\thinlines
  \ifdim\Arr@wHeadSize pt>\z@
    \ifx r#1\Mulvec{-1}{#2}\@houkou\else\edef\@houkou{#2}\fi
    \@ifundefined{xunitlength}{}{\MulS\@houkou\@houkou
      \xunitlength=\unitlength\yunitlength=\unitlength
    }%
    \Argvec\@houkou\houkou@kaku
    \Add\houkou@kaku{180}\houkou@kaku
    \Add\houkou@kaku\ArrowHeadAngle\kaku@s
    \Sub\houkou@kaku\ArrowHeadAngle\kaku@e
    \Rdef(\Arr@wHeadSize,\kaku@s)\@P
    \Rdef(\Arr@wHeadSize,\kaku@e)\@Q
    \DegCos\ArrowHeadAngle\yaziri@c\Mul\Arr@wHeadSize\yaziri@c\yaziri@c
    \DegSin\ArrowHeadAngle\yaziri@s\Mul\Arr@wHeadSize\yaziri@s\yaziri@s
    \Tyuuten\@P\@Q\yaziri@@M
    \vecXY\yaziri@@M\yaziri@@Mx\yaziri@@My
    \@ifundefined{@xscale}{%
      \xdef\yaziri@@M{\yaziri@@M}%
    }{%
      \Div\yaziri@@Mx\@xscale\yaziri@@Mx
      \Div\yaziri@@My\@yscale\yaziri@@My
      \xdef\yaziri@@M{(\yaziri@@Mx,\yaziri@@My)}%
    }%
    \if f\ArrowHeadType
      \ifdim\ArrowHeadPit\p@=\z@
        \Nuritubusi[\Nurizen]{(0,0)\@P\@Q(0,0)}%
      \else
        \Sub{1}{\ArrowHeadPit}\ArrowHeadPiti
        \Bunten\yaziri@@M{(0,0)}\ArrowHeadPit\ArrowHeadPiti\yaziri@@M
        \xdef\yaziri@@M{\yaziri@@M}%
        \Nuritubusi[\Nurizen]{(0,0)\@P\yaziri@@M\@Q(0,0)}%
      \fi
    \else
      \Put{(0,0)}{\Drawline{\@P(0,0)\@Q}}%
    \fi
  \fi
}}
%
\def\Unitvec#1#2{\edef\ev@tmp{#1}%
  \expandafter\Unit\ev@tmp(\ev@x,\ev@y)\edef#2{(\ev@x,\ev@y)}}%

% 等辺記号
%   \Touhenkigou[#1]<#2><#3>(#4)#5#6
%     #1 : 記号（デフォルトは | ）
%     #2 : 個数
%     #3 : #2で複数を指定した場合の記号間間隔（デフォルト0.5pt）
%     #4 : 位置（デフォルトは0.5，すなわち中点）
%     #5, #6 : 線分の両端
%
\def\Touhenkigou{\@ifnextchar[{\@Touhenkigou}{%
    \@Touhenkigou[$\scriptscriptstyle |$]}}
\def\@Touhenkigou[#1]{\@ifnextchar<{\@@Touhenkigou[#1]}{%
    \@@Touhenkigou[#1]<\@ne>}}
\def\@@Touhenkigou[#1]<#2>{\@ifnextchar<{\@@@Touhenkigou[#1]<#2>}{%
  \@@@Touhenkigou[#1]<#2><0pt>}}
\def\@@@Touhenkigou[#1]<#2><#3>{\@ifnextchar({\@@@@Touhenkigou[#1]<#2><#3>}{%
    \@@@@Touhenkigou[#1]<#2><#3>(0.5)}}
\def\@@@@Touhenkigou[#1]<#2><#3>(#4)#5#6{%
  \Sub{1}{#4}\T@tmp\Bunten{#5}{#6}{#4}{\T@tmp}\T@m
  \Subvec{#6}{#5}\@v\Argvec\@v\@a
    \emathPut\T@m{\rotatebox{\@a}{%
        \ifnum#2=1\makebox(0,0){#1}\else
        \ifnum#2=2\makebox(0,0){#1\hspace*{#3}#1}\else
        \ifnum#2=3\makebox(0,0){#1\hspace*{#3}#1\hspace*{#3}#1}%
        \fi\fi\fi
    }}%
}
% 等辺記号
%   \touhenkigou[#1]<#2>(#3)#4
%     #1 : 記号（デフォルトは | ）
%     #2 : 個数
%     #3 : 位置（デフォルトは0.5，すなわち中点）
%     #4 : 線分列（区切子は`;'）
%
\def\touhenkigou{\@ifnextchar[{\@touhenkigou}{%
    \@touhenkigou[$\scriptscriptstyle |$]}}
\def\@touhenkigou[#1]{\@ifnextchar<{\@@touhenkigou[#1]}{%
    \@@touhenkigou[#1]<\@ne>}}
\def\@@touhenkigou[#1]<#2>{\@ifnextchar<{\@@@touhenkigou[#1]<#2>}{%
  \@@@touhenkigou[#1]<#2><0pt>}}
\def\@@@touhenkigou[#1]<#2><#3>{\@ifnextchar({\@@@@touhenkigou[#1]<#2><#3>}{%
    \@@@@touhenkigou[#1]<#2><#3>(0.5)}}
\def\@@@@touhenkigou[#1]<#2><#3>(#4)#5{%
    \def\touhenkigou@sub(##1,##2)(##3,##4){%
      \edef\touhenkigou@a{(##1,##2)}%
      \edef\touhenkigou@b{(##3,##4)}}%
  \argsep{#5}{;}{touhenkigou@tmp}\touhenkigou@n
  \Cfor{\edef\touhenkigou@i{0}}{\touhenkigou@i<\touhenkigou@n}{}\do{%
    \Incr\touhenkigou@i
    \edef\touhenkigou@arg{%
      \csname touhenkigou@tmp\romannumeral\touhenkigou@i\endcsname}%
    \expandafter\touhenkigou@sub\touhenkigou@arg
    \Touhenkigou[#1]<#2><#3>(#4)\touhenkigou@a\touhenkigou@b
  }%
}

% 等弧記号
%     円弧の長さが等しいことを表す記号
% \Toukokigou
%   Toukokigou[#1]<#2>#3#4#5
%   #1 : 記号
%   #2 : 線分の本数
%   #3 : 円弧の中心
%   #4 : 弧の端点1
%   #5 : 弧の端点2
% \toukokigou
%   複数の弧を ; 区切りで並べる
%
\def\toukokigou{\@ifnextchar[{\@toukokigou}{%
  \@toukokigou[$\scriptscriptstyle |$]}}
\def\@toukokigou[#1]{\@ifnextchar<{\@@toukokigou[#1]}{\@@toukokigou[#1]<1>}}
\def\@@toukokigou[#1]<#2>#3{%
    \def\toukokigou@sub(##1,##2)(##3,##4)(##5,##6){%
      \edef\toukokigou@a{(##1,##2)}%
      \edef\toukokigou@b{(##3,##4)}%
      \edef\toukokigou@c{(##5,##6)}%
    }%
  \argsep{#3}{;}{toukokigou@tmp}\toukokigou@n
  \Cfor{\edef\toukokigou@i{0}}{\toukokigou@i<\toukokigou@n}{}\do{%
    \Incr\toukokigou@i
    \edef\toukokigou@arg{%
      \csname toukokigou@tmp\romannumeral\toukokigou@i\endcsname}%
    \expandafter\toukokigou@sub\toukokigou@arg
    \Toukokigou[#1]<#2>\toukokigou@a\toukokigou@b\toukokigou@c
  }%
}
\def\Toukokigou{\@ifnextchar[{\@Toukokigou}{%
  \@Toukokigou[$\scriptscriptstyle |$]}}
\def\@Toukokigou[#1]{\@ifnextchar<{\@@Toukokigou[#1]}{\@@Toukokigou[#1]<1>}}
\def\@@Toukokigou[#1]<#2>#3#4#5{%
  \Subvec{#4}{#3}\Toukokigou@tmp\Argvec\Toukokigou@tmp\@hazimekaku
  \Subvec{#5}{#3}\Toukokigou@tmp\Argvec\Toukokigou@tmp\@owarikaku
  \ifdim\@owarikaku pt<\@hazimekaku pt\relax\Add\@owarikaku{360}\@owarikaku\fi
  \Add\@hazimekaku\@owarikaku\Toukokigou@tmp
  \Div\Toukokigou@tmp{2}\Toukokigou@tmp
  \Kyori{#3}{#4}\@hankei
  \emathPut{#3}{\Rdef(\@hankei,\Toukokigou@tmp)\Toukokigou@M
    \Add\Toukokigou@tmp{90}\Toukokigou@tmp
    \emathPut\Toukokigou@M{\rotatebox{\Toukokigou@tmp}{%
      \ifnum#2=1\makebox(0,0)[c]{#1}\else
      \ifnum#2=2\makebox(0,0){#1\hspace*{0.5pt}#1}\else
      \ifnum#2=3\makebox(0,0){#1\hspace*{0.5pt}#1\hspace*{0.5pt}#1}%
      \fi\fi\fi}}}%
}%
%
%\def\Toukokigou{\@ifnextchar<{\@Toukokigou}{\@Toukokigou<1>}}
%\def\@Toukokigou<#1>#2#3#4{%
%  \Subvec{#3}{#2}\Toukokigou@tmp\Argvec\Toukokigou@tmp\@hazimekaku
%  \Subvec{#4}{#2}\Toukokigou@tmp\Argvec\Toukokigou@tmp\@owarikaku
%  \ifdim\@owarikaku pt<\@hazimekaku pt\relax\Add\@owarikaku{360}\@owarikaku\fi
%  \Add\@hazimekaku\@owarikaku\Toukokigou@tmp
%  \Div\Toukokigou@tmp{2}\Toukokigou@tmp
%  \Kyori{#2}{#3}\@hankei
%  \emathPut{#2}{\Rdef(\@hankei,\Toukokigou@tmp)\Toukokigou@M
%    \Add\Toukokigou@tmp{90}\Toukokigou@tmp
%    \emathPut\Toukokigou@M{\rotatebox{\Toukokigou@tmp}{%
%      \ifnum#1=1\makebox(0,0)[c]{$\scriptscriptstyle |$}\else
%      \ifnum#1=3\makebox(0,0)[c]{$\scriptscriptstyle |||$}\fi\fi\fi}}}%
%}%

% 平行記号
% 線分の中央に，記号 `>' を配置する。
% \heikoukigou[#1]#2
%   #1 : 記号の個数
%     または key=val
%       heikoukigoukosuu=記号の個数（デフォルト値は1）
%       heikoukigouiti  =記号の位置（デフォルト値は0.5, すなわち線分の中点）
%       heikoukigoukankaku=記号を複数配置するときの間隔
%                         （デフォルト値は 1mm）
%       heikoukigousize =記号の大きさ（デフォルト値は2）
%   #2 : 線分の列を`;'区切りで列記する．

\def\heikoukigou{\@ifnextchar[{\@heikoukigou}{\@heikoukigou[1]}}
\def\@heikoukigou[#1]#2{%
    \def\heikoukigou@sub(##1,##2)(##3,##4){%
      \edef\heikoukigou@a{(##1,##2)}%
      \edef\heikoukigou@b{(##3,##4)}}%
  \argsep{#2}{;}{heikoukigou@tmp}\heikoukigou@n
  \Cfor{\edef\heikoukigou@i{0}}{\heikoukigou@i<\heikoukigou@n}{}\do{%
    \Incr\heikoukigou@i
    \edef\heikoukigou@arg{%
      \csname heikoukigou@tmp\romannumeral\heikoukigou@i\endcsname}%
    \expandafter\heikoukigou@sub\heikoukigou@arg
    \Heikoukigou[#1]\heikoukigou@a\heikoukigou@b
  }%
}
%
% \Heikoukigou[#1]#2#3
%   #1 : 記号の個数
%   #2,#3 : 線分の両端の点
%
\def\HK@kankaku{1mm}%
\def\HeikoukigouKankaku#1{\def\HK@kankaku{#1}}%
\def\Heikoukigou{\@ifnextchar[{\@Heikoukigou}{\@Heikoukigou[1]}}
\def\@Heikoukigou[#1]#2#3{{\def\ArrowHeadType{l}%
  \def\HK@kosuu{1}%
  \def\HK@iti{.5}%
  \def\HK@size{2}%
  \Kyori{#2}{#3}\HK@kyori
  \Div\HK@kyori{2}\HK@hkyori
  \define@key{emP}{heikoukigouiti}{\def\HK@iti{##1}}%
  \define@key{emP}{heikoukigoukosuu}{\def\HK@kosuu{##1}}%
  \define@key{emP}{heikoukigousize}{\def\HK@size{##1}}%
%  \define@key{emP}{heikoukigoukankaku}{\def\HK@kankaku{##1}}%
  \define@key{emP}{heikoukigoukankaku}{\appendU{##1}\HK@kankaku}%
  \Strchr{#1}{=}\HK@tmp
  \ifnum\HK@tmp>\z@\setkeys{emP}{#1}\else\def\HK@kosuu{#1}\fi
  \ukansan\HK@kankaku\HK@ukankaku
  \changeArrowHeadSize{\HK@size}%
  \ifnum\HK@kosuu=\@ne
    \ArrowLine[\HK@iti]{#2}{#3}%
  \else\ifnum\HK@kosuu=\tw@
    \Div\HK@ukankaku{2}\HK@tmp
    \Add\HK@hkyori\HK@tmp\HK@@iti
      \Div\HK@@iti\HK@kyori\HK@@iti\ArrowLine[\HK@@iti]{#2}{#3}%
    \Sub\HK@hkyori\HK@tmp\HK@@iti
      \Div\HK@@iti\HK@kyori\HK@@iti\ArrowLine[\HK@@iti]{#2}{#3}%
  \else\ifnum\HK@kosuu=3\relax
    \ArrowLine[\HK@iti]{#2}{#3}%
    \Add\HK@hkyori\HK@ukankaku\HK@@iti
      \Div\HK@@iti\HK@kyori\HK@@iti\ArrowLine[\HK@@iti]{#2}{#3}%
    \Sub\HK@hkyori\HK@ukankaku\HK@@iti
      \Div\HK@@iti\HK@kyori\HK@@iti\ArrowLine[\HK@@iti]{#2}{#3}%
  \else\ifnum\HK@kosuu=4\relax
    \Div\HK@ukankaku{2}\HK@tmp
    \Add\HK@hkyori\HK@tmp\HK@@iti
      \Div\HK@@iti\HK@kyori\HK@@iti\ArrowLine[\HK@@iti]{#2}{#3}%
    \Add\HK@hkyori\HK@tmp\HK@@iti
    \Add\HK@@iti\HK@ukankaku\HK@@iti
      \Div\HK@@iti\HK@kyori\HK@@iti\ArrowLine[\HK@@iti]{#2}{#3}%
    \Sub\HK@hkyori\HK@tmp\HK@@iti
      \Div\HK@@iti\HK@kyori\HK@@iti\ArrowLine[\HK@@iti]{#2}{#3}%
    \Sub\HK@hkyori\HK@tmp\HK@@iti
    \Sub\HK@@iti\HK@ukankaku\HK@@iti
      \Div\HK@@iti\HK@kyori\HK@@iti\ArrowLine[\HK@@iti]{#2}{#3}%
  \else
    \errmessage{emathPh Error : 平行記号の個数は 1,2,3,4 のいずれかです。}%
  \fi\fi\fi\fi}}
%
% -----------------------------------------------\hen_ko -------------
% 線分の傍に円弧状のものをつけ長さなどを示す．
%
%   \hen_ko[曲線上のドット数]<弧と線分の距離係数>
%           (端点１ x,y)(端点２ x,y)[文字配置]<文字位置係数>{文字列}
%
%     **********************************************
%     * このコマンドで，                           *
%     *     円弧ではなくベジェ曲線を用いること     *
%     *     弧の中央部を切って文字列を置く方法     *
%     * は，bookworm さん (BYV01204) のご提案です．*
%     *     ありがとうございます．＞ bookworm さん *
%     **********************************************
%
 \define@key{emP}{henkosep}{\edef\henko@sep{#1}}%
 \define@key{emP}{henkomozikaiten}{\edef\henko@mozikaiten{#1}}%
%
%   弧の中央部を切って，そこに文字列を置くためのスイッチ
\newif\ifsironuki
\ifx\fmtname\tmpname\sironukitrue\else\sironukifalse\fi

\def\hen_ko{\@ifnextchar[{\@hen_ko}{\@hen_ko[0]}}%
\def\@hen_ko[#1]{\@ifnextchar<{\@@hen_ko[#1]}{\@@hen_ko[#1]<1>}}%
\def\@@hen_ko[#1]<#2>(#3,#4)(#5,#6){%
    \@ifnextchar[{\@@@hen_ko[#1]<#2>(#3,#4)(#5,#6)}{%
        \@@@hen_ko[#1]<#2>(#3,#4)(#5,#6)[c]}}%
\def\@@@hen_ko[#1]<#2>(#3,#4)(#5,#6)[#7]{%
    \@ifnextchar<{\@@@@hen_ko[#1]<#2>(#3,#4)(#5,#6)[#7]}{%
        \@@@@hen_ko[#1]<#2>(#3,#4)(#5,#6)[#7]<\empty>}}%
\def\@@@@hen_ko[#1]<#2>(#3,#4)(#5,#6)[#7]<#8>#9{%
   \def\@syukusyo{#2}%
    \Add{#3}{#5}\henko@x\Div\henko@x{2}\henko@x%
    \Add{#4}{#6}\henko@y\Div\henko@y{2}\henko@y%
    \Sub{#6}{#4}\henko@@x\Sub{#3}{#5}\henko@@y%
    \Unitvec{(\henko@@x,\henko@@y)}\henko@@xy
    \vecXY\henko@@xy\henko@@x\henko@@y
      \Div{40}{\strip@pt\unitlength}\u@pt%
      \Mul\u@pt\henko@@x\henko@@x\Mul\u@pt\henko@@y\henko@@y%
    \Mul\@syukusyo\henko@@x\henko@@x\Add\henko@x\henko@@x\henko@xx%
    \Mul\@syukusyo\henko@@y\henko@@y\Add\henko@y\henko@@y\henko@yy%
    \ifx\empty #1%
        \qbezier(#3,#4)(\henko@xx,\henko@yy)(#5,#6)%
    \else\ifx 0#1\else
        \qbezier[#1](#3,#4)(\henko@xx,\henko@yy)(#5,#6)\fi\fi%
    \edef\put@opt{}%
    \edef\henko@sep{1pt}%
    \def\henko@mozikaiten{0}%
    \def\yazirusi@opt{\empty}%
    \Strchr{#8}{=}\Henko@tmp
    \ifnum\Henko@tmp>\z@
      \setkeys{emP}{#8}\def\Henko@keisuu{\ifsironuki.5\else.8\fi}\else
      \ifx\empty #8\def\Henko@keisuu{\ifsironuki.5\else.8\fi}\else
      \def\Henko@keisuu{#8}\fi\fi
\ifthenelse{\equal{\yazirusi@opt}{a}\or\equal{\yazirusi@opt}{b}}{%
  \Subvec{(#5,#6)}{(\henko@xx,\henko@yy)}\henko@tmp
% \emathPut{(#5,#6)}{\yaziri\henko@tmp}%
  \Yaziri{(#5,#6)}{\henko@tmp}%
}{}%
\ifthenelse{\equal{\yazirusi@opt}{r}\or\equal{\yazirusi@opt}{b}}{%
  \Subvec{(#3,#4)}{(\henko@xx,\henko@yy)}\henko@tmp
%  \emathPut{(#3,#4)}{\yaziri\henko@tmp}%
  \Yaziri{(#3,#4)}{\henko@tmp}%
}{}%
    \ifnum\henko@mozikaiten=\z@
      \edef\henko@mozikaitenkaku{0}%
    \else
      \Subvec{(#3,#4)}{(#5,#6)}\henko@v\Argvec\henko@v\henko@mozikaitenkaku
    \fi
    \ifdim \henko@mozikaitenkaku pt>90pt
      \Sub\henko@mozikaitenkaku{180}\henko@mozikaitenkaku\else
    \ifdim \henko@mozikaitenkaku pt<-90pt
      \Add\henko@mozikaitenkaku{180}\henko@mozikaitenkaku\fi\fi
    \ifnum\henko@mozikaiten<\z@
      \ifdim \henko@mozikaitenkaku pt>\z@
        \Sub\henko@mozikaitenkaku{180}\henko@mozikaitenkaku
      \else
        \Add\henko@mozikaitenkaku{180}\henko@mozikaitenkaku
      \fi
    \fi
    \Mul\Henko@keisuu\henko@@x\henko@@x
    \Mul\Henko@keisuu\henko@@y\henko@@y%
    \Add\henko@x\henko@@x\henko@xx\Add\henko@y\henko@@y\henko@yy%
    \IFempty{#9}{}{%
      \ifx\put@opt\empty
        \ifnum\henko@mozikaiten=\z@%
          \put(\henko@xx,\henko@yy){%
          \ifsironuki{\fboxsep\henko@sep
            \makebox(0,0)[#7]{\colorbox{white}{#9}}}%
          \else\makebox(0,0)[#7]{#9}\fi}%
        \else
          \ifsironuki{\fboxsep\henko@sep
               \emathPut[background=white,kaiten=\henko@mozikaitenkaku]{%
               (\henko@xx,\henko@yy)}(0,0)[#7]{#9}}%
          \else\put(\henko@xx,\henko@yy){\makebox(0,0)[#7]{%
              \rotatebox{\henko@mozikaitenkaku}{#9}}}\fi%
        \fi
      \else
        \edef\Henko@tmp{{(\henko@xx,\henko@yy)}\put@opt}
        \expandafter\emathPut\Henko@tmp{%
        \ifsironuki{\fboxsep\henko@sep\rotatebox{\henko@mozikaitenkaku}{\colorbox{white}{#9}}}%
        \else\rotatebox{\henko@mozikaitenkaku}{#9}\fi}%
      \fi}%
  }

\def\Hen_ko{\@ifnextchar[{\Hen@ko}{\Hen@ko[\empty]}}%
\def\Hen@ko[#1]{\@ifnextchar<{\@Henko[#1]}{\@Henko[#1]<.25>}}%
\def\@Henko[#1]<#2>#3#4{%
  \Kyorii{#3}{#4}\d@Henko
  \ifthenelse{\lengthtest{\d@Henko pt>0.005pt}}{\@Henko@{#3}{#4}[#1]<#2>}{}}%
\def\@Henko@#1#2[#3]<#4>{%
  \edef\@tmp{#1#2}%
  \expandafter\@@Henko\@tmp[#3]<#4>}%
\def\@@Henko(#1,#2)(#3,#4)[#5]<#6>{%
  \@@hen_ko[#5]<#6>(#1,#2)(#3,#4)}%
%
% \HenKo[#1]<#2>#3#4#5
%
%   #1: 弧を点線にする場合，点の個数(*を指定した場合は，一任)
%   #2: key=val
%         henkoH=.. 辺と弧の距離(単位付数値) デフォルト値=1.6ex
%         henkohi=.. 辺と弧の距離を右辺値倍する
%         putoption=..
%         henkosep=.. (白抜きボックスの \fboxsep)
%         yazirusi=a/r/b
%         henkomozikaiten=1/-1
%         linewidth=..
%         dash=..
%         henkotype=..
%            0=円弧   (arc) : default
%            1=楕円弧 (ellipse)
%            2=折れ線 (triangle)
%            3 平行線 (parallel)
%            4=(oval)Drawline (bracket)
%         henkocolor=..
%         henkosideb=.. 0〜1
%         henkosidet=..0〜1
%         henkosidecolor=..
%   #3,#4 : 辺両端の点
%   #5 : 配置する文字列
%
\define@key{emP}{henkoH}{\def\henko@H{#1}}%
\define@key{emP}{henkohi}{\@tempdima=1.6ex\@tempdima=#1\@tempdima
  \edef\henko@H{\the\@tempdima}}%
\define@key{emP}{henkotype}{\HenKoType{#1}}%
\define@key{emP}{henkosideb}{\def\side@b{#1}}%
\define@key{emP}{henkosidet}{\def\side@t{#1}}%
\define@key{emP}{henkocolor}{\def\henko@color{#1}}%
\define@key{emP}{henkosidecolor}{\def\henkoside@color{#1}}%
\define@key{emP}{agezoko}{\def\age@zoko{#1}}%
\define@key{emP}{Agezoko}{\ukansan{#1}\age@zoko}%
\define@key{emP}{agezokovi}{\edef\agezokov@i{#1}}%
\define@key{emP}{agezokovii}{\edef\agezokov@ii{#1}}%
\define@key{emP}{Agezokovi}{\@Agezokovi#1}
  \def\@Agezokovi(#1,#2){%
    \ukansan{#1}\agezoko@x\ukansan{#2}\agezoko@y\edef\agezokov@i{(\agezoko@x,\agezoko@y)}}%
\define@key{emP}{Agezokovii}{\@Agezokovii#1}
  \def\@Agezokovii(#1,#2){\ukansan{#1}\agezoko@x\ukansan{#2}\agezoko@y\edef\agezokov@ii{(\agezoko@x,\agezoko@y)}}%
%
\def\henko@type{0}%
\def\HenKoType#1{%
  \ifthenelse{\equal{#1}{paren}}{\edef\henko@type{0}}{%
    \ifthenelse{\equal{#1}{ellipse}}{\edef\henko@type{1}}{%
      \ifthenelse{\equal{#1}{triangle}}{\edef\henko@type{2}}{%
        \ifthenelse{\equal{#1}{parallel}}{\edef\henko@type{3}}{%
          \ifthenelse{\equal{#1}{bracket}}{\edef\henko@type{4}}{%
            \def\henko@type{#1}%
          }%
        }%
      }%
    }%
  }%
}
\def\zituzahyo#1#2{%
  \@ifundefined{xunitlength}{\edef#2{#1}}{%
    \vecXY{#1}\zituza@x\zituza@y
    \kansan{\zituza@x\xunitlength}{\unitlength}\zituza@x
    \kansan{\zituza@y\yunitlength}{\unitlength}\zituza@y
    \edef#2{(\zituza@x,\zituza@y)}}}
\def\invzituzahyo#1#2{%
  \@ifundefined{xunitlength}{\edef#2{#1}}{%
    \vecXY{#1}\zituza@x\zituza@y
    \kansan{\zituza@x\unitlength}{\xunitlength}\zituza@x
    \kansan{\zituza@y\unitlength}{\yunitlength}\zituza@y
    \edef#2{(\zituza@x,\zituza@y)}}}
%
\def\HenKo{\@ifnextchar[{\@HenKo}{\@HenKo[\empty]}}
\def\@HenKo[#1]{\@ifnextchar<{\@@HenKo[#1]}{\@@HenKo[#1]<\empty>}}
\def\@@HenKo[#1]<#2>#3#4#5{%
\ifnum\EMps@mode=\@ne\gsave\fi
{%
  \@ifundefined{xunitlength}{%
    \edef\HenKo@A{#3}%
    \edef\HenKo@B{#4}%
  }{%
    \zituzahyo{#3}\HenKo@A
    \zituzahyo{#4}\HenKo@B
    \kansan{\xmin\xunitlength}{\unitlength}\xmin
    \kansan{\ymin\yunitlength}{\unitlength}\ymin
    \xunitlength=\unitlength
    \yunitlength=\unitlength
    \def\@xscale{1}%
    \def\@yscale{1}%
  }%
  \def\henko@sep{1pt}%
  \def\henko@H{1.6ex}%
  \def\hasen@opt{n}%
  \def\put@opt{(0,0)[c]}%
  \edef\yazirusi@opt{\empty}%
  \edef\henko@color{\empty}%
  \edef\henkoside@color{\empty}%
  \def\henko@mozikaiten{0}%
  \edef\oresen@name{\empty}%
  \def\oval@r{0}%
  \edef\age@zoko{\empty}%
  \edef\agezokov@i{\empty}%
  \edef\agezokov@ii{\empty}%
  \ifthenelse{\equal{#2}\empty}{}{%
    \Strchr{#2}{=}\HenKo@tmp
    \ifthenelse{\HenKo@tmp>\z@}{%
      \setkeys{emP}{#2}%
    }{%
      \@tempdima\henko@H
      \@tempdima 2.5\@tempdima
      \@tempdima #2\@tempdima
      \edef\henko@H{\the\@tempdima}%
    }%
  }%
\ifx\empty\agezokov@i\else\Addvec\HenKo@A\agezokov@i\HenKo@A\fi
\ifx\empty\agezokov@ii\else\Addvec\HenKo@B\agezokov@ii\HenKo@B\fi
\ifx\empty\age@zoko\else
  \Kaiten[\age@zoko]\HenKo@A\HenKo@B{-90}\HenKo@AA
  \Kaiten[\age@zoko]\HenKo@B\HenKo@A{90}\HenKo@B
  \edef\HenKo@A{\HenKo@AA}%
\fi
  \Bunten{\HenKo@A}{\HenKo@B}11\HenKo@M
  \Kyori{\HenKo@A}{\HenKo@M}\HenKo@AM
  \ukansan\henko@H\HenKo@MV
  \Div\HenKo@AM\HenKo@MV\HenKo@r
  \Mul\HenKo@r\HenKo@AM\HenKo@r
  \Add\HenKo@r\HenKo@MV\HenKo@r
  \Div\HenKo@r{2}\HenKo@r
  \Sub\HenKo@r\HenKo@MV\HenKo@CM
  \Kaiten[\HenKo@CM]\HenKo@M{\HenKo@B}{90}\HenKo@C
  \Kaiten[\HenKo@MV]\HenKo@M{\HenKo@B}{-90}\HenKo@V
  \xdef\HenKoTyuuten{\HenKo@V}%
  \ifnum\henko@mozikaiten=\z@
      \edef\henko@mozikaitenkaku{0}%
  \else
      \Subvec\HenKo@A\HenKo@B\henko@v\Argvec\henko@v\henko@mozikaitenkaku
  \fi
  \ifdim \henko@mozikaitenkaku pt>90pt
      \Sub\henko@mozikaitenkaku{180}\henko@mozikaitenkaku\else
  \ifdim \henko@mozikaitenkaku pt<-90pt
      \Add\henko@mozikaitenkaku{180}\henko@mozikaitenkaku\fi\fi
  \ifnum\henko@mozikaiten<\z@
    \ifdim \henko@mozikaitenkaku pt>\z@
        \Sub\henko@mozikaitenkaku{180}\henko@mozikaitenkaku
    \else
        \Add\henko@mozikaitenkaku{180}\henko@mozikaitenkaku
    \fi
  \fi
  \Subvec{\HenKo@A}\HenKo@C\HenKo@v\Argvec\HenKo@v\HenKo@argi
  \Subvec{\HenKo@B}\HenKo@C\HenKo@v\Argvec\HenKo@v\HenKo@argii
  \ifdim\HenKo@argii\p@<\HenKo@argi\p@\Addself\HenKo@argii{360}\fi
  \xdef\HenKoTyuusin{\HenKo@C}%
  \ifx\empty #1\relax
    \bgroup%\@ifundefined{henko@color}{}{\color{\henko@color}}\relax
%   \ifx\empty\henko@color\else\color{\henko@color}\ignorespaces\relax\fi
    \edef\henko@yazirusi{\yazirusi@opt}%
    \ifcase\henko@type% henkotype=0(paren)
      \Enko<yazirusi=\henko@yazirusi,iro=\henko@color>\HenKo@C
        \HenKo@r{hazimeten=\HenKo@A}{owariten=\HenKo@B}%
      \ifthenelse{\equal\oresen@name\empty}{}{%
        \KinziEnko\HenKo@C\HenKo@r
          {hazimeten=\HenKo@A}{owariten=\HenKo@B}\HenKo@tmp
        \expandafter\xdef\csname\oresen@name\endcsname{\HenKo@tmp}%
      }%
    \or% henkotype=1 (ellipse)
      \Subvec\HenKo@B\HenKo@A\HenKo@AB
      \Argvec\HenKo@AB\HenKo@ziku
      \@ifundefined{psdraw}{%
        \Put\HenKo@M{\rotatebox{\HenKo@ziku}{%
          \Daenko{\HenKo@AM}{\HenKo@MV}{-180}{0}}}%
      }{%
        \EPSkaiten\HenKo@M\HenKo@ziku{%
          \Put\HenKo@M{\Daenko{\HenKo@AM}{\HenKo@MV}{-180}{0}}%
        }%
      }%
    \or% henkotype=2 (triangle)
          \ifx\empty\yazirusi@opt
            \Drawline<iro=\henko@color>{\HenKo@A\HenKo@V\HenKo@B}%
          \else\if a\yazirusi@opt
            \put(0,0){\@iro\henko@color\Drawline{\HenKo@A\HenKo@V}\ArrowLine\HenKo@V\HenKo@B}%
          \else\if r\yazirusi@opt
            \put(0,0){\@iro\henko@color\Drawline{\HenKo@B\HenKo@V}\ArrowLine\HenKo@V\HenKo@A}%
          \else\if b\yazirusi@opt
            \put(0,0){\@iro\henko@color\ArrowLine\HenKo@V\HenKo@B\ArrowLine\HenKo@V\HenKo@A}%
          \fi\fi\fi\fi
    \or% henkotype=3 (parallel)
          \Kaiten[\HenKo@MV]\HenKo@A{\HenKo@B}{-90}\HenKo@VA
          \Kaiten[\HenKo@MV]\HenKo@B{\HenKo@A}{90}\HenKo@VB
          \ifx\empty\yazirusi@opt
            \Drawline<iro=\henko@color>{\HenKo@VA\HenKo@VB}%
          \else\if a\yazirusi@opt
            \put(0,0){\@iro\henko@color\ArrowLine\HenKo@VA\HenKo@VB}%
          \else\if r\yazirusi@opt
            \put(0,0){\@iro\henko@color\ArrowLine\HenKo@VB\HenKo@VA}%
          \else
            \put(0,0){\@iro\henko@color\ArrowLine[b]\HenKo@VB\HenKo@VA}%
          \fi\fi\fi
          \@ifundefined{side@b}{}{%
            \ifdim\side@b\p@=\z@
              \edef\side@P{\HenKo@A}%
              \edef\side@Q{\HenKo@B}%
            \else
              \Sub{1}\side@b\side@bb
              \Bunten\HenKo@A\HenKo@VA\side@b\side@bb\side@P
              \Bunten\HenKo@B\HenKo@VB\side@b\side@bb\side@Q
            \fi
            \ifdim\side@t\p@=\z@
              \edef\side@PP{\HenKo@VA}%
              \edef\side@QQ{\HenKo@VB}%
            \else
              \Sub{1}\side@t\side@tt
              \Bunten\HenKo@A\HenKo@VA\side@t\side@tt\side@PP
              \Bunten\HenKo@B\HenKo@VB\side@t\side@tt\side@QQ
            \fi
            \Drawline<iro=\henkoside@color>{\side@Q\side@QQ}%
            \Drawline<iro=\henkoside@color>{\side@P\side@PP}%
          }%
    \or% henkotype=4 (bracket)
          \Kaiten[\HenKo@MV]\HenKo@A{\HenKo@B}{-90}\HenKo@VA
          \Kaiten[\HenKo@MV]\HenKo@B{\HenKo@A}{90}\HenKo@VB
          \ifthenelse{\lengthtest{\oval@r\p@=\z@}}{%
            \ifx\empty\yazirusi@opt
              \Drawline<iro=\henko@color>{\HenKo@A\HenKo@VA\HenKo@VB\HenKo@B}%
            \else\if a\yazirusi@opt
              \put(0,0){\@iro\henko@color
                \Drawline{\HenKo@A\HenKo@VA\HenKo@VB}\ArrowLine\HenKo@VB\HenKo@B}%
            \else\if r\yazirusi@opt
              \put(0,0){\@iro\henko@color
                \Drawline{\HenKo@VA\HenKo@VB\HenKo@B}\ArrowLine\HenKo@VA\HenKo@A}%
            \else\if b\yazirusi@opt
              \put(0,0){\@iro\henko@color
                \Drawline{\HenKo@VA\HenKo@VB}\ArrowLine\HenKo@VA\HenKo@A\ArrowLine\HenKo@VB\HenKo@B}%
            \fi\fi\fi\fi
          }{%
            \put(0,0){\@iro\henko@color\@ovalDrawline{\HenKo@A\HenKo@VA\HenKo@VB\HenKo@B}}%
          }%
    \fi\egroup
  \else
    \ifthenelse{\equal{#1}{0}}{}{%
      \ifthenelse{\equal{#1}{*}}{%
        \@tempdima=\HenKo@AM\unitlength
        \@tempdima=.75\@tempdima
        \advance\@tempdima 0.5\p@
        \edef\HenKo@N{\seisuu\@tempdima}}{\edef\HenKo@N{#1}}%
      \ISub\HenKo@N{1}\HenKo@n
      \Sub\HenKo@argii\HenKo@argi\HenKo@argd
      \Div\HenKo@argd\HenKo@n\HenKo@argd
      \edef\HenKo@arg{\HenKo@argi}%
      \Ifor\HenKo@i{0}{\HenKo@N}\Do{%
        \Rdef[\HenKo@C](\HenKo@r,\HenKo@arg)\HenKo@P
        \Put\HenKo@P(0,-.4pt)[c]{$\cdot$}%
        \Addself\HenKo@arg\HenKo@argd
      }%
    }%
  \fi%
%  \ifthenelse{\equal{#5}{\empty}}{}{%
  \ifx\empty #5\else
    \fboxsep=\henko@sep
    \edef\HenKo@tmp{{\HenKo@V}\put@opt}%
    \ifthenelse{\henko@mozikaiten=\z@}{%
      \ifsironuki
        \expandafter\emathPut\HenKo@tmp{\colorbox{white}{\protect #5}}%
      \else
        \expandafter\emathPut\HenKo@tmp{\protect #5}%
      \fi
    }{%
      \ifsironuki
          \expandafter\emathPut\HenKo@tmp{%
            \rotatebox{\henko@mozikaitenkaku}{\colorbox{white}{\protect #5}}}%
      \else
          \expandafter\emathPut\HenKo@tmp{%
            \rotatebox{\henko@mozikaitenkaku}{\protect #5}}%
      \fi
    }%
  \fi
%  }%
}%
\ifnum\EMps@mode=\@ne\grestore\fi
}
%
% 下線
%
\define@key{emP}{kasenUehosei}{\def\namikasen@uehosei{#1}}%
\define@key{emP}{kasenSitahosei}{\def\namikasen@sitahosei{#1}}%

\let\kasenUehosei\namikasenUehosei
\let\kasenSitahosei\namikasenSitahosei
\def\phkasen{\@ifnextchar<{\@phkasen}{\@phkasen<\empty>}}
\def\@phkasen<#1>{\@ifnextchar[{\@@phkasen<#1>}{%
  \@@phkasen<#1>[\empty]}}
\def\@@phkasen<#1>[#2]{\@ifnextchar'{\@@@phkasen<#1>[#2]}{%
  \@@@phkasen<#1>[#2]'\relax'}}
\def\@@@phkasen<#1>[#2]'#3'#4{\relax
  \def\phkasen@inner{1}%
  \ifmmode
    \ifinner\else\def\phkasen@inner{0}\fi
    \@@@@phkasen<#1>[#2]'#3'{#4}%
  \else $\@@@@phkasen<#1>[#2]'#3'{\mbox{#4}}\m@th$\relax\fi}
\def\@@@@phkasen<#1>[#2]'#3'#4{%
  {%
  \ifnum\phkasen@inner=\z@
    \setbox0=\hbox{$\displaystyle #4$}%
  \else
    \setbox0=\hbox{\mbox{$#4$}}%
  \fi
  \edef\w@nami{\strip@pt\wd0}%
%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
%
  \@tempdima\dp0\advance\@tempdima4\p@
  \ifx\empty#2\relax\else\advance\@tempdima #2\p@\fi
  \advance\@tempdima\namikasen@uehosei
  \advance\@tempdima\namikasen@sitahosei
  \vrule depth \@tempdima width \z@
%
  \@tempdima-\dp0%\advance\@tempdima-4\p@
  \advance\@tempdima 8.5\p@
  \advance\@tempdima-\namikasen@uehosei
  \edef\d@nami{\the\@tempdima}%
%
  \begin{picture}(0,0)\relax
  \raisebox{\d@nami}{%
    \begin{zahyou*}[ul=1pt,haiti=t](0,\w@nami)(-10,10)\relax
      \def\iro@{}%
      \ifx\empty #1\else\setkeys{emP}{#1}\fi
      \ifx\empty\iro@
        \Sensyu{\XMIN\XMAX}%
        \ifx\empty #2\relax\else\put(0,-#2){\Sensyu{\XMIN\XMAX}}\fi
      \else
        \@iro{\iro@}
        \Sensyu{\XMIN\XMAX}%
        \ifx\empty #2\relax\else\put(0,-#2){\Sensyu{\XMIN\XMAX}}\fi
      \fi
      #3\relax
    \end{zahyou*}}%
  \end{picture}%
  \box0}}%
%
%
%   \EMunderline<#1>#2
%       文字列 #2 に下線を引く（行はまたげません）
%       #1 : key=val
%             allinethickness=...
%             sensyu=....
%             sitayohaku=.. （デフォルト2）
%             Sitayohaku=.. （デフォルト2pt）
%             iro=..
%
\def\EMunderline{\@ifnextchar<{\@EMuln}{\@EMuln<\empty>}}
\def\@EMuln<#1>#2{\relax
  \def\EMuln@inner{1}%
  \ifmmode
    \ifinner\else\def\EMuln@inner{0}\fi
    \@@EMuln<#1>{#2}%
  \else $\@@EMuln<#1>{\mbox{#2}}\m@th$\relax\fi}
\def\@@EMuln<#1>#2{{%
  \edef\sita@yohaku{2}\relax
  \def\iro@{}%
  \ifx\empty #1\relax\else\setkeys{emP}{#1}\fi
%  \setbox0=\hbox{#2}%
  \ifnum\EMuln@inner=\z@
    \setbox0=\hbox{$\displaystyle #2$}%
  \else
    \setbox0=\hbox{\mbox{$#2$}}%
  \fi
  \edef\EMuln@w{\strip@pt\wd0}\relax
  \edef\EMuln@d{\strip@pt\dp0}\relax
  \Add\EMuln@d\sita@yohaku\EMuln@d
  \unitlength=\p@
  \begin{picture}(0,0)\relax
    \ifx\empty\iro@\else\@iro{\iro@}\fi
    \Sensyu{(0,-\EMuln@d)(\EMuln@w,-\EMuln@d)}%
  \end{picture}\relax
  \leavevmode\box0\relax\vrule \@width\z@\@depth\EMuln@d\p@\relax\ignorespaces
}}
%
% 任意の2点を \underbrace, \overbrace で結ぶ。

\define@key{rotbrace}{depth}{\edef\rotbrace@depth{#1}}%
\define@key{rotbrace}{height}{\edef\rotbrace@height{#1}}%

% \rotUbrace[#1]#2#3#4
%     点#2から点#3へ向かう有向線分の，
%       進行方向右側に \underbrace をつけ，
%       中央下部に文字列#4を配置する。
%       （#4 は数式モード内と解釈される。--- \scriptstyle ）
%     \underbrace 記号と有向線分の間隔を空けたいときは#1に
%        depth=3pt
%     などと，間隔を単位付き数値で指定する。

\def\rotUbrace{\@ifnextchar[{\@rotUbrace}{\@rotUbrace[\empty]}}
\def\@rotUbrace[#1]#2#3#4{%
  \edef\rotbrace@height{0pt}%
  \edef\rotbrace@depth{0pt}%
  \ifthenelse{\equal{#1}\empty}{}{\setkeys{rotbrace}{#1}}%
  \Subvec{#3}{#2}\rotUbrace@v
  \Argvec\rotUbrace@v\rotUbrace@arg
  \Absvec\rotUbrace@v\rotUbrace@abs
  \emathPut{#2}{\rotatebox{\rotUbrace@arg}{\makebox(0,0)[lb]{\ensuremath{%
   \smash{\underbrace{%\sityuu[\rotbrace@depth]{\rotbrace@height}%
    \vrule width\z@ height \rotbrace@height depth \rotbrace@depth
    \hspace*{\rotUbrace@abs\unitlength}}_{#4}}}}}}%
}
%
\def\EMoverline{\@ifnextchar<{\@EMovln}{\@EMovln<\empty>}}
\def\@EMovln<#1>#2{{%
  \edef\ue@yohaku{2}\relax
  \ifx\empty #1\relax\else\setkeys{emP}{#1}\fi
  \setbox0=\hbox{#2}%
  \edef\EMovln@w{\strip@pt\wd0}\relax
  \edef\EMovln@h{\strip@pt\ht0}\relax
  \Add\EMovln@h\ue@yohaku\EMovln@h
  \unitlength=\p@
  \begin{picture}(0,0)\relax
    \Drawline{(0,\EMovln@h)(\EMovln@w,\EMovln@h)}%
  \end{picture}\relax\leavevmode\box0\relax
  \vrule \@width\z@\@height\EMovln@h\p@\relax\ignorespaces
}}
%
% \rotObrace[#1]#2#3#4
%     点#2から点#3へ向かう有向線分の，
%       進行方向左側に \overbrace をつけ，
%       中央上部に文字列#4を配置する。
%       （#4 は数式モード内と解釈される。--- \scriptstyle ）
%     \overbrace 記号と有向線分の間隔を空けたいときは#1に
%        height=3pt
%     などと，間隔を単位付き数値で指定する。
%
\def\rotObrace{\@ifnextchar[{\@rotObrace}{\@rotObrace[\empty]}}
\def\@rotObrace[#1]#2#3#4{%
  \edef\rotbrace@height{0pt}%
  \edef\rotbrace@depth{0pt}%
  \ifthenelse{\equal{#1}\empty}{}{\setkeys{rotbrace}{#1}}%
  \Subvec{#3}{#2}\rotObrace@v
  \Argvec\rotObrace@v\rotObrace@arg
  \Absvec\rotObrace@v\rotObrace@abs
  \emathPut{#2}{\rotatebox{\rotObrace@arg}{\makebox(0,0)[lb]{\ensuremath{%
   \smash{\overbrace{%\sityuu[\rotbrace@depth]{\rotbrace@height}%
    \vrule width\z@ height \rotbrace@height depth \rotbrace@depth
    \hspace*{\rotObrace@abs\unitlength}}^{#4}}}}}}%
}
%
% 数式の指定した2項間を円弧で結ぶ
% \DrawHatC<#1>#2#3#4
%   #1 : key=val の形式で
%         takasa=円弧の高さ（デフォルト値：6pt）
%         iti=円弧にラベル文字列を付与する際の基準位置
%               （デフォルト値 : .5 (中点)）
%         haiti=文字列を配置する \Put へのオプション
%               （デフォルト  : (0,0)[c]）
%         fboxsep=..
%   #2 : 式の先頭から項1まで
%   #3 : 式の先頭から項2まで
%   #4 : ラベル文字列
%
% \DrawHatC*<#1>#2#3#4
%   円弧を数式の下方に配置する
%
\define@key{emDrawHat}{takasa}{\def\emDrawHat@takasa{#1}}%
\define@key{emDrawHat}{hukasa}{\def\emDrawHat@hukasa{#1}}%
\define@key{emDrawHat}{iti}{\def\emDrawHat@iti{#1}}%
\define@key{emDrawHat}{haiti}{\def\emDrawHat@haiti{#1}}%
\define@key{emDrawHat}{yazirusi}{\def\emDrawHat@yazirusi{#1}}%
\define@key{emDrawHat}{offset}{\def\emDrawHat@offset{#1}}%
\define@key{emDrawHat}{fboxsep}{\fboxsep=#1}%
\define@key{emDrawHat}{kugirisi}{\def\DHS@kugirisi{#1}}%
\define@key{emDrawHat}{dumy}[1]{}%
%
\def\DrawHatC{\@ifstar{\DrawHatC@}{\@DrawHatC}}
\def\@DrawHatC{\@ifnextchar<{\@@DrawHatC}{\@@DrawHatC<\empty>}}
\def\@@DrawHatC<#1>#2#3#4{{%
  \def\emDrawHat@takasa{6pt}%
  \def\emDrawHat@iti{.5}%
  \def\emDrawHat@haiti{(0,0)[c]}%
  \def\emDrawHat@yazirusi{\empty}%
  \ifx\empty#1\else\setkeys{emDrawHat}{#1}\fi
%
  \unitlength=10pt\relax
  \begin{picture}(0,0)%
  \setbox0=\hbox{$#2$}%
  \@tempdima\wd0\advance\@tempdima-3pt\relax\divide\@tempdima by 10\relax
  \edef\DrawHatC@L{(\strip@pt\@tempdima,1)}%
  \setbox0=\hbox{$#3$}%
  \@tempdimb\wd0\advance\@tempdimb-3pt\relax\divide\@tempdimb by 10\relax
  \edef\DrawHatC@R{(\strip@pt\@tempdimb,1)}%
  \advance\@tempdima\@tempdimb
  \divide\@tempdima by \tw@
  \@tempdimb=10pt\advance\@tempdimb \emDrawHat@takasa\divide\@tempdimb by 10\relax
  \edef\DrawHatC@V{(\strip@pt\@tempdima,\strip@pt\@tempdimb)}%
  \Gaisin\DrawHatC@L\DrawHatC@V\DrawHatC@R[\DrawHatC@r]\DrawHatC@C
  \Enko<yazirusi=\emDrawHat@yazirusi>\DrawHatC@C\DrawHatC@r[\hazimekaku]{hazimeten=\DrawHatC@R}[\owarikaku]{%
    owariten=\DrawHatC@L}%
  \Sub{1}{\emDrawHat@iti}\DrawHatC@tmp
  \Mul{\emDrawHat@iti}\hazimekaku\DrawHatC@a
  \Mul\DrawHatC@tmp\owarikaku\DrawHatC@b
  \Add\DrawHatC@a\DrawHatC@b\DrawHatC@tmp
  \Rdef[\DrawHatC@C](\DrawHatC@r,\DrawHatC@tmp)\DrawHatC@P
  \edef\DrawHatC@tmp{{\DrawHatC@P}\emDrawHat@haiti}%
  \expandafter\emathPut\DrawHatC@tmp{#4}%
  \end{picture}%
}}
%
\def\DrawHatC@{\@ifnextchar<{\DrawHatC@@}{\DrawHatC@@<\empty>}}
\def\DrawHatC@@<#1>#2#3#4{%
  \def\emDrawHat@takasa{6pt}%
  \def\emDrawHat@iti{.5}%
  \def\emDrawHat@haiti{(0,0)[c]}%
  \def\emDrawHat@yazirusi{\empty}%
  \ifx\empty#1\else\setkeys{emDrawHat}{#1}\fi
%
  \unitlength10pt\relax
  \begin{picture}(0,0)%
  \setbox0=\hbox{$#2$}%
  \@tempdima\wd0\advance\@tempdima-3pt\divide\@tempdima by 10\relax
  \edef\DrawHatC@L{(\strip@pt\@tempdima,-.4)}%
  \setbox0=\hbox{$#3$}%
  \@tempdimb\wd0\advance\@tempdimb-3pt\divide\@tempdimb by 10\relax
  \edef\DrawHatC@R{(\strip@pt\@tempdimb,-.4)}%
  \advance\@tempdima\@tempdimb
  \divide\@tempdima by \tw@
  \@tempdimb=-4pt\advance\@tempdimb -\emDrawHat@takasa\divide\@tempdimb by 10\relax
  \edef\DrawHatC@V{(\strip@pt\@tempdima,\strip@pt\@tempdimb)}%
  \Gaisin\DrawHatC@L\DrawHatC@V\DrawHatC@R[\DrawHatC@r]\DrawHatC@C
  \Enko<yazirusi=\emDrawHat@yazirusi>\DrawHatC@C\DrawHatC@r[\hazimekaku]{hazimeten=\DrawHatC@L}[\owarikaku]{%
    owariten=\DrawHatC@R}%
  \Sub{1}{\emDrawHat@iti}\DrawHatC@tmp
  \Mul{\emDrawHat@iti}\owarikaku\DrawHatC@a
  \Mul\DrawHatC@tmp\hazimekaku\DrawHatC@b
  \Add\DrawHatC@a\DrawHatC@b\DrawHatC@tmp
  \Rdef[\DrawHatC@C](\DrawHatC@r,\DrawHatC@tmp)\DrawHatC@P
  \edef\DrawHatC@tmp{{\DrawHatC@P}\emDrawHat@haiti}%
  \expandafter\emathPut\DrawHatC@tmp{#4}%
  \end{picture}%
}
% 式の項を上下の括弧で結ぶ
%\def\emLarc{\@ifnextchar<{\@emLarc}{\@emLarc<\empty>}}
%\def\@emLarc<#1>#2{{%
%  \def\@pos{-90}%
%  \def\yazirusi@opt{\empty}%
%  \def\put@opt{[s]}%
%  \def\put@str{\empty}%
%  \def\takas@{5}%
%  \setbox0=\hbox{#2}%
%  \edef\emLarc@h{\strip@pt\ht0}%
%  \edef\emLarc@d{\strip@pt\dp0}%
%  \edef\emLarc@w{\strip@pt\wd0}%
%  \def\LB{(0,-\emLarc@d)}%
%  \def\RB{(\emLarc@w,-\emLarc@d)}%
%  \Strchr{#1}{=}\emLarc@tmp
%  \ifnum\emLarc@tmp>\z@\setkeys{emP}{#1}\fi
%  \Bunten\LB\RB11\emLarc@C
%  \Addvec\emLarc@C{(0,-\takas@)}\emLarc@C
%  \Gaisin\LB\RB\emLarc@C[\emLarc@r]\emLarc@O
%  \Rdef[\emLarc@O](\emLarc@r,\@pos)\emLarc@P
%  \unitlength=\p@
%  \begin{picture}(0,0)%
%    \edef\emLarc@a{\yazirusi@opt}%
%    \ifthenelse{\equal\emLarc@a\empty}{%
%      \Enko\emLarc@O\emLarc@r{hazimeten=\LB}{owariten=\RB}%
%    }{%
%      \Enko<yazirusi=\emLarc@a>\emLarc@O\emLarc@r{hazimeten=\LB}{owariten=\RB}%%
%    }%
%    \expandafter\emathPut\expandafter\emLarc@P\put@opt\put@str
%  \end{picture}%
%  \@tempdima\takas@ pt\relax
%  \ifthenelse{\equal\put@str\empty}{}{%
%    \setbox0=\hbox{\put@str}%
%    \advance\@tempdima\ht0
%    \advance\@tempdima\dp0
%    \advance\@tempdima\tw@\p@
%  }%
%  \vrule width \z@ depth \@tempdima
%}}
%
\def\DrawHatS{\@ifstar{\def\DHS@dp{0}\@DrawHatS}{\def\DHS@dp{1}\@DrawHatS}}
\def\@DrawHatS{\@ifnextchar[{\@@DrawHatS}{\@@DrawHatS[\empty]}}
\def\@@DrawHatS[#1]{\@ifnextchar<{\@@@DrawHatS[#1]}{\@@@DrawHatS[#1]<\empty>}}
\def\@@@DrawHatS[#1]<#2>#3#4{{%
%
  \def\DHS@kugirisi{,\kern1em}%
  \def\emDrawHat@takasa{1zh}%
  \def\emDrawHat@offset{0pt}%
  \ifx\empty#1\else\setkeys{emDrawHat}{#1}\fi
  \setbox0=\hbox{\ensuremath{{}\DHS@kugirisi{}}}%
  \edef\DHS@wkugirisi{\the\wd0}%
  \setlength{\@tempdima}{\emDrawHat@takasa}\edef\DHS@h{\strip@pt\@tempdima}%
  \unitlength=\p@
%
  \def\DHS@n{0}%
  \expandafter\@for\expandafter\DHS@c\expandafter:\expandafter=#3\do{%
    \Incr\DHS@n
    \ifnum\DHS@n=\@ne
      \setbox0=\hbox{$\DHS@c$}%
      \edef\DHS@ri{\the\wd0}%
      \@tempdima=.5\wd0\relax
      \expandafter\edef\csname DHS@ci\DHS@n\endcsname{\the\@tempdima}%
    \else
      \setbox0=\hbox{$\DHS@c$}%
      \@tempdima\DHS@ri\advance\@tempdima\DHS@wkugirisi
        \advance\@tempdima.5\wd0\relax
        \expandafter\edef\csname DHS@ci\DHS@n\endcsname{\the\@tempdima}%
        \advance\@tempdima.5\wd0\edef\DHS@rii{\the\@tempdima}%
      \edef\DHS@ri{\DHS@rii}%
    \fi
  }%
  \def\DHS@ii{1}%
  \Strchr{#4}{,}\DHS@tmp
  \ifnum\DHS@tmp>\z@
    \expandafter\@for\expandafter\DHS@c\expandafter:\expandafter=#4\do{%
      \edef\DHS@i{\DHS@ii}%
      \Incr\DHS@ii
      \begin{zahyou*}(0,0)(0,0)\relax
        \@tempdima=\csname DHS@ci\DHS@i\endcsname
        \@tempdimb=\csname DHS@ci\DHS@ii\endcsname
        \ifdim\emDrawHat@offset=\z@\else
          \advance\@tempdima\emDrawHat@offset
          \advance\@tempdimb\emDrawHat@offset
        \fi
        \edef\DHS@xi{\strip@pt\@tempdima}%
        \edef\DHS@xii{\strip@pt\@tempdimb}%
        \ifdim\DHS@h\p@>\z@
          \HenKo<#2>{(\DHS@xii,\DHS@h)}{(\DHS@xi,\DHS@h)}{\ensuremath{\DHS@c}}%
        \else
          \HenKo<#2>{(\DHS@xi,\DHS@h)}{(\DHS@xii,\DHS@h)}{\ensuremath{\DHS@c}}%
        \fi
      \end{zahyou*}%
    }%
  \else
    \@whilenum\DHS@ii<\DHS@n\do{%
    \edef\DHS@i{\DHS@ii}%
    \Incr\DHS@ii
    \begin{zahyou*}(0,0)(0,0)\relax
        \@tempdima=\csname DHS@ci\DHS@i\endcsname
        \@tempdimb=\csname DHS@ci\DHS@ii\endcsname
        \ifdim\emDrawHat@offset=\z@\else
          \advance\@tempdima\emDrawHat@offset
          \advance\@tempdimb\emDrawHat@offset
        \fi
        \edef\DHS@xi{\strip@pt\@tempdima}%
        \edef\DHS@xii{\strip@pt\@tempdimb}%
        \ifdim\DHS@h\p@>\z@
          \HenKo<#2>{(\DHS@xii,\DHS@h)}{(\DHS@xi,\DHS@h)}{\ensuremath{#4}}%
        \else
          \HenKo<#2>{(\DHS@xi,\DHS@h)}{(\DHS@xii,\DHS@h)}{\ensuremath{#4}}%
        \fi
      \end{zahyou*}%
    }%
  \fi
  \ifnum\DHS@dp>\z@
    \def\DHS@i{-1}%
    \expandafter\@for\expandafter\DHS@c\expandafter:\expandafter=#3\do{%
      \Incr\DHS@i
      \ifnum\DHS@i=\z@\else\DHS@kugirisi\fi
      \DHS@c
    }%
  \fi
}}
%
\newtoks\DHS@seq
\def\manDrawHatS{\@ifnextchar[{\@manDrawHatS}{\@manDrawHatS[\empty]}}
\def\@manDrawHatS[#1]#2{%
%
  \def\DHS@kugirisi{,\kern1em}%
  \def\emDrawHat@takasa{1zh}%
  \def\emDrawHat@hukasa{2pt}%
  \def\emDrawHat@offset{0pt}%
  \ifx\empty#1\else\setkeys{emDrawHat}{#1}\fi
  \setbox0=\hbox{\ensuremath{{}\DHS@kugirisi{}}}%
  \edef\DHS@wkugirisi{\the\wd0}%
  \setlength{\@tempdima}{\emDrawHat@takasa}\edef\DHS@h{\strip@pt\@tempdima}%
  \setlength{\@tempdima}{\emDrawHat@hukasa}\edef\DHS@d{\strip@pt\@tempdima}%
  \unitlength=\p@
  \DHS@seq={#2}%
%
  \def\DHS@n{0}%
  \expandafter\@for\expandafter\DHS@c\expandafter:\expandafter=#2\do{%
    \Incr\DHS@n
    \ifnum\DHS@n=\@ne
      \setbox0=\hbox{$\DHS@c$}%
      \edef\DHS@ri{\the\wd0}%
      \@tempdima=.5\wd0\relax
      \expandafter\edef\csname DHS@ci\DHS@n\endcsname{\the\@tempdima}%
    \else
      \setbox0=\hbox{$\DHS@c$}%
      \@tempdima\DHS@ri\advance\@tempdima\DHS@wkugirisi
        \advance\@tempdima.5\wd0\relax
        \expandafter\edef\csname DHS@ci\DHS@n\endcsname{\the\@tempdima}%
        \advance\@tempdima.5\wd0\edef\DHS@rii{\the\@tempdima}%
      \edef\DHS@ri{\DHS@rii}%
    \fi
  }%
  \def\DHS@i{0}%
  \@whilenum\DHS@i<\DHS@n\do{%
    \Incr\DHS@i
    \@tempdima=\csname DHS@ci\DHS@i\endcsname
    \ifdim\emDrawHat@offset=\z@\else
      \advance\@tempdima\emDrawHat@offset
    \fi
    \expandafter\edef\csname DHSx\romannumeral\DHS@i\endcsname{%
          \strip@pt\@tempdima}%
    \expandafter\edef\csname DHST\romannumeral\DHS@i\endcsname{%
          (\strip@pt\@tempdima,\DHS@h)}%
    \expandafter\edef\csname DHSB\romannumeral\DHS@i\endcsname{%
          (\strip@pt\@tempdima,-\DHS@d)}%
  }%
  \begin{zahyou*}(0,0)(0,0)\relax
}

\def\endmanDrawHatS{%
  \end{zahyou*}%
  \ensuremath{%
    \def\DHS@i{-1}%
    \expandafter\@for\expandafter\DHS@c\expandafter:\expandafter=\the\DHS@seq\do{%
      \Incr\DHS@i
      \ifnum\DHS@i=\z@\else\DHS@kugirisi\fi
      \DHS@c
    }%
  }%
}
%
% 第1階差数列
%
\def\Kaisasuuretu{\@ifnextchar[{\@Kaisasuuretu}{\@Kaisasuuretu[dumy]}}
\def\@Kaisasuuretu[#1]{\@ifnextchar<{\@@Kaisasuuretu[#1]}{%
    \@@Kaisasuuretu[#1]<\empty>}}
\def\@@Kaisasuuretu[#1]<#2>#3#4{{%
  \HenKoType{2}%
  \DrawHatS[takasa=-2pt,#1]<#2>{#3}{#4}%
}}
%
% 第2階差数列
%
\def\iiKaisasuuretu{\@ifnextchar[{\@iiKaisasuuretu}{\@iiKaisasuuretu[dumy]}}
\def\@iiKaisasuuretu[#1]{\@ifnextchar<{\@@iiKaisasuuretu[#1]}{%
    \@@iiKaisasuuretu[#1]<\empty>}}
\def\@@iiKaisasuuretu[#1]<#2>#3#4#5{{%
  \begin{manDrawHatS}[#1]{#3}%
    \HenKoType{2}%
    \def\Kaisa@i{0}
    \setlength{\@tempdima}{\baselineskip-2pt}%
    \edef\Kaisa@h{-\strip@pt\@tempdima}%
    \expandafter\@for\expandafter\Kaisa@c\expandafter:\expandafter=#4\do{%
      \Incr\Kaisa@i\IAdd\Kaisa@i{1}\Kaisa@ii
      \edef\Kaisa@P{\csname DHSB\romannumeral\Kaisa@i\endcsname}%
      \edef\Kaisa@Q{\csname DHSB\romannumeral\Kaisa@ii\endcsname}%
      \HenKo<#2>\Kaisa@P\Kaisa@Q{\ensuremath{\Kaisa@c}}%
      \Addvec\HenKoTyuuten{(0,\Kaisa@h)}\Kaisa@tmp
      \expandafter\edef\csname KaisaP\romannumeral\Kaisa@i\endcsname{%
        \Kaisa@tmp}%
    }%
    \def\Kaisa@i{0}
    \expandafter\@for\expandafter\Kaisa@c\expandafter:\expandafter=#5\do{%
      \Incr\Kaisa@i\IAdd\Kaisa@i{1}\Kaisa@ii
      \edef\Kaisa@P{\csname KaisaP\romannumeral\Kaisa@i\endcsname}%
      \edef\Kaisa@Q{\csname KaisaP\romannumeral\Kaisa@ii\endcsname}%
      \HenKo<#2>\Kaisa@P\Kaisa@Q{\ensuremath{\Kaisa@c}}%
      \expandafter\edef\csname Kaisa\romannumeral\Kaisa@i\endcsname{%
        \HenKoTyuuten}%
    }%
  \end{manDrawHatS}
}}
%
% 階層指定　階差数列
%
\def\KaisaSuuretu{\@ifnextchar[{\@KaisaSuuretu}{\@KaisaSuuretu[dumy]}}
\def\@KaisaSuuretu[#1]{\@ifnextchar<{\@@KaisaSuuretu[#1]}{%
    \@@KaisaSuuretu[#1]<\empty>}}
\def\@@KaisaSuuretu[#1]<#2>#3{%
  \ifthenelse{#3=2}{%
    \@@iiKaisasuuretu[#1]<#2>
  }{%
%   第3階差数列 ?
  }%
}%
%
% 式各項のセンターのx座標 (\sikixposi, \skixposii, \sikixposiii，...)
% 式全体の高さ(\sikiyh)，深さを求める(\sikiyd)。
%
\def\sikipicture#1{\bgroup
  \def\skxyp@s{}%
  \def\skxyp@i{0}%
  \expandafter\@for\expandafter\skxyp@c\expandafter:\expandafter=#1\do{%
    \Incr\skxyp@i
    \EMedefappend\skxyp@s{\skxyp@c}%
    \setbox0=\hbox{$\displaystyle\skxyp@c$}%
    \setbox1=\hbox{$\displaystyle\skxyp@s$}%
    \@tempdima\wd0
    \@tempdimb\wd1
    \expandafter\edef\csname sikixrpos\romannumeral\skxyp@i\endcsname{\strip@pt\@tempdimb}%
    \advance\@tempdimb-\@tempdima
    \expandafter\edef\csname sikixlpos\romannumeral\skxyp@i\endcsname{\strip@pt\@tempdimb}%
    \@tempdima=.5\@tempdima
    \advance\@tempdimb\@tempdima
    \expandafter\edef\csname sikixpos\romannumeral\skxyp@i\endcsname{\strip@pt\@tempdimb}%
    \expandafter\edef\csname sikiyhpos\romannumeral\skxyp@i\endcsname{\strip@pt\ht0}%
    \expandafter\edef\csname sikiydpos\romannumeral\skxyp@i\endcsname{\strip@pt\dp0}%
    \expandafter\edef\csname sikiB\romannumeral\skxyp@i\endcsname{(\strip@pt\@tempdimb,-\strip@pt\dp0)}%
    \expandafter\edef\csname sikiT\romannumeral\skxyp@i\endcsname{(\strip@pt\@tempdimb,\strip@pt\ht0)}%
  }%
  \edef\sikiyh{\strip@pt\ht1}%
  \edef\sikiyd{\strip@pt\dp1}%
  \edef\sikixyp@w{\strip@pt\wd1}%
\begin{zahyou*}[ul=1pt,haiti=x](0,\sikixyp@w)(-\sikiyd,\sikiyh)\ignorespaces
}
\def\endsikipicture{%
  \put(0,0){$\displaystyle \skxyp@s$}\relax
  \end{zahyou*}\egroup\@ignoretrue
}%
\let\sikixypos\sikipicture
\let\endsikixypos\endsikipicture
%
\def\bunpicture#1{\bgroup
  \def\bnxyp@s{}%
  \def\bnxyp@i{0}%
  \expandafter\@for\expandafter\bnxyp@c\expandafter:\expandafter=#1\do{%
    \Incr\bnxyp@i
    \EMedefappend\bnxyp@s{\bnxyp@c}%
    \setbox0=\hbox{\bnxyp@c}%
    \setbox1=\hbox{\bnxyp@s}%
    \@tempdima\wd0
    \@tempdimb\wd1
    \expandafter\edef\csname bunxrpos\romannumeral\bnxyp@i\endcsname{\strip@pt\@tempdimb}%
    \advance\@tempdimb-\@tempdima
    \expandafter\edef\csname bunxlpos\romannumeral\bnxyp@i\endcsname{\strip@pt\@tempdimb}%
    \@tempdima=.5\@tempdima
    \advance\@tempdimb\@tempdima
    \expandafter\edef\csname bunxpos\romannumeral\bnxyp@i\endcsname{\strip@pt\@tempdimb}%
    \expandafter\edef\csname bunyhpos\romannumeral\bnxyp@i\endcsname{\strip@pt\ht0}%
    \expandafter\edef\csname bunydpos\romannumeral\bnxyp@i\endcsname{\strip@pt\dp0}%
    \expandafter\edef\csname bunB\romannumeral\bnxyp@i\endcsname{(\strip@pt\@tempdimb,-\strip@pt\dp0)}%
    \expandafter\edef\csname bunT\romannumeral\bnxyp@i\endcsname{(\strip@pt\@tempdimb,\strip@pt\ht0)}%
  }%
  \edef\bunyh{\strip@pt\ht1}%
  \edef\bunyd{\strip@pt\dp1}%
  \edef\bunxyp@w{\strip@pt\wd1}%
\begin{zahyou*}[ul=1pt,haiti=x](0,\bunxyp@w)(-\bunyd,\bunyh)\ignorespaces
}
\def\endbunpicture{%
  \put(0,0){\bnxyp@s}\relax
  \end{zahyou*}\egroup\@ignoretrue
}%
%
% 黒丸，白丸
%   \Kuromaru[#1]#2
%   \Siromaru[#1]#2
%       #1 : 丸の半径（単位をつける）デフォルトは 1pt
%       #2 : 位置
%
\edef\Kuromaru@Hankei{1pt}%
\def\KuromaruHankei#1{\edef\Kuromaru@Hankei{#1}}
\def\Kuromaru{\@ifnextchar[{\@Kuromaru}{\@Kuromaru[\Kuromaru@Hankei]}}%
\def\@Kuromaru[#1]#2{{%
  \edef\p@Kuromaru{#2}%
  \@tempdima#1\Div{\strip@pt\@tempdima}{\strip@pt\unitlength}\r@pt%
  \En*[\Nurizen]{#2}\r@pt}}%
\def\Siromaru{\@ifnextchar[{\@Siromaru}{\@Siromaru[\Kuromaru@Hankei]}}%
\def\@Siromaru[#1]#2{{%
  \@tempdima#1\Div{\strip@pt\@tempdima}{\strip@pt\unitlength}\r@pt%
  \En*[0]{#2}\r@pt}}%
%
\def\kuromaru{\@ifnextchar[{\@kuromaru}{\@kuromaru[\Kuromaru@Hankei]}}
\def\@kuromaru[#1]#2{%
  \Cfor{\edef\kuromaru@a{#2}}{\not\equal{\kuromaru@a}{\empty}}{}\do{%
    \strsep{\kuromaru@a}{;}\kuromaru@a\kuromaru@b%
    \Kuromaru[#1]\kuromaru@a
    \edef\kuromaru@a{\kuromaru@b}}}

\def\siromaru{\@ifnextchar[{\@siromaru}{\@siromaru[\Kuromaru@Hankei]}}
\def\@siromaru[#1]#2{%
  \Cfor{\edef\siromaru@a{#2}}{\not\equal{\siromaru@a}{\empty}}{}\do{%
    \strsep{\siromaru@a}{;}\siromaru@a\siromaru@b%
    \Siromaru[#1]\siromaru@a
    \edef\siromaru@a{\siromaru@b}}}

% さいころの目
\def\saikoro#1{{%
  \unitlength.8zh\relax
  \EMkeytopcornersize{5}%
  \,\EMkeytop{%
  \begin{picture}(1,1)%
  \ifcase#1\relax
    \or\Kuromaru[.25em]{(.5,.5)}%
    \or\Kuromaru[.1em]{(.25,.25)}\Kuromaru[.1em]{(.75,.75)}%
    \or\Kuromaru[.1em]{(.125,.125)}\Kuromaru[.1em]{(.5,.5)}%
       \Kuromaru[.1em]{(.875,.875)}%
    \or\Kuromaru[.1em]{(.2,.2)}\Kuromaru[.1em]{(.2,.8)}%
       \Kuromaru[.1em]{(.8,.8)}\Kuromaru[.1em]{(.8,.2)}%
    \or\Kuromaru[.1em]{(.125,.125)}\Kuromaru[.1em]{(.5,.5)}%
       \Kuromaru[.1em]{(.875,.875)}\Kuromaru[.1em]{(.125,.875)}%
       \Kuromaru[.1em]{(.875,.125)}%
    \or\Kuromaru[.1em]{(.125,.1)}\Kuromaru[.1em]{(.125,.5)}%
      \Kuromaru[.1em]{(.125,.9)}\Kuromaru[.1em]{(.875,.1)}%
      \Kuromaru[.1em]{(.875,.5)}\Kuromaru[.1em]{(.875,.9)}%
%   \or\Kuromaru[.1em]{(.1,.125)}\Kuromaru[.1em]{(.5,.125)}%
%     \Kuromaru[.1em]{(.9,.125)}\Kuromaru[.1em]{(.1,.875)}%
%     \Kuromaru[.1em]{(.5,.875)}\Kuromaru[.1em]{(.9,.875)}%
  \fi
  \end{picture}%
  }\,%
}}%
%
% 文字サイズに合わせた丸囲み
%
\def\emPmaru@kizyun{\empty}
\def\emPmaruKizyun#1{\def\emPmaru@kizyun{#1}}
\def\emPmaruKizyun#1{\def\emPmaru@kizyun{#1}}
\def\emPmaru{\@ifnextchar<{\@emPmaru}{\@emPmaru<\empty>}}
\def\@emPmaru<#1>{\@ifnextchar[{\@@emPmaru<#1>}{\@@emPmaru<#1>[\emPmaru@kizyun]}}
\def\@@emPmaru<#1>[#2]#3{{%
  \def\iro@{}%
  \ifx\empty #1\relax\else\setkeys{emP}{#1}\fi
  \ifthenelse{\equal{#2}\empty}{%
    \setbox0=\hbox{#3}%
  }{%
    \setbox0=\hbox{#2}%
  }%
  \@tempdima=.5\wd0\relax
  \edef\emPmaru@x{\strip@pt\@tempdima}%
  \@tempdima\ht0\advance\@tempdima\dp0
  \@tempdimb=.5\@tempdima
  \edef\emPmaru@y{\strip@pt\@tempdimb}%
  \Kyori{(0,0)}{(\emPmaru@x,\emPmaru@y)}\emPmaru@r
  \@tempdima\ht0\advance\@tempdima-\@tempdimb
  \edef\emPmaru@y{\strip@pt\@tempdima}%
  \unitlength=\p@
  \Add\emPmaru@r\emPmaru@r\emPmaru@w
  \begin{picture}(\emPmaru@w,0)\relax
{\ifx\empty\iro@\else\color{\iro@}\fi
    \En{(\emPmaru@r,\emPmaru@y)}\emPmaru@r
}%
    \Put{(\emPmaru@r,0)}{\makebox[0pt][c]{#3}}%
  \end{picture}%
  \Add\emPmaru@r\emPmaru@y\emPmaru@h
  \Sub\emPmaru@r\emPmaru@y\emPmaru@d
  \vrule\@width\z@\@height\emPmaru@h\p@\@depth\emPmaru@d\p@
}}
%
%------------------------------------------------------------------


% 円弧，扇形，弓形

% 楕円
%   \Daen[#1]#2#3#4
%   #1 : 塗りつぶしの濃さ
%   #2 : 中心の座標
%   #3 : 横軸方向の半径
%   #4 : 縦軸方向の半径
%
\def\Daen{\@ifstar{\Daen@}{\@Daen}}%
\def\Daen@{\@ifstar{\Hatch@Daen}{\Daen@@}}%
\def\Daen@@{\@ifnextchar[{\@Daen@}{\@Daen@[0.5]}}%
\def\@Daen@[#1]#2#3#4{{%\special{sh #1}%
%  \edef\@resen{}%
%  \For\@kaku{0}{6.2832}{0.1}\Do{%
%  \Cos\@kaku\@x\Mul{#3}\@x\@x
%  \Sin\@kaku\@y\Mul{#4}\@y\@y
%  \edef\@P{(\@x,\@y)}\Addvec\@P{#2}\@P
%  \edef\@resen{\@resen\@P}}%
%  \Addvec{#2}{(#3,0)}\@P
%  \edef\@resen{\@resen\@P}%
%  \Nuritubusi[#1]\@resen
%  \@iro{\nuri@iro}\Drawline\@resen
  \edef\draw@border{\empty}%
  \def\nuri@iro{\nuri@iro@}%
  \Strchr{#1}{=}\nuri@iro@tmp
  \ifnum\nuri@iro@tmp>\z@\setkeys{emP}{#1}\fi
  \Add{#3}{#3}\@x\Add{#4}{#4}\@y
  \ifthenelse{\equal{#1}{0}}{%
    \put(0,0){\special{sh #1}\emathPut{#2}{\@arc\@x\@y{0}{6.2832}}}\ignorespaces
  }{%
    \ifthenelse{\equal\nuri@iro\empty}{%
      \put(0,0){\special{sh #1}\emathPut{#2}{\@arc\@x\@y{0}{6.2832}}}\ignorespaces
    }{%
      \put(0,0){%
        \special{bk}{\@iro{\nuri@iro}\emathPut{#2}{\@arc\@x\@y{0}{6.2832}}}%
        \ifx\empty\draw@border\else
          \@iro{\nuri@iro}\emathPut{#2}{\@arc\@x\@y{0}{6.2832}}%
        \fi
      }%
    }%
  }%
}}%
\def\@Daen{\@ifnextchar<{\@@Daen}{\@@Daen<\empty>}}
\def\@@Daen<#1>#2#3#4{{%
  \Strchr{#1}{=}\Daen@@tmp
  \ifnum\Daen@@tmp>\z@\setkeys{emP}{#1}\fi
  \ifthenelse{\equal\empty\iro@}{}{\@iro\iro@}%
  \Add{#3}{#3}\@x\Add{#4}{#4}\@y
  \emathPut{#2}{\@arc\@x\@y{0}{6.2832}}}\ignorespaces}%
\def\Hatch@Daen{\@ifnextchar[{\@Hatch@Daen}{\@Hatch@Daen[45]}}%
\def\@Hatch@Daen[#1]{\@ifnextchar<{\@@Hatch@Daen[#1]}{%
  \@@Hatch@Daen[#1]<\empty>}}%
\def\@@Hatch@Daen[#1]<#2>{\@ifnextchar({\@@@Hatch@Daen[#1]<#2>}{%
  \@@@Hatch@Daen[#1]<#2>(.1)}}%
\def\@@@Hatch@Daen[#1]<#2>(#3)#4#5#6{%
  \edef\@resen{}%
  \For\@kaku{0}{6.2832}{#3}\Do{%
  \Cos\@kaku\@x\Mul{#5}\@x\@x
  \Sin\@kaku\@y\Mul{#6}\@y\@y
  \edef\@P{(\@x,\@y)}\Addvec\@P{#4}\@P
  \edef\@resen{\@resen\@P}}%
  \Addvec{#4}{(#5,0)}\@P
  \edef\@resen{\@resen\@P}%
  \Hatchpolygon[#1]<#2>\@resen}%

% 楕円弧
%       \Daenko<#1>#2#3#4#5
%               #1 : key=val
%                     hasen=[破線の長さ][破線の間隔]
%                     yazirusi=a : 正方向に矢印をつける
%                              =r : 負方向に矢印をつける
%                              =b : 両方向に矢印をつける
%                              =n : 矢印をつけない
%               #2 : 横軸方向の半径
%               #3 : 縦軸方向の半径
%               #4 : 始め角
%               #5 : 終り角
%               （中心は \put (\emathPut) で指定する．）
%       \Daenko[#1][#2]#3#4#5#6
%               #1 : 弧を点線にするときの破線の長さ
%               #2 : 破線の間隔
%               #3 : 横軸方向の半径
%               #4 : 縦軸方向の半径
%               #5 : 始め角
%               #6 : 終り角
%               （中心は \put (\emathPut) で指定する．）

\def\Daenko{\edef\yazirusi@opt{\empty}\edef\hasen@opt{\empty}%
  \@ifstar{\Daenko@}{\@Daenko}}%
\def\@Daenko{%
\ifnum\EMps@mode=\@ne\gsave\fi
\bgroup
  \@ifnextchar<{\D@enko}{\@D@enko}}
\def\D@enko<#1>{\setkeys{emP}{#1}%
  \ifthenelse{\equal{\hasen@opt}{\empty}}{\@D@enko}{%
  \expandafter\@@Daenko\hasen@opt}%
}
\def\@D@enko{\@ifnextchar[{\@@Daenko}{\@@Daenko[\empty]}}%
\def\@@Daenko[#1]{\@ifnextchar[{\@@@Daenko[#1]}{\@@@Daenko[#1][1]}}%
\def\@@@Daenko[#1][#2]#3#4#5#6{%
  \ifthenelse{\equal{#1}{\empty}}%
  {%
    \Add{#3}{#3}\@x\Add{#4}{#4}\@y%
    \Sub{#6}{#5}{\@tyuusinkaku}\Sub{360}{#6}\@hazimekaku%
    \Add{\@hazimekaku}{\@tyuusinkaku}{\@owarikaku}%
    \DegRad{\@hazimekaku}{\@hazimekaku}%
    \DegRad{\@owarikaku}{\@owarikaku}%
    \put(0,0){{%
      \ifthenelse{\equal\iro@\empty}{}{\@iro{\iro@}}%
      \@arc\@x\@y{\@hazimekaku}{\@owarikaku}}}%
  }{%\else
    \edef\@hazimekaku{#5}\edef\@owarikaku{#6}%
    \DegRad{\@hazimekaku}{\@hazimekaku}\DegRad{\@owarikaku}{\@owarikaku}%
    \edef\@x{#3}\edef\@y{#4}%
    \Mul{#2}{0.18}\@dx\Mul{#1}{0.1}\@lx
    \For\@t{\@hazimekaku}{\@owarikaku}{\@dx}\Do{\Add\@t{\@lx}\@@t%
      \ifthenelse{\lengthtest{\@@t pt>\@owarikaku pt}}{%
        \edef\@@t{\@owarikaku}}{}%
      \Cos\@t\@xi\Mul\@x\@xi\@xi\Cos\@@t\@xii\Mul\@x\@xii\@xii%
      \Sin\@t\@yi\Mul\@y\@yi\@yi\Sin\@@t\@yii\Mul\@y\@yii\@yii%
      \drawline(\@xi,\@yi)(\@xii,\@yii)}%
  }%
  \ifx\empty\yazirusi@opt
  \else
    \DaYenko[\yazirusi@opt]{#3}{#4}{#5}{#6}%
  \fi
\egroup
% \ifnum\EMps@mode=\@ne\grestore\fi%%   ---> emathPs.sty
}
\def\Daenko@{\@ifstar{\Hatch@Daenko}{\Daenko@@}}%
\def\Daenko@@{\@ifnextchar[{\@Daenko@}{\@Daenko@[0.5]}}%
\def\@Daenko@[#1]#2#3#4#5{%
    \edef\@hazimekaku{#4}\edef\@owarikaku{#5}%
      \DegRad{\@hazimekaku}{\@hazimekaku}\DegRad{\@owarikaku}{\@owarikaku}%
    \edef\@x{#2}\edef\@y{#3}\def\@resen{}%
    \For\@t{\@hazimekaku}{\@owarikaku}{0.1}\Do{%\Add\@t{\@lx}\@@t%
      \Cos\@t\@xi\Mul\@x\@xi\@xi
      \Sin\@t\@yi\Mul\@y\@yi\@yi
      \edef\@resen{\@resen(\@xi,\@yi)}}%
    \Cos\@owarikaku\@xi\Mul\@x\@xi\@xi\Sin\@owarikaku\@yi\Mul\@y\@yi\@yi
    \edef\@resen{\@resen(\@xi,\@yi)}%
    \Cos\@hazimekaku\@xi\Mul\@x\@xi\@xi\Sin\@hazimekaku\@yi\Mul\@y\@yi\@yi
    \edef\@resen{\@resen(\@xi,\@yi)}%
    \Nuritubusi[#1]\@resen}%
\def\Hatch@Daenko{\@ifnextchar[{\@Hatch@Daenko}{\@Hatch@Daenko[45]}}%
\def\@Hatch@Daenko[#1]{\@ifnextchar<{\@@Hatch@Daenko[#1]}{%
  \@@Hatch@Daenko[#1]<\empty>}}%
\def\@@Hatch@Daenko[#1]<#2>{\@ifnextchar({\@@@Hatch@Daenko[#1]<#2>}{%
  \@@@Hatch@Daenko[#1]<#2>(.1)}}%
\def\@@@Hatch@Daenko[#1]<#2>(#3)#4#5#6#7{%
    \edef\@hazimekaku{#6}\edef\@owarikaku{#7}%
      \DegRad{\@hazimekaku}{\@hazimekaku}\DegRad{\@owarikaku}{\@owarikaku}%
    \edef\@x{#4}\edef\@y{#5}\def\@resen{}%
    \For\@t{\@hazimekaku}{\@owarikaku}{#3}\Do{%\Add\@t{\@lx}\@@t%
      \Cos\@t\@xi\Mul\@x\@xi\@xi
      \Sin\@t\@yi\Mul\@y\@yi\@yi
      \edef\@resen{\@resen(\@xi,\@yi)}}%
    \Cos\@owarikaku\@xi\Mul\@x\@xi\@xi\Sin\@owarikaku\@yi\Mul\@y\@yi\@yi
    \edef\@resen{\@resen(\@xi,\@yi)}%
    \Cos\@hazimekaku\@xi\Mul\@x\@xi\@xi\Sin\@hazimekaku\@yi\Mul\@y\@yi\@yi
    \edef\@resen{\@resen(\@xi,\@yi)}%
    \Hatchpolygon[#1]<#2>\@resen}%

% 矢線付き楕円弧（偏角指定）
%   \Dayenko[#1]#2#3#4#5
%   #1 : 矢印を逆につけるには [r] とする．
%   #2 : 横軸方向の半径
%   #3 : 縦軸方向の半径
%   #4 : 始め角
%   #5 : 終り角（終り角＞始め角）でなければならない．）
%   （中心は \put (\emathPut) で指定する．）

\def\Dayenko{\@ifnextchar[{\@Dayenko}{\@Dayenko[\empty]}}%
\def\@Dayenko[#1]#2#3#4#5{\Add{#2}{#3}\@Dayenko@r\Div\@Dayenko@r{2}\@Dayenko@r
  \Div\Arr@wHeadSize{\@Dayenko@r}\d@theta
  \Div\d@theta{2}\d@theta
\bgroup
  \@ifundefined{xunitlength}{}{\xunitlength=\unitlength}%
  \@ifundefined{yunitlength}{}{\yunitlength=\unitlength}%
  \ifthenelse{\equal{#1}\empty}{%
%  \ifx\empty #1\relax
    \DegRad{#5}\@Dayenko@arg
    \Cos\@Dayenko@arg\@Px\Mul{#2}\@Px\@Px
    \Sin\@Dayenko@arg\@Py\Mul{#3}\@Py\@Py
    \edef\@P{(\@Px,\@Py)}%
    \Sub\@Dayenko@arg\d@theta\@Dayenko@arg
    \Cos\@Dayenko@arg\@Sx\Mul{#2}\@Sx\@Sx
    \Sin\@Dayenko@arg\@Sy\Mul{#3}\@Sy\@Sy
    \edef\@S{(\@Sx,\@Sy)}%
    \Subvec\@S\@P\@PS
    \Rotvec[\Arr@wHeadSize]\@PS{\ArrowHeadAngle}\@PQ\Addvec\@P\@PQ\@Q%
    \Rotvec[\Arr@wHeadSize]\@PS{-\ArrowHeadAngle}\@PR\Addvec\@P\@PR\@R%
  }{%
% \else%
    \DegRad{#4}\@Dayenko@arg
    \Cos\@Dayenko@arg\@Px\Mul{#2}\@Px\@Px
    \Sin\@Dayenko@arg\@Py\Mul{#3}\@Py\@Py
    \edef\@P{(\@Px,\@Py)}%
    \Add\@Dayenko@arg\d@theta\@Dayenko@arg
    \Cos\@Dayenko@arg\@Sx\Mul{#2}\@Sx\@Sx
    \Sin\@Dayenko@arg\@Sy\Mul{#3}\@Sy\@Sy
    \edef\@S{(\@Sx,\@Sy)}%
    \Subvec\@S\@P\@PS
    \Rotvec[\Arr@wHeadSize]\@PS{\ArrowHeadAngle}\@PQ\Addvec\@P\@PQ\@Q%
    \Rotvec[\Arr@wHeadSize]\@PS{-\ArrowHeadAngle}\@PR\Addvec\@P\@PR\@R%
%  \fi%
  }%
  \Nuritubusi[\Nurizen]{\@Q\@P\@R\@Q}%
  \Drawline{\@Q\@P\@R\@Q}%
  \Daenko{#2}{#3}{#4}{#5}%
\egroup
}%

% 矢線付き楕円弧（矢印のみ）
%   \DaYenko[#1]#2#3#4#5
%   #1 : 矢印を逆につけるには [r] とする．
%   #2 : 横軸方向の半径
%   #3 : 縦軸方向の半径
%   #4 : 始め角
%   #5 : 終り角（終り角＞始め角）でなければならない．）
%   （中心は \put (\emathPut) で指定する．）

\def\DaYenko{\@ifnextchar[{\@DaYenko}{\@DaYenko[\empty]}}%
\def\@DaYenko[#1]#2#3#4#5{%
  \Add{#2}{#3}\@DaYenko@r\Div\@DaYenko@r{2}\@DaYenko@r
  \Div\Arr@wHeadSize{\@DaYenko@r}\d@theta
  \Div\d@theta{2}\d@theta
\bgroup
  \@ifundefined{xunitlength}{}{\xunitlength=\unitlength}%
  \@ifundefined{yunitlength}{}{\yunitlength=\unitlength}%
  \ifthenelse{\equal{#1}{\empty}\or\equal{#1}{a}\or\equal{#1}{b}}{%
    \DegRad{#5}\@DaYenko@arg
    \Cos\@DaYenko@arg\@Px\Mul{#2}\@Px\@Px
    \Sin\@DaYenko@arg\@Py\Mul{#3}\@Py\@Py
    \edef\@P{(\@Px,\@Py)}%
    \Sub\@DaYenko@arg\d@theta\@DaYenko@arg
    \Cos\@DaYenko@arg\@Sx\Mul{#2}\@Sx\@Sx
    \Sin\@DaYenko@arg\@Sy\Mul{#3}\@Sy\@Sy
    \edef\@S{(\@Sx,\@Sy)}%
    \Subvec\@S\@P\@PS
    \Rotvec[\Arr@wHeadSize]\@PS{\ArrowHeadAngle}\@PQ\Addvec\@P\@PQ\@Q%
    \Rotvec[\Arr@wHeadSize]\@PS{-\ArrowHeadAngle}\@PR\Addvec\@P\@PR\@R%
    \Nuritubusi[\Nurizen]{\@Q\@P\@R\@Q}\Drawline{\@Q\@P\@R\@Q}%
  }{}%
  \ifthenelse{\equal{#1}{r}\or\equal{#1}{b}}{%
    \DegRad{#4}\@DaYenko@arg
    \Cos\@DaYenko@arg\@Px\Mul{#2}\@Px\@Px
    \Sin\@DaYenko@arg\@Py\Mul{#3}\@Py\@Py
    \edef\@P{(\@Px,\@Py)}%
    \Add\@DaYenko@arg\d@theta\@DaYenko@arg
    \Cos\@DaYenko@arg\@Sx\Mul{#2}\@Sx\@Sx
    \Sin\@DaYenko@arg\@Sy\Mul{#3}\@Sy\@Sy
    \edef\@S{(\@Sx,\@Sy)}%
    \Subvec\@S\@P\@PS
    \Rotvec[\Arr@wHeadSize]\@PS{\ArrowHeadAngle}\@PQ\Addvec\@P\@PQ\@Q%
    \Rotvec[\Arr@wHeadSize]\@PS{-\ArrowHeadAngle}\@PR\Addvec\@P\@PR\@R%
    \Nuritubusi[\Nurizen]{\@Q\@P\@R\@Q}\Drawline{\@Q\@P\@R\@Q}%
  }{}%
\egroup
}

% 直線のまわりに回転させることを表す記号
% \kaitenkigou<#1>[#2]
%   #1 : 倍率
%     または key=val
%            bairitu= （倍率）デフォルト値 : 1
%            muki = r/a                      a
%                r で，負の向き
%                n で，正の向き
%            hazimekaku=                     15
%            owarikaku=                     345
%            tyouhankei=                      3mm
%            tanhankei=                     1.5mm
%   #2 : 回転角
%   位置は \emathPut で指定

\def\kaitenkigou{\@ifnextchar<{\@kaitenkigou}{\@kaitenkigou<1>}}
\def\@kaitenkigou<#1>{\@ifnextchar[{\@@kaitenkigou<#1>}{%
  \@@kaitenkigou<#1>[0]}}
\def\@@kaitenkigou<#1>[#2]{{%
  \def\@bairitu{1}%
  \def\@hazimekaku{15}%
  \def\@owarikaku{345}%
  \def\@tyouhankei{3mm}%
  \def\@tanhankei{1.5mm}%
  \def\@muki{n}%
  \Strchr{#1}{=}\kaitenkigou@tmp
  \ifnum\kaitenkigou@tmp>\z@
    \setkeys{emP}{#1}%
  \else
    \def\@bairitu{#1}%
  \fi
  \ifthenelse{\equal\@muki{n}}{\def\@muki{\empty}}{}%
  \@tempdima=\@tanhankei
  \@tempdima=\@bairitu\@tempdima
  \Div{\strip@pt\@tempdima}{\strip@pt\unitlength}\rotmark@x
  \@tempdima=\@tyouhankei
  \@tempdima=\@bairitu\@tempdima
  \Div{\strip@pt\@tempdima}{\strip@pt\unitlength}\rotmark@y
%  \Mul\rotmark@x{2}\rotmark@y
    \ifthenelse{\equal{#2}{0}}{%
      \Dayenko[\@muki]\rotmark@x\rotmark@y{\@hazimekaku}{\@owarikaku}%
    }{%
      \rotatebox{#2}{%
        \Dayenko[\@muki]\rotmark@x\rotmark@y{\@hazimekaku}{\@owarikaku}}%
    }%
}}


% 円
% \En<#1>#2#3
%  <#1>: hasen=xx で円弧を破線で描画するときの
%                  [破線の長さ][破線の間隔]
%   #2 : 中心の座標
%   #3 : 半径
% \En*[#1]#2#3 塗りつぶす
%   #1 : 塗りの濃度
%   #2 : 中心
%   #3 : 半径

\def\En{\def\iro@{\empty}\@ifstar{\Enban}{\Ensyuu}}%
\def\Ensyuu{\@ifnextchar<{\En@h}{\Ensyuu@}}
\def\En@h<#1>#2#3{\Enk@<#1>{#2}{#3}{0}{360}}
\def\Ensyuu@{\@ifnextchar[{\@Enko}{\@Ensyuu}}
\def\@Ensyuu#1{\@ifnextchar<{\@@DaEn{#1}}{\@@Ensyuu{#1}}}%
\def\@@DaEn#1<#2>#3{\Add{#2}{#2}\@x\Add{#3}{#3}\@y
  \emathPut{#1}{\@arc\@x\@y{0}{6.2832}}}%
\def\@Enko[#1,#2]{\@ifnextchar[{\@@Enko[#1,#2]}{%
  \@@Enko[#1,#2][\empty]}}%
\def\@@Enko[#1,#2][#3]#4{\@ifnextchar<{\@@@DaEnko[#1,#2][#3]{#4}}{%
  \@@@Enko[#1,#2][#3]{#4}}}%
\def\@@@Enko[#1,#2][#3]#4#5{\Add{#5}{#5}{\@tyokkei}%
    \Sub{#2}{#1}{\@tyuusinkaku}%
    \Sub{360}{#2}\@hazimekaku%
    \Add{\@hazimekaku}{\@tyuusinkaku}{\@owarikaku}%
    \DegRad{\@hazimekaku}{\@hazimekaku}%
    \DegRad{\@owarikaku}{\@owarikaku}%
    \emathPut{#4}{\@ifundefined{arc}{}{\enkoo\@tyokkei\@hazimekaku\@owarikaku}{%
      \arc{\@tyokkei}{\@hazimekaku}{\@owarikaku}}}%
    \ifx\empty#3\else
    \Rdef(#5,#1)\@A\Addvec{#4}\@A\@A
    \Rdef(#5,#2)\@B\Addvec{#4}\@B\@B
    \ifx y#3\Drawline{\@A\@B}\else\ifx o#3\Drawline{\@A#4\@B}\fi\fi\fi}%
\def\@@@DaEnko[#1,#2][#3]#4<#5>#6{%
    \Add{#5}{#5}\@x\Add{#6}{#6}\@y%
    \Sub{#2}{#1}{\@tyuusinkaku}\Sub{360}{#2}\@hazimekaku%
      \Add{\@hazimekaku}{\@tyuusinkaku}{\@owarikaku}%
      \DegRad{\@hazimekaku}{\@hazimekaku}\DegRad{\@owarikaku}{\@owarikaku}%
    \emathPut{#4}{\@arc\@x\@y{\@hazimekaku}{\@owarikaku}}}%

\def\@@Ensyuu#1#2{%
  \Strchr{#2}{=}\@@Ensyuu@tmp
  \ifnum\@@Ensyuu@tmp>\z@
    \edef\@tyuusin{#1}\relax
    \setkeys{emP}{#2}%
  \else
    \edef\@hankei{#2}%
  \fi
  \Add\@hankei\@hankei\En@d%%%%%%\Mul\En@d{.999}\En@d
  \emathPut{#1}{\circle{\En@d}}\ignorespaces}%

\def\Enban{\@ifstar{\Hatch@Circle}{\Enban@}}%
\def\Enban@{\@ifnextchar[{\@Enban}{\@Enban[0.5]}}%
\def\@Enban[#1]#2#3{%
% \Add{#3}{#3}\En@d
  \Strchr{#3}{=}\@@Ensyuu@tmp
  \ifnum\@@Ensyuu@tmp>\z@
    \edef\@tyuusin{#2}\relax
    \setkeys{emP}{#3}%
  \else
    \edef\@hankei{#3}%
  \fi
  \Add\@hankei\@hankei\En@d
  \edef\draw@border{\empty}%
  \def\nuri@iro{\nuri@iro@}%
  \Strchr{#1}{=}\nuri@iro@tmp
  \ifnum\nuri@iro@tmp>\z@\setkeys{emP}{#1}\fi
%\typeout{arg1=#1,nuri@iro=\nuri@iro.}%
  \ifthenelse{\equal{#1}{0}}{%
    \put(0,0){\special{sh #1}\emathPut{#2}{\arc{\En@d}{0}{6.2832}}}%
  }{%
    \ifthenelse{\equal\nuri@iro\empty}{%
      \put(0,0){\special{sh #1}\emathPut{#2}{\arc{\En@d}{0}{6.2832}}}%
    }{%
      \put(0,0){%
        \special{bk}{\@iro{\nuri@iro}\emathPut{#2}{\arc{\En@d}{0}{6.2832}}}%
        \ifx\empty\draw@border\else
          \@iro{\nuri@iro}\emathPut{#2}{\arc{\En@d}{0}{6.2832}}%
        \fi
      }%
    }%
  }%
}%
% {\shade\circle{\En@d}}}%
\def\Hatch@Circle{\@ifnextchar[{\@Hatch@Circle}{\@Hatch@Circle[45]}}%
\def\@Hatch@Circle[#1]{\@ifnextchar<{\@@Hatch@Circle[#1]}{%
  \@@Hatch@Circle[#1]<\empty>}}%
\def\@@Hatch@Circle[#1]<#2>{\@ifnextchar({\@@@Hatch@Circle[#1]<#2>}{%
  \@@@Hatch@Circle[#1]<#2>(.1)}}%
\def\@@@Hatch@Circle[#1]<#2>(#3)#4#5{%
  \edef\@tyuusin{#4}\relax
  \Strchr{#5}{=}\@@Ensyuu@tmp
  \ifnum\@@Ensyuu@tmp>\z@
    \setkeys{emP}{#5}%
  \else
    \edef\@hankei{#5}%
  \fi
  \def\@resen{}%
  \For\@t{0}\Pii{#3}\Do{\Cos\@t\@x\Mul\@x{\@hankei}\@x%
    \Sin\@t\@y\Mul\@y{\@hankei}\@y
    \Addvec{\@tyuusin}{(\@x,\@y)}\@P
    \edefappend\@resen{\@P}}%
  \Cos0\@x\Mul\@x{\@hankei}\@x\Sin0\@y\Mul\@y{\@hankei}\@y%
  \Addvec{\@tyuusin}{(\@x,\@y)}\@P
  \edefappend\@resen{\@P}%
  \Hatchpolygon[#1]<#2>\@resen}%

\def\Enn{\@ifnextchar({\@Enn}{\@Enn(.05)}}
\def\@Enn(#1){\@ifnextchar({\@@Enn(#1)}{\@@Enn(#1)(\empty)}}
\def\@@Enn(#1)(#2)#3#4{\vecXY{#3}\Enn@cx\Enn@cy
    \def\Enn@x##1##2{\Cos{##1}\en@x\Mul{#4}\en@x\en@x\Add\en@x\Enn@cx##2}%
    \def\Enn@y##1##2{\Sin{##1}\en@y\Mul{#4}\en@y\en@y\Add\en@y\Enn@cy##2}%
  \put(0,0){\bGurafu(#1)(#2)\Enn@x\Enn@y{0}{\Pii}}}
%
% 直径の両端を与えて円
%
\def\EnT#1#2{%
  \Tyuuten{#1}{#2}\EnT@O
  \Kyori{#1}\EnT@O\EnT@r
  \En\EnT@O\EnT@r
}
% 円弧
%\Enko<#1>#2#3[#4]#5[#6]#7
%  #1 : オプション
%         hasen=xx で円弧を破線で描画するときの
%                  [破線の長さ][破線の間隔]
%                オプションを与える。
%         ten=xx で円弧を点線で描画するときの点の個数
%         yazirusi=a : 正方向に矢印をつける
%                 =r : 負方向に矢印をつける
%                 =b : 両方向に矢印をつける
%                 =n : 矢印をつけない
%
%  #2 : 中心
%  #3 : 半径を直接与えるか
%         tuukaten=xx として，円弧の周上の一点を与える
%  #5 : 始め角を直接与えるか
%        hazimeten=xx として，中心を始点，xx を終点とするベクトルの
%         方向角を 始め角とするように指定する。
%         この場合始め角を[#4]に戻すことも可能
%  #7 : 終り角を直接与えるか
%         owariten=xx として，中心を始点，xx を終点とするベクトルの
%         方向角を 終り角とするように指定する。
%         この場合始め角を[#6]に戻すことも可能

\def\Enko{\@ifnextchar<{\Enk@}{\Enk@<\empty>}}
\def\Enk@<#1>#2#3{\@ifnextchar[{\Enk@@<#1>{#2}{#3}}{%
  \Enk@@<#1>{#2}{#3}[\empty]}}
\def\Enk@@<#1>#2#3[#4]#5{%
  \@ifnextchar[{\Enk@@@<#1>{#2}{#3}[#4]{#5}}{%
  \Enk@@@<#1>{#2}{#3}[#4]{#5}[\empty]}}
\def\Enk@@@<#1>#2#3[#4]#5[#6]#7{{%
  \edef\ten@kosuu{}%
  \edef\hasen@opt{\empty}%
  \edef\hazime@kaku{#5}%
  \edef\yazirusi@opt{}%
  \edef\owari@kaku{#7}%
  \edef\@tyuusin{#2}%
  \edef\@hankei{#3}%
  \Strchr{#1}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#1}\fi
  \Strchr{#3}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#3}\fi
  \Strchr{#5}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#5}\fi
  \Strchr{#7}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#7}\fi
  \ifx\empty#4\else\xdef#4{\hazime@kaku}\fi
  \ifx\empty#6\else\xdef#6{\owari@kaku}\fi
  \ifthenelse{\equal\ten@kosuu\empty}{%
    \ifthenelse{\equal\yazirusi@opt\empty}{\edef\yazirusi@opt{n}}{}%
    \ifx\hasen@opt\empty
      \emathPut\@tyuusin{%
        \Yenko[\yazirusi@opt]\@hankei\hazime@kaku\owari@kaku%
        \Daenko\@hankei\@hankei\hazime@kaku\owari@kaku
%       \yenko[\yazirusi@opt]\@hankei\hazime@kaku\owari@kaku
      }%
    \else
      \emathPut\@tyuusin{%
        \Yenko[\yazirusi@opt]\@hankei\hazime@kaku\owari@kaku%
        \expandafter\Daenko\hasen@opt\@hankei\@hankei\hazime@kaku\owari@kaku}%
    \fi
  }{%
    \ISub\ten@kosuu{1}\ten@kosuui
    \Sub\owari@kaku\hazime@kaku\kaku@kankaku
    \Div\kaku@kankaku\ten@kosuui\kaku@kankaku
    \edef\@kaku{\hazime@kaku}%
    \emathPut\@tyuusin{%
      \Ifor\@kizami{0}{\ten@kosuui}\Do{%
        \Rdef(\@hankei,\@kaku)\@Ten
        \emathPut\@Ten{{\unitlength\p@\circle*{1}}}%
        \Add\@kaku\kaku@kankaku\@kaku
      }%
      \Rdef(\@hankei,\owari@kaku)\@Ten
      \emathPut\@Ten{{\unitlength\p@\circle*{1}}}%
    }%
  }%
}\ignorespaces}

% \enko#1#2#3
%   #1 : 半径
%   #2 : 始め角
%   #3 : 終り角
%   （中心は \put (\emathPut) で指定する．）

\def\enko#1#2#3{%
    \Mul{2}{#1}{\@tyokkei}%
    \Sub{#3}{#2}{\@tyuusinkaku}%
    \Sub{360}{#3}\@hazimekaku%
    \Add{\@hazimekaku}{\@tyuusinkaku}{\@owarikaku}%
    \DegRad{\@hazimekaku}{\@hazimekaku}%
    \DegRad{\@owarikaku}{\@owarikaku}%
    \put(0,0){\arc{\@tyokkei}{\@hazimekaku}{\@owarikaku}}}%

% 折れ線近似による円弧
%   #1 : 半径
%   #2 : 始め角
%   #3 : 終り角（終り角＞始め角）でなければならない．）
%   （中心は \put (\emathPut) で指定する．）

\def\enkoo#1#2#3{\DegRad{#2}\kaku@s\DegRad{#3}\kaku@e\def\@resen{}%
  \For\@t\kaku@s\kaku@e{0.025}\Do{\Cos\@t\@x\Mul\@x{#1}\@x%
    \Sin\@t\@y\Mul\@y{#1}\@y\edef\@resen{\@resen(\@x,\@y)}}%
  \Cos\kaku@e\@x\Mul\@x{#1}\@x\Sin\kaku@e\@y\Mul\@y{#1}\@y%
  \edef\@resen{\@resen(\@x,\@y)}\Drawline\@resen}%

% 矢線付き円弧（偏角指定）
%   \yenko[#1]#2#3#4
%   #1 : 矢印を逆につけるには [r] とする．[b]で両向き. [n]で矢印なし.
%   #2 : 半径
%   #3 : 始め角
%   #4 : 終り角（終り角＞始め角）でなければならない．）
%   （中心は \put (\emathPut) で指定する．）
\def\yenko{\@ifnextchar[{\@yenko}{\@yenko[a]}}%
\def\@yenko[#1]#2#3#4{\Div\Arr@wHeadSize{#2}\d@theta
  \RadDeg\d@theta\d@theta\Div\d@theta{2}\d@theta
  \Add\ArrowHeadAxis\d@theta\@ArrowHeadAxis
  \Sub{\@ArrowHeadAxis}\ArrowHeadAngle\yenko@kakui
  \Add{\@ArrowHeadAxis}\ArrowHeadAngle\yenko@kakuii
% \ifx\empty #1\relax
  \ifthenelse{\equal{#1}{a} \or \equal{#1}{b} \or \equal{#1}{\empty}}{%
    \Rdef(#2,#4)\@P%
    \Rotvec[\Arr@wHeadSize]\@P{-\yenko@kakui}\@PQ\Addvec\@P\@PQ\@Q%
    \Rotvec[\Arr@wHeadSize]\@P{-\yenko@kakuii}\@PR\Addvec\@P\@PR\@R
    \Nuritubusi[\Nurizen]{\@Q\@P\@R\@Q}\Drawline{\@Q\@P\@R\@Q}%
  }{}%
  \ifthenelse{\equal{#1}{b} \or \equal{#1}{r}}{%
%  \else%
    \Rdef(#2,#3)\@P%
    \Rotvec[\Arr@wHeadSize]\@P{\yenko@kakui}\@PQ\Addvec\@P\@PQ\@Q%
    \Rotvec[\Arr@wHeadSize]\@P{\yenko@kakuii}\@PR\Addvec\@P\@PR\@R
    \Nuritubusi[\Nurizen]{\@Q\@P\@R\@Q}\Drawline{\@Q\@P\@R\@Q}%
  }{}%
% \fi%
% \Nuritubusi[\Nurizen]{\@Q\@P\@R\@Q}\Drawline{\@Q\@P\@R\@Q}%
  \enkoo{#2}{#3}{#4}}%

% \Yenko 鏃のみ
\def\Yenko{%
  \@ifnextchar[{\@Yenko}{\@Yenko[a]}}%
\def\@Yenko[#1]#2#3#4{%
\ifthenelse{\lengthtest{\arrow@headsize\p@>\z@}}{%
  \Div\Arr@wHeadSize{#2}\d@theta
  \RadDeg\d@theta\d@theta\Div\d@theta{2}\d@theta
  \Add\ArrowHeadAxis\d@theta\@ArrowHeadAxis
  \Sub{\@ArrowHeadAxis}\ArrowHeadAngle\Yenko@kakui
  \Add{\@ArrowHeadAxis}\ArrowHeadAngle\Yenko@kakuii
\bgroup
  \@ifundefined{xunitlength}{}{\xunitlength=\unitlength}%
  \@ifundefined{yunitlength}{}{\yunitlength=\unitlength}%
  \ifthenelse{\equal{#1}{a} \or \equal{#1}{b} \or \equal{#1}{\empty}}{%
    \Rdef(#2,#4)\@P\Add{#4}{90}\@tmp\Rdef(#2,\@tmp)\@m@\Yaziri\@P\@m@
%    \Rotvec[\Arr@wHeadSize]\@P{-\Yenko@kakui}\@PQ\Addvec\@P\@PQ\@Q%
%    \Rotvec[\Arr@wHeadSize]\@P{-\Yenko@kakuii}\@PR\Addvec\@P\@PR\@R
%    \Nuritubusi[\Nurizen]{\@Q\@P\@R\@Q}\Drawline{\@Q\@P\@R\@Q}%
  }{}%
  \ifthenelse{\equal{#1}{b} \or \equal{#1}{r}}{%
    \Rdef(#2,#3)\@P\Add{#3}{-90}\@tmp\Rdef(#2,\@tmp)\@m@\Yaziri\@P\@m@%
%    \Rotvec[\Arr@wHeadSize]\@P{\Yenko@kakui}\@PQ\Addvec\@P\@PQ\@Q%
%    \Rotvec[\Arr@wHeadSize]\@P{\Yenko@kakuii}\@PR\Addvec\@P\@PR\@R
%    \Nuritubusi[\Nurizen]{\@Q\@P\@R\@Q}\Drawline{\@Q\@P\@R\@Q}%
  }{}%
\egroup
}{}%
}
%
% 矢線付き円弧（両端の点指定）
%   \ArrowArc<#1>[#2]#3#4#5
%   #1 : \Enko に渡すオプション
%   #2 : [r]を付けると負の回転となるように矢印をつける．
%   #3 : 半径 (<0 のときは，[r]をつけたものとみなす。）
%   #4 : 始点
%   #5 : 終点

\def\ArrowArc{\@ifnextchar<{\@ArrowArc}{\@ArrowArc<\empty>}}%
\def\@ArrowArc<#1>{\@ifnextchar[{\@@ArrowArc<#1>}{\@@ArrowArc<#1>[a]}}%
\def\@@ArrowArc<#1>[#2]#3#4#5{%
  \edef\ArrowArc@orient{#2}%
  \ifthenelse{\equal{#2}{r}}{\edef\ArrowArc@orient{r}}{}%
  \ifdim #3 pt<\z@\Mul{#3}{-1}\ArrowArc@radius\edef\ArrowArc@orient{r}\else
  \edef\ArrowArc@radius{#3}\fi
  \vecXY{#4}\ArrowArc@x\ArrowArc@y
  \vecXY{#5}\ArrowArc@xx\ArrowArc@yy
\bgroup
  \@ifundefined{xunitlength}{}{%
  \@ifundefined{xmin}{}{%
    \Mul\@xscale\ArrowArc@x\ArrowArc@x
    \Mul\@yscale\ArrowArc@y\ArrowArc@y
    \Mul\@xscale\ArrowArc@xx\ArrowArc@xx
    \Mul\@yscale\ArrowArc@yy\ArrowArc@yy
    \Mul\@xscale\xmin\xmin
    \Mul\@yscale\ymin\ymin
    \edef\@xscale{1}%
    \edef\@yscale{1}%
    \xunitlength\unitlength
    \yunitlength\unitlength
  }}%
  \edef\ArrowArc@P{(\ArrowArc@x,\ArrowArc@y)}%
  \edef\ArrowArc@Q{(\ArrowArc@xx,\ArrowArc@yy)}%
  \Bunten{\ArrowArc@P}{\ArrowArc@Q}11\B@M\Kyorii\B@M{\ArrowArc@P}\@ll%
  \Mul{\ArrowArc@radius}{\ArrowArc@radius}\@h\Sub\@h\@ll\@h
  \Heihoukon\@h\@h\Subvec\B@M{\ArrowArc@P}\@AM%
  \ifthenelse{\equal{\ArrowArc@orient}{a}}{%
    \Rotvec[\@h]\@AM{\ArrowHeadAxis}\@MC
    \Addvec\B@M\@MC\@C%
    \Subvec{\ArrowArc@P}\@C\@CA\Subvec{\ArrowArc@Q}\@C\@CB%
    \Argvec\@CA\kaku@s\Argvec\@CB\kaku@e
  }{%
    \Rotvec[\@h]\@AM{-\ArrowHeadAxis}\@MC\Addvec\B@M\@MC\@C%
    \Subvec{\ArrowArc@P}\@C\@CA\Subvec{\ArrowArc@Q}\@C\@CB%
    \Argvec\@CA\kaku@e\Argvec\@CB\kaku@s
  }%
  \ifdim\kaku@e pt<\kaku@s pt\relax\Add{360}\kaku@e\kaku@e\fi%
  \ifx\empty#1\relax
    \Enko<yazirusi=\ArrowArc@orient>\@C\ArrowArc@radius\kaku@s\kaku@e
  \else
    \Enko<yazirusi=\ArrowArc@orient,#1>\@C\ArrowArc@radius\kaku@s\kaku@e
  \fi
\egroup
}
%
% 扇形
% ougigata[#1]#2#3#4
%   #1 : 塗りつぶしの濃さ （デフォルトは 0.5 ）
%   #2 : 半径を直接与えるか
%        tuukaten=xx として，円弧の周上の一点を与える
%   #3 : 始め角を直接与えるか
%         hazimeten=xx として，中心を始点，xx を終点とするベクトルの
%         方向角を 始め角とするように指定する。
%   #4 : 終り角を直接与えるか
%         owariten=xx として，中心を始点，xx を終点とするベクトルの
%         方向角を 終り角とするように指定する。
%   （中心は \put (\emathPut) で指定する．）

\newif\if@nuri
\def\ougigata{\@ifstar{\ougigata@}{\@nurifalse\@ougigata}}%
\def\ougigata@{\@ifstar{\hatch@ougigata}{%
  \@nuritrue\@ougigata}}%
\def\@ougigata{\@ifnextchar[{\@@ougigata}{\@@ougigata[0.5]}}%
\def\@@ougigata[#1]{\@ifnextchar<{\@@@ougigata[#1]}{\@@@ougigata[#1]<\empty>}}%
\def\@@@ougigata[#1]<#2>#3#4#5{%
  \edef\hazime@kaku{#4}%
  \edef\owari@kaku{#5}%
  \edef\@tyuusin{\local@origin}%
  \edef\@hankei{#3}%
  \Strchr{#3}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#3}\fi
  \Strchr{#4}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#4}\fi
  \Strchr{#5}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#5}\fi
\if@nuri\edef\@resen{(0,0)}%
  \For\@kaku{\hazime@kaku}{\owari@kaku}{5}\Do{\Rdef(\@hankei,\@kaku)\@P%
  \edef\@resen{\@resen\@P}}\Rdef(\@hankei,\owari@kaku)\@P%
  \edef\@resen{\@resen\@P(0,0)}\Nuritubusi[#1]<#2>\@resen%
% \ifx #2b\ougigata{#3}{#4}{\ougigata@owarikaku}\fi%
\else\DegRad{\hazime@kaku}\@hazimekaku\Cos\@hazimekaku\@x\Mul\@x{\@hankei}\@x%
  \Sin\@hazimekaku\@y\Mul\@y{\@hankei}\@y\drawline(0,0)(\@x,\@y)%
  \DegRad{\owari@kaku}\@owarikaku\Cos\@owarikaku\@@x\Mul\@@x{\@hankei}\@@x%
  \Sin\@owarikaku\@@y\Mul\@@y{\@hankei}\@@y\drawline(0,0)(\@@x,\@@y)%
  \enko{\@hankei}{\hazime@kaku}{\owari@kaku}\fi}%
\def\hatch@ougigata{\@ifnextchar[{\@hatch@ougigata}{\@hatch@ougigata[45]}}%
\def\@hatch@ougigata[#1]{\@ifnextchar<{\@@hatch@ougigata[#1]}{%
  \@@hatch@ougigata[#1]<\empty>}}%
\def\@@hatch@ougigata[#1]<#2>#3#4#5{%
  \edef\hazime@kaku{#4}%
  \edef\owari@kaku{#5}%
  \edef\@tyuusin{\local@origin}%
  \edef\@hankei{#3}%
  \Strchr{#3}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#3}\fi
  \Strchr{#4}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#4}\fi
  \Strchr{#5}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#5}\fi
  \edef\@resen{(0,0)}%
  \For\@kaku{\hazime@kaku}{\owari@kaku}{5}\Do{\Rdef(\@hankei,\@kaku)\@P%
  \edef\@resen{\@resen\@P}}\Rdef(\@hankei,\owari@kaku)\@P%
  \edef\@resen{\@resen\@P(0,0)}\Hatchpolygon[#1]<#2>\@resen}%

% 弓形
% yumigata[#1]<#2>#3#4#5
%   #1 : 塗りつぶしの濃さ （デフォルトは 0.5 ）
%   #3 : 半径を直接与えるか
%        tuukaten=xx として，円弧の周上の一点を与える
%   #4 : 始め角を直接与えるか
%         hazimeten=xx として，中心を始点，xx を終点とするベクトルの
%         方向角を 始め角とするように指定する。
%   #5 : 終り角を直接与えるか
%         owariten=xx として，中心を始点，xx を終点とするベクトルの
%         方向角を 終り角とするように指定する。
%   （中心は \put (\emathPut) で指定する．）

\def\yumigata{\@ifstar{\yumigata@}{\@nurifalse\@yumigata}}%
\def\yumigata@{\@ifstar{\hatch@yumigata}{\@nuritrue\@yumigata}}%
\def\@yumigata{\@ifnextchar[{\@@yumigata}{\@@yumigata[0.5]}}%
\def\@@yumigata[#1]{\@ifnextchar<{\@@@yumigata[#1]}{%
  \@@@yumigata[#1]<\empty>}}
\def\@@@yumigata[#1]<#2>#3#4#5{%
  \edef\hazime@kaku{#4}%
  \edef\owari@kaku{#5}%
  \edef\@tyuusin{\local@origin}%
  \edef\@hankei{#3}%
  \Strchr{#3}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#3}\fi
  \Strchr{#4}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#4}\fi
  \Strchr{#5}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#5}\fi
\if@nuri\edef\@resen{}%
  \For\@kaku{\hazime@kaku}{\owari@kaku}{5}\Do{%
  \Rdef(\@hankei,\@kaku)\@P\edef\@resen{\@resen\@P}}\Rdef(\@hankei,\owari@kaku)\@P
  \edef\@resen{\@resen\@P}\Rdef(\@hankei,\hazime@kaku)\@P
  \edef\@resen{\@resen\@P}\Nuritubusi[#1]<#2>\@resen
\else\DegRad{\hazime@kaku}\@hazimekaku\Cos\@hazimekaku\@x\Mul\@x{\@hankei}\@x%
  \Sin\@hazimekaku\@y\Mul\@y{\@hankei}\@y%
  \DegRad{\owari@kaku}\@owarikaku\Cos\@owarikaku\@@x\Mul\@@x{\@hankei}\@@x%
  \Sin\@owarikaku\@@y\Mul\@@y{\@hankei}\@@y\drawline(\@x,\@y)(\@@x,\@@y)%
  \enko{\@hankei}{\hazime@kaku}{\owari@kaku}\fi}%
\def\hatch@yumigata{\@ifnextchar[{\@hatch@yumigata}{%
  \@hatch@yumigata[45]}}%
\def\@hatch@yumigata[#1]{\@ifnextchar<{\@@hatch@yumigata[#1]}{%
  \@@hatch@yumigata[#1]<\empty>}}%
\def\@@hatch@yumigata[#1]<#2>#3#4#5{%
  \edef\hazime@kaku{#4}%
  \edef\owari@kaku{#5}%
  \edef\@tyuusin{\local@origin}%
  \edef\@hankei{#3}%
  \Strchr{#3}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#3}\fi
  \Strchr{#4}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#4}\fi
  \Strchr{#5}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#5}\fi
  \edef\@resen{}%
  \For\@kaku\hazime@kaku\owari@kaku{5}\Do{%
  \Rdef(\@hankei,\@kaku)\@P\edef\@resen{\@resen\@P}%
  }%
  \Rdef(\@hankei,\owari@kaku)\@P
  \edef\@resen{\@resen\@P}\Rdef(\@hankei,\hazime@kaku)\@P
  \edef\@resen{\@resen\@P}%
  \Hatchpolygon[#1]<#2>\@resen}%

% 矢線

% \yasen[#1]<#2>(#3,#4)
% \Yasen[#1]<#2>#3
%   #1 : ラベルを置く位置（デフォルト=0.5, 中点）
%   #2 : ラベル（位置指定を含めて）
%   (#3,#4) : 終点（始点は \put で指定）
\newtoks\yasen@toks
\def\yasen{\@ifnextchar[{\@yasen}{\@yasen[.5]}}
\def\@yasen[#1]{\@ifnextchar<{\@@yasen[#1]}{\@@yasen[#1]<\empty>}}
\def\@@yasen[#1]<#2>(#3,#4){%
  \def\yasen@O{(0,0)}%
  \def\yasen@P{(#3,#4)}%
  \Mulvec{#1}\yasen@P\yasen@M
  \yasen@toks={\yasen@M#2}%
  \expandafter\emathPut\the\yasen@toks
  \ArrowLine\yasen@O\yasen@P
}
\def\Yasen{\@ifnextchar[{\@Yasen}{\@Yasen[.5]}}
\def\@Yasen[#1]{\@ifnextchar<{\@@Yasen[#1]}{\@@Yasen[#1]<\empty>}}
\def\@@Yasen[#1]<#2>#3{\vecXY{#3}\Yasen@x\Yasen@y
  \yasen[#1]<#2>(\Yasen@x,\Yasen@y)}

\def\arrowdrawline{\@ifnextchar({\@arrowdrawline}{\relax}}
\def\@arrowdrawline(#1,#2){\@ifnextchar({%
  \@@arrowdrawline(#1,#2)}{\relax}}
\def\@@arrowdrawline(#1,#2)(#3,#4){%
  \ArrowLine{(#1,#2)}{(#3,#4)}\@arrowdrawline(#3,#4)%
}

% \ArrowLine<#1>[#2]#3#4
%   #1 : key=val
%         sensyu=
%         putstr=      （矢線の傍に置く配置オプション+文字列）
%         putpos=      （文字列の配置基準位置：デフォルトは0.5, 中点）
%         arrowheadsize= 特に 0 を指定すると，矢印無し
%         allinethickness= 幹の太さ
%         henvi=        （始点をずらす変移ベクトル -- 単位つき）
%         henvii=       （終点をずらす変移ベクトル -- 単位つき）
%   #2 : 矢印を置く位置（デフォルト = 1 すなわち終点）
%        ただし #2=b のときは，両端に矢印
%   #3 : 始点
%   #4 : 終点

\define@key{emP}{putstr}{\def\put@str{#1}}%
\define@key{emP}{putpos}{\def\put@pos{#1}}%

\def\ArrowLine{\@ifnextchar<{\@ArrowLine}{\@ArrowLine<\empty>}}%
\def\@ArrowLine<#1>{\@ifnextchar[{\@@ArrowLine<#1>}{\@@ArrowLine<#1>[1]}}%
\def\@@ArrowLine<#1>[#2]#3#4{{%
  \def\sensyu{\drawline}%%%%%%%%%%%%%%%%%%%%%%% 2005/08/22
  \def\yaziri@@M{(0,0)}%
  \def\put@str{\empty}\def\put@pos{.5}%
  \def\arrow@headsize{1}%
  \edef\hen@i{\empty}%
  \edef\hen@ii{\empty}%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
%
  \ifx\empty\hen@i\def\ArrowLine@A{#3}\else\Addvec{#3}{\hen@i}\ArrowLine@A\fi
  \ifx\empty\hen@ii\def\ArrowLine@B{#4}\else\Addvec{#4}{\hen@ii}\ArrowLine@B\fi
%
  \Subvec{\ArrowLine@B}{\ArrowLine@A}\miki@v
\Absvec\miki@v\miki@l
\ifdim\miki@l\p@>0.01pt\relax
  \put(0,0){%
    \edef\v@arrow{\ArrowLine@A\ArrowLine@B}%
    \DegCos\ArrowHeadAngle\yaziri@c\Mul\Arr@wHeadSize\yaziri@c\yaziri@c
    \Mul{0.9}\yaziri@c\yaziri@@c
    \Absvec\miki@v\ArrowLine@l
    \Sub\ArrowLine@l\yaziri@@c\ArrowLine@ll
    \Bunten\O@@\miki@v\ArrowLine@ll\yaziri@@c\ArrowLine@e
    \Bunten\O@@\miki@v\yaziri@@c\ArrowLine@ll\ArrowLine@s
    \ifthenelse{\equal{#2}{b}}{%
      {%
        \changeArrowHeadSize{\arrow@headsize}%
        \emathPut{\ArrowLine@B}{\yaziri\miki@v}\Mulvec{-1}\miki@v\miki@v@
          \Addvec{\ArrowLine@B}\yaziri@@M\ArrowLine@e
        \emathPut{\ArrowLine@A}{\yaziri\miki@v@}%
          \Addvec{\ArrowLine@A}\yaziri@@M\ArrowLine@s
        \ifthenelse{\equal{\ArrowHeadType}{f}}{%
          \edef\miki@vv{\ArrowLine@s\ArrowLine@e}%
          \Put\O@@{\expandafter\sensyu\miki@vv}%
        }{%
          \edef\v@arrow{\ArrowLine@s\ArrowLine@e}%
          \expandafter\sensyu\v@arrow
        }%
      }%
    }{%
      \Mulvec{#2}\miki@v\miki@v@\Addvec{\ArrowLine@A}\miki@v@\yaziri@v
      {%
        \changeArrowHeadSize{\arrow@headsize}%
%        \emathPut{\ArrowLine@B}{\yaziri\miki@v}%
        \emathPut{\yaziri@v}{\yaziri\miki@v}%
        \ifthenelse{\equal{#2}{1}\and\equal{\ArrowHeadType}{f}}{%
          \Addvec{\ArrowLine@B}\yaziri@@M\ArrowLine@e
          \Subvec\ArrowLine@e{\ArrowLine@A}\ArrowLine@e
          \edef\miki@vv{(0,0)\ArrowLine@e}%
          \Put{\ArrowLine@A}{\expandafter\sensyu\miki@vv}%
        }{%
          \expandafter\sensyu\v@arrow
        }%
      }%
    }%
  }%
  \ifx\empty\put@str\else
    \Mulvec\put@pos\miki@v\put@p\Addvec{\ArrowLine@A}\put@p\put@p
    \expandafter\emathPut\expandafter\put@p\put@str
  \fi
\fi
  }}%
%
\def\PhArrowLine{\@ifnextchar<{\@PhArrowLine}{\@PhArrowLine<\empty>}}%
\def\@PhArrowLine<#1>{\@ifnextchar[{\@@PhArrowLine<#1>}{\@@PhArrowLine<#1>[1]}}%
\let\@@PhArrowLine\@@ArrowLine
% 複数の矢線
\def\ArrowLines{\@ifnextchar<{\@ArrowLines}{\@ArrowLines<\empty>}}
\def\@ArrowLines<#1>{\@ifnextchar[{\@@ArrowLines<#1>}{%
    \@@ArrowLines<#1>[1]}}
\def\@@ArrowLines<#1>[#2]#3{%
    \def\ArrowLines@sub(##1,##2)(##3,##4){%
      \edef\ArrowLines@a{(##1,##2)}%
      \edef\ArrowLines@b{(##3,##4)}}%
  \argsep{#3}{;}{ArrowLines@tmp}\ArrowLines@n
  \Cfor{\edef\ArrowLines@i{0}}{\ArrowLines@i<\ArrowLines@n}{}\do{%
    \Incr\ArrowLines@i
    \edef\ArrowLines@arg{%
      \csname ArrowLines@tmp\romannumeral\ArrowLines@i\endcsname}%
    \expandafter\ArrowLines@sub\ArrowLines@arg
    \@@ArrowLine<#1>[#2]\ArrowLines@a\ArrowLines@b
  }%
}

\def\ArrowDottedLine#1#2#3{%
  \edef\v@arrow{#1#2#3}%
  \expandafter\dottedline\v@arrow
  \edef\yaziri@v{#3}%
  \Subvec{#2}{#3}\miki@v
  \Rotvec[\Arr@wHeadSize]\miki@v\ArrowHeadAngle\arrow@vi
  \Rotvec[\Arr@wHeadSize]\miki@v{-\ArrowHeadAngle}\arrow@vii
  \Addvec{#3}\arrow@vi\arrow@vi\Addvec{#3}\arrow@vii\arrow@vii
  \if\ArrowHeadType l\relax\Drawline{\arrow@vi\yaziri@v\arrow@vii}\else%
    \Nuritubusi[\Nurizen]{\arrow@vi\yaziri@v\arrow@vii\arrow@vi}\fi%
% \Nuritubusi[\Nurizen]{\arrow@vi#3\arrow@vii\arrow@vi}%
  }%

\def\ArrowDashLine{\@ifnextchar[{\@ArrowDashLine}{%
    \@ArrowDashLine[\dashlinestretch]}}%
\def\@ArrowDashLine[#1]#2#3#4{%
  \edef\v@arrow{[#1]{#2}#3#4}%
  \expandafter\dashline\v@arrow
  \edef\yaziri@v{#4}%
  \Subvec{#3}{#4}\miki@v
  \Rotvec[\Arr@wHeadSize]\miki@v\ArrowHeadAngle\arrow@vi
  \Rotvec[\Arr@wHeadSize]\miki@v{-\ArrowHeadAngle}\arrow@vii
  \Addvec{#4}\arrow@vi\arrow@vi\Addvec{#4}\arrow@vii\arrow@vii
  \if\ArrowHeadType l\relax\Drawline{\arrow@vi\yaziri@v\arrow@vii}\else%
    \Nuritubusi[\Nurizen]{\arrow@vi\yaziri@v\arrow@vii\arrow@vi}\fi%
% \Nuritubusi[\Nurizen]{\arrow@vi#4\arrow@vii\arrow@vi}%
  }%
%
\def\Arrowline#1{%
  \edef\Arrowline@tmp{#1}%
%  \typeout{now! Arrowline:arg1=#1,tmp=\Arrowline@tmp}%
  \expandafter\@Arrowline\Arrowline@tmp}
\def\@Arrowline(#1,#2)(#3,#4){%
%  \typeout{now!@Arrowline (#1,#2)->(#3,#4)}%
  \ArrowLine{(#1,#2)}{(#3,#4)}}
%\def\Arrowline#1{%
%  \edef\v@arrow{#1}%
%  \expandafter\arrow\expandafter\drawline\v@arrow}%
%
% 複数の矢線
\def\arrowline{\@ifnextchar[{\@arrowline}{%
    \@arrowline[1]}}
\def\@arrowline[#1]#2{%
    \def\arrowline@sub(##1,##2)(##3,##4){%
      \edef\arrowline@a{(##1,##2)}%
      \edef\arrowline@b{(##3,##4)}}%
  \argsep{#2}{;}{arrowline@tmp}\arrowline@n
  \Cfor{\edef\arrowline@i{0}}{\arrowline@i<\arrowline@n}{}\do{%
    \Incr\arrowline@i
    \edef\arrowline@arg{%
      \csname arrowline@tmp\romannumeral\arrowline@i\endcsname}%
    \expandafter\arrowline@sub\arrowline@arg
    \ArrowLine[#1]\arrowline@a\arrowline@b
  }%
}
%
\@ifundefined{bekutorukata}{%
  \def\bekutorukata{\@ifnextchar<{\@bekutorukata}{\@bekutorukata<\ArrowHeadPit>}}%
  \def\@bekutorukata<#1>{\edef\bekutoru@kubomi{#1}\@@bekutorukata}%
  \def\@@bekutorukata#1{%
              \ifthenelse{\equal{#1}{fill}}%
              {%
                \bekutorusityuu{\vrule height .9zh width \z@}%
                \def\bekutoru@t##1{{%
                  \@tempdima=1zh\relax
                  \edef\BK@hi{\strip@pt\@tempdima}%
                  \Div\BK@hi{9.16443}\BK@hi
                  \Mul{0.5}\BK@hi\BK@thickness
                  \changeArrowHeadSize\BK@hi
                  \setbox0=\hbox{\bekutoru@sityuu}%
                  \ukansan{\the\ht0}\bekutoru@h
                  \setbox0=\hbox{##1}%
                  \ukansan{\the\wd0}\bekutoru@w
                  \begin{picture}(0,0)\relax
                    \edef\O@@{(0,0)}%
                    \edef\ArrowHeadPit{\bekutoru@kubomi}%
                    \DegSin\ArrowHeadAngle\bekutoru@s
                    \Mul\Arr@wHeadSize\bekutoru@s\bekutoru@s
                    \Addself\bekutoru@h\bekutoru@s
                    \allinethickness{\BK@thickness pt}%
                    \put(0,\bekutoru@h){\ArrowLine{(0,0)}{(\bekutoru@w,0)}}%
                    \Addself\bekutoru@h\bekutoru@s
                    \xdef\bekutoru@H{\bekutoru@h}%
                  \end{picture}%
                  \vrule width \z@ height \bekutoru@H \p@\box0
                }}%
                \def\bekutoru@m##1{{%
                  \@tempdima=1zh\relax
                  \edef\BK@hi{\strip@pt\@tempdima}%
                  \Div\BK@hi{9.16443}\BK@hi
                  \Mul{0.5}\BK@hi\BK@thickness
                  \changeArrowHeadSize\BK@hi
                  \setbox0=\hbox{\bekutoru@sityuu}%
                  \ukansan{\the\ht0}\bekutoru@h
                  \setbox0=\hbox{\ensuremath{\displaystyle ##1}}%
                  \ukansan{\the\wd0}\bekutoru@w
                  \begin{picture}(0,0)\relax
                    \edef\ArrowHeadPit{\bekutoru@kubomi}%
                    \DegSin\ArrowHeadAngle\bekutoru@s
                    \Mul\Arr@wHeadSize\bekutoru@s\bekutoru@s
                    \Addself\bekutoru@h\bekutoru@s
                    \allinethickness{\BK@thickness pt}%
                    \put(0,\bekutoru@h){\ArrowLine{(0,0)}{(\bekutoru@w,0)}}%
                    \Addself\bekutoru@h\bekutoru@s
                    \xdef\bekutoru@H{\bekutoru@h}%
                  \end{picture}%
                  \vrule width \z@ height \bekutoru@H \p@\box0
                }}%
              }%
              {
                \relax
              }%
  }}{}%
%
% 多角形のシェイディング ---------------------------------------------
%   \nuritubusi[濃さ](x1,y1)(x2,y2).....(xN,yN)(x1,y1)
%       濃さは 0（真っ白） と 1（真っ黒） の間の数（デフォルトは 0.5）
%       (x1,y1)....(xN,yN) は多角形の頂点
%       閉じていなければなりませんから，最後に (x1,y1)

\def\nuritubusi{\@ifnextchar[{\@nuritubusi}{\@nuritubusi[.5]}}%
\def\@nuritubusi[#1]{\special{sh #1}\@@nuritubusi}%
\def\@@nuritubusi{\@ifnextchar({\@@@nuritubusi}{\special{ip}}}%
\def\@@@nuritubusi(#1,#2){{%
  \@ifundefined{em@dvipdfm}{%
    \@tempdima#1\unitlength\@tempdima13.837\@tempdima%
    \@tempdimb#2\unitlength\@tempdimb-13.837\@tempdimb%
  }{%
    \iftdir
      \@tempdima#2\unitlength\@tempdima13.837\@tempdima%
      \@tempdimb#1\unitlength\@tempdimb13.837\@tempdimb%
    \else
      \@tempdima#1\unitlength\@tempdima13.837\@tempdima%
      \@tempdimb#2\unitlength\@tempdimb-13.837\@tempdimb%
    \fi
  }%
  \special{pa \@seisuu\@tempdima\space\@seisuu\@tempdimb}}%
    \@@nuritubusi}%
%\def\@@@nuritubusi(#1,#2){{%
%    \@tempdima#1\unitlength\@tempdima13.837\@tempdima%
%    \@tempdimb#2\unitlength\@tempdimb-13.837\@tempdimb%
%    \special{pa \strip@pt\@tempdima\space \strip@pt\@tempdimb}}%
%    \@@nuritubusi}%

\def\get@orgpoint(#1,#2)#3\@nil{\edef\@rgpoint{(#1,#2)}}%

\def\nuri@noudo{.5}%
\def\nurinoudo#1{\def\nuri@noudo{#1}}%
\def\Nuritubusi{\@ifstar{\Hatchpolygon}{\Nuritubusi@}}%
\def\Nuritubusi@{\@ifnextchar[{\Nuritubusi@@}{\Nuritubusi@@[\nuri@noudo]}}%
\def\Nuritubusi@@[#1]{\@ifnextchar<{\@Nuritubusi[#1]}{%
  \@Nuritubusi[#1]<\empty>}}
\def\@Nuritubusi[#1]<#2>#3{%
\ifthenelse{\equal{#3}\empty}{}{%
  \ifnum\EMps@mode=\@ne\gsave\fi
%  \expandafter\get@orgpoint#3\@nil%%%%%%%%%%%%%% ↓
  \edef\Nuri@orgP{#3}%%%%%%%%%%%%%%%%%%%%%%%%%%%% 2004/12/14
  \expandafter\get@orgpoint\Nuri@orgP\@nil
  \edef\Nuritubusi@takakkei{#3\@rgpoint}%
  \def\draw@border{}%
  \Strchr{#2}{=}\Hatchpoly@tmp
  \ifnum\Hatchpoly@tmp>\z@\setkeys{emP}{#2}\fi
  \IFempty{\draw@border}{}{\Drawline{\Nuritubusi@takakkei}}%
  \def\nuri@iro{\nuri@iro@}%
  \Strchr{#1}{=}\nuri@iro@tmp
  \ifnum\nuri@iro@tmp>\z@\setkeys{emP}{#1}\fi
  \ifthenelse{\equal{#1}{0}}{%
    \put(0,0){\special{sh #1}\@@Nuritubusi{\Nuritubusi@takakkei}}%
  }{%
    \ifthenelse{\equal\nuri@iro\empty}{%
      \put(0,0){\special{sh #1}\@@Nuritubusi{\Nuritubusi@takakkei}}%
    }{%
      \put(0,0){%
        \special{bk}{\@iro{\nuri@iro}\@@Nuritubusi{\Nuritubusi@takakkei}}}%
    }%
  }%
  \ifnum\EMps@mode=\@ne\grestore\fi
  }\ignorespaces}%
\def\@@Nuritubusi#1{\edef\@tmp{#1}\expandafter\@@nuritubusi\@tmp}


% ---------------------------------------------------------------------
% 折れ線で囲まれた図形のハッチング

% \hatchpolygon(x1,y1)(x2,y2).....(xN,yN)% x1=xN, y1=yN
%\edef\syanuri@kankaku{.125}%   k の刻み値
%\edef\h@angle{45}%   hatch の方向角
%\DegRad\h@angle\h@angle
%\Cos\h@angle\h@v@x%
%\Sin\h@angle\h@v@y%    (\h@v@x,\h@v@y):hatch の方向ベクトル
\def\syasen@tanmatu{0pt}
\def\hatchpolygon{\edef\n@vertex{0}%
  \edef\k@max{-1000}%
  \edef\k@min{1000}%
  \@preHP}%
\def\@preHP{\@ifnextchar({\pre@HP}{\@hatchpolygon}}%
\def\pre@HP(#1,#2){\IAdd\n@vertex{1}\n@vertex
  \expandafter\edef\csname v@x\romannumeral\n@vertex\endcsname{#1}%
  \expandafter\edef\csname v@y\romannumeral\n@vertex\endcsname{#2}%
  \Mul\h@v@x{#2}\@k\Mul\h@v@y{#1}\@kk\Sub\@k\@kk\@k% y\cosΘ-x\sinΘ
% \Sub{#2}{#1}\@k%
  \expandafter\edef\csname v@k\romannumeral\n@vertex\endcsname{\@k}%
  \ifdim\@k pt>\k@max pt\relax\edef\k@max{\@k}\edef\n@max{\n@vertex}\fi
  \ifdim\@k pt<\k@min pt\relax\edef\k@min{\@k}\edef\n@min{\n@vertex}\fi
  \@preHP}%
\def\@hatchpolygon{%\n@vertex max=\k@max(\n@max), min=\k@min(\n@min)\\%
  \edef\v@i{1}%
  \@whilenum\v@i<\n@vertex\do{%\v@i :
% (\csname v@x\romannumeral\v@i\endcsname,
% \csname v@y\romannumeral\v@i\endcsname)
% \csname v@k\romannumeral\v@i\endcsname\\
  \IAdd\v@i{1}\v@i}%
  \Add\k@min\syanuri@kankaku\@k@
  \edef\@L{\n@min}%
  \edef\@U{\n@min}%
  \@ifundefined{syanuri@siteiten}{}{%
    \IFempty{\syanuri@siteiten}{}{%
      \vecXY\syanuri@siteiten\ten@x\ten@y
      \Mul\h@v@x\ten@y\@k\Mul\h@v@y\ten@x\@kk\Sub\@k\@kk\@k
      \@whiledim\@k pt>\k@min pt\relax\do{\Sub\@k\syanuri@kankaku\@k}%
      \Add\@k\syanuri@kankaku\@k@
    }%
  }%
  \@whiledim\@k@ pt<\k@max pt\relax\do{%
      \edef\@tmp{\csname v@k\romannumeral\@L\endcsname}%
      \@whiledim\@tmp pt<\@k@ pt\relax\do{%
        \next@L\@L\@L%
        \edef\@tmp{\csname v@k\romannumeral\@L\endcsname}%
      }%
      \edef\@tmp{\csname v@k\romannumeral\@U\endcsname}%
      \@whiledim\@tmp pt<\@k@ pt\relax\do{%
        \next@U\@U\@U%
        \edef\@tmp{\csname v@k\romannumeral\@U\endcsname}%
      }%
      \edef\@Pi{(\csname v@x\romannumeral\@L\endcsname,\csname v@y\romannumeral\@L\endcsname)}%
      \next@U\@L\@Li
      \edef\@Pii{(\csname v@x\romannumeral\@Li\endcsname,\csname v@y\romannumeral\@Li\endcsname)}%
      \Mul\@k@\h@v@y\h@x\Mul\@k@\h@v@x\h@y
      \Landl\@Pi\@Pii{(-\h@x,\h@y)}{(\h@v@x,\h@v@y)}\@P%
      \edef\@Qi{(\csname v@x\romannumeral\@U\endcsname,\csname v@y\romannumeral\@U\endcsname)}%
      \next@L\@U\@Ui
      \edef\@Qii{(\csname v@x\romannumeral\@Ui\endcsname,\csname v@y\romannumeral\@Ui\endcsname)}%
      \Landl\@Qi\@Qii{(-\h@x,\h@y)}{(\h@v@x,\h@v@y)}\@Q%
%     \@k@:\@L-\@U:\@Pi-\@Pii=\@P;\@Qi-\@Qii=\@Q\\
%     \Drawline{\@P\@Q}%
      \Sensyu{\@P\@Q}%
%      \ifdim\syasen@tanmatu>\z@
%        \bgroup
%        \@tempdima=\syasen@tanmatu
%        \Div{\strip@pt\@tempdima}{\strip@pt\unitlength}\Syanuri@tanmatu
%        \Bunten\@P\@Q11\@M
%        \Kyori\@P\@M\@MP
%        \ifdim\@MP pt>\Syanuri@tanmatu pt\relax
%          \Sub\@MP\Syanuri@tanmatu\@dsya
%          \Div\@dsya\@MP\@dsya
%          \Subvec\@P\@M\@vMP
%          \Mulvec\@dsya\@vMP\@vsya
%          \Addvec\@M\@vsya\@P
%          \Subvec\@M\@vsya\@Q
%          \Sensyu{\@P\@Q}%
%        \fi
%        \egroup
%      \else
%        \Sensyu{\@P\@Q}%
%      \fi
      \Add\@k@\syanuri@kankaku\@k@
  }%
}%
\def\next@L#1#2{\ifnum#1=1\edef#2{\n@vertex}\fi%
\IAdd{#1}{-1}\@nn\edef#2{\@nn}}%
\def\next@U#1#2{\ifnum#1=\n@vertex\edef#2{1}\fi%
\IAdd{#1}{1}\@nn\edef#2{\@nn}}%

% \Hatchpolygon[#1]<#2>#3
%   #1 : 斜線の方向角Θ (-90度 〜 90 度） y\cosΘ-x\sinΘ=k
%   #2 : k の刻み値
%   #3 : 閉多角形
%   [制約条項] 直線群 y\cosΘ-x\sinΘ=k が閉多角形によって
%              きり取られる線分は単一の連結な線分であること．

\def\Hatchpolygon{\@ifnextchar[{\@Hatchpolygon}{\@Hatchpolygon[45]}}%
\def\@Hatchpolygon[#1]{\@ifnextchar<{\@@Hatchpolygon[#1]}{%
  \@@Hatchpolygon[#1]<\empty>}}%
\def\@@Hatchpolygon[#1]<#2>#3{{%
\ifnum\EMps@mode=\@ne\gsave\fi
\ifthenelse{\equal{#3}\empty}{}{%
  \expandafter\get@orgpoint#3\@nil%
  \edef\Nuritubusi@takakkei{#3\@rgpoint}%
\edef\h@angle{#1}%    hatch の方向角
%\edef\syanuri@kankaku{.125}%        k の刻み値
\def\syanuri@siteiten{}%
\def\draw@border{}%
\Strchr{#2}{=}\Hatchpoly@tmp
\ifnum\Hatchpoly@tmp>\z@
  \ukansan{3pt}\syanuri@kankaku
  \setkeys{emP}{#2}%
\else
  \ifx \empty #2\relax
    \ukansan{3pt}\syanuri@kankaku
  \else
    \edef\syanuri@kankaku{#2}%
  \fi
\fi
%\@ifundefined{@yscale}{}{\Div\syanuri@kankaku\@yscale\syanuri@kankaku}%
%------------------------------------------------------------
%\typeout{syanuri@kankaku=\syanuri@kankaku}%
%------------------------------------------------------------
\IFempty{\draw@border}{}{\Takakkei{\Nuritubusi@takakkei}}%
\DegRad\h@angle\h@angle
\Cos\h@angle\h@v@x%
\Sin\h@angle\h@v@y%   (\h@v@x,\h@v@y):hatch の方向ベクトル
\@ifundefined{@xscale}{}{%
  \Div\h@v@x\@xscale\h@v@x
  \Div\h@v@y\@yscale\h@v@y
  \PhAbsvec{(\h@v@x,\h@v@y)}\h@v@norm
  \Div\h@v@x\h@v@norm\h@v@x
  \Div\h@v@y\h@v@norm\h@v@y
% \calcval{atan2(\@xscale*\h@v@y,\@yscale*\h@v@x)}\h@angle
% \Cos\h@angle\h@v@x%
% \Sin\h@angle\h@v@y%   (\h@v@x,\h@v@y):hatch の方向ベクトル
}%
\edef\@tmp{\Nuritubusi@takakkei}%
\put(0,0){{%
  \ifthenelse{\equal\iro@\empty}{}{\color{\iro@}}\relax%%%%%%%%%%%% 2004/12/20
  \expandafter\hatchpolygon\@tmp}}%
\ifdim\syasen@tanmatu>\z@%  田中 徹 さんのアイデア
  \open@nuri
%    \@tempdima=\syasen@tanmatu
%    \@tempdima=2\@tempdima
%    \color{white}\allinethickness{\@tempdima}%
%    \Drawline\Nuritubusi@takakkei
\fi
}%
\ifnum\EMps@mode=\@ne\grestore\fi
}}%

\def\open@nuri{%
    \@tempdima=\syasen@tanmatu
    \@tempdima=2\@tempdima
    \color{white}\allinethickness{\@tempdima}%
    \Drawline\Nuritubusi@takakkei
}
% ---------------------------------------------------------------------

%\def\Suisen#1#2#3#4{% 点 #1 から直線 #2#3 へ下ろした垂線の足を #4 にセット
%  \Kyori{#1}{#2}\Suisen@a
%  \Kyori{#1}{#3}\Suisen@b
%  \Kyori{#2}{#3}\Suisen@c
%  \IFnearlyzero[0.0005]\Suisen@a{\edef#4{#1}}{%
%    \IFnearlyzero[0.0005]\Suisen@b{\edef#4{#1}}{%
%    \IFnearlyzero[0.0005]\Suisen@c{\edef#4{#2}}{%
%  \sankakkei*{#1}{#2}{#3}%
% \Mul\lc\lc\cosB\Mul\la\la\@tmp\Add\cosB\@tmp\cosB%
%  \Mul\lb\lb\@tmp\Sub\cosB\@tmp\cosB\Mul\lc\la\@tmp\Mul{2}\@tmp\@tmp%
%  \Div\cosB\@tmp\cosB\Mul\lc\cosB\S@m\Sub\la\S@m\@n
%  \Bunten{#2}{#3}\S@m\@n{#4}%\fi\fi\fi
%  }}}}%
%
\def\Suisen#1#2#3#4{% 点 #1 から直線 #2#3 へ下ろした垂線の足を #4 にセット
  \Subvec{#3}{#2}\Suisen@v
  \Nvec\Suisen@v\Suisen@h
  \Landl{#2}{#3}{#1}\Suisen@h#4}
%
\def\vecXY#1#2#3{%  点 #1 の座標から x座標を #2 へ，y座標を #3 へ抽出
    \edef\vecXY@tmp{#1}%
    \expandafter\@vecXY\vecXY@tmp{#2}{#3}}%
\def\@vecXY(#1,#2)#3#4{\edef#3{#1}\edef#4{#2}}%
%
\def\Addvec{\@ifstar{\Addvec@}{\@Addvec}}
\def\@Addvec#1#2#3{\vecXY{#1}\a@x\a@y\vecXY{#2}\b@x\b@y% ベクトル計算
  \Add\a@x\b@x\a@x\Add\a@y\b@y\a@y\edef#3{(\a@x,\a@y)}}%
\def\Addvec@#1#2#3{\vecXY{#1}\a@x\a@y\vecXY{#2}\b@x\b@y% #2 : 単位つき
  \ifx0\b@x\def\a@x{0}\else\ukansan\b@x\b@x\fi
  \ifx0\b@y\def\a@y{0}\else\ukansan\b@y\b@y\fi
  \Add\a@x\b@x\a@x\Add\a@y\b@y\a@y\edef#3{(\a@x,\a@y)}}%
\def\Subvec#1#2#3{\vecXY{#1}\a@x\a@y\vecXY{#2}\b@x\b@y%
  \Sub\a@x\b@x\a@x\Sub\a@y\b@y\a@y\edef#3{(\a@x,\a@y)}}%
\def\Mulvec#1#2#3{\vecXY{#2}\a@x\a@y%
  \Mul{#1}\a@x\a@x\Mul{#1}\a@y\a@y\edef#3{(\a@x,\a@y)}}%
\def\Addvecself#1#2{\Addvec{#1}{#2}{#1}}%
\def\Mulvecself#1#2{\Mulvec{#1}{#2}{#2}}%
\def\ItiziKetugou#1#2#3#4#5{\Mulvec{#1}{#2}\ItiKetu@u\Mulvec{#3}{#4}\ItiKetu@v%
  \Addvec\ItiKetu@u\ItiKetu@v #5\relax}%
\def\itiziketugou#1#2{%
    \edef#2{(0,0)}%
    \Cfor{\edef\itiketu@a{#1}}{\not\equal\itiketu@a\empty}{}\do{%
      \strsep\itiketu@a{;}\itiketu@a\itiketu@b
      \strsep\itiketu@a{,}\itiketu@l\itiketu@v
      \Mulvec\itiketu@l\itiketu@v\itiketu@v\Addvec{#2}\itiketu@v#2\relax
      \edef\itiketu@a{\itiketu@b}}%
}

% 点 #1 から
%     #2 を通り，方向ベクトルが #3 である直線
% に下ろした垂線の足を #4 の制御綴に返す。

\def\mSuisen#1#2#3#4{\Addvec{#2}{#3}\mSuisen@a\Suisen{#1}{#2}{\mSuisen@a}#4}

% 点 #1 から
%     #2 を通り，方向角が #3(度)である直線
% に下ろした垂線の足を #4 の制御綴に返す。
\def\kSuisen#1#2#3#4{\DegRad{#3}\kSuisen@a
  \Cos\kSuisen@a\kSuisen@x\Sin\kSuisen@a\kSuisen@y
  \Addvec{#2}{(\kSuisen@x,\kSuisen@y)}\kSuisen@a
  \Suisen{#1}{#2}{\kSuisen@a}#4}

% 対称点
% \Taisyouten#1#2#3[#4]#5
%   点 #1 の
%     #2, #3 を通る直線への対称点を#5に返す。
%   対称の中心もほしいときは#4にそれを受取る制御綴を与える。
%
\def\Taisyouten#1#2#3{\@ifnextchar[{\@Taisyouten{#1}{#2}{#3}}{%
  \@Taisyouten{#1}{#2}{#3}[\Taisyouten@h]}}
\def\@Taisyouten#1#2#3[#4]#5{\Suisen{#1}{#2}{#3}#4
  \Bunten{#1}{#4}{2}{-1}#5}

% 点 #1 の
%     #2 を通り，方向ベクトルが #3 である直線への対称点
%
\def\mTaisyouten#1#2#3{\@ifnextchar[{\@mTaisyouten{#1}{#2}{#3}}{%
  \@mTaisyouten{#1}{#2}{#3}[\Taisyouten@h]}}
\def\@mTaisyouten#1#2#3[#4]#5{\mSuisen{#1}{#2}{#3}#4
  \Bunten{#1}{#4}{2}{-1}#5}

% 点 #1 の
%     #2 を通り，方向角が #3 である直線への対称点
%
\def\kTaisyouten#1#2#3{\@ifnextchar[{\@kTaisyouten{#1}{#2}{#3}}{%
  \@kTaisyouten{#1}{#2}{#3}[\Taisyouten@h]}}
\def\@kTaisyouten#1#2#3[#4]#5{\kSuisen{#1}{#2}{#3}#4
  \Bunten{#1}{#4}{2}{-1}#5}

% #1 に垂直な単位ベクトル
\def\Nvec#1#2{\vecXY{#1}\a@x\a@y\Mul{-1}\a@y\a@y\Unit(\a@y,\a@x)(\b@x,\b@y)%
  \edef#2{(\b@x,\b@y)}}%
\def\Housenvec#1#2{\vecXY{#1}\a@x\a@y\Mul{-1}\a@y\a@y\edef#2{(\a@y,\a@x)}}
%
% 線分を与えて，その垂直二等分線を求める。
% \SuityokuNitoubunsen#1#2#3#4
%   #1 : 点1
%   #2 : 点2
%   #3 : 点1,2 の中点
%   #4 : 垂直二等分線の方向ベクトル
%
\def\SuityokuNitoubunsen#1#2#3#4{%
  \Tyuuten{#1}{#2}#3\relax
  \Subvec{#2}{#1}\SN@vec
  \vecXY\SN@vec\SN@vecx\SN@vecy
  \Mul\SN@vecy{-1}\SN@vecy
  \edef#4{(\SN@vecy,\SN@vecx)}%
}
%
% 分点の座標
%   \Bunten#1#2#3#4#5
%       線分 #1#2 を #3:#4 に分ける点の座標を #5 に代入する．
%
%\def\Bunten#1#2#3#4#5{\edef\@tmp{#1#2}%
%    \expandafter\bunten\@tmp{#3}{#4}{#5}}%
%\def\bunten(#1,#2)(#3,#4)#5#6#7{%
%    \Add{#5}{#6}\@bunbo\Mul{#1}{#6}\@buntenX\Mul{#3}{#5}\@tmp%
%    \Add\@buntenX\@tmp\@buntenX\Div\@buntenX\@bunbo\@buntenX%
%    \Mul{#2}{#6}\@buntenY\Mul{#4}{#5}\@tmp%
%    \Add\@buntenY\@tmp\@buntenY\Div\@buntenY\@bunbo\@buntenY%
%    \edef#7{(\@buntenX,\@buntenY)}}%
\def\Bunten#1#2#3#4#5{%
  \Add{#3}{#4}\BT@bunbo
  \Div{#4}\BT@bunbo\BT@a
  \Div{#3}\BT@bunbo\BT@b
  \ItiziKetugou\BT@a{#1}\BT@b{#2}#5
}
\def\Tyuuten#1#2#3{%
  \vecXY{#1}\tyuuten@xi\tyuuten@yi
  \vecXY{#2}\tyuuten@xii\tyuuten@yii
  \Add\tyuuten@xi\tyuuten@xii\tyuuten@xx\Mul{.5}\tyuuten@xx\tyuuten@x
  \Add\tyuuten@yi\tyuuten@yii\tyuuten@yy\Mul{.5}\tyuuten@yy\tyuuten@y
  \edef#3{(\tyuuten@x,\tyuuten@y)}}
%
% 三角形の諸要素の計算
\def\sankakkei{\@ifstar{\sankakkei@}{\@sankakkei}}
\def\sankakkei@#1#2#3{%
  \Kyori{#1}{#2}\lc\Kyori{#2}{#3}\la\Kyori{#3}{#1}\lb
  \Add\la\lb\ls\Add\ls\lc\ls\Div\ls{2}\ls%    \ls = s
  \Sub\ls\la\lsa%                 \lsa= s-a
  \Sub\ls\lb\lsb%                 \lsb= s-b
  \Sub\ls\lc\lsc%                 \lsc= s-c
}
\def\@sankakkei#1#2#3{%
%  \edef\@tmp{#1#2}\expandafter\Distance\@tmp\lc%  \lc = 辺 AB の長さ
%  \edef\@tmp{#2#3}\expandafter\Distance\@tmp\la%  \la = 辺 BC の長さ
%  \edef\@tmp{#1#3}\expandafter\Distance\@tmp\lb%  \lb = 辺 CA の長さ
  \Kyori{#1}{#2}\lc\Kyori{#2}{#3}\la\Kyori{#3}{#1}\lb
  \Add\la\lb\ls\Add\ls\lc\ls\Div\ls{2}\ls%    \ls = s
  \Sub\ls\la\lsa%                 \lsa= s-a
  \Sub\ls\lb\lsb%                 \lsb= s-b
  \Sub\ls\lc\lsc%                 \lsc= s-c
  \vecXY{#1}\@ai\@aii
  \vecXY{#2}\@bi\@bii
  \vecXY{#3}\@ci\@cii
  \def\menseki{0}%
  \Detii\@ci\@cii\@ai\@aii\Addself\menseki\Det@ans
  \Detii\@bi\@bii\@ci\@cii\Addself\menseki\Det@ans
  \Detii\@ai\@aii\@bi\@bii\Addself\menseki\Det@ans
  \Div\menseki{2}\menseki@
  \AbsSign\menseki@\menseki\orienttriangle
%  \Mul\ls\lsa\menseki\Heihoukon\menseki\menseki
%  \Mul\lsb\lsc\@menseki\Heihoukon\@menseki\@menseki%
%  \Mul\menseki\@menseki\menseki
%  面積=\menseki \orienttriangel=+or\@empty
}%
%
% 三角形の回転符号
%   三角形#1#2#3が正の向きのとき#4の制御綴りに1が返る。
%
\def\trisign#1#2#3#4{%
  \Subvec{#2}{#1}\trisign@a\vecXY\trisign@a\trisign@ax\trisign@ay
  \Subvec{#3}{#1}\trisign@b\vecXY\trisign@b\trisign@bx\trisign@by
  \Mul\trisign@ax\trisign@by\trisign@c
  \Mul\trisign@ay\trisign@bx\trisign@d
  \Sub\trisign@c\trisign@d\trisign@s
  \ifdim\trisign@s\p@>0.0005\p@\edef#4{1}\else
  \ifdim\trisign@s\p@<-0.0005\p@\edef#4{-1}\else
  \edef#4{0}\fi\fi
}
%
% 三角形の内角
%
% \naikaku<#1>#2#3#4#5
%   三角形#2#3#4 の内角#3を#5に返す
%   <perl>を指定したときは，emathPp.sty が必要
%
\def\naikaku{\@ifnextchar<{\@naikaku}{\@@naikaku}}
\def\@@naikaku#1#2#3#4{%
  \Subvec{#1}{#2}\naikaku@u\Argvec\naikaku@u\naikaku@BA
  \Subvec{#3}{#2}\naikaku@v\Argvec\naikaku@v\naikaku@BC
  \Sub\naikaku@BC\naikaku@BA#4\relax
  \ifdim #4\p@<\z@\Mul{-1}{#4}#4\fi
  \ifdim #4\p@>180\p@\Sub{360}{#4}#4\fi
}
\def\@naikaku<#1>#2#3#4#5{%
  \Subvec{#2}{#3}\naikaku@u\Argvec<perl>\naikaku@u\naikaku@BA
  \Subvec{#4}{#3}\naikaku@v\Argvec<perl>\naikaku@v\naikaku@BC
  \Sub\naikaku@BC\naikaku@BA#5\relax
  \ifdim #5\p@<\z@\Mul{-1}{#5}#5\fi
  \ifdim #5\p@>180\p@\Sub{360}{#5}#5\fi
}
%
% 2辺夾角から第3辺の長さを求める．
% \yogen#1#2#3#4
%   c^2=a^2+b^2-2ab\cosC
% #1 = a
% #2 = b
% #3 = C
%   #4 = c を受け取るコントロールシーケンス
\def\yogen#1#2#3#4{%
  \Mul{#1}{#1}\yogen@c%
  \Mul{#2}{#2}\yogen@cc%
  \Add\yogen@c\yogen@cc\yogen@c
  \DegRad{#3}\yogen@C
  \Cos\yogen@C\yogen@cc
  \Mul{#1}\yogen@cc\yogen@cc
  \Mul{#2}\yogen@cc\yogen@cc
  \Mul{2}\yogen@cc\yogen@cc
  \Sub\yogen@c\yogen@cc\yogen@c
  \Heihoukon\yogen@c\yogen@c
  \edef#4{\yogen@c}}%

% 正弦定理
% \seigenR#1#2
%   #1 : a
%   #2 : A
%     外接円の直径が \lRR, 半径が \lR にセットされる．
% \Seigen[#1]#2#3
%   #2 : a
%   #3 : sin A を受取るコントロールシーケンス
%   #1 = e のときは，角A（鋭角）を求める．（デフォルト）
%   #1 = d のときは，角A（鈍角）を求める．
% \seigen#1#2
%   #1 : A
%   #2 : a を受取るコントロールシーケンス

\def\seigenR#1#2{\DegRad{#2}\@kaku\Sin\@kaku\lR
  \Div{#1}\lR\lRR\Div\lRR2\lR}%
\def\seigen#1#2{\DegRad{#1}\seigen@tmp\Sin\seigen@tmp\seigen@tmp%
  \Mul\lRR\seigen@tmp\seigen@tmp\edef#2{\seigen@tmp}}%
\def\Seigen{\@ifnextchar[{\@Seigen}{\@Seigen[e]}}
\def\@Seigen[#1]#2#3{\Div{#2}\lRR\seigen@tmp%
  \if e#1\asin\seigen@tmp\seigen@tmp\else%
  \if d#1\asin\seigen@tmp\seigen@tmp\Sub{180}\seigen@tmp\seigen@tmp%
  \fi\fi%
  \edef#3{\seigen@tmp}}%

% 3辺の長さから角の余弦を求める．
% \Yogen[#1]#2#3#4#5
% cos(A)=(b^2+c^2-a^2)/(2bc)
%     #2=a, #3=b, #4=c 結果は #5 にセット
%     #1=a のときは角を求める．（単位は度）
\def\Yogen{\@ifnextchar[{\@Yogen}{\@Yogen[\empty]}}%
\def\@Yogen[#1]#2#3#4#5{%
  \Mul{#3}{#3}\y@gen\Mul{#4}{#4}\@tmp\Add\y@gen\@tmp\y@gen%
  \Mul{#2}{#2}\@tmp%
  \Sub\y@gen\@tmp\y@gen\Mul{#3}{#4}\@tmp\Mul\@tmp{2}\@tmp%
  \Div\y@gen\@tmp\y@gen
  \ifx a#1\acos\y@gen\y@gen%
    \ifdim\y@gen pt<\z@\Add\y@gen{180}\y@gen\fi\fi
  \edef#5{\y@gen}}%
%
% 2辺夾角から第3辺の長さを求める．
% \yogen#1#2#3#4
% #1=b, #2=c, #3=A → a を#4にセットする．
%
\def\yogen#1#2#3#4{%
  \Mul{#1}{#1}\yogen@tmp
  \Mul{#2}{#2}\yogen@@tmp\Add\yogen@tmp\yogen@@tmp\yogen@tmp
  \DegRad{#3}\yogen@@tmp\Cos\yogen@@tmp\yogen@@tmp
  \Mul{2}\yogen@@tmp\yogen@@tmp
  \Mul{#1}\yogen@@tmp\yogen@@tmp
  \Mul{#2}\yogen@@tmp\yogen@@tmp
  \Sub\yogen@tmp\yogen@@tmp\yogen@tmp
  \Heihoukon\yogen@tmp\yogen@tmp
  \edef#4{\yogen@tmp}}%

%   \emathPut[#1]#2[#3](#4,#5)[#6]#7
%       #1 :
%            background=white 背景を白く塗る
%            kaiten    =ddd   文字を ddd度 回転する
%            houkou    =vvv          ベクトル vvv の方向に
%            fromP,to=Q              ベクトル PQ の方向に
%       #2 : 文字列を置く位置（座標）
%       #3 : r のときは，次の座標を極形式とみなす
%       (#4,#5) : 位置の修正ベクトル 【新設】単位必須
%       #6 : \makebox の [..] オプション
%       #7 : 文字列
%   \emathPut#1[#2]#3
%       #1 : 文字列を置く位置（座標）
%       #2 : 方角
%       #3 : 文字列

\def\default@syaeisensyu{\hasen}
\def\defsyaeisensyu#1{\def\default@syaeisensyu{#1}}
\def\emathPut{\def\cPut@orgP{\empty}\emath@Put}
\def\emath@Put{\@ifnextchar[{\em@thPut}{\em@thPut[\empty]}}
\def\em@thPut[#1]{%
  \define@key{emPut}{background}{\ifthenelse{\equal{##1}{white}}{%
    \edef\bg@white{1}}}%
  \define@key{emPut}{kaiten}{\edef\kaiten@kaku{##1}}%
  \define@key{emPut}{houkou}{\Argvec{##1}\kaiten@kaku}%
  \define@key{emPut}{from}{\edef\houkou@from{##1}}%
  \define@key{emPut}{to}{\Subvec{##1}\houkou@from\houkou@v
    \Argvec\houkou@v\kaiten@kaku}%
  \edef\kaiten@kaku{0}\edef\bg@white{0}
  \ifx \empty #1\else\setkeys{emPut}{#1}\fi
  \@em@thPut}
\def\@em@thPut#1{\ifthenelse{\equal\empty\cPut@orgP}{\edef\cPut@orgP{#1}}{}%
  \@ifnextchar({\emathPut@{#1}}{\@emathPut{#1}}}%
\def\emathPut@#1(#2,#3){\@ifnextchar[{\@@emathPut{#1}(#2,#3)}{%
  \@@emathPut{#1}(#2,#3)[c]}}%
\def\@emathPut#1{\@ifnextchar[{\@@emathPut@{#1}}{\@@@emathPut{#1}}}
\def\@@emathPut#1(#2,#3)[#4]#5{{%
%\typeout{now! @@emathPut arg5=#5}%
    \ifx #20\@tempdima=\z@\else\@tempdima=#2\fi
      \Div{\strip@pt\@tempdima}{\strip@pt\unitlength}\emathPut@u@pt%
    \ifx #30\@tempdimb=\z@\else\@tempdimb=#3\fi%        1999.4.28
      \Div{\strip@pt\@tempdimb}{\strip@pt\unitlength}\v@pt%
    \Addvec{#1}{(\emathPut@u@pt,\v@pt)}\@v
    \ifthenelse{\equal{\bg@white}{1}}{%
    \edef\kaiten@@kaku{\kaiten@kaku}\wPut\@v<\kaiten@@kaku>[#4]{#5}}{%
    \ifdim\kaiten@kaku pt=\z@
      \@@@emathPut\@v{\makebox(0,0)[#4]{#5}}%
    \else\edef\kaiten@@kaku{\kaiten@kaku}\@@@emathPut\@v{%
      \rotatebox{\kaiten@@kaku}{\makebox(0,0)[#4]{#5}}}%
    \fi}%
}}%
\def\@@@emathPut#1#2{%\edef\local@origin{#1}%
  \edef\put@tmp{#1}\expandafter\put\put@tmp{#2}%
% \edef\local@origin{(0,0)}%
  }%
\def\@@emathPut@#1[#2]{%
  \ifthenelse{\equal{#2}{r}}{\@@emathPut@r{#1}}{%
  \@@emathPut@@{#1}[#2]}}%
\def\@@emathPut@r#1(#2,#3){%
    \DegRad{#3}\Rdef@T%
    \Cos\Rdef@T\Rdef@x\templa=#2\relax\templa=\Rdef@x\templa%
    \Sin\Rdef@T\Rdef@y\templb=#2\relax\templb=\Rdef@y\templb%
    \emathPut@{#1}(\templa,\templb)}
\def\@@emathPut@@#1[#2]{%
  \def\syaei@xpos{}\def\syaei@ypos{}%
  \define@key{emPut}{houi}{\edef\@houi{##1}}%
  \define@key{emPut}{xlabel}{\def\label@x{##1}}%
  \define@key{emPut}{ylabel}{\def\label@y{##1}}%
  \define@key{emPut}{xpos}{\def\syaei@xpos{##1}}%
  \define@key{emPut}{ypos}{\def\syaei@ypos{##1}}%
  \define@key{emPut}{syaei}{%
    \expandafter\@tfor\expandafter\@@c\expandafter:\expandafter=##1\do{%
      \if x\@@c\edef\syaei@x{1}\else
      \if y\@@c\edef\syaei@y{1}\fi\fi}}%
  \define@key{emPut}{syaeisensyu}{\def\syaeisensyu{##1}}
  \Strchr{#2}{=}\emP@tmp
  \ifthenelse{\emP@tmp>\z@}{%
    \edef\syaei@x{0}%
    \edef\syaei@y{0}%
    \edef\@houi{\empty}%
    \def\syaeisensyu{\default@syaeisensyu}%
    \vecXY{\cPut@orgP}\@Px\@Py
    \edef\label@x{\@Px}%
    \edef\label@y{\@Py}%
    \setkeys{emPut}{#2}%
    \ifthenelse{\equal{\@Px}{0}}{\edef\syaei@y{0}}{}%
    \ifthenelse{\equal{\@Py}{0}}{\edef\syaei@x{0}}{}%
    {%\def\syaeisensyu{\dashline[40]{.1}}%
      \ifnum\syaei@x>\z@\put(0,0){\syaeisensyu(\@Px,0)(\@Px,\@Py)}%
        {\ifx\empty\syaei@xpos
          \ifdim\@Py pt>\z@\def\syaei@xpos{[s]}\else\def\syaei@xpos{[n]}\fi
         \fi
         \edef\emPut@tmp{{(\@Px,0)}\syaei@xpos}%
         \expandafter\emathPut\emPut@tmp{$\label@x$}%
        }%
      \fi%
      \ifnum\syaei@y>\z@\put(0,0){\syaeisensyu(\@Px,\@Py)(0,\@Py)}%
        {\ifx\empty\syaei@ypos
          \ifdim\@Px pt>\z@\def\syaei@ypos{[w]}\else\def\syaei@ypos{[e]}\fi
         \fi
         \edef\emPut@tmp{{(0,\@Py)}\syaei@ypos}%
         \expandafter\emathPut\emPut@tmp{$\label@y$}
        }%
      \fi
    }%
    \ifthenelse{\equal{\@houi}{\empty}}{\emathPut{#1}}{%
      \@@emathPut@@@{#1}[\@houi]}%
  }{\@@emathPut@@@{#1}[#2]}}
\def\@@emathPut@@@#1[#2]#3{%
  \edef\h@ukou{0}%
  \expandafter\@tfor\expandafter\@@c\expandafter:\expandafter=#2\do{%
    \if n\@@c\IAdd\h@ukou{7}\h@ukou\else
    \if s\@@c\IAdd\h@ukou{4}\h@ukou\else
    \if e\@@c\IAdd\h@ukou{1}\h@ukou\else
    \if w\@@c\IAdd\h@ukou{-1}\h@ukou\fi\fi\fi\fi
  }%
  \ifnum\h@ukou=\m@ne\edef\h@ukou{2}\fi
  \ifcase\h@ukou
    \@@emathPut{#1}(0,2pt)[c]{#3}%
  \or%  1 東
    \@@emathPut{#1}(0,0)[l]{\,#3}%
  \or%  2 西
    \@@emathPut{#1}(0,0)[r]{#3\,}%
  \or%  3 南西
    \@@emathPut{#1}(-1.4pt,-1.4pt)[rt]{#3}%
  \or%  4 南
    \@@emathPut{#1}(0,-2pt)[ct]{#3}%
  \or%  5 南東
    \@@emathPut{#1}(1.4pt,-1.4pt)[lt]{#3}%
  \or%  6 北西
    \@@emathPut{#1}(-1.4pt,1.4pt)[rb]{#3}%
  \or%  7 北
    \@@emathPut{#1}(0,2pt)[cb]{#3}%
  \or%  8 北東
    \@@emathPut{#1}(1.4pt,1.4pt)[lb]{#3}%
  \fi%
}
% 背景を白く塗りつぶして文字列を配置する。
% \wPut#1<#2>[#3]#4
%   #1 : 基準点
%   #2 : 回転角
%   #3 : 配置     c|l|r|t|b|lt|lb|rt|rb
%   #4 : 文字列

\def\wPut#1{\@ifnextchar<{\@wPut{#1}}{%
  \@wPut{#1}<0>}}
\def\@wPut#1<#2>{\@ifnextchar[{\@@wPut{#1}<#2>}{%
  \@@wPut{#1}<#2>[c]}}
\def\@@wPut#1<#2>[#3]#4{{\@em@thPut{#1}{%
  \unitlength1pt%
  \begin{picture}(0,0)%
  \setbox0=\hbox{#4}%
  \@tempdima\wd0\divide\@tempdima2\relax
  \@tempdimb\ht0\advance\@tempdimb\dp0\divide\@tempdimb 2\relax
  \advance\@tempdima\fboxsep
  \advance\@tempdimb\fboxsep
  \tenretu*{%
    wP@A(-\strip@pt\@tempdima,-\strip@pt\@tempdimb);
    wP@B(\strip@pt\@tempdima,-\strip@pt\@tempdimb);
    wP@C(\strip@pt\@tempdima,\strip@pt\@tempdimb);
    wP@D(-\strip@pt\@tempdima,\strip@pt\@tempdimb)}%
  \edef\wP@P{(0,0)}\edef\wP@@P{(0,0)}%
  \expandafter\@tfor\expandafter\wP@@c\expandafter:\expandafter=#3\do{%
    \if l\wP@@c\Rdef(\strip@pt\@tempdima,#2)\wP@P%    l
    \else\if r\wP@@c\Rdef(-\strip@pt\@tempdima,#2)\wP@P%    r
    \else\if b\wP@@c\Add{90}{#2}\wP@vy
      \Rdef(\strip@pt\@tempdimb,\wP@vy)\wP@@P% b
    \else\if t\wP@@c\Add{90}{#2}\wP@vy
      \Rdef(-\strip@pt\@tempdimb,\wP@vy)\wP@@P% t
    \fi\fi\fi\fi}%
  \Addvec\wP@P\wP@@P\wP@P
  \ifthenelse{\equal{#2}{0}}{}{%
    \Rotvec\wP@A{#2}\wP@A
    \Rotvec\wP@B{#2}\wP@B
    \Rotvec\wP@C{#2}\wP@C
    \Rotvec\wP@D{#2}\wP@D}%
  \emathPut\wP@P{\Nuritubusi[0]{\wP@A\wP@B\wP@C\wP@D\wP@A}}%
  \ifthenelse{\equal{#2}{0}}{\emathPut\wP@P(0,0)[c]{\box0}}{%
    \emathPut\wP@P(0,0)[c]{\rotatebox{#2}{\box0}}}%
  \end{picture}}%
}}

\def\nPut{\@ifnextchar[{\@nPut}{\@nPut[c]}}
\def\@nPut[#1]#2{\emathPut{\csname #2\endcsname}[#1]{#2}}

%   \sPut[#1]#2#3(#4,#5)[#6]#7
%       #1 : 比率 (0~1)
%       #2 : 始点
%       #3 : 終点
%       (#4,#5) : 位置の修正ベクトル 【新設】単位必須
%       #6 : \makebox の [..] オプション
%       #7 : 文字列
%   #2 かｒ #3 へ向かう線分の #1 倍の位置(\X)に，
%       \emathPut\X(#4,#5)[#6]#7 として文字列(#7)を置く．

\def\sPut{\@ifnextchar[{\@sPut}{\@sPut[.5]}}%
\def\@sPut[#1]#2#3{\Subvec{#3}{#2}\v@sPut\Mulvec{#1}\v@sPut\v@sPut%
    \Addvec{#2}\v@sPut\v@sPut%
    \emathPut\v@sPut}
%\def\@sPut[#1]#2#3{\@ifnextchar({\@@sPut[#1]{#2}{#3}}{%
%    \@@sPut[#1]{#2}{#3}(0,0)}}%
%\def\@@sPut[#1]#2#3(#4,#5){\@ifnextchar[{\@@@sPut[#1]{#2}{#3}(#4,#5)}{%
%    \@@@sPut[#1]{#2}{#3}(#4,#5)[c]}}%
%\def\@@@sPut[#1]#2#3(#4,#5)[#6]#7{%
%    \Subvec{#3}{#2}\v@sPut\Mulvec{#1}\v@sPut\v@sPut%
%    \Addvec{#2}\v@sPut\v@sPut%
%    \emathPut\v@sPut(#4,#5)[#6]{#7}}%

% \PutStr#1[#2]#3to[#4]#5
%   #1 : 文字列を置く位置
%   #2 : #1 から見ての方位（デフォルト = e ）
%   #3 : 文字列
%   #4 : 文字列から出る矢印を円弧にしたいときはその半径を指定する。
%           key=val
%             arrowheadsize=..
%             hankei=.. （矢印円弧の半径--無名数）
%             Hankei=.. （矢印円弧の半径--単位つき）
%             addvec=.. （終点の修正ベクトル）成分は単位付の数値
%                           r(dx,dy)のときは，極座標形式
%   #5 : 文字列から出る矢印の終点
% \PutStr#1(#2,#3)[#4]#5to[#6]#7
%   #1〜#5 : \Put 文と同じ
%   #6 : 文字列から出る矢印を円弧にしたいときはその半径を指定する。
%           key=val
%             hankei=.. （矢印円弧の半径）
%             addvec=.. （終点の修正ベクトル）成分は単位付の数値
%   #7 : 文字列から出る矢印の終点

\def\PutStr#1{%
  \@ifnextchar({\PutStr@{#1}}{\@PutStr@{#1}}}
\def\@PutStr@#1{\@ifnextchar[{\@PutStr{#1}}{\@PutStr{#1}[e]}}
\def\@PutStr#1[#2]#3to{\@ifnextchar[{\@@PutStr{#1}[#2]#3to}{%
  \@@PutStr{#1}[#2]#3to[0]}}
\def\@@PutStr#1[#2]#3to[#4]#5{\emathPut{#1}[#2]{#3}%
  \edef\PutStr@s{#1}\@@@PutStr[#4]{#5}}%
%\def\@@PutStr#1[#2]#3to[#4]#5{\emathPut{#1}[#2]{#3}%
%  \ifthenelse{\equal{#4}{0}}{\ArrowLine{#1}{#5}}{\ArrowArc{#4}{#1}{#5}}}
% \if 0#4\relax\ArrowLine{#1}{#5}\else\ArrowArc{#4}{#1}{#5}\fi}
\def\PutStr@#1(#2,#3){\@ifnextchar[{\PutStr@@{#1}(#2,#3)}{%
  \PutStr@@{#1}(#2,#3)[l]}}
\def\PutStr@@#1(#2,#3)[#4]#5to{\@ifnextchar[{\PutStr@@@{#1}(#2,#3)[#4]#5to}{%
  \PutStr@@@{#1}(#2,#3)[#4]#5to[0]}}
\def\PutStr@@@#1(#2,#3)[#4]#5to[#6]#7{%
  \emathPut{#1}(#2,#3)[#4]{#5}%
  \edef\PutStr@s{#1}\@@@PutStr[#6]{#7}}%
%\def\PutStr@@@#1(#2,#3)[#4]#5to[#6]#7{%
%  \emathPut{#1}(#2,#3)[#4]{#5}%
%  \if 0#6\relax\ArrowLine{#1}{#7}\else\ArrowArc{#6}{#1}{#7}\fi}
\def\@@@PutStr[#1]#2{{%
  \ifnum\EMps@mode=\@ne\gsave\fi
  \def\PutStr@r{0}%
  \def\PutStr@v{(0,0)}%
  \define@key{emP}{hankei}{\def\PutStr@r{##1}}%
  \define@key{emP}{Hankei}{\ukansan{##1}\PutStr@r}%
  \define@key{emP}{addvec}{\edef\addvec@arg{##1}%
    \headchar{\addvec@arg}\addvec@a\addvec@b
    \ifthenelse{\equal\addvec@a{r}}{%
      \vecXY{\addvec@b}\addvec@r\addvec@arg
      \ukansan\addvec@r\addvec@r
      \DegCos\addvec@arg\addvec@x\Mul\addvec@r\addvec@x\addvec@x
      \DegSin\addvec@arg\addvec@y\Mul\addvec@r\addvec@y\addvec@y
      \@ifundefined{@xscale}{}{%
        \Div\addvec@x\@xscale\addvec@x
        \Div\addvec@y\@yscale\addvec@y
      }%
    }{%
      \vecXY{\addvec@arg}\addvec@x\addvec@y
      \uxkansan\addvec@x\addvec@x
      \uykansan\addvec@y\addvec@y
    }%
    \edef\PutStr@v{(\addvec@x,\addvec@y)}%
  }%
  \def\arrow@headsize{1}%
  \Strchr{#1}{=}\PutStr@tmp
  \ifnum\PutStr@tmp>\z@\setkeys{emP}{#1}\else\def\PutStr@r{#1}\fi
  \changeArrowHeadSize{\arrow@headsize}%
  \Addvec{#2}\PutStr@v\PutStr@v
  \ifthenelse{\equal\PutStr@r{0}}{%
    \ArrowLine{\PutStr@s}{\PutStr@v}%
  }{%
    \ArrowArc{\PutStr@r}{\PutStr@s}{\PutStr@v}%
  }%
  \ifnum\EMps@mode=\@ne\grestore\fi
}}%
%
% \drawline 縦書きに対応するためのパッチ
\if0
\def\@spdrawline(#1,#2)(#3,#4){%
  \iftdir
   \@absspdrawline(#2\unitlength,-#1\unitlength)(#4\unitlength,-#3\unitlength)\else
   \@absspdrawline(#1\unitlength,#2\unitlength)(#3\unitlength,#4\unitlength)\fi
   \ignorespaces
}
\fi

\@ifundefined{em@dvipdfm}{}{%
\def\@paspecial#1#2{\iftdir\edef\@pasp@y{#1}%
  \ifnum #2>\z@\edef\@pasp@x{-#2}\else\IAbs{#2}\@pasp@x\fi%
  \special{pa \@pasp@x\space\@pasp@y}\else%
  \special{pa #1 #2}\fi}%

\def\line(#1,#2)#3{%
\@xarg #1\relax \@yarg #2\relax\@linelen=#3\unitlength
\iftdir%
  \ifnum #1=\z@\else\ifnum #2=\z@\else
    \@xarg #2\relax \@yarg -#1\relax%
    \@tempdima=#3\unitlength\divide\@tempdima #1\relax%
    \multiply\@tempdima #2\relax%
    \ifdim\@tempdima<\z@\@tempdima=-\@tempdima\fi%
    \@linelen=\@tempdima%
  \fi\fi%
\fi%
\ifnum\@xarg =0\relax \@vline%
  \else \ifnum\@yarg =0\relax\@hline \else \@ssline\fi%
\fi}%
}%
%
% 等間隔に文字を配置
%
\def\emDL@char{\picsquare}%
\def\emDL@gap{3pt}%
\def\emDottedlineGap#1{\def\emDL@gap{#1}}%
%
\define@key{emDL}{G}{\def\emDL@gap{#1}}%
\define@key{emDL}{C}{\def\emDL@char{#1}}%
%
\def\emDottedline{\@ifnextchar<{\@emDottedline}{\@emDottedline<\empty>}}
\def\@emDottedline<#1>#2{{%
  \ifx\empty #1\else\setkeys{emDL}{#1}\fi
  \edef\emDL@tmp{#2}%
  \expandafter\emdottedline\emDL@tmp\relax
}}%
%
\def\emdottedline{\edef\emDL@c{0}\ukansan\emDL@gap\emDL@gap@\@emdottedline}%
\def\emcdottedline{\edef\emDL@c{1}\ukansan\emDL@gap\emDL@gap@\@emdottedline}%
\def\@emdottedline(#1,#2){\@ifnextchar({\@@emdottedline(#1,#2)}{\relax}}%
\def\@@emdottedline(#1,#2)(#3,#4){\@@@emdottedline{(#1,#2)}{(#3,#4)}\@emdottedline(#3,#4)}%
\def\@@@emdottedline#1#2{%0
  \Kyori{#1}{#2}\emDL@l
  \Div\emDL@l\emDL@gap@\emDL@n
  \Int\emDL@n\emDL@n
  \Div\emDL@l\emDL@n\emDL@gap@
  \Div{1}\emDL@n\emDL@d
  \Subvec{#2}{#1}\emDL@v
  \Mulvec\emDL@d\emDL@v\emDL@dv
  \edef\emDL@P{#1}%
%  \Ifor\emDL@i{0}{\emDL@n}\Do{%
%    \Put\emDL@P(0,0)[c]{\emDL@char}\Addvec\emDL@P\emDL@dv\emDL@P
%  }%
  \multido{\i@emDL=0+1}{\emDL@n}{\Put\emDL@P(0,0)[c]{\emDL@char}\Addvec\emDL@P\emDL@dv\emDL@P}%
  \ifdim\emDL@c\p@=\z@\Put{#2}(0,0)[c]{\emDL@char}\fi
  \Addvec\emDL@P\emDL@dv\emDL@P
}%
%
% \Drawline<#1>#2
%   <#1> : <sensyu=\dashline[40]{.1}>などによる線種のローカルな変更
%    #2  : 点列
\def\Drawline{\@ifnextchar<{\@Drawline}{\@Drawline<\empty>}}
%\def\@Drawline<#1>#2{{\edef\Drawline@tmp{#2}%
%  \ifx \empty #1\put(0,0){\expandafter\drawline\Drawline@tmp}\else
%  \setkeys{emP}{#1}\put(0,0){\expandafter\sensyu\Drawline@tmp}\fi}}%
\def\@Drawline<#1>#2{{\edef\Drawline@tmp{#2}%
  \def\yazirusi@opt{\empty}%
  \edef\oval@r{0}%
  \ifx \empty #1\relax
    \put(0,0){\expandafter\drawline\Drawline@tmp}%
  \else
    \setkeys{emP}{#1}%
    \ifthenelse{\equal\iro@\empty}{%
      \ifdim\oval@r\p@=\z@
        \put(0,0){\expandafter\sensyu\Drawline@tmp}%
      \else
        \@ovalDrawline\Drawline@tmp
      \fi
    
    }{%
      \ifdim\oval@r\p@=\z@
        \put(0,0){\@iro{\iro@}\expandafter\sensyu\Drawline@tmp}%
      \else
        \put(0,0){\@iro{\iro@}\@ovalDrawline\Drawline@tmp}%
      \fi
    }%
  \fi}\ignorespaces}%
\let\PhDrawline\Drawline
\def\@ovalDrawline#1{{%
  \edef\ovalD@r{\oval@r}%
  \edef\ovalD@y{\yazirusi@opt}%
  \edef\ovalD@tmp{#1}%
  \expandafter\makeTenHairetu\ovalD@tmp
  \edef\ovalD@A{\hairetu{ovalT@V}{1}}%
  \edef\ovalD@B{\hairetu{ovalT@V}{2}}%
  \edef\ovalD@D{\hairetu{ovalT@V}{3}}%
  \Bunten\ovalD@B\ovalD@D11\ovalD@C
  \ovalcorner\oval@r\ovalD@A\ovalD@B\ovalD@C
  \ifthenelse{\equal\ovalD@y{r}\or\equal\ovalD@y{b}}{%
    \Subvec\ovalD@A\ovalD@B\ovalD@BA
    \Yaziri\ovalD@A\ovalD@BA
  }{}%
  \Cfor{\edef\ovalD@i{2}}{\ovalD@i<\ovalT@N}{}\do{%
    \Incr\ovalD@i
    \edef\ovalD@A{\ovalD@C}%
    \edef\ovalD@B{\ovalD@D}%
    \ifthenelse{\ovalD@i=\ovalT@N}{%
      \Sensyu{\ovalD@A\ovalD@B}%
      \ifthenelse{\equal\ovalD@y{a}\or\equal\ovalD@y{b}}{%
        \Subvec\ovalD@B\ovalD@A\ovalD@AB
        \Yaziri\ovalD@B\ovalD@AB
      }{%
      }%
    }{%
      \IAdd\ovalD@i{1}\ovalD@j
      \edef\ovalD@D{\hairetu{ovalT@V}{\ovalD@j}}%
      \Bunten\ovalD@B\ovalD@D11\ovalD@C
      \ovalcorner\ovalD@r\ovalD@A\ovalD@B\ovalD@C
    }%
  }%
}}
%
%\let\Takakkei\Drawline
%\def\Takakkei{\@ifnextchar<{\@Takakkei}{\@Takakkei<\empty>}}%
%\def\@Takakkei<#1>#2{\strsep{#2}{;}\Takakkei@a\Takakkei@b
%  \Drawline<#1>{#2\Takakkei@a}}%
\def\Takakkei{\@ifnextchar<{\@Takakkei}{\@Takakkei<\empty>}}%
\def\@Takakkei<#1>#2{{%
  \def\yazirusi@opt{\empty}%
  \edef\oval@r{0}%
  \ifx \empty #1\relax
    \@@Takakkei<#1>{#2}%
  \else
    \setkeys{emP}{#1}%
    \ifdim\oval@r\p@=\z@
      \@@Takakkei<#1>{#2}%
    \else
      \@ovalPolygon{#2}%
    \fi
  \fi}}%
\def\@@Takakkei<#1>#2{\strsep{#2}{;}\Takakkei@a\Takakkei@b
  \Drawline<#1>{#2\Takakkei@a}}%
%
\def\@ovalPolygon#1{{%
  \edef\ovalD@r{\oval@r}%
% \edef\ovalD@y{\yazirusi@opt}%
  \edef\ovalD@tmp{#1}%
  \expandafter\makeTenHairetu\ovalD@tmp
  \edef\ovalD@A{\hairetu{ovalT@V}{1}}%
  \edef\ovalD@B{\hairetu{ovalT@V}{2}}%
  \edef\ovalD@D{\hairetu{ovalT@V}{3}}%
  \Bunten\ovalD@A\ovalD@B11\ovalD@S
  \Bunten\ovalD@B\ovalD@D11\ovalD@C
  \ovalcorner\oval@r\ovalD@S\ovalD@B\ovalD@C
  \edef\ovalD@O{\ovalD@A}%
  \Cfor{\edef\ovalD@i{2}}{\ovalD@i<\ovalT@N}{}\do{%
    \Incr\ovalD@i
    \edef\ovalD@A{\ovalD@C}%
    \edef\ovalD@B{\ovalD@D}%
    \ifthenelse{\ovalD@i=\ovalT@N}{%
        \Bunten\ovalD@B\ovalD@O11\ovalD@D
        \ovalcorner\ovalD@r\ovalD@A\ovalD@B\ovalD@D
        \ovalcorner\ovalD@r\ovalD@D\ovalD@O\ovalD@S
    }{%
      \IAdd\ovalD@i{1}\ovalD@j
      \edef\ovalD@D{\hairetu{ovalT@V}{\ovalD@j}}%
      \Bunten\ovalD@B\ovalD@D11\ovalD@C
      \ovalcorner\ovalD@r\ovalD@A\ovalD@B\ovalD@C
    }%
  }%
}}
%
%\def\Drawline#1{\edef\@tmp{#1}\put(0,0){\expandafter\drawline\@tmp}}%
%\def\Drawline#1{\edef\@tmp{#1}\expandafter\path\@tmp}%
%
\def\clipDrawline#1{{%
  \ifthenelse{\equal\iro@\empty}{}{\@iro{\iro@}}%
  \edef\DL@endP{\empty}\expandafter\@clipDrawline#1}\ignorespaces}%
\def\@clipDrawline{\@ifnextchar({\@@clipDrawline}{\relax}}
\def\@@clipDrawline(#1,#2){%
  \ifthenelse{\lengthtest{#1 pt>\truexmax pt}%
    \or\lengthtest{#1 pt<\truexmin pt}%
    \or\lengthtest{#2 pt>\trueymax pt}%
    \or\lengthtest{#2 pt<\trueymin pt}}{\edef\DL@endP{\empty}}{%
    \ifthenelse{\equal\DL@endP\empty}{}{%
      \put(0,0){\expandafter\drawline\DL@endP(#1,#2)}}%
    \edef\DL@endP{(#1,#2)}}\@clipDrawline}

\def\yclipDrawline#1{{%
  \ifthenelse{\equal\iro@\empty}{}{\@iro{\iro@}}%
  \edef\DL@endP{\empty}\expandafter\@yclipDrawline#1}\ignorespaces}%
\def\@yclipDrawline{\@ifnextchar({\@@yclipDrawline}{\relax}}
\def\@@yclipDrawline(#1,#2){%
  \ifthenelse{\equal\DL@endP\empty}%
  {%
    \ifthenelse{\lengthtest{#2 pt>\trueymax pt}\or\lengthtest{#2 pt<\trueymin pt}}%
    {\han@inaifalse}%
    {\han@inaitrue}%
  }%
  {%
    \ifdim #2 pt>\trueymax pt\relax
      \ifhan@inai
        %\hokan
          \vecXY\DL@endP\clDL@x\clDL@y
          \Sub\trueymax{#2}\clDL@tmp
          \Sub\clDL@y{#2}\clDL@tmpp
          \Div\clDL@tmp\clDL@tmpp\clDL@tmp
          \Sub{#1}\clDL@x\clDL@tmpp
          \Mul\clDL@tmp\clDL@tmpp\clDL@tmp
          \Sub{#1}\clDL@tmp\clDL@xx
          \put(0,0){\drawline(\clDL@x,\clDL@y)(\clDL@xx,\trueymax)}%
        \han@inaifalse
      \fi
    \else\ifdim #2 pt<\trueymin pt\relax
      \ifhan@inai
        %\hokan
          \vecXY\DL@endP\clDL@x\clDL@y
          \Sub\trueymin{#2}\clDL@tmp
          \Sub\clDL@y{#2}\clDL@tmpp
          \Div\clDL@tmp\clDL@tmpp\clDL@tmp
          \Sub{#1}\clDL@x\clDL@tmpp
          \Mul\clDL@tmp\clDL@tmpp\clDL@tmp
          \Sub{#1}\clDL@tmp\clDL@xx
          \put(0,0){\drawline(\clDL@x,\clDL@y)(\clDL@xx,\trueymin)}%
        \han@inaifalse
      \fi
    \else
      \ifhan@inai
        \put(0,0){\expandafter\drawline\DL@endP(#1,#2)}%
      \else
        %\hokan
          \vecXY\DL@endP\clDL@x\clDL@y
          \ifdim\clDL@y pt>\trueymax pt
            \Sub\trueymax{#2}\clDL@tmp
            \Sub\clDL@y{#2}\clDL@tmpp
            \Div\clDL@tmp\clDL@tmpp\clDL@tmp
            \Sub{#1}\clDL@x\clDL@tmpp
            \Mul\clDL@tmp\clDL@tmpp\clDL@tmp
            \Sub{#1}\clDL@tmp\clDL@xx
            \put(0,0){\drawline(#1,#2)(\clDL@xx,\trueymax)}%
          \else
            \Sub\trueymin{#2}\clDL@tmp
            \Sub\clDL@y{#2}\clDL@tmpp
            \Div\clDL@tmp\clDL@tmpp\clDL@tmp
            \Sub{#1}\clDL@x\clDL@tmpp
            \Mul\clDL@tmp\clDL@tmpp\clDL@tmp
            \Sub{#1}\clDL@tmp\clDL@xx
            \put(0,0){\drawline(#1,#2)(\clDL@xx,\trueymin)}%
          \fi
        \han@inaitrue
      \fi
    \fi\fi
  }%
  \edef\DL@endP{(#1,#2)}\@yclipDrawline}
%
\def\xclipDrawline#1{\edef\DL@endP{\empty}\expandafter\@xclipDrawline#1}%
\def\@xclipDrawline{\@ifnextchar({\@@xclipDrawline}{\relax}}
\def\@@xclipDrawline(#1,#2){%
  \ifthenelse{\equal\DL@endP\empty}%
  {%
    \ifthenelse{\lengthtest{#1 pt>\truexmax pt}\or\lengthtest{#1 pt<\truexmin pt}}%
    {\han@inaifalse}%
    {\han@inaitrue}%
  }%
  {%
    \ifdim #1 pt>\truexmax pt\relax
      \ifhan@inai
        %\hokan
          \vecXY\DL@endP\clDL@x\clDL@y
          \Sub\truexmax{#1}\clDL@tmp
          \Sub\clDL@x{#1}\clDL@tmpp
          \Div\clDL@tmp\clDL@tmpp\clDL@tmp
          \Sub{#2}\clDL@y\clDL@tmpp
          \Mul\clDL@tmp\clDL@tmpp\clDL@tmp
          \Sub{#2}\clDL@tmp\clDL@xx
          \put(0,0){\drawline(\clDL@x,\clDL@y)(\truexmax,\clDL@xx)}%
        \han@inaifalse
      \fi
    \else\ifdim #1 pt<\truexmin pt\relax
      \ifhan@inai
        %\hokan
          \vecXY\DL@endP\clDL@x\clDL@y
          \Sub\truexmin{#1}\clDL@tmp
          \Sub\clDL@x{#1}\clDL@tmpp
          \Div\clDL@tmp\clDL@tmpp\clDL@tmp
          \Sub{#2}\clDL@y\clDL@tmpp
          \Mul\clDL@tmp\clDL@tmpp\clDL@tmp
          \Sub{#2}\clDL@tmp\clDL@xx
          \put(0,0){\drawline(\clDL@x,\clDL@y)(\truexmin,\clDL@xx)}%
        \han@inaifalse
      \fi
    \else
      \ifhan@inai
        \put(0,0){\expandafter\drawline\DL@endP(#1,#2)}%
      \else
        %\hokan
          \vecXY\DL@endP\clDL@x\clDL@y
          \ifdim\clDL@x pt>\truexmax pt
            \Sub\truexmax{#1}\clDL@tmp
            \Sub\clDL@x{#1}\clDL@tmpp
            \Div\clDL@tmp\clDL@tmpp\clDL@tmp
            \Sub{#2}\clDL@y\clDL@tmpp
            \Mul\clDL@tmp\clDL@tmpp\clDL@tmp
            \Sub{#2}\clDL@tmp\clDL@xx
            \put(0,0){\drawline(#1,#2)(\truexmax,\clDL@xx)}%
          \else
            \Sub\truexmin{#1}\clDL@tmp
            \Sub\clDL@x{#1}\clDL@tmpp
            \Div\clDL@tmp\clDL@tmpp\clDL@tmp
            \Sub{#2}\clDL@y\clDL@tmpp
            \Mul\clDL@tmp\clDL@tmpp\clDL@tmp
            \Sub{#2}\clDL@tmp\clDL@xx
            \put(0,0){\drawline(#1,#2)(\truexmin,\clDL@xx)}%
          \fi
        \han@inaitrue
      \fi
    \fi\fi
  }%
  \edef\DL@endP{(#1,#2)}\@xclipDrawline}
%
% コーナーを丸く切り取った多角形
%
\define@key{emP}{oval}{\edef\oval@r{#1}}%
\define@key{emP}{Oval}{\ukansan{#1}\oval@r}%
%
%
\def\ovalcorner{\@ifnextchar[{\@ovalcorner}{\@ovalcorner[\empty]}}
\def\@ovalcorner[#1]#2#3#4#5{%
  \def\yazirusi@opt{\empty}%
  \ifx\empty#1\else\setkeys{emP}{#1}\fi
  \sankakkei{#3}{#4}{#5}%
  \Yogen[a]\lb\lc\la\kaku@B
  \Div\kaku@B{2}\kaku@Bii
  \Subvec{#3}{#4}\BA@\Absvec\BA@\l@BA
  \Subvec{#5}{#4}\CA@\Absvec\CA@\l@CA
  \DegTan\kaku@Bii\oc@tmp
  \Div{#2}\oc@tmp\l@val
  \Div\l@val\l@BA\oc@tmp
  \Mulvec\oc@tmp\BA@\BH@\Addvec\BH@{#4}\oc@H
  \Div\l@val\l@CA\oc@tmp
  \Mulvec\oc@tmp\CA@\CK@\Addvec\CK@{#4}\oc@K
  \Nitoubunsen{#3}{#4}{#5}\oc@D
  \Subvec\oc@D{#4}\BD@\Absvec\BD@\l@BD
  \DegSin\kaku@Bii\oc@tmp
  \Div{#2}\oc@tmp\l@val
  \Div\l@val\l@BD\oc@tmp
  \Mulvec\oc@tmp\BD@\BP@\Addvec\BP@{#4}\oc@P
  \ifthenelse{\equal\orienttriangle{-}}{%
    \Enko\oc@P{#2}{hazimeten=\oc@K}{owariten=\oc@H}%
  }{%
    \Enko\oc@P{#2}{hazimeten=\oc@H}{owariten=\oc@K}%
  }%
% \Drawlines{{#3}\oc@H;{#5}\oc@K}%
  \ifthenelse{\equal\yazirusi@opt{a}}{%
    \Drawlines{{#3}\oc@H}\ArrowLine\oc@K{#5}%
  }{\ifthenelse{\equal\yazirusi@opt{r}}{%
     \Drawlines{{#5}\oc@K}\ArrowLine\oc@H{#3}%
    }{\Drawlines{{#3}\oc@H;{#5}\oc@K}%
    }%
  }%
}%
%
\def\makeTenHairetu{\edef\ovalT@N{0}\@makeTenHairetu}
\def\@makeTenHairetu{\@ifnextchar({\@@makeTenHairetu}{\relax}}
\def\@@makeTenHairetu(#1,#2){%
  \Incr\ovalT@N\edefhairetu{ovalT@V}\ovalT@N{(#1,#2)}%
  \@makeTenHairetu
}
\def\EMovalTakakkei{%
  \ifnum\EMps@mode=\@ne\gsave\fi
  \@ifnextchar<{\EMovalTakakkei@}{\@EMovalTakakkei}}
\def\EMovalTakakkei@<#1>{\setkeys{emP}{#1}\@EMovalTakakkei}
\def\@EMovalTakakkei#1#2{%
  \ukansan{#1}\ovalT@l
  \edef\ovalT@tmp{#2}%
  \expandafter\makeTenHairetu\ovalT@tmp
  \Ifor\ovalT@i{0}\ovalT@N\Do{%
    \edef\ovalT@p{\ovalT@i}\ifnum\ovalT@p=\z@\edef\ovalT@p{\ovalT@N}\fi
      \edef\ovalT@P{\hairetu{ovalT@V}\ovalT@p}%
    \IAdd\ovalT@i{1}\ovalT@q
      \edef\ovalT@Q{\hairetu{ovalT@V}\ovalT@q}%
    \IAdd\ovalT@i{2}\ovalT@r\ifnum\ovalT@r>\ovalT@N\edef\ovalT@r{1}\fi
      \edef\ovalT@R{\hairetu{ovalT@V}\ovalT@r}%
    \Subvec\ovalT@P\ovalT@Q\ovalT@QP\Argvec\ovalT@QP\ovalT@argi
    \Subvec\ovalT@R\ovalT@Q\ovalT@QR\Argvec\ovalT@QR\ovalT@argii
    \Sub\ovalT@argii\ovalT@argi\ovalT@arg
    \Div\ovalT@arg{2}\ovalT@arg
    \DegCos{\ovalT@arg}\ovalT@tmp
    \Div\ovalT@l\ovalT@tmp\ovalT@CQ
    \Rotvec[\ovalT@CQ]\ovalT@QP\ovalT@arg\ovalT@tmp
      \Addvec\ovalT@Q\ovalT@tmp\ovalT@C
    \Suisen\ovalT@C\ovalT@P\ovalT@Q\ovalT@H\Kyori\ovalT@C\ovalT@H\ovalT@r
    \ifnum\ovalT@i>\z@\Drawline{\ovalT@K\ovalT@H}\fi
    \Suisen\ovalT@C\ovalT@R\ovalT@Q\ovalT@K
    \ifnum\ovalT@i=\z@\edef\ovalT@orgH{\ovalT@H}\fi
    \Enko\ovalT@C\ovalT@r{hazimeten=\ovalT@H}{owariten=\ovalT@K}
  }
  \Drawline{\ovalT@K\ovalT@orgH}%
% \Takakkei{#2}%
  \ifnum\EMps@mode=\@ne\grestore\fi
}
\let\ovalTakakkei\EMovalTakakkei
%
\def\hamidasisenbun#1#2#3#4{%
% #1 : 端点1
% #2 : 端点2
% #3 : 端点1に対するはみ出し係数
% #4 : 端点2に対するはみ出し係数
  \Subvec{#2}{#1}\hmds@v
  \Mulvec{#3}\hmds@v\hmds@a
  \Mulvec{#4}\hmds@v\hmds@b
  \Put{#1}{\Drawline{\hmds@a\hmds@b}}}

\def\Sensyu#1{\edef\@tmp{#1}\put(0,0){\expandafter\sensyu\@tmp}}

% \Drawlines<#1>#2
%   <#1> : <sensyu=\dashline[40]{.1}>などによる線種のローカルな変更
%    #2  : 複数の点列を`;'で区切る
\def\Drawlines{\@ifnextchar<{\@Drawlines}{\@Drawlines<\empty>}}
\def\@Drawlines<#1>#2{{\ifx \empty #1\else\setkeys{emP}{#1}\fi
  \Cfor{\edef\Drawlines@a{#2}}{\not\equal\Drawlines@a\empty}{%
    \edef\Drawlines@a{\Drawlines@b}}\do{%
    \strsep\Drawlines@a{;}\Drawlines@a\Drawlines@b\Sensyu\Drawlines@a}}}

%\def\Drawlines#1{%
%  \Cfor{\edef\Drawlines@a{#1}}{\not\equal\Drawlines@a\empty}{%
%    \edef\Drawlines@a{\Drawlines@b}}\do{%
%    \strsep\Drawlines@a{;}\Drawlines@a\Drawlines@b\Sensyu\Drawlines@a}}

% lineto, moveto
% rlineto, rmoveto
\edef\emCurP{(0,0)}
\def\emlineto{\@ifnextchar[{\@emlineto}{\@emlineto[\empty]}}
\def\@emlineto[#1](#2,#3){%
  \ifthenelse{\equal{#1}\empty}{\Sensyu{\emCurP(#2,#3)}\edef\emCurP{(#2,#3)}}{%
  \Rdef(#2,#3)\emCurPP\Sensyu{\emCurP\emCurPP}\edef\emCurP{\emCurPP}}}
\def\emrlineto{\@ifnextchar[{\@emrlineto}{\@emrlineto[\empty]}}
\def\@emrlineto[#1](#2,#3){%
  \ifthenelse{\equal{#1}\empty}{\Addvec{(#2,#3)}\emCurP\em@TmpP}{%
    \Rdef[\emCurP](#2,#3)\em@TmpP}
    \Sensyu{\emCurP\em@TmpP}\edef\emCurP{\em@TmpP}}
\def\emmoveto{\@ifnextchar[{\@emmoveto}{\@emmoveto[\empty]}}
\def\@emmoveto[#1](#2,#3){\ifthenelse{\equal{#1}\empty}{%
  \edef\emCurP{(#2,#3)}}{\Rdef(#2,#3)\emCurP}}
\def\emrmoveto{\@ifnextchar[{\@emrmoveto}{\@emrmoveto[\empty]}}
\def\@emrmoveto[#1](#2,#3){\ifthenelse{\equal{#1}\empty}{%
  \Addvec{(#2,#3)}\emCurP\emCurP}{\Rdef[\emCurP](#2,#3)\emCurP}}

% 点線
\def\Dottedline#1#2{\edef\@hikisu{{#1}#2}\put(0,0){\expandafter\dottedline\@hikisu}}%

% 破線
\def\Dashline{\@ifnextchar [{\@Dashline}{\@Dashline[\dashlinestretch]}}
\def\@Dashline[#1]#2#3{%
  \edef\@tmp{[#1]{#2}#3}\put(0,0){\expandafter\dashline\@tmp}}%

% 破線描画
\define@key{emP@hasen}{L}{\def\hasen@L{#1}}%
\define@key{emP@hasen}{G}{\def\hasen@G{#1}}%
\def\@hasen@L{1mm}
\def\@hasen@G{.9mm}
\def\hasenL#1{\def\@hasen@L{#1}}
\def\hasenG#1{\def\@hasen@G{#1}}
\def\hasenLG#1#2{\def\@hasen@L{#1}\def\@hasen@G{#2}}
\def\hasen{\@ifstar{\ohasen}{\chasen}}
\def\chasen{\edef\hasen@L{\@hasen@L}\edef\hasen@G{\@hasen@G}%
  \@ifnextchar[{\hasen@}{\@hasen}}
\def\hasen@[#1]{\setkeys{emP@hasen}{#1}\@hasen}
\def\@hasen(#1,#2){\@ifnextchar({\@@hasen(#1,#2)}{\relax}}
\def\@@hasen(#1,#2)(#3,#4){%
\Kyori{(#1,#2)}{(#3,#4)}\d@@hasen
\@tempdima=\d@@hasen\unitlength
\ifdim\@tempdima>\p@
  \edef\hasen@S{(#1,#2)}\edef\hasen@E{(#3,#4)}%
  \templa=\hasen@L\Div{\strip@pt\templa}{\strip@pt\unitlength}\hasen@@L
  \templa=\hasen@G\Div{\strip@pt\templa}{\strip@pt\unitlength}\hasen@@G
  \Add\hasen@@L\hasen@@G\hasen@@LG
  \Subvec\hasen@E\hasen@S\hasen@v
  \Unitvec\hasen@v\hasen@u
  \Absvec\hasen@v\hasen@LL
  \Div\hasen@LL\hasen@@LG\hasen@tmp
  \Seisuububun\hasen@tmp\hasen@n
  \Sub\hasen@LL\hasen@@L\hasen@tmp
  \ifnum\hasen@n>\z@
    \Div\hasen@tmp\hasen@n\hasen@tmp
    \Sub\hasen@tmp\hasen@@L\hasen@@G
    \Add\hasen@@L\hasen@@G\hasen@@LG\fi
%
   \Mul{\hasen@n}\hasen@@LG\hasen@@LGn
   \Bunten\hasen@S\hasen@E\hasen@@LGn\hasen@@L\hasen@F
%  \Cfor{\edef\hasen@i{0}}{\hasen@i<\hasen@n}{\Incr\hasen@i}\do{%
   \Cfor{\edef\hasen@i{0}}{\hasen@i<\hasen@n}{}\do{%
%    \Mul\hasen@i\hasen@@LG\hasen@tmp
%    \Mulvec\hasen@tmp\hasen@u\hasen@tmp
%    \Addvec\hasen@S\hasen@tmp\hasen@SS
%    \Mulvec\hasen@@L\hasen@u\hasen@tmp
%    \Addvec\hasen@SS\hasen@tmp\hasen@EE
    \ISub\hasen@n\hasen@i\hasen@j
    \Bunten\hasen@S\hasen@F\hasen@i\hasen@j\hasen@SS
    \Incr\hasen@i
    \ISub\hasen@n\hasen@i\hasen@j
    \Bunten\hasen@S\hasen@F\hasen@i\hasen@j\hasen@SE
    \Bunten\hasen@SS\hasen@SE\hasen@@L\hasen@@G\hasen@EE
    \Drawline{\hasen@SS\hasen@EE}%
  }%
  \Drawline{\hasen@F\hasen@E}%
%  \Mul\hasen@i\hasen@@LG\hasen@tmp
%  \Mulvec\hasen@tmp\hasen@u\hasen@tmp
%  \Addvec\hasen@S\hasen@tmp\hasen@SS
%  \Drawline{\hasen@SS\hasen@E}%
\fi
  \@hasen(#3,#4)%
}

\def\ohasen{\edef\hasen@L{\@hasen@L}\edef\hasen@G{\@hasen@G}%
  \@ifnextchar[{\ohasen@}{\@ohasen}}
\def\ohasen@[#1]{\setkeys{emP@hasen}{#1}\@ohasen}
\def\@ohasen(#1,#2){\@ifnextchar({\@@ohasen(#1,#2)}{\relax}}
\def\@@ohasen(#1,#2)(#3,#4){%
\Kyori{(#1,#2)}{(#3,#4)}\d@@hasen
\ifdim\d@@hasen pt>0.005pt\relax
  \edef\hasen@S{(#1,#2)}\edef\hasen@E{(#3,#4)}%
  \templa=\hasen@L\Div{\strip@pt\templa}{\strip@pt\unitlength}\hasen@@L
  \templa=\hasen@G\Div{\strip@pt\templa}{\strip@pt\unitlength}\hasen@@G
  \Add\hasen@@L\hasen@@G\hasen@@LG
  \Subvec\hasen@E\hasen@S\hasen@v
  \Unitvec\hasen@v\hasen@u
  \Absvec\hasen@v\hasen@LL
  \Div\hasen@LL\hasen@@LG\hasen@tmp
  \Seisuububun\hasen@tmp\hasen@n
  \Sub\hasen@LL\hasen@@G\hasen@tmp
  \ifnum\hasen@n>\z@
    \Div\hasen@tmp\hasen@n\hasen@tmp
    \Sub\hasen@tmp\hasen@@L\hasen@@G
    \Add\hasen@@L\hasen@@G\hasen@@LG\fi
  \Cfor{\edef\hasen@i{0}}{\hasen@i<\hasen@n}{}\do{%
    \Incr\hasen@i
    \Mul\hasen@i\hasen@@LG\hasen@tmp
    \Mulvec\hasen@tmp\hasen@u\hasen@tmp
    \Addvec\hasen@S\hasen@tmp\hasen@EE
    \Mulvec{-\hasen@@L}\hasen@u\hasen@tmp
    \Addvec\hasen@EE\hasen@tmp\hasen@SS
    \Drawline{\hasen@SS\hasen@EE}%
  }%
%  \Mul\hasen@i\hasen@@LG\hasen@tmp
%  \Mulvec\hasen@tmp\hasen@u\hasen@tmp
%  \Addvec\hasen@S\hasen@tmp\hasen@SS
%  \Drawline{\hasen@SS\hasen@E}%
\fi
  \@ohasen(#3,#4)%
}
%
%
\def\Hasen{\@ifstar{\oHasen}{\cHasen}}
\def\cHasen{\edef\hasen@L{\@hasen@L}\edef\hasen@G{\@hasen@G}%
  \@ifnextchar[{\Hasen@}{\@Hasen}}
\def\Hasen@[#1]#2{\setkeys{emP@hasen}{#1}\@Hasen{#2}}
\def\@Hasen#1{\edef\Hasen@tmp{#1}\put(0,0){\expandafter\@hasen\Hasen@tmp}}

\def\oHasen{\edef\hasen@L{\@hasen@L}\edef\hasen@G{\@hasen@G}%
  \@ifnextchar[{\oHasen@}{\@oHasen}}
\def\oHasen@[#1]#2{\setkeys{emP@hasen}{#1}\@oHasen{#2}}
\def\@oHasen#1{\edef\Hasen@tmp{#1}\put(0,0){\expandafter\@ohasen\Hasen@tmp}}
%
\def\Hasens#1{{%
  \Cfor{\edef\Hasens@a{#1}}{\not\equal\Hasens@a\empty}{%
    \edef\Hasens@a{\Hasens@b}}\do{%
    \strsep\Hasens@a{;}\Hasens@a\Hasens@b\Hasen\Hasens@a}}}
%
% 縦罫線（破線）
% \vHasen[高さ]{深さ}
%
\def\vHasen{\@ifnextchar[{\@vHasen}{\setbox0=\hbox{(}\@vHasen[\ht0]}}
\def\@vHasen[#1]#2{{\unitlength=10mm\relax
  \@tempdima=#1\relax \Div{\strip@pt\@tempdima}{\strip@pt\unitlength}\vHasen@h
  \@tempdima=#2\relax \Div{\strip@pt\@tempdima}{\strip@pt\unitlength}\vHasen@d
  \begin{picture}(0,0)\Hasen{(0,\vHasen@h)(0,-\vHasen@d)}\end{picture}}}

% 鎖線
\def\Chainline{\@ifnextchar[{\@Chainline}{\@Chainline[.1]}}
\def\@Chainline[#1]{\@ifnextchar[{\@@Chainline[#1]}{%
  \@@Chainline[#1][.04]}}
\def\@@Chainline[#1][#2]#3#4{%
  \Subvec{#4}{#3}\CL@e
  \Kyori{#3}{#4}\CL@l
  \Div{1}{\CL@l}\CL@tmp
  \Mulvec\CL@tmp\CL@e\CL@e% 単位ベクトル
  \Cfor{\edef\CL@t{0}\edef\CL@a{#3}}{%
    \lengthtest{\CL@t pt<\CL@l pt}}{}\do{
      \Add\CL@t{#1}\CL@t
      \ifdim\CL@t pt>\CL@l pt\relax\edef\CL@t{\CL@l}\fi
      \Mulvec\CL@t\CL@e\CL@b
      \Addvec{#3}\CL@b\CL@b
      \Drawline{\CL@a\CL@b}%
      \Add\CL@t{#2}\CL@t
      \ifdim\CL@t pt>\CL@l pt\relax\else
        \Mulvec\CL@t\CL@e\CL@a
        \Addvec{#3}\CL@a\CL@a
        \Kuromaru[.15pt]\CL@a%
      \fi
      \Add\CL@t{#2}\CL@t
      \Mulvec\CL@t\CL@e\CL@a
      \Addvec{#3}\CL@a\CL@a
    }%
}

\def\chainline{\@ifnextchar[{\chainline@}{\chainline@[.1]}}
\def\chainline@[#1]{\@ifnextchar[{\chainline@@[#1]}{%
  \chainline@@[#1][.04]}}
\def\chainline@@[#1][#2]{\edef\chainline@len{#1}\edef\chainline@gap{#2}%
  \@ifnextchar({\@chainline}{\relax}}
\def\@chainline(#1,#2){\edef\chain@P{(#1,#2)}\@@chainline}
\def\@@chainline{\@ifnextchar({\@@@chainline}{\relax}}
\def\@@@chainline(#1,#2){%
  \Chainline[\chainline@len][\chainline@gap]\chain@P{(#1,#2)}%
  \edef\chain@P{(#1,#2)}\@@chainline}

% 格子（碁盤状の街路図）
%   \kousi<#1>(#2,#3)#4#5
%       #1 : key=val
%             nuri=...
%                  塗りを行うセルの左下の座標を
%                  \Nuritubusiへのオプションとともに ; 区切りで記述
%             put=....
%       #2 : 横方向1区画の長さ（デフォルト=1）
%       #3 : 縦方向1区画の長さ（デフォルト=1）
%       #4 : 横方向のブロック数
%       #5 : 縦方向のブロック数
%       置く位置は \put で指定する．
%
%   \kousiput, \kousiPut
%   \kousiKuromaru, \kousikuromaru
%   \kousiSiromaru, \kousisiromaru
%
\define@key{kousi}{nuri}{\def\kousi@nuri{#1}}%
\define@key{kousi}{put}{\def\kousi@put{#1}}%
\define@key{kousi}{sensyu}{\def\sensyu{#1}}%
%
\edef\kousi@xscale{1}%
\edef\kousi@yscale{1}%
\def\kousi{\@ifnextchar<{\@kousi}{\@kousi<\empty>}}%
\def\@kousi<#1>{\@ifnextchar({\@@kousi<#1>}{\@@kousi<#1>(1,1)}}%
\def\@@kousi<#1>(#2,#3)#4#5{%
  \edef\kousi@xscale{#2}%
  \edef\kousi@yscale{#3}%
  {%
  \def\@kousinuri##1(##2,##3){%
    \Mul{##2}{#2}\kousinuri@x\Add\kousinuri@x{#2}\kousinuri@xx
    \Mul{##3}{#3}\kousinuri@y\Add\kousinuri@y{#3}\kousinuri@yy
    \edef\kousinuri@tmp{%
      ##1{(\kousinuri@x,\kousinuri@y)(\kousinuri@xx,\kousinuri@y)%
      (\kousinuri@xx,\kousinuri@yy)(\kousinuri@x,\kousinuri@yy)}}%
    \expandafter\Nuritubusi\kousinuri@tmp
  }%
  \def\@@kousiput##1{%
    \@ifnextchar[{\@@@kousiput{##1}}{%
      \@ifnextchar({\@@@@kousiput{##1}}{%
        \@@@@@kousiput{##1}}}}%
  \def\@@@kousiput##1[##2]##3\@nil{%
    \Put{##1}[##2]{##3}}%
  \def\@@@@kousiput##1(##2,##3)[##4]##5\@nil{%
    \Put{##1}(##2,##3)[##4]{##5}}%
  \def\@@@@@kousiput##1##2\@nil{%
    \Put{##1}{##2}}%
  \def\@kousiput(##1,##2)##3\@nil{%
    \Mul{##1}{#2}\kousiput@x
    \Mul{##2}{#3}\kousiput@y
    \def\@kousiput@a{{(\kousiput@x,\kousiput@y)}##3\@nil}%
    \expandafter\@@kousiput\@kousiput@a
  }%
    \Strchr{#1}{=}\kousi@tmp
    \ifnum\kousi@tmp>\z@\setkeys{kousi}{#1}\fi
    \@ifundefined{kousi@nuri}{}{%
      \argsep{\kousi@nuri}{;}{kousinuri@a}\kousinuri@n
      \Cfor{\edef\kousinuri@i{0}}{\kousinuri@i<\kousinuri@n}{}\do{%
        \Incr\kousinuri@i
        \edef\kousinuri@arg{%
          \csname kousinuri@a\romannumeral\kousinuri@i\endcsname}%
        \expandafter\@kousinuri\kousinuri@arg
      }%
    }%
    \@ifundefined{kousi@put}{}{%
      \Cfor{\def\kousiput@a{\kousi@put}}{\not\equal\kousiput@a\empty}{}\do{%
        \expandafter\Strsep\kousiput@a{;}\kousiput@b\kousiput@c
%\typeout{kousiput@b=\kousiput@b,kousiput@c=\kousiput@c}%
        \expandafter\@kousiput\kousiput@b\@nil
        \def\kousiput@a{\kousiput@c}}%
    }%
    \Mul{#4}{#2}\x@len%
    \Mul{#5}{#3}\y@len%
    \Add\x@len{#2}\x@max%
    \Add\y@len{#3}\y@max%
    \For\kousi@@y0\y@max{#3}\Do{%
      \put(0,0){\sensyu(0,\kousi@@y)(\x@len,\kousi@@y)}}%
    \For\kousi@@x0\x@max{#2}\Do{%
      \put(0,0){\sensyu(\kousi@@x,0)(\kousi@@x,\y@len)}}}}%
%
\def\kousiput(#1,#2){%
  \Mul{#1}\kousi@xscale\kousiput@x
  \Mul{#2}\kousi@yscale\kousiput@y
  \emathPut{(\kousiput@x,\kousiput@y)}}%
\def\kousiPut#1{%
  \vecXY{#1}\kousiPut@x\kousiPut@y
  \Mul\kousiPut@x\kousi@xscale\kousiPut@x
  \Mul\kousiPut@y\kousi@yscale\kousiPut@y
  \emathPut{(\kousiPut@x,\kousiPut@y)}}%
%
\def\kousiKuromaru{\@ifnextchar[{\@kousiKuromaru}{%
  \@kousiKuromaru[\Kuromaru@Hankei]}}
\def\@kousiKuromaru[#1]#2{%
  \vecXY{#2}\kousikuromaru@x\kousikuromaru@y
  \Mul\kousikuromaru@x\kousi@xscale\kousikuromaru@x
  \Mul\kousikuromaru@y\kousi@yscale\kousikuromaru@y
  \Kuromaru[#1]{(\kousikuromaru@x,\kousikuromaru@y)}}%
\def\kousikuromaru{\@ifnextchar[{\@kousikuromaru}{\@kousikuromaru[\Kuromaru@Hankei]}}
\def\@kousikuromaru[#1]#2{%
  \Cfor{\edef\kousikuromaru@a{#2}}{\not\equal{\kousikuromaru@a}{\empty}}{}\do{%
    \strsep{\kousikuromaru@a}{;}\kousikuromaru@a\kousikuromaru@b%
    \kousiKuromaru[#1]\kousikuromaru@a
    \edef\kousikuromaru@a{\kousikuromaru@b}}}
\def\kousiSiromaru{\@ifnextchar[{\@kousiSiromaru}{%
  \@kousiSiromaru[\Kuromaru@Hankei]}}
\def\@kousiSiromaru[#1]#2{%
  \vecXY{#2}\kousisiromaru@x\kousisiromaru@y
  \Mul\kousisiromaru@x\kousi@xscale\kousisiromaru@x
  \Mul\kousisiromaru@y\kousi@yscale\kousisiromaru@y
  \Siromaru[#1]{(\kousisiromaru@x,\kousisiromaru@y)}}%
\def\kousisiromaru{\@ifnextchar[{\@kousisiromaru}{\@kousisiromaru[\Kuromaru@Hankei]}}
\def\@kousisiromaru[#1]#2{%
  \Cfor{\edef\kousisiromaru@a{#2}}{\not\equal{\kousisiromaru@a}{\empty}}{}\do{%
    \strsep{\kousisiromaru@a}{;}\kousisiromaru@a\kousisiromaru@b%
    \kousiSiromaru[#1]\kousisiromaru@a
    \edef\kousisiromaru@a{\kousisiromaru@b}}}
%
% spline 曲線
%
\def\emtpic@command{sp}
\def\emtpic@Bz{2}%  default=1 (Bezier); 0 (spline)

\define@key{emP}{tpicBz}{\def\emtpic@Bz{#1}}%
\define@key{emP}{tpiccom}{\def\emtpic@command{#1}}%

\def\emdrawtpic{\bgroup\@killglue
% \allinethickness{0.3pt}% 2004/01/24 コメントアウト
  \special{pn \the\@gphlinewidth}%
  \ifnum\emtpic@Bz=\tw@\else\special{Bz \emtpic@Bz}\fi
  \@emdrawtpic}
\def\@emdrawtpic{\@ifnextchar({\@@@emdrawtpic}{%
    \special{\emtpic@command}\egroup\ignorespaces}}%
\def\@@@emdrawtpic(#1,#2){%
  \@ifundefined{xunitlength}{%
    \@tempdimc=#1\unitlength}{\@tempdimc=#1\xunitlength}%
  \@tempcnta \@tempdimc\relax \advance\@tempcnta 2368 \divide\@tempcnta 4736
  \@ifundefined{yunitlength}{%
    \@tempdimc=#2\unitlength}{\@tempdimc=#2\xunitlength}%
  \@tempcntb -\@tempdimc\relax \advance\@tempcntb -2368 \divide\@tempcntb 4736
  \@paspecial{\the\@tempcnta}{\the\@tempcntb}%
  \@emdrawtpic}%
%  \@ifundefined{em@dvipdfm}{%
%    \@tempdima#1\unitlength\@tempdima13.837\@tempdima%
%    \@tempdimb#2\unitlength\@tempdimb-13.837\@tempdimb%
%  }{%
%    \iftdir
%      \@tempdima#2\unitlength\@tempdima13.837\@tempdima%
%      \@tempdimb#1\unitlength\@tempdimb13.837\@tempdimb%
%    \else
%      \@tempdima#1\unitlength\@tempdima13.837\@tempdima%
%      \@tempdimb#2\unitlength\@tempdimb-13.837\@tempdimb%
%    \fi
%  }%
%  \special{pa \@seisuu\@tempdima\space\@seisuu\@tempdimb}%
%
\def\emDrawtpic{\@ifnextchar[{\@emDrawtpic}{\@emDrawtpic[\empty]}}
\def\@emDrawtpic[#1]#2{{%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
  \edef\emDrawtpic@tmp{#2}%
  \put(0,0){\expandafter\emdrawtpic\emDrawtpic@tmp}}}
\let\Drawtpic\emDrawtpic
%
% 複数の点の定義とラベルつけ
% \tenretu#1
% \tenretu<#1>#2
%    #1 : key=val
%         perl : 座標成分を perl で計算する。
% \tenretu*#1（定義のみ  ラベル付けはオプション）
% \rtenretu[#1]#2 (極座標形式を前提 #1：極〔デフォルトは原点〕)
% \rtenretu*[#1]#2（定義のみ  ラベル付けはオプション）
%   #2 は点列を `;' で区切った列
%     #2は
%       [##1]##2(##3,##4)##5
%     の形式で点列を `;' で区切る。
%       ##1 : オプションで，点の位置に置く文字列
%             （省略時は，##2 と同じ）
%       ##2 : \##2 という変数の頂点名
%       [r] : をつけると極座標形式とみなす
%       [s] : をつけると相対移動とみなす
%       (##3,##4) : 頂点の座標
%       ##5 : 頂点の近傍に置く文字列の配置オプション
%             [方角] オプションに限り区切子 `[', `]' を省略可能
%  \edef\##2{(##3,##4)}として，点\##2 が定義され，
%  \Put に
%       \Put\##2##5{##1}
%  として引き渡される。）

\let\tenretu@Put\emathPut
\newtoks\tenretu@namae
\newtoks\namae@opt
%
\def\@tenretu@seppara{%
  \@ifnextchar[{\@tenretu@seppara@}{%
  \namae@opt={}\@@tenretu@seppara}}
\def\@tenretu@seppara@[#1]{%
  \namae@opt={[#1]}%
  \@@tenretu@seppara}
\def\@@tenretu@seppara#1(#2,#3\@nil{%
  \tenretu@namae={#1}%
  \edef\tenretu@x{#2}%
  \edef\tenretu@yn{#3}%
  \def\tenretu@y{}%
  \def\tenretu@n{}%
  \def\tenretu@k{1}
  \def\tenretu@kubun{y}%
  \expandafter\@tfor\expandafter\tenretu@c\expandafter:\expandafter=\tenretu@yn
  \do{%
    \if y\tenretu@kubun
      \if(\tenretu@c\Incr\tenretu@k
        \edefappend\tenretu@y{\tenretu@c}%
      \else\if)\tenretu@c\Decr\tenretu@k
        \ifnum\tenretu@k=\z@\edef\tenretu@kubun{n}%
        \else\edefappend\tenretu@y{\tenretu@c}\fi
      \else
        \edefappend\tenretu@y{\tenretu@c}%
      \fi\fi
    \else
      \edefappend\tenretu@n{\tenretu@c}%
    \fi
  }%
  \ifnum\tenretu@k>\z@\errmessage{tenretu : syntax error !}\fi
  \calcval\tenretu@x\tenretu@x
  \calcval\tenretu@y\tenretu@y
}
%
\def\tenretu{\@ifstar{\ntenretu}{\ltenretu}}
\def\ltenretu{\def\by@perl{0}\@ifnextchar<{\ltenretu@opt}{\@ltenretu}}
\def\ltenretu@opt<#1>{\setkeys{emP}{#1}\@ltenretu}
\def\@ltenretu#1{%
% -----------------------------------------------------
% subroutine
\def\@tenretu@sub{\@ifnextchar[{\@@tenretu@sub}{\@@tenretu@sub[\empty]}}%
\def\@@tenretu@sub[##1]##2(##3,##4){%
  \edef\tenretu@kyokuzahyou{0}%
  \edef\tenretu@soutaizahyou{0}%
  \strsep{##2}{[}\tenretu@Vname\tenretu@opt
  \Strchr\tenretu@opt{r}\tenretu@tmp
  \ifnum\tenretu@tmp>\z@\edef\tenretu@kyokuzahyou{1}\fi
  \Strchr\tenretu@opt{s}\tenretu@tmp
  \ifnum\tenretu@tmp>\z@\edef\tenretu@soutaizahyou{1}\fi
  \@ifnextchar({\@@tenretusub@std[##1]\tenretu@Vname(##3,##4)}{%
  \@ifnextchar[{\@@tenretusub@std[##1]\tenretu@Vname(##3,##4)}{%
    \@@tenretusub@brev[##1]\tenretu@Vname(##3,##4)}}}%
\def\@@tenretusub@brev[##1]##2(##3,##4)##5\@nil{%
  \ifthenelse{\equal{##5}{}}{%
  \@@tenretusub@std[##1]##2(##3,##4)\@nil}{%
  \@@tenretusub@std[##1]##2(##3,##4)[##5]\@nil}}%
\def\@@tenretusub@std[##1]##2(##3,##4)##5\@nil{%
  \ifnum\tenretu@kyokuzahyou>\z@\Rdef(##3,##4)\@OresenV\else
  \edef\@OresenV{(##3,##4)}\fi
  \ifnum\tenretu@soutaizahyou>\z@\Addvec\@OresenV@old\@OresenV\@OresenV\fi
  \expandafter\edef\csname ##2\endcsname{\@OresenV}%
  \edef\@tenretu@subtmp{{\csname ##2\endcsname}##5}%
  \ifx\empty##1\edef\tenretu@Vname{##2}\else\def\tenretu@Vname{##1}\fi
  \expandafter\tenretu@Put\@tenretu@subtmp\tenretu@Vname}%
% -----------------------------------------------------
  \Cfor{\def\@OresenVs{#1}}{\not\equal\@OresenVs\empty}{}\do{%
    \Strsep\@OresenVs{;}\@OresenV\@OresenVs
    \ifnum\by@perl=\z@
    \else
      \expandafter\@tenretu@seppara\@OresenV\@nil
      \edef\@OresenV{%
        \the\namae@opt\the\tenretu@namae(\tenretu@x,\tenretu@y)\tenretu@n}%
    \fi
    \expandafter\@tenretu@sub\@OresenV\@nil
    \edef\@OresenV@old{\@OresenV}%
  }%
\ignorespaces
}

\def\ntenretu{\@ifnextchar<{\@ntenretu@opt}{\def\by@perl{0}\@ntenretu}}
\def\@ntenretu@opt<#1>{%
  \def\by@perl{0}%
  \setkeys{emP}{#1}\@ntenretu}
\def\@ntenretu#1{%
% -----------------------------------------------------
% subroutine
\def\@ntenretu@sub{\@ifnextchar[{\@@ntenretu@sub}{\@@ntenretu@sub[\empty]}}%
\def\@@ntenretu@sub[##1]##2(##3,##4){%
  \edef\ntenretu@kyokuzahyou{0}%
  \edef\ntenretu@soutaizahyou{0}%
  \strsep{##2}{[}\ntenretu@Vname\ntenretu@opt
  \Strchr\ntenretu@opt{r}\ntenretu@tmp
  \ifnum\ntenretu@tmp>\z@\edef\ntenretu@kyokuzahyou{1}\fi
  \Strchr\ntenretu@opt{s}\ntenretu@tmp
  \ifnum\ntenretu@tmp>\z@\edef\ntenretu@soutaizahyou{1}\fi
  \@ifnextchar({\@@ntenretusub@std[##1]\ntenretu@Vname(##3,##4)}{%
  \@ifnextchar[{\@@ntenretusub@std[##1]\ntenretu@Vname(##3,##4)}{%
    \@@ntenretusub@brev[##1]\ntenretu@Vname(##3,##4)}}}%
\def\@@ntenretusub@brev[##1]##2(##3,##4)##5\@nil{%
  \ifthenelse{\equal{##5}{}}{%
  \@@ntenretusub@std[##1]##2(##3,##4)\@nil}{%
  \@@ntenretusub@std[##1]##2(##3,##4)[##5]\@nil}}%
\def\@@ntenretusub@std[##1]##2(##3,##4)##5\@nil{%
  \ifnum\ntenretu@kyokuzahyou>\z@\Rdef(##3,##4)\@OresenV\else
  \edef\@OresenV{(##3,##4)}\fi
  \ifnum\ntenretu@soutaizahyou>\z@\Addvec\@OresenV@old\@OresenV\@OresenV\fi
  \expandafter\edef\csname ##2\endcsname{\@OresenV}%
  \edef\@ntenretu@subtmp{{\csname ##2\endcsname}##5}%
  \ifx\empty##1\else\expandafter\tenretu@Put\@ntenretu@subtmp{##1}\fi}%
% -----------------------------------------------------
  \Cfor{\edef\@OresenVs{#1}}{\not\equal\@OresenVs\empty}{}\do{%
    \strsep\@OresenVs{;}\@OresenV\@OresenVs
    \ifnum\by@perl=\z@
    \else
      \expandafter\@tenretu@seppara\@OresenV\@nil
      \edef\@OresenV{%
        \the\namae@opt\the\tenretu@namae(\tenretu@x,\tenretu@y)\tenretu@n}%
    \fi
    \expandafter\@ntenretu@sub\@OresenV\@nil
    \edef\@OresenV@old{\@OresenV}}\ignorespaces}


\def\rtenretu{\@ifstar{\nrtenretu}{\lrtenretu}}

\def\lrtenretu{\def\by@perl{0}\@ifnextchar<{\@lrtenretu@opt}{\@lrtenretu}}
\def\@lrtenretu@opt<#1>{\setkeys{emP}{#1}\@lrtenretu}
\def\@lrtenretu{\@ifnextchar[{\lrtenretu@}{\lrtenretu@[(0,0)]}}
\def\lrtenretu@[#1]{\edef\lrtenretu@O{#1}\@@lrtenretu}
\def\@@lrtenretu#1{%
% -----------------------------------------------------
% subroutine
\def\@rtenretu@sub{\@ifnextchar[{\@@rtenretu@sub}{\@@rtenretu@sub[\empty]}}%
\def\@@rtenretu@sub[##1]##2(##3,##4){%
  \edef\rtenretu@kyokuzahyou{1}%
  \edef\rtenretu@soutaizahyou{0}%
  \strsep{##2}{[}\rtenretu@Vname\rtenretu@opt
%  \Strchr\rtenretu@opt{r}\rtenretu@tmp
%  \ifnum\rtenretu@tmp>\z@\edef\rtenretu@kyokuzahyou{1}\fi
  \Strchr\rtenretu@opt{s}\rtenretu@tmp
  \ifnum\rtenretu@tmp>\z@\edef\rtenretu@soutaizahyou{1}\fi
  \@ifnextchar({\@@rtenretusub@std[##1]\rtenretu@Vname(##3,##4)}{%
  \@ifnextchar[{\@@rtenretusub@std[##1]\rtenretu@Vname(##3,##4)}{%
    \@@rtenretusub@brev[##1]\rtenretu@Vname(##3,##4)}}}%
\def\@@rtenretusub@brev[##1]##2(##3,##4)##5\@nil{%
  \ifthenelse{\equal{##5}{}}{%
  \@@rtenretusub@std[##1]##2(##3,##4)\@nil}{%
  \@@rtenretusub@std[##1]##2(##3,##4)[##5]\@nil}}%
\def\@@rtenretusub@std[##1]##2(##3,##4)##5\@nil{%
  \ifnum\rtenretu@kyokuzahyou>\z@\Rdef(##3,##4)\@OresenV\else
  \edef\@OresenV{(##3,##4)}\fi
  \ifnum\rtenretu@soutaizahyou>\z@\Addvec\@OresenV@old\@OresenV\@OresenV\fi
  \Addvec\lrtenretu@O\@OresenV\@OresenV
  \expandafter\edef\csname ##2\endcsname{\@OresenV}%
  \edef\@rtenretu@subtmp{{\csname ##2\endcsname}##5}%
  \ifx\empty##1\edef\rtenretu@Vname{##2}\else\def\rtenretu@Vname{##1}\fi
  \expandafter\tenretu@Put\@rtenretu@subtmp\rtenretu@Vname}%
% -----------------------------------------------------
  \Cfor{\def\@OresenVs{#1}}{\not\equal\@OresenVs\empty}{}\do{%
    \Strsep\@OresenVs{;}\@OresenV\@OresenVs
    \ifnum\by@perl=\z@
    \else
      \expandafter\@tenretu@seppara\@OresenV\@nil
      \edef\@OresenV{%
        \the\namae@opt\the\tenretu@namae(\tenretu@x,\tenretu@y)\tenretu@n}%
    \fi
    \expandafter\@rtenretu@sub\@OresenV\@nil
    \edef\@OresenV@old{\@OresenV}}\ignorespaces}

\def\nrtenretu{\def\by@perl{0}\@ifnextchar<{\@nrtenretu@opt}{\@nrtenretu}}
\def\@nrtenretu@opt<#1>{\setkeys{emP}{#1}\@nrtenretu}
\def\@nrtenretu{\@ifnextchar[{\nrtenretu@}{\nrtenretu@[(0,0)]}}
\def\nrtenretu@[#1]{\edef\nrtenretu@O{#1}\@@nrtenretu}
\def\@@nrtenretu#1{%
% -----------------------------------------------------
% subroutine
\def\@nrtenretu@sub{\@ifnextchar[{\@@nrtenretu@sub}{\@@nrtenretu@sub[\empty]}}%
\def\@@nrtenretu@sub[##1]##2(##3,##4){%
  \edef\nrtenretu@kyokuzahyou{1}%
  \edef\nrtenretu@soutaizahyou{0}%
  \strsep{##2}{[}\nrtenretu@Vname\nrtenretu@opt
%  \Strchr\nrtenretu@opt{r}\nrtenretu@tmp
%  \ifnum\nrtenretu@tmp>\z@\edef\nrtenretu@kyokuzahyou{1}\fi
  \Strchr\nrtenretu@opt{s}\nrtenretu@tmp
  \ifnum\nrtenretu@tmp>\z@\edef\nrtenretu@soutaizahyou{1}\fi
  \@ifnextchar({\@@nrtenretusub@std[##1]\nrtenretu@Vname(##3,##4)}{%
  \@ifnextchar[{\@@nrtenretusub@std[##1]\nrtenretu@Vname(##3,##4)}{%
    \@@nrtenretusub@brev[##1]\nrtenretu@Vname(##3,##4)}}}%
\def\@@nrtenretusub@brev[##1]##2(##3,##4)##5\@nil{%
  \ifthenelse{\equal{##5}{}}{%
  \@@nrtenretusub@std[##1]##2(##3,##4)\@nil}{%
  \@@nrtenretusub@std[##1]##2(##3,##4)[##5]\@nil}}%
\def\@@nrtenretusub@std[##1]##2(##3,##4)##5\@nil{%
  \ifnum\nrtenretu@kyokuzahyou>\z@\Rdef(##3,##4)\@OresenV\else
  \edef\@OresenV{(##3,##4)}\fi
  \ifnum\nrtenretu@soutaizahyou>\z@\Addvec\@OresenV@old\@OresenV\@OresenV\fi
  \Addvec\nrtenretu@O\@OresenV\@OresenV
  \expandafter\edef\csname ##2\endcsname{\@OresenV}%
  \edef\@nrtenretu@subtmp{{\csname ##2\endcsname}##5}%
  \ifx\empty##1\else\expandafter\emathPut\@nrtenretu@subtmp{##1}\fi}%
% -----------------------------------------------------
  \Cfor{\def\@OresenVs{#1}}{\not\equal\@OresenVs\empty}{}\do{%
    \Strsep\@OresenVs{;}\@OresenV\@OresenVs
    \ifnum\by@perl=\z@
    \else
      \expandafter\@tenretu@seppara\@OresenV\@nil
      \edef\@OresenV{%
        \the\namae@opt\the\tenretu@namae(\tenretu@x,\tenretu@y)\tenretu@n}%
    \fi
    \expandafter\@nrtenretu@sub\@OresenV\@nil
    \edef\@OresenV@old{\@OresenV}}\ignorespaces}

% \oresen<#1>#2
%   <#1> : 線種を変更するときのオプション
%   #2 は折れ線の頂点列を `;' で区切った列
%     #2は
%       [##1]##2(##3,##4)##5
%     の形式で点列を `;' で区切る。
%       ##1 : オプションで，点の位置に置く文字列
%             （省略時は，##2 と同じ）
%       ##2 : \##2 という変数の頂点名
%       [r] : をつけると極座標形式とみなす
%       [s] : をつけると相対移動とみなす
%       (##3,##4) : 頂点の座標
%       ##5 : 頂点の近傍に置く文字列の配置オプション
%             [方角] オプションに限り区切子 `[', `]' を省略可能
%  \edef\##2{(##3,##4)}として，点\##2 が定義され，
%  \Put に
%       \Put\##2##5{##1}
%  として引き渡される。）
%

%\def\@nulline(#1,#2)(#3,#4){\relax}
\def\oresen{\@ifstar{\tenretu}{\@oresen}}
\def\@oresen{\@ifnextchar<{\@@oresen}{\@@oresen<\empty>}}
\def\@@oresen<#1>#2{\let\org@sensyu\sensyu
  \ifx \empty #1\else\setkeys{emP}{#1}\fi
% -----------------------------------------------------
% subroutine
\def\@oresen@sub{\@ifnextchar[{\@@oresen@sub}{\@@oresen@sub[\empty]}}%
\def\@@oresen@sub[##1]##2(##3,##4){%
  \edef\oresen@kyokuzahyou{0}%
  \edef\oresen@soutaizahyou{0}%
  \strsep{##2}{[}\oresen@Vname\oresen@opt
  \Strchr\oresen@opt{r}\oresen@tmp
  \ifnum\oresen@tmp>\z@\edef\oresen@kyokuzahyou{1}\fi
  \Strchr\oresen@opt{s}\oresen@tmp
  \ifnum\oresen@tmp>\z@\edef\oresen@soutaizahyou{1}\fi
  \@ifnextchar({\@@oresensub@std[##1]\oresen@Vname(##3,##4)}{%
  \@ifnextchar[{\@@oresensub@std[##1]\oresen@Vname(##3,##4)}{%
    \@@oresensub@brev[##1]\oresen@Vname(##3,##4)}}}%
\def\@@oresensub@brev[##1]##2(##3,##4)##5\@nil{%
  \ifthenelse{\equal{##5}{}}{%
  \@@oresensub@std[##1]##2(##3,##4)\@nil}{%
  \@@oresensub@std[##1]##2(##3,##4)[##5]\@nil}}%
\def\@@oresensub@std[##1]##2(##3,##4)##5\@nil{%
  \ifnum\oresen@kyokuzahyou>\z@\Rdef(##3,##4)\@OresenV\else
  \edef\@OresenV{(##3,##4)}\fi
  \ifnum\oresen@soutaizahyou>\z@\Addvec\@OresenV@old\@OresenV\@OresenV\fi
  \expandafter\edef\csname ##2\endcsname{\@OresenV}%
  \edef\@oresen@subtmp{{\csname ##2\endcsname}##5}%
  \ifx\empty##1\edef\oresen@Vname{##2}\else\edef\oresen@Vname{##1}\fi
  \expandafter\emathPut\@oresen@subtmp\oresen@Vname}%
% -----------------------------------------------------
\edef\oresen@siten{}%
\Cfor{\edef\@OresenVs{#2}}{\not\equal\@OresenVs\empty}{}\do{%
  \strsep\@OresenVs{;}\@OresenV\@OresenVs
  \expandafter\@oresen@sub\@OresenV\@nil
  \ifthenelse{\equal\oresen@siten\empty}{%
    \edef\oresen@siten{\@OresenV}}{%
    \Sensyu{\@OresenV@old\@OresenV}}%
  \edef\@OresenV@old{\@OresenV}}\let\sensyu\org@sensyu}

% \takakkei<#1>#2
%   <#1> : 線種を変更するときのオプション
%   #2 は多角形の頂点列を `;' で区切った列
%     #1は
%       [##1]##2(##3,##4)##5
%     の形式で点列を `;' で区切る。
%       ##1 : オプションで，点の位置に置く文字列
%             （省略時は，##2 と同じ）
%       ##2 : \##2 という変数の頂点名
%       [r] : をつけると極座標形式とみなす
%       (##3,##4) : 頂点の座標
%       ##5 : 頂点の近傍に置く文字列の配置オプション
%             [方角] オプションに限り区切子 `[', `]' を省略可能
%  \edef\##2{(##3,##4)}として，点\##2 が定義され，
%  \Put に
%       \Put\##2##5{##1}
%  として引き渡される。）
%
\def\takakkei{\@ifnextchar<{\@takakkei}{\@takakkei<\empty>}}
\def\@takakkei<#1>#2{\let\org@sensyu\sensyu
  \ifx \empty #1\else\setkeys{emP}{#1}\fi
\def\@takakkei@sub{\@ifnextchar[{\@@takakkei@sub}{\@@takakkei@sub[\empty]}}%
\def\@@takakkei@sub[##1]##2(##3,##4){%
  \edef\takakkei@kyokuzahyou{0}%
  \edef\takakkei@soutaizahyou{0}%
  \strsep{##2}{[}\takakkei@Vname\takakkei@opt
  \Strchr\takakkei@opt{r}\takakkei@tmp
  \ifnum\takakkei@tmp>\z@\edef\takakkei@kyokuzahyou{1}\fi
  \@ifnextchar({\@@takakkeisub@std[##1]\takakkei@Vname(##3,##4)}{%
  \@ifnextchar[{\@@takakkeisub@std[##1]\takakkei@Vname(##3,##4)}{%
    \@@takakkeisub@brev[##1]\takakkei@Vname(##3,##4)}}}%
\def\@@takakkeisub@brev[##1]##2(##3,##4)##5\@nil{%
  \ifthenelse{\equal{##5}{}}{%
  \@@takakkeisub@std[##1]##2(##3,##4)\@nil}{%
  \@@takakkeisub@std[##1]##2(##3,##4)[##5]\@nil}}%
\def\@@takakkeisub@std[##1]##2(##3,##4)##5\@nil{%
  \ifnum\takakkei@kyokuzahyou>\z@\Rdef(##3,##4)\@TakakuV\else
  \edef\@TakakuV{(##3,##4)}\fi
  \expandafter\edef\csname ##2\endcsname{\@TakakuV}%
  \edef\@takakkei@subtmp{{\csname ##2\endcsname}##5}%
  \ifx\empty##1\edef\takakkei@Vname{##2}\else\edef\takakkei@Vname{##1}\fi
  \expandafter\emathPut\@takakkei@subtmp\takakkei@Vname}%
\edef\takakkei@siten{}%
\Cfor{\edef\@TakakuVs{#2}}{\not\equal\@TakakuVs\empty}{}\do{%
  \strsep\@TakakuVs{;}\@TakakuV\@TakakuVs
  \expandafter\@takakkei@sub\@TakakuV\@nil
  \ifthenelse{\equal\takakkei@siten\empty}{%
    \edef\takakkei@siten{\@TakakuV}}{%
    \Sensyu{\@TakakuV@old\@TakakuV}}%
  \edef\@TakakuV@old{\@TakakuV}}%
\Sensyu{\@TakakuV@old\takakkei@siten}\let\sensyu\org@sensyu}


% 重心
\def\Zyuusin#1#2#3#4{\Addvec{#1}{#2}\Zyuusin@v\Addvec{#3}\Zyuusin@v\Zyuusin@v
  \Mulvec{0.33333}\Zyuusin@v\Zyuusin@v\edef#4{\Zyuusin@v}}%

% 内心 と 内接円
\def\Naisin#1#2#3#4{\sankakkei{#1}{#2}{#3}% 三角形#1#2#3の内心を#4にセット
  \Div\menseki\ls\lr
  \ItiziKetugou{\la}{#1}{\lb}{#2}\@uu%
  \ItiziKetugou{1}{\@uu}{\lc}{#3}\@uu\Mul\ls{2}\@n\Div{1}\@n\@n
  \Mulvec\@n\@uu\@uu\edef#4{\@uu}}%
\def\Naisetuen#1#2#3{\Naisin{#1}{#2}{#3}\vNaisin% 内接円描画，半径は \lr
  \En\vNaisin\lr}%
%  \Mul\lr{2}\@R\emathPut\vNaisin{\circle{\@R}}}% 内心は \vNaisin
%
% 三角形の二等分線と対辺の交点を求める。
% \Nitoubunsen[#1]#2#3#4#5
%   角#2#3#4（#3が角の頂点）を2等分する直線が辺#2#4と交わる点を#5に与える。
%   #1を与えたときは，外角の2等分線を#1に与える。
\def\Nitoubunsen{\@ifnextchar[{\@Nitoubunsen}{\@Nitoubunsen[\empty]}}
\def\@Nitoubunsen[#1]#2#3#4#5{%
  \Kyori{#2}{#3}\a@Nitoubunsen
  \Kyori{#4}{#3}\b@Nitoubunsen
  \Bunten{#2}{#4}\a@Nitoubunsen\b@Nitoubunsen#5\relax
  \ifx\empty#1\relax\else
    \Bunten{#2}{#4}\a@Nitoubunsen{-\b@Nitoubunsen}#1\relax
  \fi
}
%
% 傍心と傍接円
\def\Bousin#1#2#3#4{\sankakkei{#1}{#2}{#3}% 三角形#1#2#3の傍心を#4にセット
  \ItiziKetugou{-\la}{#1}{\lb}{#2}\@uu%
  \ItiziKetugou{1}{\@uu}{\lc}{#3}\@uu
  \Add\lb\lc\@n\Sub\@n\la\@n\Div{1}\@n\@n
  \Mulvec\@n\@uu\@uu\edef#4{\@uu}}%
\def\Bousetuen#1#2#3{\Bousin{#1}{#2}{#3}\vBousin% 傍接円描画
  \Suisen\vBousin{#2}{#3}\@T
  \Kyori\vBousin\@T\BousetuenHankei
  \En\vBousin\BousetuenHankei}
%
% 外心
% \Gaisin#1#2#3[#4]#5 三角形#1#2#3 の外心を #5 にセットする．半径は #4 に(\lR)

\def\Gaisin#1#2#3{\@ifnextchar[{\@Gaisin{#1}{#2}{#3}}{%
  \@Gaisin{#1}{#2}{#3}[\empty]}}
\def\@Gaisin#1#2#3[#4]#5{%
  \Bunten{#1}{#2}11\G@M\Subvec{#2}{#1}\G@u\Housenvec\G@u\G@u
  \Bunten{#3}{#2}11\G@N\Subvec{#2}{#3}\G@v\Housenvec\G@v\G@v
  \landl\G@M\G@u\G@N\G@v\vGaisin
  \Kyori\vGaisin{#1}\lR\edef#5{\vGaisin}%
  \ifx\empty #4\else\edef#4{\lR}\fi}

%\def\Gaisin#1#2#3#4{\sankakkei{#1}{#2}{#3}\Mul\la\lb\lR\Mul\lR\lc\lR%
%  \Div\lR\menseki\lR\Div\lR{4}\lR%
%  \Yogen{\lc}{\la}{\lb}\cosC%
%  \Mul\lR\cosC\B@M\Subvec{#2}{#1}\@AB\Nvec\@AB\@v\Mulvec\B@M\@v\@v%
%  \Bunten{#1}{#2}{1}{1}\B@M\Addvec\B@M\@v\@v\edef#4{\@v}}%
% 外接円の描画    外心は \vGaisin にセット，半径は \lR
\def\Gaisetuen#1#2#3{\Gaisin{#1}{#2}{#3}\vGaisin%
  \En\vGaisin\lR}
% \Mul\lR{2}\@tyokkei\emathPut\vGaisin{\circle{\@tyokkei}}}%
%
% 2点を与えて直線を描画する．
% \Tyokusen<#1>[#2]#3#4[#5]#6[#7]#8
%   <#1> : 線種を変更するオプション
%   #2 : \qbezier の [...]
%       #2=l のときは直線を \qbezier ではなく，\drawline で描画する．
%   #3,4 : 直線上の２点
%   #6 : 左端の x座標 （#5 に [y] とすれば，y座標）
%   #8 : 右端の x座標 （#7 に [y] とすれば，y座標）
%   (#6, #8 を {} としたときは描画領域全体）
\def\Tyokusen{\@ifnextchar<{\Tyokusen@s}{\@Tyokusen}}
\def\Tyokusen@s<#1>#2#3{\Subvec{#3}{#2}\houkou@bekutoru
  \mTyokusen<#1>{#2}\houkou@bekutoru}
\def\@Tyokusen{\@ifnextchar[{\@@Tyokusen}{\@@Tyokusen[l]}}%
\def\@@Tyokusen[#1]#2#3{\Subvec{#3}{#2}\houkou@bekutoru
  \mTyokusen[#1]{#2}\houkou@bekutoru}

% 1点と方向角を与えた直線
% \kTyokusen<#1>[#2]#3#4[#5]#6[#7]#8
%   <#1> : 線種を変更するオプション
%   #2 : \qbezier の [...]
%       #2=l のときは直線を \qbezier ではなく，\drawline で描画する．
%   #3 : 直線上の１点
%   #4 : 方向角
%   #6 : 左端の x座標 （#5 に [y] とすれば，y座標）
%   #8 : 右端の x座標 （#7 に [y] とすれば，y座標）
%   (#6, #8 を {} としたときは描画領域全体）
\def\kTyokusen{\@ifnextchar<{\kTyokusen@s}{\@kTyokusen}}
\def\kTyokusen@s<#1>#2#3{\Rdef(1,#3)\houkou@v\mTyokusen<#1>{#2}\houkou@v}
\def\@kTyokusen{\@ifnextchar[{\@@kTyokusen}{\@@kTyokusen[l]}}%
\def\@@kTyokusen[#1]#2#3{\Rdef(1,#3)\houkou@v\mTyokusen[#1]{#2}\houkou@v}

% １点と方向ベクトルを与えて直線を描画する．
% \mTyokusen<#1>[#2]#3#4[#5]#6[#7]#8
%   <#1> : 線種を変更するオプション
%   #2 : \qbezier の [...]
%       #2=l のときは直線を \qbezier ではなく，\drawline で描画する．
%   #3 : 直線上の１点
%   #4 : 方向ベクトル
%   #6 : 左端の x座標 （#5 に [y] とすれば，y座標）
%   #8 : 右端の x座標 （#7 に [y] とすれば，y座標）
%   (#6, #8 を {} としたときは描画領域全体）
\def\mTyokusen{\ifnum\EMps@mode=\@ne\gsave\fi
  \let\sensyu@org\sensyu\@ifnextchar<{\mTyokusen@s}{\mTyokusen@}}
\def\mTyokusen@s<#1>{\setkeys{emP}{#1}\m@Tyokusen[l]}
\def\mTyokusen@{\@ifnextchar[{\m@Tyokusen}{\m@Tyokusen[l]}}
\def\m@Tyokusen[#1]#2#3{%
  \@ifnextchar[{\@mTyokusen[#1]{#2}{#3}}{%
    \@mTyokusen[#1]{#2}{#3}[x]}}
\def\@mTyokusen[#1]#2#3[#4]#5{\@ifnextchar[{\@@mTyokusen[#1]{#2}{#3}[#4]{#5}}{%
  \@@mTyokusen[#1]{#2}{#3}[#4]{#5}[x]}}
\def\@@mTyokusen[#1]#2#3[#4]#5[#6]#7{\vecXY{#2}\@xi\@yi\vecXY{#3}\@mx\@my
  \Abs\@mx\@tmp
  \ifdim\@tmp pt<0.001pt\relax
\edef\migiT{(\@xi,\ymax)}%
\edef\hidariT{(\@xi,\ymin)}%
    \if l#1\relax\put(0,0){\sensyu(\@xi,\ymin)(\@xi,\ymax)}%
    \else \Drawline{(\@xi,\ymin)(\@xi,\ymax)}\fi
  \else
    \Div\@my\@mx\Katamuki
    \Mul\Katamuki\@xi\@xi
    \Sub\@yi\@xi\Yseppen
    \GFunci[#1]\Katamuki\Yseppen[#4]{#5}[#6]{#7}%
\edef\Yseppen{(0,\Yseppen)}%
    \ifdim\@mx \p@<\z@
      \edef\mTyokusen@tmp{\migiT}%
      \edef\migiT{\hidariT}\edef\hidariT{\mTyokusen@tmp}%
    \fi
  \fi\let\sensyu\sensyu@org
\ifnum\EMps@mode=\@ne\grestore\fi
}

% 半直線
%   描画端点が\HtyokuT に保存される。

% 始点と途中点を与えて半直線
  \def\Hantyokusen{\@ifnextchar<{\@Hantyokusen}{\@Hantyokusen<\empty>}}
  \def\@Hantyokusen<#1>#2#3{%
    \Subvec{#3}{#2}\Htyoku@mv\@mHantyokusen<#1>{#2}\Htyoku@mv}
% 始点と方向角を与えて半直線
  \def\kHantyokusen{\@ifnextchar<{\@kHantyokusen}{\@kHantyokusen<\empty>}}
  \def\@kHantyokusen<#1>#2#3{%
    \DegCos{#3}\Htyoku@x\DegSin{#3}\Htyoku@y
    \@mHantyokusen<#1>{#2}{(\Htyoku@x,\Htyoku@y)}}
% 始点と方向ベクトルを与えて半直線
  \def\mHantyokusen{\@ifnextchar<{\@mHantyokusen}{\@mHantyokusen<\empty>}}
  \def\@mHantyokusen<#1>#2#3{\ifnum\EMps@mode=\@ne\gsave\fi{%
    \Strchr{#1}{=}\Hantyoku@tmp\ifnum\Hantyoku@tmp>\z@\setkeys{emP}{#1}\fi
    \vecXY{#2}\Htyoku@xi\Htyoku@yi
    \vecXY{#3}\Htyoku@mx\Htyoku@my
    \IFnearlyzero\Htyoku@mx{%
      \ifdim \Htyoku@my pt>\z@\edef\Htyoku@P{(\Htyoku@xi,\ymax)}\else
      \edef\Htyoku@P{(\Htyoku@xi,\ymin)}\fi
    }{%
      \Div\Htyoku@my\Htyoku@mx\Htyoku@m
      \ifdim\Htyoku@mx pt>\z@
        \Sub\xmax\Htyoku@xi\Htyoku@y\Mul\Htyoku@y\Htyoku@m\Htyoku@y
        \Add\Htyoku@yi\Htyoku@y\Htyoku@y
        \ifdim \Htyoku@y pt>\ymax pt\relax
          \Sub\ymax\Htyoku@yi\Htyoku@x\Div\Htyoku@x\Htyoku@m\Htyoku@x
          \Add\Htyoku@xi\Htyoku@x\Htyoku@x\edef\Htyoku@P{(\Htyoku@x,\ymax)}%
        \else\ifdim \Htyoku@y pt<\ymin pt\relax
          \Sub\ymin\Htyoku@yi\Htyoku@x\Div\Htyoku@x\Htyoku@m\Htyoku@x
          \Add\Htyoku@xi\Htyoku@x\Htyoku@x\edef\Htyoku@P{(\Htyoku@x,\ymin)}%
        \else
          \edef\Htyoku@P{(\xmax,\Htyoku@y)}%
        \fi\fi
      \else
        \Sub\xmin\Htyoku@xi\Htyoku@y\Mul\Htyoku@y\Htyoku@m\Htyoku@y
        \Add\Htyoku@yi\Htyoku@y\Htyoku@y
        \ifdim \Htyoku@y pt>\ymax pt\relax
            \Sub\ymax\Htyoku@yi\Htyoku@x\Div\Htyoku@x\Htyoku@m\Htyoku@x
            \Add\Htyoku@xi\Htyoku@x\Htyoku@x\edef\Htyoku@P{(\Htyoku@x,\ymax)}%
        \else\ifdim \Htyoku@y pt<\ymin pt\relax
            \Sub\ymin\Htyoku@yi\Htyoku@x\Div\Htyoku@x\Htyoku@m\Htyoku@x
            \Add\Htyoku@xi\Htyoku@x\Htyoku@x\edef\Htyoku@P{(\Htyoku@x,\ymin)}%
        \else
          \edef\Htyoku@P{(\xmin,\Htyoku@y)}%
        \fi\fi
      \fi
    }\Sensyu{#2\Htyoku@P}\xdef\HtyokuT{\Htyoku@P}}%
    \ifnum\EMps@mode=\@ne\grestore\fi}

% 2点を通る直線の方程式
% #1 と #2 を通る直線 y=ax+b の a を #3, b を #4 に与える．

\def\LtoEq#1#2#3#4{%
\vecXY{#1}\@xi\@yi%
\vecXY{#2}\@xii\@yii%
\Sub\@yii\@yi\@m%
\Sub\@xii\@xi\@n%
\Div\@m\@n\@m\edef#3{\@m}%
\Mul\@m\@xi\@n
\Sub\@yi\@n\@n\edef#4{\@n}%
}%

% 一次関数値
% y=ax+b
% #1 : a
% #2 : b
% #3 : x
% #4 : y

\def\Funci#1#2#3#4{%
  \Mul{#1}{#3}\@f
  \Add\@f{#2}\@f
  \edef#4{\@f}}%

% 一次方程式
% ax+b=c
% #1 : a
% #2 : b
% #3 : c
% #4 : x

\def\Eqi#1#2#3#4{%
  \Sub{#3}{#2}\@f
  \Div\@f{#1}\@f
  \edef#4{\@f}}%

% 一次関数 y=ax+b (x1<x<x2) のグラフ
% #1 : 直線上の点の個数（デフォルトは0(無数))
%                        デフォルト変更 l (\drawline で描画)
% #2 : a
% #3 : b
% #5 : x1 #4で[y]オプションをつけたときは y1
% #7 : x2 #6で[y]オプションをつけたときは y2

\def\GFunci{\@ifnextchar[{\@GFunci}{\@GFunci[l]}}%
\def\@GFunci[#1]#2#3{\@ifnextchar[{\@@GFunci[#1]{#2}{#3}}{%
  \@@GFunci[#1]{#2}{#3}[x]}}%
\def\@@GFunci[#1]#2#3[#4]#5{\@ifnextchar[{\@@@GFunci[#1]{#2}{#3}[#4]{#5}}{%
  \@@@GFunci[#1]{#2}{#3}[#4]{#5}[x]}}%
\def\@@@GFunci[#1]#2#3[#4]#5[#6]#7{%
% \Add{#5}{#7}\GFunc@x\Div\GFunc@x{2}\GFunc@x%
  \ifthenelse{\equal{#5}{\empty}}{%
    \Mul{#2}\xmin\GFunc@yi\Add\GFunc@yi{#3}\GFunc@yi
    \ifdim \GFunc@yi pt>\ymax pt
      \Eqi{#2}{#3}\ymax\GFunc@xi\edef\GFunc@yi{\ymax}%
    \else\ifdim\GFunc@yi pt<\ymin pt
      \Eqi{#2}{#3}\ymin\GFunc@xi\edef\GFunc@yi{\ymin}%
    \else
      \edef\GFunc@xi{\xmin}%
    \fi\fi
    \Mul{#2}\xmax\GFunc@yii\Add\GFunc@yii{#3}\GFunc@yii
    \ifdim \GFunc@yii pt>\ymax pt
      \Eqi{#2}{#3}\ymax\GFunc@xii\edef\GFunc@yii{\ymax}%
    \else\ifdim\GFunc@yii pt<\ymin pt
      \Eqi{#2}{#3}\ymin\GFunc@xii\edef\GFunc@yii{\ymin}%
    \else
      \edef\GFunc@xii{\xmax}%
    \fi\fi
  }{%
    \ifx y#4\Eqi{#2}{#3}{#5}\GFunc@xi\edef\GFunc@yi{#5}\else%
      \edef\GFunc@xi{#5}\Funci{#2}{#3}{\GFunc@xi}\GFunc@yi\fi%
    \ifx y#6\Eqi{#2}{#3}{#7}\GFunc@xii\edef\GFunc@yii{#7}\else%
      \edef\GFunc@xii{#7}\Funci{#2}{#3}{\GFunc@xii}\GFunc@yii\fi%
  }%
%  \Funci{#2}{#3}\GFunc@xii\GFunc@yii%
\edef\hidariT{(\GFunc@xi,\GFunc@yi)}%
\edef\migiT{(\GFunc@xii,\GFunc@yii)}%
  \ifx l#1\put(0,0){\sensyu(\GFunc@xi,\GFunc@yi)(\GFunc@xii,\GFunc@yii)}\else%
  \Add\GFunc@xi\GFunc@xii\GFunc@x\Div\GFunc@x2\GFunc@x%
  \Funci{#2}{#3}{\GFunc@x}\GFunc@y%
  \qbezier[#1](\GFunc@xi,\GFunc@yi)(\GFunc@x,\GFunc@y)(\GFunc@xii,\GFunc@yii)\fi}%

% 直線描画
% ax+by+c=0 を描画する．
\def\tyokusen{\@ifnextchar[{\@tyokusen}{\@tyokusen[l]}}%
\def\@tyokusen[#1]#2#3#4{%
        \Div{#4}{-#3}\y@seppen
        \mTyokusen[#1]{(0,\y@seppen)}{(#3,-#2)}%
    }%

% 点と直線の距離(1)
% 点 P(x1,y1) と直線 ax+by+c=0 との距離を求める．
\def\tentotyokusen#1#2#3#4#5{%
%       #1 : 点P
%       #2 : a
%       #3 : b
%       #4 : c
%       #5 : 点と直線の距離
    \vecXY{#1}\tt@x\tt@y
    \Mul{#2}\tt@x\@bunsi
    \Mul{#3}\tt@y\@@bunsi\Add\@bunsi\@@bunsi\@bunsi
    \Add\@bunsi{#4}\@bunsi\Abs\@bunsi\@bunsi
    \Absvec{#1}\@bunbo\Div\@bunsi\@bunbo\@@bunsi
    \edef#5{\@@bunsi}}%

% 点と直線の距離(2)
% 点 P(x1,y1) と直線 AB との距離を求める．
\def\tentoTyokusen#1#2#3#4{%
%       #1 : 点P
%       #2 : 点A
%       #3 : 点B
%       #4 : 点と直線の距離
    \Suisen{#1}{#2}{#3}\@H\Kyori{#1}\@H#4}%

% 円の接線(1)
% 円周上の点における接線の単位方向ベクトルを求める．
\def\ennoSessen#1#2#3{%
%           #1 : 円の中心
%           #2 : 円周上の点
%           #3 : 接線の方向ベクトル（単位ベクトル）
    \Subvec{#2}{#1}\@CT\Nvec\@CT#3}%

% 円の接線(2)
% 円の外部の点から円に引いた接線の接点を求める．
\def\enniSessen#1#2#3#4#5{%
%           #1 : 円の中心
%           #2 : 円の半径
%           #3 : 円の外部の点
%           #4 : 接点(1)
%           #5 : 接点(2)
    \Kyorii{#1}{#3}\@ACii\Mul{#2}{#2}\@rii%
    \Sub\@ACii\@rii\@ATii\Heihoukon\@ATii\@AT%
    \ifdim\@AT pt<0.001pt\edef#4{#3}\edef#5{#3}\else
    \CandC{#1}{#2}{#3}\@AT#4#5\fi}%

% 2円の共通接線
% \KTGAISessen#1#2#3#4#5#6#7#8
% \KTNAISessen#1#2#3#4#5#6#7#8
%   #1 : 円1の中心
%   #2 : 円1の半径
%   #3 : 円2の中心
%   #4 : 円2の半径
%   #5 : 共通接線1と円1の接点
%   #6 : 共通接線1と円2の接点
%   #7 : 共通接線2と円1の接点
%   #8 : 共通接線2と円2の接点

\def\KTGAISessen#1#2#3#4#5#6#7#8{%
  \Sub{#4}{#2}\KT@tmp\Abs\KT@tmp\KT@tmp
  \ifdim\KT@tmp pt<0.001pt
    \Subvec{#1}{#3}\KT@CC
    \Rotvec[#2]\KT@CC{90}\KT@tmp
    \Addvec{#1}\KT@tmp#5\Addvec{#3}\KT@tmp#6\relax
    \Rotvec[#2]\KT@CC{-90}\KT@tmp
    \Addvec{#1}\KT@tmp#7\Addvec{#3}\KT@tmp#8\relax
  \else
    \Bunten{#1}{#3}{#2}{-#4}\KT@kouten
    \enniSessen{#1}{#2}\KT@kouten#5#7\relax
    \Suisen{#3}\KT@kouten{#5}#6\relax
    \Suisen{#3}\KT@kouten{#7}#8\relax
  \fi
}

\def\KTNAISessen#1#2#3#4#5#6#7#8{%
  \Bunten{#1}{#3}{#2}{#4}\KT@kouten
  \enniSessen{#1}{#2}\KT@kouten#5#7\relax
  \Kyorii\KT@kouten{#5}\KT@tmp
  \ifdim\KT@tmp pt<0.001pt\edef#6{#5}\edef#8{#7}\else
  \Suisen{#3}\KT@kouten{#5}#6\relax\Suisen{#3}\KT@kouten{#7}#8\fi
}
%
% 楕円の接線
%
\def\DaennoSessen#1#2#3#4#5{%
% #1 : 楕円の中心
% #2 : x軸方向の半径
% #3 : y軸方向の半径
% #4 : 接点
% #5 : 接線の方向ベクトルを受け取る制御綴
  \Div{#3}{#2}\EandL@hi
  \Subvec{#4}{#1}\EandL@tmp
   \vecXY\EandL@tmp\EandL@x\EandL@y\Div\EandL@y\EandL@hi\EandL@y
    \edef\EandL@T{(\EandL@x,\EandL@y)}%
  \ennoSessen\O@@\EandL@T\EandL@tmp
  \vecXY\EandL@tmp\EandL@x\EandL@y\Mul\EandL@y\EandL@hi\EandL@y
  \edef#5{(\EandL@x,\EandL@y)}\relax
}
\def\DaenniSessen#1#2#3#4#5#6{%
% #1 : 楕円の中心
% #2 : x軸方向の半径
% #3 : y軸方向の半径
% #4 : 楕円の外部の点
% #5 : 接点1を受け取る制御綴
% #6 : 接点2を受け取る制御綴
  \Div{#3}{#2}\EandL@hi
  \Subvec{#4}{#1}\EandL@tmp
   \vecXY\EandL@tmp\EandL@x\EandL@y\Div\EandL@y\EandL@hi\EandL@y
    \edef\EandL@T{(\EandL@x,\EandL@y)}%
  \enniSessen{(0,0)}{#2}\EandL@T\EandL@P\EandL@Q
  \vecXY\EandL@P\EandL@x\EandL@y\Mul\EandL@y\EandL@hi\EandL@y
    \edef\EandL@P{(\EandL@x,\EandL@y)}\Addvec\EandL@P{#1}#5\relax
  \vecXY\EandL@Q\EandL@x\EandL@y\Mul\EandL@y\EandL@hi\EandL@y
    \edef\EandL@Q{(\EandL@x,\EandL@y)}\Addvec\EandL@Q{#1}#6\relax
}
%
% 2直線の交点
%   \LandL#1#2#3#4#5
%       2点 #1, #2 を通る直線と
%       2点 #3, #4 を通る直線の交点を #5 に与える．
%
\edef\LandL@w{\empty}
\def\LandLweight#1{\def\LandL@w{#1}}
\def\LandL#1#2#3#4#5{%
  \edef#5{#1}%
  \Kyori{#1}{#2}\LandL@a
  \Kyori{#3}{#4}\LandL@b
%  \zKyori{#1}{#2}\LandL@a
%  \zKyori{#3}{#4}\LandL@b
  \ifdim\LandL@a pt> 0.005pt\relax
  \ifdim\LandL@b pt> 0.005pt\relax
    \vecXY{#1}\A@x\A@y\vecXY{#2}\B@x\B@y%
    \vecXY{#3}\C@x\C@y\vecXY{#4}\D@x\D@y%
\ifx\empty\LandL@w\relax\else
\Mul\A@x\LandL@w\A@x
\Mul\A@y\LandL@w\A@y
\Mul\B@x\LandL@w\B@x
\Mul\B@y\LandL@w\B@y
\Mul\C@x\LandL@w\C@x
\Mul\C@y\LandL@w\C@y
\Mul\D@x\LandL@w\D@x
\Mul\D@y\LandL@w\D@y
\fi
    \Sub\B@x\A@x\B@v\Sub\B@y\A@y\C@v%
    \Sub\D@x\C@x\D@v\Sub\D@y\C@y\E@v%
    \Mul\A@x\B@y\C@vi\Mul\B@x\A@y\@tmp\Sub\C@vi\@tmp\C@vi%
    \Mul\C@x\D@y\E@vi\Mul\D@x\C@y\@tmp\Sub\E@vi\@tmp\E@vi%
%\ifx\empty\LandL@w\relax\else
%\Mul\B@v\LandL@w\B@v
%\Mul\C@v\LandL@w\C@v
%\Mul\D@v\LandL@w\D@v
%\Mul\E@v\LandL@w\E@v
%\Mul\C@vi\LandL@w\C@vi
%\Mul\E@vi\LandL@w\E@vi
%\fi
    \Mul\B@v\E@v\delta@\Mul\C@v\D@v\@tmp\Sub\delta@\@tmp\delta@%
    \Mul\B@v\E@vi\delta@x\Mul\C@vi\D@v\@tmp\Sub\delta@x\@tmp\delta@x%
    \Mul\C@v\E@vi\delta@y\Mul\C@vi\E@v\@tmp\Sub\delta@y\@tmp\delta@y%
    \Div\delta@x\delta@\delta@x\Div\delta@y\delta@\delta@y%
\ifx\empty\LandL@w\relax\else
%\typeout{LandL@w=(\LandL@w),x=\delta@x,y=\delta@y}%
\Div\delta@x\LandL@w\delta@x
\Div\delta@y\LandL@w\delta@y
\fi
    \edef#5{(\delta@x,\delta@y)}%
  \fi\fi
}

\def\Landl#1#2#3#4#5{%
  \Addvec{#3}{#4}\@v
  \LandL{#1}{#2}{#3}\@v{#5}}%

\def\landl#1#2#3#4#5{%
  \Addvec{#1}{#2}\@u
  \Addvec{#3}{#4}\@v
  \LandL{#1}{\@u}{#3}{\@v}{#5}}%

% \kandk#1#2#3#4#5
%   点#1を通り方向角#2度の直線と
%   点#3を通り方向角#4度の直線の交点を#5に与える。
\def\kandk#1#2#3#4#5{\Rdef[#1](1,#2)\mm@A
  \Rdef[#3](1,#4)\mm@B
  \LandL{#1}\mm@A{#3}\mm@B#5}
\def\Landk#1#2#3#4#5{\Rdef[#3](1,#4)\mm@B\LandL{#1}{#2}{#3}\mm@B#5}

% 点の定義
% \Pdef[#1](#2,#3)#4
%   #1 を始点として点(#2,#3)を#4に与える。
\def\Pdef{\@ifnextchar[{\@Pdefa}{\@Pdef}}
\def\@Pdef(#1,#2)#3{\edef#3{(#1,#2)}}
\def\@Pdefa[#1](#2,#3)#4{\Addvec{#1}{(#2,#3)}#4}

% 極座標 → 直交座標
%   \Rdef(#1,#2)#3
%       極座標 (#1,#2) を直交座標に変換したものを #3 に代入する．
%           角 #2 の単位は六十分法
%
\def\Rdef{\@ifnextchar[{\Rdef@a}{\@Rdef}}
\def\Rdef@a[#1](#2,#3)#4{\@Rdef(#2,#3)\Rdef@a@tmp\Addvec{#1}{\Rdef@a@tmp}#4}
\def\@Rdef(#1,#2)#3{%
    \DegCos{#2}\Rdef@x\Mul\Rdef@x{#1}\Rdef@x%
    \DegSin{#2}\Rdef@y\Mul\Rdef@y{#1}\Rdef@y%
    \edef#3{(\Rdef@x,\Rdef@y)}}%

% 定義に引き続き，\Put につなげる。
\def\PPut{\@ifnextchar[{\@PPut@}{\@PPut}}
\def\@PPut(#1,#2)#3{\Pdef(#1,#2)#3\emathPut#3}
\def\@PPut@[#1](#2,#3)#4{\Pdef[#1](#2,#3)#4\emathPut#4}
\def\RPut{\@ifnextchar[{\@RPut@}{\@RPut}}
\def\@RPut(#1,#2)#3{\Rdef(#1,#2)#3\emathPut#3}
\def\@RPut@[#1](#2,#3)#4{\Rdef[#1](#2,#3)#4\emathPut#4}
\def\DivPut#1#2#3#4#5{\Bunten{#1}{#2}{#3}{#4}#5\emathPut#5}
\def\PerpPut#1#2#3#4{\Suisen{#1}{#2}{#3}#4\emathPut#4}

% 円と円の交点を求める．
% \CandC#1#2#3#4#5#6
%   点 #1 を中心，半径 #2 の円と
%   点 #3 を中心，半径 #4 の円との交点を #5 と #6 にセット
%
\def\CandC{\def\CandC@sign{0}\@ifstar{\CandC@}{\@CandC}}
\def\CandC@{\def\CandC@sign{1}\@CandC}
\def\@CandC#1#2#3#4#5#6{%
%  \edef\@tmp{#1#3}\expandafter\Distance\@tmp\@c%
  \Kyori{#1}{#3}\@c
  \Subvec{#3}{#1}\@@AB\Yogen{#4}{#2}{\@c}\@A%
  \acos\@A\@A
  \Rotvec[#2]\@@AB\@A\@AB
  \Addvec{#1}\@AB\@AB
  \Mul{-1}\@A\@A%
  \Rotvec[#2]\@@AB\@A\@AB@
  \Addvec{#1}\@AB@\@AB@
%
  \ifnum\CandC@sign>\z@
    \trisign{#1}\@AB\@AB@\CandC@s
    \ifnum\CandC@s>\z@
      \edef#5{\@AB}\edef#6{\@AB@}%
    \else\ifnum\CandC@s<\z@
      \edef#5{\@AB@}\edef#6{\@AB}%
    \else
      \edef\CandC@sign=\z@
    \fi\fi
  \fi
  \ifnum\CandC@sign=\z@
    \vecXY\@AB\@ABx\@ABy
    \vecXY\@AB@\@AB@x\@AB@y
    \Sub\@ABx\@AB@x\@d\Abs\@d\@d
    \ifdim\@d pt<0.005pt\relax%
      \ifdim \@ABy pt<\@AB@y pt\relax\edef#5{\@AB}\edef#6{\@AB@}\else%
      \edef#6{\@AB}\edef#5{\@AB@}\fi%
    \else\ifdim \@ABx pt<\@AB@x pt\relax\edef#5{\@AB}\edef#6{\@AB@}\else%
      \edef#6{\@AB}\edef#5{\@AB@}\fi\fi%
  \fi
}%
%
% 円と直線の交点
% \CandL#1#2#3#4#5#6
%   点 #1 を中心とし，半径 #2 の円と
%   2点 #3, #4 を通る直線との交点を #5 と #6 にセットする．
  \def\CandL{\def\CandL@sign{0}\@ifstar{\CandL@}{\@CandL}}
  \def\CandL@{\def\CandL@sign{1}\@CandL}
  \def\@CandL#1#2#3#4#5#6{%
    \Subvec{#3}{#4}\CandL@tmp%
    \Unitvec\CandL@tmp\CandL@e%
    \Suisen{#1}{#3}{#4}\CandL@H%
    \Kyori{#1}\CandL@H\CandL@h%
    \Mul{#2}{#2}\CandL@l%
    \Mul\CandL@h\CandL@h\CandL@tmp%
    \Sub\CandL@l\CandL@tmp\CandL@l%
    \Heihoukon\CandL@l\CandL@l%
    \Mulvec\CandL@l\CandL@e\CandL@e%
      \Addvec\CandL@H\CandL@e\CandL@a
      \Subvec\CandL@H\CandL@e\CandL@b
    \ifnum\CandL@sign>\z@
      \trisign{#1}\CandL@a\CandL@b\CandC@s
      \ifnum\CandC@s>\z@
        \edef#5{\CandL@a}\edef#6{\CandL@b}%
      \else\ifnum\CandC@s<\z@
        \edef#5{\CandL@b}\edef#6{\CandL@a}%
      \else
        \edef\CandL@sign=\z@
      \fi\fi
    \fi
    \ifnum\CandL@sign=\z@
      \vecXY\CandL@e\CandL@ex\CandL@ey%
      \ifdim\CandL@ex\p@<-0.005\p@
        \edef#5{\CandL@a}\edef#6{\CandL@b}%
%        \Addvec\CandL@H\CandL@e\CandL@tmp\edef#5{\CandL@tmp}%
%       \Subvec\CandL@H\CandL@e\CandL@tmp\edef#6{\CandL@tmp}%
      \else\ifdim\CandL@ex\p@>0.005\p@
        \edef#5{\CandL@b}\edef#6{\CandL@a}%
%        \Addvec\CandL@H\CandL@e\CandL@tmp\edef#6{\CandL@tmp}%
%       \Subvec\CandL@H\CandL@e\CandL@tmp\edef#5{\CandL@tmp}%
      \else
        \ifdim\CandL@ey\p@<-0.005\p@
          \edef#5{\CandL@a}\edef#6{\CandL@b}%
%          \Addvec\CandL@H\CandL@e\CandL@tmp\edef#5{\CandL@tmp}%
%          \Subvec\CandL@H\CandL@e\CandL@tmp\edef#6{\CandL@tmp}%
        \else
          \edef#5{\CandL@b}\edef#6{\CandL@a}%
%          \Addvec\CandL@H\CandL@e\CandL@tmp\edef#6{\CandL@tmp}%
%          \Subvec\CandL@H\CandL@e\CandL@tmp\edef#5{\CandL@tmp}%
        \fi
      \fi\fi
    \fi
\ignorespaces}%

\def\Candl{\@ifstar{\Candl@}{\@Candl}}%
\def\@Candl#1#2#3#4#5#6{\Addvec{#3}{#4}\Candl@v%
  \CandL{#1}{#2}{#3}\Candl@v{#5}{#6}\ignorespaces}%
\def\Candl@#1#2#3#4#5#6{\Addvec{#3}{#4}\Candl@v%
  \CandL*{#1}{#2}{#3}\Candl@v{#5}{#6}\ignorespaces}%

\def\Candk{\@ifstar{\Candk@}{\@Candk}}%
\def\@Candk#1#2#3#4#5#6{\Rdef[#3](1,#4)\Candk@p
  \CandL{#1}{#2}{#3}\Candk@p{#5}{#6}\ignorespaces}%
\def\Candk@#1#2#3#4#5#6{\Rdef[#3](1,#4)\Candk@p
  \CandL*{#1}{#2}{#3}\Candk@p{#5}{#6}\ignorespaces}%
%
%
% 楕円の周上の点を指定して
%   媒介変数表示θの値を求める。
%
\def\Earg#1#2#3#4#5{%
% #1 : 楕円の中心
% #2 : x軸方向の半径
% #3 : y軸方向の半径
% #4 : 周上の点
% #5 : 媒介変数の値（六十分法）を受け取る制御綴
  \Div{#3}{#2}\EandL@hi
  \Subvec{#4}{#1}\EandL@tmp
   \vecXY\EandL@tmp\EandL@x\EandL@y\Div\EandL@y\EandL@hi\EandL@y
    \edef\EandL@T{(\EandL@x,\EandL@y)}%
  \Argvec\EandL@T#5\relax
}
%
% 楕円と直線の交点
%
\def\EandL#1#2#3#4#5#6#7{%
% #1 : 楕円の中心
% #2 : x軸方向の半径
% #3 : y軸方向の半径
% #4 : 直線上の点1
% #5 : 直線上の点2
% #6 : 交点1
% #7 : 交点2
  \Div{#3}{#2}\EandL@hi
  \Subvec{#4}{#1}\EandL@tmp
    \vecXY\EandL@tmp\EandL@x\EandL@y\Div\EandL@y\EandL@hi\EandL@y
    \edef\EandL@Pi{(\EandL@x,\EandL@y)}%
  \Subvec{#5}{#1}\EandL@tmp
    \vecXY\EandL@tmp\EandL@x\EandL@y\Div\EandL@y\EandL@hi\EandL@y
    \edef\EandL@Pii{(\EandL@x,\EandL@y)}%
  \CandL{(0,0)}{#2}\EandL@Pi\EandL@Pii\EandL@P\EandL@Q
  \vecXY\EandL@P\EandL@x\EandL@y\Mul\EandL@y\EandL@hi\EandL@y
    \edef\EandL@P{(\EandL@x,\EandL@y)}\Addvec\EandL@P{#1}#6\relax
  \vecXY\EandL@Q\EandL@x\EandL@y\Mul\EandL@y\EandL@hi\EandL@y
    \edef\EandL@Q{(\EandL@x,\EandL@y)}\Addvec\EandL@Q{#1}#7\relax
}%
%
\def\Eandl#1#2#3#4#5#6#7{%
% #5 : 直線の方向ベクトル
  \Addvec{#4}{#5}\Eandl@P
  \EandL{#1}{#2}{#3}{#4}\Eandl@P#6#7}
\def\Eandk#1#2#3#4#5#6#7{%
% #5 : 直線の方向角（六十分法）
  \DegCos{#5}\Eandk@x
  \DegSin{#5}\Eandk@y
  \Addvec{#4}{(\Eandk@x,\Eandk@y)}\Eandl@P
  \EandL{#1}{#2}{#3}{#4}\Eandl@P#6#7}
%
% 近似的に0であるかどうかの判定
\def\IFnearlyzero{\@ifnextchar[{\@ifnearlyzero}{\@ifnearlyzero[.005]}}
\def\@ifnearlyzero[#1]#2#3#4{%
  \Abs{#2}\nearlyzero@tmp\ifthenelse{%
  \lengthtest{\nearlyzero@tmp pt<#1pt}}{#3}{#4}}

% 近似的に等しいかどうかの判定
% \IFnearlyequal[#1]#2#3#4#5
%   #2≒#3 であれば，#4 を実行し，そうでないときは #5 を実行する。
%   判定は |#2-#3|<#1(デフォルト値 0.005）による。
%
\def\IFnearlyequal{\@ifnextchar[{\@ifnearlyequal}{\@ifnearlyequal[.005]}}
\def\@ifnearlyequal[#1]#2#3{\Sub{#2}{#3}\nearlyequal@tmp
  \Abs{\nearlyequal@tmp}\nearlyequal@tmp\ifthenelse{%
  \lengthtest{\nearlyequal@tmp pt<#1pt}}}

% 2点間の距離
% \Kyori#1#2#3
%   2点 #1, #2 の距離を #3 に代入
%
%\def\Kyori#1#2#3{\ifx#1#2\edef#3{0.}\else\edef\Kyori@AB{#1#2}%
%  \expandafter\Distance\Kyori@AB\Kyori@AB\edef#3{\Kyori@AB}\fi}%
%\def\Kyori#1#2#3{\Subvec{#2}{#1}\Kyori@v\vecXY\Kyori@v\Kyori@xi\Kyori@yi
%  \Mul\Kyori@xi\Kyori@xi\Kyori@xi\Mul\Kyori@yi\Kyori@yi\Kyori@yi
%  \Add\Kyori@xi\Kyori@yi\Kyori@xi\Heihoukon\Kyori@xi#3}%
\def\Kyori#1#2#3{\Subvec{#2}{#1}\Kyori@AB\Absvec\Kyori@AB#3}

% 距離の平方
\def\Kyorii#1#2#3{\Subvec{#2}{#1}\Kyorii@v\vecXY\Kyorii@v\Kyorii@xi\Kyorii@yi
  \Mul\Kyorii@xi\Kyorii@xi\Kyorii@xi\Mul\Kyorii@yi\Kyorii@yi\Kyorii@yi
  \Add\Kyorii@xi\Kyorii@yi#3}%

% |x1-x2|+|y1-y2|
\def\zKyori#1#2#3{\Subvec{#2}{#1}\zKyori@v\vecXY\zKyori@v\zKyori@xi\zKyori@yi
  \Abs\zKyori@xi\zKyori@xi\Abs\zKyori@yi\zKyori@yi
  \Add\zKyori@xi\zKyori@yi#3}%

% ベクトルの大きさ
\def\Absvec#1#2{%
  \vecXY{#1}\abs@vx\abs@vy
  \Abs\abs@vx\abs@vx
  \Abs\abs@vy\abs@vy
  \ifdim\abs@vx\p@<\abs@vy\p@
    \edef\abs@max{\abs@vy}\edef\abs@min{\abs@vx}%
  \else
    \edef\abs@max{\abs@vx}\edef\abs@min{\abs@vy}%
  \fi
  \ifdim\abs@max pt<0.001pt\relax
    \edef#2{0}%
  \else
    \Div\abs@min\abs@max\abs@a
    \Mul\abs@a\abs@a\abs@a
    \Add\abs@a{1}\abs@a
    \Sqroot\abs@a\abs@a
    \Mul\abs@a\abs@max#2\relax
  \fi
}
\let\PhAbsvec\Absvec
%
% ベクトルの方向角
% \Argvec#1#2
%   ベクトル #1 の方向角を #2 にセット
%                 -180＜#2≦180

  \def\Argvec#1#2{%
    \vecXY{#1}\@@x\@@y%
  \Abs\@@x\abs@@x
    \ifdim \abs@@x pt<0.005pt\relax%
      \ifdim \@@y pt>\z@\def\@@kaku{90.0}\else\def\@@kaku{-90.0}\fi%
    \else%
      \Div\@@y\@@x\@@kaku
      \atan\@@kaku\@@kaku
      \ifdim \@@x pt<\z@%
        \ifdim\@@kaku pt>\z@
            \Sub\@@kaku{180}\@@kaku
        \else%
            \Add\@@kaku{180}\@@kaku
        \fi\fi\fi%
    \edef#2{\@@kaku}}%

% ベクトルの回転
% \def\Rotvec[#1]<#2>#3#4#5
%   ベクトル #3 を #4 度回転したベクトルを #5 に与える．
%   オプション #1 に長さを与えたときはその長さを持つものとする．
%   オプション #2 が指定されたときは #3 の長さを #2 倍する．

\def\Rotvec{\@ifnextchar[{\Rot@vec}{\Rot@vec[\empty]}}%
\def\Rot@vec[#1]{\@ifnextchar<{\@Rot@vec[#1]}{\@Rot@vec[#1]<\empty>}}%
\def\@Rot@vec[#1]<#2>#3#4#5{%
  \DegRad{#4}\@kaku\Cos\@kaku\@c\Sin\@kaku\@s
  \vecXY{#3}\Rotvec@x\Rotvec@y\Mul\Rotvec@x\@c\@xx\Mul\Rotvec@y\@s\Rotvec@t
  \Sub\@xx\Rotvec@t\@xx\Mul\Rotvec@x\@s\@yy\Mul\Rotvec@y\@c\Rotvec@t\Add\@yy\Rotvec@t\@yy
  \ifx\empty#1\ifx\empty#2\else\Mul{#2}\@xx\@xx\Mul{#2}\@yy\@yy\fi%
  \else\Unit(\@xx,\@yy)(\@xx,\@yy)\Mul\@xx{#1}\@xx\Mul\@yy{#1}\@yy\fi%
  \edef#5{(\@xx,\@yy)}}%

% 回転
%   \Rotdef[#1]<#2>#3#4#5#6
%     点 #3 を中心として
%       点 #4 を #5 度回転した点を #6 に与える．
%     #1 : 長さ指定
%     #2 : 長さの倍率指定

\def\Rotdef{\@ifnextchar[{\@Rotdef}{\@Rotdef[\empty]}}%
\def\@Rotdef[#1]{\@ifnextchar<{\@@Rotdef[#1]}{\@@Rotdef[#1]<\empty>}}%
\def\@@Rotdef[#1]<#2>#3#4#5#6{\Subvec{#4}{#3}\kaiten@v%
  \Rotvec[#1]<#2>\kaiten@v{#5}\kaiten@v\Addvec{#3}\kaiten@v\kaiten@v%
  \edef#6{\kaiten@v}}%
%
% #4 が点列の場合
%
\def\rotdef{\@ifnextchar[{\@rotdef}{\@rotdef[\empty]}}%
\def\@rotdef[#1]{\@ifnextchar<{\@@rotdef[#1]}{\@@rotdef[#1]<\empty>}}%
\def\@@rotdef[#1]<#2>#3#4#5#6{\edef#6{}%
  \def\@@@rotdef{\@ifnextchar({\@@@rotdef@}{\relax}}
  \def\@@@rotdef@(##1,##2){%
    \Subvec{(##1,##2)}{#3}\kaiten@v%
    \Rotvec[#1]<#2>\kaiten@v{#5}\kaiten@v\Addvec{#3}\kaiten@v\kaiten@v%
    \edefappend#6{\kaiten@v}%
    \@@@rotdef
  }%
  \expandafter\@@@rotdef#4\relax
}%
%
% 引き続き \Put
\def\RotPut{\@ifnextchar[{\@RotPut}{\RotPut[\empty]}}%
\def\@RotPut[#1]{\@ifnextchar<{\@@RotPut[#1]}{\@RotPut[#1]<\empty>}}%
\def\@@RotPut[#1]<#2>#3#4#5#6{\Subvec{#4}{#3}\RotPut@v%
  \Rotvec[#1]<#2>\RotPut@v{#5}\RotPut@v\Addvec{#3}\RotPut@v#6\emathPut{#6}}

% 伸縮
% \def\Muldef[#1]<#2>#3#4#5
%   #3 を中心として #4 を伸縮した点を #5 に与える．
%   オプション #1 に長さを与えたときはその長さにするものとする．
%   オプション #2 が指定されたときは長さを #2 倍する．
\def\Muldef{\@ifnextchar[{\@Muldef}{\@Muldef[\empty]}}
\def\@Muldef[#1]{\@ifnextchar<{\@@Muldef[#1]}{\@@Muldef[#1]<\empty>}}
\def\@@Muldef[#1]<#2>#3#4#5{%
  \Subvec{#4}{#3}\Muldef@v
  \ifx\empty#1\relax
    \ifx\empty#2\edef#5{#4}\else\Mulvec{#2}\Muldef@v\Muldef@v
      \Addvec{#3}\Muldef@v#5\fi
  \else
    \Absvec\Muldef@v\Muldef@l\Div{#1}\Muldef@l\Muldef@l
    \Mulvec\Muldef@l\Muldef@v\Muldef@v
    \Addvec{#3}\Muldef@v#5\fi}

\def\MulPut{\@ifnextchar[{\@MulPut}{\@MulPut[\empty]}}
\def\@MulPut[#1]{\@ifnextchar<{\@@MulPut[#1]}{\@@MulPut[#1]<\empty>}}
\def\@@MulPut[#1]<#2>#3#4#5{%
  \Subvec{#4}{#3}\MulPut@v
  \ifx\empty#1\relax
    \ifx\empty#2\edef#5{#4}\else\Mulvec{#2}\MulPut@v\MulPut@v
      \Addvec{#3}\MulPut@v#5\fi
  \else
    \Absvec\MulPut@v\MulPut@l\Div{#1}\MulPut@l\MulPut@l
    \Mulvec\MulPut@l\MulPut@v\MulPut@v
    \Addvec{#3}\MulPut@v#5\fi
  \emathPut#5}

% 数直線描画
%   \suutyokusen[#1](#2)#3#4
%       #1 : [+] としたときは正の目盛には + をつける．
%       #2 : 目盛の刻み値（デフォルトは 1）
%       #3 : x の下限
%       #4 : x の上限
%   描画位置は \put 文で数直線の原点位置を指定する．

\newdimen\@tmpla%
\def\suutyokusen{\@ifnextchar[{\@suutyokusen}{\@suutyokusen[\empty]}}%
\def\@suutyokusen[#1]{\@ifnextchar({\@@suutyokusen[#1]}{%
    \@@suutyokusen[#1](1)}}%
\def\@@suutyokusen[#1](#2)#3#4{%
    \def\@xi{0}\edef\@orgx{#3}\edef\@endx{#4}%
    \Sub\@endx\@orgx\@wdx\Add\@wdx{1}\@wdxx%
    \Add\@orgx{-0.5}\@orgxx\Add\@endx{0.5}\@endxx%
    \begin{picture}(\@wdxx,1)%
    \put(\@endxx,0){\makebox(0,0)[l]{ $x$}}%        軸名称
    \For\@xi{\@orgx}{\@endxx}{#2}\Do{%
        \setlength{\@tmpla}{\@xi pt}%
        {\thinlines\drawline(\@xi,.1)(\@xi,-.1)}%               目盛縦線
        \put(\@xi,-.4){\makebox(0,0){%
        \scriptsize%                                文字サイズ
        \ifx +#1\ifdim\@tmpla>\z@$+$\fi\fi%
        $\strip@pt\@tmpla$}}}%
    \put(\@orgxx,0){\vector(1,0){\@wdxx}}%
    \end{picture}}%
%
% 不等式の解を数直線上に表示
%
%\KTkukan[#1]#2#3
%    #1 : 各区間のラベル指定オプション
%    #2 : 各区間を`;'区切りで並べる
%    #3 : 結果の区間
%
%    区間は
%        開区間   : (-3,5)
%        閉区間   : [-3,5]
%        半開区間 : (-3,5], [-3,5)
%        無限区間 : (,-3), (5,)
%      などと表す。
%      2つの区間の和集合は (,-3)|(5,) などのように，`|'を用いる
%    ラベル指定オプションは，
%        デフォルトは [auto] で，\maru1, \maru2, .....が付与される。
%        各不等式に \label がついているときは，ラベル名を`;'区切りで並べる。
%        [] と指定すれば，区間にラベルはつかない。
%        下の \kukantakasa を用いて，自由に配置してもよい。
%    区間を表す横罫線の y座標は \kukantakasa で，そのデフォルト値は 0.5
%    　　層を重ねるときは，その 2, 3, ... 倍となる。
%
\edef\kukantakasa{.5}%
\def\KTkukan{%      v0.04 2000/05/20 by tDB(CQB00260@nifty.ne.jp)
  \@ifnextchar[{\@KTkukan}{\@KTkukan[auto]}}
\def\@KTkukan[#1]#2#3{%
  \def\KTkukan@sub##1{{%
    \Cfor{\edef\@kukans{##1}}{\not\equal{\@kukans}{}}{}\do{%
      \strsep\@kukans{|}\@kukan\@kukans%
      \headchar\@kukan\@kukan@l\@kukan@t
      \tailchar\@kukan@t\@kukan@m\@kukan@r
      \strsep\@kukan@m{,}\@kukan@a\@kukan@b
      \ifthenelse{\equal\@kukan@a{}}{%
        \edef\@kukan@A{(\xmin,0)}\edef\@kukan@AA{(\xmin,\@takasa)}}{%
        \edef\@kukan@A{(\@kukan@a,0)}%
        \if\@kukan@l(\Landl{(\xmin,\@takasa)}{(\xmax,\@takasa)}\@kukan@A
          {(1,3)}\@kukan@AA\Drawline{\@kukan@A\@kukan@AA}\Siromaru\@kukan@A
        \else\edef\@kukan@AA{(\@kukan@a,\@takasa)}%
          \Drawline{\@kukan@A\@kukan@AA}\Kuromaru\@kukan@A
        \fi
      }%
      \ifthenelse{\equal\@kukan@b{}}{%
        \edef\@kukan@B{(\xmax,0)}\edef\@kukan@BB{(\xmax,\@takasa)}}{%
        \edef\@kukan@B{(\@kukan@b,0)}%
        \if\@kukan@r)\Landl{(\xmin,\@takasa)}{(\xmax,\@takasa)}\@kukan@B
          {(-1,3)}\@kukan@BB\Drawline{\@kukan@B\@kukan@BB}%
          \Siromaru\@kukan@B
        \else\edef\@kukan@BB{(\@kukan@b,\@takasa)}%
          \Drawline{\@kukan@B\@kukan@BB}\Kuromaru\@kukan@B
        \fi
      }%
      \Drawline{\@kukan@AA\@kukan@BB}%
      \ifthenelse{\equal{#1}\empty}{}{%
      \ifthenelse{\equal{#1}{auto}}{%
        \sPut\@kukan@AA\@kukan@BB{{%
          \fboxsep\z@\makebox(0,0){\colorbox{white}{\maru\i@kukan}}}}}{%
        \ifthenelse{\equal\kukan@lbli\empty}{}{%
          \sPut\@kukan@AA\@kukan@BB{{%
            \fboxsep\z@\makebox(0,0){\colorbox{white}{\eqref\kukan@lbli}}}}%
        }%
      }}%
    }%
  }}%
%
  \edef\i@kukan{0}%
  \Cfor{\edef\@kukans{#2}\edef\kukan@lbl{#1}}{\not\equal{\@kukans}{}}{}\do{%
    \strsep\@kukans{;}\@kukan\@kukans%
    \Incr\i@kukan\Mul\i@kukan\kukantakasa\@takasa
    \strsep\kukan@lbl{;}\kukan@lbli\kukan@lbl
    \KTkukan@sub\@kukan
  }%
  \Cfor{\edef\@kukans{#3}}{\not\equal{\@kukans}{}}{}\do{%
    \strsep\@kukans{|}\@kukan\@kukans%
    \headchar\@kukan\@kukan@l\@kukan@t
    \tailchar\@kukan@t\@kukan@m\@kukan@r
    \strsep\@kukan@m{,}\@kukan@a\@kukan@b
    \ifthenelse{\equal\@kukan@a{}}{%
      \edef\@kukan@A{(\xmin,0)}\edef\@kukan@AA{(\xmin,\kukantakasa)}}{%
      \edef\@kukan@A{(\@kukan@a,0)}%
      \if\@kukan@l(\Landl{(\xmin,\kukantakasa)}{(\xmax,\kukantakasa)}%
        \@kukan@A{(1,3)}\@kukan@AA
      \else\edef\@kukan@AA{(\@kukan@a,\kukantakasa)}%
      \fi
      }%
    \ifthenelse{\equal\@kukan@b{}}{%
      \edef\@kukan@B{(\xmax,0)}\edef\@kukan@BB{(\xmax,\kukantakasa)}}{%
      \edef\@kukan@B{(\@kukan@b,0)}%
      \if\@kukan@r)\Landl{(\xmin,\kukantakasa)}{(\xmax,\kukantakasa)}%
        \@kukan@B{(-1,3)}\@kukan@BB
      \else\edef\@kukan@BB{(\@kukan@b,\kukantakasa)}%
      \fi
      }%
    \Nuritubusi*{\@kukan@A\@kukan@AA\@kukan@BB\@kukan@B\@kukan@A}%
  }%
}

% 座標平面
% \begin{zahyou}(xmin,xmax)(ymin,ymax).....\end{zahyou}
%   zahyou[#1][#2]<#3><#4><#5>(#6,#7)(#8,#9)
%     #1 : key=val
%       or : 横軸のラベル名   （デフォルトは [$x$]）
%     #2 : 縦軸のラベル名   （デフォルトは [$y$ ]）
%     #3 : 横軸ラベルの位置 （デフォルトは <(0,-3pt)[tl]> ）
%     #4 : 縦軸ラベルの位置 （デフォルトは <(0,0)[rt]> ）
%     #5 : 原点記号Oの位置  （デフォルトは <(-2pt,-3pt)[rt]> ）
%     (#6,#7) : xの範囲
%     (#8,#9) : yの範囲
%
\def\yokozikukigou{$x$}%
\def\tatezikukigou{$y$}%
\def\gentenkigou{O}%
\def\yokozikuhaiti{(0,-3pt)[rt]}%
\def\tatezikuhaiti{(-3pt,0)[rt]}%
\def\gentenhaiti{[sw]}%
\def\zikusensyu{\arrowdrawline}
\def\zahyou{%
  \def\zahyou@haiti{b}%
  \def\zahyou@haiti@hosei{}%
  \def\ue@yohaku{0}%
  \def\sita@yohaku{0}%
  \def\migi@yohaku{0}%
  \def\hidari@yohaku{0}%
  \def\arrow@headsize{1}%
  \z@hyou}%
\def\z@hyou{\@ifnextchar[{\@zahyou}{\@zahyou[\yokozikukigou]}}%
\def\@zahyou[#1]{\@ifnextchar[{\@@zahyou[#1]}{\@@zahyou[#1][\tatezikukigou]}}%
\def\@@zahyou[#1][#2]{\@ifnextchar<{\@@@zahyou[#1][#2]}{%
  \@@@zahyou[#1][#2]<\yokozikuhaiti>}}%
\def\@@@zahyou[#1][#2]<#3>{\@ifnextchar<{\@@@@zahyou[#1][#2]<#3>}{%
  \@@@@zahyou[#1][#2]<#3><\tatezikuhaiti>}}%
\def\@@@@zahyou[#1][#2]<#3><#4>{\@ifnextchar<{\@@@@@zahyou[#1][#2]<#3><#4>}{%
  \@@@@@zahyou[#1][#2]<#3><#4><\gentenhaiti>}}%
\def\@@@@@zahyou[#1][#2]<#3><#4><#5>(#6,#7)(#8,#9){%
  \Strchr{#1}{=}\zahyou@tmp
  \ifnum\zahyou@tmp>\z@
    \setkeys{emP}{#1}%
  \else
    \ifthenelse{\equal{#1}\empty}{}{\edef\yokozikukigou{#1}}%
    \ifthenelse{\equal{#2}\empty}{}{\edef\tatezikukigou{#2}}%
    \ifthenelse{\equal{#3}\empty}{}{\edef\yokozikuhaiti{#3}}%
    \ifthenelse{\equal{#4}\empty}{}{\edef\tatezikuhaiti{#4}}%
    \ifthenelse{\equal{#5}\empty}{}{\edef\gentenhaiti{#5}}%
  \fi
  \edef\xmin{#6}\edef\xmax{#7}%
  \edef\ymin{#8}\edef\ymax{#9}%
\edef\truexmin{\xmin}%
\edef\trueymin{\ymin}%
\edef\truexmax{\xmax}%
\edef\trueymax{\ymax}%
% picture 環境の設定
  \Sub\xmax\xmin\xwd
  \Add\xwd\migi@yohaku\xwd\Add\xwd\hidari@yohaku\xwd
  \Sub\xmin\hidari@yohaku\xmin@
  \Sub\ymax\ymin\ywd
  \Add\ywd\ue@yohaku\ywd\Add\ywd\sita@yohaku\ywd
  \Sub\ymin\sita@yohaku\ymin@
  \if t\zahyou@haiti
   \@tempdima \ywd\unitlength
  \else\if x\zahyou@haiti
    \@tempdima \ymin@\unitlength
    \@tempdima=-\@tempdima
  \else\if c\zahyou@haiti
    \@tempdima \ywd\unitlength
    \divide \@tempdima \tw@
    \advance\@tempdima -0.5ex\relax
  \else
    \@tempdima\z@
  \fi\fi\fi
  \ifthenelse{\equal\zahyou@haiti@hosei\empty}{}{%
      \@tempdimb\zahyou@haiti@hosei
      \advance\@tempdima-\@tempdimb}%
  \leavevmode\lower\@tempdima\hbox\bgroup
  \changeArrowHeadSize{\arrow@headsize}%
  \ltxpicture(\xwd,\ywd)(\xmin@,\ymin@)%
  \def\O{(0,0)}%
  \def\O@@{(0,0)}%
  \def\XMAX{(\xmax,0)}%
  \def\XMIN{(\xmin,0)}%
  \def\YMAX{(0,\ymax)}%
  \def\YMIN{(0,\ymin)}%
  \def\LT{(\xmin,\ymax)}%
  \def\LB{(\xmin,\ymin)}%
  \def\RT{(\xmax,\ymax)}%
  \def\RB{(\xmax,\ymin)}%
  \def\trueLT{(\truexmin,\trueymax)}%
  \def\trueLB{(\truexmin,\trueymin)}%
  \def\trueRT{(\truexmax,\trueymax)}%
  \def\trueRB{(\truexmax,\trueymin)}%
  \Add\xmax\migi@yohaku\xmaxY
  \Sub\xmin\hidari@yohaku\xminY
  \Add\ymax\ue@yohaku\ymaxY
  \Sub\ymin\sita@yohaku\yminY
}
\def\endzahyou{%
  \ifdrawaxis%
    \drawXYaxis
  \fi
  \endltxpicture
  \egroup\@ignoretrue
}

% 座標軸を描画しない zahyou* 環境
\expandafter\def\csname zahyou*\endcsname{\drawaxisfalse\zahyou}
\expandafter\def\csname endzahyou*\endcsname{\endzahyou\@ignoretrue}


%\def\drawXaxis{\Sub\xmax\xmin\xwd\put(\xmin,0){\vector(1,0){\xwd}}}%
%\def\drawYaxis{\Sub\ymax\ymin\ywd\put(0,\ymin){\vector(0,1){\ywd}}}%
\def\drawXaxis{\put(0,0){\ArrowLine{(\xmin,0)}{(\xmax,0)}}}
\def\drawYaxis{\put(0,0){\ArrowLine{(0,\ymin)}{(0,\ymax)}}}
\def\drawXYaxis{%
    \put(0,0){\zikusensyu(\truexmin,0)(\truexmax,0)}%
    \put(0,0){\zikusensyu(0,\trueymin)(0,\trueymax)}%
    \edef\zahyou@tmp{{(\truexmax,0)}\yokozikuhaiti}%
    \expandafter\emathPut\zahyou@tmp{\yokozikukigou}%
    \edef\zahyou@tmp{{(0,\trueymax)}\tatezikuhaiti}%
    \expandafter\emathPut\zahyou@tmp{\tatezikukigou}%
    \edef\zahyou@tmp{{(0,0)}\gentenhaiti}%
    \expandafter\emathPut\zahyou@tmp{\gentenkigou}
}
% 座標軸に目盛を打つ．
% \zahyouMemori[#1][#2]<#3>
%   #1 : g : グリッド
%        + : 格子点に +マーク
%        o : 格子点に黒丸
%        z : 座標軸上の格子点に +マーク（デフォルト）
%        n : なし
%   #2 : n : 目盛り数値なし
%   #3 : 刻み
\def\zahyouMemori{\@ifnextchar[{\@zahyouMemori}{\@zahyouMemori[z]}}%
\def\@zahyouMemori[#1]{\@ifnextchar[{\@@zahyouMemori[#1]}{%
    \@@zahyouMemori[#1][m]}}%
\def\@@zahyouMemori[#1][#2]{\@ifnextchar<{\@@@zahyouMemori[#1][#2]}{%
  \@@@zahyouMemori[#1][#2]<1>}}%
\def\@@@zahyouMemori[#1][#2]<#3>{{%
  \ifnum\EMps@mode=\@ne\gsave\fi
  \@tempdima=\def@memori@nagasa
  \Div{\strip@pt\@tempdima}{\strip@pt\unitlength}\memori@nagasa
  \if g#1\relax{\@ifundefined{allinethickness}{}{\allinethickness{0.1pt}}%
    \setbox0=\hbox{\hasen(0,\trueymax)(0,\trueymin)}%
    \For\@x{#3}{\truexmax}{#3}\Do{\put(\@x,0){\copy0}}%
    \For\@x{-#3}{\truexmin}{-#3}\Do{\put(\@x,0){\copy0}}%
    \setbox0=\hbox{\hasen(\truexmax,0)(\truexmin,0)}%
    \For\@x{#3}{\trueymax}{#3}\Do{\put(0,\@x){\copy0}}%
    \For\@x{-#3}{\trueymin}{-#3}\Do{\put(0,\@x){\copy0}}}%
  \else\if +#1\relax
    \Cfor{\edef\zM@x{0}}{\lengthtest{\zM@x pt<\truexmax pt}}{\Incr[#3]\zM@x}\do{%
      \Cfor{\edef\zM@y{0}}{\lengthtest{\zM@y pt<\trueymax pt}}{\Incr[#3]\zM@y}\do{%
        \put(\zM@x,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}%
        \put(\zM@x,\zM@y){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}%
      \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\trueymin pt}}{\Incr[-#3]\zM@y}\do{%
        \put(\zM@x,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}%
        \put(\zM@x,\zM@y){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}}%
      \Cfor{\edef\zM@x{-#3}}{\lengthtest{\zM@x pt>\truexmin pt}}{\Incr[-#3]\zM@x}\do{%
      \Cfor{\edef\zM@y{0}}{\lengthtest{\zM@y pt<\trueymax pt}}{\Incr[#3]\zM@y}\do{%
        \put(\zM@x,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}%
        \put(\zM@x,\zM@y){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}%
      \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\trueymin pt}}{\Incr[-#3]\zM@y}\do{%
        \put(\zM@x,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}%
        \put(\zM@x,\zM@y){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}}%
  \else\if o#1\relax
    \Cfor{\edef\zM@x{0}}{\lengthtest{\zM@x pt<\truexmax pt}}{\Incr[#3]\zM@x}\do{%
      \Cfor{\edef\zM@y{0}}{\lengthtest{\zM@y pt<\trueymax pt}}{\Incr[#3]\zM@y}\do{%
        \Kuromaru[0.5pt]{(\zM@x,\zM@y)}}%
      \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\trueymin pt}}{\Incr[-#3]\zM@y}\do{%
        \Kuromaru[0.5pt]{(\zM@x,\zM@y)}}}%
      \Cfor{\edef\zM@x{-#3}}{\lengthtest{\zM@x pt>\truexmin pt}}{\Incr[-#3]\zM@x}\do{%
      \Cfor{\edef\zM@y{0}}{\lengthtest{\zM@y pt<\trueymax pt}}{\Incr[#3]\zM@y}\do{%
        \Kuromaru[0.5pt]{(\zM@x,\zM@y)}}%
      \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\trueymin pt}}{\Incr[-#3]\zM@y}\do{%
        \Kuromaru[0.5pt]{(\zM@x,\zM@y)}}}%
  \else\if z#1\relax
    \Cfor{\edef\zM@x{#3}}{\lengthtest{\zM@x pt<\truexmax pt}}{\Incr[#3]\zM@x}\do{%
      \put(\zM@x,0){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}%
    \Cfor{\edef\zM@x{-#3}}{\lengthtest{\zM@x pt>\truexmin pt}}{\Incr[-#3]\zM@x}\do{%
      \put(\zM@x,0){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}%
    \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\trueymin pt}}{\Incr[-#3]\zM@y}\do{%
      \put(0,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}}%
    \Cfor{\edef\zM@y{#3}}{\lengthtest{\zM@y pt<\trueymax pt}}{\Incr[#3]\zM@y}\do{%
      \put(0,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}}%
  \fi\fi\fi\fi
  \if m#2\relax
    \Cfor{\edef\zM@x{#3}}{\lengthtest{\zM@x pt<\truexmax pt}}{\Incr[#3]\zM@x}\do{%
      \emathPut{(\zM@x,0)}[s]{\zM@x}}%
    \Cfor{\edef\zM@x{-#3}}{\lengthtest{\zM@x pt>\truexmin pt}}{\Incr[-#3]\zM@x}\do{%
      \emathPut{(\zM@x,0)}[s]{$\zM@x$}}%
    \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\trueymin pt}}{\Incr[-#3]\zM@y}\do{%
      \emathPut{(0,\zM@y)}[w]{$\zM@y$}}%
    \Cfor{\edef\zM@y{#3}}{\lengthtest{\zM@y pt<\trueymax pt}}{\Incr[#3]\zM@y}\do{%
      \emathPut{(0,\zM@y)}[w]{\zM@y}}%
  \fi
  \ifnum\EMps@mode=\@ne\grestore\fi
}}
%\def\@@@zahyouMemori[#1][#2]<#3>{{%
%  \@tempdima=\def@memori@nagasa
%  \Div{\strip@pt\@tempdima}{\strip@pt\unitlength}\memori@nagasa
%  \if g#1\relax{\@ifundefined{allinethickness}{}{\allinethickness{0.1pt}}%
%    \setbox0=\hbox{\hasen(0,\ymax)(0,\ymin)}%
%    \For\@x{#3}{\xmax}{#3}\Do{\put(\@x,0){\copy0}}%
%    \For\@x{-#3}{\xmin}{-#3}\Do{\put(\@x,0){\copy0}}%
%    \setbox0=\hbox{\hasen(\xmax,0)(\xmin,0)}%
%    \For\@x{#3}{\ymax}{#3}\Do{\put(0,\@x){\copy0}}%
%    \For\@x{-#3}{\ymin}{-#3}\Do{\put(0,\@x){\copy0}}}%
%  \else\if +#1\relax
%    \Cfor{\edef\zM@x{0}}{\lengthtest{\zM@x pt<\xmax pt}}{\Incr[#3]\zM@x}\do{%
%      \Cfor{\edef\zM@y{0}}{\lengthtest{\zM@y pt<\ymax pt}}{\Incr[#3]\zM@y}\do{%%
%        \put(\zM@x,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}%
%        \put(\zM@x,\zM@y){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}%
%      \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\ymin pt}}{\Incr[-#3]\zM@y}\do{%
%        \put(\zM@x,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}%
%        \put(\zM@x,\zM@y){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}}%
%      \Cfor{\edef\zM@x{-#3}}{\lengthtest{\zM@x pt>\xmin pt}}{\Incr[-#3]\zM@x}\do{%
%      \Cfor{\edef\zM@y{0}}{\lengthtest{\zM@y pt<\ymax pt}}{\Incr[#3]\zM@y}\do{%%
%        \put(\zM@x,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}%
%        \put(\zM@x,\zM@y){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}%
%      \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\ymin pt}}{\Incr[-#3]\zM@y}\do{%
%        \put(\zM@x,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}%
%        \put(\zM@x,\zM@y){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}}%
%  \else\if o#1\relax
%    \Cfor{\edef\zM@x{0}}{\lengthtest{\zM@x pt<\xmax pt}}{\Incr[#3]\zM@x}\do{%
%      \Cfor{\edef\zM@y{0}}{\lengthtest{\zM@y pt<\ymax pt}}{\Incr[#3]\zM@y}\do{%%
%        \Kuromaru[0.5pt]{(\zM@x,\zM@y)}}%
%      \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\ymin pt}}{\Incr[-#3]\zM@y}\do{%
%        \Kuromaru[0.5pt]{(\zM@x,\zM@y)}}}%
%      \Cfor{\edef\zM@x{-#3}}{\lengthtest{\zM@x pt>\xmin pt}}{\Incr[-#3]\zM@x}\do{%
%      \Cfor{\edef\zM@y{0}}{\lengthtest{\zM@y pt<\ymax pt}}{\Incr[#3]\zM@y}\do{%%
%        \Kuromaru[0.5pt]{(\zM@x,\zM@y)}}%
%      \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\ymin pt}}{\Incr[-#3]\zM@y}\do{%
%        \Kuromaru[0.5pt]{(\zM@x,\zM@y)}}}%
%  \else\if z#1\relax
%    \Cfor{\edef\zM@x{#3}}{\lengthtest{\zM@x pt<\xmax pt}}{\Incr[#3]\zM@x}\do{%
%      \put(\zM@x,0){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}%
%    \Cfor{\edef\zM@x{-#3}}{\lengthtest{\zM@x pt>\xmin pt}}{\Incr[-#3]\zM@x}\do{%%
%      \put(\zM@x,0){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}%
%    \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\ymin pt}}{\Incr[-#3]\zM@y}\do{%%
%      \put(0,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}}%
%    \Cfor{\edef\zM@y{#3}}{\lengthtest{\zM@y pt<\ymax pt}}{\Incr[#3]\zM@y}\do{%
%      \put(0,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}}%
%  \fi\fi\fi\fi
%  \if m#2\relax
%    \Cfor{\edef\zM@x{#3}}{\lengthtest{\zM@x pt<\xmax pt}}{\Incr[#3]\zM@x}\do{%
%      \emathPut{(\zM@x,0)}[s]{\zM@x}}%
%    \Cfor{\edef\zM@x{-#3}}{\lengthtest{\zM@x pt>\xmin pt}}{\Incr[-#3]\zM@x}\do{%%
%      \emathPut{(\zM@x,0)}[s]{$\zM@x$}}%
%    \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\ymin pt}}{\Incr[-#3]\zM@y}\do{%%
%      \emathPut{(0,\zM@y)}[w]{$\zM@y$}}%
%    \Cfor{\edef\zM@y{#3}}{\lengthtest{\zM@y pt<\ymax pt}}{\Incr[#3]\zM@y}\do{%
%      \emathPut{(0,\zM@y)}[w]{\zM@y}}%
%  \fi
%}}

% 座標軸上任意位置に目盛
% \xmemori[#1]<#2>#3
% \ymemori[#1]<#2>#3
%   #1 : t = 座標軸の下に目盛
%        b =         上
%   #2 : 目盛の文字
%        （省略すれば，#3 に指定したものが代用されます．）
%   #3 : 目盛の位置
%
\def\def@memori@nagasa{.5mm}
\def\memorinagasa#1{\def\def@memori@nagasa{#1}}
%
\def\xmemori{\@ifnextchar[{\x@memori}{\x@memori[t]}}%
\def\x@memori[#1]{\@ifnextchar<{\x@@memori[#1]}{\x@@memori[#1]<\empty>}}%
\def\x@@memori[#1]<#2>#3{{%
  \@ifundefined{cPut}{}{\let\emathPut\cPut}%
    \ifx\empty#2\edef\memori@lbl{$#3$}\else\def\memori@lbl{$#2$}\fi%
    \@ifundefined{yunitlength}{%
%     \Div{1}{\strip@pt\unitlength}\memori@u@pt%
      \ukansan\def@memori@nagasa\memori@u@pt
    }{%
%     \Div{1}{\strip@pt\yunitlength}\memori@u@pt%
      \uykansan\def@memori@nagasa\memori@u@pt
    }%
    \put(0,0){\drawline(#3,-\memori@u@pt)(#3,\memori@u@pt)}%
%   \ifx#1t\emathPut{(#3,-\memori@u@pt)}(0,-2pt)[t]\memori@lbl\else
%       \emathPut{(#3,\memori@u@pt)}(0,2pt)[b]\memori@lbl\fi
    \ifthenelse{\equal{#1}{t}}{%
      \emathPut{(#3,-\memori@u@pt)}(0,-2pt)[t]\memori@lbl
    }{%
      \ifthenelse{\equal{#1}{b}}{%
        \emathPut{(#3,\memori@u@pt)}(0,2pt)[b]\memori@lbl
      }{%
        \edef\xmemori@str{{(#3,0)}#1}%
        \expandafter\emathPut\xmemori@str\memori@lbl
      }%
    }%
}}

\def\ymemori{\@ifnextchar[{\y@memori}{\y@memori[r]}}%
\def\y@memori[#1]{\@ifnextchar<{\y@@memori[#1]}{\y@@memori[#1]<\empty>}}%
\def\y@@memori[#1]<#2>#3{{%
  \@ifundefined{cPut}{}{\let\emathPut\cPut}%
    \ifx\empty#2\edef\memori@lbl{$#3$}\else\def\memori@lbl{$#2$}\fi%
    \@ifundefined{xunitlength}{%
%      \Div{1}{\strip@pt\unitlength}\memori@u@pt%
      \ukansan\def@memori@nagasa\memori@u@pt
    }{%
%      \Div{1}{\strip@pt\xunitlength}\memori@u@pt%
      \uxkansan\def@memori@nagasa\memori@u@pt
    }%
    \put(0,0){\drawline(-\memori@u@pt,#3)(\memori@u@pt,#3)}%
%    \ifx #1r\emathPut{(-\memori@u@pt,#3)}(-2pt,0)[r]\memori@lbl\else
%        \emathPut{(\memori@u@pt,#3)}(2pt,0)[l]\memori@lbl\fi
    \ifthenelse{\equal{#1}{r}}{%
      \emathPut{(-\memori@u@pt,#3)}(-2pt,0)[r]\memori@lbl
    }{%
      \ifthenelse{\equal{#1}{l}}{%
        \emathPut{(\memori@u@pt,#3)}(2pt,0)[l]\memori@lbl
      }{%
        \edef\ymemori@str{{(0,#3)}#1}%
        \expandafter\emathPut\ymemori@str\memori@lbl
      }%
    }%
}}
%
% \rmemori
%
\def\rmemori(#1,#2)#3{%
  \ukansan\def@memori@nagasa\memori@u@pt
  \Add{#1}\memori@u@pt\rmemori@l\Rdef(\rmemori@l,#2)\rmemori@P
  \Sub{#1}\memori@u@pt\rmemori@l\Rdef(\rmemori@l,#2)\rmemori@Q
  \Drawline{\rmemori@P\rmemori@Q}%
  \Put\rmemori@P [r](6pt,#2)[c]{#3}%
}
%
% 回転
%   \begin{Mawasu}#1#2
%     #1 : 回転の中心
%     #2 : 回転角

\def\Mawasu#1#2
{%
  \vecXY{#1}\Mawasu@x\Mawasu@y
  \bgroup
  \iftdir
    \@tempdima\Mawasu@y\unitlength\@tempdima13.837\@tempdima%
    \@tempdimb\Mawasu@x\unitlength\@tempdimb13.837\@tempdimb%
  \else
    \@tempdima\Mawasu@x\unitlength\@tempdima13.837\@tempdima%
    \@tempdimb\Mawasu@y\unitlength\@tempdimb-13.837\@tempdimb%
  \fi
  \DegRad{#2}\@t\Mul{-1}\@t\@t
  \special{rt \@seisuu\@tempdima\space\@seisuu\@tempdimb\space\@t}%
}%
\def\endMawasu{\special{rt 0 0 0}\egroup}


% 近似折れ線
% (0) 円弧を近似する折れ線
% \KinziEnko<#1>#2#3#4#5#6
%   #1 : 刻み値
%   #2 : 中心
%   #3 : 半径を直接与えるか
%        tuukaten=xx として，円弧の周上の一点を与える
%   #4 : 始め角を直接与えるか
%         hazimeten=xx として，中心を始点，xx を終点とするベクトルの
%         方向角を 始め角とするように指定する。
%   #5 : 終り角を直接与えるか
%         owariten=xx として，中心を始点，xx を終点とするベクトルの
%         方向角を 終り角とするように指定する。
%   #6 : 近似折れ線を受け取る制御綴

\def\KinziEnko{\@ifnextchar<{\KinziEnk@}{\KinziEnk@<0.025>}}
\def\KinziEnk@<#1>#2#3#4#5#6{%
    \define@key{emP}{tuukaten}{\Kyori{##1}{#2}\@hankei}%
    \define@key{emP}{hazimeten}{%
      \Subvec{##1}{#2}\KinziEnk@tmp\Argvec\KinziEnk@tmp\hazime@kaku}%
    \define@key{emP}{owariten}{%
      \Subvec{##1}{#2}\KinziEnk@tmp\Argvec\KinziEnk@tmp\owari@kaku
      \ifdim\owari@kaku pt<\hazime@kaku pt\Add{360}\owari@kaku\owari@kaku\fi}%
  \edef\hasen@opt{\empty}%
  \edef\hazime@kaku{#4}%
  \edef\owari@kaku{#5}%
  \edef\@tyuusin{#2}%
  \edef\@hankei{#3}%
  \Strchr{#3}{=}\KinziEnk@tmp\ifnum\KinziEnk@tmp>\z@\setkeys{emP}{#3}\fi
  \Strchr{#4}{=}\KinziEnk@tmp\ifnum\KinziEnk@tmp>\z@\setkeys{emP}{#4}\fi
  \Strchr{#5}{=}\KinziEnk@tmp\ifnum\KinziEnk@tmp>\z@\setkeys{emP}{#5}\fi
  \DegRad\hazime@kaku\kaku@s\DegRad\owari@kaku\kaku@e\def\@resen{}
  \For\@t\kaku@s\kaku@e{#1}\Do{\Cos\@t\@x\Mul\@x{\@hankei}\@x%
    \Sin\@t\@y\Mul\@y{\@hankei}\@y
    \Addvec{(\@x,\@y)}\@tyuusin\tmp@P
    \edef\@resen{\@resen\tmp@P}}%
  \Cos\kaku@e\@x\Mul\@x{\@hankei}\@x\Sin\kaku@e\@y\Mul\@y{\@hankei}\@y%
  \Addvec{(\@x,\@y)}\@tyuusin\tmp@P
  \edef\@resen{\@resen\tmp@P}\edef#6{\@resen}}


% 座標軸に平行な辺を持つ長方形の 斜線塗り
% \hatch<#1>[#2](#3,#4)(#5,#6)
% #1 : x軸方向間隔
% #2 : n = スラッシュ（デフォルト）
%    r = 逆スラッシュ
%        x = 交差
%    h = 水平
%    v = 鉛直
%    + = 十文字
% #3〜#6 : 対角頂点
%
\def\hatchrect{\@ifnextchar<{\@hatchrect}{\@hatchrect<.15>}}%
\def\@hatchrect<#1>{\@ifnextchar[{\@@hatchrect<#1>}{\@@hatchrect<#1>[n]}}%
\def\@@hatchrect<#1>[#2](#3,#4)(#5,#6){%
\ifdim #3pt<#5pt\relax%
  \edef\hatchrect@xi{#3}\edef\hatchrect@xii{#5}\else%
  \edef\hatchrect@xi{#5}\edef\hatchrect@xii{#3}\fi%
\ifdim #4pt<#6pt\relax%
  \edef\hatchrect@yi{#4}\edef\hatchrect@yii{#6}\else%
  \edef\hatchrect@yi{#6}\edef\hatchrect@yii{#4}\fi%
\Sub\hatchrect@yii\hatchrect@yi\mhatchrect@y
\Sub\hatchrect@xii\hatchrect@xi\mhatchrect@x
\edef\hatchrect@dx{#1}%
\edef\hatchrect@n{0}\edef\hatchrect@r{0}%
\edef\hatchrect@h{0}\edef\hatchrect@v{0}%
\ifx n#2\edef\hatchrect@n{1}\else
\ifx r#2\edef\hatchrect@r{1}\else
\ifx x#2\edef\hatchrect@n{1}\edef\hatchrect@r{1}\else
\ifx h#2\edef\hatchrect@h{1}\else
\ifx v#2\edef\hatchrect@v{1}\else
\ifx +#2\edef\hatchrect@h{1}\edef\hatchrect@v{1}%
\fi\fi\fi\fi\fi\fi
\if 1\hatchrect@n%
\For\hatchrect@x\hatchrect@xi\hatchrect@xii\hatchrect@dx\Do{%
  \mTyokusen[l]{(\hatchrect@x,\hatchrect@yi)}{%
    (\mhatchrect@x,\mhatchrect@y)}\hatchrect@x\hatchrect@xii}%
\For\hatchrect@x\hatchrect@xii\hatchrect@xi{-\hatchrect@dx}\Do{%
  \mTyokusen[l]{(\hatchrect@x,\hatchrect@yii)}{%
    (-\mhatchrect@x,-\mhatchrect@y)}\hatchrect@xi\hatchrect@x}%
\fi%
\if 1\hatchrect@r
\For\hatchrect@x\hatchrect@xi\hatchrect@xii\hatchrect@dx\Do{%
  \mTyokusen[l]{(\hatchrect@x,\hatchrect@yii)}{%
    (\mhatchrect@x,-\mhatchrect@y)}\hatchrect@x\hatchrect@xii}%
\For\hatchrect@x\hatchrect@xii\hatchrect@xi{-\hatchrect@dx}\Do{%
  \mTyokusen[l]{(\hatchrect@x,\hatchrect@yi)}{%
    (-\mhatchrect@x,\mhatchrect@y)}\hatchrect@xi\hatchrect@x}%
\fi
\if 1\hatchrect@h
\For\hatchrect@x\hatchrect@yi\hatchrect@yii\hatchrect@dx\Do{%
  \put(0,0){\sensyu(\hatchrect@xi,\hatchrect@x)(\hatchrect@xii,\hatchrect@x)}}%
\fi
\if 1\hatchrect@v
\For\hatchrect@x\hatchrect@xi\hatchrect@xii\hatchrect@dx\Do{%
  \put(0,0){\sensyu(\hatchrect@x,\hatchrect@yi)(\hatchrect@x,\hatchrect@yii)}}%
\fi
}%
%
% 訂正 \teisei の斜線位置の修正
%    \teisei[#1](#2)#3[#4]<#5>
%            #1: 線の引き方についてのオプション引数で，
%                s : 斜線（／） [デフォルト] S : 二重斜線
%                r : 斜線（＼）
%                x : クロス
%                h : 横線
%                d : 横二本線
%            #2: 線の色
%            #3: 線を引く対象
%            #4: 訂正後の文字列
%            #5: 斜線の位置を修正するベクトル
%                key=val の形式
%                   dLT=(dx,dy), dLB=, dRT=, dRB= 右辺値は pt を単位とする数値

\def\teisei{%
    \@ifnextchar[{\@teisei}{\@teisei[s]}}%
\def\@teisei[#1]{%
    \@ifnextchar({\@teisei@[#1]}{\@teisei@[#1](\empty)}}%
\def\@teisei@[#1](#2)#3{%
  \@ifnextchar[{\@@teisei[#1](#2)#3}{\@@teisei[#1](#2){#3}[\empty]}}%
\def\@@teisei[#1](#2)#3[#4]{\@ifnextchar<{\@@@teisei[#1](#2){#3}[#4]}{%
  \@@@teisei[#1](#2){#3}[#4]<\empty>}}
\def\@@@teisei[#1](#2)#3[#4]<#5>{{\unitlength\p@
  \ifmmode\setbox0\hbox{$#3$}\else\setbox0\hbox{#3}\fi
  \ifx\empty#4\relax{%
    \ifx\empty#2\else\color{#2}\fi%
    \begin{picture}(0,0)%
    \if#1h\relax
      \setlength{\templa}{\ht0-\dp0}\divide\templa by 2\relax
      \edef\LT{(0,\strip@pt\templa)}%
      \edef\RT{(\strip@pt\wd0,\strip@pt\templa)}%
    \else\if#1d\relax
      \setlength{\templa}{\ht0-\dp0}\divide\templa by 2\relax
      \setlength{\templb}{\templa}\addtolength{\templb}{-0.8pt}%
      \setlength{\templc}{\templa}\addtolength{\templc}{1.2pt}%
      \edef\LT{(0,\strip@pt\templc)}%
      \edef\RT{(\strip@pt\wd0,\strip@pt\templc)}%
      \edef\LB{(0,\strip@pt\templb)}%
      \edef\RB{(\strip@pt\wd0,\strip@pt\templb)}%
    \else
      \edef\LT{(0,\strip@pt\ht0)}%
      \edef\LB{(0,-\strip@pt\dp0)}%
      \edef\RT{(\strip@pt\wd0,\strip@pt\ht0)}%
      \edef\RB{(\strip@pt\wd0,-\strip@pt\dp0)}%
    \fi\fi
    \ifthenelse{\equal{#5}\empty}{}{\setkeys{emP}{#5}}%
    \if#1r\relax
        \Drawline{\LT\RB}%
    \else\if#1h\relax
        \Drawline{\LT\RT}%
    \else\if#1d\relax
        \Drawlines{\LT\RT;\LB\RB}%
    \else\if#1x\relax
        \Drawlines{\LB\RT;\LT\RB}%
    \else\if#1S\relax
        \put(0,1){\Drawline{\LB\RT}}%
        \put(0,-1){\Drawline{\LB\RT}}%
    \else
        \Drawline{\LB\RT}%
    \fi\fi\fi\fi\fi
    \end{picture}}\box0\relax
  \else%
  \ifmmode\setbox1\hbox{$#4$}\else\setbox1\hbox{#4}\fi
  \ensuremath{\stackrel{\box1}{{%
  \ifx\empty#2\else\color{#2}\fi%
  \begin{picture}(0,0)%
    \if#1r\relax
        \drawline(0,\strip@pt\ht0)(\strip@pt\wd0,-\strip@pt\dp0)%
    \else\if#1h\relax
        \setlength{\templa}{\ht0}\addtolength{\templa}{-\dp0}%
        \divide\templa by 2\relax
        \drawline(0,\strip@pt\templa)(\strip@pt\wd0,\strip@pt\templa)%
    \else\if#1d\relax
        \setlength{\templa}{\ht0}\addtolength{\templa}{-\dp0}%
        \divide\templa by 2\relax
        \setlength{\templb}{\templa}\addtolength{\templb}{-0.8pt}%
        \setlength{\templc}{\templa}\addtolength{\templc}{1.2pt}%
        \drawline(0,\strip@pt\templb)(\strip@pt\wd0,\strip@pt\templb)%
        \drawline(0,\strip@pt\templc)(\strip@pt\wd0,\strip@pt\templc)%
    \else\if#1S\relax
        \put(0,1){\Drawline{\LB\RT}}%
        \put(0,-1){\Drawline{\LB\RT}}%
    \else
        \drawline(0,-\strip@pt\dp0)(\strip@pt\wd0,\strip@pt\ht0)%
    \fi\fi\fi\fi
    \end{picture}}\box0\relax}}%
   \fi%
    }}%
%
%  \Teisei[#1](#2)#3[#4]#5<#6>
%            #1: 線の引き方についてのオプション引数で，
%                s : 斜線（／） [デフォルト]
%                r : 斜線（＼）
%                h : 横線
%                d : 横二本線
%            #2: 線の色
%            #3: 線を引く対象
%            #4: 訂正後の文字位置
%                   r = 右上 (=tr=rt)（デフォルト）
%                   l = 左上 (=tl=lt)
%                   t = 上
%                   b = 下
%                   rb=br=右下
%                   lb=bl=左下
%            #5: 訂正後の文字列 (scriptstyle)
%            #6: 斜線の位置を修正するベクトル
%
\def\Teisei{%
    \@ifnextchar[{\@Teisei}{\@Teisei[s]}}%
\def\@Teisei[#1]{%
    \@ifnextchar({\@Teisei@[#1]}{\@Teisei[#1](\empty)}}%
\def\@Teisei@[#1](#2)#3{%
  \@ifnextchar[{\@@Teisei[#1](#2){#3}}{\@@Teisei[#1](#2){#3}[r]}}%
\def\@@Teisei[#1](#2)#3[#4]#5{\@ifnextchar<{\@@@Teisei[#1](#2){#3}[#4]{#5}}{%
  \@@@Teisei[#1](#2){#3}[#4]{#5}<\empty>}}
\def\@@@Teisei[#1](#2)#3[#4]#5<#6>{{%
    \edef\mozi@iti{0}%
%                           4  0  2
%                            {#3}
%                           5  1  3
    \expandafter\@tfor\expandafter\@c\expandafter:\expandafter=#4%
    \do {\if r\@c\IAdd\mozi@iti{2}\mozi@iti\else
        \if l\@c\IAdd\mozi@iti{4}\mozi@iti\else
        \if b\@c\IAdd\mozi@iti{1}\mozi@iti\fi\fi\fi}%
    \ifx\empty#5\@teisei@[#1](#2){#3}{}<#6>\else%
    \ifcase\mozi@iti\overset{#5}{\@teisei@[#1](#2){#3}<#6>\relax}%
    \or\underset{#5}{\@teisei@[#1](#2){#3}<#6>\relax}%
    \or{\@teisei@[#1](#2){#3}<#6>\relax}^{\,{#5}}%
    \or{\@teisei@[#1](#2){#3}<#6>\relax}_{\,{#5}}%
    \or{}^{#5}{\@teisei@[#1](#2){#3}<#6>\relax}%
    \or{}_{#5}{\@teisei@[#1](#2){#3}<#6>\relax}\fi
    \fi}}%
%
% \rotatebox を利用して斜線を引く
%
\def\rotateline(#1,#2)(#3,#4){%
  \Subvec{(#3,#4)}{(#1,#2)}\rotateln@v
  \Argvec\rotateln@v\rotateln@arg
  \Absvec\rotateln@v\rotateln@len
  \put(#1,#2){\rotatebox{\rotateln@arg}{%
      \vrule \@height \@halfwidth \@depth \@halfwidth \@width \rotateln@len\unitlength}}%
}
\def\Rotateline#1{\edef\Rotateline@tmp{#1}\expandafter\rotateline\Rotateline@tmp}
%
% フォント
%
\def\heikousihenkei{{% 平行四辺形 epic が必要
  \unitlength=.11ex\relax
  \begin{picture}(17,12)%
    \tenretu*{HS@A(1,2);HS@B(11,2);HS@C(16,11);HS@D(6,11)}%
    \@tempdima=.008ex\relax
    \edef\HS@l{\strip@pt\@tempdima}%
    \Subvec\HS@C\HS@A\HS@AC\Mulvec\HS@l\HS@AC\HS@AC
    \Subvec\HS@D\HS@B\HS@BD\Mulvec\HS@l\HS@BD\HS@BD
    \Addvec\HS@A\HS@AC\HS@AA
    \Addvec\HS@B\HS@BD\HS@BB
    \Subvec\HS@C\HS@AC\HS@CC
    \Subvec\HS@D\HS@BD\HS@DD
    \Nuritubusi[\Nurizen]{\HS@A\HS@B\HS@C\HS@D\HS@A}%
    \Nuritubusi[0]{\HS@AA\HS@BB\HS@CC\HS@DD\HS@AA}%
    \Drawline{\HS@A\HS@B\HS@C\HS@D\HS@A}
    \Drawline{\HS@AA\HS@BB\HS@CC\HS@DD\HS@AA}
  \end{picture}}}%
%
% 一般の四角形を表す記号
\def\sikakkei{{\unitlength=.11ex\relax
  \begin{picture}(17,12)%
    \allinethickness{.1ex}%
    \drawline(1,2)(5,9)(12,12)(16,2)(1,2)%
  \end{picture}}}
%
% ⊿記号
\def\Deruta{{\unitlength=.11ex\relax
\begin{picture}(17,17)%
  \@tempdima=.005em\relax
%  \advance\@tempdima1.89pt\relax
  \advance\@tempdima1.2pt\relax
  \edef\Deruta@w{\strip@pt\@tempdima}%
  \Mul{.25}\Deruta@w\Deruta@ww
  \Add{1}\Deruta@w\Deruta@Ay
  \Mul{1.4142}\Deruta@ww\Deruta@wwii
  \Add\Deruta@Ay\Deruta@wwii\Deruta@Ax
  \edef\Deruta@A{(\Deruta@Ax,\Deruta@Ay)}%
  \Mul{.7683}\Deruta@w\Deruta@Bx
  \Sub{12}\Deruta@Bx\Deruta@Bx
  \edef\Deruta@B{(\Deruta@Bx,\Deruta@Ay)}%
  \Mul{3.881}\Deruta@w\Deruta@Cx
  \Add\Deruta@Cx\Deruta@wwii\Deruta@Cx
  \Mul{0.363636}\Deruta@Cx\Deruta@Cx
  \Sub{16}\Deruta@Cx\Deruta@Cx
  \Sub\Deruta@Cx\Deruta@wwii\Deruta@Cy
  \edef\Deruta@C{(\Deruta@Cx,\Deruta@Cy)}%
  \Nuritubusi[\Nurizen]{(1,1)(12,1)(16,16)(1,1)}%
  \Nuritubusi[0]{\Deruta@A\Deruta@B\Deruta@C\Deruta@A}%
  \allinethickness{0.2pt}\Drawline{(1,1)(12,1)(16,16)(1,1)}%
\end{picture}}}
%
\def\longrightleftarrows{\@ifnextchar[{\@longrightleftarrows}{\@longrightleftarrows[2]}}
\def\@longrightleftarrows[#1]{\mathrel{\scalebox{#1}[1]{$\rightleftarrows$}}}
%
% 別名
\let\Put\emathPut
\let\kyokuTyoku\Rdef
\let\Sinsyuku\Muldef
\let\Kaiten\Rotdef
\let\kaiten\rotdef
%
% 暫定措置
%    \RequirePackage{emathPb}%
%    \RequirePackage{emathPg}%
\endinput
