% emathPh.sty by tDB(emath@nifty.com)
%
\@ifundefined{ifpapersize}{\newif\ifpapersize\papersizefalse}{}%
%
%\def\em@grdrv{dvips}
  \NeedsTeXFormat{LaTeX2e}%
  \ProvidesPackage{emathPh}[2016/11/16 v 4.89]%
  \DeclareOption{notMy}{\def\not@My{}}%
  \DeclareOption{onlyP}{\def\P@nly{}}%
% \DeclareOption{times}{\def\@times{}}%
% \DeclareOption{txfonts}{\def\@txfonts{}}%
  \DeclareOption{times}{\def\em@fonts{1}}%
  \DeclareOption{txfonts}{\def\em@fonts{2}}%
  \DeclareOption{pxfonts}{\def\em@fonts{3}}%
  \DeclareOption{mathabx}{\def\em@fonts{4}}%
  \DeclareOption{varg}{\def\@varg{}}%
  \DeclareOption{usenames}{\def\em@color@names{}}%
  \DeclareOption{dviout}{\def\em@grdrv{dviout}}%
  \DeclareOption{dvips}{\def\em@grdrv{dvips}}%
  \DeclareOption{dvipdfm}{\def\em@grdrv{dvipdfm}}%
  \DeclareOption{dvipdfmx}{\def\em@grdrv{dvipdfmx}}%
  \DeclareOption{EMdvipsk}{\def\em@dvipsk{}}%
  \DeclareOption{EMdvipdfm}{\def\em@dvipdfm{}}%
  \DeclareOption{EMdvipdfmx}{\def\em@dvipdfm{x}}%
  \DeclareOption{monochrome}{\def\em@monochrome{}}%
  \DeclareOption{papersize}{\papersizetrue}%
  \DeclareOption{notpic}{\def\not@tpic{}}%
  \DeclareOption{tenretu}{\def\load@tenretu{}}%
  \ProcessOptions\relax
\@ifundefined{@nly}{}{\def\P@nly{}}%
\@ifundefined{P@nly}{%
    \@ifundefined{emath@Ps}{%
      \@ifundefined{not@tpic}{%
        \RequirePackage{epic}%
        \RequirePackage{eepic}%
        \let\tpic@arc\arc
        \@ifundefined{Mw@silent}{\typeout{load eepic}}{}%
      }{}%
    }{}%
%%   \RequirePackage{fp}%
%%   \FPmessagesfalse
%%   \RequirePackage{array}%
%    \RequirePackage{eclarith}%
%%
%
    \def\dvipdfmx@temp{dvipdfmx.def}%
    \ifx\Gin@driver\dvipdfmx@temp\def\em@grdrv{dvipdfmx}\fi
%
    \let\revised@For\@undefined
%    \RequirePackage{emath}%
    \@ifpackageloaded{emath}{}{\RequirePackage{emath}}%
%    \RequirePackage{EMhairetu}%
    \@ifundefined{em@grdrv}{%
      \RequirePackage{keyval}%
      \RequirePackage{trig}%
%      \RequirePackage{graphicx}%
%      \@ifundefined{em@monochrome}{%
%        \@ifundefined{em@color@names}{%
%          \RequirePackage{color}%
%        }{%
%          \RequirePackage[usenames]{color}%
%        }%
%      }{%
%        \RequirePackage[monochrome]{color}%
%      }%
    }{%
      \@ifpackageloaded{graphicx}{}{\RequirePackage[\em@grdrv]{graphicx}}%
      \@ifpackageloaded{color}{}{%
        \@ifundefined{em@monochrome}{%
          \@ifundefined{em@color@names}{%
            \RequirePackage[\em@grdrv]{color}%
          }{%
            \RequirePackage[\em@grdrv,usenames]{color}%
          }%
        }{%
          \RequirePackage[monochrome,\em@grdrv]{color}%
        }%
      }%
    }%
}{\RequirePackage{emathC}}%
%
\@ifundefined{color}{}{\RequirePackage{EMcolor}}%
%
\def\@devextension{def}
\def\@ifdevloaded{\@ifl@aded\@devextension}
\def\em@gdrv@num{-1}
\@ifdevloaded{dvips}{\def\em@gdrv@num{0}}{}
\@ifdevloaded{dvipdfm}{\def\em@gdrv@num{1}}{}
\@ifdevloaded{dvipdfmx}{\def\em@gdrv@num{2}}{}
\@ifdevloaded{dviout}{\def\em@gdrv@num{3}}{}
%
%
\newif\ifdrawaxis\drawaxistrue%
\newif\ifhan@inai
\newif\ifEMpscontinue\EMpscontinuefalse
\newdimen\@tempdimd%
\edef\byouga@dousa{s}%
\let\sensyu\drawline% デフォルトは実線
%
\def\wholelinewidth{\the\@wholewidth}%
\def\halflinewidth{\the\@halfwidth}%
%
\def\arrow@headsize{1}%
\let\ltxpicture\picture
\let\endltxpicture\endpicture
\def\picture{\edef\xmin{0}\edef\ymin{0}\@ifnextchar[{\@Phpicture}{\@Phpicture[\empty]}}%
\def\@Phpicture[#1](#2,#3){%
  \Strchr{#1}{=}\zahyou@tmp
  \ifnum\zahyou@tmp>\z@\setkeys{emP}{#1}\fi
  \def\O{(0,0)}%
  \def\O@@{(0,0)}%
  \edef\xmin{0}\edef\ymin{0}%
  \changeArrowHeadSize{1}\ltxpicture(#2,#3)}%
%\def\picture{%
%  \changeArrowHeadSize{1}\def\O{(0,0)}\def\O@@{(0,0)}\edef\xmin{0}\edef\ymin{0}\ltxpicture}%
\edef\local@origin{(0,0)}%
\def\EMps@mode{0}%
\def\by@perl@{0}%
\def\by@perl{0}%
\def\by@perl@retu{\by@perl@}%
\def\byperl#1{\def\by@perl@{#1}}%
\def\by@fpcalc{0}%
%
\define@key{emP}{includeEPS}{\csname include@eps#1\endcsname}%
\define@key{emP}{debug}[1]{\def\ps@debug@{#1}}%
\define@key{emP}{remake}[1]{\def\remake@eps{#1}}%
\define@key{emP}{final}[0]{\edef\remake@eps{0}}%
\define@key{emP}{remakefalse}[0]{\edef\remake@eps{0}}%
\define@key{emP}{pdf}[1]{\def\by@pdf{#1}}%
\define@key{emP}{PDF}[0]{\def\by@pdf{#1}}%
\define@key{emP}{eps}[0]{\let\by@pdf\undefined}%
\define@key{emP}{epspdf}[0]{\def\eps@pdf{}}%
\define@key{emP}{prezahyou}[1]{#1}%
\define@key{emP}{EPSfilename}{\def\EMps@filename{#1}}%
\define@key{emP}{EPSclip}{\def\EMps@clip{#1}}%
\define@key{emP}{owariT}[owariT]{\def\YG@owariT{#1}}%
\define@key{emPs}{owariT}[owariT]{\def\YG@owariT{#1}}%
\define@key{emP}{boutyou}{\edef\boutyou@size{#1}}%
\define@key{emP}{boutyou}{\edef\boutyou@size{#1}}%
\define@key{emP}{hazimeT}[hazimeT]{\def\YG@hazimeT{#1}}%
\define@key{emP}{hazimeM}{\def\YG@hazimeM{#1}}%
\define@key{emPs}{hazimeM}{\def\YG@hazimeM{#1}}%
\define@key{emP}{owariM}{\def\YG@owariM{#1}}%
\define@key{emPs}{owariM}{\def\YG@owariM{#1}}%
\define@key{emP}{dousa}{\def\byouga@dousa{#1}}%
\define@key{emP}{showlabel}[.8em]{\def\show@label{#1}}%
\define@key{emP}{nahuda}[.8em]{\def\show@label{#1}}%
\define@key{emPs}{includeEPS}{\csname include@eps#1\endcsname}%
\define@key{emPs}{debug}[1]{\def\ps@debug@{#1}}%
\define@key{emPs}{remake}[1]{\def\remake@eps{#1}}%
\define@key{emPs}{final}[0]{\edef\remake@eps{0}}%
\define@key{emPs}{remakefalse}[0]{\edef\remake@eps{0}}%
\define@key{emPs}{pdf}[1]{\def\by@pdf{#1}}%
\define@key{emPs}{PDF}[0]{\def\by@pdf{#1}}%
\define@key{emPs}{eps}[0]{\let\by@pdf\undefined}%
\define@key{emPs}{epspdf}[0]{\def\eps@pdf{}}%
\define@key{emPs}{prezahyou}[1]{#1}%
\define@key{emPs}{EPSfilename}{\def\EMps@filename{#1}}%
\define@key{emPs}{EPSclip}{\def\EMps@clip{#1}}%
\define@key{emPs}{owariT}[owariT]{\def\YG@owariT{#1}}%
\define@key{emPs}{owariT}[owariT]{\def\YG@owariT{#1}}%
\define@key{emPs}{boutyou}{\edef\boutyou@size{#1}}%
\define@key{emPs}{boutyou}{\edef\boutyou@size{#1}}%
\define@key{emPs}{hazimeT}[hazimeT]{\def\YG@hazimeT{#1}}%
\define@key{emPs}{dousa}{\def\byouga@dousa{#1}}%
\define@key{emPs}{showlabel}[.8em]{\def\show@label{#1}}%
\define@key{emPs}{nahuda}[.8em]{\def\show@label{#1}}%
%\define@key{emP}{dash}{%
%  \headchar{#1}\dash@a\dash@b
%  \ifthenelse{\equal{\dash@a}{[}}{%
%    \edef\dash@tmp{#1}\expandafter\setdash\dash@tmp}{%
%    \setdash{#1}}%
%  }%
\define@key{emP}{dash}{%
  \headchar{#1}\Dash@a\Dash@b
  \ifthenelse{\equal{\Dash@a}{[}}{%
    \edef\Dash@tmp{#1}\expandafter\setdash\Dash@tmp}{%
    \setdash{#1}}%
  }%
%
    \def\setd@sh{\protect\@setd@sh}%
    \def\@setd@sh{\@ifnextchar[{\@@setd@sh}{\@@setd@sh[0]}}%
    \def\@@setd@sh[#1]#2{%
      \ifthenelse{\equal{#2}\empty}{%
        \edef\cur@dash{}\edef\cur@dashoffset{0}}{%
        \edef\cur@dash{#2}\edef\cur@dashoffset{#1}%
      }}%
%
\define@key{emP}{xmax}{\edef\xmax{#1}}%
\define@key{emP}{xmin}{\edef\xmin{#1}}%
\define@key{emP}{ymax}{\edef\ymax{#1}}%
\define@key{emP}{ymin}{\edef\ymin{#1}}%
\define@key{emP}{borderwidth}{\def\border@width{#1}}%
\define@key{emP}{waku}[1]{\def\ph@drawwaku{#1}}%
\define@key{emP}{frame}[1]{\def\ph@drawwaku{#1}\def\dp@frame{#1}}%
\define@key{emP}{stroke}{\def\EMps@stroke{#1}}%
\define@key{emP}{continue}{\def\EMps@continue{#1}}%
\define@key{emP}{yokozikukigou}{\def\yokozikukigou{#1}}%
\define@key{emP}{tatezikukigou}{\def\tatezikukigou{#1}}%
\define@key{emP}{gentenkigou}{\def\gentenkigou{#1}}%
%\define@key{emP}{yokozikuhaiti}{\def\yokozikuhaiti{#1}}%
%\define@key{emP}{tatezikuhaiti}{\def\tatezikuhaiti{#1}}%
\define@key{emP}{yokozikuhaiti}{%
    \headchar{#1}\houi@h\houi@r
    \if [\houi@h
      \def\yokozikuhaiti{#1}
    \else\if (\houi@h
      \def\yokozikuhaiti{#1}
    \else
      \def\yokozikuhaiti{[#1]}
    \fi\fi
}%
\define@key{emP}{tatezikuhaiti}{%
    \headchar{#1}\houi@h\houi@r
    \if [\houi@h
      \def\tatezikuhaiti{#1}
    \else\if (\houi@h
      \def\tatezikuhaiti{#1}
    \else
      \def\tatezikuhaiti{[#1]}
    \fi\fi
}%
%\define@key{emP}{gentenhaiti}{\def\gentenhaiti{#1}}%
\define@key{emP}{gentenhaiti}{%
    \headchar{#1}\houi@h\houi@r
    \if [\houi@h
      \def\gentenhaiti{#1}
    \else\if (\houi@h
      \def\gentenhaiti{#1}
    \else
      \def\gentenhaiti{[#1]}
    \fi\fi
}%
\define@key{emP}{memorinagasa}{\def\memori@nagasa{#1}}%
\def\setunitlength#1{\edef\unit@length{#1}\setlength{\unitlength}{#1}}%
\define@key{emP}{ul}{\edef\unit@length{#1}\setlength{\unitlength}{#1}}%
\define@key{emP}{haiti}{%
  \headchar{#1}\haiti@h\haiti@r
  \edef\zahyou@haiti{\haiti@h}%
  \edef\zahyou@haiti@hosei{\haiti@r}%
  }%
\define@key{emP}{ueyohaku}{\def\def@yohaku{}\ukansan{#1}\ue@yohaku}%
\define@key{emP}{Ueyohaku}{\def\def@yohaku{}\ukansan{#1}\ue@yohaku
  \@ifundefined{@yscale}{}{\Divself\ue@yohaku\@xscale}}%
\define@key{emP}{sitayohaku}{\def\def@yohaku{}\ukansan{#1}\sita@yohaku}%
\define@key{emP}{Sitayohaku}{\def\def@yohaku{}\ukansan{#1}\sita@yohaku
  \@ifundefined{@yscale}{}{\Divself\sita@yohaku\@yscale}}%
\define@key{emP}{migiyohaku}{\def\def@yohaku{}\ukansan{#1}\migi@yohaku}%
\define@key{emP}{Migiyohaku}{\def\def@yohaku{}\ukansan{#1}\migi@yohaku
  \@ifundefined{@xscale}{}{\Divself\migi@yohaku\@xscale}}%
\define@key{emP}{Hidariyohaku}{\def\def@yohaku{}\ukansan{#1}\hidari@yohaku
  \@ifundefined{@xscale}{}{\Divself\hidari@yohaku\@xscale}}%
\define@key{emP}{hidariyohaku}{\def\def@yohaku{}\ukansan{#1}\hidari@yohaku}%
\define@key{emP}{Yohaku}{\def\def@yohaku{}\ukansan{#1}\ue@yohaku\relax
                         \edef\sita@yohaku{\ue@yohaku}%
                         \ukansan{#1}\hidari@yohaku
                         \edef\migi@yohaku{\hidari@yohaku}%
                        }%
\define@key{emP}{yohaku}{\def\def@yohaku{}\ukansan{#1}\ue@yohaku\relax
                         \edef\sita@yohaku{\ue@yohaku}%
                         \ukansan{#1}\hidari@yohaku
                         \edef\migi@yohaku{\hidari@yohaku}%
                        }%
\define@key{emP}{arrowheadsize}{\def\arrow@headsize{#1}}%
\define@key{emP}{arrowheadL}{\def\Arrowhead@L{#1}}%
\define@key{emP}{arrowheadW}{\def\Arrowhead@W{#1}}%
\define@key{emP}{zikusensyu}{\def\zikusensyu{#1}}%
%
\define@key{emP}{radian}[1]{\def\Rdef@rad{#1}}%
\define@key{emP}{hasen}{\def\hasen@opt{#1}}%
\define@key{emPs}{hasen}{\def\hasen@opt{#1}}%
\define@key{emP}{hasenLG}{%
%
  \ifthenelse{\equal{#1}{\empty}}{%
    \edef\hasenLG@opt{\empty}%
    \ifnum\EMps@mode=\@ne
      \setdash{}%
    \else
      \let\sensyu\drawline
    \fi
  }{%
    \edef\hasenLG@opt{#1}%
    \vecXY{(#1)}\@hasen@x\@hasen@y
    \ukansan\@hasen@x\@hasen@x@
    \ukansan\@hasen@y\@hasen@y@
    \setlength{\@tempdima}{\@hasen@x@\unitlength}%
      \edef\@hasen@L{\the\@tempdima}% 
    \setlength{\@tempdima}{\@hasen@y@\unitlength}%
      \edef\@hasen@G{\the\@tempdima}% 
    \edef\hasen@opt{[\@hasen@x@][\@hasen@y@]}%
    \ifnum\EMps@mode=\@ne
      \setdash{#1}%
    \else
      \let\sensyu\hasen
    \fi
  }%
}%
\define@key{emP}{ten}{\def\ten@kosuu{#1}}%
\define@key{emPs}{ten}{\def\ten@kosuu{#1}}%
\define@key{emP}{yazirusi}[a]{\edef\yazirusi@opt{#1}}%
\define@key{emP}{sensyu}{\def\sensyu{#1}}%
\define@key{emP}{putoption}{\edef\put@opt{#1}}%
\define@key{emPs}{putoption}{\edef\put@opt{#1}}%
\define@key{emP}{nextopt}{\EMedef\next@opt{#1}}%
\define@key{emPs}{nextopt}{\EMedef\next@opt{#1}}%
\define@key{emP}{pos}{\def\@pos{#1}}%
\define@key{emP}{haitiT}{\def\haiti@T{#1}}%
\define@key{emP}{border}[1]{\edef\draw@border{#1}}%
\define@key{emP}{drawborder}[1]{\edef\draw@border{#1}}%
\edef\draw@border{\empty}%
\def\drawborder#1{\edef\draw@border{#1}}%
\define@key{emP}{noudo}{\def\noudo@{#1}}%
\define@key{emP}{syanurisiteiten}{\def\syanuri@siteiten{#1}%
  \Subvec\syanuri@siteiten\local@origin\syanuri@siteiten}%
\define@key{emP}{syasenkankaku}{\def\syanuri@kankaku{#1}}%
\define@key{emP}{syasenKankaku}{\ukansan{#1}\syanuri@kankaku}%
%  \@ifundefined{yunitlength}{\ukansan{#1}\syanuri@kankaku}{%
%  \kansan{#1}{\yunitlength}\syanuri@kankaku}}%
\define@key{emP}{syanurikankaku}{\def\syanuri@kankaku{#1}}%
\define@key{emP}{syanuriKankaku}{\ukansan{#1}\syanuri@kankaku}%
%\define@key{emP}{syanuriKankaku}{%
%  \@ifundefined{yunitlength}{\ukansan{#1}\syanuri@kankaku}{%
%  \kansan{#1}{\yunitlength}\syanuri@kankaku}}%
\define@key{emP}{slashspace}{\uykansan{#1}\syanuri@kankaku}%
%  \@ifundefined{yunitlength}{\ukansan{#1}\syanuri@kankaku}{%
%  \kansan{#1}{\yunitlength}\syanuri@kankaku}}%
\define@key{emP}{slash_space}{\uykansan{#1}\syanuri@kankaku}%
%\define@key{emP}{slash_space}{%
%  \@ifundefined{yunitlength}{\ukansan{#1}\syanuri@kankaku}{%
%  \kansan{#1}{\yunitlength}\syanuri@kankaku}}%
\define@key{emP}{weight}{\def\LandL@w{#1}}%
    \define@key{emP}{tuukaten}{\Kyori{#1}{\@tyuusin}\@hankei}%
    \define@key{emP}{hazimeten}{%
      \Subvec{#1}{\@tyuusin}\Enk@tmp\Argvec\Enk@tmp\hazime@kaku
%\typeout{hazimeten:arg=#1,tyuusin=\@tyuusin,kaku=\hazime@kaku}\xxx
      }%
    \define@key{emP}{owariten}{%
      \Subvec{#1}{\@tyuusin}\Enk@tmp\Argvec\Enk@tmp\owari@kaku
      \ifdim\owari@kaku pt<\hazime@kaku pt\Add{360}\owari@kaku\owari@kaku\fi}%
\define@key{emP}{syasentanmatu}{\def\syasen@tanmatu{#1}}%
\define@key{emP}{syanuriTanmatu}{\def\syasen@tanmatu{#1}}%
\define@key{emP}{parindent}{\setlength\parindent{#1}}%
\define@key{emP}{allinethickness}{\allinethickness{#1}}%
\define@key{emP}{linethickness}{\linethickness{#1}}%
\define@key{emP}{borderthickness}{\edef\draw@border{1}\linethickness{#1}}%
\edef\nuri@iro{\empty}%
\edef\nuri@iro@{\empty}%
\define@key{emP}{nuriiro}{\edef\nuri@iro{#1}}%
\define@key{emP}{paintcolor}{\edef\nuri@iro{#1}}%
\define@key{emP}{paintoption}{\edef\paint@option{#1}}%
\define@key{emP}{iro}{\edef\iro@{#1}}%
\define@key{emP}{color}{\edef\iro@{#1}}%
\define@key{emP}{bordercolor}{\edef\draw@border{1}\edef\iro@{#1}}%
\define@key{emP}{framecolor}{\edef\draw@border{1}\edef\iro@{#1}}%
\define@key{emP}{slashcolor}{\edef\slash@color{#1}}%
\define@key{emP}{kuromaru}[1]{\edef\put@kuromaru{#1}}%
\define@key{emP}{siromaru}[1]{\let\@nahudaKuromaru\Siromaru
                                \Siromarulinewidth{.3pt}%
                                \edef\put@kuromaru{#1}}%
\define@key{emP}{blackC}[1]{\edef\put@kuromaru{#1}}%
\define@key{emP}{vmark}{\def\v@mark{#1}}%
\define@key{emP}{takasa}{\def\takas@{#1}}%
\define@key{emP}{dLT}{\edef\d@LT{#1}}%
\define@key{emP}{dLB}{\edef\d@LB{#1}}%
\define@key{emP}{dRT}{\edef\d@RT{#1}}%
\define@key{emP}{dRB}{\edef\d@RB{#1}}%
%\define@key{emP}{dLB}{\Addvec\LB{#1}\LB}%
%\define@key{emP}{dRT}{\Addvec\RT{#1}\RT}%
%\define@key{emP}{dRB}{\Addvec\RB{#1}\RB}%
\define@key{emP}{DLT}{\vecXY{#1}\emP@x\emP@y
  \ukansan\emP@x\emP@x\ukansan\emP@y\emP@y
  \Addvec\LT{(\emP@x,\emP@y)}\LT}%
\define@key{emP}{DLB}{\vecXY{#1}\emP@x\emP@y
  \ukansan\emP@x\emP@x\ukansan\emP@y\emP@y
  \Addvec\LB{(\emP@x,\emP@y)}\LB}%
\define@key{emP}{DRT}{\vecXY{#1}\emP@x\emP@y
  \ukansan\emP@x\emP@x\ukansan\emP@y\emP@y
  \Addvec\RT{(\emP@x,\emP@y)}\RT}%
\define@key{emP}{DRB}{\vecXY{#1}\emP@x\emP@y
  \ukansan\emP@x\emP@x\ukansan\emP@y\emP@y
  \Addvec\RB{(\emP@x,\emP@y)}\RB}%
\define@key{emP}{bairitu}{\def\@bairitu{#1}}%
\define@key{emP}{muki}{\def\@muki{#1}}%
\define@key{emP}{hazimekaku}{\def\@hazimekaku{#1}}%
\define@key{emP}{owarikaku}{\def\@owarikaku{#1}}%
\define@key{emP}{tyouhankei}{\def\@tyouhankei{#1}}%
\define@key{emP}{tanhankei}{\def\@tanhankei{#1}}%
\define@key{emP}{perl}[1]{\def\by@perl{#1}}%
\define@key{emP}{fp}[1]{\let\retu@calcval\fpcalcval
  \def\by@perl{#1}\def\by@fpcalc{#1}}%
\define@key{emP}{skip}[0]{\def\save@perldata{#1}}%
\define@key{emP}{oresen}{\def\oresen@name{#1}}%
\define@key{emP}{hairetu}{\def\hairetu@name{#1}}%
\define@key{emP}{hairetumei}{\def\hairetu@name{#1}}%
\define@key{emP}{Henvi}{\vecXY{#1}\henvi@x\henvi@y\ukansan\henvi@x\henvi@x\ukansan\henvi@y\henvi@y
                        \edef\hen@i{(\henvi@x,\henvi@y)}}%
\define@key{emP}{Henvii}{\vecXY{#1}\henvi@x\henvi@y\ukansan\henvi@x\henvi@x\ukansan\henvi@y\henvi@y
                        \edef\hen@ii{(\henvi@x,\henvi@y)}}%
\define@key{emP}{henvi}{\def\hen@i{#1}}%
\define@key{emP}{henvii}{\def\hen@ii{#1}}%
\define@key{emP}{idou}{%
  \def\idou@vtmp{#1}\Headchar\idou@vtmp\idou@h\idou@dmy
  \if r\idou@h
    \vecXY\idou@dmy\idou@r\idou@arg\ukansan\idou@r\idou@r
    \DegCos\idou@arg\idou@c\Mul\idou@r\idou@c\idou@x
    \DegSin\idou@arg\idou@s\Mul\idou@r\idou@s\idou@y
  \else
    \vecXY\idou@vtmp\idou@x\idou@y
  \fi
  \uxkansan\idou@x\idou@x\uykansan\idou@y\idou@y
  \edef\idou@v{(\idou@x,\idou@y)}}%
%
\define@key{emP}{modifystr}{\def\modify@str{#1}}%
\define@key{emP}{inix}{\def\YG@xo{#1}}%
\define@key{emP}{minx}{\def\YG@xl{#1}}%
\define@key{emPs}{minx}{\def\YG@xl{#1}}%
\define@key{emP}{miny}{\def\YG@xl{#1}}%
\define@key{emP}{maxx}{\def\YG@xr{#1}}%
\define@key{emPs}{maxx}{\def\YG@xr{#1}}%
\define@key{emP}{maxy}{\def\YG@xr{#1}}%
\define@key{emP}{infx}{\edef\YG@xl{#1+\YG@unit}}%
\define@key{emP}{supx}{\edef\YG@xr{#1-\YG@unit}}%
\define@key{emP}{infy}{\edef\YG@xl{#1+\YG@unit}}%
\define@key{emP}{supy}{\edef\YG@xr{#1-\YG@unit}}%
%
\define@key{emP}{phzoption}{\def\phz@option{#1}}%
%
\define@key{emP}{mathmode}[1]{\edef\Put@math{#1}}%
%
%\define@key{emP}{dash}{%
%  \headchar{#1}\dash@a\dash@b
%  \ifthenelse{\equal{\dash@a}{[}}{%
%    \edef\dash@tmp{#1}\expandafter\setdash\dash@tmp}{%
%    \setdash{#1}}%
%  }%
%
%    \def\setdash{\protect\@setdash}%
%    \def\@setdash{\@ifnextchar[{\@@setdash}{\@@setdash[0]}}%
%    \def\@@setdash[#1]#2{%
%      \ifthenelse{\equal{#2}\empty}{%
%        \edef\cur@dash{}\edef\cur@dashoffset{0}}{%
%        \edef\cur@dash{#2}\edef\cur@dashoffset{#1}%
%      }}%
%
%
\def\zM@linethickness@{.4pt}%
\def\gridlinethickness#1{\edef\zM@linethickness@{#1}}%
%\define@key{emPzM}{xo}{\edef\zM@xo{#1}}%
%\define@key{emPzM}{yo}{\edef\zM@yo{#1}}%
%\define@key{emPzM}{dx}{\edef\zM@dx{#1}}%
%\define@key{emPzM}{dy}{\edef\zM@dy{#1}}%
        \define@key{emPzM}{xo}{%
          \ifnum\by@perl>\z@
            \calcval{#1}\zM@xo
          \else
            \edef\zM@xo{#1}%
          \fi
        }%
        \define@key{emPzM}{yo}{%
          \ifnum\by@perl>\z@
            \calcval{#1}\zM@yo
          \else
            \edef\zM@yo{#1}%
          \fi
          }%
        \define@key{emPzM}{dx}{%
          \ifnum\by@perl>\z@
            \calcval{#1}\zM@dx
          \else
            \edef\zM@dx{#1}%
          \fi
        }%
        \define@key{emPzM}{dy}{%
          \ifnum\by@perl>\z@
            \calcval{#1}\zM@dy
          \else
            \edef\zM@dy{#1}%
          \fi
        }%
\define@key{emPzM}{ymemoriiti}{\edef\y@memoriiti{#1}}%
\define@key{emPzM}{xmemoriiti}{\edef\x@memoriiti{#1}}%
\define@key{emPzM}{memorinagasa}{%
      \Strsep{#1}{,}\memori@nagasai\memori@nagasaii
      \uxkansan\memori@nagasai\memori@nagasaxi
      \uykansan\memori@nagasai\memori@nagasayi
      \ifx\empty\memori@nagasaii
        \let\memori@nagasaxii\memori@nagasaxi
        \let\memori@nagasayii\memori@nagasayi
        \edef\memori@nagasaxi{-\memori@nagasaxii}%
        \edef\memori@nagasayi{-\memori@nagasayii}%
      \else
        \uxkansan\memori@nagasaii\memori@nagasaxii
        \uykansan\memori@nagasaii\memori@nagasayii
      \fi
}%
\define@key{emPzM}{sensyu}{\def\zM@sensyu{#1}}%
\define@key{emPzM}{linethickness}{\edef\zM@linethickness{#1}}%
\define@key{emPzM}{linewidth}{\edef\zM@linethickness{#1}}%
\define@key{emPzM}{allinethickness}{\edef\zM@linethickness{#1}}%
\define@key{emPzM}{hasenLG}{%
      \edef\hasenLG@opt{#1}%
      \setdash{#1}%
      \ifthenelse{\equal{#1}{\empty}}{%
        \let\sensyu\drawline
      }{%
        \let\sensyu\pshasen
      }%
}%
\define@key{emPzM}{dash}{%
          \headchar{#1}\dash@a\dash@b
          \ifthenelse{\equal{\dash@a}{[}}{%
            \edef\dash@tmp{#1}\expandafter\setdash\dash@tmp}{%
            \setdash{#1}}%
}%
%
\def\dx@default{.05}%
\def\dt@default{.02}%
\def\dxdefault#1{\ukansan{#1}\dx@default}%
\def\dtdefault#1{\ukansan{#1}\dt@default}%
%
\define@key{emGurafu}{hidarix}{\def\YG@xl{#1}}%
\define@key{emGurafu}{migix}{\def\YG@xr{#1}}%
\define@key{emGurafu}{uey}{\def\XGurafu@yt{#1}}%
\define@key{emGurafu}{sitay}{\def\XGurafu@yb{#1}}%
\define@key{emGurafu}{hazimet}{\def\BGurafu@ts{#1}}%
\define@key{emGurafu}{owarit}{\def\BGurafu@te{#1}}%
\define@key{emGurafu}{xformat}{\def\x@format{#1}}%
\define@key{emGurafu}{yformat}{\def\y@format{#1}}%
\define@key{emGurafu}{iro}{\def\iro@{#1}}%
\define@key{emGurafu}{color}{\def\iro@{#1}}%
\define@key{emGurafu}{allinethickness}{\allinethickness{#1}}%
\define@key{emGurafu}{linethickness}{\linethickness{#1}}%
\define@key{emGurafu}{perl}[1]{\def\by@perl{#1}}%
\define@key{emGurafu}{infx}{\edef\YG@xl{#1+\YG@unit}}%
\define@key{emGurafu}{supx}{\edef\YG@xr{#1-\YG@unit}}%
\define@key{emGurafu}{infy}{\edef\YG@xl{#1+\YG@unit}}%
\define@key{emGurafu}{supy}{\edef\YG@xr{#1-\YG@unit}}%
\define@key{emGurafu}{inix}{\def\YG@xo{#1}}%
\define@key{emGurafu}{minx}{\def\YG@xl{#1}}%
\define@key{emGurafu}{miny}{\def\YG@xl{#1}}%
\define@key{emGurafu}{hazimex}{\def\YG@xl{#1}}%
\define@key{emGurafu}{maxx}{\def\YG@xr{#1}}%
\define@key{emGurafu}{maxy}{\def\YG@xr{#1}}%
\define@key{emGurafu}{owarix}{\def\YG@xr{#1}}%
\define@key{emGurafu}{hidariT}[hidariT]{\edef\YG@hidariT{#1}}%
\define@key{emGurafu}{sitaT}[sitaT]{\edef\YG@hidariT{#1}}%
\define@key{emGurafu}{hidarit}[hidarit]{\edef\YG@hidarit{#1}}%
\define@key{emGurafu}{leftP}[leftP]{\edef\YG@hidariT{#1}}%
\define@key{emGurafu}{migiT}[migiT]{\edef\YG@migiT{#1}}%
\define@key{emGurafu}{migiM}{\EMedef\YG@migiM{#1}}%
\define@key{emGurafu}{hidariM}{\EMedef\YG@hidariM{#1}}%
\define@key{emGurafu}{ueT}[ueT]{\EMedef\YG@migiT{#1}}%
\define@key{emGurafu}{ueM}{\EMedef\YG@migiM{#1}}%
\define@key{emGurafu}{sitaM}{\EMedef\YG@hidariM{#1}}%
\define@key{emGurafu}{migit}[migit]{\EMedef\YG@migit{#1}}%
\define@key{emGurafu}{func}[func]{\def\YG@func{#1}}%
\define@key{emGurafu}{rightP}[rightP]{\def\YG@migiT{#1}}%
\define@key{emGurafu}{point}{\def\YG@point{#1}}%
\define@key{emGurafu}{setten}[setten]{\def\YG@point{#1}}%
\define@key{emGurafu}{sessen}[sessen]{\def\YG@sessen{#1}}%
\define@key{emGurafu}{sessencsv}[sessencsv]{\def\YG@sessencsv{#1}}%
\define@key{emGurafu}{housen}[housen]{\def\YG@housen{#1}}%
\define@key{emGurafu}{housencsv}[housencsv]{\def\YG@housencsv{#1}}%
\define@key{emGurafu}{xval}[xval]{\def\YG@xval{#1}}%
\define@key{emGurafu}{yval}[yval]{\def\YG@yval{#1}}%
\define@key{emGurafu}{lim}{\def\emLlim{#1}}%
\define@key{emGurafu}{Llim}{\def\emLlim{#1}}%
\define@key{emGurafu}{emLlim}{\def\emLlim{#1}}%
\define@key{emGurafu}{nextopt}{\EMedef\next@opt{#1}}%
\define@key{emGurafu}{nextoption}{\EMedef\next@opt{#1}}%
\define@key{emGurafu}{dx}{%
  \ifthenelse{\equal{#1}{*}}{%
    \edef\YG@auto{*}%
  }{%
    \ifthenelse{\equal{#1}{-}}{%
      \Mul\YG@unit{-1}\YG@unit
    }{%
      \def\YG@unit{#1}%
    }%
  }%
}%
\define@key{emGurafu}{dy}{%
  \ifthenelse{\equal{#1}{*}}{%
    \edef\YG@auto{*}%
  }{%
    \ifthenelse{\equal{#1}{-}}{%
      \Mul\YG@unit{-1}\YG@unit
    }{%
      \def\YG@unit{#1}%
    }%
  }%
}%
\define@key{emGurafu}{inft}{\edef\YG@xl{#1+\YG@unit}}%
\define@key{emGurafu}{tinf}{\edef\YG@xl{#1+\YG@unit}}%
\define@key{emGurafu}{supt}{\edef\YG@xr{#1-\YG@unit}}%
\define@key{emGurafu}{tsup}{\edef\YG@xr{#1-\YG@unit}}%
\define@key{emGurafu}{tmin}{\isnumber{#1}{\def\YG@xl{#1}}{%
	\calcval{#1}\YG@xl}}%
\define@key{emGurafu}{mint}{\isnumber{#1}{\def\YG@xl{#1}}{%
	\calcval{#1}\YG@xl}}%
\define@key{emGurafu}{tmax}{\isnumber{#1}{\def\YG@xr{#1}}{%
	\calcval{#1}\YG@xr}}%
\define@key{emGurafu}{maxt}{\isnumber{#1}{\def\YG@xr{#1}}{%
	\calcval{#1}\YG@xr}}%
\define@key{emGurafu}{kukan}{\EMedef\YG@kukan{#1}}%
\define@key{emGurafu}{kiretto}{\EMedef\YG@gap{#1}}%
\define@key{emGurafu}{dt}{%
  \ifthenelse{\equal{#1}{*}}{%
    \edef\YG@auto{*}%
  }{%
    \def\YG@unit{#1}%
  }%
}%
\define@key{emGurafu}{bekizyun}{\edef\beki@zyun{#1}}%
\define@key{emGurafu}{kizyunten}{\edef\kizyun@ten{#1}}%
\define@key{emGurafu}{nuriiro}{\edef\nuri@iro{#1}}%
\define@key{emGurafu}{paintcolor}{\edef\nuri@iro{#1}}%
\define@key{emGurafu}{sensyu}{\def\sensyu{#1}}%
\define@key{emGurafu}{hasenLG}{%
%
  \ifthenelse{\equal{#1}{\empty}}{%
    \edef\hasenLG@opt{\empty}%
    \ifnum\EMps@mode=\@ne
      \setdash{}%
    \else
      \let\sensyu\drawline
    \fi
  }{%
    \edef\hasenLG@opt{#1}%
    \vecXY{(#1)}\@hasen@x\@hasen@y
    \ukansan\@hasen@x\@hasen@x@
    \ukansan\@hasen@y\@hasen@y@
    \setlength{\@tempdima}{\@hasen@x@\unitlength}%
      \edef\@hasen@L{\the\@tempdima}% 
    \setlength{\@tempdima}{\@hasen@y@\unitlength}%
      \edef\@hasen@G{\the\@tempdima}% 
    \edef\hasen@opt{[\@hasen@x@][\@hasen@y@]}%
    \ifnum\EMps@mode=\@ne
      \setdash{#1}%
    \else
      \let\sensyu\hasen
    \fi
  }%
}%
\define@key{emGurafu}{yazirusi}[a]{\edef\yazirusi@opt{#1}}%
\define@key{emGurafu}{arrowsize}{%
  \edef\arrow@size{#1}%
  \expandafter\setarrowsize\arrow@size
}%
\define@key{emGurafu}{oresen}{\def\oresen@name{#1}}%
%
%\def\gsave{\bgroup}%
%\def\grestore{\egroup}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%          for(#1=#2;#1<#3;#1+=\hazime@kaku){\owari@kaku}%
%             <#1>オプションを指定したときは，ループ変数を丸める。
%             ex. <2> としたときは，小数第2位まで（第3位を四捨五入）
%                                   fp-snap.sty が必要
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifx\revised@For\@undefined
\def\revised@For{}%
\def\For{\@ifnextchar<{\@For}{\@For<\empty>}}%
\def\@For<#1>#2#3#4#5\Do#6{\@killglue\edef#2{#3}\def\fr@tmp{#5}%
  \ifx\@empty\fr@tmp\@latexerr{!! Missing Argument!
    For\string#2\string#3\string#4?Do}\@ehd\fi
  \ifdim#5\p@>\z@\def\fr@cnd{\@whiledim#2\p@<#4\p@\do}%
  \else\def\fr@cnd{\@whiledim#2\p@>#4\p@\do}\fi
  \fr@cnd{#6\Add{#2}{#5}{#2}%
    \ifx \empty#1\relax\else\FPround\fr@tmp{#2}{#1}\edef#2{\fr@tmp}\fi
  }\ignorespaces}%
\fi
%
\let\ltxput\put
\def\put(#1,#2)#3{%
  \setlength{\@tempdima}{#1\unitlength}\ukansan\@tempdima\tmp@i
  \setlength{\@tempdima}{#2\unitlength}\ukansan\@tempdima\tmp@ii
  \edef\old@localorigin{\local@origin}%
  \Addvec{(\tmp@i,\tmp@ii)}\old@localorigin\local@origin
  \ltxput(#1,#2){#3}%
  \edef\local@origin{\old@localorigin}%
}%
%
\def\Nurizen{1}%
%
% \Tyokkaku[#1](#2)<#3>#4[#5]#6
%   #1    : 補正角 90, 180, 270 など
%         : 0〜1 のときは塗りつぶしの濃さ
%   #2    : 直角記号のサイズ
%   #3    : （未使用）
%   #4    : 直角の頂点
%   #5,#6 : 直角となる2辺の一方の上の点
%
\def\Tyokkaku{\@ifnextchar[{\@Tyokkaku}{\@Tyokkaku[0]}}%
\def\@Tyokkaku[#1]{\@ifnextchar({\@@Tyokkaku[#1]}{\@@Tyokkaku[#1](5)}}%
\def\@@Tyokkaku[#1](#2){\@ifnextchar<{\@@@Tyokkaku[#1](#2)}{%
    \@@@Tyokkaku[#1](#2)<\empty>}}%
\def\@@@Tyokkaku[#1](#2)<#3>#4{\@ifnextchar[{\@@@@Tyokkaku[#1](#2)<#3>{#4}}{%
  \@@@@Tyokkaku[#1](#2)<#3>{#4}[\empty]}}%
\def\@@@@Tyokkaku[#1](#2)<#3>#4[#5]#6{%
\Kyorii{#4}{#6}\Tyokkaku@a
\ifdim\Tyokkaku@a pt>0.005pt\relax
  \Subvec{#4}{#6}\@v\vecXY\@v\Pr@x\P@y%
  \@Div{#2}{\strip@pt\unitlength}\u@pt%
  \Subvec{#6}{#4}\t@x\Unitvec\t@x\t@x\Mulvec\u@pt\t@x\t@x
  \ifx\empty#5\Rotvec\t@x{-90}\t@y\else%
  \Subvec{#5}{#4}\t@y\Unitvec\t@y\t@y\Mulvec\u@pt\t@y\t@y\fi%
  \ifdim #1pt>1pt\relax\Rotvec\t@x{#1}\t@x\Rotvec\t@y{#1}\t@y\fi
  \Addvec\t@x\t@y\t@z\Addvec{#4}\t@x\t@x%
  \Addvec{#4}\t@y\t@y \Addvec{#4}\t@z\t@z%
  \ifdim #1pt>\z@\ifdim #1pt<1.1pt\relax
    \Nuritubusi[#1]{\t@x\t@z\t@y#4\t@x}\fi\fi%
  \Drawline{\t@x\t@z\t@y}%
\fi
}%
%
\def\Tyokkakukigou{\begingroup\ifnum\EMps@mode=\@ne\gsave\fi
%
  \define@key{emP}{kakukipos}{\def\kakuki@pos{##1}}%
  \define@key{emP}{kakukikaiten}{\ifdim ##1\p@<\z@\IAdd{##1}{360}\kakuki@pos
    \else\edef\kakuki@pos{##1}\fi}%
  \define@key{emP}{kakukisize}{\def\kakuki@size{##1}}%
  \define@key{emP}{size}{\def\size@{##1}}%
  \define@key{emP}{kakukinoudo}{\def\kakuki@noudo{##1}}%
%
  \edef\kakuki@pos{0}%
  \edef\kakuki@noudo{0}%
  \@ifnextchar<{\@Tyokkakukigou}{\@Tyokkakukigou<\empty>}}%
\def\@Tyokkakukigou<#1>{%
%  \Add\kakuki@pos\kakuki@noudo\kakuki@pos@noudo
  \@ifnextchar[{\@@Tyokkakukigou<#1>}{\@@Tyokkakukigou<#1>[\kakuki@noudo]}%
}%
\def\@@Tyokkakukigou<#1>[#2]{\@ifnextchar({\@@@Tyokkakukigou<#1>[#2]}{%
  \@@@Tyokkakukigou<#1>[#2](5)}}%
\def\@@@Tyokkakukigou<#1>[#2](#3)#4#5#6{%
  \edef\size@{#3\p@}%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
  \Add\kakuki@pos{#2}\kakuki@pos@noudo
  \@tempdima\size@
  \edef\size@@{\strip@pt\@tempdima}%
\Kyorii{#4}{#5}\a@Tyokkakukigou
\Kyorii{#6}{#5}\b@Tyokkakukigou
\ifdim\a@Tyokkakukigou pt>0.005pt\relax
\ifdim\b@Tyokkakukigou pt>0.005pt\relax
  \@Div{\size@@}{\strip@pt\unitlength}\u@pt%
  \Subvec{#4}{#5}\t@x\Unitvec\t@x\t@x\Mulvec\u@pt\t@x\t@x
  \Subvec{#6}{#5}\t@y\Unitvec\t@y\t@y\Mulvec\u@pt\t@y\t@y
  \Addvec\t@x\t@y\t@z\Addvec{#5}\t@x\t@x%
  \Addvec{#5}\t@y\t@y \Addvec{#5}\t@z\t@z%
  \ifdim \kakuki@pos@noudo\p@>\z@
    \ifdim \kakuki@pos@noudo\p@<90\p@
      \edef\Tykk@kaiten{0}%
      \edef\Tykk@noudo{\kakuki@pos@noudo}%
    \else\ifdim \kakuki@pos@noudo\p@<180\p@
      \edef\Tykk@kaiten{1}%
      \Sub{\kakuki@pos@noudo}{90}\Tykk@noudo
    \else\ifdim \kakuki@pos@noudo\p@<270\p@
      \edef\Tykk@kaiten{2}%
      \Sub{\kakuki@pos@noudo}{180}\Tykk@noudo
    \else
      \edef\Tykk@kaiten{3}%
      \Sub{\kakuki@pos@noudo}{270}\Tykk@noudo
    \fi\fi\fi
    \ifcase\Tykk@kaiten
        \ifdim\Tykk@noudo\p@>\z@
          \Nuritubusi[\Tykk@noudo]{\t@x\t@z\t@y#5\t@x}%
        \fi
        \Drawline{\t@x\t@z\t@y}%
      \or
        \@Bunten{#4}{#5}{2}{-1}\t@xx
        \Tyokkakukigou[\Tykk@noudo](\size@@){#6}{#5}{\t@xx}%
      \or
        \@Bunten{#4}{#5}{2}{-1}\t@xx
        \@Bunten{#6}{#5}{2}{-1}\t@yy
        \Tyokkakukigou[\Tykk@noudo](\size@@){\t@xx}{#5}{\t@yy}%
      \or
        \@Bunten{#6}{#5}{2}{-1}\t@yy
        \Tyokkakukigou[\Tykk@noudo](\size@@){\t@yy}{#5}{#4}%
    \fi
  \else
    \Drawline{\t@x\t@z\t@y}%
  \fi
\fi\fi
\ifnum\EMps@mode=\@ne\grestore\fi
\endgroup
}%
\let\perpmark\Tyokkakukigou
%
\let\RKAKUkigou\Tyokkakukigou%
%\let\RKakukigou\Tyokkakukigou
%
% 複数の角に直角記号
\def\tyokkakukigou{\begingroup\ifnum\EMps@mode=\@ne\gsave\fi
  \@ifnextchar<{\@tyokkakukigou}{\@tyokkakukigou<\empty>}}%
\def\@tyokkakukigou<#1>{\@ifnextchar[{\@@tyokkakukigou<#1>}{%
  \@@tyokkakukigou<#1>[0]}}%
\def\@@tyokkakukigou<#1>[#2]{\@ifnextchar({\@@@tyokkakukigou<#1>[#2]}{%
  \@@@tyokkakukigou<#1>[#2](5)}}%
\def\@@@tyokkakukigou<#1>[#2](#3)#4{%
    \def\@@tyokkakukigou@sub(##1,##2)(##3,##4)(##5,##6){%
      \Tyokkakukigou<#1>[#2](#3){(##1,##2)}{(##3,##4)}{(##5,##6)}}%
  \Cfor{\edef\tyokkaku@a{#4}}{\not\equal\tyokkaku@a\empty}{}\do{%
    \strsep\tyokkaku@a{;}\tyokkaku@a\tyokkaku@b
    \expandafter\@@tyokkakukigou@sub\tyokkaku@a
    \edef\tyokkaku@a{\tyokkaku@b}}%
  \ifnum\EMps@mode=\@ne\grestore\fi
  \endgroup
}%
\let\Tyokkakukigous\tyokkakukigou
%
%% 角の内部に円弧を描き，その傍に記号などを置く．
\def\Kakukigoubounagasa{.5mm}%
%\Kakukigou[#1]<#2>#3#4#5<#6><#7>
%    #1 : 円弧の上に置く記号
%     #1=a のときは角記号に矢印をつける．
%     #1=r のときは角記号に逆向きの矢印をつける．
%     #1=b のときは角記号に両向きの矢印をつける．
%     #1=| のときは，円弧中央に円弧と垂直な短い線分(長さは\Kakukigoubounagasa)
%    #2 : 円弧の個数
%         \Kakukigou@kankaku（デフォルト値=0.5mm）だけ小さい円弧を描画する。
%    #3#4#5 : 角BAC
%       #4 が角の頂点
%       半直線 #4#3 を 回転して #4#5 に重ねる回転を表示する．
%    #6 : 円弧と頂点の距離係数（デフォルト値 1 ）
%       hankei=（無名数） 半径の指定
%       Hankei=（単位付）     〃
%       siteiten=         円弧が指定点を通過
%       Kakukigoukankaku=（単位付） 複数の円弧を描画する際の間隔
%       hasen=[L][G]    円弧を破線で描画
%       bezier= （無名数）
%       Kakukigoubounagasa= （単位つき数値）
%    #7 : 円弧の中心と角の頂点位置（デフォルト値 0 ）
%    以下，\emathPut に続く。
%
\edef\toukaku@kigou{\empty}%
%
\def\Kakukigou{\edef\Kaku@nuri{\empty}\@ifstar{\Kakukigou@s}{\Kakukigou@}}%
%
\def\Kakukigou@s{\@ifnextchar[{\Kakukigou@@}{\Kakukigou@@[.5]}}%
\def\Kakukigou@@[#1]{%
  \@ifnextchar<{\Kakukigou@@@[#1]}{\Kakukigou@@@[#1]<\empty>}}%
\def\Kakukigou@@@[#1]<#2>{\EMedef\Kaku@nuri{*[#1]<#2>}\Kakukigou@}%
%
\def\Kakukigou@{\@ifnextchar[{\@Kakukigou}{\@Kakukigou[\empty]}}%
\def\@Kakukigou[#1]{\@ifnextchar<{\@@Kakukigou[#1]}{%
  \@@Kakukigou[#1]<1>}}%
\def\@@Kakukigou[#1]<#2>#3#4#5{\@ifnextchar<{%
  \@@@Kakukigou[#1]<#2>{#3}{#4}{#5}}{%
  \@@@Kakukigou[#1]<#2>{#3}{#4}{#5}<1>}}%
\def\@@@Kakukigou[#1]<#2>#3#4#5<#6>{\@ifnextchar<{%
  \@@@@Kakukigou[#1]<#2>{#3}{#4}{#5}<#6>}{%
  \@@@@Kakukigou[#1]<#2>{#3}{#4}{#5}<#6><0>}}%
\def\@@@@Kakukigou[#1]<#2>#3#4#5<#6><#7>{\begingroup%
  \ifnum\EMps@mode=\@ne\gsave\fi
    \define@key{emP}{kakukigou}{\def\toukaku@kigou{##1}}%
    \define@key{emP}{moziiti}{\edef\mozi@r{##1}}%
    \define@key{emP}{toukakukigou}{\def\toukaku@kigou{##1}}%
    \define@key{emP}{hankei}{\def\u@pt{##1}}%
    \define@key{emP}{Hankei}{\ukansan{##1}\u@pt}%
    \define@key{emP}{siteiten}{\Kyori{##1}{#4}\u@pt}%
    \define@key{emP}{Kakukigoukankaku}{\ukansan{##1}\Kakukigou@kankaku}%
    \define@key{emP}{bezier}{\def\kakuki@bz{##1}}%
    \define@key{emP}{Kakukigoubounagasa}{\def\Kakukigou@bounagasa{##1}}%
  \Subvec{#3}{#4}\kaku@u
  \Unitvec\kaku@u\kaku@u%
  \Subvec{#5}{#4}\kaku@v
  \Unitvec\kaku@v\kaku@v%
  \edef\hasen@opt{\empty}%
  \edef\kakuki@bz{\empty}%
  \edef\nuri@iro{\empty}%
  \edef\mozi@r{\empty}%
  \edef\Kakukigou@bounagasa{\Kakukigoubounagasa}%
  \ukansan{.5mm}\Kakukigou@kankaku%
  \edef\u@pt{\empty}%
  \Strchr{#6}{=}\Kakukigou@tmp
  \ifnum\Kakukigou@tmp>\z@
    \@Div{10}{\strip@pt\unitlength}\u@pt%
    \setkeys{emP}{#6}%
  \else\ifx\u@pt\empty
    \@Div{10}{\strip@pt\unitlength}\u@pt%
    \Mul{#6}\u@pt\u@pt
  \fi\fi
  \Mulvec\u@pt\kaku@u\kaku@u@
  \Mulvec\u@pt\kaku@v\kaku@v@
  \Addvec{#4}\kaku@u@\kaku@u%
  \Addvec{#4}\kaku@v@\kaku@v%
  \@Bunten\kaku@u\kaku@v11\B@M
  \Subvec\B@M{#4}\@BM
  \Mulvec{#7}\@BM\@Btyuusin
  \Addvec{#4}\@Btyuusin\@tyuusin
  \Kyori\@tyuusin\kaku@u\@hankei
  \edef\Kakuki@hankei{\@hankei}%        2004/01/22
  \Subvec\kaku@u\@tyuusin\@u\Argvec\@u\kaku@s
  \Subvec\kaku@v\@tyuusin\@v\Argvec\@v\kaku@e
  \ifdim\kaku@s pt>\kaku@e pt\relax\Add\kaku@e{360}\kaku@e\fi%
  \Add\kaku@s\kaku@e\kaku@m\@Div\kaku@m{2}\kaku@m
  \Rdef[\@tyuusin](\Kakuki@hankei,\kaku@m)\kakuki@P
  \edef\KakukigouP{\kakuki@P}%
  \ifx\empty\Kaku@nuri\else
    \emathPut\@tyuusin{%
      \expandafter\ougigata\Kaku@nuri\Kakuki@hankei\kaku@s\kaku@e}%
  \fi
  \ifnum #2>0\relax
    \ifx\empty\kakuki@bz
      \edef\Kakuki@opt{\empty}%
      \ifx a#1\edef\Kakuki@opt{yazirusi=a}\else
      \ifx r#1\edef\Kakuki@opt{yazirusi=r}\else
      \ifx b#1\edef\Kakuki@opt{yazirusi=b}\fi\fi\fi
      \ifx\empty\hasen@opt\else
        \ifx\empty\Kakuki@opt
          \edef\Kakuki@opt{hasen=\hasen@opt}%
        \else
          \edefappend\Kakuki@opt{,hasen=\hasen@opt}%
        \fi
      \fi
      \ifx\empty\Kakuki@opt
        \Enko\@tyuusin\Kakuki@hankei\kaku@s\kaku@e
      \else
        \edef\Kakuki@opt{<\Kakuki@opt>}%
        \expandafter\Enko\Kakuki@opt\@tyuusin\Kakuki@hankei\kaku@s\kaku@e
      \fi
    \else
      \Rdef[\@tyuusin](\Kakuki@hankei,\kaku@s)\kakuki@A
      \Rdef[\@tyuusin](\Kakuki@hankei,\kaku@e)\kakuki@B
      \Rdef[\@tyuusin](\Kakuki@hankei,\kaku@m)\kakuki@P
      \Mul\kakuki@bz\Kakuki@hankei\Kakuki@hankei
      \Rdef[\@tyuusin](\Kakuki@hankei,\kaku@m)\kakuki@@P
      \Sub\kakuki@bz{1}\kakuki@tmp
      \Add\kakuki@bz\kakuki@tmp\kakuki@tmp
      \Mul\Kakuki@hankei\kakuki@tmp\kakuki@tmp
      \Rdef[\@tyuusin](\kakuki@tmp,\kaku@m)\kakuki@@@P
      \Tyuuten\kakuki@A\kakuki@B\kakuki@M
      \@Bunten\kakuki@M\kakuki@@@P31\KakukigouP
      \edef\kakuki@tmp{\kakuki@A\kakuki@@@P\kakuki@B}%
      \@ifundefined{ps@debug@}{%
        \emDrawtpic\kakuki@tmp
      }{%
        \@Bunten\kakuki@A\kakuki@@@P31\kakuki@C
        \@Bunten\kakuki@B\kakuki@@@P31\kakuki@D
        \EMpsBezier\kakuki@A\kakuki@C\kakuki@D\kakuki@B
      }%
%      \Tyuuten\kakuki@@P\kakuki@@@P\kakuki@P
      \Bunten\kakuki@@P\kakuki@@@P13\kakuki@P
    \fi
    \ifx |#1\relax
        \let\arc@M\kakuki@P
        \ukansan{\Kakukigou@bounagasa}\l@l\Rdef(\l@l,\kaku@m)\@@M
        \Addvec\arc@M\@@M\Kakuki@P\Subvec\arc@M\@@M\Kakuki@Q
        \Drawline{\Kakuki@P\Kakuki@Q}%
    \fi
    \ifnum #2>1\relax
      \Sub\@hankei\Kakukigou@kankaku\@@hankei
      \ifx\empty\kakuki@bz
        \Enko\@tyuusin\@@hankei\kaku@s\kaku@e
      \else
        \Rdef[\@tyuusin](\@@hankei,\kaku@s)\kakuki@A
        \Rdef[\@tyuusin](\@@hankei,\kaku@e)\kakuki@B
        \Rdef[\@tyuusin](\@@hankei,\kaku@m)\kakuki@P
        \Mul\kakuki@bz\@@hankei\@@@hankei
        \Rdef[\@tyuusin](\@@@hankei,\kaku@m)\kakuki@@P
        \Sub\kakuki@bz{1}\kakuki@tmp
        \Add\kakuki@bz\kakuki@tmp\kakuki@tmp
        \Mul\@@@hankei\kakuki@tmp\kakuki@tmp
        \Rdef[\@tyuusin](\kakuki@tmp,\kaku@m)\kakuki@@@P
        \edef\kakuki@tmp{\kakuki@A\kakuki@@@P\kakuki@B}%
        \@ifundefined{ps@debug@}{%
          \emDrawtpic\kakuki@tmp
        }{%
          \@Bunten\kakuki@A\kakuki@@@P31\kakuki@C
          \@Bunten\kakuki@B\kakuki@@@P31\kakuki@D
          \EMpsBezier\kakuki@A\kakuki@C\kakuki@D\kakuki@B
        }%
      \fi
      \ifnum #2>2\relax
        \Sub\@@hankei\Kakukigou@kankaku\@@hankei
        \ifx\empty\kakuki@bz
          \Enko\@tyuusin\@@hankei\kaku@s\kaku@e
        \else
          \Rdef[\@tyuusin](\@@hankei,\kaku@s)\kakuki@A
          \Rdef[\@tyuusin](\@@hankei,\kaku@e)\kakuki@B
          \Rdef[\@tyuusin](\@@hankei,\kaku@m)\kakuki@P
          \Mul\kakuki@bz\@@hankei\@@@hankei
          \Rdef[\@tyuusin](\@@@hankei,\kaku@m)\kakuki@@P
          \Sub\kakuki@bz{1}\kakuki@tmp
          \Add\kakuki@bz\kakuki@tmp\kakuki@tmp
          \Mul\@@@hankei\kakuki@tmp\kakuki@tmp
          \Rdef[\@tyuusin](\kakuki@tmp,\kaku@m)\kakuki@@@P
          \edef\kakuki@tmp{\kakuki@A\kakuki@@@P\kakuki@B}%
          \@ifundefined{ps@debug@}{%
            \emDrawtpic\kakuki@tmp
          }{%
            \@Bunten\kakuki@A\kakuki@@@P31\kakuki@C
            \@Bunten\kakuki@B\kakuki@@@P31\kakuki@D
            \EMpsBezier\kakuki@A\kakuki@C\kakuki@D\kakuki@B
          }%
        \fi
    \fi\fi
  \fi
  \Rdef(\@hankei,\kaku@m)\kaku@P
  \@ifundefined{@xscale}{}{%
    \vecXY\kaku@P\kaku@x\kaku@y
    \@Div\kaku@x\@xscale\kaku@x
    \@Div\kaku@y\@yscale\kaku@y
    \edef\kaku@P{(\kaku@x,\kaku@y)}%
  }%
  \ifx\empty\kakuki@bz
    \Addvec\@tyuusin\kaku@P\KakukigouP
  \fi
  \ifx\empty\mozi@r\else
    \headchar\mozi@r\mozi@rh\mozi@rk
    \if +\mozi@rh
      \ukansan\mozi@rk\mozi@rk
      \Add\@hankei\mozi@rk\mozi@r@
    \else\if -\mozi@rh
      \ukansan\mozi@rk\mozi@rk
      \Sub\@hankei\mozi@rk\mozi@r@
    \else
      \ukansan\mozi@r\mozi@r@
    \fi\fi
    \Rdef[\@tyuusin](\mozi@r@,\kaku@m)\KakukigouP
  \fi
%  \xdef\KakukigouP{\KakukigouP}%
\ifnum\EMps@mode=\@ne\grestore\fi
    \edef\temp@x{\def\noexpand\KakukigouP{\KakukigouP}}%
    \expandafter\endgroup\temp@x
  \emathPut\KakukigouP
}%
%
\def\Kakukigous{\edef\Kaku@nuri{\empty}\@ifstar{\Kakukigous@s}{\Kakukigous@}}%
%
\def\Kakukigous@s{\@ifnextchar[{\Kakukigous@@}{\Kakukigous@@[.5]}}%
\def\Kakukigous@@[#1]{%
  \@ifnextchar<{\Kakukigous@@@[#1]}{\Kakukigous@@@[#1]<\empty>}}%
\def\Kakukigous@@@[#1]<#2>{\EMedef\Kaku@nuri{*[#1]<#2>}\Kakukigous@}%
%
\def\Kakukigous@{\@ifnextchar[{\@Kakukigous}{\@Kakukigous[\empty]}}%
\def\@Kakukigous[#1]{\@ifnextchar<{\@@Kakukigous[#1]}{%
  \@@Kakukigous[#1]<1>}}%
\def\@@Kakukigous[#1]<#2>#3{\@ifnextchar<{%
  \@@@Kakukigous[#1]<#2>{#3}}{%
  \@@@Kakukigous[#1]<#2>{#3}<\empty>}}%
\def\@@@Kakukigous[#1]<#2>#3<#4>{%
  \edef\kkg@kosuu{#2}%
  \exfor[;]\kkg@c:=#3\do{%
    \trim\kkg@c\to\kkg@c
    \EMedef\kkg@tmp{[#1]\kkg@c<#4>}%
    \expandafter\@Kakukigou@sub\kkg@tmp
  }%
}%
\def\@Kakukigou@sub[#1](#2,#3)(#4,#5)(#6,#7)#8<#9>{%
  \Headchar{#8}\kkg@h\kkg@r
  \if [\kkg@h
    \strsep{#8}{]}\kkg@a\kkg@b
    \EMedef\kkg@tmp{%
      [#1]<\kkg@kosuu>{(#2,#3)}{(#4,#5)}{(#6,#7)}<#9>\kkg@a]{\kkg@b}}%
  \else\if (\kkg@h
    \strsep{#8}{]}\kkg@a\kkg@b
    \EMedef\kkg@tmp{%
      [#1]<\kkg@kosuu>{(#2,#3)}{(#4,#5)}{(#6,#7)}<#9>\kkg@a]{\kkg@b}}%
  \else
    \EMedef\kkg@tmp{[#1]<\kkg@kosuu>{(#2,#3)}{(#4,#5)}{(#6,#7)}<#9>{#8}}%
  \fi\fi
  \expandafter\Kakukigou\kkg@tmp
}%
%
%\def\@@@@Kakukigou[#1]<#2>#3#4#5<#6><#7>{%
%    \define@key{emP}{hankei}{\def\u@pt{##1}}%
%    \define@key{emP}{Hankei}{\templa=##1\relax
%      \@Div{\strip@pt\templa}{\strip@pt\unitlength}\u@pt}%
%    \define@key{emP}{siteiten}{\Kyori{##1}{#4}\u@pt}%
%  \Subvec{#3}{#4}\kaku@u\Unitvec\kaku@u\kaku@u%
%  \Subvec{#5}{#4}\kaku@v\Unitvec\kaku@v\kaku@v%
%  \edef\hasen@opt{\empty}%
% \edef\u@pt{\empty}%
%  \Strchr{#6}{=}\Kakukigou@tmp
%  \ifnum\Kakukigou@tmp>\z@\setkeys{emP}{#6}\else
%    \ifx\u@pt\empty
%      \@Div{10}{\strip@pt\unitlength}\u@pt%
%      \Mul{#6}\u@pt\u@pt
%  \fi\fi
%  \Mulvec\u@pt\kaku@u\kaku@u@
%  \Mulvec\u@pt\kaku@v\kaku@v@
%  \Addvec{#4}\kaku@u@\kaku@u%
%  \Addvec{#4}\kaku@v@\kaku@v%
%  \@Bunten\kaku@u\kaku@v11\B@M
%  \Subvec\B@M{#4}\@BM
%  \Mulvec{#7}\@BM\@Btyuusin
%  \Addvec{#4}\@Btyuusin\@tyuusin
%  \Kyori\@tyuusin\kaku@u\@hankei
%  \Subvec\kaku@u\@tyuusin\@u\Argvec\@u\kaku@s
%  \Subvec\kaku@v\@tyuusin\@v\Argvec\@v\kaku@e
%  \ifdim\kaku@s pt>\kaku@e pt\relax\Add\kaku@e{360}\kaku@e\fi%
%  \ifnum #2>0\relax
%    \ifx a#1\emathPut\@tyuusin{\Yenko\@hankei\kaku@s\kaku@e}\else%
%    \ifx r#1\emathPut\@tyuusin{\Yenko[r]\@hankei\kaku@s\kaku@e}\else%
%    \ifx b#1\emathPut\@tyuusin{\Yenko[b]\@hankei\kaku@s\kaku@e}%
%    \fi\fi\fi
%    \ifthenelse{\equal\hasen@opt\empty}{%
%      \emathPut\@tyuusin{\@ifundefined{arc}{\enkoo\@hankei\kaku@s\kaku@e}{%
%      \ifdim\Kaku@nuri pt>\z@\ougigata*[\Kaku@nuri]\@hankei\kaku@s\kaku@e\fi
%      \enko\@hankei\kaku@s\kaku@e}}}{\emathPut\@tyuusin{%
%        \expandafter\Daenko\hasen@opt\@hankei\@hankei\kaku@s\kaku@e}}%
%    \ifx |#1\Add\kaku@s\kaku@e\kaku@m\@Div\kaku@m{2}\kaku@m
%      \Rdef(\@hankei,\kaku@m)\arc@M\Addvec\@tyuusin\arc@M\arc@M
%      \@Div{1}{\strip@pt\unitlength}\l@l\Rdef(\l@l,\kaku@m)\@@M
%      \Addvec\arc@M\@@M\@P\Subvec\arc@M\@@M\@Q\Drawline{\@P\@Q}\fi
%  \ifnum #2>1\relax
%  \Mul{0.85}\@hankei\@@hankei
%  \emathPut\@tyuusin{\@ifundefined{arc}{\enkoo\@hankei\kaku@s\kaku@e}{%
%       \enko\@@hankei\kaku@s\kaku@e}}%
%  \ifnum #2>2\relax
%  \Mul{0.85}\@@hankei\@@hankei
%  \emathPut\@tyuusin{\@ifundefined{arc}{\enkoo\@hankei\kaku@s\kaku@e}{%
%       \enko\@@hankei\kaku@s\kaku@e}}%
%  \fi\fi\fi
% \Add\kaku@s\kaku@e\kaku@m\@Div\kaku@m{2}\kaku@m
% \RPut[\@tyuusin](\@hankei,\kaku@m)\KakukigouP}%
%
%% 角の内部に円弧を描き，その傍に記号などを置く．
%\KAKUkigou[#1]<#2>#3#4#5[#6]<#7>#8
%    #1 : 円弧の上に置く記号
%     #1=a のときは角記号に矢印をつける．
%     #1=r のときは角記号に逆向きの矢印をつける．
%     #1=| のときは，円弧中央に円弧と垂直な短い線分
%    #2 : 円弧の個数
%    #3#4#5 : 角BAC
%       #4 が角の頂点
%       半直線 #4#3 を 回転して #4#5 に重ねる回転を表示する．
%    #6 : 円弧と頂点の距離係数（デフォルト値 1 ）
%    #7 : 円弧の中心と角の頂点位置（デフォルト値 0 ）
%    #8 : 角内の文字列
%
\def\KAKUkigou{\edef\KAKU@nuri{0}\@ifstar{\KAKUkigou@s}{\KAKUkigou@}}%
\def\KAKUkigou@s{\@ifnextchar[{\KAKUkigou@@}{\KAKUkigou@@[.5]}}%
\def\KAKUkigou@@[#1]{\edef\KAKU@nuri{#1}\KAKUkigou@}%
\def\KAKUkigou@{\@ifnextchar[{\@KAKUkigou}{\@KAKUkigou[\empty]}}%
\def\@KAKUkigou[#1]{\@ifnextchar<{\@@KAKUkigou[#1]}{%
  \@@KAKUkigou[#1]<1>}}%
\def\@@KAKUkigou[#1]<#2>#3#4#5{\@ifnextchar[{%
  \@@@KAKUkigou[#1]<#2>{#3}{#4}{#5}}{%
  \@@@KAKUkigou[#1]<#2>{#3}{#4}{#5}[1]}}%
\def\@@@KAKUkigou[#1]<#2>#3#4#5[#6]{\@ifnextchar<{%
  \@@@@KAKUkigou[#1]<#2>{#3}{#4}{#5}[#6]}{%
  \@@@@KAKUkigou[#1]<#2>{#3}{#4}{#5}[#6]<0>}}%
\def\@@@@KAKUkigou[#1]<#2>#3#4#5[#6]<#7>#8{%
  \edef\Kakukigou@bounagasa{\Kakukigoubounagasa}%
  \Subvec{#3}{#4}\kaku@u\Unitvec\kaku@u\kaku@u%
  \Subvec{#5}{#4}\kaku@v\Unitvec\kaku@v\kaku@v%
  \@Div{10}{\strip@pt\unitlength}\u@pt%
  \Mul{#6}\u@pt\u@pt%
  \Mulvec\u@pt\kaku@u\kaku@u@
  \Mulvec\u@pt\kaku@v\kaku@v@
  \Addvec{#4}\kaku@u@\kaku@u%
  \Addvec{#4}\kaku@v@\kaku@v%
  \@Bunten\kaku@u\kaku@v11\B@M
  \Subvec\B@M{#4}\@BM
  \Mulvec{#7}\@BM\@Btyuusin
  \Addvec{#4}\@Btyuusin\@tyuusin
  \Kyori\@tyuusin\kaku@u\@hankei
  \Subvec\kaku@u\@tyuusin\@u\Argvec\@u\kaku@s
  \Subvec\kaku@v\@tyuusin\@v\Argvec\@v\kaku@e
  \ifdim\kaku@s pt>\kaku@e pt\relax\Add\kaku@e{360}\kaku@e\fi%
  \ifnum #2>0\relax
    \ifx a#1\emathPut\@tyuusin{\yenko\@hankei\kaku@s\kaku@e}\else%
    \ifx r#1\emathPut\@tyuusin{\yenko[r]\@hankei\kaku@s\kaku@e}\else%
    \emathPut\@tyuusin{\@ifundefined{arc}{\enkoo\@hankei\kaku@s\kaku@e}{%
    \ifdim\KAKU@nuri pt>\z@\ougigata*[\KAKU@nuri]\@hankei\kaku@s\kaku@e\fi
    \EMenko\@hankei\kaku@s\kaku@e}}\fi\fi%
    \ifx |#1\Add\kaku@s\kaku@e\kaku@m\@Div\kaku@m{2}\kaku@m
      \Rdef(\@hankei,\kaku@m)\arc@M\Addvec\@tyuusin\arc@M\arc@M
      \ukansan{\Kakukigou@bounagasa}\l@l\Rdef(\l@l,\kaku@m)\@@M
      \Addvec\arc@M\@@M\@P\Subvec\arc@M\@@M\@Q\Drawline{\@P\@Q}\fi
  \ifnum #2>1\relax
  \Mul{0.85}\@hankei\@@hankei
    \emathPut\@tyuusin{\@ifundefined{arc}{\enkoo\@hankei\kaku@s\kaku@e}{%
      \EMenko\@@hankei\kaku@s\kaku@e}}%
  \ifnum #2>2\relax
  \Mul{0.85}\@@hankei\@@hankei
    \emathPut\@tyuusin{\@ifundefined{arc}{\enkoo\@hankei\kaku@s\kaku@e}{%
      \EMenko\@@hankei\kaku@s\kaku@e}}%
  \fi\fi\fi
  \Add\kaku@s\kaku@e\kaku@m\@Div\kaku@m{2}\kaku@m
  \@Div{2}{\strip@pt\unitlength}\@u@pt%
  \Add\@hankei\@u@pt\@@hankei
% \Rdef(\@hankei,\kaku@m)\@P\Addvec\@tyuusin\@P\@kakuP
  \Rdef[\@tyuusin](\@@hankei,\kaku@m)\KAKUkigou@P
% \Addvec\@tyuusin\KAKUkigou@P\KAKUkigou@P
  \emathPut\KAKUkigou@P{#8}%
}%
%
% 等角記号
%   \toukakukigou[#1]<#2>#3<#4><#5>
%     #1 : 記号（デフォルトは | ）
%     #2 : 個数
%     #3 : 角の列（区切子は`;'）
%     #4 : 円弧と頂点の距離係数（デフォルト値 1 ）
%        hankei=（無名数） 半径の指定
%        Hankei=（単位付）     〃
%        siteiten=         円弧が指定点を通過
%        kakukigou= （角内に配置する記号）
%     #5 : 円弧の中心と角の頂点位置（デフォルト値 0 ）
%
\def\toukakukigou{%
  \edef\toukaku@nuri{\empty}\@ifstar{\toukakukigou@s}{%
  \toukakukigou@ns}}%
\def\toukakukigou@s{\@ifnextchar[{\toukakukigou@@s}{\toukakukigou@@s[.5]}}%
\def\toukakukigou@@s[#1]{%
  \@ifnextchar<{\toukakukigou@@@s[#1]}{\toukakukigou@@@s[#1]<\empty>}}%
\def\toukakukigou@@@s[#1]<#2>{\EMedef\toukaku@nuri{*[#1]<#2>}\toukakukigou@ns}%
\def\toukakukigou@ns{%
  \@ifnextchar[{\@toukakukigou}{%
    \@toukakukigou[|]}}%
\def\@toukakukigou[#1]{\@ifnextchar<{\@@toukakukigou[#1]}{%
    \@@toukakukigou[#1]<\@ne>}}%
\def\@@toukakukigou[#1]<#2>#3{\@ifnextchar<{\@@@toukakukigou[#1]<#2>{#3}}{%
  \@@@toukakukigou[#1]<#2>{#3}<1>}}%
\def\@@@toukakukigou[#1]<#2>#3<#4>{%
  \@ifnextchar<{\@@@@toukakukigou[#1]<#2>{#3}<#4>}{%
  \@@@@toukakukigou[#1]<#2>{#3}<#4><0>}}%
\def\@@@@toukakukigou[#1]<#2>#3<#4><#5>{{%
  \edef\mozi@iti{1}%
  \edef\toukaku@kigou{\empty}%
  \edef\put@opt{(0,0)[c]}%
  \define@key{emP}{kakukigou}{\def\toukaku@kigou{##1}}%
  \define@key{emP}{toukakukigou}{\def\toukaku@kigou{##1}}%
  \define@key{emP}{hankei}{\def\u@pt{##1}}%
  \define@key{emP}{Hankei}{\ukansan{##1}\u@pt}%
  \define@key{emP}{siteiten}{\Kyori{##1}{#4}\u@pt}%
  \define@key{emP}{Kakukigoukankaku}{\ukansan{##1}\Kakukigou@kankaku}%
  \define@key{emP}{bezier}{\def\kakuki@bz{##1}}%
  \define@key{emP}{Kakukigoubounagasa}{\def\Kakukigou@bounagasa{##1}}%
  \define@key{emP}{moziiti}{\def\mozi@iti{##1}}%
%
    \def\toukakukigou@sub(##1,##2)(##3,##4)(##5,##6){%
      \edef\toukakukigou@a{(##1,##2)}%
      \edef\toukakukigou@b{(##3,##4)}%
      \edef\toukakukigou@c{(##5,##6)}}%
%
  \Strchr{#4}{=}\tmp@
  \ifnum\tmp@>\z@\setkeys{emP}{#4}\fi
  \argsep{#3}{;}{toukakukigou@tmp}\toukakukigou@n
  \Cfor{\edef\toukakukigou@i{0}}{\toukakukigou@i<\toukakukigou@n}{}\do{%
    \Incr\toukakukigou@i
    \edef\toukakukigou@arg{%
      \csname toukakukigou@tmp\romannumeral\toukakukigou@i\endcsname}%
    \expandafter\toukakukigou@sub\toukakukigou@arg
    \ifthenelse{\equal\toukaku@nuri\empty}{%
      \EMedef\toukakukigou@tmp{[#1]<#2>%
        {\toukakukigou@a}{\toukakukigou@b}{\toukakukigou@c}<#4><#5>\put@opt}%
      \expandafter\Kakukigou\toukakukigou@tmp{\toukaku@kigou}%
    }{%
      \EMedef\toukakukigou@tmp{\toukaku@nuri[#1]<#2>%
        {\toukakukigou@a}{\toukakukigou@b}{\toukakukigou@c}<#4><#5>\put@opt}%
      \expandafter\Kakukigou\toukakukigou@tmp\toukaku@kigou
    }%
  }%
}}%
%%
%% 等角記号
%%   \toukakukigou[#1]<#2>#3
%%     #1 : 記号（デフォルトは | ）
%%     #2 : 個数
%%     #3 : 角の列（区切子は`;'）
%%
%\def\toukakukigou{%
%  \edef\toukaku@nuri{0}\@ifstar{\toukakukigou@s}{%
%  \toukakukigou@ns}}%
%\def\toukakukigou@s{\@ifnextchar[{\toukakukigou@@s}{\toukakukigou@@s[.5]}}%
%\def\toukakukigou@@s[#1]{\edef\toukaku@nuri{#1}\toukakukigou@ns}%
%\def\toukakukigou@ns{%
%  \@ifnextchar[{\@toukakukigou}{%
%    \@toukakukigou[|]}}%
%\def\@toukakukigou[#1]{\@ifnextchar<{\@@toukakukigou[#1]}{%
%    \@@toukakukigou[#1]<\@ne>}}%
%\def\@@toukakukigou[#1]<#2>#3{%
%    \def\toukakukigou@sub(##1,##2)(##3,##4)(##5,##6){%
%      \edef\toukakukigou@a{(##1,##2)}%
%      \edef\toukakukigou@b{(##3,##4)}%
%      \edef\toukakukigou@c{(##5,##6)}}%
%  \argsep{#3}{;}{toukakukigou@tmp}\toukakukigou@n
%  \Cfor{\edef\toukakukigou@i{0}}{\toukakukigou@i<\toukakukigou@n}{}\do{%
%    \Incr\toukakukigou@i
%    \edef\toukakukigou@arg{%
%      \csname toukakukigou@tmp\romannumeral\toukakukigou@i\endcsname}%
%    \expandafter\toukakukigou@sub\toukakukigou@arg
%    \ifthenelse{\equal{\toukaku@nuri}{0}}{%
%      \KAKUkigou[#1]<#2>\toukakukigou@a\toukakukigou@b\toukakukigou@c}{%
%      \KAKUkigou*[\toukaku@nuri][#1]<#2>\toukakukigou@a\toukakukigou@b
%               \toukakukigou@c}%
%  }%
%}%
%
%\def\ArrowHeadSize{0.06}%
%\def\ArrowHeadSize{0.1}%
\def\ArrowHeadSize{0.12}%
\def\Arr@wHeadSize{0.12}%
\def\ArrowHeadAngle{18}%
\def\ArrowHeadAxis{90}%
\def\ArrowHeadType{f}%
\def\ArrowHeadPit{0}%
%\def\changeArrowHeadSize#1{\Mul\ArrowHeadSize{#1}\ArrowHeadSize%
%  \templa=0.033\unitlength\ifdim\templa>\z@
%  \@Div{\ArrowHeadSize}{\strip@pt\templa}\Arr@wHeadSize\fi}%
\def\changeArrowHeadSize{\@ifnextchar[{\changeArrowHeadSize@}{%
  \changeArrowHeadSize@[\ArrowHeadAngle]}}%
\def\changeArrowHeadSize@[#1]{\edef\ArrowHeadAngle{#1}%
  \@ifnextchar<{\changeArrowHeadSize@@}{\@changeArrowHeadSize}}%
\def\changeArrowHeadSize@@<#1>{\edef\ArrowHeadPit{#1}%
  \@changeArrowHeadSize}%
\def\@changeArrowHeadSize#1{\Mul\ArrowHeadSize{#1}\ArrowHeadSize%
  \templa0.033\unitlength
  \ifdim\templa>\z@\relax
    \@Div{\ArrowHeadSize}{\strip@pt\templa}\Arr@wHeadSize
  \fi
}%
%
% 鏃のみを描く
% \yaziri#1
%   #1 : 方向ベクトル（または方向角）
%   置く位置は \put または \emathPut で指定する．
% \Yaziri[#1]#2#3
%   #1 : rのとき，逆向き
%   #2 : 端末の位置
%   #3 : 方向ベクトル（または方向角）
%
\def\yaziri{\@ifnextchar[{\@yaziri}{\@yaziri[\empty]}}%
\def\Yaziri{\@ifnextchar[{\@Yaziri}{\@Yaziri[\empty]}}%
%\def\@Yaziri[#1]#2#3{\emathPut{#2}{\yaziri[#1]{#3}}}%
\def\@Yaziri[#1]#2#3{{\thinlines
  \ifdim\Arr@wHeadSize pt>\z@
    \ifx r#1\Mulvec{-1}{#3}\@houkou\else\edef\@houkou{#3}\fi
    \@ifundefined{xunitlength}{}{%\MulS\@houkou\@houkou%%%%%%%%%%%%%%%%%%%%??????????
      \edef\save@xu{\the\xunitlength}%
      \edef\save@yu{\the\yunitlength}%
      \xunitlength=\unitlength\yunitlength=\unitlength
    }%
    \Strchr{#3}{,}\yaziri@tmp
    \ifnum\yaziri@tmp>\z@
      \Argvec\@houkou\houkou@kaku
    \else
      \edef\houkou@kaku{#3}%
    \fi
    \Add\houkou@kaku{180}\houkou@kaku
    \Add\houkou@kaku\ArrowHeadAngle\kaku@s
    \Sub\houkou@kaku\ArrowHeadAngle\kaku@e
    \Rdef(\Arr@wHeadSize,\kaku@s)\Yaziri@P
    \Rdef(\Arr@wHeadSize,\kaku@e)\Yaziri@Q
\Addvec{#2}\Yaziri@P\Yaziri@P
\Addvec{#2}\Yaziri@Q\Yaziri@Q
    \DegCos\ArrowHeadAngle\yaziri@c\Mul\Arr@wHeadSize\yaziri@c\yaziri@c
    \DegSin\ArrowHeadAngle\yaziri@s\Mul\Arr@wHeadSize\yaziri@s\yaziri@s
    \Tyuuten\Yaziri@P\Yaziri@Q\yaziri@@M
    \@ifundefined{xunitlength}{}{%
      \setlength{\xunitlength}{\save@xu}%
      \setlength{\yunitlength}{\save@yu}%
    }%
    \if f\ArrowHeadType
      \ifdim\ArrowHeadPit\p@=\z@
        \ifx\empty\nuri@iro
          \Nuritubusi[\Nurizen]{#2\Yaziri@P\Yaziri@Q}%
        \else
          \@iro\nuri@iro\Nuritubusi{#2\Yaziri@P\Yaziri@Q}%
        \fi
      \else
        \Sub{1}{\ArrowHeadPit}\ArrowHeadPiti
        \@Bunten\yaziri@@M{#2}\ArrowHeadPit\ArrowHeadPiti\yaziri@@M
%        \Nuritubusi[\Nurizen]{#2\Yaziri@P\yaziri@@M\Yaziri@Q}%
        \ifx\empty\nuri@iro
          \Nuritubusi[\Nurizen]{#2\Yaziri@P\yaziri@@M\Yaziri@Q}%
        \else
          \@iro\nuri@iro\Nuritubusi{#2\Yaziri@P\yaziri@@M\Yaziri@Q}%
        \fi
      \fi
\Subvec\yaziri@@M{#2}\yaziri@@@M
\xdef\yaziri@@@M{\yaziri@@@M}%
    \else\if t\ArrowHeadType
      \Takakkei{\Yaziri@P#2\Yaziri@Q}%
    \else
      \Drawline{\Yaziri@P#2\Yaziri@Q}%
    \fi\fi
  \fi
}}%
%
\def\@yaziri[#1]#2{{\thinlines
  \ifdim\Arr@wHeadSize pt>\z@
    \ifx r#1\Mulvec{-1}{#2}\@houkou\else\edef\@houkou{#2}\fi
    \@ifundefined{xunitlength}{}{%\MulS\@houkou\@houkou%%%%%%%%%%%%%%%%%%%%??????????
      \xunitlength=\unitlength\yunitlength=\unitlength
    }%
    \Strchr{#2}{,}\yaziri@tmp
    \ifnum\yaziri@tmp>\z@
      \Argvec\@houkou\houkou@kaku
    \else
      \edef\houkou@kaku{#2}%
    \fi
    \Add\houkou@kaku{180}\houkou@kaku
    \Add\houkou@kaku\ArrowHeadAngle\kaku@s
    \Sub\houkou@kaku\ArrowHeadAngle\kaku@e
    \Rdef(\Arr@wHeadSize,\kaku@s)\yaziri@P
    \Rdef(\Arr@wHeadSize,\kaku@e)\yaziri@Q
    \DegCos\ArrowHeadAngle\yaziri@c\Mul\Arr@wHeadSize\yaziri@c\yaziri@c
    \DegSin\ArrowHeadAngle\yaziri@s\Mul\Arr@wHeadSize\yaziri@s\yaziri@s
    \Tyuuten\yaziri@P\yaziri@Q\yaziri@@M
    \if f\ArrowHeadType
      \ifdim\ArrowHeadPit\p@=\z@
        \ifx\empty\nuri@iro
          \Nuritubusi[\Nurizen]{(0,0)\yaziri@P\yaziri@Q(0,0)}%
        \else
          \@iro\nuri@iro\Nuritubusi{(0,0)\yaziri@P\yaziri@Q(0,0)}%
        \fi
      \else
        \Sub{1}{\ArrowHeadPit}\ArrowHeadPiti
        \@Bunten\yaziri@@M{(0,0)}\ArrowHeadPit\ArrowHeadPiti\yaziri@@M
        \Nuritubusi[\Nurizen]{(0,0)\yaziri@P\yaziri@@M\yaziri@Q(0,0)}%
%%%       {\allinethickness{.1pt}\Drawline{(0,0)\yaziri@P\yaziri@@M\yaziri@Q(0,0)}}%%%%%%%%%%%%%%%%%% 縁取り
      \fi
      \vecXY\yaziri@@M\yaziri@@Mx\yaziri@@My
      \@ifundefined{@xscale}{%
        \xdef\yaziri@@@M{\yaziri@@M}%
      }{%
        \@Div\yaziri@@Mx\@xscale\yaziri@@Mx
        \@Div\yaziri@@My\@yscale\yaziri@@My
        \xdef\yaziri@@@M{(\yaziri@@Mx,\yaziri@@My)}%
      }%
    \else\if t\ArrowHeadType
      \Put{(0,0)}{\Takakkei{\yaziri@P(0,0)\yaziri@Q}}%
    \else
      \Put{(0,0)}{\Drawline{\yaziri@P(0,0)\yaziri@Q}}%
    \fi\fi
  \fi
}}%
%
\def\Phyaziri{\@ifnextchar[{\@Phyaziri}{\@Phyaziri[\empty]}}%
\def\@Phyaziri[#1]#2{{%\thinlines
  \ifdim\Arr@wHeadSize pt>\z@
    \ifx r#1\Mulvec{-1}{#2}\@houkou\else\edef\@houkou{#2}\fi
    \@ifundefined{xunitlength}{}{%\MulS\@houkou\@houkou%%%%%%%%%%%%%%%%%%%%??????????
      \xunitlength=\unitlength\yunitlength=\unitlength
    }%
    \Strchr{#2}{,}\Phyaziri@tmp
    \ifnum\Phyaziri@tmp>\z@
      \Argvec\@houkou\houkou@kaku
    \else
      \edef\houkou@kaku{#2}%
    \fi
    \Add\houkou@kaku{180}\houkou@kaku
    \Add\houkou@kaku\ArrowHeadAngle\kaku@s
    \Sub\houkou@kaku\ArrowHeadAngle\kaku@e
    \Rdef(\Arr@wHeadSize,\kaku@s)\Phyaziri@P
    \Rdef(\Arr@wHeadSize,\kaku@e)\Phyaziri@Q
    \DegCos\ArrowHeadAngle\Phyaziri@c\Mul\Arr@wHeadSize\Phyaziri@c\Phyaziri@c
    \DegSin\ArrowHeadAngle\Phyaziri@s\Mul\Arr@wHeadSize\Phyaziri@s\Phyaziri@s
    \Tyuuten\Phyaziri@P\Phyaziri@Q\Phyaziri@@M
    \if f\ArrowHeadType
      \ifdim\ArrowHeadPit\p@=\z@
        \ifx\empty\nuri@iro
          \Nuritubusi[\Nurizen]{(0,0)\Phyaziri@P\Phyaziri@Q(0,0)}%
        \else
          \@iro\nuri@iro\Nuritubusi{(0,0)\Phyaziri@P\Phyaziri@Q(0,0)}%
        \fi
      \else
        \Sub{1}{\ArrowHeadPit}\ArrowHeadPiti
        \@Bunten\Phyaziri@@M{(0,0)}\ArrowHeadPit\ArrowHeadPiti\Phyaziri@@M
        \Nuritubusi[\Nurizen]{(0,0)\Phyaziri@P\Phyaziri@@M\Phyaziri@Q(0,0)}%
      \fi
      \vecXY\Phyaziri@@M\Phyaziri@@Mx\Phyaziri@@My
      \@ifundefined{@xscale}{%
        \xdef\Phyaziri@@@M{\Phyaziri@@M}%
      }{%
        \@Div\Phyaziri@@Mx\@xscale\Phyaziri@@Mx
        \@Div\Phyaziri@@My\@yscale\Phyaziri@@My
        \xdef\Phyaziri@@@M{(\Phyaziri@@Mx,\Phyaziri@@My)}%
      }%
    \else\if t\ArrowHeadType
      \Put{(0,0)}{\Takakkei{\Phyaziri@P(0,0)\Phyaziri@Q}}%
    \else
      \Put{(0,0)}{\Drawline{\Phyaziri@P(0,0)\Phyaziri@Q}}%
    \fi\fi
  \fi
}}%
%
  \def\ltatebou#1#2{%
    \Argvec{#1}\lt@a
    \exfor[;]\lt@P:=#2\do{\emathPut{\lt@P}{\rotatebox{\lt@a}{%
      \makebox(0,0){$\scriptscriptstyle |$}}}%
    }%
  }%
  \def\gtatebou#1#2{%
    \Argvec{(1,#1)}\lt@a
    \exfor[;]\lt@P:=#2\do{\emathPut{\lt@P}{\rotatebox{\lt@a}{%
      \makebox(0,0){$\scriptscriptstyle |$}}}%
    }%
  }%
  \def\ktatebou#1#2{%
    \exfor[;]\lt@P:=#2\do{\emathPut{\lt@P}{\rotatebox{#1}{%
      \makebox(0,0){$\scriptscriptstyle |$}}}%
    }%
  }%
  \def\Ltatebou#1#2#3{%
    \Subvec{#2}{#1}\Lt@vec
    \ltatebou\Lt@vec{#3}%
  }%
  \def\nLtatebou#1#2#3{%
    \Subvec{#2}{#1}\Lt@vec
    \perpvec\Lt@vec\Lt@vec@
    \ltatebou\Lt@vec@{#3}%
  }%
%
% 等辺記号
%   \Touhenkigou[#1]<#2><#3>(#4)#5#6
%     #1 : 記号（デフォルトは | ）
%     #2 : 個数
%     #3 : #2で複数を指定した場合の記号間間隔（デフォルト0.5pt）
%     #4 : 位置（デフォルトは0.5，すなわち中点）
%          or key=val
%             ex. haitiT=...
%     #5, #6 : 線分の両端
%
\def\Touhenkigou{\@ifnextchar[{\@Touhenkigou}{%
    \@Touhenkigou[$\scriptscriptstyle |$]}}%
\def\@Touhenkigou[#1]{\@ifnextchar<{\@@Touhenkigou[#1]}{%
    \@@Touhenkigou[#1]<1>}}%
\def\@@Touhenkigou[#1]<#2>{\@ifnextchar<{\@@@Touhenkigou[#1]<#2>}{%
  \@@@Touhenkigou[#1]<#2><0pt>}}%
\def\@@@Touhenkigou[#1]<#2><#3>{\@ifnextchar({\@@@@Touhenkigou[#1]<#2><#3>}{%
    \@@@@Touhenkigou[#1]<#2><#3>(0.5)}}%
\def\@@@@Touhenkigou[#1]<#2><#3>(#4)#5#6{%
% ----------------------------------------------------
    \define@key{emP}{kosuu}{\edef\Tk@kosuu{##1}}%
    \define@key{emP}{kankaku}{\EMedef\Tk@kankaku{##1}}%
    \define@key{emP}{kigou}{\def\Tk@kigou{##1}}%
% ----------------------------------------------------
%  \edef\TK@kankaku{0pt}%
  \def\Tk@kigou{#1}%
  \edef\Tk@kosuu{1}%
  \edef\Tk@kankaku{#3}%
  \edef\put@pos{#4}%
  \ifthenelse{\isodd{0#21}}{%
    \edef\Tk@kosuu{#2}%
  }{%
    \setkeys{emP}{#2}%
  }%
  \strchr{#4}{=}\T@tmp
  \ifnum\T@tmp>\z@
    \setkeys{emP}{#4}%
  \fi
  \exfor[;]\pp@c:=\put@pos\do{%
    \Bunten{#5}{#6}{\pp@c}{*}\T@m
    \Subvec{#6}{#5}\@v\Argvec\@v\@a
    \emathPut\T@m{\rotatebox{\@a}{%
      \ifcase\Tk@kosuu
        \or\makebox(0,0){\Tk@kigou}%
        \or\makebox(0,0){\Tk@kigou\hspace*{\Tk@kankaku}\Tk@kigou}%
        \or\makebox(0,0){\Tk@kigou\hspace*{\Tk@kankaku}\Tk@kigou
                        \hspace*{\Tk@kankaku}\Tk@kigou}%
      \fi
    }}%
  }%
}%
% 等辺記号
%   \touhenkigou[#1]<#2><#3>(#4)#5
%     #1 : 記号（デフォルトは | ）
%     #2 : 個数
%     #3 : #2で複数を指定した場合の記号間間隔（デフォルト0.5pt）
%     #4 : 位置（デフォルトは0.5，すなわち中点）
%     #5 : 線分列（区切子は`;'）
%
\def\touhenkigou{\@ifnextchar[{\@touhenkigou}{%
    \@touhenkigou[$\scriptscriptstyle |$]}}%
\def\@touhenkigou[#1]{\@ifnextchar<{\@@touhenkigou[#1]}{%
    \@@touhenkigou[#1]<1>}}%
\def\@@touhenkigou[#1]<#2>{\@ifnextchar<{\@@@touhenkigou[#1]<#2>}{%
  \@@@touhenkigou[#1]<#2><0pt>}}%
\def\@@@touhenkigou[#1]<#2><#3>{\@ifnextchar({\@@@@touhenkigou[#1]<#2><#3>}{%
    \@@@@touhenkigou[#1]<#2><#3>(0.5)}}%
\def\@@@@touhenkigou[#1]<#2><#3>(#4)#5{%
%\def\@@@touhenkigou[#1]<#2><#3>#4{%
    \def\touhenkigou@sub(##1,##2)(##3,##4){%
      \edef\touhenkigou@a{(##1,##2)}%
      \edef\touhenkigou@b{(##3,##4)}}%
  \argsep{#5}{;}{touhenkigou@tmp}\touhenkigou@n
  \Cfor{\edef\touhenkigou@i{0}}{\touhenkigou@i<\touhenkigou@n}{}\do{%
    \Incr\touhenkigou@i
    \edef\touhenkigou@arg{%
      \csname touhenkigou@tmp\romannumeral\touhenkigou@i\endcsname}%
    \expandafter\touhenkigou@sub\touhenkigou@arg
    \Touhenkigou[#1]<#2><#3>(#4)\touhenkigou@a\touhenkigou@b
  }%
}%
%
% 等弧記号
%     円弧の長さが等しいことを表す記号
% \Toukokigou
%   Toukokigou[#1]<#2>#3#4#5
%   #1 : 記号
%   #2 : 線分の本数
%   #3 : 円弧の中心
%   #4 : 弧の端点1
%   #5 : 弧の端点2
% \toukokigou
%   複数の弧を ; 区切りで並べる
%
\def\toukokigou{\@ifnextchar[{\@toukokigou}{%
  \@toukokigou[$\scriptscriptstyle |$]}}%
\def\@toukokigou[#1]{\@ifnextchar<{\@@toukokigou[#1]}{\@@toukokigou[#1]<1>}}%
\def\@@toukokigou[#1]<#2>#3{%
    \def\toukokigou@sub(##1,##2)(##3,##4)(##5,##6){%
      \edef\toukokigou@a{(##1,##2)}%
      \edef\toukokigou@b{(##3,##4)}%
      \edef\toukokigou@c{(##5,##6)}%
    }%
  \argsep{#3}{;}{toukokigou@tmp}\toukokigou@n
  \Cfor{\edef\toukokigou@i{0}}{\toukokigou@i<\toukokigou@n}{}\do{%
    \Incr\toukokigou@i
    \edef\toukokigou@arg{%
      \csname toukokigou@tmp\romannumeral\toukokigou@i\endcsname}%
    \expandafter\toukokigou@sub\toukokigou@arg
    \Toukokigou[#1]<#2>\toukokigou@a\toukokigou@b\toukokigou@c
  }%
}%
\def\Toukokigou{\@ifnextchar[{\@Toukokigou}{%
  \@Toukokigou[$\scriptscriptstyle |$]}}%
\def\@Toukokigou[#1]{\@ifnextchar<{\@@Toukokigou[#1]}{\@@Toukokigou[#1]<1>}}%
\def\@@Toukokigou[#1]<#2>#3#4#5{%
  \Subvec{#4}{#3}\Toukokigou@tmp\Argvec\Toukokigou@tmp\@hazimekaku
  \Subvec{#5}{#3}\Toukokigou@tmp\Argvec\Toukokigou@tmp\@owarikaku
  \ifdim\@owarikaku pt<\@hazimekaku pt\relax\Add\@owarikaku{360}\@owarikaku\fi
  \Add\@hazimekaku\@owarikaku\Toukokigou@tmp
  \@Div\Toukokigou@tmp{2}\Toukokigou@tmp
  \Kyori{#3}{#4}\@hankei
  \emathPut{#3}{\Rdef(\@hankei,\Toukokigou@tmp)\Toukokigou@M
    \Add\Toukokigou@tmp{90}\Toukokigou@tmp
    \emathPut\Toukokigou@M{\rotatebox{\Toukokigou@tmp}{%
      \ifnum#2=1\makebox(0,0)[c]{#1}\else
      \ifnum#2=2\makebox(0,0){#1\hspace*{0.5pt}#1}\else
      \ifnum#2=3\makebox(0,0){#1\hspace*{0.5pt}#1\hspace*{0.5pt}#1}%
      \fi\fi\fi}}}%
}%
%
%\def\Toukokigou{\@ifnextchar<{\@Toukokigou}{\@Toukokigou<1>}}%
%\def\@Toukokigou<#1>#2#3#4{%
%  \Subvec{#3}{#2}\Toukokigou@tmp\Argvec\Toukokigou@tmp\@hazimekaku
%  \Subvec{#4}{#2}\Toukokigou@tmp\Argvec\Toukokigou@tmp\@owarikaku
%  \ifdim\@owarikaku pt<\@hazimekaku pt\relax\Add\@owarikaku{360}\@owarikaku\fi
%  \Add\@hazimekaku\@owarikaku\Toukokigou@tmp
%  \@Div\Toukokigou@tmp{2}\Toukokigou@tmp
%  \Kyori{#2}{#3}\@hankei
%  \emathPut{#2}{\Rdef(\@hankei,\Toukokigou@tmp)\Toukokigou@M
%    \Add\Toukokigou@tmp{90}\Toukokigou@tmp
%    \emathPut\Toukokigou@M{\rotatebox{\Toukokigou@tmp}{%
%      \ifnum#1=1\makebox(0,0)[c]{$\scriptscriptstyle |$}\else
%      \ifnum#1=3\makebox(0,0)[c]{$\scriptscriptstyle |||$}\fi\fi\fi}}}%
%}%
%
% 平行記号
% 線分の中央に，記号 `>' を配置する。
% \heikoukigou[#1]#2
%   #1 : 記号の個数
%     または key=val
%       heikoukigoukosuu=記号の個数（デフォルト値は1）
%       heikoukigouiti  =記号の位置（デフォルト値は0.5, すなわち線分の中点）
%       heikoukigoukankaku=記号を複数配置するときの間隔
%                         （デフォルト値は 1mm）
%       heikoukigousize =記号の大きさ（デフォルト値は2）
%   #2 : 線分の列を`;'区切りで列記する．
%
\def\heikoukigou{\edef\heikoukigou@nomi{0}\@ifstar{\edef\heikoukigou@nomi{1}\@heikoukigou}{\@heikoukigou}}%
\def\@heikoukigou{\@ifnextchar[{\@@heikoukigou}{\@@heikoukigou[1]}}%
\def\@@heikoukigou[#1]#2{%
    \def\heikoukigou@sub(##1,##2)(##3,##4){%
      \edef\heikoukigou@a{(##1,##2)}%
      \edef\heikoukigou@b{(##3,##4)}}%
  \argsep{#2}{;}{heikoukigou@tmp}\heikoukigou@n
  \Cfor{\edef\heikoukigou@i{0}}{\heikoukigou@i<\heikoukigou@n}{}\do{%
    \Incr\heikoukigou@i
    \edef\heikoukigou@arg{%
      \csname heikoukigou@tmp\romannumeral\heikoukigou@i\endcsname}%
    \expandafter\heikoukigou@sub\heikoukigou@arg
    \@Heikoukigou[#1]\heikoukigou@a\heikoukigou@b
  }%
}%
%
% \Heikoukigou[#1]#2#3
%   #1 : 記号の個数
%   #2,#3 : 線分の両端の点
%
\def\HK@kankaku{1mm}%
\def\HeikoukigouKankaku#1{\def\HK@kankaku{#1}}%
%
\def\Heikoukigou{\edef\heikoukigou@nomi{0}\@ifstar{\edef\heikoukigou@nomi{1}\@Heikoukigou}{\@Heikoukigou}}%
\def\@Heikoukigou{\@ifnextchar[{\@@Heikoukigou}{\@@Heikoukigou[1]}}%
\def\@@Heikoukigou[#1]#2#3{{\def\ArrowHeadType{l}%
  \ifnum\EMps@mode=\@ne\gsave\fi
%
  \def\put@Heikoukigou##1{%
    \Sub{1}{##1}\p@Hk@b
    \@Bunten{#2}{#3}{##1}\p@Hk@b\p@Hk@P
    \Put\p@Hk@P{\Phyaziri\HK@vec}%
  }%
%
  \def\HK@kosuu{1}%
  \def\HK@iti{.5}%
  \def\HK@size{2}%
  \ukansan{\HK@kankaku}\HK@ukankaku
  \Subvec{#3}{#2}\HK@vec
  \Kyori{#2}{#3}\HK@kyori
  \@Div\HK@kyori{2}\HK@hkyori
  \define@key{emP}{heikoukigouiti}{\def\HK@iti{##1}}%
  \define@key{emP}{heikoukigoukosuu}{\def\HK@kosuu{##1}}%
  \define@key{emP}{heikoukigousize}{\def\HK@size{##1}}%
  \define@key{emP}{heikoukigoukankaku}{\ukansan{##1}\HK@ukankaku}%
  \thinlines
  \Strchr{#1}{=}\HK@tmp
  \ifnum\HK@tmp>\z@\setkeys{emP}{#1}\else\def\HK@kosuu{#1}\fi
  \changeArrowHeadSize{\HK@size}%
  \ifnum\HK@kosuu=\@ne
    \put@Heikoukigou{\HK@iti}%
  \else\ifnum\HK@kosuu=\tw@
    \put@Heikoukigou{\HK@iti}%
    \@Div\HK@ukankaku\HK@kyori\HK@tmp
    \Sub\HK@iti\HK@tmp\HK@@iti\put@Heikoukigou{\HK@@iti}%
  \else\ifnum\HK@kosuu=3\relax
    \put@Heikoukigou{\HK@iti}%
    \@Div\HK@ukankaku\HK@kyori\HK@tmp
    \Sub\HK@iti\HK@tmp\HK@@iti\put@Heikoukigou{\HK@@iti}%
    \Sub\HK@@iti\HK@tmp\HK@@iti\put@Heikoukigou{\HK@@iti}%
  \else\ifnum\HK@kosuu=4\relax
    \put@Heikoukigou{\HK@iti}%
    \@Div\HK@ukankaku\HK@kyori\HK@tmp
    \Sub\HK@iti\HK@tmp\HK@@iti\put@Heikoukigou{\HK@@iti}%
    \Sub\HK@@iti\HK@tmp\HK@@iti\put@Heikoukigou{\HK@@iti}%
    \Sub\HK@@iti\HK@tmp\HK@@iti\put@Heikoukigou{\HK@@iti}%
  \else
    \errmessage{emathPh Error : 平行記号の個数は 1,2,3,4 のいずれかです。}%
  \fi\fi\fi\fi
  \ifnum\EMps@mode=\@ne\grestore\fi
  \ifnum\heikoukigou@nomi>\z@\else
    \Drawline{#2#3}%
  \fi
  }}%
%
% -----------------------------------------------\hen_ko -------------
% 線分の傍に円弧状のものをつけ長さなどを示す．
%
%   \hen_ko[曲線上のドット数]<弧と線分の距離係数>
%           (端点１ x,y)(端点２ x,y)[文字配置]<文字位置係数>{文字列}%
%
%     **********************************************
%     * このコマンドで，                           *
%     *     円弧ではなくベジェ曲線を用いること     *
%     *     弧の中央部を切って文字列を置く方法     *
%     * は，bookworm さん (BYV01204) のご提案です．*
%     *     ありがとうございます．＞ bookworm さん *
%     **********************************************
%
 \def\henko@dot{\En*[1]\O@@\henko@dotsize@}%
 \def\henkodot#1{\def\henko@dot{#1}}%
 \def\henko@dotsize{.5pt}%
 \def\henkodotsize#1{\edef\henko@dotsize{#1}}%
 \define@key{emP}{henkosep}{\edef\henko@sep{#1}}%
 \define@key{emP}{henkodot}{\def\henko@dot{#1}}%
 \define@key{emP}{henkodotN}{\def\henko@dot@N{#1}}%
 \define@key{emP}{henkodotsize}{\edef\henko@dotsize{#1}}%
 \define@key{emP}{henkomozikaiten}[1]{\edef\henko@mozikaiten{#1}}%
%
 \define@key{emPs}{henkosep}{\edef\henko@sep{#1}}%
 \define@key{emPs}{henkodot}{\def\henko@dot{#1}}%
 \define@key{emPs}{henkodotN}{\def\henko@dot@N{#1}}%
 \define@key{emPs}{henkodotsize}{\edef\henko@dotsize{#1}}%
 \define@key{emPs}{henkomozikaiten}{\edef\henko@mozikaiten{#1}}%
%
%   弧の中央部を切って，そこに文字列を置くためのスイッチ
\newif\ifsironuki
\sironukitrue
%\ifx\fmtname\tmpname\sironukitrue\else\sironukifalse\fi
%
\def\hen_ko{\@ifnextchar[{\@hen_ko}{\@hen_ko[0]}}%
\def\@hen_ko[#1]{\@ifnextchar<{\@@hen_ko[#1]}{\@@hen_ko[#1]<1>}}%
\def\@@hen_ko[#1]<#2>(#3,#4)(#5,#6){%
    \@ifnextchar[{\@@@hen_ko[#1]<#2>(#3,#4)(#5,#6)}{%
        \@@@hen_ko[#1]<#2>(#3,#4)(#5,#6)[c]}}%
\def\@@@hen_ko[#1]<#2>(#3,#4)(#5,#6)[#7]{%
    \@ifnextchar<{\@@@@hen_ko[#1]<#2>(#3,#4)(#5,#6)[#7]}{%
        \@@@@hen_ko[#1]<#2>(#3,#4)(#5,#6)[#7]<\empty>}}%
\def\@@@@hen_ko[#1]<#2>(#3,#4)(#5,#6)[#7]<#8>#9{%
   \def\@syukusyo{#2}%
    \Add{#3}{#5}\henko@x\@Div\henko@x{2}\henko@x%
    \Add{#4}{#6}\henko@y\@Div\henko@y{2}\henko@y%
    \Sub{#6}{#4}\henko@@x\Sub{#3}{#5}\henko@@y%
    \Unitvec{(\henko@@x,\henko@@y)}\henko@@xy
    \vecXY\henko@@xy\henko@@x\henko@@y
      \@Div{40}{\strip@pt\unitlength}\u@pt%
      \Mul\u@pt\henko@@x\henko@@x\Mul\u@pt\henko@@y\henko@@y%
    \Mul\@syukusyo\henko@@x\henko@@x\Add\henko@x\henko@@x\henko@xx%
    \Mul\@syukusyo\henko@@y\henko@@y\Add\henko@y\henko@@y\henko@yy%
    \ifx\empty #1%
        \qbezier(#3,#4)(\henko@xx,\henko@yy)(#5,#6)%
    \else\ifx 0#1\else
        \qbezier[#1](#3,#4)(\henko@xx,\henko@yy)(#5,#6)\fi\fi%
    \edef\put@opt{}%
    \edef\henko@sep{1pt}%
    \def\henko@mozikaiten{0}%
    \edef\yazirusi@opt{\empty}%
    \Strchr{#8}{=}\Henko@tmp
    \ifnum\Henko@tmp>\z@
      \setkeys{emP}{#8}\def\Henko@keisuu{\ifsironuki.5\else.8\fi}\else
      \ifx\empty #8\def\Henko@keisuu{\ifsironuki.5\else.8\fi}\else
      \def\Henko@keisuu{#8}\fi\fi
\ifthenelse{\equal{\yazirusi@opt}{a}\or\equal{\yazirusi@opt}{b}}{%
  \Subvec{(#5,#6)}{(\henko@xx,\henko@yy)}\henko@tmp
% \emathPut{(#5,#6)}{\yaziri\henko@tmp}%
  \Yaziri{(#5,#6)}{\henko@tmp}%
}{}%
\ifthenelse{\equal{\yazirusi@opt}{r}\or\equal{\yazirusi@opt}{b}}{%
  \Subvec{(#3,#4)}{(\henko@xx,\henko@yy)}\henko@tmp
%  \emathPut{(#3,#4)}{\yaziri\henko@tmp}%
  \Yaziri{(#3,#4)}{\henko@tmp}%
}{}%
    \ifnum\henko@mozikaiten=\z@
      \edef\henko@mozikaitenkaku{0}%
    \else
      \Subvec{(#3,#4)}{(#5,#6)}\henko@v\Argvec\henko@v\henko@mozikaitenkaku
    \fi
    \ifdim \henko@mozikaitenkaku pt>90pt\relax
      \Sub\henko@mozikaitenkaku{180}\henko@mozikaitenkaku\else
    \ifdim \henko@mozikaitenkaku pt<-90pt\relax
      \Add\henko@mozikaitenkaku{180}\henko@mozikaitenkaku\fi\fi
    \ifnum\henko@mozikaiten<\z@\relax
      \ifdim \henko@mozikaitenkaku pt>\z@
        \Sub\henko@mozikaitenkaku{180}\henko@mozikaitenkaku
      \else
        \Add\henko@mozikaitenkaku{180}\henko@mozikaitenkaku
      \fi
    \fi
    \Mul\Henko@keisuu\henko@@x\henko@@x
    \Mul\Henko@keisuu\henko@@y\henko@@y%
    \Add\henko@x\henko@@x\henko@xx\Add\henko@y\henko@@y\henko@yy%
    \IFempty{#9}{}{%
      \ifx\put@opt\empty
        \ifnum\henko@mozikaiten=\z@%
          \put(\henko@xx,\henko@yy){%
          \ifsironuki{\fboxsep\henko@sep
            \makebox(0,0)[#7]{\colorbox{white}{#9}}}%
          \else\makebox(0,0)[#7]{#9}\fi}%
        \else
          \ifsironuki{\fboxsep\henko@sep
               \emathPut[background=white,kaiten=\henko@mozikaitenkaku]{%
               (\henko@xx,\henko@yy)}(0,0)[#7]{#9}}%
          \else\put(\henko@xx,\henko@yy){\makebox(0,0)[#7]{%
              \rotatebox{\henko@mozikaitenkaku}{#9}}}\fi%
        \fi
      \else
        \edef\Henko@tmp{{(\henko@xx,\henko@yy)}\put@opt}%
        \expandafter\emathPut\Henko@tmp{%
        \ifsironuki{\fboxsep\henko@sep\rotatebox{\henko@mozikaitenkaku}{\colorbox{white}{#9}}}%
        \else\rotatebox{\henko@mozikaitenkaku}{#9}\fi}%
      \fi}%
  }%
%
\def\Hen_ko{\@ifnextchar[{\Hen@ko}{\Hen@ko[\empty]}}%
\def\Hen@ko[#1]{\@ifnextchar<{\@Henko[#1]}{\@Henko[#1]<.25>}}%
\def\@Henko[#1]<#2>#3#4{%
  \Kyorii{#3}{#4}\d@Henko
  \ifthenelse{\lengthtest{\d@Henko pt>0.005pt}}{\@Henko@{#3}{#4}[#1]<#2>}{}}%
\def\@Henko@#1#2[#3]<#4>{%
  \edef\@tmp{#1#2}%
  \expandafter\@@Henko\@tmp[#3]<#4>}%
\def\@@Henko(#1,#2)(#3,#4)[#5]<#6>{%
  \@@hen_ko[#5]<#6>(#1,#2)(#3,#4)}%
%
% \HenKo[#1]<#2>#3#4#5
%
%   #1: 弧を点線にする場合，点の個数(*を指定した場合は，一任)
%   #2: key=val
%         henkoH=.. 辺と弧の距離(単位付数値) デフォルト値=1.6ex
%         henkohi=.. 辺と弧の距離を右辺値倍する
%         putpos=.. 
%         putoption=..
%         henkosep=.. (白抜きボックスの \fboxsep)
%         yazirusi=a/r/b
%         henkomozikaiten=1/-1
%         linewidth=..
%         dash=..
%         henkotype=..
%            0=円弧   (arc) : default
%            1=楕円弧 (ellipse)
%            2=折れ線 (triangle)
%            3 平行線 (parallel)
%            4=長方形(oval)Drawline (bracket)
%            6=台形 (trapezoid)
%            7=小括弧 (paren)
%            8=中括弧 (brace)
%         henkocolor=..
%         henkosideb=.. 0〜1
%         henkosidet=..0〜1
%         henkosidecolor=..
%         henkosideoption=
%         Hamidasi
%   #3,#4 : 辺両端の点
%   #5 : 配置する文字列
%
\def\henko@fbox#1{\protect #1}%
%
\define@key{emP}{fbox}{\def\henko@fbox{#1}}%
\define@key{emPs}{fbox}{\def\henko@fbox{#1}}%
\define@key{emP}{henkoH}{%
  \ifthenelse{\equal{#1}{-}}{%
    \setlength{\@tempdima}{\henko@H}%
    \setlength{\@tempdima}{-\@tempdima}%
  }{%
    \Headchar{#1}\henkoH@a\henkoH@b
    \if .\henkoH@a
      \Headchar{\henkoH@b}\henkoH@c\henkoH@d
      \if +\henkoH@c
        \setlength{\@tempdima}{\henko@H\henkoH@b}%
      \else\if -\henkoH@c
        \setlength{\@tempdima}{\henko@H\henkoH@b}%
      \else
        \setlength{\@tempdima}{#1}%
      \fi\fi
    \else
      \setlength{\@tempdima}{#1}%
    \fi
  }%
  \edef\henko@H{\the\@tempdima}%
}%
\define@key{emPs}{henkoH}{%
  \ifthenelse{\equal{#1}{-}}{%
    \setlength{\@tempdima}{\henko@H}%
    \setlength{\@tempdima}{-\@tempdima}%
  }{%
    \Headchar{#1}\henkoH@a\henkoH@b
    \if .\henkoH@a
      \Headchar{\henkoH@b}\henkoH@c\henkoH@d
      \if +\henkoH@c
        \setlength{\@tempdima}{\henko@H\henkoH@b}%
      \else\if -\henkoH@c
        \setlength{\@tempdima}{\henko@H\henkoH@b}%
      \else
        \setlength{\@tempdima}{#1}%
      \fi\fi
    \else
      \setlength{\@tempdima}{#1}%
    \fi
  }%
  \edef\henko@H{\the\@tempdima}%
}%
\define@key{emP}{henkomoziH}{\def\HenKo@moziH{#1}}%
\define@key{emP}{henkohi}{\@tempdima=1.6ex\@tempdima=#1\@tempdima
  \edef\henko@H{\the\@tempdima}}%
\define@key{emP}{henkotype}{\HenKoType{#1}}%
\edef\trapezoid@angle{45}%
\define@key{emP}{trapezoidangle}{\edef\trapezoid@angle{#1}}%
\define@key{emP}{henkosideb}{\def\side@b{#1}}%
\define@key{emP}{henkosidet}{\def\side@t{#1}}%
\define@key{emP}{henkocolor}{\def\henko@color{#1}}%
\define@key{emP}{henkosidecolor}{\def\henkoside@color{#1}}%
\define@key{emP}{henkosideoption}{\def\henkoside@option{#1}}%
\define@key{emP}{bezierP}{\def\bezier@P{#1}}%
\define@key{emP}{bezierQ}{\def\bezier@Q{#1}}%
\define@key{emP}{agezoko}{\ukansan{#1}\age@zokoA\edef\age@zokoB{\age@zokoA}}%
\define@key{emP}{agezokoA}{\ukansan{#1}\age@zokoA}%
\define@key{emP}{agezokoB}{\ukansan{#1}\age@zokoB}%
\define@key{emP}{Agezoko}{\ukansan{#1}\age@zokoA\edef\age@zokoB{\age@zokoA}}%
\define@key{emP}{AgezokoA}{\ukansan{#1}\age@zokoA}%
\define@key{emP}{AgezokoB}{\ukansan{#1}\age@zokoB}%
\define@key{emP}{agezokovi}{\edef\agezokov@i{#1}}%
\define@key{emP}{agezokovii}{\edef\agezokov@ii{#1}}%
\define@key{emP}{Agezokovi}{\@Agezokovi#1}%
  \def\@Agezokovi(#1,#2){%
    \ukansan{#1}\agezoko@x\ukansan{#2}\agezoko@y\edef\agezokov@i{(\agezoko@x,\agezoko@y)}}%
\define@key{emP}{Agezokovii}{\@Agezokovii#1}%
  \def\@Agezokovii(#1,#2){%
    \ukansan{#1}\agezoko@x\ukansan{#2}\agezoko@y\edef\agezokov@ii{(\agezoko@x,\agezoko@y)}}%
\define@key{emP}{Agezokov}{\@Agezokovi#1\relax\@Agezokovii#1}%
\define@key{emP}{Hamidasi}{\ukansan{#1}\hamidasi@}%
\define@key{emP}{HamidasiA}{\ukansan{#1}\hamidasi@A}%
\define@key{emP}{HamidasiB}{\ukansan{#1}\hamidasi@B}%
\define@key{emP}{hamidasikaku}{\edef\hamidasi@kaku{#1}}%
\define@key{emP}{sironuki}{\csname sironuki#1\endcsname}%
%
\define@key{emPs}{henkomoziH}{\def\HenKo@moziH{#1}}%
\define@key{emPs}{henkohi}{\@tempdima=1.6ex\@tempdima=#1\@tempdima
  \edef\henko@H{\the\@tempdima}}%
\define@key{emPs}{henkotype}{\HenKoType{#1}}%
\edef\trapezoid@angle{45}%
\define@key{emPs}{trapezoidangle}{\edef\trapezoid@angle{#1}}%
\define@key{emPs}{henkosideb}{\def\side@b{#1}}%
\define@key{emPs}{henkosidet}{\def\side@t{#1}}%
\define@key{emPs}{henkocolor}{\def\henko@color{#1}}%
\define@key{emPs}{henkosidecolor}{\def\henkoside@color{#1}}%
\define@key{emPs}{henkosideoption}{\def\henkoside@option{#1}}%
\define@key{emPs}{bezierP}{\def\bezier@P{#1}}%
\define@key{emPs}{bezierQ}{\def\bezier@Q{#1}}%
\define@key{emPs}{agezoko}{\ukansan{#1}\age@zokoA\edef\age@zokoB{\age@zokoA}}%
\define@key{emPs}{agezokoA}{\ukansan{#1}\age@zokoA}%
\define@key{emPs}{agezokoB}{\ukansan{#1}\age@zokoB}%
\define@key{emPs}{Agezoko}{\ukansan{#1}\age@zokoA\edef\age@zokoB{\age@zokoA}}%
\define@key{emPs}{AgezokoA}{\ukansan{#1}\age@zokoA}%
\define@key{emPs}{AgezokoB}{\ukansan{#1}\age@zokoB}%
\define@key{emPs}{agezokovi}{\edef\agezokov@i{#1}}%
\define@key{emPs}{agezokovii}{\edef\agezokov@ii{#1}}%
\define@key{emPs}{Agezokovi}{\@Agezokovi#1}%
  \def\@Agezokovi(#1,#2){%
    \ukansan{#1}\agezoko@x\ukansan{#2}\agezoko@y\edef\agezokov@i{(\agezoko@x,\agezoko@y)}}%
\define@key{emPs}{Agezokovii}{\@Agezokovii#1}%
  \def\@Agezokovii(#1,#2){%
    \ukansan{#1}\agezoko@x\ukansan{#2}\agezoko@y\edef\agezokov@ii{(\agezoko@x,\agezoko@y)}}%
\define@key{emPs}{Agezokov}{\@Agezokovi#1\relax\@Agezokovii#1}%
\define@key{emPs}{Hamidasi}{\ukansan{#1}\hamidasi@}%
\define@key{emPs}{HamidasiA}{\ukansan{#1}\hamidasi@A}%
\define@key{emPs}{HamidasiB}{\ukansan{#1}\hamidasi@B}%
\define@key{emPs}{hamidasikaku}{\edef\hamidasi@kaku{#1}}%
\define@key{emPs}{sironuki}{\csname sironuki#1\endcsname}%
%
\def\henko@type{0}%
\def\HenKoType#1{%
  \ifthenelse{\equal{#1}{arc}}{\edef\henko@type{0}}{%
    \ifthenelse{\equal{#1}{ellipse}}{\edef\henko@type{1}}{%
      \ifthenelse{\equal{#1}{triangle}}{\edef\henko@type{2}}{%
        \ifthenelse{\equal{#1}{parallel}}{\edef\henko@type{3}}{%
          \ifthenelse{\equal{#1}{bracket}}{\edef\henko@type{4}}{%
            \ifthenelse{\equal{#1}{bezier}}{\edef\henko@type{5}}{%
             \ifthenelse{\equal{#1}{trapezoid}}{\edef\henko@type{6}}{%
              \ifthenelse{\equal{#1}{paren}}{\edef\henko@type{7}}{%
                \ifthenelse{\equal{#1}{brace}}{\edef\henko@type{8}}{%
                  \def\henko@type{#1}}%
                }%
              }%
            }%
          }%
        }%
      }%
    }%
  }%
}%
\def\zituzahyo#1#2{%
  \@ifundefined{xunitlength}{\edef#2{#1}}{%
    \vecXY{#1}\zituza@x\zituza@y
    \kansan{\zituza@x\xunitlength}{\unitlength}\zituza@x
    \kansan{\zituza@y\yunitlength}{\unitlength}\zituza@y
    \edef#2{(\zituza@x,\zituza@y)}}}%
\def\invzituzahyo#1#2{%
  \@ifundefined{xunitlength}{\edef#2{#1}}{%
    \vecXY{#1}\zituza@x\zituza@y
    \kansan{\zituza@x\unitlength}{\xunitlength}\zituza@x
    \kansan{\zituza@y\unitlength}{\yunitlength}\zituza@y
    \edef#2{(\zituza@x,\zituza@y)}}}%
%
%\newbox\henko@box
%
\def\default@henko@H{1.6ex}%
\def\henkoH#1{\edef\default@henko@H{#1}}%
%
\def\HenKo{\@ifnextchar[{\@HenKo}{\@HenKo[\empty]}}%
\def\@HenKo[#1]{\@ifnextchar<{\@@HenKo[#1]}{\@@HenKo[#1]<\empty>}}%
\def\@@HenKo[#1]<#2>#3#4#5{%
\@ifundefined{ifcolors@}{\errmessage{HenKo needs color.sty}}{}%
\ifnum\EMps@mode=\@ne\gsave\fi
{%
  \edef\hasenLG@opt{\empty}%
%  \sironukitrue
  \@ifundefined{xunitlength}{%
    \edef\HenKo@A{#3}%
    \edef\HenKo@B{#4}%
  }{%
    \zituzahyo{#3}\HenKo@A
    \zituzahyo{#4}\HenKo@B
    \kansan{\xmin\xunitlength}{\unitlength}\xmin
    \kansan{\ymin\yunitlength}{\unitlength}\ymin
    \xunitlength=\unitlength
    \yunitlength=\unitlength
    \def\@xscale{1}%
    \def\@yscale{1}%
  }%
  \def\henko@sep{1pt}%
  \def\henko@H{\default@henko@H}%
  \edef\cur@dash{\empty}%
  \edef\hasen@opt{\empty}%
  \edef\hamidasi@{\empty}%
  \edef\hamidasi@A{\empty}%
  \edef\hamidasi@B{\empty}%
  \edef\put@pos{\empty}%
  \def\put@opt{(0,0)[c]}%
  \edef\yazirusi@opt{\empty}%
  \edef\henko@color{\empty}%
  \edef\henkoside@color{\empty}%
  \edef\henkoside@option{\empty}%
  \def\henko@mozikaiten{0}%
  \edef\oresen@name{\empty}%
  \edef\HenKo@moziH{0pt}%
  \def\oval@r{0}%
  \edef\age@zokoA{\empty}%
  \edef\age@zokoB{\empty}%
  \edef\agezokov@i{\empty}%
  \edef\agezokov@ii{\empty}%
  \edef\paint@option{\empty}%
  \edef\henko@dot@N{#1}%
  \ifx\empty #2\else
    \isnumber{#2}{%
      \@tempdima\henko@H
      \@tempdima 2.5\@tempdima
      \@tempdima #2\@tempdima
      \edef\henko@H{\the\@tempdima}%
    }{%
%      \@ifundefined{psDrawline}{\setkeys{emP}{#2}}{\setkeys{emPs}{#2}}%
      \@ifundefined{EMps@filename}{\setkeys{emP}{#2}}{\setkeys{emPs}{#2}}%
    }%
  \fi
      \ifx\empty\hamidasi@
        \ifx\empty\hamidasi@A\else
          \Subvec\HenKo@B\HenKo@A\HenKo@AB
          \Unitvec\HenKo@AB\HenKo@u
          \Mulvec\hamidasi@A\HenKo@u\HenKo@v
          \Subvec\HenKo@A\HenKo@v\HenKo@A
        \fi
        \ifx\empty\hamidasi@B\else
          \Subvec\HenKo@B\HenKo@A\HenKo@AB
          \Unitvec\HenKo@AB\HenKo@u
          \Mulvec\hamidasi@B\HenKo@u\HenKo@v
          \Addvec\HenKo@B\HenKo@v\HenKo@B
        \fi
      \else
        \Subvec\HenKo@B\HenKo@A\HenKo@AB
        \Unitvec\HenKo@AB\HenKo@u
        \Mulvec\hamidasi@\HenKo@u\HenKo@v
        \Subvec\HenKo@A\HenKo@v\HenKo@A
        \Addvec\HenKo@B\HenKo@v\HenKo@B
      \fi
  \ifx\empty\agezokov@i\else\Addvec\HenKo@A\agezokov@i\HenKo@A\fi
  \ifx\empty\agezokov@ii\else\Addvec\HenKo@B\agezokov@ii\HenKo@B\fi
  \ifx\empty\age@zokoB
    \edef\HenKo@BB{\HenKo@B}%
  \else
    \Kaiten[\age@zokoB]\HenKo@B\HenKo@A{90}\HenKo@BB
  \fi
  \ifx\empty\age@zokoA
    \edef\HenKo@AA{\HenKo@A}%
  \else
    \Kaiten[\age@zokoA]\HenKo@A\HenKo@B{-90}\HenKo@AA
  \fi
  \edef\HenKo@A{\HenKo@AA}%
  \edef\HenKo@B{\HenKo@BB}%
  \@Bunten{\HenKo@A}{\HenKo@B}11\HenKo@M
  \Kyori{\HenKo@A}{\HenKo@M}\HenKo@AM
  \ukansan\henko@H\HenKo@MV
  \ifdim\henko@H=\z@
    \edef\HenKo@r{1000}%
  \else
    \@Div\HenKo@AM\HenKo@MV\HenKo@r
  \fi
  \Mulself\HenKo@r\HenKo@AM
  \Addself\HenKo@r\HenKo@MV
  \Divself\HenKo@r{2}%
  \Sub\HenKo@r\HenKo@MV\HenKo@CM
  \Kaiten[\HenKo@CM]\HenKo@M{\HenKo@B}{90}\HenKo@C
  \Kaiten[\HenKo@MV]\HenKo@M{\HenKo@B}{-90}\HenKo@V
  \xdef\HenKoTyuuten{\HenKo@V}%
  \ifnum\henko@mozikaiten=\z@
      \edef\henko@mozikaitenkaku{0}%
  \else
      \Subvec\HenKo@A\HenKo@B\henko@v\Argvec\henko@v\henko@mozikaitenkaku
  \fi
  \ifdim \henko@mozikaitenkaku pt>90pt\relax
      \Sub\henko@mozikaitenkaku{180}\henko@mozikaitenkaku\else
  \ifdim \henko@mozikaitenkaku pt<-90pt\relax
      \Add\henko@mozikaitenkaku{180}\henko@mozikaitenkaku\fi\fi
  \ifnum\henko@mozikaiten<\z@
    \ifdim \henko@mozikaitenkaku pt>\z@
        \Sub\henko@mozikaitenkaku{180}\henko@mozikaitenkaku
    \else
        \Add\henko@mozikaitenkaku{180}\henko@mozikaitenkaku
    \fi
  \fi
%%%%%%% henkoH<0 の場合の処理 2007/03/25 %%%%%%%%%
\ifdim\HenKo@r\p@<\z@
  \edef\HenKo@tmp{\HenKo@A}%
  \edef\HenKo@A{\HenKo@B}%
  \edef\HenKo@B{\HenKo@tmp}%
  \Sub{1}{\put@pos}\put@pos%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\fi
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \xdef\HenKoTyuusin{\HenKo@C}%
  \Subvec\HenKo@A\HenKo@C\HenKo@tmp\Argvec\HenKo@tmp\HenKo@argi
  \Subvec\HenKo@B\HenKo@C\HenKo@tmp\Argvec\HenKo@tmp\HenKo@argii
  \ifdim\HenKo@argii\p@<\HenKo@argi\p@\Addself\HenKo@argii{360}\fi
  \ifx\empty \henko@dot@N\relax
    \bgroup%\@ifundefined{henko@color}{}{\color{\henko@color}}\relax
    \edef\henko@yazirusi{\yazirusi@opt}%
    \ifcase\henko@type% henkotype=0(arc)
      \ifx\empty\hasen@opt
        \ifx\empty\paint@option\else
          \KinziEnko\HenKo@C\HenKo@r\HenKo@argi\HenKo@argii\EK@oresen
          \EMedef\temp@a{\paint@option{\EK@oresen}}%
          \expandafter\emPaint\temp@a
        \fi
        \put(0,0){{%
            \ifx\empty\henko@color
              \Enko<yazirusi=\henko@yazirusi>%
                \HenKo@C\HenKo@r\HenKo@argi\HenKo@argii
            \else
              \Enko<yazirusi=\henko@yazirusi,iro=\henko@color>%
                \HenKo@C\HenKo@r\HenKo@argi\HenKo@argii
            \fi
        }}%
      \else
%        \emathPut\HenKo@C{\expandafter\Daenko\hasen@opt\HenKo@r\HenKo@r\HenKo@argi\HenKo@argii}%
%        \Enko<hasen=\hasen@opt>\HenKo@C\HenKo@r\HenKo@argi\HenKo@argii
        \put(0,0){{%
          \ifx\empty\henko@color\else\color{\henko@color}\fi
          \ifx\empty\hasenLG@opt
            \edef\henko@opt@{<yazirusi=\henko@yazirusi,hasen=\hasen@opt>}%
          \else
            \edef\Henko@tmp{\hasenLG@opt}%
            \edef\henko@opt@{<yazirusi=\henko@yazirusi,hasenLG={\Henko@tmp}>}%
          \fi
          \expandafter\Enko\henko@opt@\HenKo@C\HenKo@r\HenKo@argi\HenKo@argii
        }}%
      \fi
      \ifthenelse{\equal\oresen@name\empty}{}{%
        \KinziEnko\HenKo@C\HenKo@r
          {hazimeten=\HenKo@A}{owariten=\HenKo@B}\HenKo@tmp
        \expandafter\xdef\csname\oresen@name\endcsname{\HenKo@tmp}%
      }%
    \or% henkotype=1 (ellipse)
      \Subvec\HenKo@B\HenKo@A\HenKo@AB
      \Argvec\HenKo@AB\HenKo@ziku
      \@ifundefined{psdraw}{%
        \Put\HenKo@M{\rotatebox{\HenKo@ziku}{%
          \ifx\empty\hasen@opt
            \Daenko{\HenKo@AM}{\HenKo@MV}{-180}{0}%
          \else
            \expandafter\Daenko\hasen@opt{\HenKo@AM}{\HenKo@MV}{-180}{0}%
          \fi
        }}%
      }{%
        \EPSkaiten\HenKo@M\HenKo@ziku{%
          \Put\HenKo@M{\Daenko{\HenKo@AM}{\HenKo@MV}{-180}{0}}%
        }%
      }%
    \or% henkotype=2 (triangle)
      \ifx\empty\put@pos\else
        \Subvec\HenKo@B\HenKo@A\HenKo@AB
        \Sub\put@pos{.5}\put@pos@t
        \Mulvec\put@pos@t\HenKo@AB\HenKo@Vc
        \Addvec\HenKo@V\HenKo@Vc\HenKo@V
      \fi
          \ifx\empty\yazirusi@opt
            \Drawline<iro=\henko@color>{\HenKo@A\HenKo@V\HenKo@B}%
          \else\if a\yazirusi@opt
            \put(0,0){\@iro\henko@color\Drawline{\HenKo@A\HenKo@V}\ArrowLine\HenKo@V\HenKo@B}%
          \else\if r\yazirusi@opt
            \put(0,0){\@iro\henko@color\Drawline{\HenKo@B\HenKo@V}\ArrowLine\HenKo@V\HenKo@A}%
          \else\if b\yazirusi@opt
            \put(0,0){\@iro\henko@color\ArrowLine\HenKo@V\HenKo@B\ArrowLine\HenKo@V\HenKo@A}%
          \fi\fi\fi\fi
    \or% henkotype=3 (parallel)
          \Kaiten[\HenKo@MV]\HenKo@A{\HenKo@B}{-90}\HenKo@VA
          \Kaiten[\HenKo@MV]\HenKo@B{\HenKo@A}{90}\HenKo@VB
          \ifx\empty\yazirusi@opt
            \Drawline<iro=\henko@color>{\HenKo@VA\HenKo@VB}%
          \else\if a\yazirusi@opt
            \put(0,0){\@iro\henko@color
%            \ArrowLine\HenKo@VA\HenKo@VB%
            \Drawline<yazirusi=a>{\HenKo@VA\HenKo@VB}%
            }%
          \else\if r\yazirusi@opt
            \put(0,0){\@iro\henko@color
%            \ArrowLine\HenKo@VB\HenKo@VA%
            \Drawline<yazirusi=r>{\HenKo@VA\HenKo@VB}%
            }%
          \else
            \put(0,0){\@iro\henko@color
%            \ArrowLine[b]\HenKo@VB\HenKo@VA%
            \Drawline<yazirusi=b>{\HenKo@VA\HenKo@VB}%
            }%
          \fi\fi\fi
          \@ifundefined{side@b}{%
            \xdef\HenKosideBi{\HenKo@A}%
            \xdef\HenKosideBii{\HenKo@B}%
            \xdef\HenKosideTi{\HenKo@VA}%
            \xdef\HenKosideTii{\HenKo@VB}%
          }{%
            \ifdim\side@b\p@=\z@
              \edef\side@P{\HenKo@A}%
              \edef\side@Q{\HenKo@B}%
            \else
              \Sub{1}\side@b\side@bb
              \@Bunten\HenKo@A\HenKo@VA\side@b\side@bb\side@P
              \@Bunten\HenKo@B\HenKo@VB\side@b\side@bb\side@Q
            \fi
            \ifdim\side@t\p@=\z@
              \edef\side@PP{\HenKo@VA}%
              \edef\side@QQ{\HenKo@VB}%
            \else
              \Sub{1}\side@t\side@tt
              \@Bunten\HenKo@A\HenKo@VA\side@t\side@tt\side@PP
              \@Bunten\HenKo@B\HenKo@VB\side@t\side@tt\side@QQ
            \fi
            \ifx\empty\henkoside@option
              \EMedef\henkoside@option{<iro=\henkoside@color>}%
            \else
              \EMedef\henkoside@option{<iro=\henkoside@color,\henkoside@option>}%
            \fi
%\typeout{henkosideoption=\henkoside@option}%
\edef\yazirusi@opt{\empty}%
            \expandafter\Drawline\henkoside@option{\side@Q\side@QQ}%
            \expandafter\Drawline\henkoside@option{\side@P\side@PP}%
            \xdef\HenKosideBi{\side@P}%
            \xdef\HenKosideBii{\side@Q}%
            \xdef\HenKosideTi{\side@PP}%
            \xdef\HenKosideTii{\side@QQ}%
          }%
    \or% henkotype=4 (bracket)
          \Kaiten[\HenKo@MV]\HenKo@A{\HenKo@B}{-90}\HenKo@VA
          \Kaiten[\HenKo@MV]\HenKo@B{\HenKo@A}{90}\HenKo@VB
          \xdef\HenKoA{\HenKo@A}%
          \xdef\HenKoB{\HenKo@B}%
          \xdef\HenKoVA{\HenKo@VA}%
          \xdef\HenKoVB{\HenKo@VB}%
          \ifthenelse{\lengthtest{\oval@r\p@=\z@}}{%
            \ifx\empty\paint@option\else
              \EMedef\temp@a{\paint@option{\HenKo@A\HenKo@VA\HenKo@VB\HenKo@B}}%
              \expandafter\emPaint\temp@a
            \fi
            \ifx\empty\yazirusi@opt
              \Drawline<iro=\henko@color>{\HenKo@A\HenKo@VA\HenKo@VB\HenKo@B}%
            \else\if a\yazirusi@opt
              \put(0,0){\@iro\henko@color
                \ArrowLine\HenKo@VB\HenKo@B
                \Drawline<yazirusi=>{\HenKo@A\HenKo@VA\HenKo@VB}%
              }%
            \else\if r\yazirusi@opt
              \put(0,0){\@iro\henko@color
                \ArrowLine\HenKo@VA\HenKo@A
                \Drawline<yazirusi=>{\HenKo@VA\HenKo@VB\HenKo@B}%
              }%
            \else\if b\yazirusi@opt
              \put(0,0){\@iro\henko@color
                \ArrowLine\HenKo@VA\HenKo@A\ArrowLine\HenKo@VB\HenKo@B
                \Drawline<yazirusi=>{\HenKo@VA\HenKo@VB}%
              }%
            \fi\fi\fi\fi
          }{%
            \put(0,0){\@iro\henko@color\@ovalDrawline{\HenKo@A\HenKo@VA\HenKo@VB\HenKo@B}}%
          }%
    \or% henkotype=5 (bezier)
          \Subvec\HenKo@B\HenKo@A\HenKo@AB
          \vecXY\bezier@P\HenKo@Px\HenKo@Py
          \ukansan\HenKo@Py\HenKo@Py
          \Mulvec\HenKo@Px\HenKo@AB\HenKo@P
          \Rotvec[\HenKo@Py]\HenKo@AB{-90}\HenKo@H
          \Addvec\HenKo@P\HenKo@H\HenKo@P
          \Addvec\HenKo@P\HenKo@A\HenKo@P
          \vecXY\bezier@Q\HenKo@Qx\HenKo@Qy
          \ukansan\HenKo@Qy\HenKo@Qy
          \Mulvec\HenKo@Qx\HenKo@AB\HenKo@Q
          \Rotvec[\HenKo@Qy]\HenKo@AB{-90}\HenKo@H
          \Addvec\HenKo@Q\HenKo@H\HenKo@Q
          \Addvec\HenKo@Q\HenKo@A\HenKo@Q
%         \Drawline{\HenKo@A\HenKo@P\HenKo@Q\HenKo@B}%
          \EMpsBezier<waku>\HenKo@A\HenKo@P\HenKo@Q\HenKo@B
    \or% henkotype=6 (trapezoid)
          \DegSin{\trapezoid@angle}\henko@tmp
          \@Div\HenKo@MV\henko@tmp\HenKo@MV@
          \Kaiten[\HenKo@MV@]\HenKo@A{\HenKo@B}{-\trapezoid@angle}\HenKo@VA
          \Kaiten[\HenKo@MV@]\HenKo@B{\HenKo@A}{\trapezoid@angle}\HenKo@VB
          \xdef\HenKoA{\HenKo@A}%
          \xdef\HenKoB{\HenKo@B}%
          \xdef\HenKoVA{\HenKo@VA}%
          \xdef\HenKoVB{\HenKo@VB}%
          \ifthenelse{\lengthtest{\oval@r\p@=\z@}}{%
            \ifx\empty\paint@option\else
              \EMedef\temp@a{\paint@option{\HenKo@A\HenKo@VA\HenKo@VB\HenKo@B}}%
              \expandafter\emPaint\temp@a
            \fi
            \ifx\empty\yazirusi@opt
              \Drawline<iro=\henko@color>{\HenKo@A\HenKo@VA\HenKo@VB\HenKo@B}%
            \else\if a\yazirusi@opt
              \put(0,0){\@iro\henko@color
                \Drawline{\HenKo@A\HenKo@VA\HenKo@VB}\ArrowLine\HenKo@VB\HenKo@B}%
            \else\if r\yazirusi@opt
              \put(0,0){\@iro\henko@color
                \Drawline{\HenKo@VA\HenKo@VB\HenKo@B}\ArrowLine\HenKo@VA\HenKo@A}%
            \else\if b\yazirusi@opt
              \put(0,0){\@iro\henko@color
                \Drawline{\HenKo@VA\HenKo@VB}\ArrowLine\HenKo@VA\HenKo@A\ArrowLine\HenKo@VB\HenKo@B}%
            \fi\fi\fi\fi
          }{%
            \put(0,0){\@iro\henko@color\@ovalDrawline{\HenKo@A\HenKo@VA\HenKo@VB\HenKo@B}}%
          }%
    \or% henkotype=7 (paren)
      \Hamidasiten*\HenKo@A\HenKo@B{-\HenKo@MV}{-\HenKo@MV}\HenKo@CA\HenKo@CB
      \Kaiten\HenKo@CA\HenKo@A{90}\HenKo@VA
      \Kaiten\HenKo@CB\HenKo@B{-90}\HenKo@VB
      \Enko\HenKo@CA\HenKo@MV{hazimeten=\HenKo@A}{owariten=\HenKo@VA}%
      \Enko\HenKo@CB\HenKo@MV{hazimeten=\HenKo@VB}{owariten=\HenKo@B}%
      \Drawline{\HenKo@VA\HenKo@VB}%
    \or% henkotype=8 (brace)
      \Hamidasiten*\HenKo@A\HenKo@B{-\HenKo@MV}{-\HenKo@MV}\HenKo@CA\HenKo@CB
      \Kaiten\HenKo@CA\HenKo@A{90}\HenKo@VA
      \Kaiten\HenKo@CB\HenKo@B{-90}\HenKo@VB
      \Tyuuten\HenKo@VA\HenKo@VB\HenKo@MM
      \DegSin{45}\HK@tmp\Mul\HenKo@MV\HK@tmp\HenKo@L
      \Hamidasiten\HenKo@VA\HenKo@MM{-\HenKo@L}\HenKo@DA
      \Hamidasiten\HenKo@VA\HenKo@MM{\HenKo@L}\HenKo@DB
      \Kaiten[\HenKo@MV]\HenKo@DA\HenKo@MM{-90}\HenKo@EA
      \Kaiten[\HenKo@MV]\HenKo@DB\HenKo@MM{90}\HenKo@EB
      \Sub\HenKo@MV\HenKo@L\HenKo@ML
      \Kaiten[\HenKo@ML]\HenKo@MM\HenKo@DA{90}\HenKo@V
      \Enko\HenKo@CA\HenKo@MV{hazimeten=\HenKo@A}{owariten=\HenKo@VA}%
      \Enko\HenKo@CB\HenKo@MV{hazimeten=\HenKo@VB}{owariten=\HenKo@B}%
      \Enko\HenKo@EA\HenKo@MV{hazimeten=\HenKo@V}{owariten=\HenKo@DA}%
      \Enko\HenKo@EB\HenKo@MV{hazimeten=\HenKo@DB}{owariten=\HenKo@V}%
      \Drawlines{\HenKo@VA\HenKo@DA;\HenKo@DB\HenKo@VB}%
      \@tempdima=\HenKo@ML\unitlength
      \advance\@tempdima.5em\relax
      \ukansan\@tempdima\HK@tmp
      \Kaiten[\HK@tmp]\HenKo@MM\HenKo@DA{90}\HenKo@V
      \xdef\HenKo@V{\HenKo@V}%
    \fi\egroup
  \else
    \ifthenelse{\equal{\henko@dot@N}{0}}{}{{%
      \ifx\empty\henko@color\else\color{\henko@color}\fi
      \ifthenelse{\equal{\henko@dot@N}{*}}{%
        \@tempdima=\HenKo@AM\unitlength
%        \@tempdima=.75\@tempdima
        \advance\@tempdima 0.5\p@
        \edef\HenKo@N{\seisuu\@tempdima}}{\edef\HenKo@N{\henko@dot@N}}%
      \ISub\HenKo@N{1}\HenKo@n
      \Sub\HenKo@argii\HenKo@argi\HenKo@argd
      \@Div\HenKo@argd\HenKo@n\HenKo@argd
      \edef\HenKo@arg{\HenKo@argi}%
      \ukansan\henko@dotsize\henko@dotsize@
      \Ifor\HenKo@i{0}{\HenKo@N}\Do{%
        \Rdef[\HenKo@C](\HenKo@r,\HenKo@arg)\HenKo@P
%        \Put\HenKo@P(0,-.4pt)[c]{$\cdot$}%
%        \En*[1]\HenKo@P\henko@dotsize@
        \Put\HenKo@P(0,0)[c]{\henko@dot}%
        \Addself\HenKo@arg\HenKo@argd
      }%
    }}%
  \fi%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\typeout{HenKoTyuuten=\HenKoTyuuten}%
  \ifx\empty #5\else
    \ifcase\henko@type% henkotype=0(arc)
      \ifx\empty\put@pos\else
        \Subvec{\HenKo@A}\HenKo@C\HenKo@v\Argvec\HenKo@v\HenKo@argi
        \Subvec{\HenKo@B}\HenKo@C\HenKo@v\Argvec\HenKo@v\HenKo@argii
        \ifdim\HenKo@argii\p@<\HenKo@argi\p@\Addself\HenKo@argii{360}\fi
        \Sub\HenKo@argii\HenKo@argi\HenKo@arg
        \Mul\put@pos\HenKo@arg\HenKo@arg
        \Add\HenKo@argi\HenKo@arg\HenKo@Varg
        \Rdef[\HenKo@C](\HenKo@r,\HenKo@Varg)\HenKo@V
      \fi
      \ifdim\HenKo@moziH=\z@\else\Hamidasiten\HenKo@C\HenKo@V\HenKo@moziH\HenKo@V\fi
    \or% henkotype=1 (ellipse)
    \or% henkotype=2 (triangle)
      \ifx\empty\put@pos\else
        \Subvec\HenKo@B\HenKo@A\HenKo@AB
        \Sub\put@pos{.5}\put@pos@t
        \Mulvec\put@pos@t\HenKo@AB\HenKo@Vc
        \Addvec\HenKo@V\HenKo@Vc\HenKo@V
      \fi
    \or% henkotype=3 (parallel)
      \ifx\empty\put@pos\else
        \Subvec\HenKo@B\HenKo@A\HenKo@AB
        \Sub\put@pos{.5}\put@pos@t
        \Mulvec\put@pos@t\HenKo@AB\HenKo@Vc
        \Addvec\HenKo@V\HenKo@Vc\HenKo@V
      \fi
      \ifdim\HenKo@moziH=\z@\else
        \Tyuuten\HenKo@A\HenKo@B\HenKo@C
        \Hamidasiten\HenKo@C\HenKo@V\HenKo@moziH\HenKo@V
      \fi
    \or% henkotype=4 (bracket)
      \ifx\empty\put@pos\else
        \Subvec\HenKo@B\HenKo@A\HenKo@AB
        \Sub\put@pos{.5}\put@pos@t
        \Mulvec\put@pos@t\HenKo@AB\HenKo@Vc
        \Addvec\HenKo@V\HenKo@Vc\HenKo@V
      \fi
    \fi
    \fboxsep=\henko@sep
    \edef\HenKo@tmp{{\HenKo@V}\put@opt}%
    \ifthenelse{\henko@mozikaiten=\z@}{%
      \ifsironuki
        \ifcolors@
          \expandafter\emathPut\HenKo@tmp{\colorbox{white}{{\protect\henko@fbox{#5}}}}%
        \else
          \setbox0=\hbox{\protect\henko@fbox{\fbox{#5}}}%
          \@tempdima=\ht0\advance\@tempdima\dp0
          \@tempdimb=.5\@tempdima
          \ukansan{\@tempdimb}\HK@h
          \@tempdima=\wd0
          \@tempdimb=.5\@tempdima
          \ukansan{\@tempdimb}\HK@w
          \emathPut\HenKo@V{\Nuritubusi[0]{(-\HK@w,-\HK@h)(\HK@w,-\HK@h)(\HK@w,\HK@h)(-\HK@w,\HK@h)}}%
          \expandafter\emathPut\HenKo@tmp{{\protect\henko@fbox{#5}}}%
        \fi
      \else
        \expandafter\emathPut\HenKo@tmp{{\protect\henko@fbox{#5}}}%
      \fi
    }{%
      \ifsironuki
        \expandafter\emathPut\HenKo@tmp{%
          \rotatebox{\henko@mozikaitenkaku}{\colorbox{white}{{\henko@fbox{#5}}}}%
        }%
      \else
          \expandafter\emathPut\HenKo@tmp{%
            \rotatebox{\henko@mozikaitenkaku}{{\protect\henko@fbox{#5}}}%
          }%
      \fi
    }%
  \fi
  \xdef\HenKoP{\HenKo@V}%
}%
\ifnum\EMps@mode=\@ne\grestore\fi
\ignorespaces}%
%
\def\@HenKo@sub[#1]<#2>(#3,#4)(#5,#6)#7{%
  \ifthenelse{\equal{#1}{\empty}}{%
    \HenKo<#2>{(#3,#4)}{(#5,#6)}{#7}%
  }{%
    \HenKo[#1]<#2>{(#3,#4)}{(#5,#6)}{#7}%
  }%
}%
\def\HenKos{\@ifnextchar[{\@HenKos}{\@HenKos[\empty]}}%
\def\@HenKos[#1]{\@ifnextchar<{\@@HenKos[#1]}{\@@HenKos[#1]<\empty>}}%
\def\@@HenKos[#1]<#2>#3{%
  \exfor[;]\hks@c:=#3\do{%
    \trim\hks@c\to\hks@c
    \EMedef\hks@tmp{[#1]<#2>\hks@c}%
    \expandafter\@HenKo@sub\hks@tmp
  }%
}%
%
% \touHenKo
%
%\def\Touhenko{\@ifnextchar[{\@Touhenko}{\@Touhenko[$\scriptstyle |$]}}%
%\def\@Touhenko[#1]{\@ifnextchar<{\@@Touhenko[#1]}{%
%    \@@Touhenko[#1]<\empty>}}%
%\def\@@Touhenko[#1]<#2>(#3,#4)(#5,#6){%
%  \ifx\empty #2\relax
%    \EMedef\THK@tmp{<henkomozikaiten=1,sironuki=false>}%
%  \else
%    \EMedef\THK@tmp{<henkomozikaiten=1,sironuki=false,#2>}%
%  \fi
%  \ifcase\Tk@kosuu
%  \or
%    \expandafter\HenKo\THK@tmp{(#3,#4)}{(#5,#6)}{#1}%
%  \or
%    \expandafter\HenKo\THK@tmp{(#3,#4)}{(#5,#6)}{#1\hskip\Tk@kankaku#1}%
%  \or
%    \expandafter\HenKo\THK@tmp{(#3,#4)}{(#5,#6)}{#1\hskip\Tk@kankaku#1\hskip\Tk@kankaku#1}%
%  \fi
%}%
%%
%\def\touHenKo{\@ifnextchar[{\@touHenKo}{\@touHenKo[$\scriptstyle |$]}}%
%\def\@touHenKo[#1]{%
%  \@ifnextchar<{\@@touHenKo[#1]}{%
%  \@@touHenKo[#1]<\empty>}}%
%\def\@@touHenKo[#1]<#2>#3{{%
%  \ifnum\EMps@mode=\@ne\gsave\fi
%  \edef\Tk@kosuu{1}%
%  \edef\Tk@kankaku{0pt}%
%  \edef\Tk@henko@opt{\empty}%
% \def\Tk@kigou{#1}%
% \def\Tk@kosuu{1}%
%%% --------------------------------------------
%  \define@key{emP}{size}{\edef\Tk@size{##1}}%
%  \define@key{emP}{kosuu}{\edef\Tk@kosuu{##1}}%
%  \define@key{emP}{kigou}{\def\Tk@kigou{##1}}%
%  \define@key{emP}{kankaku}{\EMedef\Tk@kankaku{##1}}%
%  \define@key{emP}{kigouopt}{\EMedef\Tk@kigou@opt{##1}}%
%  \define@key{emP}{henkoopt}{\EMedef\Tk@henko@opt{##1}}%
%%% --------------------------------------------
%  \ifx\empty #2\else
%    \strchr{#2}{=}\Tk@tmp
%    \ifnum\Tk@tmp>\z@
%      \setkeys{emP}{#2}%
%    \else
%      \edef\Tk@kosuu{#2}%
%    \fi
%  \fi
%\@ifundefined{Tk@kigou}{%
%  \exfor[;]\tHK@c:=#3\do{%
%    \EMedef\tHK@tmp{[\protect #1]<\Tk@henko@opt>\tHK@c}%
%    \expandafter\Touhenko\tHK@tmp
%  }%
%}{%
%  \exfor[;]\tHK@c:=#3\do{%
%    \EMedef\tHK@tmp{[\Tk@kigou]<\Tk@henko@opt>\tHK@c}%
%    \expandafter\Touhenko\tHK@tmp
%  }%
%}%
%  \ifnum\EMps@mode=\@ne\grestore\fi
%}}%
%%
%\let\touhenkokigou\touHenKo
%%
\def\touhenkokigou@sub{%
  \@ifnextchar({\touhenkokigou@sub@}{\@touhenkokigou@sub}}%
\def\touhenkokigou@sub@(#1){\@touhenkokigou@sub{(#1)}}%
\def\@touhenkokigou@sub#1#2{%
  \ifx\empty\Tk@henko@opt\relax
    \EMedef\THK@tmp{<henkomozikaiten=1,sironuki=false>}%
  \else
    \EMedef\THK@tmp{<henkomozikaiten=1,sironuki=false,\Tk@henko@opt>}%
  \fi
  \ifcase\Tk@kosuu
  \or
    \expandafter\HenKo\THK@tmp{#1}{#2}{\Tk@kigou}%
  \or
    \expandafter\HenKo\THK@tmp{#1}{#2}{\Tk@kigou\hskip\Tk@kankaku\Tk@kigou}%
  \or
    \expandafter\HenKo\THK@tmp{#1}{#2}{\Tk@kigou\hskip\Tk@kankaku\Tk@kigou
      \hskip\Tk@kankaku\Tk@kigou}%
  \fi
}%
%
\def\touhenkokigou{%
  \@ifnextchar[{\@touhenkokigou}{\@touhenkokigou[$\scriptstyle |$]}}%
\def\@touhenkokigou[#1]{%
  \@ifnextchar<{\@@touhenkokigou[#1]}{%
  \@@touhenkokigou[#1]<\empty>}}%
\def\@@touhenkokigou[#1]<#2>#3{{%
  \ifnum\EMps@mode=\@ne\gsave\fi
  \edef\Tk@kosuu{1}%
  \edef\Tk@kankaku{0pt}%
  \edef\Tk@henko@opt{\empty}%
  \def\Tk@kigou{#1}%
%% --------------------------------------------
  \define@key{emP}{size}{\edef\Tk@size{##1}}%
  \define@key{emP}{kosuu}{\edef\Tk@kosuu{##1}}%
  \define@key{emP}{kigou}{\def\Tk@kigou{##1}}%
  \define@key{emP}{kankaku}{\EMedef\Tk@kankaku{##1}}%
  \define@key{emP}{kigouopt}{\EMedef\Tk@kigou@opt{##1}}%
  \define@key{emP}{henkoopt}{\EMedef\Tk@henko@opt{##1}}%
%% --------------------------------------------
%  \ifx\empty #2\else
%    \strchr{#2}{=}\Tk@tmp
%    \ifnum\Tk@tmp>\z@
%      \setkeys{emP}{#2}%
%    \else
%      \edef\Tk@kosuu{#2}%
%    \fi
%  \fi
\ifx\empty #2\else
  \ifthenelse{\isodd{0#21}}{%
     \edef\Tk@kosuu{#2}%
  }{%
     \setkeys{emP}{#2}%
  }%
\fi
  \exfor[;]\tHK@c:=#3\do{%
    \expandafter\touhenkokigou@sub\tHK@c
  }%
  \ifnum\EMps@mode=\@ne\grestore\fi
}}%
%
% 下線
%
\define@key{emP}{kasenUehosei}{\def\namikasen@uehosei{#1}}%
\define@key{emP}{kasenSitahosei}{\def\namikasen@sitahosei{#1}}%
%
\def\namikasen@uehosei{0pt}%
\def\namikasen@sitahosei{0pt}%
\def\namikasenUehosei#1{\def\namikasen@uehosei{#1}}
\def\namikasenSitahosei#1{\def\namikasen@sitahosei{#1}}
%
\let\kasenUehosei\namikasenUehosei
\let\kasenSitahosei\namikasenSitahosei
\def\phkasen{\@ifnextchar<{\@phkasen}{\@phkasen<\empty>}}%
\def\@phkasen<#1>{\@ifnextchar[{\@@phkasen<#1>}{%
  \@@phkasen<#1>[\empty]}}%
\def\@@phkasen<#1>[#2]{\@ifnextchar'{\@@@phkasen<#1>[#2]}{%
  \@@@phkasen<#1>[#2]'\relax'}}%
\def\@@@phkasen<#1>[#2]'#3'#4{\relax
  \def\phkasen@inner{1}%
  \ifmmode
    \ifinner\else\def\phkasen@inner{0}\fi
    \@@@@phkasen<#1>[#2]'#3'{#4}%
  \else $\@@@@phkasen<#1>[#2]'#3'{\mbox{#4}}\m@th$\relax\fi}%
\def\@@@@phkasen<#1>[#2]'#3'#4{%
  {%
  \ifnum\phkasen@inner=\z@
    \setbox0=\hbox{$\displaystyle #4$}%
  \else
    \setbox0=\hbox{\mbox{$#4$}}%
  \fi
  \edef\w@nami{\strip@pt\wd0}%
  \let\Sensyu\Rotateline
%
\begingroup
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
%
  \@tempdima\dp0\advance\@tempdima4\p@
  \ifx\empty#2\relax\else\advance\@tempdima #2\p@\fi
  \advance\@tempdima\namikasen@uehosei
  \advance\@tempdima\namikasen@sitahosei
  \vrule depth \@tempdima width \z@
%
  \@tempdima-\dp0%\advance\@tempdima-4\p@
  \advance\@tempdima 8.5\p@
  \advance\@tempdima-\namikasen@uehosei
  \edef\phkasen@x{\def\noexpand\d@nami{\the\@tempdima}}%
%  \edef\d@nami{\the\@tempdima}%
\expandafter\endgroup\phkasen@x
%
  \begin{picture}(0,0)\relax
  \raisebox{\d@nami}{%
    \begin{zahyou*}[ul=1pt,haiti=t](0,\w@nami)(-10,10)\relax
      \edef\iro@{\empty}%
      \begingroup
      \ifx\empty #1\else\setkeys{emP}{#1}\fi
      \ifx\empty\iro@
        \Sensyu{\XMIN\XMAX}%
        \ifx\empty #2\relax\else\put(0,-#2){\Sensyu{\XMIN\XMAX}}\fi
      \else
        \@iro{\iro@}%
        \Sensyu{\XMIN\XMAX}%
        \ifx\empty #2\relax\else\put(0,-#2){\Sensyu{\XMIN\XMAX}}\fi
      \fi
      \endgroup
      #3\relax
    \end{zahyou*}}%
  \end{picture}%
  \box0}}%
%
%
%   \EMunderline<#1>#2
%       文字列 #2 に下線を引く（行はまたげません）
%       #1 : key=val
%             allinethickness=...
%             sensyu=....
%             sitayohaku=.. （デフォルト2）
%             Sitayohaku=.. （デフォルト2pt）
%             iro=..
%
\def\EMunderline{\@ifnextchar<{\@EMuln}{\@EMuln<\empty>}}%
\def\@EMuln<#1>#2{\relax
  \def\EMuln@inner{1}%
  \ifmmode
    \ifinner\else\def\EMuln@inner{0}\fi
    \@@EMuln<#1>{#2}%
  \else $\@@EMuln<#1>{\mbox{#2}}\m@th$\relax\fi}%
\def\@@EMuln<#1>#2{{%
  \edef\sita@yohaku{2}\relax
  \def\iro@{}%
  \ifx\empty #1\relax\else\setkeys{emP}{#1}\fi
%  \setbox0=\hbox{#2}%
  \ifnum\EMuln@inner=\z@
    \setbox0=\hbox{$\displaystyle #2$}%
  \else
    \setbox0=\hbox{\mbox{$#2$}}%
  \fi
  \edef\EMuln@w{\strip@pt\wd0}\relax
  \edef\EMuln@d{\strip@pt\dp0}\relax
  \Add\EMuln@d\sita@yohaku\EMuln@d
  \unitlength=\p@
  \begin{picture}(0,0)\relax
    \ifx\empty\iro@\else\@iro{\iro@}\fi
    \Sensyu{(0,-\EMuln@d)(\EMuln@w,-\EMuln@d)}%
  \end{picture}\relax
  \leavevmode\box0\relax\vrule \@width\z@\@depth\EMuln@d\p@\relax\ignorespaces
}}%
%
% 任意の2点を \underbrace, \overbrace で結ぶ。
%
\define@key{rotbrace}{depth}{\edef\rotbrace@depth{#1}}%
\define@key{rotbrace}{height}{\edef\rotbrace@height{#1}}%
%
% \rotUbrace[#1]#2#3#4
%     点#2から点#3へ向かう有向線分の，
%       進行方向右側に \underbrace をつけ，
%       中央下部に文字列#4を配置する。
%       （#4 は数式モード内と解釈される。--- \scriptstyle ）
%     \underbrace 記号と有向線分の間隔を空けたいときは#1に
%        depth=3pt
%     などと，間隔を単位付き数値で指定する。
%
\def\rotUbrace{\@ifnextchar[{\@rotUbrace}{\@rotUbrace[\empty]}}%
\def\@rotUbrace[#1]#2#3#4{%
  \edef\rotbrace@height{0pt}%
  \edef\rotbrace@depth{0pt}%
  \ifthenelse{\equal{#1}\empty}{}{\setkeys{rotbrace}{#1}}%
  \Subvec{#3}{#2}\rotUbrace@v
  \Argvec\rotUbrace@v\rotUbrace@arg
  \Absvec\rotUbrace@v\rotUbrace@abs
  \emathPut{#2}{\rotatebox{\rotUbrace@arg}{\makebox(0,0)[lb]{\ensuremath{%
   \smash{\underbrace{%\sityuu[\rotbrace@depth]{\rotbrace@height}%
    \vrule width\z@ height \rotbrace@height depth \rotbrace@depth
    \hspace*{\rotUbrace@abs\unitlength}}_{#4}}}}}}%
}%
%
\def\EMoverline{\@ifnextchar<{\@EMovln}{\@EMovln<\empty>}}%
\def\@EMovln<#1>#2{{%
  \edef\ue@yohaku{2}\relax
  \ifx\empty #1\relax\else\setkeys{emP}{#1}\fi
  \setbox0=\hbox{#2}%
  \edef\EMovln@w{\strip@pt\wd0}\relax
  \edef\EMovln@h{\strip@pt\ht0}\relax
  \Add\EMovln@h\ue@yohaku\EMovln@h
  \unitlength=\p@
  \begin{picture}(0,0)\relax
    \Drawline{(0,\EMovln@h)(\EMovln@w,\EMovln@h)}%
  \end{picture}\relax\leavevmode\box0\relax
  \vrule \@width\z@\@height\EMovln@h\p@\relax\ignorespaces
}}%
%
% \rotObrace[#1]#2#3#4
%     点#2から点#3へ向かう有向線分の，
%       進行方向左側に \overbrace をつけ，
%       中央上部に文字列#4を配置する。
%       （#4 は数式モード内と解釈される。--- \scriptstyle ）
%     \overbrace 記号と有向線分の間隔を空けたいときは#1に
%        height=3pt
%     などと，間隔を単位付き数値で指定する。
%
\def\rotObrace{\@ifnextchar[{\@rotObrace}{\@rotObrace[\empty]}}%
\def\@rotObrace[#1]#2#3#4{%
  \edef\rotbrace@height{0pt}%
  \edef\rotbrace@depth{0pt}%
  \ifthenelse{\equal{#1}\empty}{}{\setkeys{rotbrace}{#1}}%
  \Subvec{#3}{#2}\rotObrace@v
  \Argvec\rotObrace@v\rotObrace@arg
  \Absvec\rotObrace@v\rotObrace@abs
  \emathPut{#2}{\rotatebox{\rotObrace@arg}{\makebox(0,0)[lb]{\ensuremath{%
   \smash{\overbrace{%\sityuu[\rotbrace@depth]{\rotbrace@height}%
    \vrule width\z@ height \rotbrace@height depth \rotbrace@depth
    \hspace*{\rotObrace@abs\unitlength}}^{#4}}}}}}%
}%
%
% 数式の指定した2項間を円弧で結ぶ
% \DrawHatC<#1>#2#3#4
%   #1 : key=val の形式で
%         takasa=円弧の高さ（デフォルト値：6pt）
%         iti=円弧にラベル文字列を付与する際の基準位置
%               （デフォルト値 : .5 (中点)）
%         haiti=文字列を配置する \Put へのオプション
%               （デフォルト  : (0,0)[c]）
%         fboxsep=..
%   #2 : 式の先頭から項1まで
%   #3 : 式の先頭から項2まで
%   #4 : ラベル文字列
%
% \DrawHatC*<#1>#2#3#4
%   円弧を数式の下方に配置する
%
\define@key{emDrawHat}{takasa}{\def\emDrawHat@takasa{#1}}%
\define@key{emDrawHat}{hukasa}{\def\emDrawHat@hukasa{#1}}%
\define@key{emDrawHat}{iti}{\def\emDrawHat@iti{#1}}%
\define@key{emDrawHat}{haiti}{\def\emDrawHat@haiti{#1}}%
\define@key{emDrawHat}{yazirusi}{\def\emDrawHat@yazirusi{#1}}%
\define@key{emDrawHat}{offset}{\def\emDrawHat@offset{#1}}%
\define@key{emDrawHat}{fboxsep}{\fboxsep=#1}%
\define@key{emDrawHat}{kugirisi}{\def\DHS@kugirisi{#1}}%
\define@key{emDrawHat}{dumy}[1]{}%
%
\def\DrawHatC{\@ifstar{\DrawHatC@}{\@DrawHatC}}%
\def\@DrawHatC{\@ifnextchar<{\@@DrawHatC}{\@@DrawHatC<\empty>}}%
\def\@@DrawHatC<#1>#2#3#4{{%
  \def\emDrawHat@takasa{6pt}%
  \def\emDrawHat@iti{.5}%
  \def\emDrawHat@haiti{(0,0)[c]}%
  \edef\emDrawHat@yazirusi{\empty}%
  \ifx\empty#1\else\setkeys{emDrawHat}{#1}\fi
%
  \unitlength=10pt\relax
  \begin{picture}(0,0)%
  \setbox0=\hbox{$#2$}%
  \@tempdima\wd0\advance\@tempdima-3pt\relax\divide\@tempdima by 10\relax
  \edef\DrawHatC@L{(\strip@pt\@tempdima,1)}%
  \setbox0=\hbox{$#3$}%
  \@tempdimb\wd0\advance\@tempdimb-3pt\relax\divide\@tempdimb by 10\relax
  \edef\DrawHatC@R{(\strip@pt\@tempdimb,1)}%
  \advance\@tempdima\@tempdimb
  \divide\@tempdima by \tw@
  \@tempdimb=10pt\advance\@tempdimb \emDrawHat@takasa\divide\@tempdimb by 10\relax
  \edef\DrawHatC@V{(\strip@pt\@tempdima,\strip@pt\@tempdimb)}%
  \Gaisin\DrawHatC@L\DrawHatC@V\DrawHatC@R[\DrawHatC@r]\DrawHatC@C
  \Enko<yazirusi=\emDrawHat@yazirusi>\DrawHatC@C\DrawHatC@r[\hazimekaku]{hazimeten=\DrawHatC@R}[\owarikaku]{%
    owariten=\DrawHatC@L}%
  \Sub{1}{\emDrawHat@iti}\DrawHatC@tmp
  \Mul{\emDrawHat@iti}\hazimekaku\DrawHatC@a
  \Mul\DrawHatC@tmp\owarikaku\DrawHatC@b
  \Add\DrawHatC@a\DrawHatC@b\DrawHatC@tmp
  \Rdef[\DrawHatC@C](\DrawHatC@r,\DrawHatC@tmp)\DrawHatC@P
  \edef\DrawHatC@tmp{{\DrawHatC@P}\emDrawHat@haiti}%
  \expandafter\emathPut\DrawHatC@tmp{#4}%
  \end{picture}%
}}%
%
\def\DrawHatC@{\@ifnextchar<{\DrawHatC@@}{\DrawHatC@@<\empty>}}%
\def\DrawHatC@@<#1>#2#3#4{%
  \def\emDrawHat@takasa{6pt}%
  \def\emDrawHat@iti{.5}%
  \def\emDrawHat@haiti{(0,0)[c]}%
  \edef\emDrawHat@yazirusi{\empty}%
  \ifx\empty#1\else\setkeys{emDrawHat}{#1}\fi
%
  \unitlength10pt\relax
  \begin{picture}(0,0)%
  \setbox0=\hbox{$#2$}%
  \@tempdima\wd0\advance\@tempdima-3pt\divide\@tempdima by 10\relax
  \edef\DrawHatC@L{(\strip@pt\@tempdima,-.4)}%
  \setbox0=\hbox{$#3$}%
  \@tempdimb\wd0\advance\@tempdimb-3pt\divide\@tempdimb by 10\relax
  \edef\DrawHatC@R{(\strip@pt\@tempdimb,-.4)}%
  \advance\@tempdima\@tempdimb
  \divide\@tempdima by \tw@
  \@tempdimb=-4pt\advance\@tempdimb -\emDrawHat@takasa\divide\@tempdimb by 10\relax
  \edef\DrawHatC@V{(\strip@pt\@tempdima,\strip@pt\@tempdimb)}%
  \Gaisin\DrawHatC@L\DrawHatC@V\DrawHatC@R[\DrawHatC@r]\DrawHatC@C
  \Enko<yazirusi=\emDrawHat@yazirusi>\DrawHatC@C\DrawHatC@r[\hazimekaku]{hazimeten=\DrawHatC@L}[\owarikaku]{%
    owariten=\DrawHatC@R}%
  \Sub{1}{\emDrawHat@iti}\DrawHatC@tmp
  \Mul{\emDrawHat@iti}\owarikaku\DrawHatC@a
  \Mul\DrawHatC@tmp\hazimekaku\DrawHatC@b
  \Add\DrawHatC@a\DrawHatC@b\DrawHatC@tmp
  \Rdef[\DrawHatC@C](\DrawHatC@r,\DrawHatC@tmp)\DrawHatC@P
  \edef\DrawHatC@tmp{{\DrawHatC@P}\emDrawHat@haiti}%
  \expandafter\emathPut\DrawHatC@tmp{#4}%
  \end{picture}%
}%
% 式の項を上下の括弧で結ぶ
%\def\emLarc{\@ifnextchar<{\@emLarc}{\@emLarc<\empty>}}%
%\def\@emLarc<#1>#2{{%
%  \def\@pos{-90}%
%  \def\yazirusi@opt{\empty}%
%  \def\put@opt{[s]}%
%  \def\put@str{\empty}%
%  \def\takas@{5}%
%  \setbox0=\hbox{#2}%
%  \edef\emLarc@h{\strip@pt\ht0}%
%  \edef\emLarc@d{\strip@pt\dp0}%
%  \edef\emLarc@w{\strip@pt\wd0}%
%  \def\LB{(0,-\emLarc@d)}%
%  \def\RB{(\emLarc@w,-\emLarc@d)}%
%  \Strchr{#1}{=}\emLarc@tmp
%  \ifnum\emLarc@tmp>\z@\setkeys{emP}{#1}\fi
%  \@Bunten\LB\RB11\emLarc@C
%  \Addvec\emLarc@C{(0,-\takas@)}\emLarc@C
%  \Gaisin\LB\RB\emLarc@C[\emLarc@r]\emLarc@O
%  \Rdef[\emLarc@O](\emLarc@r,\@pos)\emLarc@P
%  \unitlength=\p@
%  \begin{picture}(0,0)%
%    \edef\emLarc@a{\yazirusi@opt}%
%    \ifthenelse{\equal\emLarc@a\empty}{%
%      \Enko\emLarc@O\emLarc@r{hazimeten=\LB}{owariten=\RB}%
%    }{%
%      \Enko<yazirusi=\emLarc@a>\emLarc@O\emLarc@r{hazimeten=\LB}{owariten=\RB}%%
%    }%
%    \expandafter\emathPut\expandafter\emLarc@P\put@opt\put@str
%  \end{picture}%
%  \@tempdima\takas@ pt\relax
%  \ifthenelse{\equal\put@str\empty}{}{%
%    \setbox0=\hbox{\put@str}%
%    \advance\@tempdima\ht0
%    \advance\@tempdima\dp0
%    \advance\@tempdima\tw@\p@
%  }%
%  \vrule width \z@ depth \@tempdima
%}}%
%
\def\DrawHatS{\@ifstar{\def\DHS@dp{0}\@DrawHatS}{\def\DHS@dp{1}\@DrawHatS}}%
\def\@DrawHatS{\@ifnextchar[{\@@DrawHatS}{\@@DrawHatS[\empty]}}%
\def\@@DrawHatS[#1]{\@ifnextchar<{\@@@DrawHatS[#1]}{\@@@DrawHatS[#1]<\empty>}}%
\def\@@@DrawHatS[#1]<#2>#3#4{{%
%
  \def\DHS@kugirisi{,\kern1em}%
  \def\emDrawHat@takasa{1\zh}%
  \def\emDrawHat@offset{0pt}%
  \ifx\empty#1\else\setkeys{emDrawHat}{#1}\fi
  \setbox0=\hbox{\ensuremath{{}\DHS@kugirisi{}}}%
  \edef\DHS@wkugirisi{\the\wd0}%
  \setlength{\@tempdima}{\emDrawHat@takasa}\edef\DHS@h{\strip@pt\@tempdima}%
  \unitlength=\p@
%
  \def\DHS@n{0}%
  \expandafter\@for\expandafter\DHS@c\expandafter:\expandafter=#3\do{%
    \Incr\DHS@n
    \ifnum\DHS@n=\@ne
      \setbox0=\hbox{$\DHS@c$}%
      \edef\DHS@ri{\the\wd0}%
      \@tempdima=.5\wd0\relax
      \expandafter\edef\csname DHS@ci\DHS@n\endcsname{\the\@tempdima}%
    \else
      \setbox0=\hbox{$\DHS@c$}%
      \@tempdima\DHS@ri\advance\@tempdima\DHS@wkugirisi
        \advance\@tempdima.5\wd0\relax
        \expandafter\edef\csname DHS@ci\DHS@n\endcsname{\the\@tempdima}%
        \advance\@tempdima.5\wd0\edef\DHS@rii{\the\@tempdima}%
      \edef\DHS@ri{\DHS@rii}%
    \fi
  }%
  \def\DHS@ii{1}%
  \Strchr{#4}{,}\DHS@tmp
  \ifnum\DHS@tmp>\z@
    \expandafter\@for\expandafter\DHS@c\expandafter:\expandafter=#4\do{%
      \edef\DHS@i{\DHS@ii}%
      \Incr\DHS@ii
      \begin{zahyou*}(0,0)(0,0)\relax
        \@tempdima=\csname DHS@ci\DHS@i\endcsname
        \@tempdimb=\csname DHS@ci\DHS@ii\endcsname
        \ifdim\emDrawHat@offset=\z@\else
          \advance\@tempdima\emDrawHat@offset
          \advance\@tempdimb\emDrawHat@offset
        \fi
        \edef\DHS@xi{\strip@pt\@tempdima}%
        \edef\DHS@xii{\strip@pt\@tempdimb}%
        \ifdim\DHS@h\p@>\z@
          \HenKo<#2>{(\DHS@xii,\DHS@h)}{(\DHS@xi,\DHS@h)}{\ensuremath{\DHS@c}}%
        \else
          \HenKo<#2>{(\DHS@xi,\DHS@h)}{(\DHS@xii,\DHS@h)}{\ensuremath{\DHS@c}}%
        \fi
      \end{zahyou*}%
    }%
  \else
    \@whilenum\DHS@ii<\DHS@n\do{%
    \edef\DHS@i{\DHS@ii}%
    \Incr\DHS@ii
    \begin{zahyou*}(0,0)(0,0)\relax
        \@tempdima=\csname DHS@ci\DHS@i\endcsname
        \@tempdimb=\csname DHS@ci\DHS@ii\endcsname
        \ifdim\emDrawHat@offset=\z@\else
          \advance\@tempdima\emDrawHat@offset
          \advance\@tempdimb\emDrawHat@offset
        \fi
        \edef\DHS@xi{\strip@pt\@tempdima}%
        \edef\DHS@xii{\strip@pt\@tempdimb}%
        \ifdim\DHS@h\p@>\z@
          \HenKo<#2>{(\DHS@xii,\DHS@h)}{(\DHS@xi,\DHS@h)}{\ensuremath{#4}}%
        \else
          \HenKo<#2>{(\DHS@xi,\DHS@h)}{(\DHS@xii,\DHS@h)}{\ensuremath{#4}}%
        \fi
      \end{zahyou*}%
    }%
  \fi
  \ifnum\DHS@dp>\z@
    \def\DHS@i{-1}%
    \expandafter\@for\expandafter\DHS@c\expandafter:\expandafter=#3\do{%
      \Incr\DHS@i
      \ifnum\DHS@i=\z@\else\DHS@kugirisi\fi
      \DHS@c
    }%
  \fi
}}%
%
\newtoks\DHS@seq
\def\manDrawHatS{\@ifnextchar[{\@manDrawHatS}{\@manDrawHatS[\empty]}}%
\def\@manDrawHatS[#1]#2{%
%
  \def\DHS@kugirisi{,\kern1em}%
  \def\emDrawHat@takasa{1\zh}%
  \def\emDrawHat@hukasa{2pt}%
  \def\emDrawHat@offset{0pt}%
  \ifx\empty#1\else\setkeys{emDrawHat}{#1}\fi
  \setbox0=\hbox{\ensuremath{{}\DHS@kugirisi{}}}%
  \edef\DHS@wkugirisi{\the\wd0}%
  \setlength{\@tempdima}{\emDrawHat@takasa}\edef\DHS@h{\strip@pt\@tempdima}%
  \setlength{\@tempdima}{\emDrawHat@hukasa}\edef\DHS@d{\strip@pt\@tempdima}%
  \unitlength=\p@
  \DHS@seq={#2}%
%
  \def\DHS@n{0}%
  \expandafter\@for\expandafter\DHS@c\expandafter:\expandafter=#2\do{%
    \Incr\DHS@n
    \ifnum\DHS@n=\@ne
      \setbox0=\hbox{$\DHS@c$}%
      \edef\DHS@ri{\the\wd0}%
      \@tempdima=.5\wd0\relax
      \expandafter\edef\csname DHS@ci\DHS@n\endcsname{\the\@tempdima}%
    \else
      \setbox0=\hbox{$\DHS@c$}%
      \@tempdima\DHS@ri\advance\@tempdima\DHS@wkugirisi
        \advance\@tempdima.5\wd0\relax
        \expandafter\edef\csname DHS@ci\DHS@n\endcsname{\the\@tempdima}%
        \advance\@tempdima.5\wd0\edef\DHS@rii{\the\@tempdima}%
      \edef\DHS@ri{\DHS@rii}%
    \fi
  }%
  \def\DHS@i{0}%
  \@whilenum\DHS@i<\DHS@n\do{%
    \Incr\DHS@i
    \@tempdima=\csname DHS@ci\DHS@i\endcsname
    \ifdim\emDrawHat@offset=\z@\else
      \advance\@tempdima\emDrawHat@offset
    \fi
    \expandafter\edef\csname DHSx\romannumeral\DHS@i\endcsname{%
          \strip@pt\@tempdima}%
    \expandafter\edef\csname DHST\romannumeral\DHS@i\endcsname{%
          (\strip@pt\@tempdima,\DHS@h)}%
    \expandafter\edef\csname DHSB\romannumeral\DHS@i\endcsname{%
          (\strip@pt\@tempdima,-\DHS@d)}%
  }%
  \begin{zahyou*}(0,0)(0,0)\relax
}%
%
\def\endmanDrawHatS{%
  \end{zahyou*}%
  \ensuremath{%
    \def\DHS@i{-1}%
    \expandafter\@for\expandafter\DHS@c\expandafter:\expandafter=\the\DHS@seq\do{%
      \Incr\DHS@i
      \ifnum\DHS@i=\z@\else\DHS@kugirisi\fi
      \DHS@c
    }%
  }%
}%
%
% 第1階差数列
%
\def\Kaisasuuretu{\@ifnextchar[{\@Kaisasuuretu}{\@Kaisasuuretu[dumy]}}%
\def\@Kaisasuuretu[#1]{\@ifnextchar<{\@@Kaisasuuretu[#1]}{%
    \@@Kaisasuuretu[#1]<\empty>}}%
\def\@@Kaisasuuretu[#1]<#2>#3#4{{%
  \HenKoType{2}%
  \DrawHatS[takasa=-2pt,#1]<#2>{#3}{#4}%
}}%
%
% 第2階差数列
%
\def\iiKaisasuuretu{\@ifnextchar[{\@iiKaisasuuretu}{\@iiKaisasuuretu[dumy]}}%
\def\@iiKaisasuuretu[#1]{\@ifnextchar<{\@@iiKaisasuuretu[#1]}{%
    \@@iiKaisasuuretu[#1]<\empty>}}%
\def\@@iiKaisasuuretu[#1]<#2>#3#4#5{{%
  \begin{manDrawHatS}[#1]{#3}%
    \HenKoType{2}%
    \def\Kaisa@i{0}%
    \setlength{\@tempdima}{\baselineskip-2pt}%
    \edef\Kaisa@h{-\strip@pt\@tempdima}%
    \expandafter\@for\expandafter\Kaisa@c\expandafter:\expandafter=#4\do{%
      \Incr\Kaisa@i\IAdd\Kaisa@i{1}\Kaisa@ii
      \edef\Kaisa@P{\csname DHSB\romannumeral\Kaisa@i\endcsname}%
      \edef\Kaisa@Q{\csname DHSB\romannumeral\Kaisa@ii\endcsname}%
      \HenKo<#2>\Kaisa@P\Kaisa@Q{\ensuremath{\Kaisa@c}}%
      \Addvec\HenKoTyuuten{(0,\Kaisa@h)}\Kaisa@tmp
      \expandafter\edef\csname KaisaP\romannumeral\Kaisa@i\endcsname{%
        \Kaisa@tmp}%
    }%
    \def\Kaisa@i{0}%
    \expandafter\@for\expandafter\Kaisa@c\expandafter:\expandafter=#5\do{%
      \Incr\Kaisa@i\IAdd\Kaisa@i{1}\Kaisa@ii
      \edef\Kaisa@P{\csname KaisaP\romannumeral\Kaisa@i\endcsname}%
      \edef\Kaisa@Q{\csname KaisaP\romannumeral\Kaisa@ii\endcsname}%
      \HenKo<#2>\Kaisa@P\Kaisa@Q{\ensuremath{\Kaisa@c}}%
      \expandafter\edef\csname Kaisa\romannumeral\Kaisa@i\endcsname{%
        \HenKoTyuuten}%
    }%
  \end{manDrawHatS}%
}}%
%
% 階層指定　階差数列
%
\def\KaisaSuuretu{\@ifnextchar[{\@KaisaSuuretu}{\@KaisaSuuretu[dumy]}}%
\def\@KaisaSuuretu[#1]{\@ifnextchar<{\@@KaisaSuuretu[#1]}{%
    \@@KaisaSuuretu[#1]<\empty>}}%
\def\@@KaisaSuuretu[#1]<#2>#3{%
  \ifthenelse{#3=2}{%
    \@@iiKaisasuuretu[#1]<#2>
  }{%
%   第3階差数列 ?
  }%
}%
%
% 黒丸，白丸
%   \Kuromaru[#1]<#2>#3
%   \Siromaru[#1]#2
%       #1 : 丸の半径（単位をつける）デフォルトは 1pt
%       #2 : \En* に渡すオプション (nuriiro=.. など)
%       #3 : 位置
%
\edef\Kuromaru@Hankei{1pt}%
\edef\Kurosikaku@Hankei{1pt}%
\edef\Kurosankaku@Hankei{1pt}%
\edef\Siromaru@Hankei{1pt}%
\edef\Sirosikaku@Hankei{1pt}%
\edef\Sirosankaku@Hankei{1pt}%
\def\KuromaruHankei#1{\edef\Kuromaru@Hankei{#1}\edef\Siromaru@Hankei{#1}}%
\def\KurosikakuHankei#1{%
  \edef\Kurosikaku@Hankei{#1}\edef\Sirosikaku@Hankei{#1}}%
\def\KurosankakuHankei#1{%
  \edef\Kurosankaku@Hankei{#1}\edef\Sirosankaku@Hankei{#1}}%
\def\SiromaruHankei#1{\edef\Siromaru@Hankei{#1}}%
\def\SirosikakuHankei#1{\edef\Sirosikaku@Hankei{#1}}%
\def\SirosankakuHankei#1{\edef\Sirosankaku@Hankei{#1}}%
\def\Siromarulinewidth#1{\edef\Siromaru@linewidth{#1}}%
\def\Kuromaru{\@ifnextchar<{\K@@uromaru}{\K@uromaru}}%
\def\K@uromaru{\@ifnextchar[{\@Kuromaru}{\@Kuromaru[\Kuromaru@Hankei]}}%
\def\@Kuromaru[#1]{\@ifnextchar<{\@@Kuromaru[#1]}{\@@Kuromaru[#1]<\empty>}}%
\def\@@Kuromaru[#1]<#2>#3{{%
%
  \def\sub@KM{\@ifnextchar({\sub@@KM}{\relax}}%
  \def\sub@@KM(##1)##2?{%
    \ifx\empty #2\relax
      \En*[\Nurizen]{(##1)}\r@pt
    \else
      \En*[\Nurizen]<#2>{(##1)}\r@pt
    \fi
    \ifx\empty ##2\else
      \edef\sub@KM@tmp{##2?}%
      \expandafter\sub@KM\sub@KM@tmp
    \fi
  }%
%
  \ukansan{#1}\r@pt
  \okikae{#3}{;}{}\KM@str%
  \edef\sub@KM@tmp{\KM@str?}%
  \expandafter\sub@KM\sub@KM@tmp
}}%
\def\K@@uromaru<#1>#2{\begingroup
%
  \edef\size@{\Kuromaru@Hankei}%
  \edef\nuri@iro{\empty}%
  \edef\next@opt{\empty}%
%
  \def\sub@KM{\@ifnextchar({\sub@@KM}{\relax}}%
  \def\sub@@KM(##1)##2?{%
      \EMedef\KM@tmp{[\Nurizen]<\next@opt>}%
    \ifx\empty\next@opt\relax
      \Put{(##1)}{\En*[\Nurizen]\O@@\r@pt}%
    \else
      \EMedef\KM@tmp{*[\Nurizen]<\next@opt>}%
      \Put{(##1)}{\expandafter\En\KM@tmp\O@@\r@pt}%
    \fi
    \ifx\empty ##2\else
      \edef\sub@KM@tmp{##2?}%
      \expandafter\sub@KM\sub@KM@tmp
    \fi
  }%
%
  \ifx\empty #1\else\setkeys{emPKM}{#1}\fi
  \ifx\empty\nuri@iro\else\edefappend[,]\next@opt{nuriiro=\nuri@iro}\fi
  \ukansan\size@\r@pt
  \edef\sub@KM@tmp{#2?}%
  \expandafter\sub@KM\sub@KM@tmp
\endgroup
}%
\let\oldKuromaru\K@uromaru
\let\Kuromarus\Kuromaru
%
%\def\Siromaru{\@ifnextchar[{\S@@iromaru}{\@Siromaru[\Siromaru@Hankei]}}%
%\def\@Siromaru[#1]{\@ifnextchar<{\@@Siromaru[#1]}{\@@Siromaru[#1]<\empty>}}%
\def\Siromaru{\@ifnextchar<{\S@@iromaru}{\S@iromaru}}%
\def\S@iromaru{\@ifnextchar[{\@Siromaru}{\@Siromaru[\Siromaru@Hankei]}}%
\def\@Siromaru[#1]{\@ifnextchar<{\@@Siromaru[#1]}{\@@Siromaru[#1]<\empty>}}%
\def\@@Siromaru[#1]<#2>#3{{%
%
  \def\sub@SM{\@ifnextchar({\sub@@SM}{\relax}}%
  \def\sub@@SM(##1)##2?{%
    \@ifundefined{psdraw}{%
%      \En*[0]{(##1)}\r@pt
      \ifx\empty #2\relax
        \En*[0]{(##1)}\r@pt
      \else
        \En*[0]<#2>{(##1)}\r@pt
      \fi
    }{%
      \gsave
        \@ifundefined{Siromaru@linewidth}{}{%
          \setlinewidth{\Siromaru@linewidth}}%
        \ifx\empty #2\relax
          \En*[0]{(##1)}\r@pt
        \else
          \En*[0]<#2>{(##1)}\r@pt
        \fi
      \grestore
    }%
    \ifx\empty ##2\else
%      \expandafter\sub@SM##2?
      \edef\sub@SM@tmp{##2?}%
      \expandafter\sub@SM\sub@SM@tmp
    \fi
  }%
%
  \ukansan{#1}\r@pt
%  \edef\sub@KM@tmp{#3?}%
%  \expandafter\sub@SM\sub@KM@tmp
  \okikae{#3}{;}{}\SM@str%
  \edef\sub@SM@tmp{\SM@str?}%
  \expandafter\sub@SM\sub@SM@tmp
}}%
\def\S@@iromaru<#1>#2{\begingroup
%
  \edef\size@{\Siromaru@Hankei}%
  \edef\nuri@iro{\empty}%
  \edef\next@opt{\empty}%
%
  \def\sub@SM{\@ifnextchar({\sub@@SM}{\relax}}%
  \def\sub@@SM(##1)##2?{%
      \EMedef\SM@tmp{[0]<\next@opt>}%
    \ifx\empty\next@opt\relax
      \Put{(##1)}{\En*[0]\O@@\r@pt}%
    \else
      \EMedef\SM@tmp{*[0]<\next@opt>}%
      \Put{(##1)}{\expandafter\En\SM@tmp\O@@\r@pt}%
    \fi
    \ifx\empty ##2\else
      \edef\sub@SM@tmp{##2?}%
      \expandafter\sub@SM\sub@SM@tmp
    \fi
  }%
%
  \ifx\empty #1\else\setkeys{emPKM}{#1}\fi
  \ifx\empty\nuri@iro\else\edefappend[,]\next@opt{nuriiro=\nuri@iro}\fi
  \ukansan\size@\r@pt
  \edef\sub@SM@tmp{#2?}%
  \expandafter\sub@SM\sub@SM@tmp
\endgroup
}%
\let\oldSiromaru\K@uromaru
\let\Siromarus\Siromaru
%
\def\kuromaru{\@ifnextchar[{\@kuromaru}{\@kuromaru[\Kuromaru@Hankei]}}%
\def\@kuromaru[#1]{\@ifnextchar<{\@@kuromaru[#1]}{\@@kuromaru[#1]<\empty>}}%
\def\@@kuromaru[#1]<#2>#3{%
  \Cfor{\edef\kuromaru@a{#3}}{\not\equal{\kuromaru@a}{\empty}}{}\do{%
    \strsep{\kuromaru@a}{;}\kuromaru@a\kuromaru@b%
    \Kuromaru[#1]<#2>\kuromaru@a
    \edef\kuromaru@a{\kuromaru@b}}}%
%\def\kuromaru{\@ifnextchar[{\@kuromaru}{\@kuromaru[\Kuromaru@Hankei]}}%
%\def\@kuromaru[#1]#2{%
%  \Cfor{\edef\kuromaru@a{#2}}{\not\equal{\kuromaru@a}{\empty}}{}\do{%
%    \strsep{\kuromaru@a}{;}\kuromaru@a\kuromaru@b%
%    \Kuromaru[#1]\kuromaru@a
%    \edef\kuromaru@a{\kuromaru@b}}}%
%
\def\siromaru{\@ifnextchar[{\@siromaru}{\@siromaru[\Siromaru@Hankei]}}%
\def\@siromaru[#1]#2{%
  \Cfor{\edef\siromaru@a{#2}}{\not\equal{\siromaru@a}{\empty}}{}\do{%
    \strsep{\siromaru@a}{;}\siromaru@a\siromaru@b%
    \Siromaru[#1]\siromaru@a
    \edef\siromaru@a{\siromaru@b}}}%
%
% 四角
%
\define@key{emPKM}{size}{\def\size@{#1}}%
\define@key{emPKM}{kaiten}{\def\kaiten@{#1}}%
\define@key{emPKM}{nextopt}{\EMedef\next@opt{#1}}%
\define@key{emPKM}{nextoption}{\EMedef\next@opt{#1}}%
\define@key{emPKM}{iro}{\edef\iro@{#1}}%
\define@key{emPKM}{color}{\edef\iro@{#1}}%
\define@key{emPKM}{nuriiro}{\edef\nuri@iro{#1}}%
\define@key{emPKM}{paintcolor}{\edef\nuri@iro{#1}}%
\define@key{emPKM}{thickness}{\edef\thickness@{#1}}%
\define@key{emPKM}{linethickness}{\linethickness{#1}}%
%
\def\Kurosikaku{\begingroup
%
%
  \def\xy@hosei{}%
  \edef\size@{\Kurosikaku@Hankei}%
  \edef\kaiten@{0}%
  \edef\nuri@iro{\empty}%
  \edef\next@opt{\empty}%
  \edef\thickness@{\empty}%
  \@ifnextchar<{\@Kurosikaku}{\@Kurosikaku<\empty>}%
}%
\def\@Kurosikaku<#1>#2{%
%
  \def\sub@KM{\@ifnextchar({\sub@@KM}{\relax}}%
  \def\sub@@KM(##1)##2?{%
      \EMedef\KM@tmp{[\Nurizen]<\next@opt>}%
    \ifx\empty\next@opt\relax
      \Put{(##1)}{\Nuritubusi[\Nurizen]\KM@oresen}%
    \else
      \EMedef\KM@tmp{[\Nurizen]<\next@opt>}%
      \Put{(##1)}{\expandafter\Nuritubusi\KM@tmp\KM@oresen}%
    \fi
    \ifx\empty ##2\else
      \edef\sub@KM@tmp{##2?}%
      \expandafter\sub@KM\sub@KM@tmp
    \fi
  }%
%
  \ifx\empty #1\else\setkeys{emPKM}{#1}\fi
  \ukansan\size@\r@pt
  \ifx\empty\nuri@iro\else
    \edefappend[,]\next@opt{nuriiro=\nuri@iro}%
  \fi
  \ifx\empty\thickness@\else
    \edef\Nurizen{\thickness@}%
  \fi
  \Addself\kaiten@{45}\Rdef(\r@pt,\kaiten@)\KM@P
  \Addself\kaiten@{90}\Rdef(\r@pt,\kaiten@)\KM@Q
  \Addself\kaiten@{90}\Rdef(\r@pt,\kaiten@)\KM@R
  \Addself\kaiten@{90}\Rdef(\r@pt,\kaiten@)\KM@S
  \edef\KM@oresen{\KM@P\KM@Q\KM@R\KM@S}%
  \edef\sub@KM@tmp{#2?}%
  \expandafter\sub@KM\sub@KM@tmp
\endgroup
}%
%
\def\Sirosikaku{\begingroup
  \def\xy@hosei{}%
  \edef\size@{\Sirosikaku@Hankei}%
  \edef\kaiten@{0}%
  \edef\next@opt{\empty}%
  \@ifnextchar<{\@Sirosikaku}{\@Sirosikaku<\empty>}}%
\def\@Sirosikaku<#1>#2{%
%
  \def\sub@KM{\@ifnextchar({\sub@@KM}{\relax}}%
  \def\sub@@KM(##1)##2?{%
    \ifx\empty \next@opt\relax
      \Put{(##1)}{\Nuritubusi[0]<border>\KM@oresen}%
    \else
      \EMedef\PKM@tmp{[0]<border,\next@opt>}%
      \Put{(##1)}{\expandafter\Nuritubusi\PKM@tmp\KM@oresen}%
    \fi
    \ifx\empty ##2\else
      \edef\sub@KM@tmp{##2?}%
      \expandafter\sub@KM\sub@KM@tmp
    \fi
  }%
%
  \ifx\empty #1\else\setkeys{emPKM}{#1}\fi
  \ukansan\size@\r@pt
  \Addself\kaiten@{45}\Rdef(\r@pt,\kaiten@)\KM@P
  \Addself\kaiten@{90}\Rdef(\r@pt,\kaiten@)\KM@Q
  \Addself\kaiten@{90}\Rdef(\r@pt,\kaiten@)\KM@R
  \Addself\kaiten@{90}\Rdef(\r@pt,\kaiten@)\KM@S
  \edef\KM@oresen{\KM@P\KM@Q\KM@R\KM@S}%
  \edef\sub@KM@tmp{#2?}%
  \expandafter\sub@KM\sub@KM@tmp
\endgroup
}%
\def\Kurosankaku{\begingroup
%
  \def\xy@hosei{}%
  \edef\size@{\Kurosankaku@Hankei}%
  \edef\kaiten@{0}%
  \edef\nuri@iro{\empty}%
  \edef\next@opt{\empty}%
  \edef\thickness@{\empty}%
  \@ifnextchar<{\@Kurosankaku}{\@Kurosankaku<\empty>}}%
%
\def\@Kurosankaku<#1>#2{%
%
  \def\sub@KM{\@ifnextchar({\sub@@KM}{\relax}}%
  \def\sub@@KM(##1)##2?{%
    \ifx\empty #1\relax
      \Put{(##1)}{\Nuritubusi[\Nurizen]\KM@oresen}%
    \else
      \EMedef\KM@tmp{[\Nurizen]<\next@opt>}%
      \Put{(##1)}{\expandafter\Nuritubusi\KM@tmp\KM@oresen}%
    \fi
    \ifx\empty ##2\else
      \edef\sub@KM@tmp{##2?}%
      \expandafter\sub@KM\sub@KM@tmp
    \fi
  }%
%
  \ifx\empty #1\else\setkeys{emPKM}{#1}\fi
  \ukansan\size@\r@pt
  \ifx\empty\nuri@iro\else
    \edefappend[,]\next@opt{nuriiro=\nuri@iro}%
  \fi
  \ifx\empty\thickness@\else
    \edef\Nurizen{\thickness@}%
  \fi
  \Addself\kaiten@{-30}\Rdef(\r@pt,\kaiten@)\KM@P
  \Addself\kaiten@{120}\Rdef(\r@pt,\kaiten@)\KM@Q
  \Addself\kaiten@{120}\Rdef(\r@pt,\kaiten@)\KM@R
  \edef\KM@oresen{\KM@P\KM@Q\KM@R}%
  \edef\sub@KM@tmp{#2?}%
  \expandafter\sub@KM\sub@KM@tmp
\endgroup
}%
%
\def\Sirosankaku{\begingroup
%
  \def\xy@hosei{}%
  \edef\size@{\Sirosankaku@Hankei}%
  \edef\kaiten@{0}%
  \edef\next@opt{\empty}%
  \@ifnextchar<{\@Sirosankaku}{\@Sirosankaku<\empty>}}%
\def\@Sirosankaku<#1>#2{%
%
  \def\sub@KM{\@ifnextchar({\sub@@KM}{\relax}}%
  \def\sub@@KM(##1)##2?{%
    \ifx\empty #1\relax
      \Put{(##1)}{\Nuritubusi[0]<border>\KM@oresen}%
    \else
      \EMedef\KM@tmp{[0]<border,\next@opt>}%
      \Put{(##1)}{\expandafter\Nuritubusi\KM@tmp\KM@oresen}%
    \fi
    \ifx\empty ##2\else
      \edef\sub@KM@tmp{##2?}%
      \expandafter\sub@KM\sub@KM@tmp
    \fi
  }%
%
  \ifx\empty #1\else\setkeys{emPKM}{#1}\fi
  \ukansan\size@\r@pt
  \Addself\kaiten@{-30}\Rdef(\r@pt,\kaiten@)\KM@P
  \Addself\kaiten@{120}\Rdef(\r@pt,\kaiten@)\KM@Q
  \Addself\kaiten@{120}\Rdef(\r@pt,\kaiten@)\KM@R
  \edef\KM@oresen{\KM@P\KM@Q\KM@R}%
  \edef\sub@KM@tmp{#2?}%
  \expandafter\sub@KM\sub@KM@tmp
\endgroup
}%
%
%\def\Sirosikaku{\@ifnextchar[{\@Sirosikaku}{\@Sirosikaku[\Siromaru@Hankei]}}%
%\def\@Sirosikaku[#1]{\@ifnextchar<{\@@Sirosikaku[#1]}{\@@Sirosikaku[#1]<\empty>}}%
%\def\@@Sirosikaku[#1]<#2>#3{{%
%%
%  \def\sub@KM{\@ifnextchar({\sub@@KM}{\relax}}%
%  \def\sub@@KM(##1)##2?{%
%    \ifx\empty #2\relax
%      \Put{(##1)}{\Nuritubusi[0]<border>{%
%        (\r@pt,\r@pt)(-\r@pt,\r@pt)(-\r@pt,-\r@pt)(\r@pt,-\r@pt)}}%
%    \else
%      \Put{(##1)}{\Nuritubusi[0]<#2,border>{%
%        (\r@pt,\r@pt)(-\r@pt,\r@pt)(-\r@pt,-\r@pt)(\r@pt,-\r@pt)}}%
%    \fi
%    \ifx\empty ##2\else
%      \edef\sub@KM@tmp{##2?}%
%      \expandafter\sub@KM\sub@KM@tmp
%    \fi
%  }%
%%
%  \ukansan{#1}\r@pt
%  \edef\sub@KM@tmp{#3?}%
%  \expandafter\sub@KM\sub@KM@tmp
%}}%
%
\def\Sikaku{\@ifstar{\Sikaku@}{\@Sikaku}}%
\def\@Sikaku{\@ifnextchar<{\@@Sikaku}{\@@Sikaku<\empty>}}%
\def\@@Sikaku<#1>#2{%
  \ukansan\Kuromaru@Hankei\Sikaku@r
  \define@key{emP}{hankei}{\ukansan{##1}\Sikaku@r}%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
  \emathPut{#2}(0,0)[c]{\Takakkei{(-\Sikaku@r,-\Sikaku@r)(\Sikaku@r,-\Sikaku@r)(\Sikaku@r,\Sikaku@r)(-\Sikaku@r,\Sikaku@r)}}%
}%
\def\Sikaku@{\@ifnextchar<{\@Sikaku@}{\@Sikaku@<\empty>}}%
\def\@Sikaku@<#1>{\@ifnextchar[{\@@Sikaku@<#1>}{\@@Sikaku@<#1>[1]}}%
\def\@@Sikaku@<#1>[#2]{%
  \ukansan\Kuromaru@Hankei\Sikaku@r
  \edef\Sikaku@nuri@pt{\empty}%
  \define@key{emP}{hankei}{\ukansan{##1}\Sikaku@r}%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
  \Nuritubusi[#2]{%
      (-\Sikaku@r,-\Sikaku@r)(\Sikaku@r,-\Sikaku@r)(\Sikaku@r,\Sikaku@r)(-\Sikaku@r,\Sikaku@r)}%
}%
%
%\def\Sikaku{\@ifstar{\Sikaku@}{\@Sikaku}}%
%\def\@Sikaku{\@ifnextchar<{\@@Sikaku}{\@@Sikaku<\empty>}}%
%\def\@@Sikaku<#1>#2{%
%  \ukansan\Kuromaru@Hankei\Sikaku@r
%  \define@key{emP}{hankei}{\ukansan{##1}\Sikaku@r}%
%  \ifx\empty #1\else\setkeys{emP}{#1}\fi
%  \emathPut{#2}(0,0)[c]{\Takakkei{(-\Sikaku@r,-\Sikaku@r)(\Sikaku@r,-\Sikaku@r)(\Sikaku@r,\Sikaku@r)(-\Sikaku@r,\Sikaku@r)}}%
%}%
%\def\Sikaku@{\@ifnextchar<{\@Sikaku@}{\@Sikaku@<\empty>}}%
%\def\@Sikaku@<#1>{\@ifnextchar[{\@@Sikaku@<#1>}{\@@Sikaku@<#1>[1]}}%
%\def\@@Sikaku@<#1>[#2]#3{%
%  \ukansan\Kuromaru@Hankei\Sikaku@r
%  \edef\Sikaku@nuri@pt{\empty}%
%  \define@key{emP}{hankei}{\ukansan{##1}\Sikaku@r}%
%  \ifx\empty #1\else\setkeys{emP}{#1}\fi
%  \emathPut{#3}(0,0)[c]{\Nuritubusi[#2]{%
%      (-\Sikaku@r,-\Sikaku@r)(\Sikaku@r,-\Sikaku@r)(\Sikaku@r,\Sikaku@r)(-\Sikaku@r,\Sikaku@r)}}%
%}%
%
%
% さいころの目
\def\saikoro#1{{%
  \unitlength.8\zh\relax
  \EMkeytopcornersize{5}%
  \,\EMkeytop{%
  \begin{picture}(1,1)%
  \ifcase#1\relax
    \or\Kuromaru[.25em]{(.5,.5)}%
    \or\Kuromaru[.1em]{(.25,.25)}\Kuromaru[.1em]{(.75,.75)}%
    \or\Kuromaru[.1em]{(.125,.125)}\Kuromaru[.1em]{(.5,.5)}%
       \Kuromaru[.1em]{(.875,.875)}%
    \or\Kuromaru[.1em]{(.2,.2)}\Kuromaru[.1em]{(.2,.8)}%
       \Kuromaru[.1em]{(.8,.8)}\Kuromaru[.1em]{(.8,.2)}%
    \or\Kuromaru[.1em]{(.125,.125)}\Kuromaru[.1em]{(.5,.5)}%
       \Kuromaru[.1em]{(.875,.875)}\Kuromaru[.1em]{(.125,.875)}%
       \Kuromaru[.1em]{(.875,.125)}%
    \or\Kuromaru[.1em]{(.125,.1)}\Kuromaru[.1em]{(.125,.5)}%
      \Kuromaru[.1em]{(.125,.9)}\Kuromaru[.1em]{(.875,.1)}%
      \Kuromaru[.1em]{(.875,.5)}\Kuromaru[.1em]{(.875,.9)}%
%   \or\Kuromaru[.1em]{(.1,.125)}\Kuromaru[.1em]{(.5,.125)}%
%     \Kuromaru[.1em]{(.9,.125)}\Kuromaru[.1em]{(.1,.875)}%
%     \Kuromaru[.1em]{(.5,.875)}\Kuromaru[.1em]{(.9,.875)}%
  \fi
  \end{picture}%
  }\,%
}}%
%
% 文字サイズに合わせた丸囲み
%
\edef\emPmaru@kizyun{\empty}%
\def\emPmaru@fontsize{\normalsize}%
\def\emPmaru@thickness{.4truept}%
\def\emPmaruKizyun#1{\def\emPmaru@kizyun{#1}}%
\def\emPmaruKizyun#1{\def\emPmaru@kizyun{#1}}%
\def\emPmarufontsize#1{\def\emPmaru@fontsize{#1}}%
\def\emPmaruthickness#1{\def\emPmaru@thickness{#1}}%
%\def\emPmaru{\@ifnextchar<{\@emPmaru}{\@emPmaru<\empty>}}%
\DeclareRobustCommand\emPmaru{\@ifnextchar<{\@emPmaru}{\@emPmaru<\empty>}}%
\def\@emPmaru<#1>{\@ifnextchar[{\@@emPmaru<#1>}{\@@emPmaru<#1>[\emPmaru@kizyun]}}%
\def\@@emPmaru<#1>[#2]#3{{%
  \def\iro@{}%
  \ifx\empty #1\relax\else\setkeys{emP}{#1}\fi
  \ifthenelse{\equal{#2}\empty}{%
    \setbox0=\hbox{\emPmaru@fontsize #3}%
  }{%
    \setbox0=\hbox{\emPmaru@fontsize #2}%
  }%
  \@tempdima=.5\wd0\relax
  \edef\emPmaru@x{\strip@pt\@tempdima}%
  \@tempdima\ht0\advance\@tempdima\dp0
  \@tempdimb=.5\@tempdima
  \edef\emPmaru@y{\strip@pt\@tempdimb}%
  \Kyori{(0,0)}{(\emPmaru@x,\emPmaru@y)}\emPmaru@r
  \@tempdima\ht0\advance\@tempdima-\@tempdimb
  \edef\emPmaru@y{\strip@pt\@tempdima}%
  \Add\emPmaru@r\emPmaru@r\emPmaru@w
  \Add\emPmaru@r\emPmaru@y\emPmaru@h
  \Sub\emPmaru@r\emPmaru@y\emPmaru@d
%  \begin{picture}(\emPmaru@w,0)\relax
\mbox{%
  \begin{picture}(0,0)\relax
    \begin{zahyou*}[ul=\p@,haiti=x](0,\emPmaru@d)(-\emPmaru@d,\emPmaru@h)\relax
      {\ifx\empty\iro@\else\color{\iro@}\fi
%        \linethickness{\emPmaru@thickness}%
%        \put(\emPmaru@r,\emPmaru@y){\circle{\emPmaru@w}}%
       \En<linethickness=\emPmaru@thickness>{(\emPmaru@r,\emPmaru@y)}\emPmaru@r
      }%
    \end{zahyou*}%
  \end{picture}%
%  \hspace*{\emPmaru@r\p@}%
  \makebox[\emPmaru@w\p@][c]{\emPmaru@fontsize #3}%
%  \hspace{\emPmaru@r\p@}%
  \vrule\@width\z@\@height\emPmaru@h\p@\@depth\emPmaru@d\p@
}%
}}%
%
% 縦長の丸数字
\def\Nmaru@yokokei{.9em}%
%\def\Nmaru@tatekei{1.3em}%
%\def\Nmaru@tatekei{1.25em}%
\def\Nmaru@tatekei{1.2em}%
\def\nagamaru@thickness{.6pt}%
\def\nagamaruyokoHankei#1{\edef\Nmaru@yokokei{#1}}%
\def\nagamarutateHankei#1{\edef\Nmaru@tatekei{#1}}%
\DeclareRobustCommand\emNagamaru{%
  \begingroup
%  \setlength{\unitlength}{1pt}%
  \@ifstar{\emNagaNmaru@}{\@emNagamaru}}%
\def\emNagaNmaru@{\@ifnextchar[{\@@emNagamaru}{\@@emNagamaru[.5]}}%
\def\@emNagamaru{\@ifnextchar[{\@@emNagamaru}{\@@emNagamaru[\empty]}}%
\def\@@emNagamaru[#1]#2{%
  \settowidth\@tempdima{9}\advance\@tempdima\p@
  \settowidth\@tempdimb{#2}%
  \ifdim\@tempdimb>\@tempdima\edef\emNm@s{.8}\else\edef\emNm@s{.9}\fi
  \ukansan\Nmaru@yokokei\Nmaru@x
  \@Div\Nmaru@x{2}\Nmaru@a
  \ukansan\Nmaru@tatekei\Nmaru@y
  \@Div\Nmaru@y{2}\Nmaru@b
  \Mul\Nmaru@y{.75}\Nmaru@h
  \Sub\Nmaru@y\Nmaru@h\Nmaru@d
  \Sub\Nmaru@h\Nmaru@d\Nmaru@cy
  \Divself\Nmaru@cy{2}%
  \edef\Nmaru@cx{\Nmaru@a}%
  \@ifundefined{@xscale}{}{%
    \Divself\Nmaru@cy\@yscale
    \Divself\Nmaru@cx\@xscale
  }%
%%\Addself\Nmaru@cy{-.6}%
%\uykansan{.05em}\Nmaru@cy@
\uykansan{.01em}\Nmaru@cy@%%%%%%%%%%%% 2013/11/02
\Subself\Nmaru@cy\Nmaru@cy@
  \,\mbox{%
    \begin{zahyou*}(0,0)(0,0)%
      \ifx\empty #1\relax
        \linethickness{\nagamaru@thickness}%
        \Daen{(\Nmaru@cx,\Nmaru@cy)}\Nmaru@a\Nmaru@b
      \else
        \Daen*[#1]{(\Nmaru@cx,\Nmaru@cy)}\Nmaru@a\Nmaru@b
      \fi
    \end{zahyou*}%
    \@ifundefined{yunitlength}{%
      \makebox[\Nmaru@x\unitlength][c]{{\chgfontsizeratio{\emNm@s}{#2}}}%
      \vrule height\Nmaru@h\unitlength depth\Nmaru@d\unitlength width\z@
    }{%
      \makebox[\Nmaru@x\xunitlength][c]{{\chgfontsizeratio{\emNm@s}{#2}}}%
      \vrule height\Nmaru@h\yunitlength depth\Nmaru@d\yunitlength width\z@
    }%
  }\,\relax
\endgroup}%
%\let\nagamaru\emNagamaru
\DeclareRobustCommand\embNagamaru[1]{{%
  \def\nagamaru@thickness{1pt}\mbox{\normalfont\bfseries\emNagamaru{#1}}}}%
%\let\bnagamaru\embNagamaru
%\def\knagamaru#1{\emkNagamaru[1]{#1}}%
%
\def\emkNagamaru{\@ifstar{\emkNagaNmaru@}{\@emkNagamaru}}%
\def\emkNagaNmaru@{\@ifnextchar[{\@@emkNagamaru}{\@@emkNagamaru[1]}}%
\def\@emkNagamaru{\@ifnextchar[{\@@emkNagamaru}{\@@emkNagamaru[1]}}%
\def\@@emkNagamaru[#1]#2{{%
%  \ifnum #2<10\relax\edef\emNm@s{1}\else\edef\emNm@s{.75}\fi
\setbox0=\hbox{#2}%
\setbox1=\hbox{9}%
\@tempdima=\wd1\advance\@tempdima\p@
\ifdim\wd0>\@tempdima\edef\emNm@s{.8}\else\edef\emNm@s{1}\fi
  \ukansan\Nmaru@yokokei\Nmaru@x
  \@Div\Nmaru@x{2}\Nmaru@a
  \ukansan\Nmaru@tatekei\Nmaru@y
  \@Div\Nmaru@y{2}\Nmaru@b
  \Mul\Nmaru@y{.75}\Nmaru@h
  \Sub\Nmaru@y\Nmaru@h\Nmaru@d
  \Sub\Nmaru@h\Nmaru@d\Nmaru@cy
  \Divself\Nmaru@cy{2}%
  \edef\Nmaru@cx{\Nmaru@a}%
  \@ifundefined{@xscale}{}{%
    \Divself\Nmaru@cy\@yscale
    \Divself\Nmaru@cx\@xscale
  }%
  \mbox{%
    \begin{zahyou*}(0,0)(0,0)%
      \ifx\empty #1\relax
        \linethickness{\nagamaru@thickness}%
        \Daen{(\Nmaru@cx,\Nmaru@cy)}\Nmaru@a\Nmaru@b
      \else
        \Daen*[#1]{(\Nmaru@cx,\Nmaru@cy)}\Nmaru@a\Nmaru@b
      \fi
    \end{zahyou*}%
    \@ifundefined{yunitlength}{%
      \makebox[\Nmaru@x\unitlength][c]{{\chgfontsizeratio{\emNm@s}{\textcolor{white}{\textbf{#2}}}}}%
      \vrule height\Nmaru@h\unitlength depth\Nmaru@d\unitlength width\z@
    }{%
      \makebox[\Nmaru@x\xunitlength][c]{{\chgfontsizeratio{\emNm@s}{\textcolor{white}{\textbf{#2}}}}}%
      \vrule height\Nmaru@h\yunitlength depth\Nmaru@d\yunitlength width\z@
    }%
  }%
}}%
\let\knagamaru\emkNagamaru
%------------------------------------------------------------------
%
%
% 円弧，扇形，弓形
%
% 楕円
%   \Daen[#1]#2#3#4
%   #1 : 塗りつぶしの濃さ
%   #2 : 中心の座標
%   #3 : 横軸方向の半径
%   #4 : 縦軸方向の半径
%
\def\Daen{\@ifstar{\Daen@}{\@Daen}}%
\def\Daen@{\@ifstar{\Hatch@Daen}{\Daen@@}}%
\def\Daen@@{\@ifnextchar[{\@Daen@}{\@Daen@[0.5]}}%
\def\@Daen@[#1]#2#3#4{{%\special{sh #1}%
%  \edef\@resen{}%
%  \For\@kaku{0}{6.2832}{0.1}\Do{%
%  \Cos\@kaku\@x\Mul{#3}\@x\@x
%  \Sin\@kaku\@y\Mul{#4}\@y\@y
%  \edef\@P{(\@x,\@y)}\Addvec\@P{#2}\@P
%  \edef\@resen{\@resen\@P}}%
%  \Addvec{#2}{(#3,0)}\@P
%  \edef\@resen{\@resen\@P}%
%  \Nuritubusi[#1]\@resen
%  \@iro{\nuri@iro}\Drawline\@resen
  \edef\draw@border{\empty}%
  \edef\nuri@iro{\nuri@iro@}%
  \Strchr{#1}{=}\nuri@iro@tmp
  \ifnum\nuri@iro@tmp>\z@\setkeys{emP}{#1}\fi
  \Add{#3}{#3}\@x\Add{#4}{#4}\@y
%\typeout{nuri@iro=\nuri@iro}%
  \ifthenelse{\equal{#1}{0}}{%
%    \put(0,0){\special{sh #1}\emathPut{#2}{\@arc\@x\@y{0}{6.2832}}}\ignorespaces
     \put(0,0){\special{bk}{\@iro{white}\emathPut{#2}{\@arc\@x\@y{0}{6.2832}}}}\ignorespaces
  }{%
    \ifthenelse{\equal\nuri@iro\empty}{%
      \put(0,0){\special{sh #1}\emathPut{#2}{\@arc\@x\@y{0}{6.2832}}}\ignorespaces
    }{%
      \put(0,0){%
        \special{bk}{\@iro{\nuri@iro}\emathPut{#2}{\@arc\@x\@y{0}{6.2832}}}%
        \ifx\empty\draw@border\else
          \@iro{\iro@}\emathPut{#2}{\@arc\@x\@y{0}{6.2832}}%
        \fi
      }%
    }%
  }%
}}%
\def\@Daen{\@ifnextchar<{\@@Daen}{\@@Daen<\empty>}}%
\def\@@Daen<#1>#2#3#4{{%
  \edef\hasen@opt{\empty}%
  \Strchr{#1}{=}\Daen@@tmp
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
  \ifx\empty\hasen@opt
    \ifthenelse{\equal\empty\iro@}{}{\@iro\iro@}%
    \Add{#3}{#3}\@x\Add{#4}{#4}\@y
    \emathPut{#2}{\@arc\@x\@y{0}{6.2832}}%
  \else
    \emathPut{#2}{\Daenko<#1>{#3}{#4}{0}{360}}%
  \fi
}\ignorespaces}%
\def\Hatch@Daen{\@ifnextchar[{\@Hatch@Daen}{\@Hatch@Daen[45]}}%
\def\@Hatch@Daen[#1]{\@ifnextchar<{\@@Hatch@Daen[#1]}{%
  \@@Hatch@Daen[#1]<\empty>}}%
\def\@@Hatch@Daen[#1]<#2>{\@ifnextchar({\@@@Hatch@Daen[#1]<#2>}{%
  \@@@Hatch@Daen[#1]<#2>(.1)}}%
\def\@@@Hatch@Daen[#1]<#2>(#3)#4#5#6{%
  \edef\@resen{}%
  \For\@kaku{0}{6.2832}{#3}\Do{%
  \Cos\@kaku\@x\Mul{#5}\@x\@x
  \Sin\@kaku\@y\Mul{#6}\@y\@y
  \edef\@P{(\@x,\@y)}\Addvec\@P{#4}\@P
  \edef\@resen{\@resen\@P}}%
  \Addvec{#4}{(#5,0)}\@P
  \edef\@resen{\@resen\@P}%
  \Hatchpolygon[#1]<#2>\@resen}%
%
% 楕円弧
%       \Daenko<#1>#2#3#4#5
%               #1 : key=val
%                     hasen=[破線の長さ][破線の間隔]
%                     yazirusi=a : 正方向に矢印をつける
%                              =r : 負方向に矢印をつける
%                              =b : 両方向に矢印をつける
%                              =n : 矢印をつけない
%               #2 : 横軸方向の半径
%               #3 : 縦軸方向の半径
%               #4 : 始め角
%               #5 : 終り角
%               （中心は \put (\emathPut) で指定する．）
%       \Daenko[#1][#2]#3#4#5#6
%               #1 : 弧を点線にするときの破線の長さ
%               #2 : 破線の間隔
%               #3 : 横軸方向の半径
%               #4 : 縦軸方向の半径
%               #5 : 始め角
%               #6 : 終り角
%               （中心は \put (\emathPut) で指定する．）
%
\def\Daenko{\edef\yazirusi@opt{\empty}\edef\hasen@opt{\empty}%
  \@ifstar{\Daenko@}{\@Daenko}}%
\def\@Daenko{%
\ifnum\EMps@mode=\@ne\gsave\fi
\bgroup
  \@ifnextchar<{\D@enko}{\@D@enko}}%
\def\D@enko<#1>{\setkeys{emP}{#1}%
  \ifthenelse{\equal{\hasen@opt}{\empty}}{\@D@enko}{%
  \expandafter\@@Daenko\hasen@opt}%
}%
\def\@D@enko{\@ifnextchar[{\@@Daenko}{\@@Daenko[\empty]}}%
\def\@@Daenko[#1]{\@ifnextchar[{\@@@Daenko[#1]}{\@@@Daenko[#1][1]}}%
\def\@@@Daenko[#1][#2]#3#4#5#6{%
  \ifthenelse{\equal{#1}{\empty}}%
  {%
    \Add{#3}{#3}\@x\Add{#4}{#4}\@y%
    \Sub{#6}{#5}{\@tyuusinkaku}\Sub{360}{#6}\@hazimekaku%
    \Add{\@hazimekaku}{\@tyuusinkaku}{\@owarikaku}%
    \DegRad{\@hazimekaku}{\@hazimekaku}%
    \DegRad{\@owarikaku}{\@owarikaku}%
    \put(0,0){{%
      \ifthenelse{\equal\iro@\empty}{}{\@iro{\iro@}}%
      \@arc\@x\@y{\@hazimekaku}{\@owarikaku}}}%
  }{%\else
    \edef\@hazimekaku{#5}\edef\@owarikaku{#6}%
    \DegRad{\@hazimekaku}{\@hazimekaku}\DegRad{\@owarikaku}{\@owarikaku}%
    \edef\@x{#3}\edef\@y{#4}%
    \Mul{#2}{0.18}\@dx\Mul{#1}{0.1}\@lx
%    \Mul{#2}{.9}\@dx\Mul{#1}{.5}\@lx
%      \Divself\@dx\@x
%      \Divself\@lx\@x
    \For\@t{\@hazimekaku}{\@owarikaku}{\@dx}\Do{\Add\@t{\@lx}\@@t%
      \ifthenelse{\lengthtest{\@@t pt>\@owarikaku pt}}{%
        \edef\@@t{\@owarikaku}}{}%
      \Cos\@t\@xi\Mul\@x\@xi\@xi\Cos\@@t\@xii\Mul\@x\@xii\@xii%
      \Sin\@t\@yi\Mul\@y\@yi\@yi\Sin\@@t\@yii\Mul\@y\@yii\@yii%
      \drawline(\@xi,\@yi)(\@xii,\@yii)}%
  }%
  \ifthenelse{\lengthtest{\arrow@headsize\p@>\z@}}{%
    \ifx\empty\yazirusi@opt
    \else
      \DaYenko[\yazirusi@opt]{#3}{#4}{#5}{#6}%
    \fi
  }{}%
\egroup
% \ifnum\EMps@mode=\@ne\grestore\fi%%   ---> emathPs.sty
}%
\def\Daenko@{\@ifstar{\Hatch@Daenko}{\Daenko@@}}%
\def\Daenko@@{\@ifnextchar[{\@Daenko@}{\@Daenko@[0.5]}}%
\def\@Daenko@[#1]#2#3#4#5{%
    \edef\@hazimekaku{#4}\edef\@owarikaku{#5}%
      \DegRad{\@hazimekaku}{\@hazimekaku}\DegRad{\@owarikaku}{\@owarikaku}%
    \edef\@x{#2}\edef\@y{#3}\def\@resen{}%
    \For\@t{\@hazimekaku}{\@owarikaku}{0.1}\Do{%\Add\@t{\@lx}\@@t%
      \Cos\@t\@xi\Mul\@x\@xi\@xi
      \Sin\@t\@yi\Mul\@y\@yi\@yi
      \edef\@resen{\@resen(\@xi,\@yi)}}%
    \Cos\@owarikaku\@xi\Mul\@x\@xi\@xi\Sin\@owarikaku\@yi\Mul\@y\@yi\@yi
    \edef\@resen{\@resen(\@xi,\@yi)}%
    \Cos\@hazimekaku\@xi\Mul\@x\@xi\@xi\Sin\@hazimekaku\@yi\Mul\@y\@yi\@yi
    \edef\@resen{\@resen(\@xi,\@yi)}%
\emPaint<thickness=#1>\@resen
%    \Nuritubusi[#1]\@resen
}%
%
\def\KinziDaenko{\@ifnextchar[{\@KinziDaenko}{\@KinziDaenko[\empty]}}%
\def\@KinziDaenko[#1]#2#3#4#5#6#7{%
  \edef\Rdef@rad{0}%
	\ifx #1\empty\else\setkeys{emP}{#1}\fi
	\vecXY{#2}\c@x\c@y
	\def\X@t{\c@x+{#3}*cos(T)}%
	\def\Y@t{\c@x+{#4}*sin(T)}%
	\ifnum\Rdef@rad=\z@
		\DegRad{#5}\ts@val
		\DegRad{#6}\te@val
		\ParamLC<mint=\ts@val,maxt=\te@val>\X@t\Y@t#7\relax
	\else
		\ParamLC<mint=#5,maxt=#6>\X@t\Y@t#7\relax
	\fi
}%
%
\def\Hatch@Daenko{\@ifnextchar[{\@Hatch@Daenko}{\@Hatch@Daenko[45]}}%
\def\@Hatch@Daenko[#1]{\@ifnextchar<{\@@Hatch@Daenko[#1]}{%
  \@@Hatch@Daenko[#1]<\empty>}}%
\def\@@Hatch@Daenko[#1]<#2>{\@ifnextchar({\@@@Hatch@Daenko[#1]<#2>}{%
  \@@@Hatch@Daenko[#1]<#2>(.1)}}%
\def\@@@Hatch@Daenko[#1]<#2>(#3)#4#5#6#7{%
    \edef\@hazimekaku{#6}\edef\@owarikaku{#7}%
      \DegRad{\@hazimekaku}{\@hazimekaku}\DegRad{\@owarikaku}{\@owarikaku}%
    \edef\@x{#4}\edef\@y{#5}\def\@resen{}%
    \For\@t{\@hazimekaku}{\@owarikaku}{#3}\Do{%\Add\@t{\@lx}\@@t%
      \Cos\@t\@xi\Mul\@x\@xi\@xi
      \Sin\@t\@yi\Mul\@y\@yi\@yi
      \edef\@resen{\@resen(\@xi,\@yi)}}%
    \Cos\@owarikaku\@xi\Mul\@x\@xi\@xi\Sin\@owarikaku\@yi\Mul\@y\@yi\@yi
    \edef\@resen{\@resen(\@xi,\@yi)}%
    \Cos\@hazimekaku\@xi\Mul\@x\@xi\@xi\Sin\@hazimekaku\@yi\Mul\@y\@yi\@yi
    \edef\@resen{\@resen(\@xi,\@yi)}%
    \Hatchpolygon[#1]<#2>\@resen}%
%
%% 矢線付き楕円弧（偏角指定）
%%   \Dayenko[#1]#2#3#4#5
%%   #1 : 矢印を逆につけるには [r] とする．
%%   #2 : 横軸方向の半径
%%   #3 : 縦軸方向の半径
%%   #4 : 始め角
%%   #5 : 終り角（終り角＞始め角）でなければならない．）
%%   （中心は \put (\emathPut) で指定する．）
%
%
\def\Dayenko{\@ifnextchar[{\@Dayenko}{\@Dayenko[\empty]}}%
\def\@Dayenko[#1]#2#3#4#5{\Add{#2}{#3}\@Dayenko@r\@Div\@Dayenko@r{2}\@Dayenko@r
  \@Div\Arr@wHeadSize{\@Dayenko@r}\d@theta
  \Mul\d@theta{.95}\d@theta
\bgroup
%
  \@ifundefined{xunitlength}{}{%
    \kansan{\xmin\xunitlength}{\unitlength}\xmin
    \kansan{\ymin\yunitlength}{\unitlength}\ymin
    \xunitlength=\unitlength
    \yunitlength=\unitlength
    \def\@xscale{1}%
    \def\@yscale{1}%
  }%
%
%  \@ifundefined{xunitlength}{}{\xunitlength=\unitlength}%
%  \@ifundefined{yunitlength}{}{\yunitlength=\unitlength}%
  \ifthenelse{\equal{#1}\empty}{%
    \DegRad{#5}\@Dayenko@arg
    \Cos\@Dayenko@arg\@Px\Mul{#2}\@Px\@Px
    \Sin\@Dayenko@arg\@Py\Mul{#3}\@Py\@Py
    \edef\@P{(\@Px,\@Py)}%
    \Sub\@Dayenko@arg\d@theta\@Dayenko@arg
    \Cos\@Dayenko@arg\@Sx\Mul{#2}\@Sx\@Sx
    \Sin\@Dayenko@arg\@Sy\Mul{#3}\@Sy\@Sy
    \edef\@S{(\@Sx,\@Sy)}%
    \Subvec\@S\@P\@PS
    \Rotvec[\Arr@wHeadSize]\@PS{\ArrowHeadAngle}\@PQ\Addvec\@P\@PQ\@Q%
    \Rotvec[\Arr@wHeadSize]\@PS{-\ArrowHeadAngle}\@PR\Addvec\@P\@PR\@R%
  }{%
    \DegRad{#4}\@Dayenko@arg
    \Cos\@Dayenko@arg\@Px\Mul{#2}\@Px\@Px
    \Sin\@Dayenko@arg\@Py\Mul{#3}\@Py\@Py
    \edef\@P{(\@Px,\@Py)}%
    \Add\@Dayenko@arg\d@theta\@Dayenko@arg
    \Cos\@Dayenko@arg\@Sx\Mul{#2}\@Sx\@Sx
    \Sin\@Dayenko@arg\@Sy\Mul{#3}\@Sy\@Sy
    \edef\@S{(\@Sx,\@Sy)}%
    \Subvec\@S\@P\@PS
    \Rotvec[\Arr@wHeadSize]\@PS{\ArrowHeadAngle}\@PQ\Addvec\@P\@PQ\@Q%
    \Rotvec[\Arr@wHeadSize]\@PS{-\ArrowHeadAngle}\@PR\Addvec\@P\@PR\@R%
  }%
  \Nuritubusi[\Nurizen]{\@Q\@P\@R\@Q}%
  \Drawline{\@Q\@P\@R\@Q}%
  \Daenko{#2}{#3}{#4}{#5}%
\egroup
}%
%
% 矢線付き楕円弧（矢印のみ）
%   \DaYenko[#1]#2#3#4#5
%   #1 : 矢印を逆につけるには [r] とする．
%   #2 : 横軸方向の半径
%   #3 : 縦軸方向の半径
%   #4 : 始め角
%   #5 : 終り角（終り角＞始め角）でなければならない．）
%   （中心は \put (\emathPut) で指定する．）
%
\def\DaYenko{\@ifnextchar[{\@DaYenko}{\@DaYenko[\empty]}}%
\def\@DaYenko[#1]#2#3#4#5{%
  \Add{#2}{#3}\@DaYenko@r\@Div\@DaYenko@r{2}\@DaYenko@r
  \@Div\Arr@wHeadSize{\@DaYenko@r}\d@theta
  \Mul\d@theta{.95}\d@theta
\bgroup
%
%  \@ifundefined{xunitlength}{}{%
%    \kansan{\xmin\xunitlength}{\unitlength}\xmin
%    \kansan{\ymin\yunitlength}{\unitlength}\ymin
%    \xunitlength=\unitlength
%    \yunitlength=\unitlength
%    \def\@xscale{1}%
%    \def\@yscale{1}%
%  }%
%
\edef\DaYenko@yazirusi{#1}\edef\yazirusi@opt{\empty}%
  \@ifundefined{xunitlength}{}{\xunitlength=\unitlength}%
  \@ifundefined{yunitlength}{}{\yunitlength=\unitlength}%
  \ifthenelse{\equal{\DaYenko@yazirusi}{\empty}\or\equal{\DaYenko@yazirusi}{a}\or\equal{\DaYenko@yazirusi}{b}}{%
    \DegRad{#5}\@DaYenko@arg
    \Cos\@DaYenko@arg\@Px\Mul{#2}\@Px\@Px
    \Sin\@DaYenko@arg\@Py\Mul{#3}\@Py\@Py
    \edef\@P{(\@Px,\@Py)}%
    \Sub\@DaYenko@arg\d@theta\@DaYenko@arg
    \Cos\@DaYenko@arg\@Sx\Mul{#2}\@Sx\@Sx
    \Sin\@DaYenko@arg\@Sy\Mul{#3}\@Sy\@Sy
    \edef\@S{(\@Sx,\@Sy)}%
    \Subvec\@S\@P\@PS
    \Rotvec[\Arr@wHeadSize]\@PS{\ArrowHeadAngle}\@PQ\Addvec\@P\@PQ\@Q%
    \Rotvec[\Arr@wHeadSize]\@PS{-\ArrowHeadAngle}\@PR\Addvec\@P\@PR\@R%
    \Nuritubusi[\Nurizen]{\@Q\@P\@R\@Q}\Drawline{\@Q\@P\@R\@Q}%
  }{}%
  \ifthenelse{\equal{\DaYenko@yazirusi}{r}\or\equal{\DaYenko@yazirusi}{b}}{%
    \DegRad{#4}\@DaYenko@arg
    \Cos\@DaYenko@arg\@Px\Mul{#2}\@Px\@Px
    \Sin\@DaYenko@arg\@Py\Mul{#3}\@Py\@Py
    \edef\@P{(\@Px,\@Py)}%
    \Add\@DaYenko@arg\d@theta\@DaYenko@arg
    \Cos\@DaYenko@arg\@Sx\Mul{#2}\@Sx\@Sx
    \Sin\@DaYenko@arg\@Sy\Mul{#3}\@Sy\@Sy
    \edef\@S{(\@Sx,\@Sy)}%
    \Subvec\@S\@P\@PS
    \Rotvec[\Arr@wHeadSize]\@PS{\ArrowHeadAngle}\@PQ\Addvec\@P\@PQ\@Q%
    \Rotvec[\Arr@wHeadSize]\@PS{-\ArrowHeadAngle}\@PR\Addvec\@P\@PR\@R%
    \Nuritubusi[\Nurizen]{\@Q\@P\@R\@Q}\Drawline{\@Q\@P\@R\@Q}%
  }{}%
\egroup
}%
%
% 直線のまわりに回転させることを表す記号
% \kaitenkigou<#1>[#2]
%   #1 : 倍率
%     または key=val
%            bairitu= （倍率）デフォルト値 : 1
%            muki = r/a                      a
%                r で，負の向き
%                n で，正の向き
%            hazimekaku=                     15
%            owarikaku=                     345
%            tyouhankei=                      3mm
%            tanhankei=                     1.5mm
%   #2 : 回転角
%   位置は \emathPut で指定
%
\def\kaitenkigou{\@ifnextchar<{\@kaitenkigou}{\@kaitenkigou<1>}}%
\def\@kaitenkigou<#1>{\@ifnextchar[{\@@kaitenkigou<#1>}{%
  \@@kaitenkigou<#1>[0]}}%
\def\@@kaitenkigou<#1>[#2]{{%
  \def\@bairitu{1}%
  \def\@hazimekaku{15}%
  \def\@owarikaku{345}%
  \def\@tyouhankei{3mm}%
  \def\@tanhankei{1.5mm}%
  \def\@muki{n}%
  \edef\yazirusi@opt{n}%
  \Strchr{#1}{=}\kaitenkigou@tmp
  \ifnum\kaitenkigou@tmp>\z@
    \setkeys{emP}{#1}%
  \else
    \def\@bairitu{#1}%
  \fi
  \ifx\empty\yazirusi@opt
    \else\edef\@muki{\yazirusi@opt}\edef\yazirusi@opt{\empty}%
  \fi
  \ifthenelse{\equal\@muki{n}}{\edef\@muki{\empty}}{}%
  \@tempdima=\@tanhankei
  \@tempdima=\@bairitu\@tempdima
  \@Div{\strip@pt\@tempdima}{\strip@pt\unitlength}\rotmark@x
  \@tempdima=\@tyouhankei
  \@tempdima=\@bairitu\@tempdima
  \@Div{\strip@pt\@tempdima}{\strip@pt\unitlength}\rotmark@y
%  \Mul\rotmark@x{2}\rotmark@y
    \ifthenelse{\equal{#2}{0}}{%
      \Dayenko[\@muki]\rotmark@x\rotmark@y{\@hazimekaku}{\@owarikaku}%
    }{%
      \rotatebox{#2}{%
        \Dayenko[\@muki]\rotmark@x\rotmark@y{\@hazimekaku}{\@owarikaku}}%
    }%
}}%
%
%
% 円
% \En<#1>#2#3
%  <#1>: hasen=xx で円弧を破線で描画するときの
%                  [破線の長さ][破線の間隔]
%   #2 : 中心の座標
%   #3 : 半径
% \En*[#1]#2#3 塗りつぶす
%   #1 : 塗りの濃度
%   #2 : 中心
%   #3 : 半径
%
\def\@icirclespecial#1#2#3#4{%
              \special{pn \the\@gphlinewidth}%
              \special{ia 0 0 #1 #2 #3 #4}%
}%
\def\@iarc#1#2#3#4{%
%% convert TeX dimension to length in terms thousandth of an inch
        \@tempdima #1\unitlength
        \@tempdimb #2\unitlength
        \@tempcnta\@tempdima \advance\@tempcnta 4736 \divide\@tempcnta 9473
        \@tempcntb\@tempdimb \advance\@tempcntb 4736 \divide\@tempcntb 9473
        \setbox\@tempboxa\hbox{%
            \@icirclespecial{\the\@tempcnta}{\the\@tempcntb}{#3}{#4}}%
        \wd\@tempboxa\z@ \box\@tempboxa}%
\def\iarc#1#2#3{\@iarc{#1}{#1}{#2}{#3}}%
%
%\def\En{%\edef\iro@{\empty}%
\DeclareRobustCommand\En{%\edef\iro@{\empty}%
  \@ifstar{\Enban}{\Ensyuu}}%
\def\Ensyuu{\@ifnextchar<{\En@h}{\Ensyuu@}}%
\def\En@h<#1>#2#3{\Enk@<#1>{#2}{#3}{0}{360}}%
\def\Ensyuu@{\@ifnextchar[{\@Enko}{\@Ensyuu}}%
\def\@Ensyuu#1{\@ifnextchar<{\@@DaEn{#1}}{\@@Ensyuu{#1}}}%
\def\@@DaEn#1<#2>#3{\Add{#2}{#2}\@x\Add{#3}{#3}\@y
  \emathPut{#1}{\@arc\@x\@y{0}{6.2832}}}%
\def\@Enko[#1,#2]{\@ifnextchar[{\@@Enko[#1,#2]}{%
  \@@Enko[#1,#2][\empty]}}%
\def\@@Enko[#1,#2][#3]#4{\@ifnextchar<{\@@@DaEnko[#1,#2][#3]{#4}}{%
  \@@@Enko[#1,#2][#3]{#4}}}%
\def\@@@Enko[#1,#2][#3]#4#5{\Add{#5}{#5}{\@tyokkei}%
    \Sub{#2}{#1}{\@tyuusinkaku}%
    \Sub{360}{#2}\@hazimekaku%
    \Add{\@hazimekaku}{\@tyuusinkaku}{\@owarikaku}%
    \DegRad{\@hazimekaku}{\@hazimekaku}%
    \DegRad{\@owarikaku}{\@owarikaku}%
    \emathPut{#4}{\@ifundefined{arc}{}{\enkoo\@tyokkei\@hazimekaku\@owarikaku}{%
      \tpic@arc{\@tyokkei}{\@hazimekaku}{\@owarikaku}}}%
    \ifx\empty#3\else
    \Rdef(#5,#1)\@A\Addvec{#4}\@A\@A
    \Rdef(#5,#2)\@B\Addvec{#4}\@B\@B
    \ifx y#3\Drawline{\@A\@B}\else\ifx o#3\Drawline{\@A#4\@B}\fi\fi\fi}%
\def\@@@DaEnko[#1,#2][#3]#4<#5>#6{%
    \Add{#5}{#5}\@x\Add{#6}{#6}\@y%
    \Sub{#2}{#1}{\@tyuusinkaku}\Sub{360}{#2}\@hazimekaku%
      \Add{\@hazimekaku}{\@tyuusinkaku}{\@owarikaku}%
      \DegRad{\@hazimekaku}{\@hazimekaku}\DegRad{\@owarikaku}{\@owarikaku}%
    \emathPut{#4}{\@arc\@x\@y{\@hazimekaku}{\@owarikaku}}}%
%
\def\@@Ensyuu#1#2{%
  \Strchr{#2}{=}\@@Ensyuu@tmp
  \ifnum\@@Ensyuu@tmp>\z@
    \EMedef\@tyuusin{#1}\relax
    \setkeys{emP}{#2}%
  \else
    \edef\@hankei{#2}%
  \fi
  \ifnum\enkobyspecial>\z@
    \Add\@hankei\@hankei\En@d%%%%%%\Mul\En@d{.999}\En@d
    \emathPut{#1}{\circle{\En@d}}%
  \else
    \Enko{#1}{#2}{0}{360}%
  \fi
  \ignorespaces}%
%
\def\Enban{\@ifstar{\Hatch@Circle}{\Enban@}}%
\def\Enban@{\@ifnextchar[{\@Enban}{\@Enban[0.5]}}%
\def\@Enban[#1]{\@ifnextchar<{\@@Enban[#1]}{\@@Enban[#1]<\empty>}}%
\def\@@Enban[#1]<#2>#3#4{{%
  \Strchr{#4}{=}\@@Ensyuu@tmp
  \ifnum\@@Ensyuu@tmp>\z@
    \edef\@tyuusin{#3}\relax
    \setkeys{emP}{#4}%
  \else
    \edef\@hankei{#4}%
  \fi
  \Add\@hankei\@hankei\En@d
  \edef\noudo@{.5}%
  \edef\nuri@iro{\nuri@iro@}%
  \Strchr{#1}{=}\nuri@iro@tmp
  \ifnum\nuri@iro@tmp>\z@\setkeys{emP}{#1}\else\edef\noudo@{#1}\fi
  \ifx\empty #2\else\setkeys{emP}{#2}\fi
  \ifx\empty\iro@\else\edef\draw@border{y}\fi
\@ifundefined{em@grdrv}{%
  \ifthenelse{\equal{\noudo@}{0}}{%
    \@ifundefined{ifcolors@}{%
      \put(0,0){\special{sh \noudo@}\emathPut{#3}{\iarc{\En@d}{0}{6.2832}}}%
    }{%
      \put(0,0){%
            \special{bk}{\@iro{white}\emathPut{#3}{\iarc{\En@d}{0}{6.2832}}}}%
    }%
    \ifthenelse{\equal\draw@border{0}}{}{%
      \@ifundefined{ifcolors@}{%
        \emathPut{#3}{\tpic@arc{\En@d}{0}{6.2832}}%
      }{%
        \emathPut{#3}{\@iro{\iro@}\tpic@arc{\En@d}{0}{6.2832}}%
      }%
    }%
  }{%
    \ifthenelse{\equal\nuri@iro\empty}{%
      \put(0,0){\special{sh \noudo@}\emathPut{#3}{\iarc{\En@d}{0}{6.2832}}}%
    }{%
      \put(0,0){%
        \special{bk}{\@iro{\nuri@iro}\emathPut{#3}{\iarc{\En@d}{0}{6.2832}}%
        \emathPut{#3}{\@iro{\nuri@iro}\iarc{\En@d}{0}{6.2832}}}%
      }%
    }%
    \ifx\empty\draw@border\else
      \emathPut{#3}{\@iro{\iro@}\tpic@arc{\En@d}{0}{6.2832}}%
    \fi
  }%
}{%
  \ifthenelse{\equal{\noudo@}{0}}{%
    \ifthenelse{\equal{\em@grdrv}{dviout}}{%
      \put(0,0){\special{sh \noudo@}\emathPut{#3}{\iarc{\En@d}{0}{6.2832}}}%
    }{%
      \ifthenelse{\equal{\em@grdrv}{dvipdfmx}}{%
        \put(0,0){\special{sh \noudo@}\emathPut{#3}{\iarc{\En@d}{0}{6.2832}}}%
      }{%
        \@ifundefined{color}{%
          \put(0,0){\special{sh \noudo@}\emathPut{#3}{\iarc{\En@d}{0}{6.2832}}}%
        }{%
          \put(0,0){%
            \special{bk}{\@iro{white}\emathPut{#3}{\iarc{\En@d}{0}{6.2832}}}}%
        }%
      }%
    }%
    \ifthenelse{\equal\draw@border{0}}{}{%
      \emathPut{#3}{\@iro{\iro@}\tpic@arc{\En@d}{0}{6.2832}}}%
  }{%
    \ifthenelse{\equal\nuri@iro\empty}{%
      \put(0,0){\special{sh \noudo@}\emathPut{#3}{\iarc{\En@d}{0}{6.2832}}}%
    }{%
      \put(0,0){%
        \special{bk}{\@iro{\nuri@iro}\emathPut{#3}{\iarc{\En@d}{0}{6.2832}}%
        \emathPut{#3}{\@iro{\nuri@iro}\iarc{\En@d}{0}{6.2832}}}%
      }%
    }%
    \ifx\empty\draw@border\else
      \emathPut{#3}{\@iro{\iro@}\tpic@arc{\En@d}{0}{6.2832}}%
    \fi
  }%
}%
}}%
%
\def\Hatch@Circle{\@ifnextchar[{\@Hatch@Circle}{\@Hatch@Circle[45]}}%
\def\@Hatch@Circle[#1]{\@ifnextchar<{\@@Hatch@Circle[#1]}{%
  \@@Hatch@Circle[#1]<\empty>}}%
\def\@@Hatch@Circle[#1]<#2>{\@ifnextchar({\@@@Hatch@Circle[#1]<#2>}{%
  \@@@Hatch@Circle[#1]<#2>(.1)}}%
\def\@@@Hatch@Circle[#1]<#2>(#3)#4#5{%
  \edef\@tyuusin{#4}\relax
  \Strchr{#5}{=}\@@Ensyuu@tmp
  \ifnum\@@Ensyuu@tmp>\z@
    \setkeys{emP}{#5}%
  \else
    \edef\@hankei{#5}%
  \fi
  \def\@resen{}%
  \For\@t{0}\Pii@{#3}\Do{\Cos\@t\@x\Mul\@x{\@hankei}\@x%
    \Sin\@t\@y\Mul\@y{\@hankei}\@y
    \Addvec{\@tyuusin}{(\@x,\@y)}\@P
    \edefappend\@resen{\@P}}%
  \Cos0\@x\Mul\@x{\@hankei}\@x\Sin0\@y\Mul\@y{\@hankei}\@y%
  \Addvec{\@tyuusin}{(\@x,\@y)}\@P
  \edefappend\@resen{\@P}%
%  \Hatchpolygon[#1]<#2>\@resen
  \ifx\empty #2
    \Strchr{#1}{=}\@@Ensyuu@tmp
    \ifnum\@@Ensyuu@tmp>\z@
      \emPaint*<slashangle=#1>\@resen
    \else
      \Hatchpolygon[#1]<#2>\@resen
    \fi
  \else
    \Strchr{#2}{=}\@@Ensyuu@tmp
    \ifnum\@@Ensyuu@tmp>\z@
      \emPaint*<slashangle=#1,#2>\@resen
    \else
      \Hatchpolygon[#1]<#2>\@resen
    \fi
  \fi
}%
%
\def\Enn{\@ifnextchar({\@Enn}{\@Enn(.05)}}%
\def\@Enn(#1){\@ifnextchar({\@@Enn(#1)}{\@@Enn(#1)(\empty)}}%
\def\@@Enn(#1)(#2)#3#4{\vecXY{#3}\Enn@cx\Enn@cy
    \def\Enn@x##1##2{\Cos{##1}\en@x\Mul{#4}\en@x\en@x\Add\en@x\Enn@cx##2}%
    \def\Enn@y##1##2{\Sin{##1}\en@y\Mul{#4}\en@y\en@y\Add\en@y\Enn@cy##2}%
  \put(0,0){\bGurafu(#1)(#2)\Enn@x\Enn@y{0}{\Pii@}}}%
%
% 直径の両端を与えて円
%
\def\EnT{\@ifnextchar<{\@EnT}{\@EnT<\empty>}}%
\def\@EnT<#1>#2#3{%
  \Tyuuten{#2}{#3}\EnT@O
  \Kyori{#2}\EnT@O\EnT@r
  \ifx\empty #1\relax
    \En\EnT@O\EnT@r
  \else
    \En<#1>\EnT@O\EnT@r
  \fi
}%
%
% 線分とそれを見込む角で円を指定
%
\def\EnK#1#2#3#4#5#6{%
% #1:点1
% #2:点2
% #3:線分#1#2を見込む角
% #4:円の半径
% #5,#6: 円の中心
  \Kyori{#1}{#2}\EnK@AB
  \fpcalcval{\EnK@AB/(2*Degsin(#3))}#4\relax% 正弦定理から円の半径
  \Tyuuten{#1}{#2}\EnK@M% 線分の中点を中心とした±90度の回転
  \fpcalcval{(#4)*Degcos(#3)}\EnK@h
  \Kaiten[\EnK@h]\EnK@M{#1}{90}#5\relax
  \Kaiten[\EnK@h]\EnK@M{#1}{-90}#6\relax
}%
%
% 円弧
%\Enko<#1>#2#3[#4]#5[#6]#7
%  #1 : オプション
%         hasen=xx で円弧を破線で描画するときの
%                  [破線の長さ][破線の間隔]
%                オプションを与える。
%         ten=xx で円弧を点線で描画するときの点の個数
%         yazirusi=a : 正方向に矢印をつける
%                 =r : 負方向に矢印をつける
%                 =b : 両方向に矢印をつける
%                 =n : 矢印をつけない
%         arrowheadsize=..
%
%  #2 : 中心
%  #3 : 半径を直接与えるか
%         tuukaten=xx として，円弧の周上の一点を与える
%  #5 : 始め角を直接与えるか
%        hazimeten=xx として，中心を始点，xx を終点とするベクトルの
%         方向角を 始め角とするように指定する。
%         この場合始め角を[#4]に戻すことも可能
%  #7 : 終り角を直接与えるか
%         owariten=xx として，中心を始点，xx を終点とするベクトルの
%         方向角を 終り角とするように指定する。
%         この場合始め角を[#6]に戻すことも可能
%
\def\Enko{\@ifnextchar<{\Enk@}{\Enk@<\empty>}}%
\def\Enk@<#1>#2#3{\@ifnextchar[{\Enk@@<#1>{#2}{#3}}{%
  \Enk@@<#1>{#2}{#3}[\empty]}}%
\def\Enk@@<#1>#2#3[#4]#5{%
  \@ifnextchar[{\Enk@@@<#1>{#2}{#3}[#4]{#5}}{%
  \Enk@@@<#1>{#2}{#3}[#4]{#5}[\empty]}}%
\def\Enk@@@<#1>#2#3[#4]#5[#6]#7{\begingroup
  \edef\ten@kosuu{}%
  \edef\hasen@opt{\empty}%
  \edef\hazime@kaku{#5}%
  \edef\yazirusi@opt{}%
% \edef\iro@{\empty}%
  \edef\owari@kaku{#7}%
  \edef\@tyuusin{#2}%
  \edef\@hankei{#3}%
  \edef\hamidasi@kaku{0}%
  \def\arrow@headsize{1}%
  \edef\hasenLG@opt{\empty}%
  \edef\YG@owariT{\empty}%
  \edef\YG@hazimeT{\empty}%
  \edef\YG@hazimeM{\empty}%
  \edef\YG@owariM{\empty}%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
  \Strchr{#3}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#3}\fi
  \Strchr{#5}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#5}\fi
  \Strchr{#7}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#7}\fi
  \ifdim\@hankei\p@=\z@\else
%    \Subself\hazime@kaku\hamidasi@kaku
%    \Addself\owari@kaku\hamidasi@kaku
    \strsep{\hamidasi@kaku}{,}\hk@a\hk@b
    \ifx\empty\hk@b\edef\hk@b{\hk@a}\fi
    \Subself\hazime@kaku\hk@a
    \Addself\owari@kaku\hk@b
    \Rdef[\@tyuusin](\@hankei,\hazime@kaku)\hazimeT
    \Rdef[\@tyuusin](\@hankei,\owari@kaku)\owariT
    \ifx\empty#4\else\xdef#4{\hazime@kaku}\fi
    \ifx\empty#6\else\xdef#6{\owari@kaku}\fi
    \ifthenelse{\equal\ten@kosuu\empty}{%
      \ifthenelse{\equal\yazirusi@opt\empty}{%
        \edef\yazirusi@opt{n}%
      }{%
        \changeArrowHeadSize{\arrow@headsize}%
      }%
      \ifx\hasen@opt\empty
        \emathPut\@tyuusin{%
          \ifx\empty\iro@\else\@iro{\iro@}\fi
          \yenko[\yazirusi@opt]\@hankei\hazime@kaku\owari@kaku
        }%
      \else
        \edef\hazime@kaku@{\hazime@kaku}%
        \edef\owari@kaku@{\owari@kaku}%
        \ifthenelse{\lengthtest{\Arr@wHeadSize\p@=\z@}}{}{%
          \@tempdima=\Arr@wHeadSize\unitlength\advance\@tempdima-\p@
          \ukansan{\@tempdima}\yenko@tmp
          \Sub{1}{\ArrowHeadPit}\yenko@@tmp
          \Mulself\yenko@tmp\yenko@@tmp
          \@Div\yenko@tmp\@hankei\yenko@tmp
          \RadDeg\yenko@tmp\yenko@da
          \ifthenelse{\equal{\yazirusi@opt}{a} \or \equal{\yazirusi@opt}{b}}{%
            \Sub\owari@kaku{\yenko@da}\owari@kaku@
          }{}%
          \ifthenelse{\equal{\yazirusi@opt}{b} \or \equal{\yazirusi@opt}{r}}{%
            \Add\hazime@kaku{\yenko@da}\hazime@kaku@
          }{}%
        }%
        \emathPut\@tyuusin{%
          \ifx\empty\iro@\else\@iro{\iro@}\fi
          \Yenko[\yazirusi@opt]\@hankei\hazime@kaku\owari@kaku%
          \ifx\empty\hasenLG@opt
            \expandafter\Daenko\hasen@opt
              \@hankei\@hankei\hazime@kaku@\owari@kaku@
          \else
            \expandafter\hasen@Enko\hasen@opt\@hankei\hazime@kaku@\owari@kaku@%
          \fi
        }%
      \fi
    }{%
      \ISub\ten@kosuu{1}\ten@kosuui
      \Sub\owari@kaku\hazime@kaku\kaku@kankaku
      \@Div\kaku@kankaku\ten@kosuui\kaku@kankaku
      \edef\@kaku{\hazime@kaku}%
      \emathPut\@tyuusin{%
        \ifx\empty\iro@\else\@iro{\iro@}\fi
        \Ifor\@kizami{0}{\ten@kosuui}\Do{%
          \Rdef(\@hankei,\@kaku)\@Ten
          \emathPut\@Ten{{\unitlength\p@\circle*{1}}}%
          \Add\@kaku\kaku@kankaku\@kaku
        }%
        \Rdef(\@hankei,\owari@kaku)\@Ten
        \emathPut\@Ten{{\unitlength\p@\circle*{1}}}%
      }%
    }%
  \fi
  \ifx\empty\YG@hazimeM\else
    \EMedef\Enk@tmp{{\hazimeT}\YG@hazimeM}%
    \expandafter\emathPut\Enk@tmp
  \fi
  \ifx\empty\YG@owariM\else
    \EMedef\Enk@tmp{{\owariT}\YG@owariM}%
    \expandafter\emathPut\Enk@tmp
  \fi
  \edef\temp@x{\def\noexpand\hazimeT{\hazimeT}%
               \def\noexpand\owariT{\owariT}%
               \def\noexpand\YG@hazimeT{\YG@hazimeT}%
               \def\noexpand\YG@owariT{\YG@owariT}}%
  \expandafter\endgroup\temp@x
  \ifx\empty\YG@hazimeT\else
    \expandafter\edef\csname\YG@hazimeT\endcsname{\hazimeT}\fi
  \ifx\empty\YG@owariT\else
    \expandafter\edef\csname\YG@owariT\endcsname{\owariT}\fi
\ignorespaces}%
%
\def\hasen@Enko[#1][#2]#3#4#5{%
  \edef\hasen@@L{#1}%
  \edef\hasen@@G{#2}%
  \Add\hasen@@L\hasen@@G\hasen@@LG
  \DegRad{#4}\hE@argS
  \DegRad{#5}\hE@argE
  \Sub\hE@argE\hE@argS\hE@arg@
  \Mul{#3}\hE@arg@\hasen@LL
  \@Div\hasen@LL\hasen@@LG\hasen@tmp
  \Seisuububun\hasen@tmp\hasen@n
  \ifthenelse{\equal{#4}{0}\and\equal{#5}{360}}{%
    \edef\hasen@tmp{\hasen@LL}%
  }{%
    \Sub\hasen@LL\hasen@@L\hasen@tmp
  }%
  \ifnum\hasen@n>\z@
    \@Div\hasen@tmp\hasen@n\hasen@tmp
    \Sub\hasen@tmp\hasen@@L\hasen@@G
    \Add\hasen@@L\hasen@@G\hasen@@LG
    \@Div\hasen@@L{#3}\hE@argL\RadDeg\hE@argL\hE@argL
    \@Div\hasen@@G{#3}\hE@argG\RadDeg\hE@argG\hE@argG
    \@Div\hasen@@LG{#3}\hE@argLG\RadDeg\hE@argLG\hE@argLG
  \fi
  \Cfor{\edef\hasen@i{0}\edef\hE@arg@S{#4}}{\hasen@i<\hasen@n}{}\do{%
    \Add\hE@arg@S\hE@argL\hE@arg@E
    \Enko\O@@{#3}\hE@arg@S\hE@arg@E
    \Addself\hE@arg@S\hE@argLG
    \Incr\hasen@i
  }%
  \ifthenelse{\equal{#4}{0}\and\equal{#5}{360}}{}{%
    \Enko\O@@{#3}\hE@arg@S{#5}%
  }%
}%
%
% \EMenko#1#2#3
%   #1 : 半径
%   #2 : 始め角
%   #3 : 終り角
%   （中心は \put (\emathPut) で指定する．）
%
\def\enkobyspecial{1}%
\def\EMenko#1#2#3{%
\ifnum\enkobyspecial>\z@
    \Mul{2}{#1}{\@tyokkei}%
    \Sub{#3}{#2}{\@tyuusinkaku}%
    \Sub{360}{#3}\@hazimekaku%
    \Add{\@hazimekaku}{\@tyuusinkaku}{\@owarikaku}%
    \DegRad{\@hazimekaku}{\@hazimekaku}%
    \DegRad{\@owarikaku}{\@owarikaku}%
    \put(0,0){\tpic@arc{\@tyokkei}{\@hazimekaku}{\@owarikaku}}%
\else
    \edef\@hazimekaku{#2}%
    \edef\@owarikaku{#3}%
    \DegRad{\@hazimekaku}{\@hazimekaku}%
    \DegRad{\@owarikaku}{\@owarikaku}%
    \def\enko@Xt{{#1}*cos(T)}%
    \def\enko@Yt{{#1}*sin(T)}%
    \bgroup
      \let\clipDrawline\Drawline
      \ParamC<mint=\@hazimekaku,maxt=\@owarikaku>\enko@Xt\enko@Yt
    \egroup
\fi
}%
\let\enko\EMenko
%
% 折れ線近似による円弧
%   #1 : 半径
%   #2 : 始め角
%   #3 : 終り角（終り角＞始め角）でなければならない．）
%   （中心は \put (\emathPut) で指定する．）
%
\def\enkoo#1#2#3{\DegRad{#2}\kaku@s\DegRad{#3}\kaku@e\def\@resen{}%
  \For\@t\kaku@s\kaku@e{0.025}\Do{\Cos\@t\@x\Mul\@x{#1}\@x%
    \Sin\@t\@y\Mul\@y{#1}\@y\edef\@resen{\@resen(\@x,\@y)}}%
  \Cos\kaku@e\@x\Mul\@x{#1}\@x\Sin\kaku@e\@y\Mul\@y{#1}\@y%
  \edef\@resen{\@resen(\@x,\@y)}\Drawline\@resen}%
%
% 矢線付き円弧（偏角指定）
%   \yenko[#1]#2#3#4
%   \yenko*[#1]#2#3#4 : 鏃のみ描画
%   #1 : 矢印を逆につけるには [r] とする．[b]で両向き. [n]で矢印なし.
%   #2 : 半径
%   #3 : 始め角
%   #4 : 終り角（終り角＞始め角）でなければならない．）
%   （中心は \put (\emathPut) で指定する．）
%
\def\yenko{\@ifstar{\def\yenko@byouga{0}\@yenko}{\def\yenko@byouga{1}\@yenko}}%
\def\@yenko{\@ifnextchar[{\@@yenko}{\@@yenko[a]}}%
\def\@@yenko[#1]#2#3#4{{%
%
  \@ifundefined{xunitlength}{}{%
    \kansan{\xmin\xunitlength}{\unitlength}\xmin
    \kansan{\ymin\yunitlength}{\unitlength}\ymin
    \xunitlength=\unitlength
    \yunitlength=\unitlength
    \def\@xscale{1}%
    \def\@yscale{1}%
  }%
%
  \ifthenelse{\equal{#1}{n} \or \equal{#1}{\empty}}{%
    \edef\d@theta{0}%
  }{%
    \@Div\Arr@wHeadSize{#2}\d@theta
  }%
  \RadDeg\d@theta\d@theta\@Div\d@theta{2}\d@theta
  \Add\ArrowHeadAxis\d@theta\@ArrowHeadAxis
  \Sub{\@ArrowHeadAxis}\ArrowHeadAngle\yenko@kakui
  \Add{\@ArrowHeadAxis}\ArrowHeadAngle\yenko@kakuii
  \ifthenelse{\equal{#1}{a} \or \equal{#1}{b} \or \equal{#1}{\empty}}{%
    \Rdef(#2,#4)\yenko@P%
    \Rotvec[\Arr@wHeadSize]\yenko@P{-\yenko@kakui}\yenko@PQ
      \Addvec\yenko@P\yenko@PQ\yenko@Q%
    \Rotvec[\Arr@wHeadSize]\yenko@P{-\yenko@kakuii}\yenko@PR
      \Addvec\yenko@P\yenko@PR\yenko@R
    \Tyuuten\yenko@Q\yenko@R\@M\Subvec\yenko@P\@M\@MP
    \Yaziri\yenko@P\@MP
  }{}%
  \ifthenelse{\equal{#1}{b} \or \equal{#1}{r}}{%
    \Rdef(#2,#3)\yenko@P%
    \Rotvec[\Arr@wHeadSize]\yenko@P{\yenko@kakui}\yenko@PQ
      \Addvec\yenko@P\yenko@PQ\yenko@Q%
    \Rotvec[\Arr@wHeadSize]\yenko@P{\yenko@kakuii}\yenko@PR
      \Addvec\yenko@P\yenko@PR\yenko@R
    \Tyuuten\yenko@Q\yenko@R\@M\Subvec\yenko@P\@M\@MP
    \Yaziri\yenko@P\@MP
  }{}%
  \edef\yenko@yazirusi{#1}%
  \edef\yazirusi@opt{\empty}% BBS #10703
  \ifnum\yenko@byouga>\z@
    \edef\yenko@s{#3}\edef\yenko@e{#4}%
    \ifthenelse{\equal{\yenko@yazirusi}{n} \or \equal{\yenko@yazirusi}{\empty}}{}{%
      \ifthenelse{\lengthtest{\Arr@wHeadSize\p@=\z@}}{}{%
        \@tempdima=\Arr@wHeadSize\unitlength\advance\@tempdima-\p@
        \ukansan{\@tempdima}\yenko@tmp
        \Sub{1}{\ArrowHeadPit}\yenko@@tmp
        \Mulself\yenko@tmp\yenko@@tmp
        \@Div\yenko@tmp{#2}\yenko@tmp
        \RadDeg\yenko@tmp\yenko@da
        \if f\ArrowHeadType\else\edef\yenko@da{0}\fi
        \ifthenelse{\equal{\yenko@yazirusi}{a} \or \equal{\yenko@yazirusi}{b} \or \equal{\yenko@yazirusi}{\empty}}{%
        \Sub{#4}{\yenko@da}\yenko@e
        \ifdim\yenko@e\p@<#3\p@\edef\yenko@e{#3}\fi
        }{}%
        \ifthenelse{\equal{\yenko@yazirusi}{b} \or \equal{\yenko@yazirusi}{r}}{%
          \Add{#3}{\yenko@da}\yenko@s
          \ifdim\yenko@s\p@>#4\p@\edef\yenkos{#4}\fi
        }{}%
      }%
    }%
    \EMenko{#2}{\yenko@s}{\yenko@e}%
  \fi
}}%
%
% \Yenko 鏃のみ
% \Yenko(#1)[#2]#3#4#5
%   #1 : 鏃を置く位置(0〜1)
%   #2 : 鏃の方向 (a/r/b)
%   #3 : 円弧の中心
%   #4 : はじめ角
%   #5 : おわり角
%
\edef\yaziri@iti{\empty}%
\def\yaziriiti#1{\edef\yaziri@iti{#1}}%
\def\Yenko{\@ifnextchar({\@Yenko}{\@Yenko(\yaziri@iti)}}%
\def\@Yenko(#1){\@ifnextchar[{\@@Yenko(#1)}{\@@Yenko(#1)[a]}}%
\def\@@Yenko(#1)[#2]#3#4#5{{%
  \ifthenelse{\lengthtest{\arrow@headsize\p@>\z@}}{%
%
%    \kansan{\xmin\xunitlength}{\unitlength}\xmin
%    \kansan{\ymin\yunitlength}{\unitlength}\ymin
%    \xunitlength=\unitlength
%    \yunitlength=\unitlength
%    \def\@xscale{1}%
%    \def\@yscale{1}%
%
    \@Div\Arr@wHeadSize{#3}\d@theta
    \RadDeg\d@theta\d@theta\@Div\d@theta{2}\d@theta
    \Add\ArrowHeadAxis\d@theta\@ArrowHeadAxis
    \Sub{\@ArrowHeadAxis}\ArrowHeadAngle\Yenko@kakui
    \Add{\@ArrowHeadAxis}\ArrowHeadAngle\Yenko@kakuii
    \bgroup
      \@ifundefined{xunitlength}{}{\xunitlength=\unitlength}%
      \@ifundefined{yunitlength}{}{\yunitlength=\unitlength}%
      \ifthenelse{\equal{#2}{a} \or \equal{#2}{b} \or \equal{#2}{\empty}}{%
        \ifthenelse{\equal{#1}{\empty}}{%
          \Rdef(#3,#5)\Yenko@P\Add{#5}{90}\@tmp\Rdef(#3,\@tmp)\@m@\Yaziri\Yenko@P\@m@
        }{%
          \Sub{1}{#1}\Yenko@t
          \Mul\Yenko@t{#4}\Yenko@u
          \Mul{#1}{#5}\Yenko@v
          \Addself\Yenko@u\Yenko@v
          \Rdef(#3,\Yenko@u)\Yenko@P\Add{\Yenko@u}{90}\@tmp\Rdef(#3,\@tmp)\@m@\Yaziri\Yenko@P\@m@
        }%
      }{}%
      \ifthenelse{\equal{#2}{b} \or \equal{#2}{r}}{%
        \ifthenelse{\equal{#1}{\empty}}{%
          \Rdef(#3,#4)\Yenko@P\Add{#4}{-90}\@tmp\Rdef(#3,\@tmp)\@m@\Yaziri\Yenko@P\@m@%
        }{%
          \Sub{1}{#1}\Yenko@t
          \Mul\Yenko@t{#5}\Yenko@u
          \Mul{#1}{#4}\Yenko@v
          \Addself\Yenko@u\Yenko@v
          \Rdef(#3,\Yenko@u)\Yenko@P\Add{\Yenko@u}{-90}\@tmp\Rdef(#3,\@tmp)\@m@\Yaziri\Yenko@P\@m@
        }%
      }{}%
    \egroup
  }{}%
}}%
%
% 矢線付き円弧（両端の点指定）
%   \ArrowArc<#1>[#2]#3#4#5
%   #1 : \Enko に渡すオプション
%   #2 : [r]を付けると負の回転となるように矢印をつける．
%   #3 : 半径 (<0 のときは，[r]をつけたものとみなす。）
%   #4 : 始点
%   #5 : 終点
%
\def\ArrowArc{\@ifnextchar<{\@ArrowArc}{\@ArrowArc<\empty>}}%
\def\@ArrowArc<#1>{\@ifnextchar[{\@@ArrowArc<#1>}{\@@ArrowArc<#1>[a]}}%
\def\@@ArrowArc<#1>[#2]#3#4#5{%
  \edef\hen@i{\empty}%
  \edef\hen@ii{\empty}%
  \edef\ArrowArc@orient{#2}%
  \ifthenelse{\equal{#2}{r}}{\edef\ArrowArc@orient{r}}{}%
  \ifdim #3 pt<\z@\Mul{#3}{-1}\ArrowArc@radius\edef\ArrowArc@orient{r}\else
  \edef\ArrowArc@radius{#3}\fi
  \vecXY{#4}\ArrowArc@x\ArrowArc@y
  \vecXY{#5}\ArrowArc@xx\ArrowArc@yy
\begingroup
\ifx\empty #1\else\setkeys{emP}{#1}\fi
  \@ifundefined{xunitlength}{}{%
  \@ifundefined{xmin}{}{%
    \Mul\@xscale\ArrowArc@x\ArrowArc@x
    \Mul\@yscale\ArrowArc@y\ArrowArc@y
    \Mul\@xscale\ArrowArc@xx\ArrowArc@xx
    \Mul\@yscale\ArrowArc@yy\ArrowArc@yy
    \Mul\@xscale\xmin\xmin
    \Mul\@yscale\ymin\ymin
    \edef\@xscale{1}%
    \edef\@yscale{1}%
    \xunitlength\unitlength
    \yunitlength\unitlength
  }}%
  \edef\ArrowArc@P{(\ArrowArc@x,\ArrowArc@y)}%
  \edef\ArrowArc@Q{(\ArrowArc@xx,\ArrowArc@yy)}%
  \ifx\empty\hen@i\else\Addvec*\ArrowArc@P{\hen@i}\ArrowArc@P\fi
  \ifx\empty\hen@ii\else\Addvec*\ArrowArc@Q{\hen@ii}\ArrowArc@Q\fi
  \@Bunten{\ArrowArc@P}{\ArrowArc@Q}11\B@M\Kyorii\B@M{\ArrowArc@P}\@ll%
  \Mul{\ArrowArc@radius}{\ArrowArc@radius}\@h\Sub\@h\@ll\@h
  \Heihoukon\@h\@h\Subvec\B@M{\ArrowArc@P}\@AM%
  \ifthenelse{\equal{\ArrowArc@orient}{a}}{%
    \Rotvec[\@h]\@AM{\ArrowHeadAxis}\@MC
    \Addvec\B@M\@MC\@C%
    \Subvec{\ArrowArc@P}\@C\@CA\Subvec{\ArrowArc@Q}\@C\@CB%
    \Argvec\@CA\kaku@s\Argvec\@CB\kaku@e
  }{%
    \ifthenelse{\equal{\ArrowArc@orient}{r}}{%
      \Rotvec[\@h]\@AM{-\ArrowHeadAxis}\@MC\Addvec\B@M\@MC\@C%
      \Subvec{\ArrowArc@P}\@C\@CA\Subvec{\ArrowArc@Q}\@C\@CB%
      \Argvec\@CA\kaku@e\Argvec\@CB\kaku@s
    }{}%
  }%
  \ifdim\kaku@e pt<\kaku@s pt\relax\Add{360}\kaku@e\kaku@e\fi%
  \ifx\empty#1\relax
    \Enko<yazirusi=\ArrowArc@orient>\@C\ArrowArc@radius\kaku@s\kaku@e
  \else
    \Enko<yazirusi=\ArrowArc@orient,#1>\@C\ArrowArc@radius\kaku@s\kaku@e
  \fi
  \edef\temp@x{\def\noexpand\ArrowArcC{\@C}}%
  \expandafter\endgroup\temp@x
}%
%
% 扇形
% ougigata[#1]#2#3#4
%   #1 : 塗りつぶしの濃さ （デフォルトは 0.5 ）
%   #2 : 半径を直接与えるか
%        tuukaten=xx として，円弧の周上の一点を与える
%   #3 : 始め角を直接与えるか
%         hazimeten=xx として，中心を始点，xx を終点とするベクトルの
%         方向角を 始め角とするように指定する。
%   #4 : 終り角を直接与えるか
%         owariten=xx として，中心を始点，xx を終点とするベクトルの
%         方向角を 終り角とするように指定する。
%   （中心は \put (\emathPut) で指定する．）
%
\newif\if@nuri
\def\ougigata{\@ifstar{\ougigata@}{\@nurifalse\@ougigata}}%
\def\ougigata@{\@ifstar{\hatch@ougigata}{%
  \@nuritrue\@ougigata}}%
\def\@ougigata{\@ifnextchar[{\@@ougigata}{\@@ougigata[0.5]}}%
\def\@@ougigata[#1]{\@ifnextchar<{\@@@ougigata[#1]}{\@@@ougigata[#1]<\empty>}}%
\def\@@@ougigata[#1]<#2>#3#4#5{%
  \edef\hazime@kaku{#4}%
  \edef\owari@kaku{#5}%
  \edef\@tyuusin{\local@origin}%
  \edef\@hankei{#3}%
  \Strchr{#3}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#3}\fi
  \Strchr{#4}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#4}\fi
  \Strchr{#5}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#5}\fi
\if@nuri\edef\@resen{(0,0)}%
  \For\@kaku{\hazime@kaku}{\owari@kaku}{5}\Do{\Rdef(\@hankei,\@kaku)\@P%
  \edef\@resen{\@resen\@P}}\Rdef(\@hankei,\owari@kaku)\@P%
  \edef\@resen{\@resen\@P(0,0)}\Nuritubusi[#1]<#2>\@resen%
% \ifx #2b\ougigata{#3}{#4}{\ougigata@owarikaku}\fi%
\else\DegRad{\hazime@kaku}\@hazimekaku\Cos\@hazimekaku\@x\Mul\@x{\@hankei}\@x%
  \Sin\@hazimekaku\@y\Mul\@y{\@hankei}\@y\Drawline{(0,0)(\@x,\@y)}%
  \DegRad{\owari@kaku}\@owarikaku\Cos\@owarikaku\@@x\Mul\@@x{\@hankei}\@@x%
  \Sin\@owarikaku\@@y\Mul\@@y{\@hankei}\@@y\Drawline{(0,0)(\@@x,\@@y)}%
  \EMenko{\@hankei}{\hazime@kaku}{\owari@kaku}\fi}%
\def\hatch@ougigata{\@ifnextchar[{\@hatch@ougigata}{\@hatch@ougigata[45]}}%
\def\@hatch@ougigata[#1]{\@ifnextchar<{\@@hatch@ougigata[#1]}{%
  \@@hatch@ougigata[#1]<\empty>}}%
\def\@@hatch@ougigata[#1]<#2>#3#4#5{%
  \edef\hazime@kaku{#4}%
  \edef\owari@kaku{#5}%
  \edef\@tyuusin{\local@origin}%
  \edef\@hankei{#3}%
  \Strchr{#3}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#3}\fi
  \Strchr{#4}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#4}\fi
  \Strchr{#5}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#5}\fi
  \edef\@resen{(0,0)}%
  \For\@kaku{\hazime@kaku}{\owari@kaku}{5}\Do{\Rdef(\@hankei,\@kaku)\@P%
  \edef\@resen{\@resen\@P}}\Rdef(\@hankei,\owari@kaku)\@P%
  \edef\@resen{\@resen\@P(0,0)}\Hatchpolygon[#1]<#2>\@resen}%
%
% 弓形
% yumigata[#1]<#2>#3#4#5
%   #1 : 塗りつぶしの濃さ （デフォルトは 0.5 ）
%   #3 : 半径を直接与えるか
%        tuukaten=xx として，円弧の周上の一点を与える
%   #4 : 始め角を直接与えるか
%         hazimeten=xx として，中心を始点，xx を終点とするベクトルの
%         方向角を 始め角とするように指定する。
%   #5 : 終り角を直接与えるか
%         owariten=xx として，中心を始点，xx を終点とするベクトルの
%         方向角を 終り角とするように指定する。
%   （中心は \put (\emathPut) で指定する．）
%
\def\yumigata{\@ifstar{\yumigata@}{\@nurifalse\@yumigata}}%
\def\yumigata@{\@ifstar{\hatch@yumigata}{\@nuritrue\@yumigata}}%
\def\@yumigata{\@ifnextchar[{\@@yumigata}{\@@yumigata[0.5]}}%
\def\@@yumigata[#1]{\@ifnextchar<{\@@@yumigata[#1]}{%
  \@@@yumigata[#1]<\empty>}}%
\def\@@@yumigata[#1]<#2>#3#4#5{%
  \edef\hazime@kaku{#4}%
  \edef\owari@kaku{#5}%
  \edef\@tyuusin{\local@origin}%
  \edef\@hankei{#3}%
  \Strchr{#3}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#3}\fi
  \Strchr{#4}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#4}\fi
  \Strchr{#5}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#5}\fi
\if@nuri\edef\@resen{}%
  \For\@kaku{\hazime@kaku}{\owari@kaku}{5}\Do{%
  \Rdef(\@hankei,\@kaku)\@P\edef\@resen{\@resen\@P}}\Rdef(\@hankei,\owari@kaku)\@P
  \edef\@resen{\@resen\@P}\Rdef(\@hankei,\hazime@kaku)\@P
  \edef\@resen{\@resen\@P}\Nuritubusi[#1]<#2>\@resen
\else\DegRad{\hazime@kaku}\@hazimekaku\Cos\@hazimekaku\@x\Mul\@x{\@hankei}\@x%
  \Sin\@hazimekaku\@y\Mul\@y{\@hankei}\@y%
  \DegRad{\owari@kaku}\@owarikaku\Cos\@owarikaku\@@x\Mul\@@x{\@hankei}\@@x%
  \Sin\@owarikaku\@@y\Mul\@@y{\@hankei}\@@y\drawline(\@x,\@y)(\@@x,\@@y)%
  \EMenko{\@hankei}{\hazime@kaku}{\owari@kaku}\fi}%
\def\hatch@yumigata{\@ifnextchar[{\@hatch@yumigata}{%
  \@hatch@yumigata[45]}}%
\def\@hatch@yumigata[#1]{\@ifnextchar<{\@@hatch@yumigata[#1]}{%
  \@@hatch@yumigata[#1]<\empty>}}%
\def\@@hatch@yumigata[#1]<#2>#3#4#5{%
  \edef\hazime@kaku{#4}%
  \edef\owari@kaku{#5}%
  \edef\@tyuusin{\local@origin}%
  \edef\@hankei{#3}%
  \Strchr{#3}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#3}\fi
  \Strchr{#4}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#4}\fi
  \Strchr{#5}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#5}\fi
  \edef\@resen{}%
  \For\@kaku\hazime@kaku\owari@kaku{5}\Do{%
  \Rdef(\@hankei,\@kaku)\@P\edef\@resen{\@resen\@P}%
  }%
  \Rdef(\@hankei,\owari@kaku)\@P
  \edef\@resen{\@resen\@P}\Rdef(\@hankei,\hazime@kaku)\@P
  \edef\@resen{\@resen\@P}%
  \Hatchpolygon[#1]<#2>\@resen}%
%
  \def\Ougigata{\@ifstar{\Ougigata@}{\@Ougigata}}%
  \def\Ougigata@{\@ifstar{\Ougigata@@}{\@Ougigata@}}%
%
  \def\@Ougigata{% 周のみ
    \@ifnextchar<{\@@Ougigata}{\@@Ougigata<\empty>}%
  }%
  \def\@@Ougigata<#1>#2#3#4#5{%
    \edef\hazime@kaku{#4}%
      \edef\owari@kaku{#5}%
      \def\nuri@iro{\nuri@iro@}%
      \edef\draw@border{\empty}%
      \Strchr{#1}{=}\Enk@tmp
      \ifnum\Enk@tmp>\z@\setkeys{emP}{#1}\fi
      \edef\@tyuusin{#2}%
      \edef\@hankei{#3}%
      \Strchr{#3}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#3}\fi
      \Strchr{#4}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#4}\fi
      \Strchr{#5}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#5}\fi
%    \typeout{\@tyuusin\@hankei\hazime@kaku\owari@kaku}
    \KinziEnko\@tyuusin\@hankei\hazime@kaku\owari@kaku\oresen@i
    \Takakkei<#1>{\oresen@i\@tyuusin}%
  }%
%
  \def\@Ougigata@{% べた塗り
    \@ifnextchar<{\@@Ougigata@}{\@@Ougigata@<\empty>}%
  }%
  \def\@@Ougigata@<#1>#2#3#4#5{%
    \edef\hazime@kaku{#4}%
      \edef\owari@kaku{#5}%
      \def\nuri@iro{\nuri@iro@}%
      \edef\draw@border{\empty}%
      \Strchr{#1}{=}\Enk@tmp
      \ifnum\Enk@tmp>\z@\setkeys{emP}{#1}\fi
      \edef\@tyuusin{#2}%
      \edef\@hankei{#3}%
      \Strchr{#3}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#3}\fi
      \Strchr{#4}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#4}\fi
      \Strchr{#5}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#5}\fi
%    \typeout{\@tyuusin\@hankei\hazime@kaku\owari@kaku}
    \KinziEnko\@tyuusin\@hankei\hazime@kaku\owari@kaku\oresen@i
    \emPaint<#1>{\oresen@i\@tyuusin}%
  }%
%
  \def\Ougigata@@{% 斜線塗り
    \@ifnextchar<{\@Ougigata@@}{\@Ougigata@@<\empty>}%
  }%
  \def\@Ougigata@@<#1>#2#3#4#5{%
    \edef\hazime@kaku{#4}%
      \edef\owari@kaku{#5}%
      \def\nuri@iro{\nuri@iro@}%
      \edef\draw@border{\empty}%
      \Strchr{#1}{=}\Enk@tmp
      \ifnum\Enk@tmp>\z@\setkeys{emP}{#1}\fi
      \edef\@tyuusin{#2}%
      \edef\@hankei{#3}%
      \Strchr{#3}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#3}\fi
      \Strchr{#4}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#4}\fi
      \Strchr{#5}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#5}\fi
%    \typeout{\@tyuusin\@hankei\hazime@kaku\owari@kaku}
    \KinziEnko\@tyuusin\@hankei\hazime@kaku\owari@kaku\oresen@i
    \emPaint*<#1>{\oresen@i\@tyuusin}%
  }%
%
  \def\Yumigata{\@ifstar{\Yumigata@}{\@Yumigata}}%
  \def\Yumigata@{\@ifstar{\Yumigata@@}{\@Yumigata@}}%
%
  \def\@Yumigata{% 周のみ
    \@ifnextchar<{\@@Yumigata}{\@@Yumigata<\empty>}%
  }%
  \def\@@Yumigata<#1>#2#3#4#5{%
    \edef\hazime@kaku{#4}%
      \edef\owari@kaku{#5}%
      \def\nuri@iro{\nuri@iro@}%
      \edef\draw@border{\empty}%
      \Strchr{#1}{=}\Enk@tmp
      \ifnum\Enk@tmp>\z@\setkeys{emP}{#1}\fi
      \edef\@tyuusin{#2}%
      \edef\@hankei{#3}%
      \Strchr{#3}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#3}\fi
      \Strchr{#4}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#4}\fi
      \Strchr{#5}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#5}\fi
%    \typeout{\@tyuusin\@hankei\hazime@kaku\owari@kaku}
    \KinziEnko\@tyuusin\@hankei\hazime@kaku\owari@kaku\oresen@i
    \Takakkei<#1>{\oresen@i}%
  }%
%
  \def\@Yumigata@{% べた塗り
    \@ifnextchar<{\@@Yumigata@}{\@@Yumigata@<\empty>}%
  }%
  \def\@@Yumigata@<#1>#2#3#4#5{%
    \edef\hazime@kaku{#4}%
      \edef\owari@kaku{#5}%
      \def\nuri@iro{\nuri@iro@}%
      \edef\draw@border{\empty}%
      \Strchr{#1}{=}\Enk@tmp
      \ifnum\Enk@tmp>\z@\setkeys{emP}{#1}\fi
      \edef\@tyuusin{#2}%
      \edef\@hankei{#3}%
      \Strchr{#3}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#3}\fi
      \Strchr{#4}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#4}\fi
      \Strchr{#5}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#5}\fi
%    \typeout{\@tyuusin\@hankei\hazime@kaku\owari@kaku}
    \KinziEnko\@tyuusin\@hankei\hazime@kaku\owari@kaku\oresen@i
    \emPaint<#1>{\oresen@i}%
  }%
%
  \def\Yumigata@@{% 斜線塗り
    \@ifnextchar<{\@Yumigata@@}{\@Yumigata@@<\empty>}%
  }%
  \def\@Yumigata@@<#1>#2#3#4#5{%
    \edef\hazime@kaku{#4}%
      \edef\owari@kaku{#5}%
      \def\nuri@iro{\nuri@iro@}%
      \edef\draw@border{\empty}%
      \Strchr{#1}{=}\Enk@tmp
      \ifnum\Enk@tmp>\z@\setkeys{emP}{#1}\fi
      \edef\@tyuusin{#2}%
      \edef\@hankei{#3}%
      \Strchr{#3}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#3}\fi
      \Strchr{#4}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#4}\fi
      \Strchr{#5}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#5}\fi
%    \typeout{\@tyuusin\@hankei\hazime@kaku\owari@kaku}
    \KinziEnko\@tyuusin\@hankei\hazime@kaku\owari@kaku\oresen@i
    \emPaint*<#1>{\oresen@i}%
  }%
%
% 矢線
%
\def\Phrightarrow{\mathrel{%
  \unitlength=1em
  \begin{picture}(1,0)\relax
    \@tempdima=0.04em\relax
    \linethickness{\the\@tempdima}%
    \edef\Phra@tmp{\strip@pt\@tempdima}
    \Divself\Phra@tmp{0.4}%
    \put(0,.24){\Drawline<arrowheadsize=\Phra@tmp,yazirusi=a>{(.05,0)(.95,0)}}%
  \end{picture}}}%
%
% \yasen[#1]<#2>(#3,#4)
% \Yasen[#1]<#2>#3
%   #1 : ラベルを置く位置（デフォルト=0.5, 中点）
%   #2 : ラベル（位置指定を含めて）
%   (#3,#4) : 終点（始点は \put で指定）
\newtoks\yasen@toks
\def\yasen{\@ifnextchar[{\@yasen}{\@yasen[.5]}}%
\def\@yasen[#1]{\@ifnextchar<{\@@yasen[#1]}{\@@yasen[#1]<\empty>}}%
\def\@@yasen[#1]<#2>(#3,#4){%
  \def\yasen@O{(0,0)}%
  \def\yasen@P{(#3,#4)}%
  \Mulvec{#1}\yasen@P\yasen@M
  \yasen@toks={\yasen@M#2}%
  \expandafter\emathPut\the\yasen@toks
  \ArrowLine\yasen@O\yasen@P
}%
\def\Yasen{\@ifnextchar[{\@Yasen}{\@Yasen[.5]}}%
\def\@Yasen[#1]{\@ifnextchar<{\@@Yasen[#1]}{\@@Yasen[#1]<\empty>}}%
\def\@@Yasen[#1]<#2>#3{\vecXY{#3}\Yasen@x\Yasen@y
  \yasen[#1]<#2>(\Yasen@x,\Yasen@y)}%
%
\def\arrowdrawline{%
  \@ifnextchar({\@arrowdrawline}{\relax}}%
\def\@arrowdrawline(#1,#2){\@ifnextchar({%
  \@@arrowdrawline(#1,#2)}{\relax}}%
\def\@@arrowdrawline(#1,#2)(#3,#4){%
  \ArrowLine{(#1,#2)}{(#3,#4)}\@arrowdrawline(#3,#4)%
}%
%
% \ArrowLine<#1>[#2]#3#4
%   #1 : key=val
%         sensyu=
%         putstr=      （矢線の傍に置く配置オプション+文字列）
%         putpos=      （文字列の配置基準位置：デフォルトは0.5, 中点）
%         arrowheadsize= 特に 0 を指定すると，矢印無し
%         allinethickness= 幹の太さ
%         henvi=        （始点をずらす変移ベクトル -- 単位つき）
%         henvii=       （終点をずらす変移ベクトル -- 単位つき）
%   #2 : 矢印を置く位置（デフォルト = 1 すなわち終点）
%        ただし #2=b のときは，両端に矢印
%   #3 : 始点
%   #4 : 終点
%
%\define@key{emP}{putstr}{\def\put@str{#1}}%
\define@key{emP}{putstr}{\EMedef\put@str{#1}}%
\define@key{emP}{putpos}{\def\put@pos{#1}}%
\define@key{emPs}{putstr}{\EMedef\put@str{#1}}%
\define@key{emPs}{putpos}{\def\put@pos{#1}}%
%
\edef\yazirusi@opt{\empty}%
\edef\put@kuromaru{0}%
\edef\put@tatebou{0}%
\edef\put@pstatebou{\empty}%
\def\yazirusiopt#1{\edef\yazirusi@opt{#1}}%
%
\def\ArrowLine{\@ifnextchar<{\@ArrowLine}{\@ArrowLine<\empty>}}%
\def\@ArrowLine<#1>{\@ifnextchar[{\@@ArrowLine<#1>}{\@@ArrowLine<#1>[1]}}%
\def\@@ArrowLine<#1>[#2]#3#4{{%
%  \def\sensyu{\drawline}%%%%%%%%%%%%%%%%%%%%%%% 2005/08/22
  \def\yaziri@@@M{(0,0)}%
  \edef\put@str{\empty}\def\put@pos{.5}%
  \def\arrow@headsize{1}%
  \edef\hen@i{\empty}%
  \edef\hen@ii{\empty}%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
%
  \ifx\empty\hen@i\def\ArrowLine@A{#3}\else\Addvec*{#3}{\hen@i}\ArrowLine@A\fi
  \ifx\empty\hen@ii\def\ArrowLine@B{#4}\else\Addvec*{#4}{\hen@ii}\ArrowLine@B\fi
%
  \Subvec{\ArrowLine@B}{\ArrowLine@A}\miki@v
  \Absvec\miki@v\miki@l
  \ifdim\miki@l\p@>0.01pt\relax
    \ifdim\@wholewidth=\z@\else
      \put(0,0){%
        \ifx\empty\iro@\else\@iro{\iro@}\fi
        \edef\v@arrow{\ArrowLine@A\ArrowLine@B}%
        \DegCos\ArrowHeadAngle\yaziri@c\Mul\Arr@wHeadSize\yaziri@c\yaziri@c
        \Mul{0.9}\yaziri@c\yaziri@@c
        \Absvec\miki@v\ArrowLine@l
        \Sub\ArrowLine@l\yaziri@@c\ArrowLine@ll
        \@Bunten\O@@\miki@v\ArrowLine@ll\yaziri@@c\ArrowLine@e
        \@Bunten\O@@\miki@v\yaziri@@c\ArrowLine@ll\ArrowLine@s
        \ifthenelse{\equal{#2}{b}}{%
          {%
            \changeArrowHeadSize{\arrow@headsize}%
            \emathPut{\ArrowLine@B}{\yaziri\miki@v}\Mulvec{-1}\miki@v\miki@v@
              \Addvec{\ArrowLine@B}\yaziri@@@M\ArrowLine@e
              \Hamidasiten\ArrowLine@B\ArrowLine@e{-1pt}\ArrowLine@e
            \emathPut{\ArrowLine@A}{\yaziri\miki@v@}%
              \Addvec{\ArrowLine@A}\yaziri@@@M\ArrowLine@s
              \Hamidasiten\ArrowLine@A\ArrowLine@s{-1pt}\ArrowLine@s
            \ifthenelse{\equal{\ArrowHeadType}{f}}{%
              \edef\miki@vv{\ArrowLine@s\ArrowLine@e}%
              \Put\O@@{\expandafter\sensyu\miki@vv}%
            }{%
              \edef\v@arrow{\ArrowLine@s\ArrowLine@e}%
              \expandafter\sensyu\v@arrow
            }%
          }%
        }{%
          \Mulvec{#2}\miki@v\miki@v@\Addvec{\ArrowLine@A}\miki@v@\yaziri@v
          {%
            \changeArrowHeadSize{\arrow@headsize}%
            \emathPut{\yaziri@v}{\yaziri\miki@v}%
            \ifthenelse{\equal{#2}{1}\and\equal{\ArrowHeadType}{f}}{%
              \Addvec{\ArrowLine@B}\yaziri@@@M\ArrowLine@e
              \Subvec\ArrowLine@e{\ArrowLine@A}\ArrowLine@e
              \ifdim\Arr@wHeadSize\p@=\z@\else
                \Absvec\ArrowLine@e\AL@tmp
                \@tempdima\AL@tmp\unitlength\advance\@tempdima\p@
                \ukansan\@tempdima\AL@@tmp
                \@Div\AL@@tmp\AL@tmp\AL@tmp
                \Mulvec\AL@tmp\ArrowLine@e\ArrowLine@e
              \fi
              \edef\miki@vv{(0,0)\ArrowLine@e}%
              \Put{\ArrowLine@A}{\expandafter\sensyu\miki@vv}%
            }{%
              \expandafter\sensyu\v@arrow%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
            }%
          }%
        }%
      }%
    \fi
    \ifx\empty\put@str\else
      \Mulvec\put@pos\miki@v\put@p
      \Addvec{\ArrowLine@A}\put@p\put@p
      \put(0,0){\expandafter\emathPut\expandafter\put@p\put@str}%
    \fi
  \fi
}}%
%
%\let\Phdrawline\drawline
\let\@Phdrawline\@drawline
\def\Phdrawline{\@ifnextchar [{\@iPhdrawline}{\@iPhdrawline[\drawlinestretch]}}%
\def\@iPhdrawline[#1](#2,#3){\@ifnextchar ({\@iiPhdrawline[#1](#2,#3)}{\relax}}%
\def\@iiPhdrawline[#1](#2,#3)(#4,#5){\@Phdrawline[#1](#2,#3)(#4,#5)
\@iPhdrawline[#1](#4,#5)}%
\def\PhArrowLine{\@ifnextchar<{\@PhArrowLine}{\@PhArrowLine<\empty>}}%
\def\@PhArrowLine<#1>{\@ifnextchar[{\@@PhArrowLine<#1>}{\@@PhArrowLine<#1>[1]}}%
%\let\@@PhArrowLine\@@ArrowLine
\def\@@PhArrowLine<#1>[#2]#3#4{{\thinlines
  \def\sensyu{\Phdrawline}%%%%%%%%%%%%%%%%%%%%%%% 2005/08/22
  \def\yaziri@@@M{(0,0)}%
  \edef\put@str{\empty}\def\put@pos{.5}%
  \def\arrow@headsize{1}%
  \edef\hen@i{\empty}%
  \edef\hen@ii{\empty}%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
%
  \ifx\empty\hen@i\def\ArrowLine@A{#3}\else\Addvec{#3}{\hen@i}\ArrowLine@A\fi
  \ifx\empty\hen@ii\def\ArrowLine@B{#4}\else\Addvec{#4}{\hen@ii}\ArrowLine@B\fi
%
  \Subvec{\ArrowLine@B}{\ArrowLine@A}\miki@v
\Absvec\miki@v\miki@l
\ifdim\miki@l\p@>0.01pt\relax
  \put(0,0){%
    \edef\v@arrow{\ArrowLine@A\ArrowLine@B}%
    \DegCos\ArrowHeadAngle\yaziri@c\Mul\Arr@wHeadSize\yaziri@c\yaziri@c
    \Mul{0.9}\yaziri@c\yaziri@@c
    \Absvec\miki@v\ArrowLine@l
    \Sub\ArrowLine@l\yaziri@@c\ArrowLine@ll
    \@Bunten\O@@\miki@v\ArrowLine@ll\yaziri@@c\ArrowLine@e
    \@Bunten\O@@\miki@v\yaziri@@c\ArrowLine@ll\ArrowLine@s
    \ifthenelse{\equal{#2}{b}}{%
      {%
        \changeArrowHeadSize{\arrow@headsize}%
        \emathPut{\ArrowLine@B}{\yaziri\miki@v}\Mulvec{-1}\miki@v\miki@v@
          \Addvec{\ArrowLine@B}\yaziri@@@M\ArrowLine@e
        \emathPut{\ArrowLine@A}{\yaziri\miki@v@}%
          \Addvec{\ArrowLine@A}\yaziri@@@M\ArrowLine@s
        \ifthenelse{\equal{\ArrowHeadType}{f}}{%
          \edef\miki@vv{\ArrowLine@s\ArrowLine@e}%
          \Put\O@@{\expandafter\sensyu\miki@vv}%
        }{%
          \edef\v@arrow{\ArrowLine@s\ArrowLine@e}%
          \expandafter\sensyu\v@arrow
        }%
      }%
    }{%
      \Mulvec{#2}\miki@v\miki@v@\Addvec{\ArrowLine@A}\miki@v@\yaziri@v
      {%
        \changeArrowHeadSize{\arrow@headsize}%
%        \emathPut{\ArrowLine@B}{\yaziri\miki@v}%
        \emathPut{\yaziri@v}{\Phyaziri\miki@v}%
        \ifthenelse{\equal{#2}{1}\and\equal{\ArrowHeadType}{f}}{%
          \Addvec{\ArrowLine@B}\yaziri@@@M\ArrowLine@e
          \Subvec\ArrowLine@e{\ArrowLine@A}\ArrowLine@e
          \edef\miki@vv{(0,0)\ArrowLine@e}%
          \Put{\ArrowLine@A}{\expandafter\sensyu\miki@vv}%
        }{%
          \expandafter\sensyu\v@arrow
        }%
      }%
    }%
  }%
  \ifx\empty\put@str\else
    \Mulvec\put@pos\miki@v\put@p\Addvec{\ArrowLine@A}\put@p\put@p
    \put(0,0){\expandafter\emathPut\expandafter\put@p\put@str}%
  \fi
\fi
  }}%
%
% 複数の矢線
\def\ArrowLines{\@ifnextchar<{\@ArrowLines}{\@ArrowLines<\empty>}}%
\def\@ArrowLines<#1>{\@ifnextchar[{\@@ArrowLines<#1>}{%
    \@@ArrowLines<#1>[1]}}%
\def\@@ArrowLines<#1>[#2]#3{%
    \def\ArrowLines@sub(##1,##2)(##3,##4){%
      \edef\ArrowLines@a{(##1,##2)}%
      \edef\ArrowLines@b{(##3,##4)}}%
  \argsep{#3}{;}{ArrowLines@tmp}\ArrowLines@n
  \Cfor{\edef\ArrowLines@i{0}}{\ArrowLines@i<\ArrowLines@n}{}\do{%
    \Incr\ArrowLines@i
    \edef\ArrowLines@arg{%
      \csname ArrowLines@tmp\romannumeral\ArrowLines@i\endcsname}%
    \expandafter\ArrowLines@sub\ArrowLines@arg
    \@@ArrowLine<#1>[#2]\ArrowLines@a\ArrowLines@b
  }%
}%
%
\def\ArrowDottedLine#1#2#3{%
  \edef\v@arrow{#1#2#3}%
  \expandafter\dottedline\v@arrow
  \edef\yaziri@v{#3}%
  \Subvec{#2}{#3}\miki@v
  \Rotvec[\Arr@wHeadSize]\miki@v\ArrowHeadAngle\arrow@vi
  \Rotvec[\Arr@wHeadSize]\miki@v{-\ArrowHeadAngle}\arrow@vii
  \Addvec{#3}\arrow@vi\arrow@vi\Addvec{#3}\arrow@vii\arrow@vii
  \if\ArrowHeadType l\relax\Drawline{\arrow@vi\yaziri@v\arrow@vii}\else%
    \Nuritubusi[\Nurizen]{\arrow@vi\yaziri@v\arrow@vii\arrow@vi}\fi%
% \Nuritubusi[\Nurizen]{\arrow@vi#3\arrow@vii\arrow@vi}%
  }%
%
\def\ArrowDashLine{\@ifnextchar[{\@ArrowDashLine}{%
    \@ArrowDashLine[\dashlinestretch]}}%
\def\@ArrowDashLine[#1]#2#3#4{%
  \edef\v@arrow{[#1]{#2}#3#4}%
  \expandafter\dashline\v@arrow
  \edef\yaziri@v{#4}%
  \Subvec{#3}{#4}\miki@v
  \Rotvec[\Arr@wHeadSize]\miki@v\ArrowHeadAngle\arrow@vi
  \Rotvec[\Arr@wHeadSize]\miki@v{-\ArrowHeadAngle}\arrow@vii
  \Addvec{#4}\arrow@vi\arrow@vi\Addvec{#4}\arrow@vii\arrow@vii
  \if\ArrowHeadType l\relax\Drawline{\arrow@vi\yaziri@v\arrow@vii}\else%
    \Nuritubusi[\Nurizen]{\arrow@vi\yaziri@v\arrow@vii\arrow@vi}\fi%
% \Nuritubusi[\Nurizen]{\arrow@vi#4\arrow@vii\arrow@vi}%
  }%
%
\def\Arrowline#1{%
  \edef\Arrowline@tmp{#1}%
%  \typeout{now! Arrowline:arg1=#1,tmp=\Arrowline@tmp}%
  \expandafter\@Arrowline\Arrowline@tmp}%
\def\@Arrowline(#1,#2)(#3,#4){%
%  \typeout{now!@Arrowline (#1,#2)->(#3,#4)}%
  \ArrowLine{(#1,#2)}{(#3,#4)}}%
%\def\Arrowline#1{%
%  \edef\v@arrow{#1}%
%  \expandafter\arrow\expandafter\drawline\v@arrow}%
%
% 複数の矢線
\def\arrowline{\@ifnextchar[{\@arrowline}{%
    \@arrowline[1]}}%
\def\@arrowline[#1]#2{%
    \def\arrowline@sub(##1,##2)(##3,##4){%
      \edef\arrowline@a{(##1,##2)}%
      \edef\arrowline@b{(##3,##4)}}%
  \argsep{#2}{;}{arrowline@tmp}\arrowline@n
  \Cfor{\edef\arrowline@i{0}}{\arrowline@i<\arrowline@n}{}\do{%
    \Incr\arrowline@i
    \edef\arrowline@arg{%
      \csname arrowline@tmp\romannumeral\arrowline@i\endcsname}%
    \expandafter\arrowline@sub\arrowline@arg
    \ArrowLine[#1]\arrowline@a\arrowline@b
  }%
}%
%
%\let\mybekutoru\relax
%\iffalse
%\@ifundefined{bekutorukata}{%
%  \def\bekutorukata{\@ifnextchar<{\@bekutorukata}{\@bekutorukata<\ArrowHeadPit>}}%
%  \def\@bekutorukata<#1>{\edef\bekutoru@kubomi{#1}\@@bekutorukata}%
%  \def\@@bekutorukata#1{%
%              \ifthenelse{\equal{#1}{fill}}%
%              {%
%                \bekutorusityuu{\vrule height .9\zh width \z@}%
%                \def\bekutoru@t##1{{%
%                  \@tempdima=1\zh\relax
%                  \edef\BK@hi{\strip@pt\@tempdima}%
%                  \@Div\BK@hi{9.16443}\BK@hi
%                  \Mul{0.5}\BK@hi\BK@thickness
%                  \changeArrowHeadSize\BK@hi
%%                  \setbox0=\hbox{\bekutoru@sityuu}%
%                  \setbox0=\hbox{\EMvphantom*[.5pt][0pt]{##1}\bekutoru@sityuu}%
%                  \ukansan{\the\ht0}\bekutoru@h
%%                  \setbox0=\hbox{##1}%
%                  \ukansan{\the\wd0}\bekutoru@w
%                  \begin{picture}(0,0)\relax
%  \@ifundefined{xunitlength}{}{\xunitlength=\unitlength\def\@xscale{1}}%
%  \@ifundefined{yunitlength}{}{\yunitlength=\unitlength\def\@yscale{1}}%
%                    \edef\O@@{(0,0)}%
%                    \edef\ArrowHeadPit{\bekutoru@kubomi}%
%                    \DegSin\ArrowHeadAngle\bekutoru@s
%                    \Mul\Arr@wHeadSize\bekutoru@s\bekutoru@s
%                    \Addself\bekutoru@h\bekutoru@s
% %                   \allinethickness{\BK@thickness pt}%
%\mybekutoru
%                    \put(0,\bekutoru@h){\ArrowLine{(0,0)}{(\bekutoru@w,0)}}%
%                    \Addself\bekutoru@h\bekutoru@s
%                    \xdef\bekutoru@H{\bekutoru@h}%
%                  \end{picture}%
%                  \vrule width \z@ height \bekutoru@H \p@\box0
%                }}%
%                \def\bekutoru@m##1{{%
%                  \@tempdima=1\zh\relax
%                  \edef\BK@hi{\strip@pt\@tempdima}%
%                  \@Div\BK@hi{9.16443}\BK@hi
%                  \Mul{0.5}\BK@hi\BK@thickness
%                  \changeArrowHeadSize\BK@hi
%%                  \setbox0=\hbox{\bekutoru@sityuu}%
%                  \setbox0=\hbox{\EMvphantom*[.5pt][0pt]{\ensuremath{\displaystyle ##1}}\bekutoru@sityuu}%
%                  \ukansan{\the\ht0}\bekutoru@h
%%                  \setbox0=\hbox{\ensuremath{\displaystyle ##1}}%
%                  \ukansan{\the\wd0}\bekutoru@w
%                  \begin{picture}(0,0)\relax
%  \@ifundefined{xunitlength}{}{\xunitlength=\unitlength\def\@xscale{1}}%
%  \@ifundefined{yunitlength}{}{\yunitlength=\unitlength\def\@yscale{1}}%
%                    \edef\ArrowHeadPit{\bekutoru@kubomi}%
%                    \DegSin\ArrowHeadAngle\bekutoru@s
%                    \Mul\Arr@wHeadSize\bekutoru@s\bekutoru@s
%                    \Addself\bekutoru@h\bekutoru@s
%                    \allinethickness{\BK@thickness pt}%
%\mybekutoru
%                    \put(0,\bekutoru@h){\ArrowLine{(0,0)}{(\bekutoru@w,0)}}%
%                    \Addself\bekutoru@h\bekutoru@s
%                    \xdef\bekutoru@H{\bekutoru@h}%
%                  \end{picture}%
%                  \vrule width \z@ height \bekutoru@H \p@\box0
%                }}%
%              }%
%              {%
%                \relax
%              }%
%  }}{}%
%\fi
%
%
% 矢線ボックス
%
\define@key{ArrowBox}{ryoumuki}[]{\def\ryou@muki{}}%
\define@key{ArrowBox}{W}[8pt]{\arrowboxW{#1}}%
\define@key{ArrowBox}{w}[4pt]{\arrowboxw{#1}}%
\define@key{ArrowBox}{L}[16pt]{\arrowboxL{#1}}%
\define@key{ArrowBox}{A}[90]{\arrowboxA{#1}}%
\def\arrowbox@W@{8pt}%
\def\arrowbox@w@{4pt}%
\def\arrowbox@L@{16pt}%
\def\arrowbox@A@{90}%
\def\arrowboxL#1{\edef\arrowbox@L@{#1}}%
\def\arrowboxW#1{\edef\arrowbox@W@{#1}}%
\def\arrowboxw#1{\edef\arrowbox@w@{#1}}%
\def\arrowboxA#1{\edef\arrowbox@A@{#1}}%
%
%\def\ArrowBox{\@ifstar{\arrowbox@}{\def\ab@cmd{\Takakkei}\@@arrowbox}}%
\DeclareRobustCommand\ArrowBox{%
  \@ifstar{\arrowbox@}{\def\ab@cmd{\Takakkei}\@@arrowbox}}%
\def\arrowbox@{\@ifstar{\edef\ab@cmd{\empty}\@@arrowbox}{%
  \def\ab@cmd{\emPaint}\@@arrowbox}}%
\def\@@arrowbox{\@ifnextchar({\@@@arrowbox}{\@@@arrowbox(\empty)}}%
\def\@@@arrowbox(#1){%
  \@ifnextchar<{\@@@@arrowbox(#1)}{\@@@@arrowbox(#1)<\empty>}%
}%
\def\@@@@arrowbox(#1)<#2>#3#4{\begingroup
  \@ifundefined{zituKaiten}{}{\let\Rotdef\zituKaiten}%
  \edef\yazirusi@opt{\empty}%
  \ifx\empty #1\else\setkeys{ArrowBox}{#1}\fi
  \ukansan\arrowbox@L@\arrowbox@L
  \ukansan\arrowbox@W@\arrowbox@W
  \ukansan\arrowbox@w@\arrowbox@w
  \@Div\arrowbox@W{2}\arrowbox@hW
  \Subvec{#4}{#3}\box@v
  \Rotdef[\arrowbox@hW]{#3}{#4}{\arrowbox@A@}\box@A
  \Rotdef[\arrowbox@hW]{#3}{#4}{-\arrowbox@A@}\box@B
  \Addvec\box@A\box@v\box@D
  \Addvec\box@B\box@v\box@C
  \Hamidasiten*\box@A\box@D{-\arrowbox@L@}{-\arrowbox@L@}\box@AA\box@DD
  \Hamidasiten*\box@B\box@C{-\arrowbox@L@}{-\arrowbox@L@}\box@BB\box@CC
  \Rotdef[\arrowbox@w]\box@CC\box@B{\arrowbox@A@}\box@CCC%
  \Rotdef[\arrowbox@w]\box@DD\box@A{-\arrowbox@A@}\box@DDD%
  \@ifundefined{ryou@muki}{%
    \edef\ab@oresen{\box@A\box@B\box@CC\box@CCC#4\box@DDD\box@DD}%
  }{%
    \Rotdef[\arrowbox@w]\box@BB\box@B{\arrowbox@A@}\box@BBB%
    \Rotdef[\arrowbox@w]\box@AA\box@A{-\arrowbox@A@}\box@AAA%
    \edef\ab@oresen{%
      #3\box@BBB\box@BB\box@CC\box@CCC#4\box@DDD\box@DD\box@AA\box@AAA}%
  }%
  \ifx\empty\ab@cmd
    \ifx\empty #2\relax
      \emPaint*<border>{\ab@oresen}%
    \else
      \emPaint*<border,#2>{\ab@oresen}%
    \fi
  \else
    \ab@cmd<#2>{\ab@oresen}%
  \fi
\endgroup}%
%
% 多角形のシェイディング ---------------------------------------------
%   \nuritubusi[濃さ](x1,y1)(x2,y2).....(xN,yN)(x1,y1)
%       濃さは 0（真っ白） と 1（真っ黒） の間の数（デフォルトは 0.5）
%       (x1,y1)....(xN,yN) は多角形の頂点
%       閉じていなければなりませんから，最後に (x1,y1)
%
\def\nuritubusi{\@ifnextchar[{\@nuritubusi}{\@nuritubusi[.5]}}%
\def\@nuritubusi[#1]{\special{sh #1}\@@nuritubusi}%
\def\@@nuritubusi{\@ifnextchar({\@@@nuritubusi}{\special{ip}}}%
\def\@@@nuritubusi(#1,#2){{%
  \@ifundefined{em@dvipdfm}{%
    \@tempdima#1\unitlength\@tempdima13.837\@tempdima%
    \@tempdimb#2\unitlength\@tempdimb-13.837\@tempdimb%
  }{%
    \iftdir
      \@tempdima#2\unitlength\@tempdima13.837\@tempdima%
      \@tempdimb#1\unitlength\@tempdimb13.837\@tempdimb%
    \else
      \@tempdima#1\unitlength\@tempdima13.837\@tempdima%
      \@tempdimb#2\unitlength\@tempdimb-13.837\@tempdimb%
    \fi
  }%
  \special{pa \@seisuu\@tempdima\space\@seisuu\@tempdimb}}%
    \@@nuritubusi}%
%\def\@@@nuritubusi(#1,#2){{%
%    \@tempdima#1\unitlength\@tempdima13.837\@tempdima%
%    \@tempdimb#2\unitlength\@tempdimb-13.837\@tempdimb%
%    \special{pa \strip@pt\@tempdima\space \strip@pt\@tempdimb}}%
%    \@@nuritubusi}%
%
\def\get@orgpoint(#1,#2)#3\@nil{\edef\@rgpoint{(#1,#2)}}%
%
\define@key{emP}{thickness}{\def\thickness@{#1}}%
\define@key{emP}{slashangle}{\def\slash@angle{#1}}%
\define@key{emP}{slash_angle}{\def\slash@angle{#1}}%
\define@key{emP}{slashthickness}{\def\slash@thickness{#1}}%
\def\emPaint{\@ifstar{\emPaint@}{\@emPaint}}%
\def\@emPaint{\@ifnextchar[{\@emPaint@}{%
	\def\thickness@{.5}\@@emPaint}}%
\def\@emPaint@[#1]{\def\thickness@{#1}\@@emPaint}%
\def\@@emPaint{\@ifnextchar<{\@@@emPaint}{\@@@emPaint<\empty>}}%
\def\@@@emPaint<#1>#2{%
  \ifx\empty #2\else
    \begingroup
    \edef\draw@border{\empty}%
    \edef\nuri@iro{\nuri@iro@}%
    \ifnum\EMps@mode=\@ne\gsave\fi
%    \def\thickness@{.5}%
    \ifx\empty #1\else\setkeys{emP}{#1}\fi
%    \ifx\empty\iro@\else\edef\draw@border{1}\fi%削除 2012/12/17 周の描画は別途
    \@ifundefined{dilute@color}{}{%
      \EMdilutecolor{\nuri@iro}{\dilute@color}{nuri@iro@tmp}%
      \edef\nuri@iro{nuri@iro@tmp}%
    }%
    \ifnum\EMps@mode=\@ne
      \begin{clipTakakkei}{#2}%
          \Nuritubusi[\thickness@]<#1>{\zenheimen}%
      \end{clipTakakkei}%
    \else
      {\Nuritubusi[\thickness@]<#1>{#2}}%
    \fi
    \ifx\empty\draw@border\else
      \Takakkei<#1>{#2}%
    \fi
    \ifnum\EMps@mode=\@ne\grestore\fi
    \endgroup
  \fi
}%
%
\def\syanuri@kankaku@{3pt}%
\def\syanuriKankaku#1{\def\syanuri@kankaku@{#1}}%
\def\slash@thickness{.3pt}%
\def\emPaint@{\@ifnextchar[{\emPaint@@}{\def\slash@angle{45}\emPaint@@@}}%
\def\emPaint@@[#1]{\def\slash@angle{#1}\emPaint@@@}%
\def\emPaint@@@{\@ifnextchar<{\emPaint@@@@}{\emPaint@@@@<\empty>}}
\def\emPaint@@@@<#1>#2{%
  \ifx\empty #2\else
    \begingroup
    \ifnum\EMps@mode=\@ne\gsave\fi
    \edef\draw@border{\empty}%
    \def\slash@thickness{.3pt}%
%    \def\slash@angle{45}%
    \edef\slash@color{\empty}%
%    \uykansan{3pt}\syanuri@kankaku
%    \ukansan{3pt}\syanuri@kankaku
    \ukansan{\syanuri@kankaku@}\syanuri@kankaku
    \ifx\empty #1\else\setkeys{emP}{#1}\fi
    \ifnum\EMps@mode=\@ne
      \begin{clipTakakkei}{#2}%
        \linethickness{\slash@thickness}%
        \expandafter\@for\expandafter\slash@angle@\expandafter:\expandafter
            =\slash@angle\do{%
              \ifdim\slash@angle@\p@>90\p@\Subself\slash@angle@{180}\fi
              \ifx\empty\slash@color
                  \edef\iro@{\empty}%
              \else
                  \edef\iro@{\slash@color}%
              \fi
              \Hatchplane
        }%
      \end{clipTakakkei}%
    \else
      \linethickness{\slash@thickness}%
      \Hatchpolygon[\slash@angle]<#1>{#2}%
    \fi
    \ifx\empty\draw@border\else
      \Takakkei{#2}%
    \fi
    \ifnum\EMps@mode=\@ne\grestore\fi
    \endgroup
  \fi
}%
\def\Hatchplane{{%
\edef\local@origin{(0,0)}%
  \ifnum\EMps@mode=\@ne\gsave\fi
\begin{clipTakakkei}{\truezenheimen}%
  \@ifundefined{@xscale}{\edef\@xscale{1}\edef\@yscale{1}}{}%
  \ifx\empty\iro@\else\EMpsIrositei\iro@\fi
  \Sub\truexmax\truexmin\HP@w
    \Mul\HP@w\@xscale\HP@w@
  \Sub\trueymax\trueymin\HP@h
    \Mul\HP@h\@yscale\HP@h@
  \ifdim\slash@angle@\p@>45\p@
    \Sub{90}\slash@angle@\slash@angle@@
    \DegTan{\slash@angle@@}\HP@tmp
      \Mul\HP@h@\HP@tmp\HP@W@
      \Add\HP@W@\HP@w@\HP@Ww@
      \@Div\HP@Ww@\@xscale\HP@Ww
      \@Div\HP@W@\@xscale\HP@W
    \DegSin{\slash@angle@}\HP@tmp
      \@Div\syanuri@kankaku\HP@tmp\HP@r
      \Divself\HP@r\@xscale
      \@Div\HP@Ww\HP@r\HP@n
    \Int\HP@n\HP@n
    \Incr\HP@n
    \multiput(\truexmax,\trueymin)(-\HP@r,0)\HP@n{%
        \Drawline{(0,0)(\HP@W,\HP@h)}}%
  \else\ifdim\slash@angle@\p@>\z@
    \DegTan{\slash@angle@}\HP@tmp
      \Mul\HP@w@\HP@tmp\HP@H@
      \Add\HP@H@\HP@h@\HP@Hh@
      \@Div\HP@Hh@\@yscale\HP@Hh
      \@Div\HP@H@\@yscale\HP@H
    \DegCos{\slash@angle@}\HP@tmp
      \@Div\syanuri@kankaku\HP@tmp\HP@r
      \Divself\HP@r\@yscale
      \@Div\HP@Hh\HP@r\HP@n
    \Int\HP@n\HP@n
    \Incr\HP@n
%\typeout{angle=\slash@angle@,r=\HP@r}
%\typeout{w=\HP@w,\HP@w@}
%\typeout{H=\HP@H,\HP@H@}
%\typeout{(\truexmin,\trueymax)(0,-\HP@r)\HP@n}%\yyy
    \multiput(\truexmin,\trueymax)(0,-\HP@r)\HP@n{%
        \Drawline{(0,0)(\HP@w,\HP@H)}}%
  \else\ifdim\slash@angle@\p@>-45\p@
    \DegTan{\slash@angle@}\HP@tmp
    \Abs\HP@tmp\HP@tmp
      \Mul\HP@w@\HP@tmp\HP@H@
      \Add\HP@H@\HP@h@\HP@Hh@
      \@Div\HP@Hh@\@yscale\HP@Hh
      \@Div\HP@H@\@yscale\HP@H
    \DegCos{\slash@angle@}\HP@tmp
      \@Div\syanuri@kankaku\HP@tmp\HP@r
      \Divself\HP@r\@yscale
      \@Div\HP@Hh\HP@r\HP@n
    \Int\HP@n\HP@n
    \Incr\HP@n
    \multiput(\truexmax,\trueymax)(0,-\HP@r)\HP@n{%
        \Drawline{(0,0)(-\HP@w,\HP@H)}}%
  \else
    \Add{90}\slash@angle@\slash@angle@@
    \DegTan{\slash@angle@@}\HP@tmp
      \Mul\HP@h@\HP@tmp\HP@W@
      \Add\HP@W@\HP@w@\HP@Ww@
      \@Div\HP@Ww@\@xscale\HP@Ww
      \@Div\HP@W@\@xscale\HP@W
    \DegSin{\slash@angle@}\HP@tmp
    \Abs\HP@tmp\HP@tmp
      \@Div\syanuri@kankaku\HP@tmp\HP@r
      \Divself\HP@r\@xscale
      \@Div\HP@Ww\HP@r\HP@n
    \Int\HP@n\HP@n
    \Incr\HP@n
%\typeout{(\truexmin,\trueymax)(0,-\HP@r)\HP@n}\yyy
    \multiput(\truexmax,\trueymax)(-\HP@r,0)\HP@n{%
        \Drawline{(0,0)(\HP@W,-\HP@h)}}%
  \fi\fi\fi
\end{clipTakakkei}%
  \ifnum\EMps@mode=\@ne\grestore\fi
}}%
%\def\Hatchplane{{%
%  \ifnum\EMps@mode=\@ne\gsave\fi
%  \Sub\truexmax\truexmin\HP@wx
%  \Sub\trueymax\trueymin\HP@wy
%  \Div\HP@wy\HP@wx\HP@tmp
%  \atan\HP@tmp\HP@kaku
%  \ifdim\slash@angle@\p@>\z@
%    \Unitvec{(\HP@wx,-\HP@wy)}\HP@v
%    \Addself\HP@kaku\slash@angle@
%    \DegSin\HP@kaku\HP@tmp
%    \@Div\syanuri@kankaku\HP@tmp\HP@r
%    \@ifundefined{@yscale}{}{\Mulself\HP@r\@yscale\Divself\HP@r\@xscale}%
%    \Mulvecself\HP@r\HP@v
%    \Cfor{\Addvec\trueLT\HP@v\HP@P\vecXY\HP@P\HP@Px\HP@Py}%
%          {\lengthtest{\HP@Px\p@<\truexmax\p@}}{}\do{%
%      \kline\HP@P{\slash@angle@}%
%      \Addvecself\HP@P\HP@v
%      \vecXY\HP@P\HP@Px\HP@Py
%    }%
%  \else
%    \Unitvec{(-\HP@wx,-\HP@wy)}\HP@v
%    \Subself\HP@kaku\slash@angle@
%    \DegSin\HP@kaku\HP@tmp
%    \Div\syanuri@kankaku\HP@tmp\HP@r
%    \@ifundefined{@yscale}{}{\Mulself\HP@r\@yscale\Divself\HP@r\@xscale}%
%    \Mulvecself\HP@r\HP@v
%    \Cfor{\Addvec\trueRT\HP@v\HP@P\vecXY\HP@P\HP@Px\HP@Py}%
%          {\lengthtest{\HP@Px\p@>\truexmin\p@}}{}\do{%
%      \kline\HP@P{\slash@angle@}%
%      \Addvecself\HP@P\HP@v
%      \vecXY\HP@P\HP@Px\HP@Py
%    }%
%  \fi
%    \ifnum\EMps@mode=\@ne\grestore\fi
%}}%
\let\Paint\emPaint
%
\def\nuri@noudo{.5}%
\def\nurinoudo#1{\def\nuri@noudo{#1}}%
\def\Nuritubusi{\@ifstar{\Hatchpolygon}{\Nuritubusi@}}%
\def\Nuritubusi@{\@ifnextchar[{\Nuritubusi@@}{\Nuritubusi@@[\nuri@noudo]}}%
\def\Nuritubusi@@[#1]{\@ifnextchar<{\@Nuritubusi[#1]}{%
  \@Nuritubusi[#1]<\empty>}}%
\def\@Nuritubusi[#1]<#2>#3{%
\ifthenelse{\equal{#3}\empty}{}{{%
  \ifnum\EMps@mode=\@ne\gsave\fi
%  \expandafter\get@orgpoint#3\@nil%%%%%%%%%%%%%% ↓
  \edef\Nuri@orgP{#3}%%%%%%%%%%%%%%%%%%%%%%%%%%%% 2004/12/14
  \expandafter\get@orgpoint\Nuri@orgP\@nil
  \edef\Nuritubusi@takakkei{#3\@rgpoint}%
  \edef\draw@border{\empty}%
  \edef\nuri@iro{\nuri@iro@}%
  \def\noudo@{.5}%
%  \Strchr{#2}{=}\Hatchpoly@tmp
%  \ifnum\Hatchpoly@tmp>\z@\setkeys{emP}{#2}\fi
  \ifx\empty #2\else\setkeys{emP}{#2}\fi
  \Strchr{#1}{=}\nuri@iro@tmp
  \ifnum\nuri@iro@tmp>\z@\setkeys{emP}{#1}\else\edef\noudo@{#1}\fi
  \ifthenelse{\equal{\noudo@}{0}}{%
\@ifundefined{ifcolors@}{\errmessage{Nirutubusi needs color.sty}}{}%
\ifcolors@
    \@ifundefined{em@grdrv}{%
      \put(0,0){%
        \special{bk}{\color{white}\@@Nuritubusi{\Nuritubusi@takakkei}}}%
    }{%
      \ifthenelse{\equal{\em@grdrv}{dviout}}{%
        \put(0,0){\special{sh \noudo@}\@@Nuritubusi{\Nuritubusi@takakkei}}%
      }{%
        \ifthenelse{\equal{\em@grdrv}{dvipdfmx}}{%
          \put(0,0){\special{sh \noudo@}\@@Nuritubusi{\Nuritubusi@takakkei}}%
        }{%
          \put(0,0){%
            \special{bk}{\color{white}\@@Nuritubusi{\Nuritubusi@takakkei}}}%
        }%
      }%
    }%
\else
  \put(0,0){\special{sh \noudo@}\@@Nuritubusi{\Nuritubusi@takakkei}}%
\fi
  }{%
    \ifthenelse{\equal\nuri@iro\empty}{%
      \put(0,0){\special{sh \noudo@}\@@Nuritubusi{\Nuritubusi@takakkei}}%
    }{%
      \put(0,0){%
        \special{bk}{\@iro{\nuri@iro}\@@Nuritubusi{\Nuritubusi@takakkei}}}%
    }%
  }%
  \IFempty{\draw@border}{}{%
    \ifx\empty\iro@
      \Drawline{\Nuritubusi@takakkei}%
    \else
      \@iro{\iro@}\Drawline{\Nuritubusi@takakkei}%
    \fi
  }%
  \ifnum\EMps@mode=\@ne\grestore\fi
  }}\ignorespaces}%
\def\@@Nuritubusi#1{\edef\@tmp{#1}\expandafter\@@nuritubusi\@tmp}%
%
%
% ---------------------------------------------------------------------
% 折れ線で囲まれた図形のハッチング
%
% \hatchpolygon(x1,y1)(x2,y2).....(xN,yN)% x1=xN, y1=yN
%\edef\syanuri@kankaku{.125}%   k の刻み値
%\edef\h@angle{45}%   hatch の方向角
%\DegRad\h@angle\h@angle
%\Cos\h@angle\h@v@x%
%\Sin\h@angle\h@v@y%    (\h@v@x,\h@v@y):hatch の方向ベクトル
\def\syasen@tanmatu{0pt}%
\def\hatchpolygon{\edef\n@vertex{0}%
  \edef\k@max{-1000}%
  \edef\k@min{1000}%
  \@preHP}%
\def\@preHP{\@ifnextchar({\pre@HP}{\@hatchpolygon}}%
\def\pre@HP(#1,#2){\IAdd\n@vertex{1}\n@vertex
  \expandafter\edef\csname v@x\romannumeral\n@vertex\endcsname{#1}%
  \expandafter\edef\csname v@y\romannumeral\n@vertex\endcsname{#2}%
  \Mul\h@v@x{#2}\@k\Mul\h@v@y{#1}\@kk\Sub\@k\@kk\@k% y\cosΘ-x\sinΘ
% \Sub{#2}{#1}\@k%
  \expandafter\edef\csname v@k\romannumeral\n@vertex\endcsname{\@k}%
  \ifdim\@k pt>\k@max pt\relax\edef\k@max{\@k}\edef\n@max{\n@vertex}\fi
  \ifdim\@k pt<\k@min pt\relax\edef\k@min{\@k}\edef\n@min{\n@vertex}\fi
  \@preHP}%
\def\@hatchpolygon{%\n@vertex max=\k@max(\n@max), min=\k@min(\n@min)\\%
  \edef\v@i{1}%
  \@whilenum\v@i<\n@vertex\do{%\v@i :
% (\csname v@x\romannumeral\v@i\endcsname,
% \csname v@y\romannumeral\v@i\endcsname)
% \csname v@k\romannumeral\v@i\endcsname\\
  \IAdd\v@i{1}\v@i}%
  \Add\k@min\syanuri@kankaku\@k@
  \edef\@L{\n@min}%
  \edef\@U{\n@min}%
  \@ifundefined{syanuri@siteiten}{}{%
    \IFempty{\syanuri@siteiten}{}{%
      \vecXY\syanuri@siteiten\ten@x\ten@y
      \Mul\h@v@x\ten@y\@k\Mul\h@v@y\ten@x\@kk\Sub\@k\@kk\@k
      \@whiledim\@k pt>\k@min pt\relax\do{\Sub\@k\syanuri@kankaku\@k}%
      \Add\@k\syanuri@kankaku\@k@
    }%
  }%
  \@whiledim\@k@ pt<\k@max pt\relax\do{%
      \edef\@tmp{\csname v@k\romannumeral\@L\endcsname}%
      \@whiledim\@tmp pt<\@k@ pt\relax\do{%
        \next@L\@L\@L%
        \edef\@tmp{\csname v@k\romannumeral\@L\endcsname}%
      }%
      \edef\@tmp{\csname v@k\romannumeral\@U\endcsname}%
      \@whiledim\@tmp pt<\@k@ pt\relax\do{%
        \next@U\@U\@U%
        \edef\@tmp{\csname v@k\romannumeral\@U\endcsname}%
      }%
      \edef\@Pi{(\csname v@x\romannumeral\@L\endcsname,\csname v@y\romannumeral\@L\endcsname)}%
      \next@U\@L\@Li
      \edef\@Pii{(\csname v@x\romannumeral\@Li\endcsname,\csname v@y\romannumeral\@Li\endcsname)}%
      \Mul\@k@\h@v@y\h@x\Mul\@k@\h@v@x\h@y
      \Landl\@Pi\@Pii{(-\h@x,\h@y)}{(\h@v@x,\h@v@y)}\@P%
      \edef\@Qi{(\csname v@x\romannumeral\@U\endcsname,\csname v@y\romannumeral\@U\endcsname)}%
      \next@L\@U\@Ui
      \edef\@Qii{(\csname v@x\romannumeral\@Ui\endcsname,\csname v@y\romannumeral\@Ui\endcsname)}%
      \Landl\@Qi\@Qii{(-\h@x,\h@y)}{(\h@v@x,\h@v@y)}\@Q%
%     \@k@:\@L-\@U:\@Pi-\@Pii=\@P;\@Qi-\@Qii=\@Q\\
%     \Drawline{\@P\@Q}%
      \Sensyu{\@P\@Q}%
%      \ifdim\syasen@tanmatu>\z@
%        \bgroup
%        \@tempdima=\syasen@tanmatu
%        \@Div{\strip@pt\@tempdima}{\strip@pt\unitlength}\Syanuri@tanmatu
%        \@Bunten\@P\@Q11\@M
%        \Kyori\@P\@M\@MP
%        \ifdim\@MP pt>\Syanuri@tanmatu pt\relax
%          \Sub\@MP\Syanuri@tanmatu\@dsya
%          \@Div\@dsya\@MP\@dsya
%          \Subvec\@P\@M\@vMP
%          \Mulvec\@dsya\@vMP\@vsya
%          \Addvec\@M\@vsya\@P
%          \Subvec\@M\@vsya\@Q
%          \Sensyu{\@P\@Q}%
%        \fi
%        \egroup
%      \else
%        \Sensyu{\@P\@Q}%
%      \fi
      \Add\@k@\syanuri@kankaku\@k@
  }%
}%
\def\next@L#1#2{\ifnum#1=1\edef#2{\n@vertex}\fi%
\IAdd{#1}{-1}\@nn\edef#2{\@nn}}%
\def\next@U#1#2{\ifnum#1=\n@vertex\edef#2{1}\fi%
\IAdd{#1}{1}\@nn\edef#2{\@nn}}%
%
% \Hatchpolygon[#1]<#2>#3
%   #1 : 斜線の方向角Θ (-90度 〜 90 度） y\cosΘ-x\sinΘ=k
%        コンマ区切りで複数指定可
%   #2 : k の刻み値
%   #3 : 閉多角形
%   [制約条項] 直線群 y\cosΘ-x\sinΘ=k が閉多角形によって
%              きり取られる線分は単一の連結な線分であること．
%
\def\Hatchpolygon{\@ifnextchar[{\@Hatchpolygon}{\@Hatchpolygon[45]}}%
\def\@Hatchpolygon[#1]{\@ifnextchar<{\@@Hatchpolygon[#1]}{%
  \@@Hatchpolygon[#1]<\empty>}}%
\def\@@Hatchpolygon[#1]<#2>#3{{%
%
  \define@key{emP}{background}{\ifthenelse{\equal{##1}{white}}{%
    \edef\bg@white{1}}{}}%
%
  \edef\bg@white{0}%
  \ifnum\EMps@mode=\@ne\gsave
    \EMpscontinuefalse
  \fi
  \ifthenelse{\equal{#3}\empty}{}{%
    \ifthenelse{\equal{#3}{*}}{%
      \edef\HP@tmp{\LT\LB\RB\RT}%
    }{%
      \edef\HP@tmp{#3}%
    }%
    \expandafter\get@orgpoint\HP@tmp\@nil%
\ifnum\EMps@mode=\@ne
  \psnewpath
  \psmoveto\@rgpoint
  \psLineto\HP@tmp
  \psclosepath
  \psclip
\fi
    \edef\Nuritubusi@takakkei{\HP@tmp\@rgpoint}%
%   \edef\h@angle{#1}%    hatch の方向角
    \def\syanuri@siteiten{}%
    \edef\draw@border{\empty}%
%    \ukansan{3pt}\syanuri@kankaku
    \ukansan{\syanuri@kankaku@}\syanuri@kankaku
%\typeout{syanuri@kankaku=\syanuri@kankaku}%
%    \@ifundefined{yunitlength}{%
%        \ukansan{3pt}\syanuri@kankaku
%    }{%
%        \kansan{3pt}{\yunitlength}\syanuri@kankaku
%    }%
    \ifx\empty #2\else
      \isnumber{#2}{\edef\syanuri@kankaku{#2}}{\setkeys{emP}{#2}}%
%      \setkeys{emP}{#2}%
    \fi
%\typeout{syanuri@kankaku=\syanuri@kankaku}%\xxx%
%   \ifthenelse{\equal{#2}\empty}{}{%
%      \Headchar{#2}\Hp@tmp\Hp@dmy
%      \ifthenelse{\equal\Hp@tmp{.}\or\isodd{0\Hp@tmp1}}{%
%        \edef\syanuri@kankaku{#2}%
%      }{%
%        \setkeys{emP}{#2}%
%      }%
%    }%
%    \Strchr{#2}{=}\Hatchpoly@tmp
%    \ifnum\Hatchpoly@tmp>\z@
%      \setkeys{emP}{#2}%
%    \else
%      \ifx \empty #2\relax
%      \else
%        \edef\syanuri@kankaku{#2}%
%      \fi
%    \fi
    \ifnum\bg@white>\z@
      \Nuritubusi[0]\Nuritubusi@takakkei
    \fi
    \expandafter\@for\expandafter\h@angle\expandafter:\expandafter=#1\do{%
      \DegRad\h@angle\h@angle
      \Cos\h@angle\h@v@x%
      \Sin\h@angle\h@v@y%   (\h@v@x,\h@v@y):hatch の方向ベクトル
      \@ifundefined{@xscale}{}{%
        \@Div\h@v@x\@xscale\h@v@x
        \@Div\h@v@y\@yscale\h@v@y
        \PhAbsvec{(\h@v@x,\h@v@y)}\h@v@norm
        \@Div\h@v@x\h@v@norm\h@v@x
        \@Div\h@v@y\h@v@norm\h@v@y
      }%
      \edef\@tmp{\Nuritubusi@takakkei}%
      \put(0,0){{%
        \ifthenelse{\equal\iro@\empty}{}{\@iro{\iro@}}\relax
        \expandafter\hatchpolygon\@tmp}}%
    }%
    \ifx \empty \draw@border \else
      \Drawline{\Nuritubusi@takakkei}%
    \fi
    \ifdim\syasen@tanmatu>\z@%  田中 徹 さんのアイデア
      \open@nuri
    \fi
  }%
  \ifnum\EMps@mode=\@ne
    \ifEMpscontinue\else\grestore\fi
  \fi
}}%
%
\def\open@nuri{%
    \@tempdima=\syasen@tanmatu
    \@tempdima=2\@tempdima
    \color{white}\allinethickness{\@tempdima}%
    \Drawline\Nuritubusi@takakkei
}%
% ---------------------------------------------------------------------
%
%\def\Suisen#1#2#3#4{% 点 #1 から直線 #2#3 へ下ろした垂線の足を #4 にセット
%  \Kyori{#1}{#2}\Suisen@a
%  \Kyori{#1}{#3}\Suisen@b
%  \Kyori{#2}{#3}\Suisen@c
%  \IFnearlyzero[0.0005]\Suisen@a{\edef#4{#1}}{%
%    \IFnearlyzero[0.0005]\Suisen@b{\edef#4{#1}}{%
%    \IFnearlyzero[0.0005]\Suisen@c{\edef#4{#2}}{%
%  \sankakkei*{#1}{#2}{#3}%
% \Mul\lc\lc\cosB\Mul\la\la\@tmp\Add\cosB\@tmp\cosB%
%  \Mul\lb\lb\@tmp\Sub\cosB\@tmp\cosB\Mul\lc\la\@tmp\Mul{2}\@tmp\@tmp%
%  \@Div\cosB\@tmp\cosB\Mul\lc\cosB\S@m\Sub\la\S@m\@n
%  \@Bunten{#2}{#3}\S@m\@n{#4}%\fi\fi\fi
%  }}}}%
%
\def\Suisen#1#2#3#4{% 点 #1 から直線 #2#3 へ下ろした垂線の足を #4 にセット
  \Subvec{#3}{#2}\Suisen@v
  \Absvec\Suisen@v\Suisen@h
  \ifdim\Suisen@h\p@<0.0001\p@
    \edef\Ss@H{#2}%
    \Put@nil\Ss@H #4\@nil
  \else
    \Nvec\Suisen@v\Suisen@h
    \Landl{#2}{#3}{#1}\Suisen@h{#4}\relax
  \fi
}%
%
\def\abcSuisen#1#2#3{% 点 #1 から直線 #2(a,b,c) へ下ろした垂線の足を #3 に
  \vecXY{#1}\x@val\y@val
  \vecXYZ{(#2)}\a@val\b@val\c@val
  \sEqi<perl>{\a@val,\b@val,-(\c@val);%
  \b@val,-(\a@val),\b@val*\x@val-\a@val*\y@val}#3}%
%
% ベクトル計算
%
%
% 点 #1 から
%     #2 を通り，方向ベクトルが #3 である直線
% に下ろした垂線の足を #4 の制御綴に返す。
%
\def\lSuisen#1#2#3#4{\Addvec{#2}{#3}\lSuisen@a\Suisen{#1}{#2}{\lSuisen@a}{#4}}%
\def\nSuisen#1#2#3#4{\Rotvec{#3}{90}\lSuisen@a
  \Addvecself\lSuisen@a{#2}\Suisen{#1}{#2}{\lSuisen@a}{#4}}%
\let\mSuisen\lSuisen
%
% 点 #1 から
%     #2 を通り，方向角が #3(度)である直線
% に下ろした垂線の足を #4 の制御綴に返す。
\def\kSuisen#1#2#3#4{\DegRad{#3}\kSuisen@a
  \Cos\kSuisen@a\kSuisen@x\Sin\kSuisen@a\kSuisen@y
  \Addvec{#2}{(\kSuisen@x,\kSuisen@y)}\kSuisen@a
  \Suisen{#1}{#2}{\kSuisen@a}#4}%
%
\def\gSuisen#1#2#3#4{\def\gSuisen@v{(1,#3)}\lSuisen{#1}{#2}{\gSuisen@v}{#4}}%
\def\ngSuisen#1#2#3#4{\def\gSuisen@v{(#3,-1)}\lSuisen{#1}{#2}{\gSuisen@v}{#4}}%
%
% 対称点
% \Taisyouten#1#2#3[#4]#5
%   点 #1 の
%     #2, #3 を通る直線への対称点を#5に返す。
%   対称の中心もほしいときは#4にそれを受取る制御綴を与える。
%
\def\Taisyouten#1#2#3{\@ifnextchar[{\@Taisyouten{#1}{#2}{#3}}{%
  \@Taisyouten{#1}{#2}{#3}[\Taisyouten@h]}}%
\def\@Taisyouten#1#2#3[#4]#5{\Suisen{#1}{#2}{#3}\Tt@asi
  \Put@nil\Tt@asi#4\@nil
  \@Bunten{#1}{\Tt@asi}{2}{-1}{#5}}%
\def\gTaisyouten#1#2#3{\@ifnextchar[{\@gTaisyouten{#1}{#2}{#3}}{%
  \@gTaisyouten{#1}{#2}{#3}[\gTaisyouten@h]}}%
\def\@gTaisyouten#1#2#3[#4]#5{\gSuisen{#1}{#2}{#3}\Tt@asi\relax
  \Put@nil\Tt@asi #4\@nil
  \@Bunten{#1}{\Tt@asi}{2}{-1}{#5}}%
\def\ngTaisyouten#1#2#3{\@ifnextchar[{\@ngTaisyouten{#1}{#2}{#3}}{%
  \@ngTaisyouten{#1}{#2}{#3}[\ngTaisyouten@h]}}%
\def\@ngTaisyouten#1#2#3[#4]#5{\ngSuisen{#1}{#2}{#3}\Tt@asi\relax
  \Put@nil\Tt@asi #4\@nil
  \@Bunten{#1}{\Tt@asi}{2}{-1}{#5}}%
%
% 座標軸への射影
%
\def\xsyaei#1#2{%
  \vecXY{#1}\tmp@x\tmp@y
  \edef\tmp@P{(\tmp@x,0)}%
  \Put@nil\tmp@P #2\@nil
}%
\def\ysyaei#1#2{%
  \vecXY{#1}\tmp@x\tmp@y
  \edef\tmp@P{(0,\tmp@y)}%
  \Put@nil\tmp@P #2\@nil
}%
%
% 3点を与えて，平行四辺形を作る
%
\def\Heikousihenkei{\@ifnextchar<{\@Heikousihenkei}{\@Heikousihenkei<\empty>}}%
\def\@Heikousihenkei<#1>#2#3#4#5{%
%   線分#2#3, #2#4 を２辺とする平行四辺形の第４頂点を #5の制御綴に
  \edef\save@byouga@dousa{\byouga@dousa}%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
  \Tyuuten{#3}{#4}\HS@O
  \Bunten{#2}\HS@O{2}{-1}#5\relax
  \ifx\empty\byouga@dousa\else
    \Headchar\byouga@dousa\dousa@h\dousa@r
    \EMedef\oresen@tmp{#2#3#5#4}%
    \if T\dousa@h
      \expandafter\Takakkei\dousa@r\oresen@tmp
    \else\if P\dousa@h
      \expandafter\emPaint\dousa@r\oresen@tmp
    \fi\fi
  \fi
  \edef\byouga@dousa{\save@byouga@dousa}%
}%
%
% 点 #1 の
%     #2 を通り，方向ベクトルが #3 である直線への対称点
%
\def\lTaisyouten#1#2#3{\@ifnextchar[{\@lTaisyouten{#1}{#2}{#3}}{%
  \@lTaisyouten{#1}{#2}{#3}[\Taisyouten@h]}}%
\def\@lTaisyouten#1#2#3[#4]#5{\lSuisen{#1}{#2}{#3}\Tt@asi\relax
  \Put@nil\Tt@asi #4\@nil
  \@Bunten{#1}{\Tt@asi}{2}{-1}{#5}}%
\let\mTaisyouten\lTaisyouten
%
% 点 #1 の
%     #2 を通り，方向角が #3 である直線への対称点
%
\def\kTaisyouten#1#2#3{\@ifnextchar[{\@kTaisyouten{#1}{#2}{#3}}{%
  \@kTaisyouten{#1}{#2}{#3}[\Taisyouten@h]}}%
\def\@kTaisyouten#1#2#3[#4]#5{\kSuisen{#1}{#2}{#3}\Tt@asi\relax
  \Put@nil\Tt@asi #4\@nil
  \@Bunten{#1}{\Tt@asi}{2}{-1}{#5}}%
%
% 法線ベクトル
%
%\def\Housenvec#1#2{\vecXY{#1}\a@x\a@y\Mul{-1}\a@y\a@y\edef#2{(\a@y,\a@x)}}%
\let\Housenvec\perpvec
%
% 線分を与えて，その垂直二等分線を求める。
% \SuityokuNitoubunsen#1#2#3#4
%   #1 : 点1
%   #2 : 点2
%   #3 : 点1,2 の中点
%   #4 : 垂直二等分線の方向ベクトル
%
\def\SuityokuNitoubunsen#1#2#3#4{%
  \Tyuuten{#1}{#2}{#3}\relax
  \Subvec{#2}{#1}\SN@vec
  \vecXY\SN@vec\SN@vecx\SN@vecy
  \Mul\SN@vecy{-1}\SN@vecy
  \edef#4{(\SN@vecy,\SN@vecx)}%
}%
%
% 分点の座標
%   \@Bunten#1#2#3#4#5
%       線分 #1#2 を #3:#4 に分ける点の座標を #5 に代入する．
%
\def\iBunten#1#2#3#4#5{%
%  \ifnum\by@perl@=\z@
    \Add{#3}{#4}\BT@bunbo
    \Mul{#1}{#4}\BT@i
    \Mul{#2}{#3}\BT@ii
    \Addself\BT@i\BT@ii
    \@Div\BT@i\BT@bunbo#5\relax
%  \else
%    \perl@Bunten{#1}{#2}{#3}{#4}{#5}%
%  \fi
}%
%
%\def\Bunten{%
\DeclareRobustCommand\Bunten{%
  \define@key{emP}{tatebou}[1]{\edef\put@tatebou{##1}}%
  \define@key{emP}{pstatebou}[1]{\edef\put@pstatebou{##1}}%
  \edef\save@put@kuromaru{\put@kuromaru}%
  \edef\save@put@tatebou{\put@tatebou}%
  \edef\save@put@pstatebou{\put@pstatebou}%
  \edef\put@kuromaru{0}%
  \edef\put@tatebou{0}%
  \edef\put@pstatebou{\empty}%
  \edef\by@perl{\by@perl@}%
  \@ifnextchar<{\Bunten@}{\Bunten@@}}%
\def\Bunten@<#1>{\setkeys{emP}{#1}\Bunten@@}%
\def\Bunten@@#1#2#3#4#5{%
  \edef\BT@m{#3}%
  \edef\BT@n{#4}%
  \ifnum\by@perl=\z@
    \ifthenelse{\equal{#4}{*}}{%
      \isnumber{\BT@m}{}{\fpcalcval{\BT@m}\BT@m}%
      \Sub{1}{\BT@m}\BT@n
    }{%
      \ifthenelse{\equal{#3}{*}}{%
        \isnumber{\BT@n}{}{\fpcalcval{\BT@n}\BT@n}%
        \Sub{1}{\BT@n}\BT@m
      }{%
        \isnumber{\BT@m}{}{\fpcalcval{\BT@m}\BT@m}%
        \isnumber{\BT@n}{}{\fpcalcval{\BT@n}\BT@n}%
      }%
    }%
    \@Bunten{#1}{#2}\BT@m\BT@n{#5}\relax
  \else
    \perlBunten{#1}{#2}{#3}{#4}#5\relax
  \fi
  \edef\put@kuromaru{\save@put@kuromaru}%
  \edef\put@tatebou{\save@put@tatebou}%
  \edef\put@pstatebou{\save@put@pstatebou}%
  \edef\by@perl{\by@perl@}%
}%
\def\@Bunten#1#2#3#4#5{%
  \ifnum\by@perl=\z@
    \Add{#3}{#4}\BT@bunbo
    \@Div{#4}\BT@bunbo\BT@a
    \@Div{#3}\BT@bunbo\BT@b
    \ItiziKetugou\BT@a{#1}\BT@b{#2}{#5}\relax
  \else
    \perlBunten{#1}{#2}{#3}{#4}{#5}%
  \fi
  \ifnum\put@kuromaru>\z@\Kuromaru{#5}\fi
  \ifnum\put@tatebou>\z@\Ltatebou{#1}{#2}{#5}\fi
  \ifx\empty\put@pstatebou\else
    \ifthenelse{\equal\put@pstatebou{1}}{%
      \Lpstatebou{#1}{#2}{#5}%
    }{%
      \edef\Bt@tmp{<\put@pstatebou>}%
      \expandafter\Lpstatebou\Bt@tmp{#1}{#2}{#5}%
    }%
  \fi
%  \@ifundefined{save@put@kuromau}{}{%
%    \edef\put@kuromaru{\save@put@kuromaru}%
%    \edef\put@tatebou{\save@put@tatebou}%
%    \edef\put@pstatebou{\save@put@pstatebou}%
%  }%
  \edef\by@perl{\by@perl@}%
}%
%
\def\@BuntenMark@Lu{.5mm}%
\def\@BuntenMark@Ld{.5mm}%
\def\@BuntenMark#1#2#3#4{%
  \Subvec{#2}{#1}\BM@v
  \Rotvec[\@BuntenMark@Lu]\BM@v{-90}\BM@u
  \Rotvec[\@BuntenMark@Ld]\BM@v{90}\BM@d
  \@Bunten{#1}{#2}{#3}{#4}\BM@M
  \Addvec\BM@M\BM@u\BM@P
  \Addvec\BM@M\BM@d\BM@Q
  \Drawline{\BM@P\BM@Q}%
}%
\def\toubunmark#1#2#3{%
  \Cfor{\edef\tm@i{1}}{\tm@i<#3}{\Incr\tm@i}\do{%
    \ISub{#3}\tm@i\tm@j
    \@BuntenMark{#1}{#2}\tm@i\tm@j
  }%
}%
%
\def\HenToubun{\@ifnextchar<{\@HenToubun}{\@HenToubun<\empty>}}%
\def\@HenToubun<#1>#2#3#4#5{%
% #1: key=val
%     kuromaru
%     tatebou
% #2: 端点1
% #3: 端点2
% #4: 分割数
% #5: 分点の名前（配列基幹名，または，コンマ区切り点列名）
%   #5 において，戻る分点の個数は両端を除く (n-1)個
  \define@key{emP}{tatebou}[1]{\edef\put@tatebou{##1}}%
  \edef\put@kuromaru{0}%
  \edef\put@tatebou{0}%
  \edef\show@label{\empty}%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
  \csvhairetu*{#5}{HT@Q}%
  \IAdd\HT@QN{1}\TH@tmp
  \ifnum\HT@QN>\@ne
    \ifnum\TH@tmp=#4\relax
        \else\errmessage{HenToubun:arg5 doesn't much arg4}%
    \fi
  \fi
  \edef\HT@P@ld{#2}%
  \Ifor\HT@i{1}{#4}\Do{%
    \ISub{#4}\HT@i\HT@j
    \Bunten{#2}{#3}{\HT@i}{\HT@j}\HT@P
    \ifnum\put@kuromaru=\z@
      \ifnum\put@tatebou=\z@\else
        \@ifundefined{EMps@filename}{%
          \Touhenkigou(1)\HT@P@ld\HT@P
        }{%
          \psTouhenkigou(1)\HT@P@ld\HT@P
        }%
      \fi
      \edef\HT@P@ld{\HT@P}%
    \else\Kuromaru\HT@P
    \fi
    \ifnum\HT@QN>\@ne
      \edef\HT@nm{\csname HT@Q\romannumeral\HT@i\endcsname}%
      \expandafter\edef\csname \HT@nm\endcsname{\HT@P}%
      \ifx\empty\show@label\else
        \Kaiten[\show@label]\HT@P{#3}{90}\HT@tmp
        \emathPut\HT@tmp[c]{\HT@nm}%
      \fi
    \else
      \expandafter\edef\csname #5\romannumeral\HT@i\endcsname{\HT@P}%
      \ifx\empty\show@label\else
        \Kaiten[\show@label]\HT@P{#3}{90}\HT@tmp
        \emathPut\HT@tmp[c]{#5$_{\HT@i}$}%
      \fi
    \fi
  }%
  \ifnum\put@kuromaru<\z@\Kuromaru{#2#3}%
  \else
    \ifnum\put@tatebou<\z@
    \@ifundefined{EMps@filename}{%
      \Touhenkigou<putpos=0>{#2}{#3}%
      \Touhenkigou<putpos=1>{#2}{#3}%
    }{%
      \psTouhenkigou<putpos=0>{#2}{#3}%
      \psTouhenkigou<putpos=1>{#2}{#3}%
    }%
  \fi\fi%%%% 端点にも
  \edef\put@kuromaru{0}%
  \edef\put@tatebou{0}%
}%
%
\def\iHenToubun{\@ifnextchar<{\@iHenToubun}{\@iHenToubun<\empty>}}%
\def\@iHenToubun<#1>#2#3#4#5{%
% #1: key=val
%     kuromaru
% #2: 端点1
% #3: 端点2
% #4: 分割数
% #5: 分点の名前（配列基幹名，または，コンマ区切り点列名）
%   #5 において，戻る分点の個数は両端を除く (n-1)個
  \edef\put@kuromaru{0}%
  \edef\by@perl{\by@perl@}%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
  \csvhairetu*{#5}{HT@Q}%
  \ifnum\by@perl>\z@
    \perlteisuuretu{x@s=#2;x@e=#3;HT@w=((#3)-(#2))/#4}%
    \edef\by@perl{\by@perl@}%
  \else
    \edef\x@s{#2}%
    \edef\x@e{#3}%
    \Sub{#3}{#2}\HT@w
    \Divself\HT@w{#4}%
  \fi
  \edef\HT@tmp{\x@s}%
  \Ifor\HT@i{1}{#4}\Do{%
    \ISub{#4}\HT@i\HT@j
    \Addself\HT@tmp\HT@w
    \ifnum\HT@QN>\@ne
      \ifnum\put@kuromaru>\z@\Kuromaru\HT@P\fi
      \IAdd\HT@QN{1}\TH@tmp
      \ifnum\TH@tmp=#4\relax
        \else\errmessage{iHenToubun:arg4 doesn't much arg3}\fi
      \edef\HT@nm{\csname HT@Q\romannumeral\HT@i\endcsname}%
      \expandafter\edef\csname \HT@nm\endcsname{\HT@tmp}%
    \else
      \expandafter\edef\csname #5\romannumeral\HT@i\endcsname{\HT@tmp}%
    \fi
  }%
  \ifnum\HT@QN=\@ne
      \expandafter\edef\csname #5o\endcsname{\x@s}%
      \expandafter\edef\csname #5\romannumeral #4\endcsname{\x@e}%
  \fi
}%
\let\KukanToubun\iHenToubun
%
\def\EnkoTyuuten#1#2#3#4#5{%
% #1: 中心
% #2: 半径
% #3: 端点1
% #4: 端点2
% #5: 中点を受け取る制御綴
%
  \edef\@tyuusin{#1}%
  \edef\@hankei{#2}%
  \Subvec{#3}{\@tyuusin}\Enk@tmp
  \Argvec\Enk@tmp\hazime@kaku
  \Absvec\Enk@tmp\@hankei
  \Subvec{#4}{\@tyuusin}\Enk@tmp\Argvec\Enk@tmp\owari@kaku
  \ifdim\owari@kaku pt<\hazime@kaku pt\Add{360}\owari@kaku\owari@kaku\fi
  \Add\hazime@kaku\owari@kaku\ET@tmp\Divself\ET@tmp{2}%
  \Rdef[\@tyuusin](\@hankei,\ET@tmp)#5\relax
}%
%
\def\EMmklbl#1{#1}%
\def\EnkoToubun{\@ifnextchar<{\@EnkoToubun}{\@EnkoToubun<\empty>}}%
\def\@EnkoToubun<#1>#2#3#4#5#6#7{%
% #1: key=val
%       oresen
% #2: 中心
% #3: 半径
% #4: 始め角
% #5: 終り角（+ と指定した場合は，#5=#4+360）
% #6: 分割数
% #7: 分点の名前（配列基幹名，または，コンマ区切り点列名）
%   #7 において，戻る分点の個数は
%      #5 で +, - を指定した場合は，  n個
%      それ以外の場合は両端を含め (n+1)個
%
%\ifthenelse{\equal{#7}{D}}{%
%  \errmessage{EnkoToubun: 取得配列名に 'D' は使用できません。}}{}%
\define@key{emP}{tatebou}[1]{\edef\put@tatebou{##1}}%
\define@key{emP}{ptatebou}[5pt]{\EMedef\put@ptatebou{##1}}%
\define@key{emP}{enko}[1]{\EMedef\byouga@enko{##1}}%
\edef\save@by@perl{\by@perl}%
\edef\by@perl{0}%
\edef\save@byouga@dousa{\byouga@dousa}%
\ifnum\EMps@mode=\@ne\gsave\fi
  \edef\hazime@kaku{#4}%
  \edef\owari@kaku{#5}%
  \edef\@tyuusin{#2}%
  \edef\@hankei{#3}%
  \edef\byouga@dousa{\empty}%
  \edef\oresen@name{\empty}%
  \edef\hairetu@name{\empty}%
  \edef\oresen@tmp{}%
  \edef\put@kuromaru{0}%
  \edef\show@label{\empty}%
%  \let\put@tatebou\undefined
  \let\put@ptatebou\undefined
  \edef\put@tatebou{0}%
%  \edef\put@ptatebou{0}%
  \let\byouga@enko\undefined
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
  \Strchr{#3}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#3}\fi
  \Strchr{#4}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#4}\fi
  \Strchr{#5}{=}\Enk@tmp\ifnum\Enk@tmp>\z@\setkeys{emP}{#5}\fi
  \csvhairetu*{#7}{ET@Q}%
  \@ifundefined{put@ptatebou}{}{%
    \Strsep\put@ptatebou{<}\pt@L\pt@opt
    \ifx\empty\pt@opt\else\edef\pt@opt{<\pt@opt}\fi
    \ukansan{\pt@L}\pt@out
    \Divself\pt@out\@hankei
    \Sub\pt@out{1}\pt@in
  }%
  \ifthenelse{\equal{\owari@kaku}{+}}{%
    \edef\ET@kaku{360}%
    \def\zen@En{}%
  }{%
    \ifthenelse{\equal{\owari@kaku}{-}}{%
      \edef\ET@kaku{-360}%
      \def\zen@En{}%
    }{%
      \Sub{\owari@kaku}{\hazime@kaku}\ET@kaku
    }%
  }%
  \ifx\empty\show@label\else
    \@tempdima=\@hankei\unitlength
    \advance\@tempdima\show@label
    \ukansan\@tempdima\L@rval
  \fi
  \@ifundefined{zen@En}{%
    \Ifor*\ET@i{0}{#6}\Do{%
      \IAdd\ET@i{1}\ET@j
      \Mul{\ET@i}{\ET@kaku}\ET@tmp
      \Divself\ET@tmp{#6}%
      \Add{\hazime@kaku}\ET@tmp\ET@arg
      \Rdef[#2](\@hankei,\ET@arg)\ET@P
      \edefappend\oresen@tmp{\ET@P}%
      \ifnum\put@kuromaru>\z@\Kuromaru\ET@P\fi
%      \@ifundefined{put@tatebou}{%
      \ifnum\put@tatebou=\z@
        \@ifundefined{put@ptatebou}{%
        }{%
          \ifnum\ET@i>\z@
            \ifnum\ET@i<#6\relax
              \expandafter\hamidasisenbun\pt@opt\@tyuusin\ET@P\pt@in\pt@out
            \fi
          \fi
        }%
      \else
        \ifnum\ET@i>\z@
          \ifnum\ET@i<#6\relax
            \nLtatebou{#2}\ET@P\ET@P
          \fi
        \fi
      \fi
%\typeout{ET@QN=\ET@QN}%\pause
      \ifnum\ET@QN>\@ne
        \ISub\ET@QN{1}\ET@QN@
        \ifnum\ET@QN@=#6\relax
          \else\errmessage{EnkoToubun:arg7 doesn't much arg6}\fi
        \edef\ET@nm{\csname ET@Q\EMromannumeral\ET@j\endcsname}%
        \ifx\empty\ET@nm\else
          \expandafter\edef\csname \ET@nm\endcsname{\ET@P}%
          \ifx\empty\show@label\else
            \Rdef[#2](\L@rval,\ET@arg)\ET@PL
            \emathPut\ET@PL[c]{\EMmklbl{\ET@nm}}%
          \fi
        \fi
        \ifx\empty\hairetu@name\else
\expandafter\edef\csname\hairetu@name\EMromannumeral\ET@j\endcsname{\ET@P}%
\expandafter\edef\csname\hairetu@name N\endcsname{\ET@j}%
        \fi
      \else
        \expandafter\edef\csname #7\EMromannumeral\ET@j\endcsname{\ET@P}%
        \expandafter\edef\csname #7N\endcsname{\ET@j}%
          \ifx\empty\show@label\else
            \Rdef[#2](\L@rval,\ET@arg)\ET@PL
            \emathPut\ET@PL[c]{#7$_{\ET@j}$}%
          \fi
      \fi
    }%
  }{%
\ifnum\by@perl=\z@
    \Ifor\ET@i{0}{#6}\Do{%
\ifnum \hairetu@baseN=\m@ne
  \edef\ET@j{\ET@i}%
\else
  \IAdd\ET@i{1}\ET@j
\fi
      \Mul{\ET@i}{\ET@kaku}\ET@tmp
      \Divself\ET@tmp{#6}%
      \Add{\hazime@kaku}\ET@tmp\ET@arg
      \Rdef[#2](\@hankei,\ET@arg)\ET@P
      \edefappend\oresen@tmp{\ET@P}%
      \ifnum\put@kuromaru>\z@\Kuromaru\ET@P\fi
%      \@ifundefined{put@tatebou}{%
%         \@ifundefined{put@ptatebou}{%
%         }{%
      \ifnum\put@tatebou=\z@
        \@ifundefined{put@ptatebou}{}{%
          \expandafter\hamidasisenbun\pt@opt\@tyuusin\ET@P\pt@in\pt@out
        }%
      \else
        \nLtatebou{#2}\ET@P\ET@P
      \fi
      \ifnum\ET@QN>\@ne
        \ifnum\ET@QN=#6\relax
          \else\errmessage{EnkoToubun:arg7 doesn't much arg6}\fi
        \edef\ET@nm{\csname ET@Q\EMromannumeral\ET@j\endcsname}%
        \ifx\empty\ET@nm\else
          \expandafter\edef\csname \ET@nm\endcsname{\ET@P}%
          \ifx\empty\show@label\else
            \Rdef[#2](\L@rval,\ET@arg)\ET@PL
            \emathPut\ET@PL[c]{\EMmklbl{\ET@nm}}%
          \fi
        \fi
        \ifx\empty\hairetu@name\else
\expandafter\edef\csname\hairetu@name\EMromannumeral\ET@j\endcsname{\ET@P}%
\expandafter\edef\csname\hairetu@name N\endcsname{\ET@j}%
        \fi
      \else
        \expandafter\edef\csname #7\EMromannumeral\ET@j\endcsname{\ET@P}%
        \expandafter\edef\csname #7N\endcsname{\ET@j}%
          \ifx\empty\show@label\else
            \Rdef[#2](\L@rval,\ET@arg)\ET@PL
            \emathPut\ET@PL[c]{#7$_{\ET@j}$}%
          \fi
      \fi
    }%
\else
    \edef\ET@tmp{}%
    \Ifor\ET@i{0}{#6}\Do{%
      \IAdd\ET@i{1}\ET@j
      \EMedefappend[;]\ET@tmp{%
        ET@P\EMromannumeral\ET@j(\@hankei,\hazime@kaku+360*\ET@i/#6)}%
      \ifx\empty\show@label\else
        \EMedefappend\ET@tmp{%
          ;ET@PL\EMromannumeral\ET@j(\L@rval,\hazime@kaku+360*\ET@i/#6)}%
      \fi
    }%
    \edef\ET@PN{#6}%
    \edef\ET@PLN{#6}%
    \edef\ET@tmp@{*[#2]{\ET@tmp}}%
    \expandafter\perlrtenretu\ET@tmp@
    \edef\oresen@tmp{}%
    \Ifor*\ET@j{1}{#6}\Do{%
      \edefappend\oresen@tmp{\hairetu{ET@P}{\ET@j}}%
    }%
    \ifnum\ET@QN>\@ne
    \else
      \Ifor*\ET@j{1}{#6}\Do{%
        \expandafter\edef\csname #7\EMromannumeral\ET@j\endcsname{%
          \hairetu{ET@P}{\ET@j}}%
        \ifx\empty\show@label\else
          \emathPut{\hairetu{ET@PL}{\ET@j}}[c]{#7$_{\ET@j}$}%
        \fi
      }%
      \expandafter\edef\csname #7N\endcsname{#6}%
    \fi
\fi
  }%
\edef\by@perl{\save@by@perl}%
  \ifx\empty\oresen@name
  \else
    \expandafter\edef\csname\oresen@name\endcsname{\oresen@tmp}%
  \fi
    \ifx\empty\byouga@dousa\else
      \Headchar\byouga@dousa\dousa@h\dousa@r
      \if D\dousa@h
        \expandafter\Drawline\dousa@r\oresen@tmp
      \else\if T\dousa@h
        \expandafter\Takakkei\dousa@r\oresen@tmp
      \else\if P\dousa@h
%        \expandafter\emPaint\dousa@r\oresen@tmp
        \EMedef\ET@tmp{\dousa@r{\oresen@tmp}}%
        \expandafter\emPaint\ET@tmp
      \fi\fi\fi
    \fi
  \@ifundefined{byouga@enko}{}{{%
    \gsave
    \ifthenelse{\equal{\byouga@enko}{1}}{%
      \edef\enko@opt{<\empty>}%
    }{%
      \EMedef\enko@opt{<\byouga@enko>}%
    }%
    \@ifundefined{zen@En}{%
      \expandafter\Enko\enko@opt{#2}{#3}{#4}{#5}%
    }{%
      \expandafter\En\enko@opt{#2}{#3}%
    }%
    \grestore
  }}%
\ifnum\EMps@mode=\@ne\grestore\fi
\edef\byouga@dousa{\save@byouga@dousa}%
\edef\put@kuromaru{0}%
}%
%
% 一辺を指定した正多角形
%
% \seitakakkei<#1>#2#3#4#5
% #1: \EnkoToubun に引き継ぐオプション
% #2,#3: １辺（有向線分）
% #4: 辺数
% #5: 頂点の名前（中心も #5o の名前で返る）
%
\def\seitakakkei{\@ifnextchar<{\@seitakakkei}{\@seitakakkei<\empty>}}%
\def\@seitakakkei<#1>#2#3#4#5{%
  \perlKyori{#2}{#3}\st@lval
  \perlteisuuretu{st@rval=\st@lval/(2*sin($pi/(#4)));%
    st@arg=(#4-2)*180/(2*(#4))}
  \perlKaiten[\st@rval]{#2}{#3}\st@arg\st@C
  \expandafter\edef\csname #5o\endcsname{\st@C}%
  \EnkoToubun<#1>\st@C\st@rval{hazimeten=#2}{+}{#4}{#5}%
}%
%
% 円に外接する正多角形
%
% \Gseitakakkei<#1>#2#3#4#5#6
% #1: \EnkoToubun に引き継ぐオプション
% #2: 中心
% #3: 半径
% #4: 始め角
% #5: 辺数
% #6: 頂点の名前
%
\def\Gseitakakkei{\@ifnextchar<{\@Gseitakakkei}{\@Gseitakakkei<\empty>}}%
\def\@Gseitakakkei<#1>#2#3#4#5#6{%
  \calcval{#3/cos($pi/#5)}\Rst@R
  \EnkoToubun<#1>{#2}{\Rst@R}{#4}{+}{#5}{#6}%
}%
%
% 三角形の諸要素の計算
%
\def\sankakkei{\@ifstar{\sankakkei@}{\@sankakkei}}%
\def\sankakkei@#1#2#3{%
  \Kyori{#1}{#2}\lc\Kyori{#2}{#3}\la\Kyori{#3}{#1}\lb
  \Add\la\lb\ls\Add\ls\lc\ls\@Div\ls{2}\ls%    \ls = s
  \Sub\ls\la\lsa%                 \lsa= s-a
  \Sub\ls\lb\lsb%                 \lsb= s-b
  \Sub\ls\lc\lsc%                 \lsc= s-c
}%
\def\@sankakkei#1#2#3{%
%  \edef\@tmp{#1#2}\expandafter\Distance\@tmp\lc%  \lc = 辺 AB の長さ
%  \edef\@tmp{#2#3}\expandafter\Distance\@tmp\la%  \la = 辺 BC の長さ
%  \edef\@tmp{#1#3}\expandafter\Distance\@tmp\lb%  \lb = 辺 CA の長さ
  \Kyori{#1}{#2}\lc\Kyori{#2}{#3}\la\Kyori{#3}{#1}\lb
  \Add\la\lb\ls\Add\ls\lc\ls\@Div\ls{2}\ls%    \ls = s
  \Sub\ls\la\lsa%                 \lsa= s-a
  \Sub\ls\lb\lsb%                 \lsb= s-b
  \Sub\ls\lc\lsc%                 \lsc= s-c
  \vecXY{#1}\@ai\@aii
  \vecXY{#2}\@bi\@bii
  \vecXY{#3}\@ci\@cii
  \def\menseki{0}%
  \Detii\@ci\@cii\@ai\@aii\Addself\menseki\Det@ans
  \Detii\@bi\@bii\@ci\@cii\Addself\menseki\Det@ans
  \Detii\@ai\@aii\@bi\@bii\Addself\menseki\Det@ans
  \@Div\menseki{2}\menseki@
  \AbsSign\menseki@\menseki\orienttriangle
%  \Mul\ls\lsa\menseki\Heihoukon\menseki\menseki
%  \Mul\lsb\lsc\@menseki\Heihoukon\@menseki\@menseki%
%  \Mul\menseki\@menseki\menseki
%  面積=\menseki \orienttriangel=+or\@empty
}%
%
% 三角形の面積（符号付）
%   \Menseki<#1>#2#3#4[#5]#6
%      #1 : perl を指定したときは，perl で計算
%      #2,#3,#4 : ３頂点
%      #5 : 符号(- or \empty) を受け取る制御綴
%      #6 : 面積（絶対値）を受け取る制御綴
%
\def\Menseki{\edef\by@perl{\by@perl@}\@ifnextchar<{\Menseki@}{\@Menseki}}%
\def\Menseki@<#1>{\setkeys{emP}{#1}\@Menseki}%
\def\@Menseki#1#2#3{\@ifnextchar[{\@@Menseki{#1}{#2}{#3}}{\@@Menseki{#1}{#2}{#3}[\empty]}}%
\def\@@Menseki#1#2#3[#4]#5{%
  \Subvec{#2}{#1}\msk@va\vecXY\msk@va\msk@a\msk@b
  \Subvec{#3}{#1}\msk@vb\vecXY\msk@vb\msk@c\msk@d
  \ifnum\by@perl=\z@
    \Mul\msk@a\msk@d\msk@s
    \Mul\msk@b\msk@c\msk@ss
    \Sub\msk@s\msk@ss\msk@s
    \@Div\msk@s{2}\msk@s
  \else
    \calcval[s]{((\msk@a)*(\msk@d)-(\msk@b)*(\msk@c))/2}\msk@s
  \fi
  \AbsSign\msk@s#5\msk@sign
  \ifx\empty#4\else\edef #4{\msk@sign}\fi
  \edef\by@perl{\by@perl@}%
}%
%
% 折れ線で囲まれた図形の面積
%
\def\MensekiP#1#2{%
  \CalcVal{%
    $tmpa="#1";
%
    $i=index($tmpa,",");
    $xo=substr($tmpa,1,$i-1);
    $tmpa=substr($tmpa,$i+1);
    $i=index($tmpa,")");
    $yo=substr($tmpa,0,$i);
    $tmpa=substr($tmpa,$i+1);
%
    $i=index($tmpa,",");
    $xi=substr($tmpa,1,$i-1);
    $tmpa=substr($tmpa,$i+1);
    $i=index($tmpa,")");
    $yi=substr($tmpa,0,$i);
    $tmpa=substr($tmpa,$i+1);
    $xi-=$xo;
    $yi-=$yo;
%
    $menseki=0;
    for ($i=index($tmpa,",");$i>=0;){
      $xii=substr($tmpa,1,$i-1);
      $tmpa=substr($tmpa,$i+1);
      $i=index($tmpa,")");
      $yii=substr($tmpa,0,$i);
      $xii-=$xo;
      $yii-=$yo;
      $menseki+=($xi*$yii-$xii*$yi)/2;
      $tmpa=substr($tmpa,$i+1);
      $xi=$xii;
      $yi=$yii;
      $i=index($tmpa,",");
    }
    printf FHNDL "\EMpercentchar s\string\n",$menseki;
  }#2
}
%
% ヘロンの公式
%
\def\Heron#1#2#3#4{%
    \CalcVal{%
      $a=(#1);
      $b=(#2);
      $c=(#3);
      $s=($a+$b+$c)/2;
      printf FHNDL "\@percent s",sqrt($s*($s-$a)*($s-$b)*($s-$c));
    }#4\relax
}%
%
% 三角形の回転符号
%   三角形#1#2#3が正の向きのとき#4の制御綴りに1が返る。
%
\def\trisign#1#2#3#4{%
  \Subvec{#2}{#1}\trisign@a\vecXY\trisign@a\trisign@ax\trisign@ay
  \Subvec{#3}{#1}\trisign@b\vecXY\trisign@b\trisign@bx\trisign@by
  \Mul\trisign@ax\trisign@by\trisign@c
  \Mul\trisign@ay\trisign@bx\trisign@d
  \Sub\trisign@c\trisign@d\trisign@s
  \ifdim\trisign@s\p@>0.0005\p@\edef#4{1}\else
  \ifdim\trisign@s\p@<-0.0005\p@\edef#4{-1}\else
  \edef#4{0}\fi\fi
}%
%
% 三角形の内角
%
% \naikaku<#1>#2#3#4#5
%   三角形#2#3#4 の内角#3を#5に返す
%   <perl>を指定したときは，emathPp.sty が必要
%
\def\naikaku{\@ifnextchar<{\@naikaku}{\@@naikaku}}%
\def\@@naikaku#1#2#3#4{%
  \Subvec{#1}{#2}\naikaku@u\Argvec\naikaku@u\naikaku@BA
  \Subvec{#3}{#2}\naikaku@v\Argvec\naikaku@v\naikaku@BC
  \Sub\naikaku@BC\naikaku@BA#4\relax
  \ifdim #4\p@<\z@\Mul{-1}{#4}#4\fi
  \ifdim #4\p@>180\p@\Sub{360}{#4}#4\fi
}%
\def\@naikaku<#1>#2#3#4#5{%
  \def\by@perl{\by@perl@}%
  \setkeys{emP}{#1}%
  \Subvec{#2}{#3}\naikaku@u\Argvec\naikaku@u\naikaku@BA
  \Subvec{#4}{#3}\naikaku@v\Argvec\naikaku@v\naikaku@BC
  \Sub\naikaku@BC\naikaku@BA#5\relax
  \ifdim #5\p@<\z@\Mul{-1}{#5}#5\fi
  \ifdim #5\p@>180\p@\Sub{360}{#5}#5\fi
  \def\by@perl{\by@perl@}%
}%
%
% 2辺夾角から第3辺の長さを求める．
% \yogen#1#2#3#4
%   c^2=a^2+b^2-2ab\cosC
% #1 = a
% #2 = b
% #3 = C
%   #4 = c を受け取るコントロールシーケンス
%\def\yogen#1#2#3#4{%
%  \Mul{#1}{#1}\yogen@c%
%  \Mul{#2}{#2}\yogen@cc%
%  \Add\yogen@c\yogen@cc\yogen@c
%  \DegRad{#3}\yogen@C
%  \Cos\yogen@C\yogen@cc
%  \Mul{#1}\yogen@cc\yogen@cc
%  \Mul{#2}\yogen@cc\yogen@cc
%  \Mul{2}\yogen@cc\yogen@cc
%  \Sub\yogen@c\yogen@cc\yogen@c
%  \Heihoukon\yogen@c\yogen@c
%  \edef#4{\yogen@c}}%
%
% 正弦定理
% \seigenR#1#2
%   #1 : a
%   #2 : A
%     外接円の直径が \lRR, 半径が \lR にセットされる．
% \Seigen[#1]#2#3
%   #2 : a
%   #3 : A（60分法） を受取るコントロールシーケンス
%   #1 = e のときは，角A（鋭角）を求める．（デフォルト）
%   #1 = d のときは，角A（鈍角）を求める．
% \seigen#1#2
%   #1 : A
%   #2 : a を受取るコントロールシーケンス
%
\def\seigenR#1#2{\DegRad{#2}\@kaku\Sin\@kaku\lR
  \@Div{#1}\lR\lRR\@Div\lRR2\lR}%
\def\seigen#1#2{\DegRad{#1}\seigen@tmp\Sin\seigen@tmp\seigen@tmp%
  \Mul\lRR\seigen@tmp\seigen@tmp\edef#2{\seigen@tmp}}%
\def\Seigen{\@ifnextchar[{\@Seigen}{\@Seigen[e]}}%
\def\@Seigen[#1]#2#3{\@Div{#2}\lRR\seigen@tmp%
  \if e#1\asin\seigen@tmp\seigen@tmp\else%
  \if d#1\asin\seigen@tmp\seigen@tmp\Sub{180}\seigen@tmp\seigen@tmp%
  \fi\fi%
  \edef#3{\seigen@tmp}}%
%
% 3辺の長さから角の余弦を求める．
% \Yogen[#1]#2#3#4#5
% cos(A)=(b^2+c^2-a^2)/(2bc)
%     #2=a, #3=b, #4=c 結果は #5 にセット
%     #1=a のときは角を求める．（単位は度）
\def\Yogen{\@ifnextchar[{\@Yogen}{\@Yogen[\empty]}}%
\def\@Yogen[#1]#2#3#4#5{%
%  \Mul{#3}{#3}\y@gen\Mul{#4}{#4}\@tmp\Add\y@gen\@tmp\y@gen%
%  \Mul{#2}{#2}\@tmp%
%  \Sub\y@gen\@tmp\y@gen\Mul{#3}{#4}\@tmp\Mul\@tmp{2}\@tmp%
%  \@Div\y@gen\@tmp\y@gen
  \Max{#2,#3,#4}\m@val
  \@Div{#2}\m@val\a@val
  \@Div{#3}\m@val\b@val
  \@Div{#4}\m@val\c@val
  \Mul\b@val\b@val\y@gen\Mul\c@val\c@val\@tmp\Addself\y@gen\@tmp
  \Mul\a@val\a@val\@tmp\Sub\y@gen\@tmp\y@gen
  \Mul\b@val\c@val\@tmp\Mul{2}\@tmp\@tmp
  \@Div\y@gen\@tmp\y@gen
  \ifx a#1\acos\y@gen\y@gen%
    \ifdim\y@gen pt<\z@\Add\y@gen{180}\y@gen\fi\fi
  \edef#5{\y@gen}}%
%
% 2辺夾角から第3辺の長さを求める．
% \yogen#1#2#3#4
% #1=b, #2=c, #3=A → a を#4にセットする．
%
\def\yogen#1#2#3#4{%
%  \Mul{#1}{#1}\yogen@tmp
%  \Mul{#2}{#2}\yogen@@tmp\Add\yogen@tmp\yogen@@tmp\yogen@tmp
%  \DegRad{#3}\yogen@@tmp\Cos\yogen@@tmp\yogen@@tmp
%  \Mul{2}\yogen@@tmp\yogen@@tmp
%  \Mul{#1}\yogen@@tmp\yogen@@tmp
%  \Mul{#2}\yogen@@tmp\yogen@@tmp
  \Max{#1,#2}\yogen@m
  \@Div{#1}\yogen@m\yogen@b
  \@Div{#2}\yogen@m\yogen@c
  \Mul\yogen@b\yogen@b\yogen@tmp
  \Mul\yogen@c\yogen@c\yogen@@tmp
  \Addself\yogen@tmp\yogen@@tmp
  \DegRad{#3}\yogen@@tmp\Cos\yogen@@tmp\yogen@@tmp
  \Mul\yogen@b\yogen@@tmp\yogen@@tmp
  \Mul\yogen@c\yogen@@tmp\yogen@@tmp
  \Mul{2}\yogen@@tmp\yogen@@tmp
  \Sub\yogen@tmp\yogen@@tmp\yogen@tmp
  \Heihoukon\yogen@tmp\yogen@tmp
  \Mul\yogen@m\yogen@tmp\yogen@tmp
  \edef#4{\yogen@tmp}}%
\def\FPyogen#1#2#3#4{%
  \fpcalcval{sqrt((#1)^2+(#2)^2-2*(#1)*(#2)*Degcos(#3))}#4\relax
}%
%
\def\yogenT#1#2#3#4#5{%
  \calcval{-RadDeg(atan2((#2)*Degsin(#3),#1-(#2)*Degcos(#3)))}\arg@A
  \Sub\arg@A{#3}\arg@B
  \rtenretu*{@A(#1,\arg@A);@B(#2,\arg@B)}
  \Put@nil\@A#4\@nil
  \Put@nil\@B#5\@nil
}%
%
%   \emathPut[#1]#2[#3](#4,#5)[#6]#7
%       #1 :
%            background=white 背景を白く塗る
%            kaiten    =ddd   文字を ddd度 回転する
%            houkou    =vvv          ベクトル vvv の方向に
%            fromP,to=Q              ベクトル PQ の方向に
%       #2 : 文字列を置く位置（座標）
%       #3 : r のときは，次の座標を極形式とみなす
%       (#4,#5) : 位置の修正ベクトル 【新設】単位必須
%       #6 : \makebox の [..] オプション
%       #7 : 文字列
%   \emathPut#1[#2]#3
%       #1 : 文字列を置く位置（座標）
%       #2 : 方角
%       #3 : 文字列
%
\edef\put@KM@{\empty}%
\def\putKM#1{\ifcase #1\edef\put@KM@{\empty}\or\edef\put@KM@{1}\fi}%
\edef\Put@math{0}%
\def\default@syaeisensyu{\hasen}%
\def\defsyaeisensyu#1{\def\default@syaeisensyu{#1}}%
%\def\emathPut{\edef\houi@opt{\empty}\edef\cPut@orgP{\empty}\emath@Put}%
\DeclareRobustCommand\emathPut{%
  \edef\houi@opt{\empty}\edef\cPut@orgP{\empty}\emath@Put}%
\def\emath@Put{\@ifnextchar[{\em@thPut}{\em@thPut[\empty]}}%
\def\em@thPut[#1]{%
  \define@key{emPut}{background}{\ifthenelse{\equal{##1}{white}}{%
    \edef\bg@white{1}}{}}%
  \define@key{emPut}{kaiten}{\edef\kaiten@kaku{##1}}%
  \define@key{emPut}{houkou}{\Argvec{##1}\kaiten@kaku}%
%  \define@key{emPut}{kuromaru}[1]{\def\put@kuromaru{##1}}%
  \define@key{emPut}{from}{\edef\houkou@from{##1}}%
  \define@key{emPut}{to}{\Subvec{##1}\houkou@from\houkou@v
    \Argvec\houkou@v\kaiten@kaku}%
  \define@key{emPut}{mathmode}[1]{\edef\Put@math{##1}}%
  \edef\kaiten@kaku{0}\edef\bg@white{0}%
%  \edef\put@kuromaru{0}%
  \ifx \empty #1\else\setkeys{emPut}{#1}\fi
  \@em@thPut}%
\def\@em@thPut#1{%
%\typeout{@em@thPut:arg1=#1}%
  \ifthenelse{\equal\empty\cPut@orgP}{\edef\cPut@orgP{#1}}{}%
  \@ifnextchar({\emathPut@{#1}}{\@emathPut{#1}}}%
\def\emathPut@#1(#2,#3){\@ifnextchar[{\@@emathPut{#1}(#2,#3)}{%
  \@@emathPut{#1}(#2,#3)[c]}}%
\def\@emathPut#1{%
  \@ifnextchar[{\@@emathPut@{#1}}{\@@@emathPut{#1}}}%
\def\@@emathPut#1(#2,#3)[#4]#5{{%
%\typeout{now! @@emathPut arg=#1(#2,#3)[#4]#5,mathmode=\Put@math}\mmmm%
    \Strchr{#4}{e}\em@tmp
    \ifnum\em@tmp>\z@\errmessage{emathPut:(#2,#3)[#4] is not allowed}\fi
    \Strchr{#4}{w}\em@tmp
    \ifnum\em@tmp>\z@\errmessage{emathPut:(#2,#3)[#4] is not allowed}\fi
    \Strchr{#4}{s}\em@tmp
    \ifnum\em@tmp>\z@\errmessage{emathPut:(#2,#3)[#4] is not allowed}\fi
    \Strchr{#4}{n}\em@tmp
    \ifnum\em@tmp>\z@\errmessage{emathPut:(#2,#3)[#4] is not allowed}\fi
    \ukansan{#2}\emathPut@u@pt
    \ukansan{#3}\v@pt
    \Addvec{#1}{(\emathPut@u@pt,\v@pt)}\@v
    \ifthenelse{\equal{\bg@white}{1}}{%
      \edef\bg@white{0}%
      \edef\kaiten@@kaku{\kaiten@kaku}\wPut\@v<\kaiten@@kaku>[#4]{#5}%
    }{%
      \ifdim\kaiten@kaku pt=\z@
%       \@@@emathPut\@v{\makebox(0,0)[#4]{\ifnum\Put@math>\z@\ensuremath{#5}\else#5\fi}}%
        \ifnum\Put@math>\z@
          \strstrchr{#5}{$}\Pm@tmp
          \ifnum\Pm@tmp>\z@
            \@@@emathPut\@v{\makebox(0,0)[#4]{#5}}%
          \else
            \@@@emathPut\@v{\makebox(0,0)[#4]{\ensuremath{#5}}}%
          \fi
        \else
          \@@@emathPut\@v{\makebox(0,0)[#4]{#5}}%
        \fi
      \else\edef\kaiten@@kaku{\kaiten@kaku}\@@@emathPut\@v{%
        \rotatebox{\kaiten@@kaku}{\makebox(0,0)[#4]{\ifnum\Put@math>\z@\ensuremath{#5}\else#5\fi}}}%
      \fi
    }%
% \ifnum\put@kuromaru>\z@\Kuromaru{#1}\edef\put@kuromaru{0}\fi
}}%
\def\@@@emathPut#1#2{%\edef\local@origin{#1}%
  \ifnum\Put@math>\z@
    \edef\put@tmp{#1}\expandafter\put\put@tmp{\ensuremath{#2}}%
  \else
    \ifnum\bg@white>\z@
      \edef\put@tmp{#1}\expandafter\put\put@tmp{\colorbox{white}{#2}}%
    \else
      \edef\put@tmp{#1}\expandafter\put\put@tmp{#2}%
    \fi
  \fi
% \edef\local@origin{(0,0)}%
  }%
\def\@@emathPut@#1[#2]{%
  \ifthenelse{\equal{#2}{r}}{\@@emathPut@r{#1}}{\@@emathPut@@{#1}[#2]}%
}%
\def\@@emathPut@r#1(#2,#3){%
    \DegRad{#3}\Rdef@T%
%   \Cos\Rdef@T\Rdef@x\templa=#2\relax\templa=\Rdef@x\templa%
%   \Sin\Rdef@T\Rdef@y\templb=#2\relax\templb=\Rdef@y\templb%
%    \emathPut@{#1}(\templa,\templb)%
    \ukansan{#2}\Rdef@r\Cos\Rdef@T\Rdef@x\Mulself\Rdef@x\Rdef@r
    \Sin\Rdef@T\Rdef@y\Mulself\Rdef@y\Rdef@r
    \emathPut@{#1}(\Rdef@x\unitlength,\Rdef@y\unitlength)}%
\def\@@emathPut@@#1[#2]{%
  \def\syaei@xpos{}\def\syaei@ypos{}%
  \define@key{emPut}{houi}{\edef\@houi{##1}}%
  \define@key{emPut}{xlabel}{\def\label@x{##1}}%
  \define@key{emPut}{ylabel}{\def\label@y{##1}}%
%  \define@key{emPut}{xpos}{\def\syaei@xpos{##1}}%
  \define@key{emPut}{xpos}{%
    \headchar{##1}\houi@h\houi@r
    \if [\houi@h
      \edef\syaei@xpos{##1}%
    \else\if (\houi@h
      \edef\syaei@xpos{##1}%
    \else
      \edef\syaei@xpos{[##1]}%
    \fi\fi}%
%  \define@key{emPut}{ypos}{\def\syaei@ypos{##1}}%
  \define@key{emPut}{ypos}{%
    \headchar{##1}\houi@h\houi@r
    \if [\houi@h
      \edef\syaei@ypos{##1}%
    \else\if (\houi@h
      \edef\syaei@ypos{##1}%
    \else
      \edef\syaei@ypos{[##1]}%
    \fi\fi}%
  \define@key{emPut}{syaei}[xy]{%
    \expandafter\@tfor\expandafter\@@c\expandafter:\expandafter=##1\do{%
      \if x\@@c\edef\syaei@x{1}\else
      \if y\@@c\edef\syaei@y{1}\fi\fi}}%
  \define@key{emPut}{syaeisensyu}{\def\syaeisensyu{##1}}%
  \define@key{emPut}{kuromaru}[1]{\edef\put@KM{##1}}%
  \define@key{emPut}{siromaru}[1]{\edef\put@SM{##1}}%
  \Strchr{#2}{=}\emP@tmp
  \ifnum\emP@tmp=\z@
    \emstrstr{#2}{syaei}%
    \ifnum\retval>\z@\edef\emP@tmp{1}\fi
  \fi
  \edef\put@KM{\put@KM@}%
  \ifthenelse{\emP@tmp>\z@}{%
    \edef\syaei@x{0}%
    \edef\syaei@y{0}%
    \edef\put@SM{\empty}%
    \edef\@houi{\empty}%
    \def\syaeisensyu{\default@syaeisensyu}%
    \vecXY{\cPut@orgP}\@Px\@Py
\edef\syaeiX{(\@Px,0)}%
\edef\syaeiY{(0,\@Py)}%
\edef\syaeix{\@Px}%
\edef\syaeiy{\@Py}%
%    \def\label@x{\@Px}%
%    \def\label@y{\@Py}%
\EMclip\@Px\label@x
\EMclip\@Py\label@y
    \setkeys{emPut}{#2}%
%    \ifthenelse{\equal{\@Px}{0}}{\edef\syaei@y{0}}{}% 2012/12/20 保留
%    \ifthenelse{\equal{\@Py}{0}}{\edef\syaei@x{0}}{}% BBS #11362
    {%\def\syaeisensyu{\dashline[40]{.1}}%
%\typeout{labelx=\meaning\label@x,labely=\meaning\label@y}$
\edef\put@kuromaru{0}%
      \ifnum\syaei@x>\z@
        \Abs\@Py\@tmp
        \ifdim\@tmp\p@>\emLlim\p@
          \put(0,0){\syaeisensyu(\@Px,0)(\@Px,\@Py)}%
        \fi
        {\ifx\empty\syaei@xpos
          \ifdim\@Py pt>\z@\def\syaei@xpos{[s]}\else\def\syaei@xpos{[n]}\fi
         \fi
         \edef\emPut@tmp{{(\@Px,0)}\syaei@xpos}%
         \expandafter\emathPut\emPut@tmp{$\label@x$}%
        }%
      \fi%
      \ifnum\syaei@y>\z@\put(0,0){\syaeisensyu(\@Px,\@Py)(0,\@Py)}%
        {\ifx\empty\syaei@ypos
          \ifdim\@Px pt>\z@\def\syaei@ypos{[w]}\else\def\syaei@ypos{[e]}\fi
         \fi
         \edef\emPut@tmp{{(0,\@Py)}\syaei@ypos}%
         \expandafter\emathPut\emPut@tmp{$\label@y$}%
        }%
      \fi
      \ifx\empty\put@KM
      \else
        \ifthenelse{\equal\put@KM{1}}{%
          \Kuromaru\cPut@orgP
        }{%
          \expandafter\Kuromaru\put@KM{\cPut@orgP}%
        }%
      \fi
      \ifx\empty\put@SM
      \else
        \ifthenelse{\equal\put@SM{1}}{%
          \Siromaru\cPut@orgP
        }{%
          \expandafter\Siromaru\put@SM{\cPut@orgP}%
        }%
      \fi
    }%
    \ifthenelse{\equal{\@houi}{\empty}}{\emathPut{#1}}{%
      \@@emathPut@@@{#1}[\@houi]}%
  }{\@@emathPut@@@{#1}[#2]}}%
\def\@@emathPut@@@#1[#2]#3{%
  \edef\h@ukou{0}%
  \expandafter\@tfor\expandafter\@@c\expandafter:\expandafter=#2\do{%
    \if n\@@c\IAdd\h@ukou{7}\h@ukou\else
    \if s\@@c\IAdd\h@ukou{4}\h@ukou\else
    \if e\@@c\IAdd\h@ukou{1}\h@ukou\else
    \if w\@@c\IAdd\h@ukou{-1}\h@ukou\else
    \if c\@@c\IAdd\h@ukou{100}\h@ukou\else
    \if [\@@c\else
    \if ]\@@c\else
\edef\h@ukou{1000}%
%    \errmessage{emathPut : 方位の指定が異常です:[#2]}%
    \fi\fi\fi\fi\fi\fi\fi
  }%
\ifnum\h@ukou=1000\relax
  \edef\emp@tmp{{#1}#2{#3}}%
%\typeout{goto emathPut: arg=\emp@tmp}%
  \expandafter\@@emathPut\emp@tmp
\else
  \ifnum\h@ukou=100\relax
    \@@emathPut{#1}(0,0)[c]{#3}%
  \else
    \ifnum\h@ukou=\m@ne\edef\h@ukou{2}\fi
    \ifcase\h@ukou
      \@@emathPut{#1}(0,2pt)[c]{#3}%
    \or%  1 東
      \@@emathPut{#1}(0,0)[l]{\,#3}%
    \or%  2 西
      \@@emathPut{#1}(0,0)[r]{#3\,}%
    \or%  3 南西
      \@@emathPut{#1}(-1.4pt,-1.4pt)[rt]{#3}%
    \or%  4 南
      \@@emathPut{#1}(0,-2pt)[ct]{#3}%
    \or%  5 南東
      \@@emathPut{#1}(1.4pt,-1.4pt)[lt]{#3}%
    \or%  6 北西
      \@@emathPut{#1}(-1.4pt,1.4pt)[rb]{#3}%
    \or%  7 北
      \@@emathPut{#1}(0,2pt)[cb]{#3}%
    \or%  8 北東
      \@@emathPut{#1}(1.4pt,1.4pt)[lb]{#3}%
    \else
      \errmessage{emathPut : 方位の指定が異常です:[#2]}%
    \fi%
  \fi
% \ifnum\put@kuromaru>\z@\Kuromaru{#1}\edef\put@kuromaru{0}\fi
\fi
}%
%
\define@key{emPzM}{memori}[1]{\def\put@memorisen{#1}}%
\define@key{emPzM}{memorisen}[1]{\def\put@memorisen{#1}}%
\define@key{emPzM}{kuromaru}[1]{\edef\put@kuromaru{#1}}%
\define@key{emPzM}{siromaru}[1]{\let\@nahudaKuromaru\Siromaru
                                \Siromarulinewidth{.3pt}%
                                \edef\put@siromaru{#1}%
                                \edef\put@kuromaru{#1}}%
%
\def\xPut@houi{[s]}%
\def\xPuthoui#1{\edef\xPut@houi{#1}}%
\def\yPut@houi{[w]}%
\def\yPuthoui#1{\edef\yPut@houi{#1}}%
%
\def\xPut@sub{\@ifnextchar[{\@xPut@sub}{\@xPut@sub[\empty]}}%
\def\@xPut@sub[#1]#2\@nil{%
  \Strsep{#2}{(}\xPut@sub@P\xPut@sub@opt
  \strchr\xPut@sub@opt{,}\xPut@sub@tmp
  \ifnum\xPut@sub@tmp=\z@
    \edef\xPut@sub@P{#2}%
    \edef\xPut@sub@opt{\empty}%
  \fi
  \ifx\empty\xPut@sub@opt
    \Strsep{#2}{[}\xPut@sub@P\xPut@sub@opt
\ifnum\by@perl@retu>\z@
  \calcval[s]{\xPut@sub@P}\xPut@x
\else
  \strip@kakko\xPut@sub@P\xPut@sub@P@
  \isnumber{\xPut@sub@P@}{%
    \edef\xPut@x{\xPut@sub@P@}%
  }{%
    \fpcalcval{\xPut@sub@P}\xPut@x
  }%
\fi
    \ifx\empty\xPut@sub@opt
      \ifx\empty #1\relax
        \EMedef\xPut@l{\xPut@x}%
      \else
        \EMedef\xPut@l{#1}%
      \fi
      \EMedef\xPut@tmp{%
%        {(\xPut@x,0)}[s]{{\xPut@l}}}%
        {(\xPut@x,0)}\xPut@houi{\xPut@l}}%
    \else
      \ifx\empty #1\relax
        \EMedef\xPut@l{\xPut@x}%
      \else
        \EMedef\xPut@l{#1}%
      \fi
      \EMedef\xPut@tmp{%
        {(\xPut@x,0)}[\xPut@sub@opt{\xPut@l}}%
    \fi
  \else
\ifnum\by@perl@retu>\z@
  \calcval[s]{\xPut@sub@P}\xPut@x
\else
  \edef\xPut@x{\xPut@sub@P}%
\fi
    \ifx\empty #1\relax
      \EMedef\xPut@l{\xPut@x}%
    \else
      \EMedef\xPut@l{#1}%
    \fi
    \EMedef\xPut@tmp{%
      {(\xPut@x,0)}(\xPut@sub@opt{\xPut@l}}%
  \fi
  \ifnum\put@kuromaru>\z@\@nahudaKuromaru{(\xPut@x,0)}\fi
\ifnum\put@memorisen>\z@
  \Drawline<linethickness=.3pt>{(\xPut@x,\memori@nagasayi)(\xPut@x,\memori@nagasayii)}%
\fi
%\typeout{Put=\meaning\@nahudaPut, xPut@tmp=\meaning\xPut@tmp}%\xxxxx
  \expandafter\@nahudaPut\xPut@tmp
}%
\def\xPut{\begingroup%
  \edef\Put@math{1}%
  \ifnum\EMps@mode=\@ne
    \let\@nahudaPut\cPut
  \else
    \let\@nahudaPut\emathPut
  \fi
  \let\@nahudaKuromaru\Kuromaru
  \edef\put@kuromaru{0}%
  \edef\put@memorisen{0}%
  \edef\by@perl{\by@perl@}%
  \edef\by@perl@retu{\by@perl@}%
  \Strsep{\def@memori@nagasa}{,}\memori@nagasai\memori@nagasaii
  \uxkansan\memori@nagasai\memori@nagasaxi
  \uykansan\memori@nagasai\memori@nagasayi
  \ifx\empty\memori@nagasaii
    \let\memori@nagasaxii\memori@nagasaxi
    \let\memori@nagasayii\memori@nagasayi
    \edef\memori@nagasaxi{-\memori@nagasaxii}%
    \edef\memori@nagasayi{-\memori@nagasayii}%
  \else
    \uxkansan\memori@nagasaii\memori@nagasaxii
    \uykansan\memori@nagasaii\memori@nagasayii
  \fi
  \@ifnextchar<{\xPut@}{\@xPut}}%
\def\xPut@<#1>{\setkeys{emPzM}{#1}%
  \edef\by@perl@retu{\by@perl}\edef\by@perl{\by@perl@}%
  \@xPut}%
\def\@xPut#1{%
  \trim{#1}\to\xPut@b
  \Cfor{\Strsep\xPut@b{;}\xPut@a\xPut@b}%
       {\not\equal\xPut@a\empty}%
       {\Strsep\xPut@b{;}\xPut@a\xPut@b}%
    \do{%
      \expandafter\xPut@sub\xPut@a\@nil
    }%
  \endgroup
}%
%
%
%
\def\yPut@sub{\@ifnextchar[{\@yPut@sub}{\@yPut@sub[\empty]}}%
\def\@yPut@sub[#1]#2\@nil{%
  \Strsep{#2}{(}\yPut@sub@P\yPut@sub@opt
  \strchr\yPut@sub@opt{,}\yPut@sub@tmp
  \ifnum\yPut@sub@tmp=\z@
    \edef\yPut@sub@P{#2}%
    \edef\yPut@sub@opt{\empty}%
  \fi
  \ifx\empty\yPut@sub@opt
    \Strsep{#2}{[}\yPut@sub@P\yPut@sub@opt
\ifnum\by@perl@retu>\z@
  \calcval[s]{\yPut@sub@P}\yPut@y
\else
  \strip@kakko\yPut@sub@P\yPut@sub@P@
  \isnumber{\yPut@sub@P@}{%
    \edef\yPut@y{\yPut@sub@P@}%
  }{%
    \fpcalcval\yPut@sub@P\yPut@y
  }%
\fi
    \ifx\empty\yPut@sub@opt
      \ifx\empty #1\relax
        \EMedef\yPut@l{\yPut@y}%
      \else
        \EMedef\yPut@l{#1}%
      \fi
      \EMedef\yPut@tmp{%
        {(0,\yPut@y)}\yPut@houi{\yPut@l}}%
    \else
      \ifx\empty #1\relax
        \EMedef\yPut@l{\yPut@y}%
      \else
        \EMedef\yPut@l{#1}%
      \fi
      \EMedef\yPut@tmp{%
        {(0,\yPut@y)}[\yPut@sub@opt{\yPut@l}}%
    \fi
  \else
\ifnum\by@perl@retu>\z@
  \calcval[s]{\yPut@sub@P}\yPut@y
\else
  \edef\yPut@y{\yPut@sub@P}%
\fi
    \ifx\empty #1\relax
      \EMedef\yPut@l{\yPut@y}%
    \else
      \EMedef\yPut@l{#1}%
    \fi
    \EMedef\yPut@tmp{%
      {(0,\yPut@y)}(\yPut@sub@opt{\yPut@l}}%
  \fi
  \ifnum\put@kuromaru>\z@\@nahudaKuromaru<linethickness=.3pt>{(0,\yPut@y)}\fi
\ifnum\put@memorisen>\z@
  \Drawline<linethickness=.3pt>{(\memori@nagasaxi,\yPut@y)(\memori@nagasaxii,\yPut@y)}%
\fi
  \expandafter\@nahudaPut\yPut@tmp
}%
\def\yPut{\begingroup%
  \edef\Put@math{1}%
  \edef\put@kuromaru{0}%
  \edef\put@memorisen{0}%
  \edef\by@perl{\by@perl@}%
  \edef\by@perl@retu{\by@perl@}%
  \let\@nahudaKuromaru\Kuromaru
  \Strsep{\def@memori@nagasa}{,}\memori@nagasai\memori@nagasaii
  \uxkansan\memori@nagasai\memori@nagasaxi
  \uykansan\memori@nagasai\memori@nagasayi
  \ifx\empty\memori@nagasaii
    \let\memori@nagasaxii\memori@nagasaxi
    \let\memori@nagasayii\memori@nagasayi
    \edef\memori@nagasaxi{-\memori@nagasaxii}%
    \edef\memori@nagasayi{-\memori@nagasayii}%
  \else
    \uxkansan\memori@nagasaii\memori@nagasaxii
    \uykansan\memori@nagasaii\memori@nagasayii
  \fi
  \@ifnextchar<{\yPut@}{\@yPut}}%
\def\yPut@<#1>{\setkeys{emPzM}{#1}%
  \edef\by@perl@retu{\by@perl}\edef\by@perl{\by@perl@}%
  \@yPut}%
\def\@yPut#1{%
  \ifnum\EMps@mode=\@ne
    \let\@nahudaPut\cPut
  \else
    \let\@nahudaPut\emathPut
  \fi
  \trim{#1}\to\yPut@b
  \Cfor{\Strsep\yPut@b{;}\yPut@a\yPut@b}%
       {\not\equal\yPut@a\empty}%
       {\Strsep\yPut@b{;}\yPut@a\yPut@b}%
    \do{%
%\typeout{goto yPut@sub:arg=\yPut@a}%
      \expandafter\yPut@sub\yPut@a\@nil
    }%
  \endgroup
}%
%
% 背景を白く塗りつぶして文字列を配置する。
% \wPut#1<#2>[#3]#4
%   #1 : 基準点
%   #2 : 回転角
%   #3 : 配置     c|l|r|t|b|lt|lb|rt|rb
%   #4 : 文字列
%
\def\wPut#1{\@ifnextchar<{\@wPut{#1}}{%
  \@wPut{#1}<0>}}%
\def\@wPut#1<#2>{\@ifnextchar[{\@@wPut{#1}<#2>}{%
  \@@wPut{#1}<#2>[c]}}%
\def\@@wPut#1<#2>[#3]#4{{\@em@thPut{#1}{%
  \unitlength1pt%
  \begin{picture}(0,0)%
  \setbox0=\hbox{#4}%
  \@tempdima\wd0\divide\@tempdima2\relax
  \@tempdimb\ht0\advance\@tempdimb\dp0\divide\@tempdimb 2\relax
  \advance\@tempdima\fboxsep
  \advance\@tempdimb\fboxsep
  \tenretu*{%
    wP@A(-\strip@pt\@tempdima,-\strip@pt\@tempdimb);
    wP@B(\strip@pt\@tempdima,-\strip@pt\@tempdimb);
    wP@C(\strip@pt\@tempdima,\strip@pt\@tempdimb);
    wP@D(-\strip@pt\@tempdima,\strip@pt\@tempdimb)}%
  \edef\wP@P{(0,0)}\edef\wP@@P{(0,0)}%
  \expandafter\@tfor\expandafter\wP@@c\expandafter:\expandafter=#3\do{%
    \if l\wP@@c\Rdef(\strip@pt\@tempdima,#2)\wP@P%    l
    \else\if r\wP@@c\Rdef(-\strip@pt\@tempdima,#2)\wP@P%    r
    \else\if b\wP@@c\Add{90}{#2}\wP@vy
      \Rdef(\strip@pt\@tempdimb,\wP@vy)\wP@@P% b
    \else\if t\wP@@c\Add{90}{#2}\wP@vy
      \Rdef(-\strip@pt\@tempdimb,\wP@vy)\wP@@P% t
    \fi\fi\fi\fi}%
  \Addvec\wP@P\wP@@P\wP@P
  \ifthenelse{\equal{#2}{0}}{}{%
    \Rotvec\wP@A{#2}\wP@A
    \Rotvec\wP@B{#2}\wP@B
    \Rotvec\wP@C{#2}\wP@C
    \Rotvec\wP@D{#2}\wP@D}%
  \emathPut\wP@P{\Nuritubusi[0]{\wP@A\wP@B\wP@C\wP@D\wP@A}}%
  \ifthenelse{\equal{#2}{0}}{\emathPut\wP@P(0,0)[c]{\box0}}{%
    \emathPut\wP@P(0,0)[c]{\rotatebox{#2}{\box0}}}%
  \end{picture}}%
}}%
%
\def\nPut{\@ifnextchar[{\@nPut}{\@nPut[c]}}%
\def\@nPut[#1]#2{\emathPut{\csname #2\endcsname}[#1]{#2}}%
%
%   \sPut[#1]#2#3(#4,#5)[#6]#7
%       #1 : 比率 (0~1)
%       #2 : 始点
%       #3 : 終点
%       (#4,#5) : 位置の修正ベクトル 【新設】単位必須
%       #6 : \makebox の [..] オプション
%       #7 : 文字列
%   #2 かｒ #3 へ向かう線分の #1 倍の位置(\X)に，
%       \emathPut\X(#4,#5)[#6]#7 として文字列(#7)を置く．
%
\def\sPut{\@ifnextchar[{\@sPut}{\@sPut[.5]}}%
\def\@sPut[#1]#2#3{\Subvec{#3}{#2}\v@sPut\Mulvec{#1}\v@sPut\v@sPut%
    \Addvec{#2}\v@sPut\v@sPut%
    \emathPut\v@sPut}%
%\def\@sPut[#1]#2#3{\@ifnextchar({\@@sPut[#1]{#2}{#3}}{%
%    \@@sPut[#1]{#2}{#3}(0,0)}}%
%\def\@@sPut[#1]#2#3(#4,#5){\@ifnextchar[{\@@@sPut[#1]{#2}{#3}(#4,#5)}{%
%    \@@@sPut[#1]{#2}{#3}(#4,#5)[c]}}%
%\def\@@@sPut[#1]#2#3(#4,#5)[#6]#7{%
%    \Subvec{#3}{#2}\v@sPut\Mulvec{#1}\v@sPut\v@sPut%
%    \Addvec{#2}\v@sPut\v@sPut%
%    \emathPut\v@sPut(#4,#5)[#6]{#7}}%
%
% \PutStr#1[#2]#3to[#4]#5
%   #1 : 文字列を置く位置
%   #2 : #1 から見ての方位（デフォルト = e ）
%   #3 : 文字列
%   #4 : 文字列から出る矢印を円弧にしたいときはその半径を指定する。
%           key=val
%             arrowheadsize=..
%             hankei=.. （矢印円弧の半径--無名数）
%             Hankei=.. （矢印円弧の半径--単位つき）
%             addvec=.. （終点の修正ベクトル）成分は単位付の数値
%                           r(dx,dy)のときは，極座標形式
%             enkoH=.. （円弧の中点と弦との距離）
%             arc=ellipse/Ellipse
%   #5 : 文字列から出る矢印の終点
% \PutStr#1(#2,#3)[#4]#5to[#6]#7
%   #1〜#5 : \Put 文と同じ
%   #6 : 文字列から出る矢印を円弧にしたいときはその半径を指定する。
%           key=val
%             hankei=.. （矢印円弧の半径）
%             addvec=.. （終点の修正ベクトル）成分は単位付の数値
%   #7 : 文字列から出る矢印の終点
%
\def\PutStr{\edef\PutStr@hen{\empty}\@ifstar{\PutStr@a}{\PutStr@b}}%
\def\PutStr@a#1{\edef\PutStr@hen{#1}\PutStr@b{#1}}%
\def\PutStr@b#1{%
  \@ifnextchar({\PutStr@{#1}}{\@PutStr@{#1}}}%
\def\@PutStr@#1{\@ifnextchar[{\@PutStr{#1}}{\@PutStr{#1}[e]}}%
\def\@PutStr#1[#2]#3to{\@ifnextchar[{\@@PutStr{#1}[#2]#3to}{%
  \@@PutStr{#1}[#2]#3to[0]}}%
\def\@@PutStr#1[#2]#3to[#4]#5{%
  \ifx\empty\PutStr@hen
    \edef\PutStr@s{#1}%
  \else
    \Addvec*{#5}\PutStr@hen\PutStr@s
  \fi
  \emathPut{\PutStr@s}[#2]{#3}%
  \@@@PutStr[#4]{#5}}%
%\def\@@PutStr#1[#2]#3to[#4]#5{\emathPut{#1}[#2]{#3}%
%  \ifthenelse{\equal{#4}{0}}{\ArrowLine{#1}{#5}}{\ArrowArc{#4}{#1}{#5}}}%
% \if 0#4\relax\ArrowLine{#1}{#5}\else\ArrowArc{#4}{#1}{#5}\fi}%
\def\PutStr@#1(#2,#3){\@ifnextchar[{\PutStr@@{#1}(#2,#3)}{%
  \PutStr@@{#1}(#2,#3)[l]}}%
\def\PutStr@@#1(#2,#3)[#4]#5to{\@ifnextchar[{\PutStr@@@{#1}(#2,#3)[#4]#5to}{%
  \PutStr@@@{#1}(#2,#3)[#4]#5to[0]}}%
\def\PutStr@@@#1(#2,#3)[#4]#5to[#6]#7{%
  \ifx\empty\PutStr@hen
      \edef\PutStr@s{#1}%
  \else
    \Addvec*{#7}\PutStr@hen\PutStr@s
  \fi
  \emathPut{\PutStr@s}(#2,#3)[#4]{#5}%
  \@@@PutStr[#6]{#7}}%
%\def\PutStr@@@#1(#2,#3)[#4]#5to[#6]#7{%
%  \emathPut{#1}(#2,#3)[#4]{#5}%
%  \if 0#6\relax\ArrowLine{#1}{#7}\else\ArrowArc{#6}{#1}{#7}\fi}%
\def\@@@PutStr[#1]#2{{%
  \ifnum\EMps@mode=\@ne\gsave\fi
  \def\PutStr@r{0}%
  \def\PutStr@v{(0,0)}%
  \edef\PutStr@arc{\empty}%
%  \edef\yazirusi@opt{\empty}%
  \define@key{emP}{hankei}{\def\PutStr@r{##1}}%
  \define@key{emP}{Hankei}{\ukansan{##1}\PutStr@r}%
  \define@key{emP}{arc}{\def\PutStr@arc{##1}}%
  \define@key{emP}{bezier}{\def\PutStr@arc{bezier}%
    \Strsep{##1}{>}\bz@opt\bz@arg
    \ifthenelse{\equal\bz@arg\empty}{%
      \EMedef\bz@opt{<\empty>}\EMedef\bz@arg{{##1}}%
    }{%
      \edef\bz@opt{\bz@opt>}%
      \edef\bz@arg{{\bz@arg}}%
    }%
  }%
  \define@key{emP}{enkoH}{\ukansan{##1}\PutStr@h
    \Kyori\PutStr@s{#2}\PutStr@l
    \@Div\PutStr@l{2}\PutStr@lh
    \Kyorii{(0,0)}{(\PutStr@lh,\PutStr@h)}\PutStr@r
    \@Div\PutStr@r\PutStr@h\PutStr@r
    \@Div\PutStr@r{2}\PutStr@r
  }%
  \define@key{emP}{addvec}{\edef\addvec@arg{##1}%
    \headchar{\addvec@arg}\addvec@a\addvec@b
    \ifthenelse{\equal\addvec@a{r}}{%
    \strchr\addvec@b{*}\PutStr@tmp
      \ifnum\PutStr@tmp>\z@
        \Subvec\PutStr@s{#2}\PutStr@v
        \Argvec\PutStr@v\PutStr@arg
        \substitute\addvec@b{*}\PutStr@arg\addvec@b
      \fi
      \vecXY{\addvec@b}\addvec@r\addvec@arg
      \ukansan\addvec@r\addvec@r
      \DegCos\addvec@arg\addvec@x\Mul\addvec@r\addvec@x\addvec@x
      \DegSin\addvec@arg\addvec@y\Mul\addvec@r\addvec@y\addvec@y
      \@ifundefined{@xscale}{}{%
        \@Div\addvec@x\@xscale\addvec@x
        \@Div\addvec@y\@yscale\addvec@y
      }%
    }{%
      \vecXY{\addvec@arg}\addvec@x\addvec@y
      \uxkansan\addvec@x\addvec@x
      \uykansan\addvec@y\addvec@y
    }%
    \edef\PutStr@v{(\addvec@x,\addvec@y)}%
  }%
  \def\arrow@headsize{1}%
  \Strchr{#1}{=}\PutStr@tmp
  \ifnum\PutStr@tmp>\z@\setkeys{emP}{#1}\else\def\PutStr@r{#1}\fi
  \changeArrowHeadSize{\arrow@headsize}%
  \Addvec{#2}\PutStr@v\PutStr@v
  \ifthenelse{\equal\PutStr@r{0}}{%
    \ifthenelse{\equal\PutStr@arc{bezier}}{%
      \edef\PutStr@tmp{\bz@opt{\PutStr@s}{\PutStr@v}\bz@arg}%
      \expandafter\emRbezier\PutStr@tmp
    }{%
      \ifthenelse{\equal\PutStr@arc{ellipse}}{%
        \vecXY\PutStr@s\PutStr@sx\PutStr@sy
        \vecXY\PutStr@v\PutStr@vx\PutStr@vy
        \Sub\PutStr@vx\PutStr@sx\PutStr@a
        \Sub\PutStr@vy\PutStr@sy\PutStr@b
        \Abs\PutStr@a\PutStr@aa
        \Abs\PutStr@b\PutStr@bb
        \ifthenelse{\lengthtest{\PutStr@a\p@>\z@}}{%
          \ifthenelse{\lengthtest{\PutStr@b\p@>\z@}}{%
            \Put{(\PutStr@sx,\PutStr@vy)}{\Daenko\PutStr@aa\PutStr@bb{-90}{0}}%
          }{%
            \Put{(\PutStr@sx,\PutStr@vy)}{\Daenko\PutStr@aa\PutStr@bb{0}{90}}%
          }%
        }{%
          \ifthenelse{\lengthtest{\PutStr@b\p@>\z@}}{%
            \Put{(\PutStr@sx,\PutStr@vy)}{%
              \Daenko\PutStr@aa\PutStr@bb{-180}{-90}}%
          }{%
            \Put{(\PutStr@sx,\PutStr@vy)}{%
              \Daenko\PutStr@aa\PutStr@bb{90}{180}}%
          }%
        }%
      }{%
        \ifthenelse{\equal\PutStr@arc{Ellipse}}{%
          \vecXY\PutStr@s\PutStr@sx\PutStr@sy
          \vecXY\PutStr@v\PutStr@vx\PutStr@vy
          \Sub\PutStr@vx\PutStr@sx\PutStr@a
          \Sub\PutStr@vy\PutStr@sy\PutStr@b
          \Abs\PutStr@a\PutStr@aa
          \Abs\PutStr@b\PutStr@bb
          \ifthenelse{\lengthtest{\PutStr@a\p@>\z@}}{%
            \ifthenelse{\lengthtest{\PutStr@b\p@>\z@}}{%
              \Put{(\PutStr@vx,\PutStr@sy)}{%
                \Daenko\PutStr@aa\PutStr@bb{90}{180}}%
            }{%
              \Put{(\PutStr@vx,\PutStr@sy)}{%
                \Daenko\PutStr@aa\PutStr@bb{-180}{-90}}%
            }%
          }{%
            \ifthenelse{\lengthtest{\PutStr@b\p@>\z@}}{%
              \Put{(\PutStr@vx,\PutStr@sy)}{%
                \Daenko\PutStr@aa\PutStr@bb{0}{90}}%  
            }{%
              \Put{(\PutStr@vx,\PutStr@sy)}{%
                \Daenko\PutStr@aa\PutStr@bb{-90}{0}}%
            }%
          }%
        }{%
          \ifx\empty\yazirusi@opt
            \ArrowLine{\PutStr@s}{\PutStr@v}%
          \else
            \if r\yazirusi@opt
              \ArrowLine{\PutStr@v}{\PutStr@s}%
            \else
              \ArrowLine{\PutStr@s}{\PutStr@v}%
            \fi
          \fi
        }%
      }%
    }%
  }{%
    \ArrowArc{\PutStr@r}{\PutStr@s}{\PutStr@v}%
  }%
  \ifnum\EMps@mode=\@ne\grestore\fi
}}%
%
\def\putstr(#1,#2){\PutStr*{(#1,#2)}}%
%
% \drawline 縦書きに対応するためのパッチ
\if0
\def\@spdrawline(#1,#2)(#3,#4){%
  \iftdir
   \@absspdrawline(#2\unitlength,-#1\unitlength)(#4\unitlength,-#3\unitlength)\else
   \@absspdrawline(#1\unitlength,#2\unitlength)(#3\unitlength,#4\unitlength)\fi
   \ignorespaces
}%
\fi
%
\@ifundefined{em@dvipdfm}{}{%
\def\@paspecial#1#2{\iftdir\edef\@pasp@y{#1}%
  \ifnum #2>\z@\edef\@pasp@x{-#2}\else\IAbs{#2}\@pasp@x\fi%
  \special{pa \@pasp@x\space\@pasp@y}\else%
  \special{pa #1 #2}\fi}%
%
\def\line(#1,#2)#3{%
\@xarg #1\relax \@yarg #2\relax\@linelen=#3\unitlength
\iftdir%
  \ifnum #1=\z@\else\ifnum #2=\z@\else
    \@xarg #2\relax \@yarg -#1\relax%
    \@tempdima=#3\unitlength\divide\@tempdima #1\relax%
    \multiply\@tempdima #2\relax%
    \ifdim\@tempdima<\z@\@tempdima=-\@tempdima\fi%
    \@linelen=\@tempdima%
  \fi\fi%
\fi%
\ifnum\@xarg =0\relax \@vline%
  \else \ifnum\@yarg =0\relax\@hline \else \@ssline\fi%
\fi}%
}%
%
% 等間隔に文字を配置
%
\def\emDL@char{\picsquare}%
\def\emDL@gap{3pt}%
\def\emDottedlineGap#1{\def\emDL@gap{#1}}%
\def\emDottedlineChar#1{\def\emDL@char{#1}}%
%
\define@key{emDL}{G}{\def\emDL@gap{#1}}%
\define@key{emDL}{C}{\def\emDL@char{#1}}%
%
\def\emDottedline{\@ifnextchar<{\@emDottedline}{\@emDottedline<\empty>}}%
\def\@emDottedline<#1>#2{{%
  \ifx\empty #1\else\setkeys{emDL}{#1}\fi
%  \edef\emDL@tmp{#2}%
%  \expandafter\emdottedline\emDL@tmp\relax
  \exfor[;]\Dl@c:=#2\do{%
    \edef\emDL@tmps{\Dl@c}%
    \expandafter\emdottedline\emDL@tmps\relax
  }%
}}%
%
\def\emDottedlines{\@ifnextchar<{\@emDottedlines}{\@emDottedlines<\empty>}}%
\def\@emDottedlines<#1>#2{{%
  \ifx\empty #1\else\setkeys{emDL}{#1}\fi
  \exfor[;]\Dl@c:=#2\do{%
    \edef\emDL@tmps{\Dl@c}%
    \expandafter\emdottedline\emDL@tmps\relax
  }%
}}%
%
%\def\emdottedline{\begingroup\@ifnextchar<{\emdottedline@}{\emdottedline@@}}%
\DeclareRobustCommand\emdottedline{%
  \begingroup\@ifnextchar<{\emdottedline@}{\emdottedline@@}}%
\def\emdottedline@<#1>{\setkeys{emDL}{#1}\emdottedline@@}%
\def\emdottedline@@{\edef\emDL@c{0}\ukansan\emDL@gap\emDL@gap@\@emdottedline}%
%\def\emcdottedline{\edef\emDL@c{1}\ukansan\emDL@gap\emDL@gap@\@emdottedline}%
\def\emcdottedline{\begingroup\@ifnextchar<{\emcdottedline@}{\emcdottedline@@}}%
\def\emcdottedline@<#1>{\setkeys{emDL}{#1}\emcdottedline@@}%
\def\emcdottedline@@{\edef\emDL@c{1}\ukansan\emDL@gap\emDL@gap@\@emdottedline}%
\def\@emdottedline(#1,#2){\@ifnextchar({\@@emdottedline(#1,#2)}{\endgroup}}%
\def\@@emdottedline(#1,#2)(#3,#4){\@@@emdottedline{(#1,#2)}{(#3,#4)}\@emdottedline(#3,#4)}%
\def\@@@emdottedline#1#2{%0
  \Kyori{#1}{#2}\emDL@l
\ifdim\emDL@l\p@=\z@
\else
  \@Div\emDL@l\emDL@gap@\emDL@n
  \Int\emDL@n\emDL@n
%  \@Div\emDL@l\emDL@n\emDL@gap@%%%%%% (BBS #7406)
  \@Div{1}\emDL@n\emDL@d
  \Subvec{#2}{#1}\emDL@v
  \Mulvec\emDL@d\emDL@v\emDL@dv
  \edef\emDL@P{#1}%
%  \Ifor\emDL@i{0}{\emDL@n}\Do{%
%    \Put\emDL@P(0,0)[c]{\emDL@char}\Addvec\emDL@P\emDL@dv\emDL@P
%  }%
  \multido{\i@emDL=0+1}{\emDL@n}{\Put\emDL@P(0,0)[c]{\emDL@char}\Addvec\emDL@P\emDL@dv\emDL@P}%
  \ifdim\emDL@c\p@=\z@\Put{#2}(0,0)[c]{\emDL@char}\fi
  \Addvec\emDL@P\emDL@dv\emDL@P
\fi
}%
%
\edef\yazirusi@opt{\empty}%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% \Drawline<#1>#2
%   <#1> : <sensyu=\dashline[40]{.1}>などによる線種のローカルな変更
%    #2  : 点列
%\def\Drawline{\@ifnextchar<{\@Drawline}{\@Drawline<\empty>}}%
\DeclareRobustCommand\Drawline{\@ifnextchar<{\@Drawline}{\@Drawline<\empty>}}%
\def\@Drawline<#1>#2{{\edef\Drawline@tmp{#2}%
  \ifx\empty \Drawline@tmp\relax\else
    \edef\oval@r{0}%
    \edef\idou@v{\empty}%
    \edef\hamidasi@A{\empty}%
    \edef\hamidasi@B{\empty}%
    \edef\hen@i{\empty}%
    \edef\hen@ii{\empty}%
    \ifx \empty #1\else\setkeys{emP}{#1}\fi
    \ifdim\Arr@wHeadSize\p@=\z@\edef\yazirusi@opt{\empty}\fi
    \ifdim\arrow@headsize\p@=\z@\edef\yazirusi@opt{\empty}\fi
    \expandafter\makeTenHairetu\Drawline@tmp
%    \ifx\empty\hen@i\else
%      \Addvec*{\hairetu{TH@V}{1}}{\hen@i}\DR@tmpv
%      \edefhairetu{TH@V}{1}{\DR@tmpv}%
%      \edef\Drawline@tmp{\empty}%
%      \Cfor{\edef\DR@i{0}}{\DR@i<\TH@N}{}\do{%
%        \Incr\DR@i
%        \edef\DR@tmpv{\hairetu{TH@V}{\DR@i}}%
%        \edefappend\Drawline@tmp{\DR@tmpv}%
%      }%
%    \fi
%    \ifx\empty\hen@ii\else
%      \Addvec*{\hairetu{TH@V}{\TH@N}}{\hen@ii}\DR@tmpv
%      \edefhairetu{TH@V}{\TH@N}{\DR@tmpv}%
%      \edef\Drawline@tmp{\empty}%
%      \Cfor{\edef\DR@i{0}}{\DR@i<\TH@N}{}\do{%
%        \Incr\DR@i
%        \edef\DR@tmpv{\hairetu{TH@V}{\DR@i}}%
%        \edefappend\Drawline@tmp{\DR@tmpv}%
%      }%
%    \fi
    \ifx\empty\idou@v\else
      \edef\Drawline@tmp{\empty}%
      \Cfor{\edef\DR@i{0}}{\DR@i<\TH@N}{}\do{%
        \Incr\DR@i
        \Addvec{\hairetu{TH@V}{\DR@i}}{\idou@v}\DR@tmpv
        \edefappend\Drawline@tmp{\DR@tmpv}%
      }%
    \fi
    \ifthenelse{\equal\iro@\empty}{%
      \ifthenelse{\lengthtest{\oval@r\p@=\z@}}{%
        \ifthenelse{\equal{\yazirusi@opt}{\empty}}{%
          \put(0,0){\expandafter\sensyu\Drawline@tmp}%
        }{%
          \changeArrowHeadSize{\arrow@headsize}%
          \expandafter\makeTenHairetu\Drawline@tmp
          \ifthenelse{\equal\yazirusi@opt{r}}{%
            \edef\DR@A{\hairetu{TH@V}{1}}%
            \edef\DR@B{\hairetu{TH@V}{2}}%
            \Subvec\DR@A\DR@B\DR@BA\Put\DR@A{\yaziri\DR@BA}%
            \Addvec\DR@A\yaziri@@@M\DR@A@
            \Hamidasiten\DR@B\DR@A@{1pt}\DR@A@
            \Cfor{\edef\Drawline@tmp{\DR@A@}\edef\DR@i{1}}{\DR@i<\TH@N}{}\do{%
              \Incr\DR@i\edefappend\Drawline@tmp{\hairetu{TH@V}{\DR@i}}%
            }%
            \put(0,0){\expandafter\sensyu\Drawline@tmp}%
          }{%
            \ifthenelse{\equal{\yazirusi@opt}{a}}{%
              \edef\DR@A{\hairetu{TH@V}{\TH@N}}%
              \ISub\TH@N{1}\TH@Ni
              \edef\DR@B{\hairetu{TH@V}{\TH@Ni}}%
              \Subvec\DR@A\DR@B\DR@BA\Put\DR@A{\yaziri\DR@BA}%
              \Addvec\DR@A\yaziri@@@M\DR@A@
              \Hamidasiten\DR@B\DR@A@{1pt}\DR@A@
              \edef\Drawline@tmp{}%
              \Ifor\DR@i{1}{\TH@N}\Do{%
                \edefappend\Drawline@tmp{\hairetu{TH@V}{\DR@i}}}%
              \edefappend\Drawline@tmp{\DR@A@}%
              \put(0,0){\expandafter\sensyu\Drawline@tmp}%
            }{%
              \ifthenelse{\equal{\yazirusi@opt}{b}}{%
                \edef\DR@A{\hairetu{TH@V}{1}}%
                \edef\DR@B{\hairetu{TH@V}{2}}%
                \Subvec\DR@A\DR@B\DR@BA\Put\DR@A{\yaziri\DR@BA}%
                \Addvec\DR@A\yaziri@@@M\DR@A@
                \Hamidasiten\DR@B\DR@A@{1pt}\DR@A@
                \ISub\TH@N{1}\TH@Ni
                \Cfor{%
                  \edef\Drawline@tmp{\DR@A@}\edef\DR@i{1}}{\DR@i<\TH@Ni}{}\do
                {%
                    \Incr\DR@i\edefappend\Drawline@tmp{\hairetu{TH@V}{\DR@i}}%
                }%
                \edef\DR@A{\hairetu{TH@V}{\TH@N}}%
                \edef\DR@B{\hairetu{TH@V}{\TH@Ni}}%
                \Subvec\DR@A\DR@B\DR@BA\Put\DR@A{\yaziri\DR@BA}%
                \Addvec\DR@A\yaziri@@@M\DR@A@
                \Hamidasiten\DR@B\DR@A@{1pt}\DR@A@
                \edefappend\Drawline@tmp{\DR@A@}%
                \put(0,0){\expandafter\sensyu\Drawline@tmp}%
              }{}%
            }%
          }%
        }%
      }{%
        \@ovalDrawline\Drawline@tmp
      }%
    }{%
      \ifthenelse{\lengthtest{\oval@r\p@=\z@}}{%
        \ifthenelse{\equal{\yazirusi@opt}{\empty}}{%
          \put(0,0){\@iro{\iro@}\expandafter\sensyu\Drawline@tmp}%
        }{%
          \changeArrowHeadSize{\arrow@headsize}%
          \expandafter\makeTenHairetu\Drawline@tmp
          \ifthenelse{\equal\yazirusi@opt{r}}{%
            \edef\DR@A{\hairetu{TH@V}{1}}%
            \edef\DR@B{\hairetu{TH@V}{2}}%
            \Subvec\DR@A\DR@B\DR@BA\put(0,0){\@iro{\iro@}\Yaziri\DR@A\DR@BA}%
            \Addvec\DR@A\yaziri@@@M\DR@A@
            \Hamidasiten\DR@B\DR@A@{1pt}\DR@A@
            \Cfor{\edef\Drawline@tmp{\DR@A@}\edef\DR@i{1}}{\DR@i<\TH@N}{}\do{%
              \Incr\DR@i\edefappend\Drawline@tmp{\hairetu{TH@V}{\DR@i}}%
            }%
            \put(0,0){\@iro{\iro@}\expandafter\sensyu\Drawline@tmp}%
          }{%
            \ifthenelse{\equal{\yazirusi@opt}{a}}{%
              \edef\DR@A{\hairetu{TH@V}{\TH@N}}%
              \ISub\TH@N{1}\TH@Ni
              \edef\DR@B{\hairetu{TH@V}{\TH@Ni}}%
              \Subvec\DR@A\DR@B\DR@BA\put(0,0){\@iro{\iro@}\Yaziri\DR@A\DR@BA}%
              \Addvec\DR@A\yaziri@@@M\DR@A@
              \Hamidasiten\DR@B\DR@A@{1pt}\DR@A@
              \edef\Drawline@tmp{}%
              \Ifor\DR@i{1}{\TH@N}\Do{%
                \edefappend\Drawline@tmp{\hairetu{TH@V}{\DR@i}}}%
              \edefappend\Drawline@tmp{\DR@A@}%
              \put(0,0){\@iro{\iro@}\expandafter\sensyu\Drawline@tmp}%
            }{%
              \ifthenelse{\equal{\yazirusi@opt}{b}}{%
                \edef\DR@A{\hairetu{TH@V}{1}}%
                \edef\DR@B{\hairetu{TH@V}{2}}%
                \Subvec\DR@A\DR@B\DR@BA
                \put(0,0){\@iro{\iro@}\Yaziri\DR@A\DR@BA}%
                \Addvec\DR@A\yaziri@@@M\DR@A@
                \Hamidasiten\DR@B\DR@A@{1pt}\DR@A@
                \ISub\TH@N{1}\TH@Ni
                \Cfor{%
                  \edef\Drawline@tmp{\DR@A@}\edef\DR@i{1}}{\DR@i<\TH@Ni}{}\do
                {%
                  \Incr\DR@i\edefappend\Drawline@tmp{\hairetu{TH@V}{\DR@i}}%
                }%
                \edef\DR@A{\hairetu{TH@V}{\TH@N}}%
                \edef\DR@B{\hairetu{TH@V}{\TH@Ni}}%
                \Subvec\DR@A\DR@B\DR@BA
                \put(0,0){\@iro{\iro@}\Yaziri\DR@A\DR@BA}%
                \Addvec\DR@A\yaziri@@@M\DR@A@
                \Hamidasiten\DR@B\DR@A@{1pt}\DR@A@
                \edefappend\Drawline@tmp{\DR@A@}%
                \put(0,0){\@iro{\iro@}\expandafter\sensyu\Drawline@tmp}%
              }{}%
            }%
          }%
        }%
      }{%
        \put(0,0){\@iro{\iro@}\@ovalDrawline\Drawline@tmp}%
      }%
    }%
  \fi}\ignorespaces}%
\let\PhDrawline\Drawline
\def\@ovalDrawline#1{{%
  \edef\ovalD@r{\oval@r}%
  \edef\ovalD@y{\yazirusi@opt}%
  \edef\ovalD@tmp{#1}%
  \expandafter\makeTenHairetu\ovalD@tmp
  \edef\ovalD@A{\hairetu{TH@V}{1}}%
  \edef\ovalD@B{\hairetu{TH@V}{2}}%
  \edef\ovalD@D{\hairetu{TH@V}{3}}%
  \@Bunten\ovalD@B\ovalD@D11\ovalD@C
  \ovalcorner\oval@r\ovalD@A\ovalD@B\ovalD@C
  \ifthenelse{\equal\ovalD@y{r}\or\equal\ovalD@y{b}}{%
    \changeArrowHeadSize{\arrow@headsize}%
    \Subvec\ovalD@A\ovalD@B\ovalD@BA
    \Yaziri\ovalD@A\ovalD@BA
  }{}%
  \Cfor{\edef\ovalD@i{2}}{\ovalD@i<\TH@N}{}\do{%
    \Incr\ovalD@i
    \edef\ovalD@A{\ovalD@C}%
    \edef\ovalD@B{\ovalD@D}%
    \ifthenelse{\ovalD@i=\TH@N}{%
%      \Sensyu{\ovalD@A\ovalD@B}%
      \ifthenelse{\equal\ovalD@y{a}\or\equal\ovalD@y{b}}{%
        \changeArrowHeadSize{\arrow@headsize}%
        \Subvec\ovalD@B\ovalD@A\ovalD@AB
%        \Yaziri\ovalD@B\ovalD@AB
        \Put\ovalD@B{\yaziri\ovalD@AB}%
        \Addvec\ovalD@B\yaziri@@@M\ovalD@B@
        \Hamidasiten\ovalD@A\ovalD@B@{1pt}\ovalD@B
%        \Sensyu{\ovalD@A\ovalD@B}%
      }{%
      }%
      \Sensyu{\ovalD@A\ovalD@B}%
    }{%
      \IAdd\ovalD@i{1}\ovalD@j
      \edef\ovalD@D{\hairetu{TH@V}{\ovalD@j}}%
      \@Bunten\ovalD@B\ovalD@D11\ovalD@C
      \ovalcorner\ovalD@r\ovalD@A\ovalD@B\ovalD@C
    }%
  }%
}}%
%
\define@key{emP}{label}{\edef\label@name{#1}}%
\def\label@name{1}%
\def\setxyrange{\@ifnextchar<{\@setxyrange}{\@setxyrange<\empty>}}%
\def\@setxyrange<#1>{\@ifnextchar[{\@@setxyrange<#1>}{\@@setxyrange<#1>[\pszahyou@N]}}%
%\def\@setxyrange<#1>{\@ifnextchar[{\@@setxyrange<#1>}{\@@setxyrange<#1>[1]}}%
\def\@@setxyrange<#1>[#2]#3{{%
% -------------------------------------------------------------
  \define@key{emP}{circle}{\add@circle{##1}}%
  \def\add@circle##1{%
    \Cfor{\strsep{##1}{;}\xyr@a\xyr@b}{\not\equal\xyr@a\empty}{%
        \strsep\xyr@b{;}\xyr@a\xyr@b}\do{%
      \strsep{\xyr@a}{:}\xyr@C\xyr@r
      \ifx\empty\xyr@r
        \errmessage{Illegal format circle-option of setxyrange}\fi
      \Addvec\xyr@C{(\xyr@r,\xyr@r)}\xyr@tmp\EMedefappend\setxy@tmp{\xyr@tmp}%
      \Addvec\xyr@C{(-\xyr@r,-\xyr@r)}\xyr@tmp
        \EMedefappend\setxy@tmp{\xyr@tmp}%
    }%
  }%
% -------------------------------------------------------------
    \edef\x@L{0}%
    \edef\x@R{0}%
    \edef\y@T{0}%
    \edef\y@B{0}%
  \edef\label@name{#2}%
  \EMedef\setxy@tmp{#3}%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
  \expandafter\makeTenHairetu\setxy@tmp
    \Ifor*\DR@i{1}{\TH@N}\Do{%
      \vecXY{\hairetu{TH@V}{\DR@i}}\DR@x\DR@y
      \ifdim\DR@x\p@>\x@R\p@\edef\x@R{\DR@x}\fi
      \ifdim\DR@x\p@<\x@L\p@\edef\x@L{\DR@x}\fi
      \ifdim\DR@y\p@>\y@T\p@\edef\y@T{\DR@y}\fi
      \ifdim\DR@y\p@<\y@B\p@\edef\y@B{\DR@y}\fi
    }%
    \EMwriteLabel{\label@name-xL}{\x@L}%
    \EMwriteLabel{\label@name-xR}{\x@R}%
    \EMwriteLabel{\label@name-yT}{\y@T}%
    \EMwriteLabel{\label@name-yB}{\y@B}%
}}%
%
%\let\Takakkei\Drawline
%\def\Takakkei{\@ifnextchar<{\@Takakkei}{\@Takakkei<\empty>}}%
%\def\@Takakkei<#1>#2{\strsep{#2}{;}\Takakkei@a\Takakkei@b
%  \Drawline<#1>{#2\Takakkei@a}}%
\def\Takakkei{\@ifnextchar<{\@Takakkei}{\@Takakkei<\empty>}}%
\def\@Takakkei<#1>#2{{%
%\typeout{now! @Takakkei:arg1=#1}%\ttt%
  \edef\yazirusi@opt{\empty}%
  \edef\oval@r{0}%
  \ifx \empty #1\relax
    \@@Takakkei<#1>{#2}%
  \else
    \setkeys{emP}{#1}%
    \@ifundefined{boutyou@size}{%
      \edef\oresen@T{#2}%
    }{%
      \boutyou{#2}{\boutyou@size}\oresen@T
    }%
    \ifdim\oval@r\p@=\z@
      \@@Takakkei<#1>{\oresen@T}%
    \else
      \@ovalPolygon{\oresen@T}%
    \fi
  \fi}}%
\def\@@Takakkei<#1>#2{%
% \@ifundefined{pIIe@mode}{%
    \strsep{#2}{)}\Takakkei@a\Takakkei@b
    \Drawline<#1>{#2\Takakkei@a)}%
%  }{%
%   \let\sensyu\polygon
%   \Drawline<#1>{#2}%
% }%
}%
%
\def\Takakkeis{\@ifnextchar<{\@Takakkeis}{\@Takakkeis<\empty>}}%
\def\@Takakkeis<#1>#2{\exfor[;]\Ts@c:=#2\do{\Takakkei<#1>{\Ts@c}}}
%
\def\boutyou#1#2#3{%
% 多角形 #1 を辺に垂直方向に #2 だけ膨張させた多角形を #3 に返す。
  \edef\boutyou@oresen{#1}%
  \ukansan{#2}\boutyou@l
  \expandafter\makeTenHairetu\boutyou@oresen
  \edef\boutyou@oresen{\empty}%
  \Cfor{\edef\DR@i{0}}{\DR@i<\TH@N}{}\do{%
        \Incr\DR@i
        \ifnum\DR@i<\TH@N
          \IAdd\DR@i{1}\DR@ii
        \else
          \edef\DR@ii{1}%
        \fi
        \edef\@P{\hairetu{TH@V}{\DR@i}}%
        \edef\@Q{\hairetu{TH@V}{\DR@ii}}%
        \Kaiten[\boutyou@l]\@P\@Q{-90}\DR@i@
        \Kaiten[\boutyou@l]\@Q\@P{90}\DR@ii@
    \ifnum\DR@i=\@ne
      \edef\DR@i@start{\DR@i@}%
      \edef\DR@ii@start{\DR@ii@}%
    \else
      \perlLandL\DR@i@old\DR@ii@old\DR@i@\DR@ii@\DR@R
      \edefappend\boutyou@oresen{\DR@R}%
      \ifnum\DR@ii=\@ne
        \perlLandL\DR@i@start\DR@ii@start\DR@i@\DR@ii@\DR@R
        \edefappend\boutyou@oresen{\DR@R}%
      \fi
    \fi
    \edef\DR@i@old{\DR@i@}%
    \edef\DR@ii@old{\DR@ii@}%
%        \edefappend\boutyou@oresen{\DR@i@\DR@ii@}%
  }%
  \edef#3{\boutyou@oresen}%
}%
%
\def\@ovalPolygon#1{{%
  \edef\ovalD@r{\oval@r}%
% \edef\ovalD@y{\yazirusi@opt}%
  \edef\ovalD@tmp{#1}%
  \expandafter\makeTenHairetu\ovalD@tmp
  \edef\ovalD@A{\hairetu{TH@V}{1}}%
  \edef\ovalD@B{\hairetu{TH@V}{2}}%
  \edef\ovalD@D{\hairetu{TH@V}{3}}%
  \@Bunten\ovalD@A\ovalD@B11\ovalD@S
  \@Bunten\ovalD@B\ovalD@D11\ovalD@C
  \ovalcorner\oval@r\ovalD@S\ovalD@B\ovalD@C
  \edef\ovalD@O{\ovalD@A}%
  \Cfor{\edef\ovalD@i{2}}{\ovalD@i<\TH@N}{}\do{%
    \Incr\ovalD@i
    \edef\ovalD@A{\ovalD@C}%
    \edef\ovalD@B{\ovalD@D}%
    \ifthenelse{\ovalD@i=\TH@N}{%
        \@Bunten\ovalD@B\ovalD@O11\ovalD@D
        \ovalcorner\ovalD@r\ovalD@A\ovalD@B\ovalD@D
        \ovalcorner\ovalD@r\ovalD@D\ovalD@O\ovalD@S
    }{%
      \IAdd\ovalD@i{1}\ovalD@j
      \edef\ovalD@D{\hairetu{TH@V}{\ovalD@j}}%
      \@Bunten\ovalD@B\ovalD@D11\ovalD@C
      \ovalcorner\ovalD@r\ovalD@A\ovalD@B\ovalD@C
    }%
  }%
}}%
%
%\def\Drawline#1{\edef\@tmp{#1}\put(0,0){\expandafter\drawline\@tmp}}%
%\def\Drawline#1{\edef\@tmp{#1}\expandafter\path\@tmp}%
%
\def\clipDrawline{\begingroup
  \@ifnextchar<{\clipDrawline@}{\clipDrawline@@}}%
\def\clipDrawline@<#1>{%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi\clipDrawline@@}%
\def\clipDrawline@@#1{%
  \ifthenelse{\equal\iro@\empty}{}{\@iro{\iro@}}%
  \edef\DL@endP{\empty}\expandafter\@clipDrawline#1\ignorespaces\endgroup}%
\def\@clipDrawline{\@ifnextchar({\@@clipDrawline}{\relax}}%
\def\@@clipDrawline(#1,#2){%
  \ifthenelse{\lengthtest{#1 pt>\truexmax pt}%
    \or\lengthtest{#1 pt<\truexmin pt}%
    \or\lengthtest{#2 pt>\trueymax pt}%
    \or\lengthtest{#2 pt<\trueymin pt}}{\edef\DL@endP{\empty}}{%
    \ifthenelse{\equal\DL@endP\empty}{}{%
      \put(0,0){\expandafter\drawline\DL@endP(#1,#2)}}%
    \edef\DL@endP{(#1,#2)}}\@clipDrawline}%
%
\def\yclipDrawline{\begingroup
  \@ifnextchar<{\yclipDrawline@}{\yclipDrawline@@}}%
\def\yclipDrawline@<#1>{%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi\yclipDrawline@@}%
\def\yclipDrawline@@#1{%
  \ifthenelse{\equal\iro@\empty}{}{\@iro{\iro@}}%
  \edef\DL@endP{\empty}\expandafter\@yclipDrawline#1\ignorespaces\endgroup}%
\def\@yclipDrawline{\@ifnextchar({\@@yclipDrawline}{\relax}}%
\def\@@yclipDrawline(#1,#2){%
  \ifthenelse{\equal\DL@endP\empty}%
  {%
    \ifthenelse{\lengthtest{#2 pt>\trueymax pt}\or\lengthtest{#2 pt<\trueymin pt}}%
    {\han@inaifalse}%
    {\han@inaitrue}%
  }%
  {%
    \ifdim #2 pt>\trueymax pt\relax
      \ifhan@inai
        %\hokan
          \vecXY\DL@endP\clDL@x\clDL@y
          \Sub\trueymax{#2}\clDL@tmp
          \Sub\clDL@y{#2}\clDL@tmpp
          \@Div\clDL@tmp\clDL@tmpp\clDL@tmp
          \Sub{#1}\clDL@x\clDL@tmpp
          \Mul\clDL@tmp\clDL@tmpp\clDL@tmp
          \Sub{#1}\clDL@tmp\clDL@xx
          \put(0,0){\drawline(\clDL@x,\clDL@y)(\clDL@xx,\trueymax)}%
        \han@inaifalse
      \fi
    \else\ifdim #2 pt<\trueymin pt\relax
      \ifhan@inai
        %\hokan
          \vecXY\DL@endP\clDL@x\clDL@y
          \Sub\trueymin{#2}\clDL@tmp
          \Sub\clDL@y{#2}\clDL@tmpp
          \@Div\clDL@tmp\clDL@tmpp\clDL@tmp
          \Sub{#1}\clDL@x\clDL@tmpp
          \Mul\clDL@tmp\clDL@tmpp\clDL@tmp
          \Sub{#1}\clDL@tmp\clDL@xx
          \put(0,0){\drawline(\clDL@x,\clDL@y)(\clDL@xx,\trueymin)}%
        \han@inaifalse
      \fi
    \else
      \ifhan@inai
        \put(0,0){\expandafter\drawline\DL@endP(#1,#2)}%
      \else
        %\hokan
          \vecXY\DL@endP\clDL@x\clDL@y
          \ifdim\clDL@y pt>\trueymax pt
            \Sub\trueymax{#2}\clDL@tmp
            \Sub\clDL@y{#2}\clDL@tmpp
            \@Div\clDL@tmp\clDL@tmpp\clDL@tmp
            \Sub{#1}\clDL@x\clDL@tmpp
            \Mul\clDL@tmp\clDL@tmpp\clDL@tmp
            \Sub{#1}\clDL@tmp\clDL@xx
            \put(0,0){\drawline(#1,#2)(\clDL@xx,\trueymax)}%
          \else
            \Sub\trueymin{#2}\clDL@tmp
            \Sub\clDL@y{#2}\clDL@tmpp
            \@Div\clDL@tmp\clDL@tmpp\clDL@tmp
            \Sub{#1}\clDL@x\clDL@tmpp
            \Mul\clDL@tmp\clDL@tmpp\clDL@tmp
            \Sub{#1}\clDL@tmp\clDL@xx
            \put(0,0){\drawline(#1,#2)(\clDL@xx,\trueymin)}%
          \fi
        \han@inaitrue
      \fi
    \fi\fi
  }%
  \edef\DL@endP{(#1,#2)}\@yclipDrawline}%
%
%\def\xclipDrawline#1{\edef\DL@endP{\empty}\expandafter\@xclipDrawline#1}%
\def\xclipDrawline{\begingroup
  \@ifnextchar<{\xclipDrawline@}{\xclipDrawline@@}}%
\def\xclipDrawline@<#1>{%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi\xclipDrawline@@}%
\def\xclipDrawline@@#1{%
  \ifthenelse{\equal\iro@\empty}{}{\@iro{\iro@}}%
  \edef\DL@endP{\empty}\expandafter\@xclipDrawline#1\ignorespaces\endgroup}%
\def\@xclipDrawline{\@ifnextchar({\@@xclipDrawline}{\relax}}%
\def\@@xclipDrawline(#1,#2){%
  \ifthenelse{\equal\DL@endP\empty}%
  {%
    \ifthenelse{\lengthtest{#1 pt>\truexmax pt}\or\lengthtest{#1 pt<\truexmin pt}}%
    {\han@inaifalse}%
    {\han@inaitrue}%
  }%
  {%
    \ifdim #1 pt>\truexmax pt\relax
      \ifhan@inai
        %\hokan
          \vecXY\DL@endP\clDL@x\clDL@y
          \Sub\truexmax{#1}\clDL@tmp
          \Sub\clDL@x{#1}\clDL@tmpp
          \@Div\clDL@tmp\clDL@tmpp\clDL@tmp
          \Sub{#2}\clDL@y\clDL@tmpp
          \Mul\clDL@tmp\clDL@tmpp\clDL@tmp
          \Sub{#2}\clDL@tmp\clDL@xx
          \put(0,0){\drawline(\clDL@x,\clDL@y)(\truexmax,\clDL@xx)}%
        \han@inaifalse
      \fi
    \else\ifdim #1 pt<\truexmin pt\relax
      \ifhan@inai
        %\hokan
          \vecXY\DL@endP\clDL@x\clDL@y
          \Sub\truexmin{#1}\clDL@tmp
          \Sub\clDL@x{#1}\clDL@tmpp
          \@Div\clDL@tmp\clDL@tmpp\clDL@tmp
          \Sub{#2}\clDL@y\clDL@tmpp
          \Mul\clDL@tmp\clDL@tmpp\clDL@tmp
          \Sub{#2}\clDL@tmp\clDL@xx
          \put(0,0){\drawline(\clDL@x,\clDL@y)(\truexmin,\clDL@xx)}%
        \han@inaifalse
      \fi
    \else
      \ifhan@inai
        \put(0,0){\expandafter\drawline\DL@endP(#1,#2)}%
      \else
        %\hokan
          \vecXY\DL@endP\clDL@x\clDL@y
          \ifdim\clDL@x pt>\truexmax pt
            \Sub\truexmax{#1}\clDL@tmp
            \Sub\clDL@x{#1}\clDL@tmpp
            \@Div\clDL@tmp\clDL@tmpp\clDL@tmp
            \Sub{#2}\clDL@y\clDL@tmpp
            \Mul\clDL@tmp\clDL@tmpp\clDL@tmp
            \Sub{#2}\clDL@tmp\clDL@xx
            \put(0,0){\drawline(#1,#2)(\truexmax,\clDL@xx)}%
          \else
            \Sub\truexmin{#1}\clDL@tmp
            \Sub\clDL@x{#1}\clDL@tmpp
            \@Div\clDL@tmp\clDL@tmpp\clDL@tmp
            \Sub{#2}\clDL@y\clDL@tmpp
            \Mul\clDL@tmp\clDL@tmpp\clDL@tmp
            \Sub{#2}\clDL@tmp\clDL@xx
            \put(0,0){\drawline(#1,#2)(\truexmin,\clDL@xx)}%
          \fi
        \han@inaitrue
      \fi
    \fi\fi
  }%
  \edef\DL@endP{(#1,#2)}\@xclipDrawline}%
%
% コーナーを丸く切り取った多角形
%
\define@key{emP}{oval}{\ukansan{#1}\oval@r}%
\define@key{emP}{Oval}{\ukansan{#1}\oval@r}%
%
%
\def\ovalcorner{\@ifnextchar[{\@ovalcorner}{\@ovalcorner[\empty]}}%
\def\@ovalcorner[#1]#2#3#4#5{%
  \edef\yazirusi@opt{\empty}%
  \ifx\empty#1\else\setkeys{emP}{#1}\fi
  \sankakkei{#3}{#4}{#5}%
  \Yogen[a]\lb\lc\la\kaku@B
  \@Div\kaku@B{2}\kaku@Bii
  \Subvec{#3}{#4}\BA@\Absvec\BA@\l@BA
  \Subvec{#5}{#4}\CA@\Absvec\CA@\l@CA
  \DegTan\kaku@Bii\oc@tmp
  \@Div{#2}\oc@tmp\l@val
  \@Div\l@val\l@BA\oc@tmp
  \Mulvec\oc@tmp\BA@\BH@\Addvec\BH@{#4}\oc@H
  \@Div\l@val\l@CA\oc@tmp
  \Mulvec\oc@tmp\CA@\CK@\Addvec\CK@{#4}\oc@K
  \Nitoubunsen{#3}{#4}{#5}\oc@D
  \Subvec\oc@D{#4}\BD@\Absvec\BD@\l@BD
  \DegSin\kaku@Bii\oc@tmp
  \@Div{#2}\oc@tmp\l@val
  \@Div\l@val\l@BD\oc@tmp
  \Mulvec\oc@tmp\BD@\BP@\Addvec\BP@{#4}\oc@P
\ifx\empty\iro@
  \ifthenelse{\equal\orienttriangle{-}}{%
    \Enko\oc@P{#2}{hazimeten=\oc@K}{owariten=\oc@H}%
  }{%
    \Enko\oc@P{#2}{hazimeten=\oc@H}{owariten=\oc@K}%
  }%
  \ifthenelse{\equal\yazirusi@opt{a}}{%
    \Drawlines{{#3}\oc@H}\ArrowLine\oc@K{#5}%
  }{\ifthenelse{\equal\yazirusi@opt{r}}{%
     \Drawlines{{#5}\oc@K}\ArrowLine\oc@H{#3}%
    }{\Drawlines{{#3}\oc@H;{#5}\oc@K}%
    }%
  }%
\else\put(0,0){\@iro{\iro@}%
  \ifthenelse{\equal\orienttriangle{-}}{%
    \Enko\oc@P{#2}{hazimeten=\oc@K}{owariten=\oc@H}%
  }{%
    \Enko\oc@P{#2}{hazimeten=\oc@H}{owariten=\oc@K}%
  }%
  \ifthenelse{\equal\yazirusi@opt{a}}{%
    \Drawlines{{#3}\oc@H}\ArrowLine\oc@K{#5}%
  }{\ifthenelse{\equal\yazirusi@opt{r}}{%
     \Drawlines{{#5}\oc@K}\ArrowLine\oc@H{#3}%
    }{\Drawlines{{#3}\oc@H;{#5}\oc@K}%
    }%
  }%
}%
\fi
}%
%
% 座標軸に平行な長方形
%
\define@key{emP}{kizyunten}{\edef\kizyun@ten{#1}}%
%
\def\emkukei{\@ifnextchar[{\@emkukei}{\@emkukei[\empty]}}%
\def\@emkukei[#1]{\@ifnextchar<{\@@emkukei[#1]}{\@@emkukei[#1]<\empty>}}%
\def\@@emkukei[#1]<#2>#3#4{%
% #1: key=val
%       kizyunten
%       pos
%       label
% #2: Takakkei に引き継ぐオプション
% #3: 横
% #4: 縦
%
  \edef\kizyun@ten{(0,0)}%
  \edef\@pos{lb}%
  \edef\label@name{\empty}%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
  \uxkansan{#3}\wd@kukei
  \uykansan{#4}\ht@kukei
  \@Div\ht@kukei{2}\ht@kukei@
  \@Div\wd@kukei{2}\wd@kukei@
  \ifthenelse{\equal\@pos{c}}{%
    \Addvec{\kizyun@ten}{(-\wd@kukei@,0)}\kukei@L
    \Addvec{\kizyun@ten}{(\wd@kukei@,0)}\kukei@R
    \Addvec{\kizyun@ten}{(0,\ht@kukei@)}\kukei@T
    \Addvec{\kizyun@ten}{(0,-\ht@kukei@)}\kukei@B
    \Addvec{\kizyun@ten}{(-\wd@kukei@,\ht@kukei@)}\kukei@LT
    \Addvec{\kizyun@ten}{(-\wd@kukei@,-\ht@kukei@)}\kukei@LB
    \Addvec{\kizyun@ten}{(\wd@kukei@,\ht@kukei@)}\kukei@RT
    \Addvec{\kizyun@ten}{(\wd@kukei@,-\ht@kukei@)}\kukei@RB
    \edef\kukei@C{\kizyun@ten}%
  }{%
    \ifthenelse{\equal\@pos{lb}}{%
      \Addvec{\kizyun@ten}{(0,\ht@kukei@)}\kukei@L
      \Addvec{\kizyun@ten}{(\wd@kukei,\ht@kukei@)}\kukei@R
      \Addvec{\kizyun@ten}{(\wd@kukei@,\ht@kukei)}\kukei@T
      \Addvec{\kizyun@ten}{(\wd@kukei@,0)}\kukei@B
      \Addvec{\kizyun@ten}{(0,\ht@kukei)}\kukei@LT
      \edef\kukei@LB{\kizyun@ten}%
      \Addvec{\kizyun@ten}{(\wd@kukei,\ht@kukei)}\kukei@RT
      \Addvec{\kizyun@ten}{(\wd@kukei,0)}\kukei@RB
      \Addvec{\kizyun@ten}{(\wd@kukei@,\ht@kukei@)}\kukei@C
    }{%
      \errmessage{pos=\@pos: not supported}
    }%
  }%
  \Takakkei<#2>{\kukei@LT\kukei@LB\kukei@RB\kukei@RT}%
  \ifx\empty\label@name\else
    \expandafter\edef\csname\label@name L\endcsname{\kukei@L}%
    \expandafter\edef\csname\label@name R\endcsname{\kukei@R}%
    \expandafter\edef\csname\label@name T\endcsname{\kukei@T}%
    \expandafter\edef\csname\label@name B\endcsname{\kukei@B}%
    \expandafter\edef\csname\label@name LT\endcsname{\kukei@LT}%
    \expandafter\edef\csname\label@name LB\endcsname{\kukei@LB}%
    \expandafter\edef\csname\label@name RT\endcsname{\kukei@RT}%
    \expandafter\edef\csname\label@name RB\endcsname{\kukei@RB}%
    \expandafter\edef\csname\label@name C\endcsname{\kukei@C}%
  \fi
}%
%
\let\emtyouhoukei\emkukei
%
% 点列 ---> 配列
%
\def\tenhairetu#1#2{%
%   #1: 点列
%   #2: 配列基幹名
  \EMedef\th@arg{#1}%
  \makeTenHairetu<hairetu=#2>\th@arg
}%
%
%
\def\makeTenHairetu{\edef\TH@N{0}\edef\hairetu@name{TH@V}%
  \@ifnextchar<{\makeTenHairetu@}{\@makeTenHairetu}}%
\def\makeTenHairetu@<#1>{\setkeys{emP}{#1}\expandafter\@makeTenHairetu}%
\def\@makeTenHairetu{\@ifnextchar({\@@makeTenHairetu}{%
  \expandafter\edef\csname\hairetu@name N\endcsname{\TH@N}\relax}}%
\def\@@makeTenHairetu(#1,#2){%
  \Incr\TH@N
  \expandafter\edef\csname\hairetu@name\romannumeral\TH@N\endcsname{(#1,#2)}%
  \@makeTenHairetu
}%
\def\EMovalTakakkei{%
  \ifnum\EMps@mode=\@ne
    \ifEMpscontinue\def\byouga@dousa{p}\def\EMps@newpath{0}\else\gsave\fi
  \fi
  \@ifnextchar<{\EMovalTakakkei@}{\@EMovalTakakkei}}%
\def\EMovalTakakkei@<#1>{\setkeys{emP}{#1}\@EMovalTakakkei}%
\def\@EMovalTakakkei#1#2{%
  \ukansan{#1}\ovalT@l
  \edef\ovalT@tmp{#2}%
  \expandafter\makeTenHairetu\ovalT@tmp
  \Ifor\ovalT@i{0}\TH@N\Do{%
    \edef\ovalT@p{\ovalT@i}\ifnum\ovalT@p=\z@\edef\ovalT@p{\TH@N}\fi
      \edef\ovalT@P{\hairetu{TH@V}\ovalT@p}%
    \IAdd\ovalT@i{1}\ovalT@q
      \edef\ovalT@Q{\hairetu{TH@V}\ovalT@q}%
    \IAdd\ovalT@i{2}\ovalT@r\ifnum\ovalT@r>\TH@N\edef\ovalT@r{1}\fi
      \edef\ovalT@R{\hairetu{TH@V}\ovalT@r}%
    \Subvec\ovalT@P\ovalT@Q\ovalT@QP\Argvec\ovalT@QP\ovalT@argi
    \Subvec\ovalT@R\ovalT@Q\ovalT@QR\Argvec\ovalT@QR\ovalT@argii
    \Sub\ovalT@argii\ovalT@argi\ovalT@arg
    \@Div\ovalT@arg{2}\ovalT@arg
    \DegCos{\ovalT@arg}\ovalT@tmp
    \@Div\ovalT@l\ovalT@tmp\ovalT@CQ
    \Rotvec[\ovalT@CQ]\ovalT@QP\ovalT@arg\ovalT@tmp
      \Addvec\ovalT@Q\ovalT@tmp\ovalT@C
    \Suisen\ovalT@C\ovalT@P\ovalT@Q\ovalT@H\Kyori\ovalT@C\ovalT@H\ovalT@r
    \ifnum\ovalT@i>\z@\Drawline{\ovalT@K\ovalT@H}\fi
    \Suisen\ovalT@C\ovalT@R\ovalT@Q\ovalT@K
    \ifnum\ovalT@i=\z@\edef\ovalT@orgH{\ovalT@H}\fi
    \Enko\ovalT@C\ovalT@r{hazimeten=\ovalT@H}{owariten=\ovalT@K}%
  }%
  \Drawline{\ovalT@K\ovalT@orgH}%
% \Takakkei{#2}%
  \ifnum\EMps@mode=\@ne
    \ifEMpscontinue\else\grestore\fi
  \fi
}%
\let\ovalTakakkei\EMovalTakakkei
%
\def\hamidasisenbun{\@ifstar{\edef\HS@draw{0}\@hamidasisenbun}{\edef\HS@draw{1}\@hamidasisenbun}}%
\def\@hamidasisenbun{\@ifnextchar[{\@@hamidasisenbun}{\@@hamidasisenbun[\empty]}}%
\def\@@hamidasisenbun[#1]{\@ifnextchar<{\@@@hamidasisenbun[#1]}%
  {\@@@hamidasisenbun[#1]<\empty>}}%
\def\@@@hamidasisenbun[#1]<#2>#3#4#5#6{%
% #1 : key=val
% #2 : \Drawline に引き渡されるオプション引数
% #3 : 端点1
% #4 : 端点2
% #5 : 端点1に対するはみ出し係数
% #6 : 端点2に対するはみ出し係数
%
  \begingroup
  \ifnum\EMps@mode=\@ne\gsave\fi
  \edef\by@perl{0}%
  \edef\YG@migiT{\empty}%
  \edef\YG@hidariT{\empty}%
  \edef\YG@migiM{\empty}%
  \edef\YG@hidariM{\empty}%
  \ifx\empty #1\relax
%    \ifthenelse{\equal{#2}\empty}{}{%
%      \emstrstr{#2}{iT}%
%      \ifnum\retval>\z@
%        \setkeys{emGurafu}{#2}\def\opt@done{}\relax
%      \fi
%    }%
  \else
    \setkeys{emGurafu}{#1}%
  \fi
  \Subvec{#4}{#3}\hmds@v
  \Mulvec{#5}\hmds@v\hmds@a\Subvec{#3}\hmds@a\hmds@a
  \Mulvec{#6}\hmds@v\hmds@b\Addvec{#4}\hmds@b\hmds@b
  \ifnum\HS@draw>\z@
%    \expandafter\Drawline<#2>{\hmds@a\hmds@b}%
    \@ifundefined{opt@done}{%
      \Drawline<#2>{\hmds@a\hmds@b}%
    }{%
      \Drawline{\hmds@a\hmds@b}%
    }%
  \fi
  \ifnum\EMps@mode=\@ne\grestore\fi
\ifx\empty\YG@migiM\else
  \edef\migiT{\hmds@b}%
  \expandafter\show@migiM\YG@migiM\@nil
\fi
\ifx\empty\YG@hidariM\else
  \edef\hidariT{\hmds@a}%
  \expandafter\show@hidariM\YG@hidariM\@nil
\fi
  \edef\temp@x{%
    \def\noexpand\hidariT{\hmds@a}%
    \def\noexpand\migiT{\hmds@b}%
    \def\noexpand\YG@hidariT{\YG@hidariT}%
    \def\noexpand\YG@migiT{\YG@migiT}%
  }%
  \expandafter\endgroup\temp@x
  \ifx\empty\YG@migiT\else
    \expandafter\edef\csname\YG@migiT\endcsname{\migiT}\fi
  \ifx\empty\YG@hidariT\else
    \expandafter\edef\csname\YG@hidariT\endcsname{\hidariT}\fi
  \let\rightP\migiT
  \let\leftP\hidariT
}%
%
\def\hamidasisenbuns{\@ifstar{%
  \edef\HS@draw{0}\@hamidasisenbuns}{\edef\HS@draw{1}\@hamidasisenbuns}}%
\def\@hamidasisenbuns{\@ifnextchar<{%
  \@@hamidasisenbuns}{\@@hamidasisenbuns<\empty>}}%
\def\@@hamidasisenbuns<#1>#2#3#4{%
  \exfor[;]\Hss@tmp:=#2\do{%
    \edef\Hss@tmp@{\Hss@tmp}%
    \Strsep\Hss@tmp@{)}\Hss@a\Hss@b
    \@@hamidasisenbun[\empty]<#1>{\Hss@a)}{\Hss@b}{#3}{#4}%
  }%
}%
%
\def\Hamidasisenbun{\@ifstar{\edef\HS@draw{0}\@Hamidasisenbun}{%
  \edef\HS@draw{1}\@Hamidasisenbun}}%
\def\@Hamidasisenbun{\@ifnextchar[{\@@Hamidasisenbun}{%
  \@@Hamidasisenbun[\empty]}}%
\def\@@Hamidasisenbun[#1]{%
  \@ifnextchar<{\@@@Hamidasisenbun[#1]}{\@@@Hamidasisenbun[#1]<\empty>}}%
\def\@@@Hamidasisenbun[#1]<#2>#3#4#5#6{%
% #1 : key=val
% #2 : \Drawline に引き渡されるオプション引数
% #3 : 端点1
% #4 : 端点2
% #5 : 端点1に対するはみ出し量（単位つき長さ）
% #6 : 端点2に対するはみ出し量（単位つき長さ）
  \begingroup
  \ifnum\EMps@mode=\@ne\gsave\fi
  \edef\by@perl{0}%
  \edef\YG@migiT{\empty}%
  \edef\YG@hidariT{\empty}%
  \edef\YG@migiM{\empty}%
  \edef\YG@hidariM{\empty}%
  \ifx\empty #1\relax
%    \ifthenelse{\equal{#2}\empty}{}{%
%      \emstrstr{#2}{iT}%
%      \ifnum\retval>\z@
%        \setkeys{emGurafu}{#2}\def\opt@done{}\relax
%      \fi
%    }%
  \else
    \setkeys{emGurafu}{#1}%
  \fi
  \Subvec{#4}{#3}\hmds@v
  \Unitvec\hmds@v\hmds@uv
  \ukansan{#5}\hmds@a\Mulvec\hmds@a\hmds@uv\hmds@va\Subvec{#3}\hmds@va\hmds@a
  \ukansan{#6}\hmds@b\Mulvec\hmds@b\hmds@uv\hmds@vb\Addvec{#4}\hmds@vb\hmds@b
  \ifnum\HS@draw>\z@
    \@ifundefined{opt@done}{%
      \Drawline<#2>{\hmds@a\hmds@b}%
    }{%
      \Drawline{\hmds@a\hmds@b}%
    }%
  \fi
  \ifnum\EMps@mode=\@ne\grestore\fi
\ifx\empty\YG@migiM\else
  \edef\migiT{\hmds@b}%
  \expandafter\show@migiM\YG@migiM\@nil
\fi
\ifx\empty\YG@hidariM\else
  \edef\hidariT{\hmds@a}%
  \expandafter\show@hidariM\YG@hidariM\@nil
\fi
  \edef\temp@x{%
    \def\noexpand\hidariT{\hmds@a}%
    \def\noexpand\migiT{\hmds@b}%
    \def\noexpand\YG@hidariT{\YG@hidariT}%
    \def\noexpand\YG@migiT{\YG@migiT}%
  }%
  \expandafter\endgroup\temp@x
  \ifx\empty\YG@migiT\else
    \expandafter\edef\csname\YG@migiT\endcsname{\migiT}\fi
  \ifx\empty\YG@hidariT\else
    \expandafter\edef\csname\YG@hidariT\endcsname{\hidariT}\fi
  \let\rightP\migiT
  \let\leftP\hidariT
}%
%
\def\Hamidasisenbuns{\@ifstar{%
  \edef\HS@draw{0}\@Hamidasisenbuns}{\edef\HS@draw{1}\@Hamidasisenbuns}}%
\def\@Hamidasisenbuns{\@ifnextchar<{%
  \@@Hamidasisenbuns}{\@@Hamidasisenbuns<\empty>}}%
\def\@@Hamidasisenbuns<#1>#2#3#4{%
  \exfor[;]\Hss@tmp:=#2\do{%
    \edef\Hss@tmp@{\Hss@tmp}%
    \Strsep\Hss@tmp@{)}\Hss@a\Hss@b
    \@Hamidasisenbun<#1>{\Hss@a)}{\Hss@b}{#3}{#4}%
  }%
}%
%
\def\Hamidasiten{\@ifstar{\Hamidasiten@}{\@Hamidasiten}}%
\def\Hamidasiten@#1#2#3#4#5#6{%
% #1 : 端点1
% #2 : 端点2
% #3 : 端点1に対するはみ出し量（単位つき長さ）
% #4 : 端点2に対するはみ出し量（単位つき長さ）
% #5 : 端点1 からはみ出した点を受け取る制御綴
% #6 : 端点2 からはみ出した点を受け取る制御綴
  \Subvec{#2}{#1}\hmds@v
  \Unitvec\hmds@v\hmds@uv
  \ukansan{#3}\hmds@a
  \Mulvec\hmds@a\hmds@uv\hmds@va
  \Subvec{#1}\hmds@va#5\relax
  \ukansan{#4}\hmds@b
  \Mulvec\hmds@b\hmds@uv\hmds@vb
  \Addvec{#2}\hmds@vb#6\relax
}%
\def\@Hamidasiten#1#2#3#4{%
% #1 : 端点1
% #2 : 端点2
% #3 : 端点2に対するはみ出し量（単位つき長さ）
% #4 : 結果を受け取る制御綴
  \Subvec{#2}{#1}\hmds@v
  \Unitvec\hmds@v\hmds@uv
  \ukansan{#3}\hmds@b\Mulvec\hmds@b\hmds@uv\hmds@vb\Addvec{#2}\hmds@vb\hmds@b
%  \edef#4{\hmds@b}%
  \Put@nil\hmds@b #4\@nil
}%
%
\def\HamidasiPut#1#2#3{%
  \@Hamidasiten{#1}{#2}{#3}\HP@tmp
  \emathPut\HP@tmp
}%
%
\def\Sensyu#1{\edef\@tmp{#1}\put(0,0){\expandafter\sensyu\@tmp}}%
%
% \Drawlines<#1>#2
%   <#1> : <sensyu=\dashline[40]{.1}>などによる線種のローカルな変更
%    #2  : 複数の点列を`;'で区切る
\def\Drawlines{\@ifnextchar<{\@Drawlines}{\@Drawlines<\empty>}}%
\def\@Drawlines<#1>#2{{%\ifx \empty #1\else\setkeys{emP}{#1}\fi
  \Cfor{\edef\Drawlines@a{#2}}{\not\equal\Drawlines@a\empty}{%
    \edef\Drawlines@a{\Drawlines@b}}\do{%
%    \strsep\Drawlines@a{;}\Drawlines@a\Drawlines@b\Sensyu\Drawlines@a}}}%
    \strsep\Drawlines@a{;}\Drawlines@a\Drawlines@b\Drawline<#1>\Drawlines@a}}}%
%
\def\PhDrawlines{\@ifnextchar<{\@PhDrawlines}{\@PhDrawlines<\empty>}}%
\def\@PhDrawlines<#1>#2{{%\ifx \empty #1\else\setkeys{emP}{#1}\fi
%  \Cfor{\edef\PhDrawlines@a{#2}}{\not\equal\PhDrawlines@a\empty}{%
%    \edef\PhDrawlines@a{\PhDrawlines@b}}\do{%
%    \strsep\PhDrawlines@a{;}\PhDrawlines@a\PhDrawlines@b
%    \PhDrawline<#1>\PhDrawlines@a}%
  \exfor[;]\PhDrawlines@a:=#2\do{\PhDrawline<#1>\PhDrawlines@a}%
}}%
%
% lineto, moveto
% rlineto, rmoveto
\edef\emCurP{(0,0)}%
\edef\emCurArg{0}%
\def\emlineto{\@ifnextchar[{\@emlineto}{\@@emlineto}}%
\def\@emlineto[#1]{\@@emplineto}%
\def\@@emlineto{\@ifnextchar({\@@@emlineto}{\relax}}%
\def\@@@emlineto(#1,#2){\Sensyu{\emCurP(#1,#2)}\edef\emCurP{(#1,#2)}\@@emlineto}%
\def\@@emplineto{\@ifnextchar({\@@@emplineto}{\relax}}%
\def\@@@emplineto(#1,#2){\Rdef(#1,#2)\emCur@P\Sensyu{\emCurP\emCur@P}\edef\emCurP{\emCur@P}\@@emplineto}%
%
\def\emrlineto{\@ifnextchar[{\@emrlineto}{\@@emrlineto}}%
\def\@emrlineto[#1]{\@@emprlineto}%
\def\@@emrlineto{\@ifnextchar({\@@@emrlineto}{\relax}}%
\def\@@@emrlineto(#1,#2){\Addvec\emCurP{(#1,#2)}\emCur@P\Sensyu{\emCurP\emCur@P}\edef\emCurP{\emCur@P}\@@emrlineto}%
\def\@@emprlineto{\@ifnextchar({\@@@emprlineto}{\relax}}%
\def\@@@emprlineto(#1,#2){\Rdef(#1,#2)\emCur@P\Addvecself\emCur@P{\emCurP}%
  \Sensyu{\emCurP\emCur@P}\edef\emCurP{\emCur@P}\@@emprlineto}%
%\def\emlineto{\@ifnextchar[{\@emlineto}{\@emlineto[\empty]}}%
%\def\@emlineto[#1](#2,#3){%
%  \ifthenelse{\equal{#1}\empty}{\Sensyu{\emCurP(#2,#3)}\edef\emCurP{(#2,#3)}}{%
%  \Rdef(#2,#3)\emCurPP\Sensyu{\emCurP\emCurPP}\edef\emCurP{\emCurPP}}}%
%\def\emrlineto{\@ifnextchar[{\@emrlineto}{\@emrlineto[\empty]}}%
%\def\@emrlineto[#1](#2,#3){%
%  \ifthenelse{\equal{#1}\empty}{\Addvec{(#2,#3)}\emCurP\em@TmpP}{%
%    \Rdef[\emCurP](#2,#3)\em@TmpP}%
%    \Sensyu{\emCurP\em@TmpP}\edef\emCurP{\em@TmpP}}%
\def\emmoveto{\@ifnextchar[{\@emmoveto}{\@emmoveto[\empty]}}%
\def\@emmoveto[#1](#2,#3){%
  \ifthenelse{\equal{#1}\empty}{%
    \edef\emCurP{(#2,#3)}}{\Rdef(#2,#3)\emCurP}}%
\def\emrmoveto{\@ifnextchar[{\@emrmoveto}{\@emrmoveto[\empty]}}%
\def\@emrmoveto[#1](#2,#3){\ifthenelse{\equal{#1}\empty}{%
  \Addvec{(#2,#3)}\emCurP\emCurP}{\Rdef[\emCurP](#2,#3)\emCurP}}%
\def\emrrmoveto{\@ifnextchar[{\@emrrmoveto}{\@emrrmoveto[\empty]}}%
\def\@emrrmoveto[#1](#2,#3){\Addself\emCurArg{#3}%
  \ifthenelse{\equal{#1}\empty}{%
    \Rdef(#2,\emCurArg)\em@TmpP}{\Rdef[\emCurP](#2,\emCurArg)\em@TmpP}%
    \Addvec\emCurP\em@TmpP\emCurP}%
\def\emrrlineto{\@ifnextchar[{\@emrrlineto}{\@emrrlineto[\emCurP]}}%
\def\@emrrlineto[#1](#2,#3){\Addself\emCurArg{#3}%
  \ifthenelse{\equal{#1}\empty}{\Addvec{(#2,\emCurArg)}\emCurP\em@TmpP}{%
    \Rdef[\emCurP](#2,\emCurArg)\em@TmpP}%
    \Sensyu{\emCurP\em@TmpP}\edef\emCurP{\em@TmpP}}%
%
\def\emMoveto#1{\edef\emCurP{#1}}%
\def\emLineto{\@ifnextchar[\emLineto@\@emLineto}%
\def\emLineto@[#1]{\emMoveto{#1}\@emLineto}%
\def\@emLineto#1#2{%
  \edef\Drawline@tmp{#1}%
  \expandafter\makeTenHairetu\Drawline@tmp
  \edef\Drawline@tmp{\emCurP}%
  \Cfor{\edef\DR@i{0}}{\DR@i<\TH@N}{}\do{%
    \Incr\DR@i
    \Addvec{\hairetu{TH@V}{\DR@i}}{\emCurP}\DR@tmpv
    \edef\emCurP{\DR@tmpv}%
    \edefappend\Drawline@tmp{\DR@tmpv}%
  }%
  \edef#2{\Drawline@tmp}%
}%
%
% 点線
\def\Dottedline#1#2{\edef\@hikisu{{#1}#2}\put(0,0){\expandafter\dottedline\@hikisu}}%
%
% 破線
\def\Dashline{\@ifnextchar [{\@Dashline}{\@Dashline[\dashlinestretch]}}%
\def\@Dashline[#1]#2#3{%
  \edef\@tmp{[#1]{#2}#3}\put(0,0){\expandafter\dashline\@tmp}}%
%
% 破線描画
\define@key{emP@hasen}{L}{\def\hasen@L{#1}}%
\define@key{emP@hasen}{G}{\def\hasen@G{#1}}%
\define@key{emP@hasen}{allinethickness}{\allinethickness{#1}}%
\define@key{emP@hasen}{linethickness}{\linethickness{#1}}%
\define@key{emP@hasen}{iro}{\iro@{#1}}%
\def\@hasen@L{1mm}%
\def\@hasen@G{.9mm}%
\def\hasenL#1{\def\@hasen@L{#1}}%
\def\hasenG#1{\def\@hasen@G{#1}}%
\def\hasenLG#1#2{\def\@hasen@L{#1}\def\@hasen@G{#2}}%
%
\def\calchasenLG#1#2#3#4#5#6{%
%
% #1: 破線の長さ
% #2: 実線の長さ
% #3: gap の長さ
% #4: gap の個数
% #5: 実線の長さ
% #6: gap の長さ
%
%\typeout{length=#1,L=#2,G=#3}%
  \ukansan{#1}\h@@TH
  \ukansan{#2}\h@@L
  \ukansan{#3}\h@@G
  \Add\h@@L\h@@G\h@@LG
  \Sub\h@@TH\h@@L\tmp@@a
  \Divself\tmp@@a\h@@LG
  \Addself\tmp@@a{.4}%
  \Int\tmp@@a\h@@N
%  \Incr\h@@N
  \IAdd\h@@N{1}\h@@Ni
  \Mul\h@@Ni\h@@L\h@@tmpa
  \Sub\h@@TH\h@@tmpa\h@@tmpa
  \edef#4{\h@@N}%
  \ifnum\h@@N=\z@
    \edef#5{\h@@TH}%
    \edef#6{0}%
  \else
    \@Div\h@@tmpa\h@@N\h@@G
    \edef#5{\h@@L}%
    \edef#6{\h@@G}%
  \fi
%\typeout{N=#4,L=#5,G=#6}
}%
%
%\def\hasen{\@ifstar{\ohasen}{\chasen}}%
\DeclareRobustCommand\hasen{\@ifstar{\ohasen}{\chasen}}%
\def\chasen{\edef\hasen@L{\@hasen@L}\edef\hasen@G{\@hasen@G}%
  \@ifnextchar[{\hasen@}{\@hasen}}%
\def\hasen@[#1]{\setkeys{emP@hasen}{#1}\@hasen}%
\def\@hasen(#1,#2){\@ifnextchar({\@@hasen(#1,#2)}{\relax}}%
\def\@@hasen(#1,#2)(#3,#4){%
\Kyori{(#1,#2)}{(#3,#4)}\d@@hasen
\@tempdima=\d@@hasen\unitlength
\ifdim\@tempdima>\p@
  \edef\hasen@S{(#1,#2)}\edef\hasen@E{(#3,#4)}%
  \templa=\hasen@L\@Div{\strip@pt\templa}{\strip@pt\unitlength}\hasen@@L
  \templa=\hasen@G\@Div{\strip@pt\templa}{\strip@pt\unitlength}\hasen@@G
  \Add\hasen@@L\hasen@@G\hasen@@LG
  \Subvec\hasen@E\hasen@S\hasen@v
  \Unitvec\hasen@v\hasen@u
  \Absvec\hasen@v\hasen@LL
  \@Div\hasen@LL\hasen@@LG\hasen@tmp
  \Seisuububun\hasen@tmp\hasen@n
  \Sub\hasen@LL\hasen@@L\hasen@tmp
  \ifnum\hasen@n>\z@
    \@Div\hasen@tmp\hasen@n\hasen@tmp
    \Sub\hasen@tmp\hasen@@L\hasen@@G
    \Add\hasen@@L\hasen@@G\hasen@@LG\fi
%
   \Mul{\hasen@n}\hasen@@LG\hasen@@LGn
   \@Bunten\hasen@S\hasen@E\hasen@@LGn\hasen@@L\hasen@F
%  \Cfor{\edef\hasen@i{0}}{\hasen@i<\hasen@n}{\Incr\hasen@i}\do{%
   \Cfor{\edef\hasen@i{0}}{\hasen@i<\hasen@n}{}\do{%
%    \Mul\hasen@i\hasen@@LG\hasen@tmp
%    \Mulvec\hasen@tmp\hasen@u\hasen@tmp
%    \Addvec\hasen@S\hasen@tmp\hasen@SS
%    \Mulvec\hasen@@L\hasen@u\hasen@tmp
%    \Addvec\hasen@SS\hasen@tmp\hasen@EE
    \ISub\hasen@n\hasen@i\hasen@j
    \@Bunten\hasen@S\hasen@F\hasen@i\hasen@j\hasen@SS
    \Incr\hasen@i
    \ISub\hasen@n\hasen@i\hasen@j
    \@Bunten\hasen@S\hasen@F\hasen@i\hasen@j\hasen@SE
    \@Bunten\hasen@SS\hasen@SE\hasen@@L\hasen@@G\hasen@EE
 %   \Drawline{\hasen@SS\hasen@EE}%
    \edef\hasen@SE{\hasen@SS\hasen@EE}%
    \expandafter\drawline\hasen@SE
  }%
% \Drawline{\hasen@F\hasen@E}%
  \edef\hasen@SE{\hasen@F\hasen@E}%
  \expandafter\drawline\hasen@SE
%  \Mul\hasen@i\hasen@@LG\hasen@tmp
%  \Mulvec\hasen@tmp\hasen@u\hasen@tmp
%  \Addvec\hasen@S\hasen@tmp\hasen@SS
%  \Drawline{\hasen@SS\hasen@E}%
\fi
  \@hasen(#3,#4)%
}%
%
\def\ohasen{\edef\hasen@L{\@hasen@L}\edef\hasen@G{\@hasen@G}%
  \@ifnextchar[{\ohasen@}{\@ohasen}}%
\def\ohasen@[#1]{\setkeys{emP@hasen}{#1}\@ohasen}%
\def\@ohasen(#1,#2){\@ifnextchar({\@@ohasen(#1,#2)}{\relax}}%
\def\@@ohasen(#1,#2)(#3,#4){%
\Kyori{(#1,#2)}{(#3,#4)}\d@@hasen
\ifdim\d@@hasen pt>0.005pt\relax
  \edef\hasen@S{(#1,#2)}\edef\hasen@E{(#3,#4)}%
  \templa=\hasen@L\@Div{\strip@pt\templa}{\strip@pt\unitlength}\hasen@@L
  \templa=\hasen@G\@Div{\strip@pt\templa}{\strip@pt\unitlength}\hasen@@G
  \Add\hasen@@L\hasen@@G\hasen@@LG
  \Subvec\hasen@E\hasen@S\hasen@v
  \Unitvec\hasen@v\hasen@u
  \Absvec\hasen@v\hasen@LL
  \@Div\hasen@LL\hasen@@LG\hasen@tmp
  \Seisuububun\hasen@tmp\hasen@n
  \Sub\hasen@LL\hasen@@G\hasen@tmp
  \ifnum\hasen@n>\z@
    \@Div\hasen@tmp\hasen@n\hasen@tmp
    \Sub\hasen@tmp\hasen@@L\hasen@@G
    \Add\hasen@@L\hasen@@G\hasen@@LG\fi
  \Cfor{\edef\hasen@i{0}}{\hasen@i<\hasen@n}{}\do{%
    \Incr\hasen@i
    \Mul\hasen@i\hasen@@LG\hasen@tmp
    \Mulvec\hasen@tmp\hasen@u\hasen@tmp
    \Addvec\hasen@S\hasen@tmp\hasen@EE
    \Mulvec{-\hasen@@L}\hasen@u\hasen@tmp
    \Addvec\hasen@EE\hasen@tmp\hasen@SS
    \Drawline{\hasen@SS\hasen@EE}%
  }%
%  \Mul\hasen@i\hasen@@LG\hasen@tmp
%  \Mulvec\hasen@tmp\hasen@u\hasen@tmp
%  \Addvec\hasen@S\hasen@tmp\hasen@SS
%  \Drawline{\hasen@SS\hasen@E}%
\fi
  \@ohasen(#3,#4)%
}%
%
\define@key{emP}{dashLG}{\vecXY{(#1)}\dash@L\dash@G\let\sensyu\dashln}%
\DeclareRobustCommand\dashln{\@ifstar{\odashln}{\cdashln}}%
\def\cdashln{\@ifnextchar[{\dashln@}{\@dashln}}%
\def\dashln@[#1]{\setkeys{emP}{#1}\@dashln}%
\def\@dashln(#1,#2){\@ifnextchar({\@@dashln(#1,#2)}{\relax}}%
\def\@@dashln(#1,#2)(#3,#4){%
  \Subvec{(#3,#4)}{(#1,#2)}\dashln@v
  \Unitvec\dashln@v\dashln@uv
  \Kyori{(#1,#2)}{(#3,#4)}\d@@dashln
  \ukansan\dash@L\dash@L@
  \ukansan\dash@G\dash@G@
  \Mulvec\dash@L@\dashln@uv\dashln@Lv
  \Mulvec\dash@G@\dashln@uv\dashln@Gv
  \Add\dash@L@\dash@G@\dash@LG@
  \@Div\d@@dashln\dash@LG@\dashln@tmp
  \Int\dashln@tmp\dashln@N
  \ifnum\dashln@N>\z@
    \edef\dashln@S{(#1,#2)}%
    \Ifor*\dashln@i{1}\dashln@N\Do{%
      \Addvec\dashln@S\dashln@Lv\dashln@E
      \edef\dashln@tmp{\dashln@S\dashln@E}%
      \expandafter\drawline\dashln@tmp
      \Addvec\dashln@E\dashln@Gv\dashln@S
    }%
%   \Addvec\dashln@S\dashln@Lv\dashln@E
%   \Kyori{(#1,#2)}\dashln@E\dashln@d
%   \ifdim\dashln@d\p@>\d@@dashln\p@\edef\dashln@E{(#3,#4)}\fi
%     \edef\dashln@tmp{\dashln@S\dashln@E}%
    \edef\dashln@tmp{\dashln@S(#3,#4)}%
    \expandafter\drawline\dashln@tmp
  \fi
  \@dashln(#3,#4)%
}%
%
\def\Hasen{\@ifstar{\oHasen}{\cHasen}}%
\def\cHasen{\begingroup
  \ifnum\EMps@mode=\@ne\gsave\fi
  \edef\hasen@L{\@hasen@L}\edef\hasen@G{\@hasen@G}%
  \@ifnextchar[{\Hasen@}{\@Hasen}}%
\def\Hasen@[#1]#2{\setkeys{emP@hasen}{#1}\@Hasen{#2}}%
\def\@Hasen#1{\edef\Hasen@tmp{#1}\put(0,0){%
%   \ifx\empty\iro@\else\color{\iro@}\fi
    \expandafter\@hasen\Hasen@tmp}%
  \ifnum\EMps@mode=\@ne\grestore\fi
  \endgroup}%
%
\def\oHasen{\begingroup
  \ifnum\EMps@mode=\@ne\gsave\fi
  \edef\hasen@L{\@hasen@L}\edef\hasen@G{\@hasen@G}%
  \@ifnextchar[{\oHasen@}{\@oHasen}}%
\def\oHasen@[#1]#2{\setkeys{emP@hasen}{#1}\@oHasen{#2}}%
\def\@oHasen#1{\edef\Hasen@tmp{#1}\put(0,0){\expandafter\@ohasen\Hasen@tmp}%
  \ifnum\EMps@mode=\@ne\grestore\fi
  \endgroup}%
%
\def\Hasens#1{{%
  \Cfor{\edef\Hasens@a{#1}}{\not\equal\Hasens@a\empty}{%
    \edef\Hasens@a{\Hasens@b}}\do{%
    \strsep\Hasens@a{;}\Hasens@a\Hasens@b\Hasen\Hasens@a}}}%
%
\def\oHasens#1{{%
  \Cfor{\edef\oHasens@a{#1}}{\not\equal\oHasens@a\empty}{%
    \edef\oHasens@a{\oHasens@b}}\do{%
    \strsep\oHasens@a{;}\oHasens@a\oHasens@b\oHasen\oHasens@a}}}%
%
% 縦罫線（破線）
% \vHasen[高さ]{深さ}%
%
\def\vHasen{\@ifnextchar[{\@vHasen}{\setbox0=\hbox{(}\@vHasen[\ht0]}}%
\def\@vHasen[#1]#2{{\unitlength=10mm\relax
  \@tempdima=#1\relax \@Div{\strip@pt\@tempdima}{\strip@pt\unitlength}\vHasen@h
  \@tempdima=#2\relax \@Div{\strip@pt\@tempdima}{\strip@pt\unitlength}\vHasen@d
  \begin{picture}(0,0)\Hasen{(0,\vHasen@h)(0,-\vHasen@d)}\end{picture}}}%
%
% 鎖線
%
\def\Chainline{\begingroup\@ifnextchar<{\Chainline@}{\@Chainline}}%
\def\Chainline@<#1>{\setkeys{emP}{#1}\@Chainline}%
\def\@Chainline{\@ifnextchar[{\@@Chainline}{\@@Chainline[.1]}}%
\def\@@Chainline[#1]{\@ifnextchar[{\@@@Chainline[#1]}{%
  \@@@Chainline[#1][.04]}}%
\def\@@@Chainline[#1][#2]#3{%
  \edef\Chainline@t{[#1][#2]#3}%
  \expandafter\chainline\Chainline@t\endgroup}%
%
\def\ChainLine{\@ifnextchar[{\@ChainLine}{\@ChainLine[.1]}}%
\def\@ChainLine[#1]{\@ifnextchar[{\@@ChainLine[#1]}{%
  \@@ChainLine[#1][.04]}}%
\def\@@ChainLine[#1][#2]#3#4{{%
  \Subvec{#4}{#3}\CL@e
  \Kyori{#3}{#4}\CL@l
  \@Div{1}{\CL@l}\CL@tmp
  \Mulvec\CL@tmp\CL@e\CL@e% 単位ベクトル
  \@ifundefined{cur@halflinewidth}{%
    \@tempdima\@halfwidth
  }{%
    \@Div{\cur@halflinewidth}{10}\CL@tmp
    \@tempdima\CL@tmp\p@
  }
  \advance\@tempdima 0.15\p@
  \edef\CL@r{\the\@tempdima}%
  \Cfor{\edef\CL@t{0}\edef\CL@a{#3}}{%
    \lengthtest{\CL@t pt<\CL@l pt}}{}\do{%
      \Add\CL@t{#1}\CL@t
      \ifdim\CL@t pt>\CL@l pt\relax\edef\CL@t{\CL@l}\fi
      \Mulvec\CL@t\CL@e\CL@b
      \Addvec{#3}\CL@b\CL@b
%     \Drawline{\CL@a\CL@b}%
      \edef\CL@tmp{\CL@a\CL@b}%
      \expandafter\drawline\CL@tmp
      \Add\CL@t{#2}\CL@t
      \ifdim\CL@t pt>\CL@l pt\relax\else
        \Mulvec\CL@t\CL@e\CL@a
        \Addvec{#3}\CL@a\CL@a
%        \Kuromaru[.15pt]\CL@a%
        \Kuromaru[\CL@r]\CL@a%
      \fi
      \Add\CL@t{#2}\CL@t
      \Mulvec\CL@t\CL@e\CL@a
      \Addvec{#3}\CL@a\CL@a
    }%
}}%
%
%\def\chainline{\@ifnextchar[{\chainline@}{\chainline@[.1]}}%
\DeclareRobustCommand\chainline{\@ifnextchar[{\chainline@}{\chainline@[.1]}}%
\def\chainline@[#1]{\@ifnextchar[{\chainline@@[#1]}{%
  \chainline@@[#1][.04]}}%
\def\chainline@@[#1][#2]{\edef\chainline@len{#1}\edef\chainline@gap{#2}%
  \@ifnextchar({\@chainline}{\relax}}%
\def\@chainline(#1,#2){\edef\chain@P{(#1,#2)}\@@chainline}%
\def\@@chainline{\@ifnextchar({\@@@chainline}{\relax}}%
\def\@@@chainline(#1,#2){%
  \ChainLine[\chainline@len][\chainline@gap]\chain@P{(#1,#2)}%
  \edef\chain@P{(#1,#2)}\@@chainline}%
%
% 格子（碁盤状の街路図）
%   \kousi<#1>(#2,#3)#4#5
%       #1 : key=val
%             nuri=...
%                  塗りを行うセルの左下の座標を
%                  \Nuritubusiへのオプションとともに ; 区切りで記述
%             put=....
%       #2 : 横方向1区画の長さ（デフォルト=1）
%       #3 : 縦方向1区画の長さ（デフォルト=1）
%       #4 : 横方向のブロック数
%       #5 : 縦方向のブロック数
%       置く位置は \put で指定する．
%
%   \kousiput, \kousiPut
%   \kousiKuromaru, \kousikuromaru
%   \kousiSiromaru, \kousisiromaru
%
\define@key{kousi}{nuri}{\def\kousi@nuri{#1}}%
\define@key{kousi}{put}{\def\kousi@put{#1}}%
\define@key{kousi}{sensyu}{\def\sensyu{#1}}%
\define@key{kousi}{border}[1]{\edef\draw@border{#1}}%
\define@key{kousi}{drawborder}[1]{\edef\draw@border{#1}}%
\define@key{kousi}{borderlinethickness}{\edef\border@thickness{#1}}%
\define@key{kousi}{kousilinethicknesss}{\edef\kousi@thickness{#1}}%
\define@key{kousi}{innerlinethickness}{\edef\kousi@thickness{#1}}%
\define@key{kousi}{linethickness}{\edef\border@thickness{#1}\edef\kousi@thickness{#1}}%
\define@key{kousi}{iro}{\edef\kousi@color{#1}\edef\border@color{#1}}%
\define@key{kousi}{color}{\edef\kousi@color{#1}\edef\border@color{#1}}%
\define@key{kousi}{kousicolor}{\edef\kousi@color{#1}}%
\define@key{kousi}{innercolor}{\edef\kousi@color{#1}}%
\define@key{kousi}{bordercolor}{\edef\border@color{#1}}%
\define@key{kousi}{hasenLG}{\edef\kousi@hasenLG{#1}\edef\border@hasenLG{#1}}%
\define@key{kousi}{dash}{\edef\kousi@hasenLG{#1}\edef\border@hasenLG{#1}}%
\define@key{kousi}{kousihasenLG}{\edef\kousi@hasenLG{#1}}%
\define@key{kousi}{innerdash}{\edef\kousi@hasenLG{#1}}%
\define@key{kousi}{borderhasenLG}{\edef\border@hasenLG{#1}}%
\define@key{kousi}{borderdash}{\edef\border@hasenLG{#1}}%
\define@key{kousi}{kuromaru}[1]{\edef\put@kuromaru{#1}}%
%
\xdef\kousi@xscale{1}%
\xdef\kousi@yscale{1}%
%
  \let\kousinuricmd\emPaint
%
\def\kousi{\@ifnextchar<{\@kousi}{\@kousi<\empty>}}%
\def\@kousi<#1>{\@ifnextchar({\@@kousi<#1>}{\@@kousi<#1>(1,1)}}%
\def\@@kousi<#1>(#2,#3)#4#5{%
  \xdef\kousi@xscale{#2}%
  \xdef\kousi@yscale{#3}%
{%
  \edef\border@thickness{\the\@wholewidth}%
  \edef\kousi@thickness{\the\@wholewidth}%
  \ifnum\EMps@mode=\@ne
    \gsave
  \fi
  \edef\kousi@color{\empty}%
  \edef\border@color{\empty}%
  \edef\kousi@hasenLG{\empty}%
  \edef\border@hasenLG{\empty}%
  \edef\put@kuromaru{0}%
%
  \def\@kousinuri##1(##2,##3){%
%\typeout{@kousinuri:arg=##1(##2,##3)}%
    \Mul{##2}{#2}\kousinuri@x\Add\kousinuri@x{#2}\kousinuri@xx
    \Mul{##3}{#3}\kousinuri@y\Add\kousinuri@y{#3}\kousinuri@yy
    \edef\kousinuri@tmp{%
      ##1{(\kousinuri@x,\kousinuri@y)(\kousinuri@xx,\kousinuri@y)%
      (\kousinuri@xx,\kousinuri@yy)(\kousinuri@x,\kousinuri@yy)}}%
%    \expandafter\Nuritubusi\kousinuri@tmp
    \expandafter\kousinuricmd\kousinuri@tmp
  }%
  \def\@@kousiput##1{%
    \@ifnextchar[{\@@@kousiput{##1}}{%
      \@ifnextchar({\@@@@kousiput{##1}}{%
        \@@@@@kousiput{##1}}}}%
  \def\@@@kousiput##1[##2]##3\@nil{%
    \Put{##1}[##2]{##3}}%
  \def\@@@@kousiput##1(##2,##3)[##4]##5\@nil{%
    \Put{##1}(##2,##3)[##4]{##5}}%
  \def\@@@@@kousiput##1##2\@nil{%
    \Put{##1}{##2}}%
  \def\@kousiput(##1,##2)##3\@nil{%
    \Mul{##1}{#2}\kousiput@x
    \Mul{##2}{#3}\kousiput@y
    \def\@kousiput@a{{(\kousiput@x,\kousiput@y)}##3\@nil}%
    \expandafter\@@kousiput\@kousiput@a
  }%
%
%    \Strchr{#1}{=}\kousi@tmp
%    \ifnum\kousi@tmp>\z@\setkeys{kousi}{#1}\fi
    \ifx\empty #1\else\setkeys{kousi}{#1}\fi
    \@ifundefined{kousi@nuri}{}{%
      \argsep{\kousi@nuri}{;}{kousinuri@a}\kousinuri@n
      \Cfor{\edef\kousinuri@i{0}}{\kousinuri@i<\kousinuri@n}{}\do{%
        \Incr\kousinuri@i
        \edef\kousinuri@arg{%
          \csname kousinuri@a\EMromannumeral\kousinuri@i\endcsname}%
        \expandafter\@kousinuri\kousinuri@arg
      }%
    }%
    \@ifundefined{kousi@put}{}{%
      \Cfor{\def\kousiput@a{\kousi@put}}{\not\equal\kousiput@a\empty}{}\do{%
        \expandafter\Strsep\kousiput@a{;}\kousiput@b\kousiput@c
        \expandafter\@kousiput\kousiput@b\@nil
        \def\kousiput@a{\kousiput@c}}%
    }%
    \Mul{#4}{#2}\x@len%
    \Mul{#5}{#3}\y@len%
    \Add\x@len{#2}\x@max%
    \Add\y@len{#3}\y@max%
    \put(0,0){%
        \Sub\y@max{#3}\y@max@
        \Sub\x@max{#2}\x@max@
        \EMedef\kousi@opt{<linethickness=\kousi@thickness}%
        \ifx\empty\kousi@hasenLG\else
          \EMedefappend\kousi@opt{,hasenLG={\kousi@hasenLG}}%
        \fi
        \ifx\empty\kousi@color\else
          \EMedefappend\kousi@opt{,iro=\kousi@color}%
        \fi
        \EMedefappend\kousi@opt{>}%
        \For\kousi@@y{#3}\y@max@{#3}\Do{%
          \expandafter\Drawline\kousi@opt{(0,\kousi@@y)(\x@len,\kousi@@y)}%
        }%
        \For\kousi@@x{#2}\x@max@{#2}\Do{%
          \expandafter\Drawline\kousi@opt{(\kousi@@x,0)(\kousi@@x,\y@len)}%
        }%
    }%
    \put(0,0){%
        \ifthenelse{\equal{\draw@border}{0}}{}{%
          \Sub\x@max{#2}\kousi@@x
          \Sub\y@max{#3}\kousi@@y
          \edef\border@opt{<linethickness=\border@thickness}%
          \ifx\empty\border@hasenLG\else
            \edefappend\border@opt{,hasenLG={\border@hasenLG}}%
          \fi
          \ifx\empty\border@color\else
            \edefappend\border@opt{,iro=\border@color}%
          \fi
          \edefappend\border@opt{>}%
          \edef\kyoukai@sen{%
            (0,0)(\kousi@@x,0)(\kousi@@x,\kousi@@y)(0,\kousi@@y)}%
          \expandafter\Takakkei\border@opt{\kyoukai@sen}%
        }%
    }%
    \ifnum\put@kuromaru>\z@
      \Ifor\x@val{0}{#4}\Do{%
        \Ifor\y@val{0}{#5}\Do{%
          \kousiKuromaru{(\x@val,\y@val)}%
        }%
      }%
    \fi
    \ifnum\EMps@mode=\@ne\grestore\fi
}}%
%
\def\kousiput(#1,#2){%
  \Mul{#1}\kousi@xscale\kousiput@x
  \Mul{#2}\kousi@yscale\kousiput@y
  \emathPut{(\kousiput@x,\kousiput@y)}}%
\def\kousiPut#1{%
  \vecXY{#1}\kousiPut@x\kousiPut@y
  \Mul\kousiPut@x\kousi@xscale\kousiPut@x
  \Mul\kousiPut@y\kousi@yscale\kousiPut@y
  \emathPut{(\kousiPut@x,\kousiPut@y)}}%
%
\def\kousiKuromaru{\@ifnextchar[{\@kousiKuromaru}{%
  \@kousiKuromaru[\Kuromaru@Hankei]}}%
\def\@kousiKuromaru[#1]#2{%
  \vecXY{#2}\kousikuromaru@x\kousikuromaru@y
  \Mul\kousikuromaru@x\kousi@xscale\kousikuromaru@x
  \Mul\kousikuromaru@y\kousi@yscale\kousikuromaru@y
  \Kuromaru[#1]{(\kousikuromaru@x,\kousikuromaru@y)}}%
\def\kousikuromaru{\@ifnextchar[{\@kousikuromaru}{\@kousikuromaru[\Kuromaru@Hankei]}}%
\def\@kousikuromaru[#1]#2{%
  \Cfor{\edef\kousikuromaru@a{#2}}{\not\equal{\kousikuromaru@a}{\empty}}{}\do{%
    \strsep{\kousikuromaru@a}{;}\kousikuromaru@a\kousikuromaru@b%
    \kousiKuromaru[#1]\kousikuromaru@a
    \edef\kousikuromaru@a{\kousikuromaru@b}}}%
\def\kousiSiromaru{\@ifnextchar[{\@kousiSiromaru}{%
  \@kousiSiromaru[\Kuromaru@Hankei]}}%
\def\@kousiSiromaru[#1]#2{%
  \vecXY{#2}\kousisiromaru@x\kousisiromaru@y
  \Mul\kousisiromaru@x\kousi@xscale\kousisiromaru@x
  \Mul\kousisiromaru@y\kousi@yscale\kousisiromaru@y
  \Siromaru[#1]{(\kousisiromaru@x,\kousisiromaru@y)}}%
\def\kousisiromaru{\@ifnextchar[{\@kousisiromaru}{\@kousisiromaru[\Kuromaru@Hankei]}}%
\def\@kousisiromaru[#1]#2{%
  \Cfor{\edef\kousisiromaru@a{#2}}{\not\equal{\kousisiromaru@a}{\empty}}{}\do{%
    \strsep{\kousisiromaru@a}{;}\kousisiromaru@a\kousisiromaru@b%
    \kousiSiromaru[#1]\kousisiromaru@a
    \edef\kousisiromaru@a{\kousisiromaru@b}}}%
%
\def\kousifill{\@ifnextchar<{\@kousifill}{\@kousifill<\empty>}}%
\def\@kousifill<#1>{{% ベースとなる (ps)zahyou平面全体に拡がる格子
  \define@key{emP}{ex}{%
    \def\use@exy{}%
    \headchar{##1}\ex@h\ex@r
    \ifthenelse{\equal\ex@h{r}}{%
      \expandafter\Rdef\ex@r\az@ex
    }{%
      \edef\az@ex{##1}%
    }%
  }%
  \define@key{emP}{ey}{%
    \def\use@exy{}%
    \headchar{##1}\ex@h\ex@r
    \ifthenelse{\equal\ex@h{r}}{%
      \expandafter\Rdef\ex@r\az@ey
    }{%
      \edef\az@ey{##1}%
    }%
  }%
%
  \ifnum\EMps@mode=\@ne\gsave\fi
  \edef\az@ex{(1,0)}%
  \edef\az@ey{(0,1)}%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
  \Cfor{\edef\ak@x{0}\edef\ak@done{0}\edef\akousi@tmp{\O}}{\ak@done=\z@}{}\do{%
    \Landl\trueLT\trueRT\akousi@tmp\az@ey\az@tmp
    \vecXY\az@tmp\az@x@\az@y@
    \Landl\trueLB\trueRB\akousi@tmp\az@ey\az@tmp
    \vecXY\az@tmp\az@x@@\az@y@@
    \ifdim\az@x@\p@<\truexmin\p@
      \ifdim\az@x@@\p@<\truexmin\p@\edef\ak@done{1}\fi
    \fi
    \ifdim\az@x@\p@>\truexmax\p@
      \ifdim\az@x@@\p@>\truexmax\p@\edef\ak@done{1}\fi
    \fi
    \ifnum\ak@done=\z@
      \lline\akousi@tmp\az@ey
      \Incr\ak@x
      \Addvecself\akousi@tmp\az@ex
    \fi
  }%
  \Cfor{\edef\ak@x{0}\edef\ak@done{0}\edef\akousi@tmp{\O}}{\ak@done=\z@}{}\do{%
    \Landl\trueLT\trueRT\akousi@tmp\az@ey\az@tmp
    \vecXY\az@tmp\az@x@\az@y@
    \Landl\trueLB\trueRB\akousi@tmp\az@ey\az@tmp
    \vecXY\az@tmp\az@x@@\az@y@@
    \ifdim\az@x@\p@<\truexmin\p@
      \ifdim\az@x@@\p@<\truexmin\p@\edef\ak@done{1}\fi
    \fi
    \ifdim\az@x@\p@>\truexmax\p@
      \ifdim\az@x@@\p@>\truexmax\p@\edef\ak@done{1}\fi
    \fi
    \ifnum\ak@done=\z@
      \lline\akousi@tmp\az@ey
      \Decr\ak@x
      \Subvecself\akousi@tmp\az@ex
    \fi
  }%
%
  \Cfor{\edef\ak@x{0}\edef\ak@done{0}\edef\akousi@tmp{\O}}{\ak@done=\z@}{}\do{%
    \Landl\trueLT\trueLB\akousi@tmp\az@ex\az@tmp
    \vecXY\az@tmp\az@x@\az@y@
    \Landl\trueRT\trueRB\akousi@tmp\az@ex\az@tmp
    \vecXY\az@tmp\az@x@@\az@y@@
    \ifdim\az@y@\p@<\trueymin\p@
      \ifdim\az@y@@\p@<\trueymin\p@\edef\ak@done{1}\fi
    \fi
    \ifdim\az@y@\p@>\trueymax\p@
      \ifdim\az@y@@\p@>\trueymax\p@\edef\ak@done{1}\fi
    \fi
    \ifnum\ak@done=\z@
      \lline\akousi@tmp\az@ex
      \Incr\ak@x
      \Addvecself\akousi@tmp\az@ey
    \fi
  }%
  \Cfor{\edef\ak@x{0}\edef\ak@done{0}\edef\akousi@tmp{\O}}{\ak@done=\z@}{}\do{%
    \Landl\trueLT\trueLB\akousi@tmp\az@ex\az@tmp
    \vecXY\az@tmp\az@x@\az@y@
    \Landl\trueRT\trueRB\akousi@tmp\az@ex\az@tmp
    \vecXY\az@tmp\az@x@@\az@y@@
    \ifdim\az@y@\p@<\trueymin\p@
      \ifdim\az@y@@\p@<\trueymin\p@\edef\ak@done{1}\fi
    \fi
    \ifdim\az@y@\p@>\trueymax\p@
      \ifdim\az@y@@\p@>\trueymax\p@\edef\ak@done{1}\fi
    \fi
    \ifnum\ak@done=\z@
      \lline\akousi@tmp\az@ex
      \Decr\ak@x
      \Subvecself\akousi@tmp\az@ey
    \fi
  }%
  \ifnum\EMps@mode=\@ne\grestore\fi
}}%
%
% Bezier
%
\def\Qbezier{\@ifnextchar[{\@Qbezier}{\@Qbezier[0]}}%
\def\@Qbezier[#1]#2#3#4{\edef\Qbezier@tmp{[#1]#2#3#4}\expandafter\qbezier\Qbezier@tmp}%
%
% spline 曲線
%
\def\emtpic@command{sp}%
\def\emtpic@Bz{2}%  default=1 (Bezier); 0 (spline)
%
\define@key{emP}{tpicBz}{\def\emtpic@Bz{#1}}%
\define@key{emP}{tpiccom}{\def\emtpic@command{#1}}%
%
\def\emdrawtpic{\bgroup\@killglue
% \allinethickness{0.3pt}% 2004/01/24 コメントアウト
  \@gphlinewidth\@wholewidth \divide\@gphlinewidth 4736
  \special{pn \the\@gphlinewidth}%
  \ifnum\emtpic@Bz=\tw@\else\special{Bz \emtpic@Bz}\fi
  \@ifundefined{noudo@}{}{%
    \special{sh \noudo@}%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 塗り
  }%
  \@emdrawtpic}%
\def\@emdrawtpic{\@ifnextchar({\@@@emdrawtpic}{%
    \special{\emtpic@command}\egroup\ignorespaces}}%
\def\@@@emdrawtpic(#1,#2){%
  \@ifundefined{xunitlength}{%
    \@tempdimc=#1\unitlength}{\@tempdimc=#1\xunitlength}%
  \@tempcnta \@tempdimc\relax \advance\@tempcnta 2368 \divide\@tempcnta 4736
  \@ifundefined{yunitlength}{%
    \@tempdimc=#2\unitlength}{\@tempdimc=#2\xunitlength}%
  \@tempcntb -\@tempdimc\relax \advance\@tempcntb -2368 \divide\@tempcntb 4736
  \@paspecial{\the\@tempcnta}{\the\@tempcntb}%
  \@emdrawtpic}%
%  \@ifundefined{em@dvipdfm}{%
%    \@tempdima#1\unitlength\@tempdima13.837\@tempdima%
%    \@tempdimb#2\unitlength\@tempdimb-13.837\@tempdimb%
%  }{%
%    \iftdir
%      \@tempdima#2\unitlength\@tempdima13.837\@tempdima%
%      \@tempdimb#1\unitlength\@tempdimb13.837\@tempdimb%
%    \else
%      \@tempdima#1\unitlength\@tempdima13.837\@tempdima%
%      \@tempdimb#2\unitlength\@tempdimb-13.837\@tempdimb%
%    \fi
%  }%
%  \special{pa \@seisuu\@tempdima\space\@seisuu\@tempdimb}%
%
\def\emDrawtpic{\@ifnextchar[{\@emDrawtpic}{\@emDrawtpic[\empty]}}%
\def\ph@drawwaku@{0}%
\def\phdrawwaku#1{\def\ph@drawwaku@{#1}}%
\def\@emDrawtpic[#1]#2{{%
  \edef\ph@drawwaku{\ph@drawwaku@}%
  \edef\yazirusi@opt{\empty}%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
  \@ifundefined{@yscale}{\edef\emDrawtpic@tmp{#2}}{\xyhenkan{#2}\emDrawtpic@tmp}%
  \ifnum\ph@drawwaku>\z@\Drawline{#2}\fi
  \put(0,0){\expandafter\emdrawtpic\emDrawtpic@tmp}%
%
  \ifx\empty\yazirusi@opt\else
    \edef\Drawtpic@t{#2}%
    \expandafter\makeTenHairetu\Drawtpic@t%
    \ifthenelse{\equal\yazirusi@opt{a}\or\equal\yazirusi@opt{b}}{%
      \edef\Drawtpic@P{\hairetu{TH@V}{\TH@N}}%
      \ISub\TH@N{1}\TH@Ni
      \edef\Drawtpic@Pi{\hairetu{TH@V}{\TH@Ni}}%
      \Subvec\Drawtpic@P\Drawtpic@Pi\Drawtpic@v
      \Yaziri\Drawtpic@P\Drawtpic@v
    }{}%
    \ifthenelse{\equal\yazirusi@opt{r}\or\equal\yazirusi@opt{b}}{%
      \edef\Drawtpic@P{\hairetu{TH@V}{1}}%
      \edef\Drawtpic@Pi{\hairetu{TH@V}{2}}%
      \Subvec\Drawtpic@P\Drawtpic@Pi\Drawtpic@v
      \Yaziri\Drawtpic@P\Drawtpic@v
    }{}%
  \fi
%
}}%
\let\Drawtpic\emDrawtpic
%
% 順序を逆転させた点列
%
\def\gyakutenretu#1#2{%
% #1 : 元点列
% #2 : 逆転させた点列を受け取る制御綴
%
  \def\@gyakutenretu{\@ifnextchar({\@@gyakutenretu}{\relax}}%
  \def\@@gyakutenretu(##1){\EMedeffrontappend#2{(##1)}\@gyakutenretu}%
%
  \EMedef\tenretu@org{#1}%
  \edef#2{}%
  \expandafter\@gyakutenretu\tenretu@org
}%
%
% 複数の点の定義とラベルつけ
% \tenretu#1
% \tenretu<#1>#2
%    #1 : key=val
%         perl : 座標成分を perl で計算する。
% \tenretu*#1（定義のみ  ラベル付けはオプション）
% \rtenretu[#1]#2 (極座標形式を前提 #1：極〔デフォルトは原点〕)
% \rtenretu*[#1]#2（定義のみ  ラベル付けはオプション）
%   #2 は点列を `;' で区切った列
%     #2は
%       [##1]##2(##3,##4)##5
%     の形式で点列を `;' で区切る。
%       ##1 : オプションで，点の位置に置く文字列
%             （省略時は，##2 と同じ）
%       ##2 : \##2 という変数の頂点名
%       [r] : をつけると極座標形式とみなす
%       [s] : をつけると相対移動とみなす
%       (##3,##4) : 頂点の座標
%       ##5 : 頂点の近傍に置く文字列の配置オプション
%             [方角] オプションに限り区切子 `[', `]' を省略可能
%  \edef\##2{(##3,##4)}として，点\##2 が定義され，
%  \Put に
%       \Put\##2##5{##1}%
%  として引き渡される。）
%
\let\tenretu@Put\emathPut
\newtoks\tenretu@namae
\newtoks\namae@opt
%
\def\@tenretu@seppara{%
  \@ifnextchar[{\@tenretu@seppara@}{%
  \namae@opt={}\@@tenretu@seppara}}%
\def\@tenretu@seppara@[#1]{%
  \namae@opt={[#1]}%
  \@@tenretu@seppara}%
\def\@@tenretu@seppara#1(#2,#3\@nil{%
  \tenretu@namae={#1}%
  \edef\tenretu@x{#2}%
  \EMedef\tenretu@yn{#3}%
  \def\tenretu@y{}%
  \def\tenretu@n{}%
  \def\tenretu@k{1}%
  \def\tenretu@kubun{y}%
  \expandafter\@tfor\expandafter\tenretu@c\expandafter:\expandafter=\tenretu@yn
  \do{%
    \if y\tenretu@kubun
      \if(\tenretu@c\Incr\tenretu@k
        \edefappend\tenretu@y{\tenretu@c}%
      \else\if)\tenretu@c\Decr\tenretu@k
        \ifnum\tenretu@k=\z@\edef\tenretu@kubun{n}%
        \else\edefappend\tenretu@y{\tenretu@c}\fi
      \else
        \edefappend\tenretu@y{\tenretu@c}%
      \fi\fi
    \else
      \EMedefappend\tenretu@n{\tenretu@c}%
    \fi
  }%
  \ifnum\tenretu@k>\z@\errmessage{tenretu : syntax error !}\fi
\ifnum\by@perl@retu=\z@
  \isnumber{\tenretu@x}{}{%
    \Okikae\tenretu@x{OLDX}\old@x\tenretu@x
    \fpcalcval{\tenretu@x}\tenretu@x}%
  \isnumber{\tenretu@y}{}{%
    \Okikae\tenretu@y{OLDY}\old@y\tenretu@y
    \fpcalcval{\tenretu@y}\tenretu@y}%
\else
  \retu@calcval[s]{(\tenretu@x)}\tenretu@x
  \retu@calcval[s]{(\tenretu@y)}\tenretu@y
\fi
}%
%
\def\tenretu{%
  \edef\oresen@name{\empty}%
  \edef\oresen@tmp{\empty}%
  \edef\old@x{0}%
  \edef\old@y{0}%
%  \edef\TR@opt{\empty}%
  \edef\save@mathmode{\Put@math}%
  \edef\save@byouga@dousa{\byouga@dousa}%
  \edef\save@iro@{\iro@}%
  \edef\byouga@dousa{\empty}%
  \edef\v@mark{\empty}%
  \edef\v@mark@tenretu{\empty}%
  \edef\by@perl@retu{0}%
  \edef\O@@{(0,0)}%
  \def\put@kuromaru{0}%
  \def\show@label{1}%
  \let\retu@calcval\calcval
  \let\@nahudaKuromaru\Kuromaru
  \edef\tenretu@kizyunten{(0,0)}%
\leavevmode
  \@ifstar{\def\show@label{0}\ten@retu}{\ten@retu}}%
\def\ten@retu{\@ifnextchar[{\@tenretu@@}{\@tenretu@@@}}%
\def\@tenretu@@[#1]{\edef\tenretu@kizyunten{#1}\@tenretu@@@}%
\def\@tenretu@@@{\ifthenelse{\show@label=\z@}{\ntenretu}{\ltenretu}}%
\def\ltenretu{\def\by@perl{\by@perl@}%
  \@ifnextchar<{\ltenretu@opt}{\@ltenretu}}%
\def\ltenretu@opt<#1>{\setkeys{emP}{#1}%
    \EMedef\v@mark@tenretu{\v@mark}%
%  \EMedef\TR@opt{#1}%
  \ifx\empty\byouga@dousa\else
    \ifx\empty\oresen@name\edef\oresen@name{oresen@i}\fi
  \fi
  \edef\by@perl@retu{\by@perl}\edef\by@perl{\by@perl@}%
  \@ltenretu}%
\def\@ltenretu#1{%
% -----------------------------------------------------
% subroutine
\def\@tenretu@sub{\@ifnextchar[{\@@tenretu@sub}{\@@tenretu@sub[\empty]}}%
\def\@@tenretu@sub[##1]##2(##3,##4){%
  \@ifnextchar({\@@tenretusub@std[##1]##2(##3,##4)}{%
  \@ifnextchar[{\@@tenretusub@std[##1]##2(##3,##4)}{%
    \@@tenretusub@brev[##1]##2(##3,##4)}}}%
\def\@@tenretusub@brev[##1]##2(##3,##4)##5\@nil{%
  \ifthenelse{\equal{##5}{}}{%
  \@@tenretusub@std[##1]##2(##3,##4)\@nil}{%
  \@@tenretusub@std[##1]##2(##3,##4)[##5]\@nil}}%
\def\@@tenretusub@std[##1]##2(##3,##4)##5\@nil{%
  \ifnum\tenretu@kyokuzahyou>\z@
    \ifnum\by@perl@retu>\z@
      \perlRdef(##3,##4)\@OresenV
    \else
      \Rdef(##3,##4)\@OresenV
    \fi
  \else
    \edef\@OresenV{(##3,##4)}%
  \fi
  \ifthenelse{\equal\tenretu@kizyunten\O@@}{}{%
    \Addvecself\@OresenV\tenretu@kizyunten}%
  \ifnum\tenretu@soutaizahyou>\z@\Addvec\@OresenV@old\@OresenV\@OresenV\fi
  \expandafter\edef\csname ##2\endcsname{\@OresenV}%
  \EMedef\@tenretu@subtmp{{\csname ##2\endcsname}##5}%
  \ifx\empty##1\edef\tenretu@Vname@{##2}\else\def\tenretu@Vname@{##1}\fi
  \ifnum\show@label=\z@\edef\tenretu@Vname@{}\fi
  \ifx\empty\oresen@name\else
    \edefappend\oresen@tmp{\csname ##2\endcsname}%
  \fi
  \expandafter\tenretu@Put\@tenretu@subtmp{\modify@str{\tenretu@Vname@}}%
  \ifx\empty\v@mark@tenretu
    \ifnum\put@kuromaru>\z@\@nahudaKuromaru{\@nameuse{##2}}\fi
  \else
    \emathPut{\@nameuse{##2}}[c]{\v@mark@tenretu}%
    \edef\v@mark{\empty}%
  \fi
  \vecXY\@OresenV\s@x\s@y
  \@ifundefined{syaeiX}{}{%
    \expandafter\edef\csname ##2syaeiX\endcsname{\syaeiX}%
    \expandafter\edef\csname ##2syaeix\endcsname{\syaeix}}%
  \@ifundefined{syaeiY}{}{%
    \expandafter\edef\csname ##2syaeiY\endcsname{\syaeiY}%
    \expandafter\edef\csname ##2syaeiy\endcsname{\syaeiy}}%
}%
% -----------------------------------------------------
\def\check@soutai{\edef\cs@i{\empty}%
  \@ifnextchar[{\check@soutai@}{\@check@soutai}}%
\def\check@soutai@[##1]##2\@nil{\EMedef\cs@i{[##1]}\@check@soutai##2\@nil}%
\def\@check@soutai##1(##2\@nil{%
  \edef\tenretu@kyokuzahyou{0}%
  \edef\tenretu@soutaizahyou{0}%
  \strsep{##1}{[}\cs@a\cs@b
  \ifx\empty\cs@b
    \EMedef\cs@ii{##1(##2}%
  \else
    \strsep\cs@b{]}\cs@c\cs@d
    \Strchr\cs@c{s}\cs@tmp
    \ifnum\cs@tmp>\z@\edef\tenretu@soutaizahyou{1}\fi
    \Strchr\cs@c{r}\cs@tmp
    \ifnum\cs@tmp>\z@\edef\tenretu@kyokuzahyou{1}\fi
    \EMedef\cs@ii{\cs@a(##2}%
  \fi
  \EMedef\@OresenV{\cs@i\cs@ii}
}%
% -----------------------------------------------------
  \Cfor{\def\@OresenVs{#1}}{\not\equal\@OresenVs\empty}{}\do{%
    \Strsep\@OresenVs{;}\@OresenV\@OresenVs
    \trim\@OresenVs\to\@OresenVs
\expandafter\check@soutai\@OresenV\@nil%
\Headchar\@OresenV\lt@h\lt@r
\if [\lt@h
      \Strsep\lt@r{[}\sp@a\sp@b
      \EMedef\sp@a{[\sp@a}%
\else
      \Strsep\@OresenV{[}\sp@a\sp@b
\fi
      \ifx\empty\sp@b
        \expandafter\@tenretu@seppara\@OresenV\@nil
        \edef\@OresenV{%
          \the\namae@opt\the\tenretu@namae(\tenretu@x,\tenretu@y)\tenretu@n}%
      \else
        \expandafter\@tenretu@seppara\sp@a\@nil
        \EMedef\@OresenV{%
          \the\namae@opt\the\tenretu@namae(\tenretu@x,\tenretu@y)\tenretu@n[\sp@b}%
      \fi
    \expandafter\@tenretu@sub\@OresenV\@nil
    \EMedef\@OresenV@old{\@OresenV}%
    \edef\old@x{\tenretu@x}%
    \edef\old@y{\tenretu@y}%
  }%
  \ifx\empty\oresen@name\else
    \expandafter\edef\csname \oresen@name\endcsname{\oresen@tmp}%
    \ifx\empty\byouga@dousa\else
      \headchar\byouga@dousa\dousa@h\dousa@r
      \if D\dousa@h
        \expandafter\Drawline\dousa@r\oresen@tmp
      \else\if T\dousa@h
        \expandafter\Takakkei\dousa@r\oresen@tmp
      \else\if P\dousa@h
        \expandafter\emPaint\dousa@r\oresen@tmp
      \fi\fi\fi
    \fi
  \fi
\edef\Put@math{\save@mathmode}%
\ignorespaces
\edef\put@kuromaru{0}%
\edef\v@mark{\empty}%
\edef\byouga@dousa{\save@byouga@dousa}%
\edef\iro@{\save@iro@}%
}%
%
\def\ntenretu{%
  \@ifstar{\tenNahuda}{\ltenretu}}%
\def\@ntenretu{\@ifnextchar<{\@ntenretu@opt}{\def\by@perl{\by@perl@}%
  \@@ntenretu}}%
\def\@ntenretu@opt<#1>{%
  \def\by@perl{\by@perl@}%
  \setkeys{emP}{#1}%
  \ifx\empty\byouga@dousa\else
    \ifx\empty\oresen@name\edef\oresen@name{oresen@i}\fi
  \fi
  \edef\by@perl@retu{\by@perl}\edef\by@perl{\by@perl@}%
  \@@ntenretu}%
\def\@@ntenretu#1{%
% -----------------------------------------------------
% subroutine
\def\@ntenretu@sub{\@ifnextchar[{\@@ntenretu@sub}{\@@ntenretu@sub[\empty]}}%
\def\@@ntenretu@sub[##1]##2(##3,##4){%
  \edef\ntenretu@kyokuzahyou{0}%
  \edef\ntenretu@soutaizahyou{0}%
  \@ifnextchar({\@@ntenretusub@std[##1]##2(##3,##4)}{%
  \@ifnextchar[{\@@ntenretusub@std[##1]##2(##3,##4)}{%
    \@@ntenretusub@brev[##1]##2(##3,##4)}}}%
\def\@@ntenretusub@brev[##1]##2(##3,##4)##5\@nil{%
  \ifthenelse{\equal{##5}{}}{%
  \@@ntenretusub@std[##1]##2(##3,##4)\@nil}{%
  \@@ntenretusub@std[##1]##2(##3,##4)[##5]\@nil}}%
\def\@@ntenretusub@std[##1]##2(##3,##4)##5\@nil{%
  \ifnum\ntenretu@kyokuzahyou>\z@
    \ifnum\by@perl@retu>\z@
      \perlRdef(##3,##4)\@OresenV
    \else
      \Rdef(##3,##4)\@OresenV
    \fi
  \else
    \edef\@OresenV{(##3,##4)}%
  \fi
  \Addvecself\@OresenV\tenretu@kizyunten
  \ifnum\ntenretu@soutaizahyou>\z@\Addvec\@OresenV@old\@OresenV\@OresenV\fi
  \expandafter\edef\csname ##2\endcsname{\@OresenV}%
  \ifnum\put@kuromaru>\z@\@nahudaKuromaru{\@nameuse{##2}}\fi
  \ifx\empty\oresen@name\else
    \edefappend\oresen@tmp{\csname ##2\endcsname}%
  \fi
}%
% -----------------------------------------------------
\def\check@nsoutai{\edef\cs@i{\empty}%
  \@ifnextchar[{\check@nsoutai@}{\@check@nsoutai}}%
\def\check@nsoutai@[##1]##2\@nil{\EMedef\cs@i{[##1]}\@check@nsoutai##2\@nil}%
\def\@check@nsoutai##1(##2\@nil{%
  \edef\ntenretu@kyokuzahyou{0}%
  \edef\ntenretu@soutaizahyou{0}%
  \strsep{##1}{[}\cs@a\cs@b
  \ifx\empty\cs@b
    \EMedef\cs@ii{##1(##2}%
  \else
    \strsep\cs@b{]}\cs@c\cs@d
    \Strchr\cs@c{s}\cs@tmp
    \ifnum\cs@tmp>\z@\edef\ntenretu@soutaizahyou{1}\fi
    \Strchr\cs@c{r}\cs@tmp
    \ifnum\cs@tmp>\z@\edef\ntenretu@kyokuzahyou{1}\fi
    \EMedef\cs@ii{\cs@a(##2}%
  \fi
  \EMedef\@OresenV{\cs@i\cs@ii}
}%
% -----------------------------------------------------
  \Cfor{\edef\@OresenVs{#1}}{\not\equal\@OresenVs\empty}{}\do{%
    \Strsep\@OresenVs{;}\@OresenV\@OresenVs
    \trim\@OresenVs\to\@OresenVs
\expandafter\check@nsoutai\@OresenV\@nil%
\Headchar\@OresenV\lt@h\lt@r
\if [\lt@h
      \Strsep\lt@r{[}\sp@a\sp@b
      \EMedef\sp@a{[\sp@a}%
\else
      \Strsep\@OresenV{[}\sp@a\sp@b
\fi
      \ifx\empty\sp@b
        \expandafter\@tenretu@seppara\@OresenV\@nil
        \edef\@OresenV{%
          \the\namae@opt\the\tenretu@namae(\tenretu@x,\tenretu@y)\tenretu@n}%
      \else
        \expandafter\@tenretu@seppara\sp@a\@nil
        \EMedef\@OresenV{%
          \the\namae@opt\the\tenretu@namae(\tenretu@x,\tenretu@y)\tenretu@n[\sp@b}%
      \fi
    \expandafter\@ntenretu@sub\@OresenV\@nil
    \edef\old@x{\tenretu@x}%
    \edef\old@y{\tenretu@y}%
    \edef\@OresenV@old{\@OresenV}}%
  \ifx\empty\oresen@name\else
    \expandafter\edef\csname \oresen@name\endcsname{\oresen@tmp}%
    \ifx\empty\byouga@dousa\else
      \headchar\byouga@dousa\dousa@h\dousa@r
      \if D\dousa@h
        \expandafter\Drawline\dousa@r\oresen@tmp
      \else\if T\dousa@h
        \expandafter\Takakkei\dousa@r\oresen@tmp
      \else\if P\dousa@h
        \expandafter\emPaint\dousa@r\oresen@tmp
      \fi\fi\fi
    \fi
  \fi
  \edef\Put@math{\save@mathmode}%
  \edef\put@kuromaru{0}%
  \edef\byouga@dousa{\save@byouga@dousa}%
  \ignorespaces}%
%
\let\emPoints\tenretu
%
\def\rtenretu{%
  \edef\put@kuromaru{0}%
  \edef\oresen@name{\empty}%
  \edef\old@x{0}%
  \edef\old@y{0}%
  \edef\oresen@tmp{\empty}%
  \edef\save@mathmode{\Put@math}%
  \edef\save@byouga@dousa{\byouga@dousa}%
  \edef\byouga@dousa{\empty}%
  \edef\by@perl@retu{0}%
  \edef\Rdef@rad{0}%
  \let\retu@calcval\calcval
  \let\@nahudaKuromaru\Kuromaru
  \@ifstar{\nrtenretu}{\lrtenretu}}%
%
\def\lrtenretu{\def\by@perl{\by@perl@}%\edef\put@kuromaru{0}%
  \@ifnextchar<{\@lrtenretu@opt}{\@lrtenretu}}%
\def\@lrtenretu@opt<#1>{\setkeys{emP}{#1}%
  \ifx\empty\byouga@dousa\else
    \ifx\empty\oresen@name\edef\oresen@name{oresen@i}\fi
  \fi
  \edef\by@perl@retu{\by@perl}\edef\by@perl{\by@perl@}%
  \@lrtenretu}%
\def\@lrtenretu{\@ifnextchar[{\lrtenretu@}{\lrtenretu@[(0,0)]}}%
\def\lrtenretu@[#1]{%
  \Headchar{#1}\lrt@a\lrt@b
  \if r\lrt@a\expandafter\Rdef\lrt@b\lrtenretu@O
  \else\edef\lrtenretu@O{#1}\fi
  \@@lrtenretu}%
\def\@@lrtenretu#1{%
% -----------------------------------------------------
% subroutine
\def\@rtenretu@sub{\@ifnextchar[{\@@rtenretu@sub}{\@@rtenretu@sub[\empty]}}%
\def\@@rtenretu@sub[##1]##2(##3,##4){%
  \edef\rtenretu@kyokuzahyou{1}%
  \@ifnextchar({\@@rtenretusub@std[##1]##2(##3,##4)}{%
  \@ifnextchar[{\@@rtenretusub@std[##1]##2(##3,##4)}{%
    \@@rtenretusub@brev[##1]##2(##3,##4)}}}%
\def\@@rtenretusub@brev[##1]##2(##3,##4)##5\@nil{%
  \ifthenelse{\equal{##5}{}}{%
  \@@rtenretusub@std[##1]##2(##3,##4)\@nil}{%
  \@@rtenretusub@std[##1]##2(##3,##4)[##5]\@nil}}%
\def\@@rtenretusub@std[##1]##2(##3,##4)##5\@nil{%
  \ifnum\rtenretu@kyokuzahyou>\z@
    \ifnum\by@perl@retu>\z@
      \@perlRdef(##3,##4)\@OresenV
    \else
      \@Rdef(##3,##4)\@OresenV
    \fi
  \else
    \EMedef\@OresenV{(##3,##4)}%
  \fi
  \ifnum\rtenretu@soutaizahyou>\z@
    \Addvec\@OresenV@old\@OresenV\@OresenV
  \fi
  \Addvec\lrtenretu@O\@OresenV\@OresenV
  \expandafter\EMedef\csname ##2\endcsname{\@OresenV}%
  \EMedef\@rtenretu@subtmp{{\csname ##2\endcsname}##5}%
  \ifx\empty##1\EMedef\rtenretu@Vname@{##2}\else\def\rtenretu@Vname@{##1}\fi
  \ifnum\put@kuromaru>\z@\@nahudaKuromaru{\@nameuse{##2}}\fi
  \ifx\empty\oresen@name\else
    \EMedefappend\oresen@tmp{\csname ##2\endcsname}%
  \fi
  \expandafter\tenretu@Put\@rtenretu@subtmp\rtenretu@Vname@
}%
% -----------------------------------------------------
\def\check@rsoutai{\edef\cs@i{\empty}%
  \@ifnextchar[{\check@rsoutai@}{\@check@rsoutai}}%
\def\check@rsoutai@[##1]##2\@nil{\EMedef\cs@i{[##1]}\@check@rsoutai##2\@nil}%
\def\@check@rsoutai##1(##2\@nil{%
  \edef\rtenretu@soutaizahyou{0}%
  \strsep{##1}{[}\cs@a\cs@b
  \ifx\empty\cs@b
    \EMedef\cs@ii{##1(##2}%
  \else
    \strsep\cs@b{]}\cs@c\cs@d
    \if s\cs@c\edef\rtenretu@soutaizahyou{1}%
    \fi
    \EMedef\cs@ii{\cs@a(##2}%
  \fi
  \EMedef\@OresenV{\cs@i\cs@ii}
}%
% -----------------------------------------------------
  \Cfor{\def\@OresenVs{#1}}{\not\equal\@OresenVs\empty}{}\do{%
    \Strsep\@OresenVs{;}\@OresenV\@OresenVs
    \trim\@OresenVs\to\@OresenVs
\expandafter\check@rsoutai\@OresenV\@nil%
\Headchar\@OresenV\lt@h\lt@r
\if [\lt@h
      \Strsep\lt@r{[}\sp@a\sp@b
      \EMedef\sp@a{[\sp@a}%
\else
      \Strsep\@OresenV{[}\sp@a\sp@b
\fi
      \ifx\empty\sp@b
        \expandafter\@tenretu@seppara\@OresenV\@nil
        \EMedef\@OresenV{%
          \the\namae@opt\the\tenretu@namae(\tenretu@x,\tenretu@y)\tenretu@n}%
      \else
        \expandafter\@tenretu@seppara\sp@a\@nil
        \EMedef\@OresenV{%
          \the\namae@opt\the\tenretu@namae(\tenretu@x,\tenretu@y)\tenretu@n[\sp@b}%
      \fi
    \expandafter\@rtenretu@sub\@OresenV\@nil
    \edef\old@x{\tenretu@x}%
    \edef\old@y{\tenretu@y}%%
    \EMedef\@OresenV@old{\@OresenV}}%
  \ifx\empty\oresen@name\else
    \expandafter\EMedef\csname \oresen@name\endcsname{\oresen@tmp}%
    \ifx\empty\byouga@dousa\else
      \headchar\byouga@dousa\dousa@h\dousa@r
      \if D\dousa@h
        \expandafter\Drawline\dousa@r\oresen@tmp
      \else\if T\dousa@h
        \expandafter\Takakkei\dousa@r\oresen@tmp
      \else\if P\dousa@h
        \expandafter\emPaint\dousa@r\oresen@tmp
      \fi\fi\fi
    \fi
  \fi
    \EMedef\Put@math{\save@mathmode}%
  \EMedef\byouga@dousa{\save@byouga@dousa}%
  \EMedef\put@kuromaru{0}%
  \ignorespaces}%
%
\def\nrtenretu{\def\by@perl{\by@perl@}\@ifnextchar<{\@nrtenretu@opt}{\@nrtenretu}}%
\def\@nrtenretu@opt<#1>{\setkeys{emP}{#1}%
  \ifx\empty\byouga@dousa\else
    \ifx\empty\oresen@name\EMedef\oresen@name{oresen@i}\fi
  \fi
  \EMedef\by@perl@retu{\by@perl}\EMedef\by@perl{\by@perl@}%
  \@nrtenretu}%
\def\@nrtenretu{\@ifnextchar[{\nrtenretu@}{\nrtenretu@[(0,0)]}}%
\def\nrtenretu@[#1]{%
% \EMedef\nrtenretu@O{#1}%
  \Headchar{#1}\lrt@a\lrt@b
  \if r\lrt@a\expandafter\Rdef\lrt@b\nrtenretu@O
  \else\edef\nrtenretu@O{#1}\fi
  \@@nrtenretu}%
\def\@@nrtenretu#1{%
% -----------------------------------------------------
% subroutine
\def\@nrtenretu@sub{\@ifnextchar[{\@@nrtenretu@sub}{\@@nrtenretu@sub[\empty]}}%
\def\@@nrtenretu@sub[##1]##2(##3,##4){%
  \edef\nrtenretu@kyokuzahyou{1}%
  \@ifnextchar({\@@nrtenretusub@std[##1]##2(##3,##4)}{%
  \@ifnextchar[{\@@nrtenretusub@std[##1]##2(##3,##4)}{%
    \@@nrtenretusub@brev[##1]##2(##3,##4)}}}%
\def\@@nrtenretusub@brev[##1]##2(##3,##4)##5\@nil{%
  \ifthenelse{\equal{##5}{}}{%
  \@@nrtenretusub@std[##1]##2(##3,##4)\@nil}{%
  \@@nrtenretusub@std[##1]##2(##3,##4)[##5]\@nil}}%
\def\@@nrtenretusub@std[##1]##2(##3,##4)##5\@nil{%
  \ifnum\nrtenretu@kyokuzahyou>\z@
    \ifnum\by@perl@retu>\z@
      \@perlRdef(##3,##4)\@OresenV
    \else
      \@Rdef(##3,##4)\@OresenV
    \fi
  \else
    \EMedef\@OresenV{(##3,##4)}%
  \fi
  \ifnum\nrtenretu@soutaizahyou>\z@
    \Addvec\@OresenV@old\@OresenV\@OresenV
  \fi
  \Addvec\nrtenretu@O\@OresenV\@OresenV
  \expandafter\EMedef\csname ##2\endcsname{\@OresenV}%
  \EMedef\@nrtenretu@subtmp{{\csname ##2\endcsname}##5}%
  \ifnum\put@kuromaru>\z@\@nahudaKuromaru{\@nameuse{##2}}\fi
  \ifx\empty\oresen@name\else
    \EMedefappend\oresen@tmp{\csname ##2\endcsname}%
  \fi
  \ifx\empty##1\else\expandafter\emathPut\@nrtenretu@subtmp{##1}\fi}%
% -----------------------------------------------------
\def\check@nrsoutai{\edef\cs@i{\empty}%
  \@ifnextchar[{\check@nrsoutai@}{\@check@nrsoutai}}%
\def\check@nrsoutai@[##1]##2\@nil{\EMedef\cs@i{[##1]}\@check@nrsoutai##2\@nil}%
\def\@check@nrsoutai##1(##2\@nil{%
  \edef\nrtenretu@soutaizahyou{0}%
  \strsep{##1}{[}\cs@a\cs@b
  \ifx\empty\cs@b
    \EMedef\cs@ii{##1(##2}%
  \else
    \strsep\cs@b{]}\cs@c\cs@d
    \if s\cs@c\edef\nrtenretu@soutaizahyou{1}\fi
    \EMedef\cs@ii{\cs@a(##2}%
  \fi
  \EMedef\@OresenV{\cs@i\cs@ii}
}%
% -----------------------------------------------------
  \Cfor{\def\@OresenVs{#1}}{\not\equal\@OresenVs\empty}{}\do{%
    \Strsep\@OresenVs{;}\@OresenV\@OresenVs
    \trim\@OresenVs\to\@OresenVs
\expandafter\check@nrsoutai\@OresenV\@nil%
\Headchar\@OresenV\lt@h\lt@r
\if [\lt@h
      \Strsep\lt@r{[}\sp@a\sp@b
      \EMedef\sp@a{[\sp@a}%
\else
      \Strsep\@OresenV{[}\sp@a\sp@b
\fi
      \ifx\empty\sp@b
        \expandafter\@tenretu@seppara\@OresenV\@nil
        \edef\@OresenV{%
          \the\namae@opt\the\tenretu@namae(\tenretu@x,\tenretu@y)\tenretu@n}%
      \else
        \expandafter\@tenretu@seppara\sp@a\@nil
        \EMedef\@OresenV{%
          \the\namae@opt\the\tenretu@namae(\tenretu@x,\tenretu@y)\tenretu@n[\sp@b}%
      \fi
    \expandafter\@nrtenretu@sub\@OresenV\@nil
    \edef\old@x{\tenretu@x}%
    \edef\old@y{\tenretu@y}%
    \EMedef\@OresenV@old{\@OresenV}}%
    \ifx\empty\byouga@dousa\else
      \headchar\byouga@dousa\dousa@h\dousa@r
      \if D\dousa@h
        \expandafter\Drawline\dousa@r\oresen@tmp
      \else\if T\dousa@h
        \expandafter\Takakkei\dousa@r\oresen@tmp
      \else\if P\dousa@h
        \expandafter\emPaint\dousa@r\oresen@tmp
      \fi\fi\fi
    \fi
    \EMedef\Put@math{\save@mathmode}%
  \EMedef\put@kuromaru{0}%
  \EMedef\byouga@dousa{\save@byouga@dousa}%
  \ignorespaces}%
%
% 点に名札
%
\let\modify@str\relax
%
\def\tenNahuda@sub{\@ifnextchar[{\@tenNahuda@sub}{\@tenNahuda@sub[\empty]}}%
\def\@tenNahuda@sub[#1]#2\@nil{%
%\typeout{@tenNahuda@sub:[#1]#2}%\xxx
  \Strsep{#2}{(}\tenNahuda@sub@P\tenNahuda@sub@opt
  \ifx\empty\tenNahuda@sub@opt
    \Strsep{#2}{[}\tenNahuda@sub@P\tenNahuda@sub@opt
    \ifx\empty\tenNahuda@sub@opt
      \ifx\empty #1\relax
        \EMedef\tenNahuda@l{\tenNahuda@sub@P}%
      \else
        \EMedef\tenNahuda@l{#1}%
      \fi
      \EMedef\tenNahuda@tmp{{\@nameuse{\tenNahuda@sub@P}}(0,0)[lb]}%
    \else
      \ifx\empty #1\relax
        \EMedef\tenNahuda@l{\tenNahuda@sub@P}%
      \else
        \EMedef\tenNahuda@l{#1}%
      \fi
      \EMedef\tenNahuda@tmp{%
        {\@nameuse{\tenNahuda@sub@P}}[\tenNahuda@sub@opt}%
    \fi
  \else
    \edeffrontappend\tenNahuda@sub@opt{(}%
    \Strsep\tenNahuda@sub@P{[}\tenNahuda@sub@A\tenNahuda@sub@B
    \ifx\empty\tenNahuda@sub@B
    \else
      \edef\tenNahuda@sub@P{\tenNahuda@sub@A}%
      \edeffrontappend\tenNahuda@sub@opt{[\tenNahuda@sub@B}%
    \fi
    \ifx\empty #1\relax
      \EMedef\tenNahuda@l{\tenNahuda@sub@P}%
    \else
      \EMedef\tenNahuda@l{#1}%
    \fi
    \EMedef\tenNahuda@tmp{%
      {\@nameuse{\tenNahuda@sub@P}}\tenNahuda@sub@opt}%
  \fi
%\typeout{tenNahuda@tmp=\tenNahuda@tmp}%\zzzz%
  \ifnum\put@kuromaru>\z@\@nahudaKuromaru{\@nameuse{\tenNahuda@sub@P}}\fi
  \ifnum\show@label=\z@\edef\tenNahuda@l{}\fi
  \expandafter\@nahudaPut\tenNahuda@tmp{\modify@str{\tenNahuda@l}}%
  \@ifundefined{syaeiX}{}{%
    \expandafter\xdef\csname \tenNahuda@sub@P syaeiX\endcsname{\syaeiX}%
    \expandafter\xdef\csname \tenNahuda@sub@P syaeix\endcsname{\syaeix}}%
  \@ifundefined{syaeiY}{}{%
    \expandafter\xdef\csname \tenNahuda@sub@P syaeiY\endcsname{\syaeiY}%
    \expandafter\xdef\csname \tenNahuda@sub@P syaeiy\endcsname{\syaeiy}}%
}%
\def\tenNahuda{\begingroup\@ifstar{\ten@Nahuda}{%
  \edef\show@label{1}\ten@Nahuda}}%
\def\ten@Nahuda{%\begingroup
% \typeout{tenNahuda:showlabel=\show@label}\xxxx%
% \edef\put@kuromaru{0}%
  \ifnum\EMps@mode=\@ne
    \let\@nahudaPut\cPut
  \else
    \let\@nahudaPut\emathPut
  \fi
  \let\@nahudaKuromaru\Kuromaru
%  \edef\show@label{1}%
  \@ifnextchar<{\tenNahuda@}{\@tenNahuda}}%
\def\tenNahuda@<#1>{\setkeys{emP}{#1}%
  \edef\by@perl@retu{\by@perl}\edef\by@perl{\by@perl@}%
  \@tenNahuda}%
\def\@tenNahuda#1{%
  \EMedef\tenNahuda@b{#1}%
%  \trim{#1}\to\tenNahuda@b
  \Cfor{\Strsep\tenNahuda@b{;}\tenNahuda@a\tenNahuda@b}%
       {\not\equal\tenNahuda@a\empty}%
       {\Strsep\tenNahuda@b{;}\tenNahuda@a@\tenNahuda@b
        \trim\tenNahuda@a@\to\tenNahuda@a
       }%
    \do{%
      \expandafter\tenNahuda@sub\tenNahuda@a\@nil
    }%
  \endgroup
  \edef\Put@math{\save@mathmode}%
  \edef\put@kuromaru{0}%
  \edef\byouga@dousa{\save@byouga@dousa}%
  \ignorespaces
}%
%
% \oresen<#1>#2
%   <#1> : 線種を変更するときのオプション
%   #2 は折れ線の頂点列を `;' で区切った列
%     #2は
%       [##1]##2(##3,##4)##5
%     の形式で点列を `;' で区切る。
%       ##1 : オプションで，点の位置に置く文字列
%             （省略時は，##2 と同じ）
%       ##2 : \##2 という変数の頂点名
%       [r] : をつけると極座標形式とみなす
%       [s] : をつけると相対移動とみなす
%       (##3,##4) : 頂点の座標
%       ##5 : 頂点の近傍に置く文字列の配置オプション
%             [方角] オプションに限り区切子 `[', `]' を省略可能
%  \edef\##2{(##3,##4)}として，点\##2 が定義され，
%  \Put に
%       \Put\##2##5{##1}%
%  として引き渡される。）
%
%
%\def\@nulline(#1,#2)(#3,#4){\relax}%
\def\oresen{%
  \edef\by@perl{\by@perl@}%
  \def\show@label{1}%
  \def\oresen@@kyokuzahyou{0}%
  \@ifstar{\def\show@label{0}\@oresen}{\@oresen}}%
\def\roresen{%
  \def\show@label{1}%
  \def\oresen@@kyokuzahyou{1}%
  \@ifstar{\def\show@label{0}\@oresen}{\@oresen}}%
\def\@oresen{%
  \edef\by@perl@retu{0}%
  \edef\put@kuromaru{0}%
  \@ifnextchar<{\@@oresen}{\@@oresen<\empty>}}%
\def\@@oresen<#1>#2{\let\org@sensyu\sensyu
  \edef\next@opt{\empty}%
  \ifx \empty #1\else\setkeys{emP}{#1}\fi
% -----------------------------------------------------
% subroutine
\def\@oresen@sub{%
  \@ifnextchar[{\@@oresen@sub}{\@@oresen@sub[\empty]}}%
\def\@@oresen@sub[##1]##2(##3,##4){%
  \edef\oresen@kyokuzahyou{\oresen@@kyokuzahyou}%
  \edef\oresen@soutaizahyou{0}%
  \Strsep{##2}{[}\oresen@Vname\oresen@opt
  \Strchr\oresen@opt{r}\oresen@tmp
  \ifnum\oresen@tmp>\z@\edef\oresen@kyokuzahyou{1}\fi
  \Strchr\oresen@opt{s}\oresen@tmp
  \ifnum\oresen@tmp>\z@\edef\oresen@soutaizahyou{1}\fi
  \@ifnextchar({\@@oresensub@std[##1]\oresen@Vname(##3,##4)}{%
  \@ifnextchar[{\@@oresensub@std[##1]\oresen@Vname(##3,##4)}{%
    \@@oresensub@brev[##1]\oresen@Vname(##3,##4)}}}%
\def\@@oresensub@brev[##1]##2(##3,##4)##5\@nil{%
  \ifthenelse{\equal{##5}{}}{%
  \@@oresensub@std[##1]##2(##3,##4)\@nil}{%
  \@@oresensub@std[##1]##2(##3,##4)[##5]\@nil}}%
\def\@@oresensub@std[##1]##2(##3,##4)##5\@nil{%
  \ifnum\oresen@kyokuzahyou>\z@
    \@Rdef(##3,##4)\@OresenV
  \else
    \ifnum\by@perl=\z@
      \edef\@OresenV{(##3,##4)}%
    \else
      \calcval[s]{##3}\tmp@x
      \calcval[s]{##4}\tmp@y
      \edef\@OresenV{(\tmp@x,\tmp@y)}%
    \fi
  \fi
  \ifnum\oresen@soutaizahyou>\z@\Addvec\@OresenV@old\@OresenV\@OresenV\fi
  \expandafter\edef\csname ##2\endcsname{\@OresenV}%
  \edef\@oresen@subtmp{{\csname ##2\endcsname}##5}%
  \ifnum\put@kuromaru>\z@\expandafter\Kuromaru{\@OresenV}\fi
  \ifnum\show@label>\z@
    \ifx\empty##1\relax
      \expandafter\emathPut\@oresen@subtmp{##2}\relax
    \else
      \expandafter\emathPut\@oresen@subtmp{##1}\relax
    \fi
  \else
    \expandafter\emathPut\@oresen@subtmp{}\relax
  \fi
}%
% -----------------------------------------------------
\edef\oresen@siten{}%
  \edef\Oresen@oresen{}%
  \Cfor{\def\@OresenVs{#2}}{\not\equal\@OresenVs\empty}{}\do{%
    \Strsep\@OresenVs{;}\@OresenV\@OresenVs
    \trim\@OresenVs\to\@OresenVs
%    \ifnum\by@perl@retu=\z@
%    \else
      \expandafter\@tenretu@seppara\@OresenV\@nil
      \edef\@OresenV{%
        \the\namae@opt\the\tenretu@namae(\tenretu@x,\tenretu@y)\tenretu@n}%
%    \fi
    \expandafter\@oresen@sub\@OresenV\@nil
    \ifthenelse{\equal\oresen@siten\empty}{%
      \edef\oresen@siten{\@OresenV}%
    }{%
%      \edef\Oresen@tmp{\@OresenV@old\@OresenV}%
%      \expandafter\sensyu\Oresen@tmp
    }%
    \edefappend\Oresen@oresen{\@OresenV}%
%    \edef\old@x{\tenretu@x}%
%    \edef\old@y{\tenretu@y}%
    \edef\@OresenV@old{\@OresenV}%
  }%
  \ifx\empty\next@opt
    \expandafter\sensyu\Oresen@oresen
  \else
    \bgroup
    \ifnum\EMps@mode=\@ne\gsave\fi
        \EMedef\oresen@opt{{emP}{\next@opt}}%
        \expandafter\setkeys\oresen@opt
        \ifthenelse{\equal\iro@\empty}{%
          \expandafter\sensyu\Oresen@oresen
        }{%
          \put(0,0){\EMpsIrositei{\iro@}\expandafter\sensyu\Oresen@oresen}%%
        }%
    \ifnum\EMps@mode=\@ne\grestore\fi
    \egroup
  \fi
  \edef\by@perl{\by@perl@}%
  \let\sensyu\org@sensyu
  \ignorespaces
}%
%
%\def\oresen{%
%  \edef\oresen@by@perl{0}%
%  \edef\by@perl{\by@perl@}%
%  \def\show@label{1}%
%  \def\oresen@@kyokuzahyou{0}%
%  \@ifstar{\def\show@label{0}\@oresen}{\@oresen}}%
%\def\perloresen{%
%  \edef\oresen@by@perl{1}%
%  \edef\by@perl{\by@perl@}%
%  \def\show@label{1}%
%  \def\oresen@@kyokuzahyou{0}%
%  \@ifstar{\def\show@label{0}\@oresen}{\@oresen}}%
%\def\roresen{%
%  \def\show@label{1}%
%  \def\oresen@@kyokuzahyou{1}%
%  \@ifstar{\def\show@label{0}\@oresen}{\@oresen}}%
%\def\@oresen{%
%  \edef\by@perl@retu{0}%
%  \edef\put@kuromaru{0}%
%%  \edef\next@opt{\empty}%
%  \@ifnextchar<{\@@oresen}{\@@oresen<\empty>}}%
%\def\@@oresen<#1>#2{%\let\org@sensyu\sensyu
%  \Strchr{#1}{p}\@c
%  \ifnum\@c>\z@\errmessage{oresen: key `perl' not available}\fi
%%  \ifx \empty #1\else\setkeys{emP}{#1}\fi
%% -----------------------------------------------------
%% subroutine
%\def\@oresen@sub{%
%  \@ifnextchar[{\@@oresen@sub}{\@@oresen@sub[\empty]}}%
%\def\@@oresen@sub[##1]##2(##3,##4){%
%  \edef\oresen@kyokuzahyou{\oresen@@kyokuzahyou}%
%  \edef\oresen@soutaizahyou{0}%
%  \Strsep{##2}{[}\oresen@Vname\oresen@opt
%  \Strchr\oresen@opt{r}\oresen@tmp
%  \ifnum\oresen@tmp>\z@\edef\oresen@kyokuzahyou{1}\fi
%  \Strchr\oresen@opt{s}\oresen@tmp
%  \ifnum\oresen@tmp>\z@\edef\oresen@soutaizahyou{1}\fi
%  \@ifnextchar({\@@oresensub@std[##1]\oresen@Vname(##3,##4)}{%
%  \@ifnextchar[{\@@oresensub@std[##1]\oresen@Vname(##3,##4)}{%
%    \@@oresensub@brev[##1]\oresen@Vname(##3,##4)}}}%
%\def\@@oresensub@brev[##1]##2(##3,##4)##5\@nil{%
%  \ifthenelse{\equal{##5}{}}{%
%  \@@oresensub@std[##1]##2(##3,##4)\@nil}{%
%  \@@oresensub@std[##1]##2(##3,##4)[##5]\@nil}}%
%\def\@@oresensub@std[##1]##2(##3,##4)##5\@nil{%
%  \ifnum\oresen@kyokuzahyou>\z@
%    \@Rdef(##3,##4)\@OresenV
%  \else
%    \ifnum\oresen@by@perl=\z@
%      \edef\@OresenV{(##3,##4)}%
%    \else
%      \calcval[s]{##3}\tmp@x
%      \calcval[s]{##4}\tmp@y
%      \edef\@OresenV{(\tmp@x,\tmp@y)}%
%    \fi
%  \fi
%  \ifnum\oresen@soutaizahyou>\z@\Addvec\@OresenV@old\@OresenV\@OresenV\fi
%  \expandafter\edef\csname ##2\endcsname{\@OresenV}%
%  \edef\@oresen@subtmp{{\csname ##2\endcsname}##5}%
%  \ifnum\put@kuromaru>\z@\expandafter\Kuromaru{\@OresenV}\fi
%  \ifnum\show@label>\z@
%    \ifx\empty##1\relax
%      \expandafter\emathPut\@oresen@subtmp{##2}\relax
%    \else
%      \expandafter\emathPut\@oresen@subtmp{##1}\relax
%    \fi
%  \else
%    \expandafter\emathPut\@oresen@subtmp{}\relax
%  \fi
%}%
%% -----------------------------------------------------
%\edef\oresen@siten{}%
%  \edef\Oresen@oresen{}%
%  \Cfor{\def\@OresenVs{#2}}{\not\equal\@OresenVs\empty}{}\do{%
%    \Strsep\@OresenVs{;}\@OresenV\@OresenVs
%    \trim\@OresenVs\to\@OresenVs
%    \ifnum\by@perl@retu=\z@
%    \else
%      \expandafter\@tenretu@seppara\@OresenV\@nil
%      \edef\@OresenV{%
%        \the\namae@opt\the\tenretu@namae(\tenretu@x,\tenretu@y)\tenretu@n}%
%    \fi
%    \expandafter\@oresen@sub\@OresenV\@nil
%    \ifthenelse{\equal\oresen@siten\empty}{%
%      \edef\oresen@siten{\@OresenV}%
%    }{%
%%      \edef\Oresen@tmp{\@OresenV@old\@OresenV}%
%%      \bgroup
%%        \ifnum\EMps@mode=\@ne\gsave\fi
%%        \ifx \empty #1\else\setkeys{emP}{#1}\fi
%%        \ifthenelse{\equal\iro@\empty}{%
%%              \expandafter\sensyu\Oresen@tmp
%%        }{%
%%              \put(0,0){\EMpsIrositei{\iro@}\expandafter\sensyu\Oresen@tmp}%
%%        }%
%%        \ifnum\EMps@mode=\@ne\grestore\fi
%%      \egroup
%    }%
%    \edefappend\Oresen@oresen{\@OresenV}%
%    \edef\@OresenV@old{\@OresenV}}%
%%\typeout{Oresen@oresen=\Oresen@oresen}\ooooo
%    \edef\by@perl{\by@perl@}%
%    \bgroup
%    \ifnum\EMps@mode=\@ne\gsave\fi
%        \ifx \empty #1\else\setkeys{emP}{#1}\fi
%        \ifthenelse{\equal\iro@\empty}{%
%              \expandafter\sensyu\Oresen@oresen
%        }{%
%              \put(0,0){\EMpsIrositei{\iro@}\expandafter\sensyu\Oresen@oresen}%%
%        }%
%    \ifnum\EMps@mode=\@ne\grestore\fi
%    \egroup
%%    \let\sensyu\org@sensyu
%    \ignorespaces}%
%%\edef\oresen@siten{}%
%
%
%\Cfor{\edef\@OresenVs{#2}}{\not\equal\@OresenVs\empty}{}\do{%
%  \strsep\@OresenVs{;}\@OresenV\@OresenVs
%  \expandafter\@oresen@sub\@OresenV\@nil
%  \ifthenelse{\equal\oresen@siten\empty}{%
%    \edef\oresen@siten{\@OresenV}}{%
%   \edef\Oresen@tmp{\@OresenV@old\@OresenV}%
%   \expandafter\sensyu\Oresen@tmp}%
%  \edef\@OresenV@old{\@OresenV}}\let\sensyu\org@sensyu}%
%
% \takakkei<#1>#2
%   <#1> : 線種を変更するときのオプション
%   #2 は多角形の頂点列を `;' で区切った列
%     #1は
%       [##1]##2(##3,##4)##5
%     の形式で点列を `;' で区切る。
%       ##1 : オプションで，点の位置に置く文字列
%             （省略時は，##2 と同じ）
%       ##2 : \##2 という変数の頂点名
%       [r] : をつけると極座標形式とみなす
%       (##3,##4) : 頂点の座標
%       ##5 : 頂点の近傍に置く文字列の配置オプション
%             [方角] オプションに限り区切子 `[', `]' を省略可能
%  \edef\##2{(##3,##4)}として，点\##2 が定義され，
%  \Put に
%       \Put\##2##5{##1}%
%  として引き渡される。）
%
\def\takakkei{\@ifnextchar<{\@takakkei}{\@takakkei<\empty>}}%
\def\@takakkei<#1>#2{\let\org@sensyu\sensyu
  \ifx \empty #1\else\setkeys{emP}{#1}\fi
\def\@takakkei@sub{\@ifnextchar[{\@@takakkei@sub}{\@@takakkei@sub[\empty]}}%
\def\@@takakkei@sub[##1]##2(##3,##4){%
  \edef\takakkei@kyokuzahyou{0}%
  \edef\takakkei@soutaizahyou{0}%
  \strsep{##2}{[}\takakkei@Vname\takakkei@opt
  \Strchr\takakkei@opt{r}\takakkei@tmp
  \ifnum\takakkei@tmp>\z@\edef\takakkei@kyokuzahyou{1}\fi
  \@ifnextchar({\@@takakkeisub@std[##1]\takakkei@Vname(##3,##4)}{%
  \@ifnextchar[{\@@takakkeisub@std[##1]\takakkei@Vname(##3,##4)}{%
    \@@takakkeisub@brev[##1]\takakkei@Vname(##3,##4)}}}%
\def\@@takakkeisub@brev[##1]##2(##3,##4)##5\@nil{%
  \ifthenelse{\equal{##5}{}}{%
  \@@takakkeisub@std[##1]##2(##3,##4)\@nil}{%
  \@@takakkeisub@std[##1]##2(##3,##4)[##5]\@nil}}%
\def\@@takakkeisub@std[##1]##2(##3,##4)##5\@nil{%
  \ifnum\takakkei@kyokuzahyou>\z@\@Rdef(##3,##4)\@TakakuV\else
  \edef\@TakakuV{(##3,##4)}\fi
  \expandafter\edef\csname ##2\endcsname{\@TakakuV}%
  \edef\@takakkei@subtmp{{\csname ##2\endcsname}##5}%
  \ifx\empty##1\edef\takakkei@Vname@{##2}\else\edef\takakkei@Vname@{##1}\fi
  \expandafter\emathPut\@takakkei@subtmp\takakkei@Vname@}%
\edef\takakkei@siten{}%
\Cfor{\edef\@TakakuVs{#2}}{\not\equal\@TakakuVs\empty}{}\do{%
  \strsep\@TakakuVs{;}\@TakakuV\@TakakuVs
  \expandafter\@takakkei@sub\@TakakuV\@nil
  \ifthenelse{\equal\takakkei@siten\empty}{%
    \edef\takakkei@siten{\@TakakuV}}{%
    \Sensyu{\@TakakuV@old\@TakakuV}}%
  \edef\@TakakuV@old{\@TakakuV}}%
\Sensyu{\@TakakuV@old\takakkei@siten}\let\sensyu\org@sensyu}%
%
%
% 重心
\def\Zyuusin#1#2#3#4{\Addvec{#1}{#2}\Zyuusin@v\Addvec{#3}\Zyuusin@v\Zyuusin@v
  \Mulvec{0.333333}\Zyuusin@v{#4}}%
%
% 内心 と 内接円
\def\Naisin{\@ifnextchar<{\@Naisin}{\@Naisin<\empty>}}%
\def\@Naisin<#1>#2#3#4#5{%
%
    \define@key{emP}{hankei}{\strip@cmd{##1}\h@nkei}%
%
  \edef\h@nkei{\empty}%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
  \sankakkei{#2}{#3}{#4}% 三角形#1#2#3の内心を#4にセット
  \@Div\menseki\ls\lr\edef\NaisetuenHankei{\lr}%
  \ifx\empty\h@nkei\else\expandafter\edef\csname\h@nkei\endcsname{\lr}\fi
  \ItiziKetugou{\la}{#2}{\lb}{#3}\@uu%
  \ItiziKetugou{1}{\@uu}{\lc}{#4}\@uu\Mul\ls{2}\@n\@Div{1}\@n\@n
%  \Mulvec\@n\@uu\@uu\edef#5{\@uu}%
  \Mulvec\@n\@uu{#5}%
}%
\def\Naisetuen{\@ifnextchar<{\@Naisetuen}{\@Naisetuen<\empty>}}%
\def\@Naisetuen<#1>#2#3#4{\Naisin{#2}{#3}{#4}\vNaisin% 内接円描画，半径は \lr
  \En<#1>\vNaisin\lr}%
%  \Mul\lr{2}\@R\emathPut\vNaisin{\circle{\@R}}}% 内心は \vNaisin
%
%
% 三角形の二等分線と対辺の交点を求める。
% \Nitoubunsen[#1]#2#3#4#5
%   角#2#3#4（#3が角の頂点）を2等分する直線が辺#2#4と交わる点を#5に与える。
%   #1を与えたときは，外角の2等分線を#1に与える。
\def\Nitoubunsen{\@ifnextchar[{\@Nitoubunsen}{\@Nitoubunsen[\empty]}}%
\def\@Nitoubunsen[#1]#2#3#4#5{%
  \Kyori{#2}{#3}\a@Nitoubunsen
  \Kyori{#4}{#3}\b@Nitoubunsen
  \@Bunten{#2}{#4}\a@Nitoubunsen\b@Nitoubunsen{#5}\relax
  \ifx\empty#1\relax\else
    \@Bunten{#2}{#4}\a@Nitoubunsen{-\b@Nitoubunsen}{#1}\relax
  \fi
}%
%
% 傍心と傍接円
\def\Bousin#1#2#3#4{\sankakkei{#1}{#2}{#3}% 三角形#1#2#3の傍心を#4にセット
  \ItiziKetugou{-\la}{#1}{\lb}{#2}\@uu%
  \ItiziKetugou{1}{\@uu}{\lc}{#3}\@uu
  \Add\lb\lc\@n\Sub\@n\la\@n\@Div{1}\@n\@n
  \Mulvec\@n\@uu\@uu
  \tentoTyokusen\@uu{#2}{#3}\BousetuenHankei
  \edef\lr{\BousetuenHankei}%
  \edef#4{\@uu}}%
\def\Bousetuen#1#2#3{\Bousin{#1}{#2}{#3}\vBousin% 傍接円描画
%  \Suisen\vBousin{#2}{#3}\@T
%  \Kyori\vBousin\@T\BousetuenHankei
  \En\vBousin\lr}%
%
% 外心
% \Gaisin#1#2#3[#4]#5 三角形#1#2#3 の外心を #5 にセットする．半径は #4 に(\lR)
%
%\def\Gaisin#1#2#3{\@ifnextchar[{\@Gaisin{#1}{#2}{#3}}{%
%  \@Gaisin{#1}{#2}{#3}[\empty]}}%
%\def\@Gaisin#1#2#3[#4]#5{%
%  \@Bunten{#1}{#2}11\G@M\Subvec{#2}{#1}\G@u\Housenvec\G@u\G@u
%  \@Bunten{#3}{#2}11\G@N\Subvec{#2}{#3}\G@v\Housenvec\G@v\G@v
%  \landl\G@M\G@u\G@N\G@v\vGaisin
%  \Kyori\vGaisin{#1}\lR
%  \edef\GaisetuenHankei{\lR}%
%  \edef#5{\vGaisin}%
%  \ifx\empty #4\else\edef#4{\lR}\fi}%
%
\edef\set@xyrange{\empty}%
%\define@key{emP}{xyrange}[\pszahyou@N]{\edef\set@xyrange{#1}}%
\define@key{emP}{xyrange}[1]{\edef\set@xyrange{#1}}%
\define@key{emP}{setxyrange}[\pszahyou@N]{\edef\set@xyrange{#1}}%
%\define@key{emP}{setxyrange}[1]{\edef\set@xyrange{#1}}%
\def\Gaisin{\@ifnextchar<{\@Gaisin}{\@Gaisin<\empty>}}%
\def\@Gaisin<#1>#2#3#4{\@ifnextchar[{\@@Gaisin<#1>{#2}{#3}{#4}}{%
  \@@Gaisin<#1>{#2}{#3}{#4}[\empty]}}%
\def\@@Gaisin<#1>#2#3#4[#5]#6{%
%
    \define@key{emP}{hankei}{\strip@cmd{##1}\h@nkei}%
%
  \edef\h@nkei{\empty}%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
  \@Bunten{#2}{#3}11\G@M\Subvec{#3}{#2}\G@u\Housenvec\G@u\G@u
  \@Bunten{#4}{#3}11\G@N\Subvec{#3}{#4}\G@v\Housenvec\G@v\G@v
  \landl\G@M\G@u\G@N\G@v\vGaisin
  \Kyori\vGaisin{#2}\lR
  \edef\GaisetuenHankei{\lR}%
%  \edef#6{\vGaisin}%
  \Put@nil\vGaisin #6\@nil
  \ifx\empty #5\else\edef#5{\lR}\fi
  \ifx\empty\h@nkei\else\expandafter\edef\csname\h@nkei\endcsname{\lR}\fi
  \ifx\empty\set@xyrange\else
    \vecXY\vGaisin\G@x\G@y
    \Add\G@x\lR\x@R
    \Sub\G@x\lR\x@L
    \Add\G@y\lR\y@T
    \Sub\G@y\lR\y@B
    \EMwriteLabel{\set@xyrange-xL}{\x@L}%
    \EMwriteLabel{\set@xyrange-xR}{\x@R}%
    \EMwriteLabel{\set@xyrange-yT}{\y@T}%
    \EMwriteLabel{\set@xyrange-yB}{\y@B}%
    \edef\set@xyrange{\empty}%
  \fi
}%
%
  \edef\h@sep{\empty}\edef\v@sep{\empty}%
  \edef\t@sep{\empty}\edef\b@sep{\empty}%
  \edef\l@sep{\empty}\edef\r@sep{\empty}%
%\define@key{emP}{getxyrange}[1]{\getxyrange[#1]}%
\define@key{emP}{getxyrange}[\pszahyou@N]{\getxyrange[#1]}%
\define@key{emP}{addxrange}{\@addxrange{#1}}%
\define@key{emP}{addyrange}{\@addyrange{#1}}%
\define@key{emP}{revision}{\def\h@sep{#1}\def\v@sep{#1}}%
\define@key{emP}{hsep}{\def\h@sep{#1}}%
\define@key{emP}{lsep}{\def\l@sep{#1}}%
\define@key{emP}{rsep}{\def\r@sep{#1}}%
\define@key{emP}{tsep}{\setlength{\@tempdima}{#1}\edef\t@sep{\the\@tempdima}}%
\define@key{emP}{bsep}{\def\b@sep{#1}}%
\define@key{emP}{vsep}{\def\v@sep{#1}}%
\define@key{emP}{hvsep}{\def\h@sep{#1}\def\v@sep{#1}}%
\def\getxyrange{\@ifnextchar<{\@getxyrange}{\@getxyrange<\empty>}}%
\def\@getxyrange<#1>{%
  \@ifnextchar[{\@@getxyrange<#1>}{\@@getxyrange<#1>[\pszahyou@N]}}%
%  \@ifnextchar[{\@@getxyrange<#1>}{\@@getxyrange<#1>[1]}}%
\def\@@getxyrange<#1>[#2]{%
  \edef\label@name{#2}%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
  \dimenref**[0]{\label@name-xL}{\xmin}%
  \dimenref**[1]{\label@name-xR}{\xmax}%
  \dimenref**[0]{\label@name-yB}{\ymin}%
  \dimenref**[1]{\label@name-yT}{\ymax}%
%\typeout{jobname=\jobname,lbl=\label@name,(\xmin,\xmax)(\ymin,\ymax)}%
}%
\def\@addxrange#1{%
  \vecXY{#1}\tmp@x\tmp@y
  \ukansan\tmp@x\tmp@xx
  \ukansan\tmp@y\tmp@yy
  \Addself\xmin\tmp@xx
  \Addself\xmax\tmp@yy
}%
\def\@addyrange#1{%
  \vecXY{#1}\tmp@x\tmp@y
  \ukansan\tmp@x\tmp@xx
  \ukansan\tmp@y\tmp@yy
  \Addself\ymin\tmp@xx
  \Addself\ymax\tmp@yy
}%
%
%\def\Gaisin#1#2#3#4{\sankakkei{#1}{#2}{#3}\Mul\la\lb\lR\Mul\lR\lc\lR%
%  \@Div\lR\menseki\lR\@Div\lR{4}\lR%
%  \Yogen{\lc}{\la}{\lb}\cosC%
%  \Mul\lR\cosC\B@M\Subvec{#2}{#1}\@AB\Nvec\@AB\@v\Mulvec\B@M\@v\@v%
%  \@Bunten{#1}{#2}{1}{1}\B@M\Addvec\B@M\@v\@v\edef#4{\@v}}%
% 外接円の描画    外心は \vGaisin にセット，半径は \lR
\def\Gaisetuen{\@ifnextchar<{\@Gaisetuen}{\@Gaisetuen<\empty>}}%
\def\@Gaisetuen<#1>#2#3#4{\Gaisin{#2}{#3}{#4}\vGaisin%
  \En<#1>\vGaisin\lR}%
% \Mul\lR{2}\@tyokkei\emathPut\vGaisin{\circle{\@tyokkei}}}%
%
% 垂心
%
\def\Suisin#1#2#3#4{%
  \Suisen{#1}{#2}{#3}\Suisini
  \Suisen{#2}{#3}{#1}\Suisinii
  \Suisen{#3}{#1}{#2}\Suisiniii
%  \LandL{#1}\Suisini{#2}\Suisinii#4}%
  \LandL{#1}\Suisini{#2}\Suisinii\Suisin@P
  \Put@nil\Suisin@P #4\@nil
}%
%
% 2点を与えて直線を描画する．
% \Tyokusen<#1>[#2]#3#4[#5]#6[#7]#8
%   <#1> : 線種を変更するオプション
%   #2 : \qbezier の [...]
%       #2=l のときは直線を \qbezier ではなく，\drawline で描画する．
%   #3,4 : 直線上の２点
%   #6 : 左端の x座標 （#5 に [y] とすれば，y座標）
%   #8 : 右端の x座標 （#7 に [y] とすれば，y座標）
%   (#6, #8 を {} としたときは描画領域全体）
%
%
\def\show@migiM{%
  \@ifnextchar({\show@migiM@}{\@show@migiM}}%
\def\show@migiM@(#1){\@ifnextchar[{\show@migiM@@(#1)}{%
  \show@migiM@@(#1)[l]}}%
\def\show@migiM@@(#1)[#2]#3\@nil{%
  \edef\Put@math{1}%
  \EMedef\show@m@tmp{{\migiT}(#1)[#2]{#3}}%
  \expandafter\emathPut\show@m@tmp}%
\def\@show@migiM{\@ifnextchar[{\@@show@migiM}{\@@show@migiM[e]}}%
\def\@@show@migiM[#1]#2\@nil{%
  \edef\Put@math{1}%
  \EMedef\show@m@tmp{{\migiT}[#1]{#2}}%
  \expandafter\emathPut\show@m@tmp}%
%
\def\show@hidariM{\@ifnextchar({\show@hidariM@}{\@show@hidariM}}%
\def\show@hidariM@(#1){\@ifnextchar[{\show@hidariM@@(#1)}{%
  \show@hidariM@@(#1)[r]}}%
\def\show@hidariM@@(#1)[#2]#3\@nil{%
  \edef\Put@math{1}%
  \EMedef\show@h@tmp{{\hidariT}(#1)[#2]{#3}}%
  \expandafter\emathPut\show@h@tmp}%
\def\@show@hidariM{\@ifnextchar[{\@@show@hidariM}{\@@show@hidariM[w]}}%
\def\@@show@hidariM[#1]#2\@nil{%
  \edef\Put@math{1}%
  \EMedef\show@h@tmp{{\hidariT}[#1]{#2}}%
  \expandafter\emathPut\show@h@tmp}%
%
\def\Lline{\@ifnextchar<{\@Lline}{\@Lline<\empty>}}%
\def\@Lline<#1>#2#3{%
  \Subvec{#3}{#2}\kl@v
  \@lline<#1>{#2}\kl@v
}%
%
\def\Llines{\@ifnextchar<{\@Llines}{\@Llines<\empty>}}%
\def\@Llines<#1>#2{{%
  \ifnum\EMps@mode=\@ne\gsave\fi
  \ifx\empty #1\else
    \@ifundefined{ps@debug@}{\setkeys{emP}{#1}}{\setkeys{emPs}{#1}}%
  \fi
      \def\@@Llines(##1)(##2){%
%       \Lline<#1>{(##1)}{(##2)}}%
        \Lline{(##1)}{(##2)}}%
  \Cfor{\edef\Llines@a{#2}}{\not\equal\Llines@a\empty}{%
    \edef\Llines@a{\Llines@b}}\do{%
      \strsep\Llines@a{;}\Llines@a\Llines@b
      \expandafter\@@Llines\Llines@a}%
  \ifnum\EMps@mode=\@ne\grestore\fi
}}%
%
\def\kline{\@ifstar{\edef\Rdef@rad{1}\@kline}{\edef\Rdef@rad{0}\@kline}}%
\def\@kline{\@ifnextchar<{\@@kline}{\@@kline<\empty>}}%
\def\@@kline<#1>#2#3{%
%  \edef\kl@a{#3}%
  \isnumber{#3}{\edef\kl@a{#3}}{\fpcalcval{#3}\kl@a}%
  \ifnum\Rdef@rad>\z@
    \RadDeg{\kl@a}\kl@a
  \fi
  \ifdim\kl@a\p@=90\p@
    \edef\kl@c{0}%
    \edef\kl@s{1}%
  \else
    \@ifundefined{@xscale}{}{%
      \DegTan{\kl@a}\kl@tmp
      \Mulself\kl@tmp\@xscale
      \Divself\kl@tmp\@yscale
      \atan\kl@tmp\kl@a
    }%
    \DegCos{\kl@a}\kl@c
    \DegSin{\kl@a}\kl@s
  \fi
  \@lline<#1>{#2}{(\kl@c,\kl@s)}%
}%
\def\perlkline{%
  \@ifstar{\edef\Rdef@rad{1}\@perlkline}{\edef\Rdef@rad{0}\@perlkline}}%
\def\@perlkline{\@ifnextchar<{\@@perlkline}{\@@perlkline<\empty>}}%
\def\@@perlkline<#1>#2#3{%
  \ifnum\Rdef@rad>\z@
    \calcval[s]{RadDeg(#3)}\kl@a
  \else
    \calcval[s]{#3}\kl@a
  \fi
  \ifdim\kl@a\p@=90\p@\else
  \@ifundefined{@xscale}{}{%
    \ifdim\@xscale\p@=\p@
      \ifdim\@yscale\p@=\p@
      \else
        \calcval[s]{RadDeg(atan2(\@xscale*Degtan(\kl@a),\@yscale))}\kl@a
      \fi
    \else
      \calcval[s]{RadDeg(atan2(\@xscale*Degtan(\kl@a),\@yscale))}\kl@a
%    \DegTan{\kl@a}\kl@tmp
%    \Mulself\kl@tmp\@xscale
%    \Divself\kl@tmp\@yscale
%    \atan\kl@tmp\kl@a
    \fi
  }%
  \fi
  \calcvals{Degcos(\kl@a),Degsin(\kl@a)}{pkl@ary}%
  \edef\kl@c{\hairetu{pkl@ary}{1}}%
  \edef\kl@s{\hairetu{pkl@ary}{2}}%
%  \calcval[s]{Degcos(\kl@a)}\kl@c
%  \calcval[s]{Degsin(\kl@a)}\kl@s
%  \DegCos{\kl@a}\kl@c
%  \DegSin{\kl@a}\kl@s
  \@lline<#1>{#2}{(\kl@c,\kl@s)}%
}%
\def\lline{\@ifnextchar<{\@lline}{\@lline<\empty>}}%
\def\@lline<#1>#2#3{%
  \vecXY{#3}\kl@a\kl@b
  \Abs\kl@a\kl@a@
  \ifdim\kl@a@\p@<0.0001\p@
    \Abs\kl@b\kl@b@
    \ifdim\kl@b@\p@<0.0001\p@\errmessage{lline:illegal arg:#2#3}\fi
    \bgroup
    \ifnum\EMps@mode=\@ne\gsave\fi
    \vecXY{#2}\kl@x\kl@y
    \edef\gl@L{(\kl@x,\true@ymin)}%
    \edef\gl@R{(\kl@x,\true@ymax)}%
    \edef\by@perl{0}%
    \edef\next@opt{\empty}%
    \edef\YG@xl{\true@ymin}%
    \edef\YG@xr{\true@ymax}%
    \edef\YG@migiT{\empty}%
    \edef\YG@migiM{\empty}%
    \edef\YG@hidariT{\empty}%
    \edef\YG@hidariM{\empty}%
    \edef\YG@func{\empty}%
    \edef\YG@func@{\empty}%
    \ifx\empty #1\else\setkeys{emGurafu}{#1}\fi
%    \edef\hidariT{(\kl@x,\YG@xl)}%
%    \edef\migiT{(\kl@x,\YG@xr)}%
    \EMedef\gline@tmp{<\next@opt>}%
%\ifx\empty\cPut@orgP\else
%    \Absvec{\cPut@orgP}\l@
%    \Hamidasiten*\gl@L\gl@R{\l@\unitlength}{\l@\unitlength}\gl@L\gl@R
%\fi
    \expandafter\Drawline\gline@tmp{\gl@L\gl@R}%
\ifx\empty\YG@migiM\else
  \edef\migiT{\gl@R}%
  \expandafter\show@migiM\YG@migiM\@nil
\fi
\ifx\empty\YG@hidariM\else
  \edef\hidariT{\gl@L}%
  \expandafter\show@hidariM\YG@hidariM\@nil
\fi
    \ifnum\EMps@mode=\@ne\grestore\fi
    \edef\temp@x{%
      \def\noexpand\hidariT{\gl@L}%
      \def\noexpand\migiT{\gl@R}%
      \def\noexpand\YG@func{\YG@func}%
      \def\noexpand\YG@func@{\YG@func@}%
      \def\noexpand\YG@hidariT{\YG@hidariT}%
      \def\noexpand\YG@migiT{\YG@migiT}%
    }%
    \expandafter\egroup\temp@x
    \ifx\empty\YG@migiT\else
      \expandafter\edef\csname\YG@migiT\endcsname{\migiT}\fi
    \ifx\empty\YG@hidariT\else
      \expandafter\edef\csname\YG@hidariT\endcsname{\hidariT}\fi
    \ifx\empty\YG@func\else
      \expandafter\edef\csname\YG@func\endcsname{\YG@func@}\fi
    \let\rightP\migiT
    \let\leftP\hidariT
  \else
    \@Div\kl@b\kl@a\kl@m
    \gline<#1>{#2}{\kl@m}%
  \fi
}%
%
\def\llines{\@ifnextchar<{\@llines}{\@llines<\empty>}}%
\def\@llines<#1>#2{{%
  \ifnum\EMps@mode=\@ne\gsave\fi
  \ifx\empty #1\else
    \@ifundefined{ps@debug@}{\setkeys{emP}{#1}}{\setkeys{emPs}{#1}}%
  \fi
      \def\@@llines(##1)(##2){%
        \lline{(##1)}{(##2)}}%
  \Cfor{\edef\llines@a{#2}}{\not\equal\llines@a\empty}{%
    \edef\llines@a{\llines@b}}\do{%
    \strsep\llines@a{;}\llines@a\llines@b
    \expandafter\@@llines\llines@a}%
  \ifnum\EMps@mode=\@ne\grestore\fi
}}%
%
\def\klines{\@ifnextchar<{\@klines}{\@klines<\empty>}}%
\def\@klines<#1>#2{{%
  \ifnum\EMps@mode=\@ne\gsave\fi
  \ifx\empty #1\else
    \@ifundefined{ps@debug@}{\setkeys{emP}{#1}}{\setkeys{emPs}{#1}}%
  \fi
      \def\@@klines(##1)##2\@nil{%
        \kline{(##1)}{##2}}%
  \Cfor{\edef\klines@a{#2}}{\not\equal\klines@a\empty}{%
    \edef\klines@a{\klines@b}}\do{%
    \strsep\klines@a{;}\klines@a\klines@b
    \expandafter\@@klines\klines@a\@nil}%
  \ifnum\EMps@mode=\@ne\grestore\fi
}}%
%
\def\nline{\@ifnextchar<{\@nline}{\@nline<\empty>}}%
\def\@nline<#1>#2#3{%
  \Housenvec{#3}\kl@v
  \@lline<#1>{#2}\kl@v
}%
\let\nlline\nline
\def\gline{\@ifnextchar<{\@gline}{\@gline<\empty>}}%
\def\@gline<#1>#2#3{\begingroup
  \ifnum\EMps@mode=\@ne\gsave\fi
  \edef\by@perl{0}%
  \edef\next@opt{\empty}%
  \edef\YG@migiT{\empty}%
  \edef\YG@xl{\true@xmin}%
  \edef\YG@xr{\true@xmax}%
  \edef\YG@migiT{\empty}%
  \edef\YG@migiM{\empty}%
  \edef\YG@hidariT{\empty}%
  \edef\YG@hidariM{\empty}%
  \edef\YG@func{\empty}%
  \edef\YG@func@{\empty}%
  \ifx\empty#1\else\setkeys{emGurafu}{#1}\fi
  \vecXY{#2}\gl@x\gl@y
  \ifnum\by@perl>\z@
    \calcval[s]{(\YG@xr-(\gl@x))*(#3)+(\gl@y)}\gl@tmp
  \else
    \Sub\YG@xr\gl@x\gl@tmp
    \Mulself\gl@tmp{#3}%
    \Addself\gl@tmp\gl@y
  \fi
  \ifdim\gl@tmp\p@>\true@ymax\p@
    \ifnum\by@perl>\z@
      \calcval[s]{(\true@ymax-(\gl@y))/(#3)+(\gl@x)}\gl@tmp
    \else
      \Sub\true@ymax\gl@y\gl@tmp
      \Divself\gl@tmp{#3}%
      \Addself\gl@tmp\gl@x
    \fi
    \edef\gl@R{(\gl@tmp,\true@ymax)}%
  \else\ifdim\gl@tmp\p@<\true@ymin\p@
    \ifnum\by@perl>\z@
      \calcval[s]{(\true@ymin-(\gl@y))/(#3)+(\gl@x)}\gl@tmp
    \else
      \Sub\true@ymin\gl@y\gl@tmp
      \Divself\gl@tmp{#3}%
      \Addself\gl@tmp\gl@x
    \fi
    \edef\gl@R{(\gl@tmp,\true@ymin)}%
  \else
    \edef\gl@R{(\YG@xr,\gl@tmp)}%
  \fi\fi
  \ifnum\by@perl>\z@
    \calcval[s]{(\YG@xl-(\gl@x))*(#3)+(\gl@y)}\gl@tmp
  \else
    \Sub\YG@xl\gl@x\gl@tmp
    \Mulself\gl@tmp{#3}%
    \Addself\gl@tmp\gl@y
  \fi
  \ifdim\gl@tmp\p@>\true@ymax\p@
    \ifnum\by@perl>\z@
      \calcval[s]{(\true@ymax-(\gl@y))/(#3)+\gl@x}\gl@tmp
    \else
      \Sub\true@ymax\gl@y\gl@tmp
      \Divself\gl@tmp{#3}%
      \Addself\gl@tmp\gl@x
    \fi
    \edef\gl@L{(\gl@tmp,\true@ymax)}%
  \else\ifdim\gl@tmp\p@<\true@ymin\p@
    \ifnum\by@perl>\z@
      \calcval[s]{(\true@ymin-(\gl@y))/(#3)+\gl@x}\gl@tmp
    \else
      \Sub\true@ymin\gl@y\gl@tmp
      \Divself\gl@tmp{#3}%
      \Addself\gl@tmp\gl@x
    \fi
    \edef\gl@L{(\gl@tmp,\true@ymin)}%
  \else
    \edef\gl@L{(\YG@xl,\gl@tmp)}%
  \fi\fi
%  \ifx\empty\cPut@orgP\else
%    \Absvec{\cPut@orgP}\l@
%    \Hamidasiten*\gl@L\gl@R{\l@\unitlength}{\l@\unitlength}\gl@L\gl@R
%  \fi
  \EMedef\gline@tmp{<\next@opt>}%
  \expandafter\Drawline\gline@tmp{\gl@L\gl@R}%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \ifx\empty\YG@func\else
    \gLfunc{#2}{#3}\YG@func@
  \fi
\ifx\empty\YG@migiM\else
  \edef\migiT{\gl@R}%
  \expandafter\show@migiM\YG@migiM\@nil
\fi
\ifx\empty\YG@hidariM\else
  \edef\hidariT{\gl@L}%
  \expandafter\show@hidariM\YG@hidariM\@nil
\fi
  \ifnum\EMps@mode=\@ne\grestore\fi
  \edef\temp@x{%
    \def\noexpand\hidariT{\gl@L}%
    \def\noexpand\migiT{\gl@R}%
    \def\noexpand\YG@func{\YG@func}%
    \def\noexpand\YG@func@{\YG@func@}%
    \def\noexpand\YG@hidariT{\YG@hidariT}%
    \def\noexpand\YG@migiT{\YG@migiT}%
  }%
  \expandafter\endgroup\temp@x
  \ifx\empty\YG@migiT\else
    \expandafter\edef\csname\YG@migiT\endcsname{\migiT}\fi
  \ifx\empty\YG@hidariT\else
    \expandafter\edef\csname\YG@hidariT\endcsname{\hidariT}\fi
  \ifx\empty\YG@func\else
    \expandafter\edef\csname\YG@func\endcsname{\YG@func@}\fi
  \let\rightP\migiT
  \let\leftP\hidariT
}%
%
\def\glines{\@ifnextchar<{\@glines}{\@glines<\empty>}}%
\def\@glines<#1>#2{{%
  \ifnum\EMps@mode=\@ne\gsave\fi
  \ifx\empty #1\else
    \@ifundefined{ps@debug@}{\setkeys{emP}{#1}}{\setkeys{emPs}{#1}}%
  \fi
      \def\@@glines(##1)##2\@nil{%
        \gline{(##1)}{##2}}%
  \Cfor{\edef\glines@a{#2}}{\not\equal\glines@a\empty}{%
    \edef\glines@a{\glines@b}}\do{%
    \strsep\glines@a{;}\glines@a\glines@b
    \expandafter\@@glines\glines@a\@nil}%
  \ifnum\EMps@mode=\@ne\grestore\fi
}}%
%
\def\ngline{\@ifnextchar<{\@ngline}{\@ngline<\empty>}}%
\def\@ngline<#1>#2#3{%
  \@Div{-1}{#3}\kl@m
  \@gline<#1>{#2}\kl@m
}%
%
%
\def\LlineLR#1#2#3#4{%
% #1, #2: 二点
% #3: \hidariT
% #4: \migiT
%
  \Subvec{#2}{#1}\cL@tmp\vecXY\cL@tmp\cL@x\cL@y
  \Abs\cL@x\cL@absx
  \ifdim\cL@absx\p@<0.0001\p@%    鉛直
    \vecXY{#1}\cL@x\cL@y
    \edef#3{(\cL@x,\true@ymin)}%
    \edef#4{(\cL@x,\true@ymax)}%
  \else
    \vecXY{#1}\cL@xi\cL@yi
    \vecXY{#2}\cL@xii\cL@yii
    \Sub\true@xmax\cL@xi\cL@m\Sub\cL@xii\true@xmax\cL@n
    \Bunten{#1}{#2}\cL@m\cL@n\cL@R
    \vecXY\cL@R\cL@Rx\cL@Ry
    \Sub\true@xmin\cL@xi\cL@m\Sub\cL@xii\true@xmin\cL@n
    \Bunten{#1}{#2}\cL@m\cL@n\cL@L
    \vecXY\cL@L\cL@Lx\cL@Ly\relax
    \ifdim\cL@Ry\p@>\true@ymax\p@
      \Sub\true@ymax\cL@yi\cL@m\Sub\cL@yii\true@ymax\cL@n
      \Bunten{#1}{#2}\cL@m\cL@n#4\relax
    \else\ifdim\cL@Ry\p@<\true@ymin\p@
      \Sub\true@ymin\cL@yi\cL@m\Sub\cL@yii\true@ymin\cL@n
      \Bunten{#1}{#2}\cL@m\cL@n#4\relax
    \else
      \edef#4{\cL@R}%
    \fi\fi
    \ifdim\cL@Ly\p@>\true@ymax\p@
      \Sub\true@ymax\cL@yi\cL@m\Sub\cL@yii\true@ymax\cL@n
      \Bunten{#1}{#2}\cL@m\cL@n#3\relax
    \else\ifdim\cL@Ly\p@<\true@ymin\p@
      \Sub\true@ymin\cL@yi\cL@m\Sub\cL@yii\true@ymin\cL@n
      \Bunten{#1}{#2}\cL@m\cL@n#3\relax
    \else
      \edef#3{\cL@L}%
    \fi\fi
  \fi
}%
\def\llineLR#1#2#3#4{%
  \Addvec{#1}{#2}\gL@Q
  \LlineLR{#1}\gL@Q#3#4\relax
}%
\def\glineLR#1#2#3#4{%
  \Addvec{#1}{(1,#2)}\gL@Q
  \LlineLR{#1}\gL@Q#3#4\relax
}%
\def\nglineLR#1#2#3#4{%
  \@Div{-1}{#2}\kl@m
  \glineLR{#1}\kl@m#3#4\relax
}%
\def\nlineLR#1#2#3#4{%
  \Housenvec{#3}\kl@v
  \llineLR{#1}\kl@v#3#4\relax
}%
\def\klineLR#1#2#3#4{%
  \edef\kl@a{#2}%
  \ifnum\Rdef@rad>\z@
    \RadDeg{\kl@a}\kl@a
  \fi
  \ifdim\kl@a\p@=90\p@
    \edef\kl@c{0}%
    \edef\kl@s{1}%
  \else
    \@ifundefined{@xscale}{}{%
      \DegTan{\kl@a}\kl@tmp
      \Mulself\kl@tmp\@xscale
      \Divself\kl@tmp\@yscale
      \atan\kl@tmp\kl@a
    }%
    \DegCos{\kl@a}\kl@c
    \DegSin{\kl@a}\kl@s
  \fi
  \llineLR{#1}{(\kl@c,\kl@s)}#3#4\relax
}%
%
% \LlineLRs
%
\def\LlineLRs@sub{\@ifnextchar({\LlineLRs@sub@}{\LlineLRs@sub@@}}%
\def\LlineLRs@sub@(#1){\LlineLRs@sub@@{(#1)}}%
\def\LlineLRs@sub@@#1#2#3#4\@nil{%
  \lineLR@cmd{#1}{#2}#3#4\@nil
}%
\def\LlineLRs#1{%
  \let\lineLR@cmd\LlineLR
  \exfor[;]\LLRs@:=#1\do{%
    \expandafter\LlineLRs@sub\LLRs@
  }%
}%
\def\llineLRs#1{%
  \let\lineLR@cmd\llineLR
  \exfor[;]\LLRs@:=#1\do{%
    \expandafter\LlineLRs@sub\LLRs@
  }%
}%
\def\klineLRs#1{%
  \let\lineLR@cmd\klineLR
  \exfor[;]\LLRs@:=#1\do{%
    \expandafter\LlineLRs@sub\LLRs@
  }%
}%
\def\glineLRs#1{%
  \let\lineLR@cmd\glineLR
  \exfor[;]\LLRs@:=#1\do{%
    \expandafter\LlineLRs@sub\LLRs@
  }%
}%
%
%
%
% 直線 ax+by+c=0
%
\def\abcline{\@ifnextchar<{\@abcline}{\@abcline<\empty>}}%
\def\@abcline<#1>#2{%
% #2=a,b,c
  \vecXYZ{(#2)}\abcln@a\abcln@b\abcln@c
  \perlteisuuretu{abcln@a=\abcln@a;abcln@b=\abcln@b;abcln@c=\abcln@c}%
  \ifdim \abcln@b\p@=\z@
    \@Div\abcln@c\abcln@a\abcln@x
    \Mulself\abcln@x{-1}%
    \kline<#1>{(\abcln@x,0)}{90}%
  \else
    \@Div\abcln@a\abcln@b\abcln@m
    \@Div\abcln@c\abcln@b\abcln@n
    \Mulself\abcln@m{-1}%
    \Mulself\abcln@n{-1}%
    \gline<#1>{(0,\abcln@n)}\abcln@m
  \fi
}
%
\def\abclines{\@ifnextchar<{\@abclines}{\@abclines<\empty>}}%
\def\@abclines<#1>#2{{\ifx\empty #1\else\setkeys{emGurafu}{#1}\fi
%-----------------------------------------------------
  \def\@@abclines{\@ifnextchar<{\@@@abclines}{\@@@abclines<\empty>}}%
  \def\@@@abclines<##1>##2\@nil{%
    \EMedef\abc@tmp{<##1>{##2}}%
    \expandafter\abcline\abc@tmp
  }%
%-----------------------------------------------------
  \Cfor{\EMedef\abclines@a{#2}}{\not\equal\abclines@a\empty}{%
      \EMedef\abclines@a{\abclines@b}}\do{%
    \Strsep\abclines@a{;}\abclines@a\abclines@b
    \expandafter\@@abclines\abclines@a\@nil}}}%
%
\def\csvline{\@ifnextchar<{\@csvline}{\@csvline<\empty>}}%
\def\@csvline<#1>#2{%
  \vecXY{(#2)}\csvl@a\csvl@b
  \@abcline<#1>{\csvl@a,-1,\csvl@b}%
}%
%
\def\Tyokusen{\@ifstar{\Tyokusen@star}{\@Tyokusen}}%
\def\Tyokusen@star{\@ifnextchar<{\@Tyokusen@star}{\@Tyokusen@star<\empty>}}%
\def\@Tyokusen@star<#1>#2#3{%
  \Subvec{#3}{#2}\houkou@bekutoru\mTyokusen*<#1>{#2}\houkou@bekutoru}%
\def\@Tyokusen{\@ifnextchar<{\@Tyokusen@s}{\@@Tyokusen}}%
\def\@Tyokusen@s<#1>#2#3{\Subvec{#3}{#2}\houkou@bekutoru
  \@mTyokusen<#1>{#2}\houkou@bekutoru}%
\def\@@Tyokusen{\@ifnextchar[{\@@@Tyokusen}{\@@@Tyokusen[l]}}%
\def\@@@Tyokusen[#1]#2#3{\Subvec{#3}{#2}\houkou@bekutoru
  \@mTyokusen[#1]{#2}\houkou@bekutoru}%
%
% 1点と方向角を与えた直線
% \kTyokusen<#1>[#2]#3#4[#5]#6[#7]#8
%   <#1> : 線種を変更するオプション
%   #2 : \qbezier の [...]
%       #2=l のときは直線を \qbezier ではなく，\drawline で描画する．
%   #3 : 直線上の１点
%   #4 : 方向角
%   #6 : 左端の x座標 （#5 に [y] とすれば，y座標）
%   #8 : 右端の x座標 （#7 に [y] とすれば，y座標）
%   (#6, #8 を {} としたときは描画領域全体）
\def\kTyokusen{\@ifstar{\kTyokusen@star}{\@kTyokusen}}%
\def\kTyokusen@star{\@ifnextchar<{\@kTyokusen@star}{\@kTyokusen@star<\empty>}}%
\def\@kTyokusen@star<#1>#2#3{\Rdef(1,#3)\houkou@v\mTyokusen*<#1>{#2}\houkou@v}%
\def\@kTyokusen{\@ifnextchar<{\@kTyokusen@s}{\@@kTyokusen}}%
\def\@kTyokusen@s<#1>#2#3{\Rdef(1,#3)\houkou@v\@mTyokusen<#1>{#2}\houkou@v}%
\def\@@kTyokusen{\@ifnextchar[{\@@@kTyokusen}{\@@@kTyokusen[l]}}%
\def\@@@kTyokusen[#1]#2#3{\Rdef(1,#3)\houkou@v\@mTyokusen[#1]{#2}\houkou@v}%
%
\def\nTyokusen{\@ifstar{\nTyokusen@star}{\@nTyokusen}}%
\def\nTyokusen@star{\@ifnextchar<{\@nTyokusen@star}{\@nTyokusen@star<\empty>}}%
\def\@nTyokusen@star<#1>#2#3{%
  \vecXY{#3}\LL@x\LL@y\Mulself\LL@x{-1}\edef\houkou@v{(\LL@y,\LL@x)}
  \mTyokusen*<#1>{#2}\houkou@v}%
\def\@nTyokusen{\@ifnextchar<{\@nTyokusen@s}{\@@nTyokusen}}%
\def\@nTyokusen@s<#1>#2#3{%
  \vecXY{#3}\LL@x\LL@y\Mulself\LL@x{-1}\edef\houkou@v{(\LL@y,\LL@x)}
  \@mTyokusen<#1>{#2}\houkou@v}%
\def\@@nTyokusen{\@ifnextchar[{\@@@nTyokusen}{\@@@nTyokusen[l]}}%
\def\@@@nTyokusen[#1]#2#3{%
  \vecXY{#3}\LL@x\LL@y\Mulself\LL@x{-1}\edef\houkou@v{(\LL@y,\LL@x)}
  \@mTyokusen[#1]{#2}\houkou@v}%
%
\def\gTyokusen{\@ifstar{\gTyokusen@star}{\@gTyokusen}}%
\def\gTyokusen@star{\@ifnextchar<{\@gTyokusen@star}{\@gTyokusen@star<\empty>}}%
\def\@gTyokusen@star<#1>#2#3{\edef\houkou@v{(1,#3)}%
  \mTyokusen*<#1>{#2}\houkou@v}%
\def\@gTyokusen{\@ifnextchar<{\@gTyokusen@s}{\@@gTyokusen}}%
\def\@gTyokusen@s<#1>#2#3{\edef\houkou@v{(1,#3)}\@mTyokusen<#1>{#2}\houkou@v}%
\def\@@gTyokusen{\@ifnextchar[{\@@@gTyokusen}{\@@@gTyokusen[l]}}%
\def\@@@gTyokusen[#1]#2#3{\edef\houkou@v{(1,#3)}\@mTyokusen[#1]{#2}\houkou@v}%
%
% １点と方向ベクトルを与えて直線を描画する．
% \mTyokusen<#1>[#2]#3#4[#5]#6[#7]#8
%   <#1> : 線種を変更するオプション
%   #2 : \qbezier の [...]
%       #2=l のときは直線を \qbezier ではなく，\drawline で描画する．
%   #3 : 直線上の１点
%   #4 : 方向ベクトル
%   #6 : 左端の x座標 （#5 に [y] とすれば，y座標）
%   #8 : 右端の x座標 （#7 に [y] とすれば，y座標）
%   (#6, #8 を {} としたときは描画領域全体）
\def\mTyokusen{\@ifstar{\mTyokusen@}{\@mTyokusen}}%
%
\def\mTyokusen@{\@ifnextchar<{\@mTyokusen@}{\@mTyokusen@<\empty>}}%
\def\@mTyokusen@<#1>#2#3{%
%
  \def\mT@yval##1##2{%
    \edef##2{##1}%
    \Subself##2\mT@xi
    \Mulself##2\mT@vy
    \Divself##2\mT@vx
    \Addself##2\mT@yi
  }%
  \def\mT@xval##1##2{%
    \edef##2{##1}%
    \Subself##2\mT@yi
    \Mulself##2\mT@vx
    \Divself##2\mT@vy
    \Addself##2\mT@xi
  }%
%
  \vecXY{#2}\mT@xi\mT@yi
  \vecXY{#3}\mT@vx\mT@vy
  \Abs\mT@vx\mT@tmp
  \ifdim\mT@tmp\p@<\emLlim\p@
    \edef\mT@P{(\mT@xi,\true@ymin)}%
    \edef\mT@Q{(\mT@xi,\true@ymax)}%
  \else
    \Abs\mT@vy\mT@tmp
    \ifdim\mT@tmp\p@<\emLlim\p@
      \edef\mT@P{(\true@xmin,\mT@yi)}%
      \edef\mT@Q{(\true@xmax,\mT@yi)}%
    \else
      \mT@yval\true@xmax\mT@tmp
      \ifdim\mT@tmp\p@>\true@ymax\p@
        \mT@xval\true@ymax\mT@tmp
        \edef\mT@Q{(\mT@tmp,\true@ymax)}%
      \else\ifdim\mT@tmp\p@<\true@ymin\p@
        \mT@xval\true@ymin\mT@tmp
        \edef\mT@Q{(\mT@tmp,\true@ymin)}%
      \else
        \edef\mT@Q{(\true@xmax,\mT@tmp)}%
      \fi\fi
      \mT@yval\true@xmin\mT@tmp
      \ifdim\mT@tmp\p@>\true@ymax\p@
        \mT@xval\true@ymax\mT@tmp
        \edef\mT@P{(\mT@tmp,\true@ymax)}%
      \else\ifdim\mT@tmp\p@<\true@ymin\p@
        \mT@xval\true@ymin\mT@tmp
        \edef\mT@P{(\mT@tmp,\true@ymin)}%
      \else
        \edef\mT@P{(\true@xmin,\mT@tmp)}%
      \fi\fi
    \fi
  \fi
  \Drawline<#1>{\mT@P\mT@Q}%
  \ifdim\mT@vx\p@<\z@
    \edef\migiT{\mT@P}%
    \edef\hidariT{\mT@Q}%
  \else
    \edef\migiT{\mT@Q}%
    \edef\hidariT{\mT@P}%
  \fi
}%
%
\def\@mTyokusen{\begingroup
  \ifnum\EMps@mode=\@ne\gsave\fi
  \let\sensyu@org\sensyu\@ifnextchar<{\@mTyokusen@s}{\@mTyokusen@t}}%
\def\@mTyokusen@s<#1>{\setkeys{emP}{#1}\m@Tyokusen[l]}%
\def\@mTyokusen@t{\@ifnextchar[{\m@Tyokusen}{\m@Tyokusen[l]}}%
\def\m@Tyokusen[#1]#2#3{%
  \@ifnextchar[{\@@mTyokusen[#1]{#2}{#3}}{%
    \@@mTyokusen[#1]{#2}{#3}[x]}}%
\def\@@mTyokusen[#1]#2#3[#4]#5{\@ifnextchar[{\@@@mTyokusen[#1]{#2}{#3}[#4]{#5}}{%
  \@@@mTyokusen[#1]{#2}{#3}[#4]{#5}[x]}}%
\def\@@@mTyokusen[#1]#2#3[#4]#5[#6]#7{\vecXY{#2}\@xi\@yi\vecXY{#3}\@mx\@my
  \Abs\@mx\@tmp
  \ifdim\@tmp pt<0.001pt\relax
\xdef\migiT{(\@xi,\true@ymax)}%
\xdef\hidariT{(\@xi,\true@ymin)}%
    \if l#1\relax\put(0,0){\sensyu(\@xi,\true@ymin)(\@xi,\true@ymax)}%
    \else \Drawline{(\@xi,\true@ymin)(\@xi,\true@ymax)}\fi
  \else
    \@Div\@my\@mx\Katamuki
    \Mul\Katamuki\@xi\@xi
    \Sub\@yi\@xi\Yseppen
    \GFunci[#1]\Katamuki\Yseppen[#4]{#5}[#6]{#7}%
\xdef\migiT{\migiT}%
\xdef\hidariT{\hidariT}%
\edef\Yseppen{(0,\Yseppen)}%
    \ifdim\@mx \p@<\z@
      \edef\mTyokusen@tmp{\migiT}%
      \xdef\migiT{\hidariT}\xdef\hidariT{\mTyokusen@tmp}%
    \fi
  \fi\let\sensyu\sensyu@org
\ifnum\EMps@mode=\@ne\grestore\fi
\endgroup
}%
%
\let\lTyokusen\mTyokusen
%
% 半直線
%
\define@key{emGurafu}{HlineT}[HlineT]{\def\YG@migiT{#1}}%
\define@key{emGurafu}{HlineM}{\def\YG@migiM{#1}}%
\define@key{emGurafu}{arrowheadsize}{\changeArrowHeadSize{#1}}%
% 始点と途中点を与えて半直線
\def\LHline{\@ifnextchar<{\@LHline}{\@LHline<\empty>}}%
\def\@LHline<#1>#2#3{%
  \Subvec{#3}{#2}\LHln@v
  \@lHline<#1>{#2}\LHln@v}%
% 始点と方向角を与えて半直線
\def\kHline{\@ifnextchar<{\@kHline}{\@kHline<\empty>}}%
\def\@kHline<#1>#2#3{%
  \DegCos{#3}\LH@x\DegSin{#3}\LH@y\edef\LHln@v{(\LH@x,\LH@y)}%
  \@lHline<#1>{#2}\LHln@v}%
% 始点と方向ベクトルを与えて半直線
\def\lHline{%
  \@ifnextchar<{\@lHline}{\@lHline<\empty>}}%
\def\@lHline<#1>#2#3{%
  \begingroup
  \ifnum\EMps@mode=\@ne\gsave\fi
  \edef\next@opt{\empty}%
  \edef\YG@migiT{\empty}%
  \edef\YG@migiM{\empty}%
  \ifx\empty#1\else\setkeys{emGurafu}{#1}\fi
  \vecXY{#2}\Htyoku@xi\Htyoku@yi
  \vecXY{#3}\Htyoku@mx\Htyoku@my
  \IFnearlyzero\Htyoku@mx{%
    \ifdim \Htyoku@my pt>\z@\edef\Htyoku@P{(\Htyoku@xi,\true@ymax)}\else
    \edef\Htyoku@P{(\Htyoku@xi,\true@ymin)}\fi
  }{%
    \@Div\Htyoku@my\Htyoku@mx\Htyoku@m
    \ifdim\Htyoku@mx pt>\z@
      \Sub\true@xmax\Htyoku@xi\Htyoku@y\Mul\Htyoku@y\Htyoku@m\Htyoku@y
      \Add\Htyoku@yi\Htyoku@y\Htyoku@y
      \ifdim \Htyoku@y pt>\true@ymax pt\relax
        \Sub\true@ymax\Htyoku@yi\Htyoku@x\@Div\Htyoku@x\Htyoku@m\Htyoku@x
        \Add\Htyoku@xi\Htyoku@x\Htyoku@x\edef\Htyoku@P{(\Htyoku@x,\true@ymax)}%
      \else\ifdim \Htyoku@y pt<\true@ymin pt\relax
        \Sub\true@ymin\Htyoku@yi\Htyoku@x\@Div\Htyoku@x\Htyoku@m\Htyoku@x
        \Add\Htyoku@xi\Htyoku@x\Htyoku@x\edef\Htyoku@P{(\Htyoku@x,\true@ymin)}%
      \else
        \edef\Htyoku@P{(\true@xmax,\Htyoku@y)}%
      \fi\fi
    \else
      \Sub\true@xmin\Htyoku@xi\Htyoku@y\Mul\Htyoku@y\Htyoku@m\Htyoku@y
      \Add\Htyoku@yi\Htyoku@y\Htyoku@y
      \ifdim \Htyoku@y pt>\true@ymax pt\relax
        \Sub\true@ymax\Htyoku@yi\Htyoku@x\@Div\Htyoku@x\Htyoku@m\Htyoku@x
        \Add\Htyoku@xi\Htyoku@x\Htyoku@x\edef\Htyoku@P{(\Htyoku@x,\true@ymax)}%
      \else\ifdim \Htyoku@y pt<\true@ymin pt\relax
        \Sub\true@ymin\Htyoku@yi\Htyoku@x\@Div\Htyoku@x\Htyoku@m\Htyoku@x
        \Add\Htyoku@xi\Htyoku@x\Htyoku@x\edef\Htyoku@P{(\Htyoku@x,\true@ymin)}%
      \else
        \edef\Htyoku@P{(\true@xmin,\Htyoku@y)}%
      \fi\fi
    \fi
  }%
  \ifx\empty\next@opt
    \Drawline{#2\Htyoku@P}%\edef\HtyokuT{\Htyoku@P}%
  \else
    \EMedef\Hl@tmp{<\next@opt>}
    \expandafter\Drawline\Hl@tmp{#2\Htyoku@P}%\edef\HtyokuT{\Htyoku@P}%
  \fi
  \ifx\empty\YG@migiM\else
    \edef\migiT{\Htyoku@P}%
    \expandafter\show@migiM\YG@migiM\@nil
  \fi
  \ifnum\EMps@mode=\@ne\grestore\fi
  \edef\temp@x{%
    \def\noexpand\HlineT{\Htyoku@P}%
    \def\noexpand\YG@migiT{\YG@migiT}%
  }%
  \expandafter\endgroup\temp@x
  \ifx\empty\YG@migiT\else
    \expandafter\edef\csname\YG@migiT\endcsname{\HlineT}\fi
  \edef\migiT{\HlineT}%
}%
\let\mHline\lHline
%
% 始点と途中点を与えて半直線
  \def\Hantyokusen{\@ifnextchar<{\@Hantyokusen}{\@Hantyokusen<\empty>}}%
  \def\@Hantyokusen<#1>#2#3{%
    \Subvec{#3}{#2}\Htyoku@mv\@mHantyokusen<#1>{#2}\Htyoku@mv}%
% 始点と方向角を与えて半直線
  \def\kHantyokusen{\@ifnextchar<{\@kHantyokusen}{\@kHantyokusen<\empty>}}%
  \def\@kHantyokusen<#1>#2#3{%
    \DegCos{#3}\Htyoku@x\DegSin{#3}\Htyoku@y
    \@mHantyokusen<#1>{#2}{(\Htyoku@x,\Htyoku@y)}}%
% 始点と方向ベクトルを与えて半直線
  \def\mHantyokusen{\@ifnextchar<{\@mHantyokusen}{\@mHantyokusen<\empty>}}%
  \def\@mHantyokusen<#1>#2#3{%\ifnum\EMps@mode=\@ne\gsave\fi{%
%    \Strchr{#1}{=}\Hantyoku@tmp\ifnum\Hantyoku@tmp>\z@\setkeys{emP}{#1}\fi
    \vecXY{#2}\Htyoku@xi\Htyoku@yi
    \vecXY{#3}\Htyoku@mx\Htyoku@my
    \IFnearlyzero\Htyoku@mx{%
      \ifdim \Htyoku@my pt>\z@\edef\Htyoku@P{(\Htyoku@xi,\ymax)}\else
      \edef\Htyoku@P{(\Htyoku@xi,\true@ymin)}\fi
    }{%
      \@Div\Htyoku@my\Htyoku@mx\Htyoku@m
      \ifdim\Htyoku@mx pt>\z@
        \Sub\xmax\Htyoku@xi\Htyoku@y\Mul\Htyoku@y\Htyoku@m\Htyoku@y
        \Add\Htyoku@yi\Htyoku@y\Htyoku@y
        \ifdim \Htyoku@y pt>\ymax pt\relax
          \Sub\ymax\Htyoku@yi\Htyoku@x\@Div\Htyoku@x\Htyoku@m\Htyoku@x
          \Add\Htyoku@xi\Htyoku@x\Htyoku@x\edef\Htyoku@P{(\Htyoku@x,\ymax)}%
        \else\ifdim \Htyoku@y pt<\true@ymin pt\relax
          \Sub\true@ymin\Htyoku@yi\Htyoku@x\@Div\Htyoku@x\Htyoku@m\Htyoku@x
          \Add\Htyoku@xi\Htyoku@x\Htyoku@x\edef\Htyoku@P{(\Htyoku@x,\true@ymin)}%
        \else
          \edef\Htyoku@P{(\xmax,\Htyoku@y)}%
        \fi\fi
      \else
        \Sub\xmin\Htyoku@xi\Htyoku@y\Mul\Htyoku@y\Htyoku@m\Htyoku@y
        \Add\Htyoku@yi\Htyoku@y\Htyoku@y
        \ifdim \Htyoku@y pt>\ymax pt\relax
            \Sub\ymax\Htyoku@yi\Htyoku@x\@Div\Htyoku@x\Htyoku@m\Htyoku@x
            \Add\Htyoku@xi\Htyoku@x\Htyoku@x\edef\Htyoku@P{(\Htyoku@x,\ymax)}%
        \else\ifdim \Htyoku@y pt<\true@ymin pt\relax
            \Sub\true@ymin\Htyoku@yi\Htyoku@x\@Div\Htyoku@x\Htyoku@m\Htyoku@x
            \Add\Htyoku@xi\Htyoku@x\Htyoku@x\edef\Htyoku@P{(\Htyoku@x,\true@ymin)}%
        \else
          \edef\Htyoku@P{(\xmin,\Htyoku@y)}%
        \fi\fi
      \fi
    }%\Sensyu{#2\Htyoku@P}\xdef\HtyokuT{\Htyoku@P}}%
    \Drawline<#1>{#2\Htyoku@P}\edef\HtyokuT{\Htyoku@P}%
%    \ifnum\EMps@mode=\@ne\grestore\fi
}%
%
% 2点を通る直線の方程式
% #1 と #2 を通る直線 y=ax+b の a を #3, b を #4 に与える．
%
\def\LtoEq#1#2#3#4{%
\vecXY{#1}\@xi\@yi%
\vecXY{#2}\@xii\@yii%
\Sub\@yii\@yi\@m%
\Sub\@xii\@xi\@n%
\@Div\@m\@n\@m\edef#3{\@m}%
\Mul\@m\@xi\@n
\Sub\@yi\@n\@n\edef#4{\@n}%
}%
%
% 一次関数値
% y=ax+b
% #1 : a
% #2 : b
% #3 : x
% #4 : y
%
\def\Funci#1#2#3#4{%
  \Mul{#1}{#3}\@f
  \Add\@f{#2}\@f
  \edef#4{\@f}}%
%
% 一次方程式
% ax+b=c
% #1 : a
% #2 : b
% #3 : c
% #4 : x
%
\def\Eqi#1#2#3#4{%
  \Sub{#3}{#2}\@f
  \@Div\@f{#1}\@f
  \edef#4{\@f}}%
%
% 一次関数 y=ax+b (x1<x<x2) のグラフ
% #1 : 直線上の点の個数（デフォルトは0(無数))
%                        デフォルト変更 l (\drawline で描画)
% #2 : a
% #3 : b
% #5 : x1 #4で[y]オプションをつけたときは y1
% #7 : x2 #6で[y]オプションをつけたときは y2
%
\def\GFunci{\@ifnextchar[{\@GFunci}{\@GFunci[l]}}%
\def\@GFunci[#1]#2#3{\@ifnextchar[{\@@GFunci[#1]{#2}{#3}}{%
  \@@GFunci[#1]{#2}{#3}[x]}}%
\def\@@GFunci[#1]#2#3[#4]#5{\@ifnextchar[{\@@@GFunci[#1]{#2}{#3}[#4]{#5}}{%
  \@@@GFunci[#1]{#2}{#3}[#4]{#5}[x]}}%
\def\@@@GFunci[#1]#2#3[#4]#5[#6]#7{%
% \Add{#5}{#7}\GFunc@x\@Div\GFunc@x{2}\GFunc@x%
  \ifthenelse{\equal{#5}{\empty}}{%
    \Mul{#2}\truexmin\GFunc@yi\Add\GFunc@yi{#3}\GFunc@yi
    \ifdim \GFunc@yi pt>\ymax pt
      \Eqi{#2}{#3}\ymax\GFunc@xi\edef\GFunc@yi{\ymax}%
    \else\ifdim\GFunc@yi pt<\trueymin pt
      \Eqi{#2}{#3}\trueymin\GFunc@xi\edef\GFunc@yi{\trueymin}%
    \else
      \edef\GFunc@xi{\truexmin}%
    \fi\fi
    \Mul{#2}\truexmax\GFunc@yii\Add\GFunc@yii{#3}\GFunc@yii
    \ifdim \GFunc@yii pt>\ymax pt
      \Eqi{#2}{#3}\ymax\GFunc@xii\edef\GFunc@yii{\ymax}%
    \else\ifdim\GFunc@yii pt<\trueymin pt
      \Eqi{#2}{#3}\trueymin\GFunc@xii\edef\GFunc@yii{\trueymin}%
    \else
      \edef\GFunc@xii{\truexmax}%
    \fi\fi
  }{%
    \ifx y#4\Eqi{#2}{#3}{#5}\GFunc@xi\edef\GFunc@yi{#5}\else%
      \edef\GFunc@xi{#5}\Funci{#2}{#3}{\GFunc@xi}\GFunc@yi\fi%
    \ifx y#6\Eqi{#2}{#3}{#7}\GFunc@xii\edef\GFunc@yii{#7}\else%
      \edef\GFunc@xii{#7}\Funci{#2}{#3}{\GFunc@xii}\GFunc@yii\fi%
  }%
%  \Funci{#2}{#3}\GFunc@xii\GFunc@yii%
\edef\hidariT{(\GFunc@xi,\GFunc@yi)}%
\edef\migiT{(\GFunc@xii,\GFunc@yii)}%
  \ifx l#1\relax
    \ifx\empty\iro@
      \put(0,0){\sensyu(\GFunc@xi,\GFunc@yi)(\GFunc@xii,\GFunc@yii)}%
    \else
      \ifnum\EMps@mode>\z@
        \begin{EMpscolor}\iro@
          \put(0,0){\sensyu(\GFunc@xi,\GFunc@yi)(\GFunc@xii,\GFunc@yii)}%
        \end{EMpscolor}%
      \else
        \put(0,0){\@iro{\iro@}%
          \sensyu(\GFunc@xi,\GFunc@yi)(\GFunc@xii,\GFunc@yii)%
        }%
      \fi
    \fi
  \else%
    \Add\GFunc@xi\GFunc@xii\GFunc@x\@Div\GFunc@x2\GFunc@x%
    \Funci{#2}{#3}{\GFunc@x}\GFunc@y%
    \qbezier[#1](\GFunc@xi,\GFunc@yi)(\GFunc@x,\GFunc@y)(\GFunc@xii,\GFunc@yii)%
  \fi}%
%
% 直線描画
% ax+by+c=0 を描画する．
\def\tyokusen{\@ifnextchar[{\@tyokusen}{\@tyokusen[l]}}%
\def\@tyokusen[#1]#2#3#4{%
        \@Div{#4}{-#3}\y@seppen
        \mTyokusen[#1]{(0,\y@seppen)}{(#3,-#2)}%
    }%
%
% 点と直線の距離(1)
% 点 P(x1,y1) と直線 ax+by+c=0 との距離を求める．
\def\tentotyokusen#1#2#3#4#5{%
%       #1 : 点P
%       #2 : a
%       #3 : b
%       #4 : c
%       #5 : 点と直線の距離
    \vecXY{#1}\tt@x\tt@y
    \Mul{#2}\tt@x\@bunsi
    \Mul{#3}\tt@y\@@bunsi\Add\@bunsi\@@bunsi\@bunsi
    \Add\@bunsi{#4}\@bunsi\Abs\@bunsi\@bunsi
    \Absvec{(#2,#3)}\@bunbo\@Div\@bunsi\@bunbo\@@bunsi
    \edef#5{\@@bunsi}}%
%
% 点と直線の距離(2)
% 点 P(x1,y1) と直線 AB との距離を求める．
\def\tentoTyokusen#1#2#3#4{%
%       #1 : 点P
%       #2 : 点A
%       #3 : 点B
%       #4 : 点と直線の距離
    \Suisen{#1}{#2}{#3}\@H\Kyori{#1}\@H#4}%
%
% 円の接線(1)
% 円周上の点における接線の単位方向ベクトルを求める．
\def\ennoSessen#1#2#3{%
%           #1 : 円の中心
%           #2 : 円周上の点
%           #3 : 接線の方向ベクトル（単位ベクトル）
    \Subvec{#2}{#1}\@CT\Nvec\@CT#3}%
%
%
% 円の接線(2)
% 円の外部の点から円に引いた接線の接点を求める．
\def\enniSessen#1#2#3#4#5{%
%           #1 : 円の中心
%           #2 : 円の半径
%           #3 : 円の外部の点
%           #4 : 接点(1)
%           #5 : 接点(2)
%    \Kyorii{#1}{#3}\@ACii\Mul{#2}{#2}\@rii%
%    \Sub\@ACii\@rii\@ATii
%    \Heihoukon\@ATii\@AT%
    \Kyori{#1}{#3}\@ACi
    \@Div{#2}\@ACi\@ACii
    \Mulself\@ACii\@ACii
    \Sub{1}\@ACii\@ACiii
    \Heihoukon\@ACiii\@AT
    \Mulself\@AT\@ACi
    \ifdim\@AT pt<0.001pt\relax
      \edef#4{#3}\edef#5{#3}%
    \else
      \CandC{#1}{#2}{#3}\@AT{#4}{#5}\relax
    \fi
}%
% 方向ベクトルを指定した接線
\def\enlSessen#1#2#3#4#5{%
%           #1 : 円の中心
%           #2 : 円の半径
%           #3 : 接線の方向ベクトル
%           #4 : 接点(1)
%           #5 : 接点(2)
  \vecXY{#3}\enl@x\enl@y
  \Mulself\enl@x{-1}%
  \Candl{#1}{#2}{#1}{(\enl@y,\enl@x)}{#4}{#5}%
}%
\def\engSessen#1#2#3#4#5{%
  \enlSessen{#1}{#2}{(1,#3)}#4#5\relax}%
%
% 2円の共通接線
% \KTGAISessen#1#2#3#4#5#6#7#8
% \KTNAISessen#1#2#3#4#5#6#7#8
%   #1 : 円1の中心
%   #2 : 円1の半径
%   #3 : 円2の中心
%   #4 : 円2の半径
%   #5 : 共通接線1と円1の接点
%   #6 : 共通接線1と円2の接点
%   #7 : 共通接線2と円1の接点
%   #8 : 共通接線2と円2の接点
%
\def\KTGAISessen#1#2#3#4#5#6#7#8{%
  \Sub{#4}{#2}\KT@tmp\Abs\KT@tmp\KT@tmp
  \ifdim\KT@tmp pt<0.001pt
    \Subvec{#1}{#3}\KT@CC
    \Rotvec[#2]\KT@CC{90}\KT@tmp
    \Addvec{#1}\KT@tmp#5\Addvec{#3}\KT@tmp#6\relax
    \Rotvec[#2]\KT@CC{-90}\KT@tmp
    \Addvec{#1}\KT@tmp#7\Addvec{#3}\KT@tmp#8\relax
  \else
    \@Bunten{#1}{#3}{#2}{-#4}\KT@kouten
    \enniSessen{#1}{#2}\KT@kouten#5#7\relax
    \Suisen{#3}\KT@kouten{#5}#6\relax
    \Suisen{#3}\KT@kouten{#7}#8\relax
  \fi
}%
%
\def\KTNAISessen#1#2#3#4#5#6#7#8{%
  \@Bunten{#1}{#3}{#2}{#4}\KT@kouten
  \enniSessen{#1}{#2}\KT@kouten#5#7\relax
  \Kyori\KT@kouten{#5}\KT@tmp
  \ifdim\KT@tmp pt<0.0001pt\edef#6{#5}\edef#8{#7}\else
  \Suisen{#3}\KT@kouten{#5}#6\relax\Suisen{#3}\KT@kouten{#7}#8\fi
}%
%
%
% 楕円の接線
%
\def\DaennoSessen#1#2#3#4#5{%
% #1 : 楕円の中心
% #2 : x軸方向の半径
% #3 : y軸方向の半径
% #4 : 接点
% #5 : 接線の方向ベクトルを受け取る制御綴
  \@Div{#3}{#2}\EandL@hi
  \Subvec{#4}{#1}\EandL@tmp
   \vecXY\EandL@tmp\EandL@x\EandL@y\@Div\EandL@y\EandL@hi\EandL@y
    \edef\EandL@T{(\EandL@x,\EandL@y)}%
  \ennoSessen\O@@\EandL@T\EandL@tmp
  \vecXY\EandL@tmp\EandL@x\EandL@y\Mul\EandL@y\EandL@hi\EandL@y
  \edef#5{(\EandL@x,\EandL@y)}\relax
}%
\def\DaenniSessen#1#2#3#4#5#6{%
% #1 : 楕円の中心
% #2 : x軸方向の半径
% #3 : y軸方向の半径
% #4 : 楕円の外部の点
% #5 : 接点1を受け取る制御綴
% #6 : 接点2を受け取る制御綴
  \@Div{#3}{#2}\EandL@hi
  \Subvec{#4}{#1}\EandL@tmp
   \vecXY\EandL@tmp\EandL@x\EandL@y\@Div\EandL@y\EandL@hi\EandL@y
    \edef\EandL@T{(\EandL@x,\EandL@y)}%
  \enniSessen{(0,0)}{#2}\EandL@T\EandL@P\EandL@Q
  \vecXY\EandL@P\EandL@x\EandL@y\Mul\EandL@y\EandL@hi\EandL@y
    \edef\EandL@P{(\EandL@x,\EandL@y)}\Addvec\EandL@P{#1}#5\relax
  \vecXY\EandL@Q\EandL@x\EandL@y\Mul\EandL@y\EandL@hi\EandL@y
    \edef\EandL@Q{(\EandL@x,\EandL@y)}\Addvec\EandL@Q{#1}#6\relax
}%
%
%
% 2直線の交点
%   \LandL#1#2#3#4#5
%       2点 #1, #2 を通る直線と
%       2点 #3, #4 を通る直線の交点を #5 に与える．
%
    \def\Put@nil#1{\let\LL@prnm\undefined
      \@ifnextchar[{\Put@nil@{#1}}{\@Put@nil{#1}}}%
    \def\Put@nil@#1[#2]{%
      \EMedef\LL@prnm{#2}\@Put@nil{#1}}%
    \def\@Put@nil#1#2#3\@nil{%
%\strip@cmd{#2}\P@name
      \edef#2{#1}%
%\vecXY{#2}\P@x\P@y
%\expandafter\edef\csname \P@name x\endcsname{\P@x}%
%\expandafter\edef\csname \P@name y\endcsname{\P@y}%
      \ifx\empty #3\else
        \@ifundefined{LL@prnm}{\strip@cmd #2\LL@prnm}{}%
        \EMedef\LL@putarg{{#2}#3{\LL@prnm}}%
        \expandafter\emathPut\LL@putarg
%\typeout{put@nil:KM=\put@KM}%
      \fi
    }%
%
    \def\Put@@nil#1{\let\LL@prnm\undefined\edef\Pn@P{#1}%
      \@ifnextchar[{\Put@@nil@}{\@Put@@nil}}%
    \def\Put@@nil@[#1]{%
      \EMedef\LL@prnm{#1}\@Put@@nil}%
    \def\@Put@@nil#1\@nil{%
      \Strsep{#1}{(}\Pn@a\Pn@b
      \ifx\empty\Pn@b
        \Strsep{#1}{[}\Pn@a\Pn@b
        \ifx\empty\Pn@b
          \@@Put@@nil\Pn@a\@@nil
        \else
          \@@Put@@nil{\Pn@a}[\Pn@b\@@nil
        \fi
      \else
        \@@Put@@nil{\Pn@a}(\Pn@b\@@nil
      \fi
    }
    \def\@@Put@@nil#1#2\@@nil{%
      \expandafter\edef\csname #1\endcsname{\Pn@P}%
      \ifx\empty #2\else
        \@ifundefined{LL@prnm}{\edef\LL@prnm{#1}}{}%
        \EMedef\LL@putarg{{\csname #1\endcsname}#2{\LL@prnm}}%
        \expandafter\emathPut\LL@putarg
      \fi
    }%
%
\edef\LandL@w{\empty}%
\def\LandLweight#1{\def\LandL@w{#1}}%
\def\LandL{%
  \edef\by@perl{\by@perl@}%
  \edef\LandL@w{\empty}%
  \@ifnextchar<{\LandL@}{\@LandL}}%
\def\LandL@<#1>{\setkeys{emP}{#1}\@LandL}%
\def\@LandL#1#2#3#4#5{%
% ---------------------------------------------------------------
    \def\@@LandL{\let\LL@prnm\undefined
      \@ifnextchar[{\@@LandL@}{\@@@LandL}}%
    \def\@@LandL@[##1]{\edef\LL@prnm{##1}\@@@LandL}%
    \def\@@@LandL##1##2\@nil{%
      \edef##1{\LL@P}%
      \ifx\empty ##2\else
        \@ifundefined{LL@prnm}{\strip@cmd##1\LL@prnm}{}%
        \EMedef\LL@putarg{{##1}##2{\LL@prnm}}%
        \expandafter\emathPut\LL@putarg
      \fi
    }%
% ---------------------------------------------------------------
 \ifnum\by@perl=\z@
%  \edef#5{#1}%
  \Kyori{#1}{#2}\LandL@a
  \Kyori{#3}{#4}\LandL@b
  \ifdim\LandL@a pt> 0.005pt\relax
  \ifdim\LandL@b pt> 0.005pt\relax
    \vecXY{#1}\A@x\A@y\vecXY{#2}\B@x\B@y%
    \vecXY{#3}\C@x\C@y\vecXY{#4}\D@x\D@y%
    \ifx\empty\LandL@w\relax\else
      \Mul\A@x\LandL@w\A@x
      \Mul\A@y\LandL@w\A@y
      \Mul\B@x\LandL@w\B@x
      \Mul\B@y\LandL@w\B@y
      \Mul\C@x\LandL@w\C@x
      \Mul\C@y\LandL@w\C@y
      \Mul\D@x\LandL@w\D@x
      \Mul\D@y\LandL@w\D@y
    \fi
    \Sub\B@x\A@x\B@v\Sub\B@y\A@y\C@v%
    \Sub\D@x\C@x\D@v\Sub\D@y\C@y\E@v%
    \Mul\A@x\B@y\C@vi\Mul\B@x\A@y\@tmp\Sub\C@vi\@tmp\C@vi%
    \Mul\C@x\D@y\E@vi\Mul\D@x\C@y\@tmp\Sub\E@vi\@tmp\E@vi%
    \Mul\B@v\E@v\delta@\Mul\C@v\D@v\@tmp\Sub\delta@\@tmp\delta@%
    \Mul\B@v\E@vi\delta@x\Mul\C@vi\D@v\@tmp\Sub\delta@x\@tmp\delta@x%
    \Mul\C@v\E@vi\delta@y\Mul\C@vi\E@v\@tmp\Sub\delta@y\@tmp\delta@y%
    \ifdim\delta@\p@=\z@
      \edef\LL@P{#1}%
    \else
      \@Div\delta@x\delta@\delta@x\@Div\delta@y\delta@\delta@y%
      \ifx\empty\LandL@w\relax\else
        \@Div\delta@x\LandL@w\delta@x
        \@Div\delta@y\LandL@w\delta@y
      \fi
      \edef\LL@P{(\delta@x,\delta@y)}%
    \fi
  \fi\fi
%  \@@LandL#5\@nil
  \Put@nil\LL@P #5\@nil
 \else
  \perlLandL{#1}{#2}{#3}{#4}{#5}%
  \edef\by@perl{\by@perl@}%
 \fi
}%
%
\def\Landl#1#2#3#4#5{%
  \Addvec{#3}{#4}\@v
  \LandL{#1}{#2}{#3}\@v{#5}}%
%
\def\landl#1#2#3#4#5{%
  \Addvec{#1}{#2}\@u
  \Addvec{#3}{#4}\@v
  \LandL{#1}{\@u}{#3}{\@v}{#5}}%
\def\Landg#1#2#3#4#5{%
  \Addvec{#3}{(1,#4)}\@u
  \LandL{#1}{#2}{#3}{\@u}{#5}}%
\def\gandL#1#2#3#4#5{%
  \Landg{#3}{#4}{#1}{#2}{#5}}%
\def\Landng#1#2#3#4#5{%
  \Addvec{#3}{(#4,-1)}\@u
  \LandL{#1}{#2}{#3}{\@u}{#5}}%
\def\Landn#1#2#3#4#5{%
  \vecXY{#4}\LL@x\LL@y
  \Mulself\LL@x{-1}%
  \Landl{#1}{#2}{#3}{(\LL@y,\LL@x)}{#5}}%
\let\Landnl\Landn
\def\LandnL#1#2#3#4#5{%
  \Subvec{#4}{#3}\lnl@v
  \Landnl{#1}{#2}{#3}\lnl@v{#5}}%
\def\landg#1#2#3#4#5{%
  \Addvec{#1}{#2}\@u
  \Addvec{#3}{(1,#4)}\@v
  \LandL{#1}{\@u}{#3}{\@v}{#5}}%
\def\gandl#1#2#3#4#5{\landg{#3}{#4}{#1}{#2}{#5}}%
\def\landng#1#2#3#4#5{%
  \Addvec{#3}{(#4,-1)}\@u
  \Landl{#3}\@u{#1}{#2}{#5}}%
\def\landn#1#2#3#4#5{%
  \Housenvec{#4}\kl@v
  \landl{#1}{#2}{#3}\kl@v{#5}\relax}%
\let\landnl\landn
\def\gandg#1#2#3#4#5{%
  \Addvec{#1}{(1,#2)}\@u
  \Addvec{#3}{(1,#4)}\@v
  \LandL{#1}{\@u}{#3}{\@v}{#5}}%
\def\gandk#1#2#3#4#5{%
  \Addvec{#1}{(1,#2)}\@u
  \Rdef[#3](1,#4)\@v
  \LandL{#1}{\@u}{#3}{\@v}{#5}}%
\def\ngandk#1#2#3#4#5{%
  \Addvec{#1}{(#2,-1)}\@u
  \Rdef[#3](1,#4)\@v
  \LandL{#1}{\@u}{#3}{\@v}{#5}}%
\def\nandn#1#2#3#4#5{%
  \Housenvec{#2}\@u
  \Housenvec{#4}\@v
  \landl{#1}{\@u}{#3}{\@v}{#5}}%
\def\ngandng#1#2#3#4#5{%
  \Addvec{#1}{(#2,-1)}\@u
  \Addvec{#3}{(#4,-1)}\@v
  \LandL{#1}{\@u}{#3}{\@v}{#5}}%
%
% \kandk#1#2#3#4#5
%   点#1を通り方向角#2度の直線と
%   点#3を通り方向角#4度の直線の交点を#5に与える。
\def\kandk{\@ifstar{\kandk@}{\@kandk}}%
\def\@kandk#1#2#3#4#5{%
  \Rdef[#1](1,#2)\mm@A
  \Rdef[#3](1,#4)\mm@B
  \@ifundefined{@yscale}{}{%
    \vecXY\mm@A\mm@Ax\mm@Ay
    \vecXY\mm@B\mm@Bx\mm@By
    \Divself\mm@Ax\@xscale
    \Divself\mm@Bx\@xscale
    \Divself\mm@Ay\@yscale
    \Divself\mm@By\@yscale
    \edef\mm@A{(\mm@Ax,\mm@Ay)}%
    \edef\mm@B{(\mm@Bx,\mm@By)}%
  }%
  \LandL{#1}\mm@A{#3}\mm@B{#5}}%
\def\kandk@#1#2#3#4#5{\Rdef*[#1](1,#2)\mm@A
  \Rdef*[#3](1,#4)\mm@B
  \LandL{#1}\mm@A{#3}\mm@B#5}%
\def\kandn#1#2#3#4#5{\Rdef[#1](1,#2)\mm@A
  \Rdef[#1](1,#2)\mm@B
  \vecXY{#4}\LL@x\LL@y
  \Mulself\LL@x{-1}%
  \Landl{#1}\mm@A{#3}{(\LL@y,\LL@x)}{#5}}%
\def\landk#1#2#3#4#5{%
  \Addvec{#1}{#2}\@u
  \Rdef[#3](1,#4)\@v
%  \@ifundefined{@yscale}{}{%
%    \vecXY\@v\@vx\@vy
%    \Divself\@vx\@xscale
%    \Divself\@vy\@yscale
%    \edef\@v{(\@vx,\@vy)}%
%  }%
  \LandL{#1}\@u{#3}\@v{#5}}%
\def\kandl#1#2#3#4#5{\landk{#3}{#4}{#1}{#2}{#5}}%
\def\Landk{\@ifstar{\Landk@}{\@Landk}}%
\def\@Landk#1#2#3#4#5{%
  \ifnum\by@perl@=\z@
    \Rdef[#3](1,#4)\mm@B
%    \@ifundefined{@yscale}{}{%
%      \vecXY\mm@B\mm@Bx\mm@By
%      \Divself\mm@Bx\@xscale
%      \Divself\mm@By\@yscale
%      \edef\mm@B{(\mm@Bx,\mm@By)}%
%    }%
    \LandL{#1}{#2}{#3}\mm@B{#5}%
  \else
    \perlLandk{#1}{#2}{#3}{#4}{#5}%
  \fi
}%
\def\Landk@#1#2#3#4#5{%
    \Rdef*[#3](1,#4)\mm@B\LandL{#1}{#2}{#3}\mm@B{#5}%
}%
%
\def\abcandabc#1#2#3{%
  \vecXYZ{(#1)}\abc@ai\abc@bi\abc@ci
  \vecXYZ{(#2)}\abc@aii\abc@bii\abc@cii
  \perlteisuuretu{abc@ai=\abc@ai;abc@bi=\abc@bi;abc@ci=\abc@ci;%
    abc@aii=\abc@aii;abc@bii=\abc@bii;abc@cii=\abc@cii}%
  \Mulself\abc@ci{-1}%
  \Mulself\abc@cii{-1}%
  \sEqi{\abc@ai,\abc@bi,\abc@ci;\abc@aii,\abc@bii,\abc@cii}\tmp@\relax
  \Put@nil\tmp@ #3\@nil
}%
\def\Iabcandabc#1#2#3{%
  \strip@cmd{#3}\Iabc@ret
  \vecXYZ{(#1)}\abc@ai\abc@bi\abc@ci
  \vecXYZ{(#2)}\abc@aii\abc@bii\abc@cii
  \IMulself\abc@ci{-1}%
  \IMulself\abc@cii{-1}%
  \IsEqi{\abc@ai,\abc@bi,\abc@ci;\abc@aii,\abc@bii,\abc@cii}\Iabcabc@P\relax
  \vecXY\Iabcabc@P\Iabc@x\Iabc@y
  \expandafter\edef\csname\Iabc@ret x\endcsname{\Iabc@x}%
  \expandafter\edef\csname\Iabc@ret y\endcsname{\Iabc@y}%
  \FtoS\Iabc@x\Iabc@x@
  \FtoS\Iabc@y\Iabc@y@
  \edef#3{(\Iabc@x@,\Iabc@y@)}%
}%
%
% 点の定義
% \Pdef[#1](#2,#3)#4
%   #1 を始点として点(#2,#3)を#4に与える。
\def\Pdef{\@ifnextchar[{\@Pdefa}{\@Pdef}}%
\def\@Pdef(#1,#2)#3{\edef#3{(#1,#2)}}%
\def\@Pdefa[#1](#2,#3)#4{\Addvec{#1}{(#2,#3)}#4}%
%
% 極座標 → 直交座標
%   \Rdef(#1,#2)#3
%       極座標 (#1,#2) を直交座標に変換したものを #3 に代入する．
%           角 #2 の単位は六十分法（\Rdef* の場合は，ラジアン）
%
\edef\Rdef@rad{0}%
\def\Rdef{\edef\Rdef@rad{0}\@ifstar{\edef\Rdef@rad{1}\@Rdef}{\@Rdef}}%
\def\@Rdef{\@ifnextchar[{\Rdef@a}{\@@Rdef}}%
\def\Rdef@a[#1](#2,#3)#4{\@@Rdef(#2,#3)\Rdef@a@tmp\Addvec{#1}{\Rdef@a@tmp}#4}%
\def\@@Rdef(#1,#2)#3{%
%\typeout{@@Rdef:(#1,#2)}%\rrrr
  \ukansan{#1}\Rdef@r
  \ifnum\by@perl=\z@
    \ifnum\Rdef@rad>\z@
      \Cos{#2}\Rdef@x\Mul\Rdef@x{\Rdef@r}\Rdef@x%
      \Sin{#2}\Rdef@y\Mul\Rdef@y{\Rdef@r}\Rdef@y%
    \else
      \DegCos{#2}\Rdef@x\Mul\Rdef@x{\Rdef@r}\Rdef@x%
      \DegSin{#2}\Rdef@y\Mul\Rdef@y{\Rdef@r}\Rdef@y%
    \fi
  \else
    \ifnum\Rdef@rad>\z@
      \calcval[s]{(\Rdef@r)*cos(#2)}\Rdef@x
      \calcval[s]{(\Rdef@r)*sin(#2)}\Rdef@y
    \else
      \calcval[s]{(\Rdef@r)*Degcos(#2)}\Rdef@x
      \calcval[s]{(\Rdef@r)*Degsin(#2)}\Rdef@y
    \fi
  \fi
  \@ifundefined{xy@hosei}{}{%
    \@ifundefined{@xscale}{}{\Divself\Rdef@x\@xscale}%
    \@ifundefined{@yscale}{}{\Divself\Rdef@y\@yscale}%
  }%
  \edef#3{(\Rdef@x,\Rdef@y)}}%
%
\def\xyhosei#1{\vecXY{#1}\xyh@x\xyh@y
  \Divself\xyh@x\@xscale
  \Divself\xyh@y\@yscale
  \edef#1{(\xyh@x,\xyh@y)}}%
%
\def\perlRdef{\edef\Rdef@rad{0}%
  \@ifstar{\edef\Rdef@rad{1}\@perlRdef}{\@perlRdef}}%
\def\@perlRdef{\@ifnextchar[{\perlRdef@a}{\@@perlRdef}}%
\def\perlRdef@a[#1](#2,#3)#4{\@@perlRdef(#2,#3)\Rdef@a@tmp
  \perlAddvec{#1}{\Rdef@a@tmp}#4}%
\def\@@perlRdef(#1,#2)#3{%
%\typeout{@@perlRdef:(#1,#2)}\rrrr
    \ifnum\Rdef@rad>\z@
      \retu@calcval[s]{(#1)*cos(#2)}\Rdef@x
      \retu@calcval[s]{(#1)*sin(#2)}\Rdef@y
    \else
      \retu@calcval[s]{(#1)*Degcos(#2)}\Rdef@x
      \retu@calcval[s]{(#1)*Degsin(#2)}\Rdef@y
    \fi
  \edef#3{(\Rdef@x,\Rdef@y)}}%
%
% 定義に引き続き，\Put につなげる。
\def\PPut{\@ifnextchar[{\@PPut@}{\@PPut}}%
\def\@PPut(#1,#2)#3{\Pdef(#1,#2)#3\emathPut#3}%
\def\@PPut@[#1](#2,#3)#4{\Pdef[#1](#2,#3)#4\emathPut#4}%
\def\RPut{\@ifnextchar[{\@RPut@}{\@RPut}}%
\def\@RPut(#1,#2)#3{\Rdef(#1,#2)#3\emathPut#3}%
\def\@RPut@[#1](#2,#3)#4{\Rdef[#1](#2,#3)#4\Kuromaru{#4}\emathPut#4}%
\def\DivPut#1#2#3#4#5{\@Bunten{#1}{#2}{#3}{#4}#5\emathPut#5}%
\def\PerpPut#1#2#3#4{\Suisen{#1}{#2}{#3}#4\emathPut#4}%
%
% 円と円の交点を求める．
% \CandC#1#2#3#4#5#6
%   点 #1 を中心，半径 #2 の円と
%   点 #3 を中心，半径 #4 の円との交点を #5 と #6 にセット
%
\def\CandC{\def\CandC@sign{0}\@ifstar{\CandC@}{\@CandC}}%
\def\CandC@{\def\CandC@sign{1}\@CandC}%
\def\@CandC#1#2#3#4#5#6{%
  \isnumber{#2}{\edef\ri@val{#2}}{\fpcalcval{#2}\ri@val}%
  \isnumber{#4}{\edef\rii@val{#4}}{\fpcalcval{#4}\rii@val}%
  \Kyori{#1}{#3}\@c
\ifdim\@c\p@=\z@
  \edef\CC@Pi{#1}\edef\CC@Pii{#3}%
\else\ifdim \ri@val\p@=\z@
  \edef\CC@Pi{#1}\edef\CC@Pii{#3}%
\else\ifdim \rii@val\p@=\z@
  \edef\CC@Pi{#1}\edef\CC@Pii{#3}%
\else
 \ifnum\by@perl@=\z@
  \Subvec{#3}{#1}\@@AB\Yogen{\rii@val}{\ri@val}{\@c}\@A%
  \acos\@A\@A
  \Rotvec[\ri@val]\@@AB\@A\@AB
  \Addvec{#1}\@AB\@AB
  \Mul{-1}\@A\@A%
  \Rotvec[\ri@val]\@@AB\@A\@AB@
  \Addvec{#1}\@AB@\@AB@
%
  \ifnum\CandC@sign>\z@
    \trisign{#1}\@AB\@AB@\CandC@s
    \ifnum\CandC@s>\z@
      \edef\CC@Pi{\@AB}\edef\CC@Pii{\@AB@}%
    \else\ifnum\CandC@s<\z@
      \edef\CC@Pi{\@AB@}\edef\CC@Pii{\@AB}%
    \else
      \edef\CandC@sign{\z@}%
    \fi\fi
  \fi
  \ifnum\CandC@sign=\z@
    \vecXY\@AB\@ABx\@ABy
    \vecXY\@AB@\@AB@x\@AB@y
    \Sub\@ABx\@AB@x\@d\Abs\@d\@d
    \ifdim\@d pt<0.005pt\relax%
      \ifdim \@ABy pt<\@AB@y pt\relax
        \edef\CC@Pi{\@AB}\edef\CC@Pii{\@AB@}%
      \else
        \edef\CC@Pii{\@AB}\edef\CC@Pi{\@AB@}%
      \fi%
    \else
      \ifdim \@ABx pt<\@AB@x pt\relax
        \edef\CC@Pi{\@AB}\edef\CC@Pii{\@AB@}%
      \else%
        \edef\CC@Pii{\@AB}\edef\CC@Pi{\@AB@}%
      \fi%
    \fi
  \fi
  \ifx\empty #5\else\Put@nil\CC@Pi #5\@nil\fi
  \ifx\empty #6\else\Put@nil\CC@Pii #6\@nil\fi
 \else
  \perlCandC{#1}{#2}{#3}{#4}{#5}{#6}%
 \fi
\fi\fi\fi
}%
%
% 円と直線の交点
% \CandL#1#2#3#4#5#6
%   点 #1 を中心とし，半径 #2 の円と
%   2点 #3, #4 を通る直線との交点を #5 と #6 にセットする．
  \def\CandL{\def\CandL@sign{0}\@ifstar{\CandL@}{\@CandL}}%
  \def\CandL@{\def\CandL@sign{1}\@CandL}%
  \def\@CandL#1#2#3#4#5#6{%
    \Subvec{#3}{#4}\CandL@tmp%
    \Unitvec\CandL@tmp\CandL@e%
    \Suisen{#1}{#3}{#4}\CandL@H%
    \Kyori{#1}\CandL@H\CandL@h%
    \@Div\CandL@h{#2}\CandL@tmp
    \Mulself\CandL@tmp\CandL@tmp
    \Sub{1}\CandL@tmp\CandL@l
%    \Mul{#2}{#2}\CandL@l%
%    \Mul\CandL@h\CandL@h\CandL@tmp%
%    \Sub\CandL@l\CandL@tmp\CandL@l%
    \Heihoukon\CandL@l\CandL@l%
    \Mulself\CandL@l{#2}%
    \Mulvec\CandL@l\CandL@e\CandL@e%
      \Addvec\CandL@H\CandL@e\CandL@a
      \Subvec\CandL@H\CandL@e\CandL@b
    \ifnum\CandL@sign>\z@
      \trisign{#1}\CandL@a\CandL@b\CandC@s
      \ifnum\CandC@s>\z@
        \edef\CL@i{\CandL@a}\edef\CL@ii{\CandL@b}%
      \else\ifnum\CandC@s<\z@
        \edef\CL@i{\CandL@b}\edef\CL@ii{\CandL@a}%
      \else
        \edef\CandL@sign{\z@}%
      \fi\fi
      \ifx\empty #5\else\Put@nil\CL@i #5\@nil\fi
      \ifx\empty #6\else\Put@nil\CL@ii #6\@nil\fi
    \fi
    \ifnum\CandL@sign=\z@
      \vecXY\CandL@e\CandL@ex\CandL@ey%
      \ifdim\CandL@ex\p@<-0.005\p@
        \edef\CL@i{\CandL@a}\edef\CL@ii{\CandL@b}%
      \else\ifdim\CandL@ex\p@>0.005\p@
        \edef\CL@i{\CandL@b}\edef\CL@ii{\CandL@a}%
      \else
        \ifdim\CandL@ey\p@<-0.005\p@
          \edef\CL@i{\CandL@a}\edef\CL@ii{\CandL@b}%
        \else
          \edef\CL@i{\CandL@b}\edef\CL@ii{\CandL@a}%
        \fi
      \fi\fi
      \ifx\empty #5\else\Put@nil\CL@i #5\@nil\fi
      \ifx\empty #6\else\Put@nil\CL@ii #6\@nil\fi
    \fi
\ignorespaces}%
%
\def\Candl{\@ifstar{\Candl@}{\@Candl}}%
\def\@Candl#1#2#3#4#5#6{\Addvec{#3}{#4}\Candl@v%
  \CandL{#1}{#2}{#3}\Candl@v{#5}{#6}\ignorespaces}%
\def\Candl@#1#2#3#4#5#6{\Addvec{#3}{#4}\Candl@v%
  \CandL*{#1}{#2}{#3}\Candl@v{#5}{#6}\ignorespaces}%
%
\def\Candnl{\@ifstar{\Candnl@}{\@Candnl}}%
\def\@Candnl#1#2#3#4#5#6{%
  \perpvec{#4}\Candnl@tmp
  \Addvec{#3}\Candnl@tmp\Candnl@v%
  \CandL{#1}{#2}{#3}\Candnl@v{#5}{#6}\ignorespaces}%
\def\Candnl@#1#2#3#4#5#6{%
  \perpvec{#4}\Candnl@tmp
  \Addvec{#3}\Candnl@tmp\Candnl@v%
  \CandL*{#1}{#2}{#3}\Candnl@v{#5}{#6}\ignorespaces}%
%
\def\Candg{\@ifstar{\Candg@}{\@Candg}}%
\def\@Candg#1#2#3#4#5#6{\Addvec{#3}{(1,#4)}\Candg@v%
  \CandL{#1}{#2}{#3}\Candg@v{#5}{#6}\ignorespaces}%
\def\Candg@#1#2#3#4#5#6{\Addvec{#3}{(1,#4)}\Candg@v%
  \CandL*{#1}{#2}{#3}\Candg@v{#5}{#6}\ignorespaces}%
%
\def\Candng{\@ifstar{\Candng@}{\@Candng}}%
\def\@Candng#1#2#3#4#5#6{\Addvec{#3}{(#4,-1)}\Candng@v%
  \CandL{#1}{#2}{#3}\Candng@v{#5}{#6}\ignorespaces}%
\def\Candng@#1#2#3#4#5#6{\Addvec{#3}{(#4,-1)}\Candng@v%
  \CandL*{#1}{#2}{#3}\Candng@v{#5}{#6}\ignorespaces}%
%
\def\Candk{\@ifstar{\Candk@}{\@Candk}}%
\def\@Candk#1#2#3#4#5#6{\Rdef[#3](1,#4)\Candk@p
  \CandL{#1}{#2}{#3}\Candk@p{#5}{#6}\ignorespaces}%
\def\Candk@#1#2#3#4#5#6{\Rdef[#3](1,#4)\Candk@p
  \CandL*{#1}{#2}{#3}\Candk@p{#5}{#6}\ignorespaces}%
%
\def\Candabc{\def\CandL@sign{0}\@ifstar{\CandL@}{\@Candabc}}%
\def\Candabc@{\def\CandL@sign{1}\@Candabc}%
\def\@Candabc#1#2#3{%
  \vecXYZ{(#3)}\a@val\b@val\c@val
  \Abs{\b@val}\tmp@
  \ifthenelse{\lengthtest{\tmp@\p@<\emLlim\p@}}{%
    \@Div\c@val\a@val\x@val
    \Mulself\x@val{-1}%
    \ifthenelse{\CandL@sign>\z@}{\Candl*{#1}{#2}{(\x@val,0)}\YMAX}{%
      \Candl{#1}{#2}{(\x@val,0)}\YMAX
    }%
  }{%
    \@Div\c@val\b@val\y@val
    \Mulself\y@val{-1}%
    \Mulself\a@val{-1}%
    \ifthenelse{\CandL@sign>\z@}{%
      \Candl*{#1}{#2}{(0,\y@val)}{(\b@val,\a@val)}%
    }{%
      \Candl{#1}{#2}{(0,\y@val)}{(\b@val,\a@val)}%
    }
  }%
}%
%
% 楕円上の点
%
\def\ETen{\@ifnextchar<{\@ETen}{\@ETen<\empty>}}%
\def\@ETen<#1>#2#3#4#5#6{\begingroup
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
  \ifnum\by@perl>\z@
    \vecXY{#2}\ETen@@x\ETen@@y
    \ifnum\Rdef@rad>\z@
      \CalcVal{%
        printf FHNDL "(\EMpercentchar s,\EMpercentchar s)\string\n",
            #3*cos(#5)+(\ETen@@x),#4*sin(#5)+(\ETen@@y);
      }\ETen@ans
    \else
      \CalcVal{%
        printf FHNDL "(\EMpercentchar s,\EMpercentchar s)\string\n",
            #3*Degcos(#5)+(\ETen@@x),#4*Degsin(#5)+(\ETen@@y);
      }\ETen@ans
    \fi
  \else
    \ifnum\Rdef@rad>\z@
      \Cos{#5}\ETen@tmp\Mul\ETen@tmp{#3}\ETen@x
      \Sin{#5}\ETen@tmp\Mul\ETen@tmp{#4}\ETen@y
      \Addvec{#2}{(\ETen@x,\ETen@y)}\ETen@ans\relax
    \else
      \DegCos{#5}\ETen@tmp\Mul\ETen@tmp{#3}\ETen@x
      \DegSin{#5}\ETen@tmp\Mul\ETen@tmp{#4}\ETen@y
      \Addvec{#2}{(\ETen@x,\ETen@y)}\ETen@ans\relax
    \fi
  \fi
  \edef\temp@x{\def\noexpand\Eten@P{\ETen@ans}}%
  \expandafter\endgroup\temp@x
  \Put@nil\Eten@P #6\@nil
}%
\let\EPoint\ETen
%
% 楕円：x座標を指定してy座標を求める
%
\def\Eyval{\@ifnextchar<{\@Eyval}{\@Eyval<\empty>}}%
\def\@Eyval<#1>#2#3#4#5#6#7{%
%  #2: 中心
%  #3: x軸方向半径
%  #4: y軸方向半径
%  #5: x座標
%  #6: y座標1（小）
%  #7: y座標2（大）
  \edef\YG@xval{\empty}%
  \ifx\empty #1\else\setkeys{emGurafu}{#1}\fi
  \vecXY{#2}\Eyval@x\Eyval@y
  \CalcVals{%
$a=#3;
$b=#4;
$xi=\Eyval@x;
$yi=\Eyval@y;
$x=#5;
$tmp=abs($b*sin(acos(($x-$xi)/$a)));
printf FHNDL "\EMpercentchar s \string\n",$x;
printf FHNDL "\EMpercentchar s,\EMpercentchar s \string\n",$yi-$tmp,$yi+$tmp;
  }{Eyval@h}%
  \vecXY{(\Eyval@hii)}#6#7\relax
  \ifx\empty\YG@xval\else
    \expandafter\edef\csname\YG@xval\endcsname{\Eyval@hi}%
  \fi
}%
%
\def\Eypoints{\@ifnextchar<{\@Eypoints}{\@Eypoints<\empty>}}%
\def\@Eypoints<#1>#2#3#4#5#6#7{%
%\typeout{@Eypoints:<#1>{#2}{#3}{#4}{#5}}%
  \Eyval<#1>{#2}{#3}{#4}{#5}\Eyp@i\Eyp@ii
%  \edef#6{(#5,\Eyp@i)}%
%  \edef#7{(#5,\Eyp@ii)}%
  \ifx\empty #6\else\edef\tmp@{(#5,\Eyp@i)}\Put@nil\tmp@ #6\@nil\fi
  \ifx\empty #7\else\edef\tmp@{(#5,\Eyp@ii)}\Put@nil\tmp@ #7\@nil\fi
}%
\let\Eypoint\Eypoints
%
% 楕円：y座標を指定してx座標を求める
%
\def\Exval{\@ifnextchar<{\@Exval}{\@Exval<\empty>}}%
\def\@Exval<#1>#2#3#4#5#6#7{%
%  #2: 中心
%  #3: x軸方向半径
%  #4: y軸方向半径
%  #5: y座標
%  #6: x座標1（小）
%  #7: x座標2（大）
  \edef\YG@yval{\empty}%
  \ifx\empty #1\else\setkeys{emGurafu}{#1}\fi
  \vecXY{#2}\Exval@x\Exval@y
  \CalcVals{%
$a=#3;
$b=#4;
$xi=\Exval@x;
$yi=\Exval@y;
$y=#5;
$tmp=$a*cos(asin(($y-$yi)/$b));
printf FHNDL "\EMpercentchar s \string\n",$y;
printf FHNDL "\EMpercentchar s,\EMpercentchar s \string\n",$xi-$tmp,$xi+$tmp;
  }{Exval@h}%
  \vecXY{(\Exval@hii)}#6#7\relax
  \ifx\empty\YG@yval\else
    \expandafter\edef\csname\YG@yval\endcsname{\Exval@hi}%
  \fi
}%
%
\def\Expoints{\@ifnextchar<{\@Expoints}{\@Expoints<\empty>}}%
\def\@Expoints<#1>#2#3#4#5#6#7{%
  \Exval<#1>{#2}{#3}{#4}{#5}\Exp@i\Exp@ii
%  \edef#6{(\Exp@i,#5)}%
%  \edef#7{(\Exp@ii,#5)}%
  \ifx\empty #6\else\edef\tmp@{(\Exp@i,#5)}\Put@nil\tmp@ #6\@nil\fi
  \ifx\empty #7\else\edef\tmp@{(\Exp@ii,#5)}\Put@nil\tmp@ #7\@nil\fi
}%
\let\Expoint\Expoints
%
% 楕円の周上の点を指定して
%   媒介変数表示θの値を求める。
%
\def\Earg{\@ifstar{\edef\Earg@R{1}\@Earg}{\edef\Earg@R{0}\@Earg}}%
\def\@Earg#1#2#3#4#5{%
% #1 : 楕円の中心
% #2 : x軸方向の半径
% #3 : y軸方向の半径
% #4 : 周上の点
% #5 : 媒介変数の値（六十分法）を受け取る制御綴
%    Earg* の場合はラジアンを返す。
%
  \@Div{#3}{#2}\EandL@hi
  \Subvec{#4}{#1}\EandL@tmp
   \vecXY\EandL@tmp\EandL@x\EandL@y\@Div\EandL@y\EandL@hi\EandL@y
    \edef\EandL@T{(\EandL@x,\EandL@y)}%
  \ifnum\Earg@R>\z@
    \Argvec*\EandL@T#5\relax
  \else
    \Argvec\EandL@T#5\relax
  \fi
}%
%
% 楕円と直線の交点
%
\def\EandL#1#2#3#4#5#6#7{%
% #1 : 楕円の中心
% #2 : x軸方向の半径
% #3 : y軸方向の半径
% #4 : 直線上の点1
% #5 : 直線上の点2
% #6 : 交点1
% #7 : 交点2
  \@Div{#3}{#2}\EandL@hi
  \Subvec{#4}{#1}\EandL@tmp
    \vecXY\EandL@tmp\EandL@x\EandL@y\@Div\EandL@y\EandL@hi\EandL@y
    \edef\EandL@Pi{(\EandL@x,\EandL@y)}%
  \Subvec{#5}{#1}\EandL@tmp
    \vecXY\EandL@tmp\EandL@x\EandL@y\@Div\EandL@y\EandL@hi\EandL@y
    \edef\EandL@Pii{(\EandL@x,\EandL@y)}%
  \CandL{(0,0)}{#2}\EandL@Pi\EandL@Pii\EandL@P\EandL@Q
  \vecXY\EandL@P\EandL@x\EandL@y\Mul\EandL@y\EandL@hi\EandL@y
    \edef\EandL@P{(\EandL@x,\EandL@y)}\Addvec\EandL@P{#1}{#6}\relax
  \vecXY\EandL@Q\EandL@x\EandL@y\Mul\EandL@y\EandL@hi\EandL@y
    \edef\EandL@Q{(\EandL@x,\EandL@y)}\Addvec\EandL@Q{#1}{#7}\relax
}%
%
\def\Eandl#1#2#3#4#5#6#7{%
% #5 : 直線の方向ベクトル
  \Addvec{#4}{#5}\Eandl@P
  \EandL{#1}{#2}{#3}{#4}\Eandl@P{#6}{#7}}%
\def\Eandk#1#2#3#4#5#6#7{%
% #5 : 直線の方向角（六十分法）
  \isnumber{#5}{\edef\Eandk@arg{#5}}{\fpcalcval{#5}\Eandk@arg}%
  \DegCos{\Eandk@arg}\Eandk@x
  \DegSin{\Eandk@arg}\Eandk@y
  \Addvec{#4}{(\Eandk@x,\Eandk@y)}\Eandl@P
  \EandL{#1}{#2}{#3}{#4}\Eandl@P{#6}{#7}}%
\def\Eandg#1#2#3#4#5#6#7{%
% #5 : 直線の傾き
  \isnumber{#5}{\edef\Eandg@v{#5}}{\fpcalcval{#5}\Eandg@v}%
  \Addvec{#4}{(1,\Eandg@v)}\Eandg@P
  \EandL{#1}{#2}{#3}{#4}\Eandg@P{#6}{#7}}%
\def\Eandn#1#2#3#4#5#6#7{%
% #5 : 法線ベクトル
  \Rotvec{#5}{90}\Eandn@a
  \Eandl{#1}{#2}{#3}{#4}\Eandn@a{#6}{#7}}%
\def\Eandng#1#2#3#4#5#6#7{%
% #5 : 法線の傾き
  \Addvec{#4}{(#5,-1)}\Eandng@P
  \EandL{#1}{#2}{#3}{#4}\Eandng@P{#6}{#7}}%
%
% 
%
\def\HTen{\@ifnextchar<{\@HTen}{\@HTen<\empty>}}%
\def\@HTen<#1>#2#3#4#5#6{\begingroup
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
    \vecXY{#2}\HTen@@x\HTen@@y
    \ifnum\Rdef@rad>\z@
      \CalcVal{%
        printf FHNDL "(\EMpercentchar s,\EMpercentchar s)\string\n",
            #3/cos(#5)+(\HTen@@x),#4*tan(#5)+(\HTen@@y);
      }\HTen@ans
    \else
      \CalcVal{%
        printf FHNDL "(\EMpercentchar s,\EMpercentchar s)\string\n",
            #3/cos(#5*$pi/180)+(\HTen@@x),#4*tan(#5*$pi/180)+(\HTen@@y);
      }\HTen@ans
    \fi
  \edef\temp@x{\def\noexpand\Eten@P{\HTen@ans}}%
  \expandafter\endgroup\temp@x
  \Put@nil\Eten@P #6\@nil
}%
\let\HPoint\HTen
%
% 二次関数のグラフと直線との交点
%
\def\xQandL#1#2#3#4#5{%
%  #1: 二次関数の係数列
%  #2,#3: 二点
%  #4,#5: 交点のx座標 (cf. \Eqii)
%
  \vecXYZ{(#1)}\QL@a\QL@b\QL@c
  \vecXY{#2}\QL@xi\QL@yi
  \vecXY{#3}\QL@xii\QL@yii
  \Sub\QL@yii\QL@yi\QL@y
  \Sub\QL@xii\QL@xi\QL@x
  \@Div\QL@y\QL@x\QL@bb
  \Mul\QL@bb\QL@xi\QL@tmp
  \Sub\QL@yi\QL@tmp\QL@cc
  \Subself\QL@b\QL@bb
  \Subself\QL@c\QL@cc
  \perlEqii\QL@a\QL@b\QL@c#4#5\relax
}%
\def\xQandl#1#2#3#4#5{%
  \Addvec{#2}{#3}\QL@v
  \xQandL{#1}{#2}{\QL@v}#4#5\relax
}%
\def\xQandk#1#2#3#4#5{%
  \Rdef[#2](1,#3)\QL@B
  \xQandL{#1}{#2}\QL@B#4#5\relax
}%
%
%\def\xQandLcsv#1#2#3#4{%
%  #1: 二次関数の係数列
%  #2: 一次関数の係数列
%  #3,#4: 交点のx座標 (cf. \Eqii)
%  \vecXYZ{(#1)}\QL@a\QL@b\QL@c
%  \vecXY{(#2)}\QL@m\QL@n
%  \perlEqii{\QL@a}{(\QL@b)-(\QL@m)}{(\QL@c)-(\QL@n)}#3#4\relax
%}%
%
%%
%\def\QandQ{\@ifnextchar<{\@QandQ}{\@QandQ<\empty>}}%
%\def\@QandQ<#1>#2#3#4{%
%% #2: 係数列1
%% #3: 係数列2
%% #4: 交点を格納する配列基幹名
%%
%  \edef\YG@xval{x}%
%  \ifx\empty #1\else\setkeys{emGurafu}{#1}\fi
%  \edef\QQ@xval{\YG@xval}%
%  \defcsvfunc\Q@f{#2}%
%  \Qeq{#2}{#3}{Q@x}%
%  \edef\x@i{\hairetu{Q@x}{1}}%
%  \YPoint\Q@f{\x@i}\Q@P
%  \edefhairetu{#4}{1}{\Q@P}%
%  \expandafter\edef\csname\QQ@xval i\endcsname{\x@i}%
%  \ifnum\csname Q@xN\endcsname=2\relax
%  \edef\x@i{\hairetu{Q@x}{1}}%
%    \edef\x@ii{\hairetu{Q@x}{2}}%
%    \YPoint\Q@f{\x@ii}\Q@P
%    \edefhairetu{#4}{2}{\Q@P}%
%    \expandafter\edef\csname\QQ@xval ii\endcsname{\x@ii}%
%  \fi
%}%
%
% 近似的に0であるかどうかの判定
\def\IFnearlyzero{\@ifnextchar[{\@ifnearlyzero}{\@ifnearlyzero[\emLlim]}}%
\def\@ifnearlyzero[#1]#2#3#4{%
  \Abs{#2}\nearlyzero@tmp\ifthenelse{%
  \lengthtest{\nearlyzero@tmp pt<#1pt}}{#3}{#4}}%
%
% 近似的に等しいかどうかの判定
% \IFnearlyequal[#1]#2#3#4#5
%   #2≒#3 であれば，#4 を実行し，そうでないときは #5 を実行する。
%   判定は |#2-#3|<#1(デフォルト値 0.005）による。
%
\def\IFnearlyequal{\@ifnextchar[{\@ifnearlyequal}{\@ifnearlyequal[\emLlim]}}%
\def\@ifnearlyequal[#1]#2#3#4#5{\Sub{#2}{#3}\nearlyequal@tmp
  \Abs{\nearlyequal@tmp}\nearlyequal@tmp\ifthenelse{%
  \lengthtest{\nearlyequal@tmp pt<#1pt}}{#4}{#5}}%
%
% 2点間の距離
% \Kyori#1#2#3
%   2点 #1, #2 の距離を #3 に代入
%
%\def\Kyori#1#2#3{\ifx#1#2\edef#3{0.}\else\edef\Kyori@AB{#1#2}%
%  \expandafter\Distance\Kyori@AB\Kyori@AB\edef#3{\Kyori@AB}\fi}%
%\def\Kyori#1#2#3{\Subvec{#2}{#1}\Kyori@v\vecXY\Kyori@v\Kyori@xi\Kyori@yi
%  \Mul\Kyori@xi\Kyori@xi\Kyori@xi\Mul\Kyori@yi\Kyori@yi\Kyori@yi
%  \Add\Kyori@xi\Kyori@yi\Kyori@xi\Heihoukon\Kyori@xi#3}%
\def\Kyori#1#2#3{\Subvec{#2}{#1}\Kyori@AB\Absvec\Kyori@AB#3}%
%
% 距離の平方
\def\Kyorii#1#2#3{\Subvec{#2}{#1}\Kyorii@v\vecXY\Kyorii@v\Kyorii@xi\Kyorii@yi
  \Mul\Kyorii@xi\Kyorii@xi\Kyorii@xi\Mul\Kyorii@yi\Kyorii@yi\Kyorii@yi
  \Add\Kyorii@xi\Kyorii@yi#3}%
%
% |x1-x2|+|y1-y2|
\def\zKyori#1#2#3{\Subvec{#2}{#1}\zKyori@v\vecXY\zKyori@v\zKyori@xi\zKyori@yi
  \Abs\zKyori@xi\zKyori@xi\Abs\zKyori@yi\zKyori@yi
  \Add\zKyori@xi\zKyori@yi#3}%
%
%
% 回転
%   \Rotdef[#1]<#2>#3#4#5#6
%     点 #3 を中心として
%       点 #4 を #5 度回転した点を #6 に与える．
%     #1 : 長さ指定
%     #2 : 長さの倍率指定
%
\def\Rotdef{\@ifstar{\rotdef}{\@R@tdef}}%
\def\@R@tdef{\@ifnextchar[{\@Rotdef}{\@Rotdef[\empty]}}%
\def\@Rotdef[#1]{\@ifnextchar<{\@@Rotdef[#1]}{\@@Rotdef[#1]<\empty>}}%
\def\@@Rotdef[#1]<#2>#3#4#5#6{%
  \Subvec{#4}{#3}\kaiten@v%
  \Rotvec[#1]<#2>\kaiten@v{#5}\kaiten@v\Addvec{#3}\kaiten@v\kaiten@v%
  \Put@nil\kaiten@v #6\@nil
}%
%  \edef#6{\kaiten@v}}%
%
% #4 が点列の場合
%
\def\rotdef{\@ifnextchar[{\@rotdef}{\@rotdef[\empty]}}%
\def\@rotdef[#1]{\@ifnextchar<{\@@rotdef[#1]}{\@@rotdef[#1]<\empty>}}%
\def\@@rotdef[#1]<#2>#3#4#5#6{\edef#6{}%
  \def\@@@rotdef{\@ifnextchar({\@@@rotdef@}{\relax}}%
  \def\@@@rotdef@(##1,##2){%
    \Subvec{(##1,##2)}{#3}\kaiten@v%
    \Rotvec[#1]<#2>\kaiten@v{#5}\kaiten@v\Addvec{#3}\kaiten@v\kaiten@v%
    \edefappend#6{\kaiten@v}%
    \@@@rotdef
  }%
  \ifx\empty #4\relax\else\expandafter\@@@rotdef#4\relax\fi
}%
%
% 引き続き \Put
\def\RotPut{\@ifnextchar[{\@RotPut}{\RotPut[\empty]}}%
\def\@RotPut[#1]{\@ifnextchar<{\@@RotPut[#1]}{\@RotPut[#1]<\empty>}}%
\def\@@RotPut[#1]<#2>#3#4#5#6{\Subvec{#4}{#3}\RotPut@v%
  \Rotvec[#1]<#2>\RotPut@v{#5}\RotPut@v\Addvec{#3}\RotPut@v#6\emathPut{#6}}%
%
% 伸縮
% \def\Muldef[#1]<#2>#3#4#5
%   #3 を中心として #4 を伸縮した点を #5 に与える．
%   オプション #1 に長さを与えたときはその長さにするものとする．
%   オプション #2 が指定されたときは長さを #2 倍する．
\def\Muldef{\@ifnextchar[{\@Muldef}{\@Muldef[\empty]}}%
\def\@Muldef[#1]{\@ifnextchar<{\@@Muldef[#1]}{\@@Muldef[#1]<\empty>}}%
\def\@@Muldef[#1]<#2>#3#4#5{%
  \Subvec{#4}{#3}\Muldef@v
  \ifx\empty#1\relax
    \ifx\empty#2\edef#5{#4}\else\Mulvec{#2}\Muldef@v\Muldef@v
      \Addvec{#3}\Muldef@v#5\fi
  \else
    \Absvec\Muldef@v\Muldef@l\@Div{#1}\Muldef@l\Muldef@l
    \Mulvec\Muldef@l\Muldef@v\Muldef@v
    \Addvec{#3}\Muldef@v#5\fi}%
%
\def\MulPut{\@ifnextchar[{\@MulPut}{\@MulPut[\empty]}}%
\def\@MulPut[#1]{\@ifnextchar<{\@@MulPut[#1]}{\@@MulPut[#1]<\empty>}}%
\def\@@MulPut[#1]<#2>#3#4#5{%
  \Subvec{#4}{#3}\MulPut@v
  \ifx\empty#1\relax
    \ifx\empty#2\edef#5{#4}\else\Mulvec{#2}\MulPut@v\MulPut@v
      \Addvec{#3}\MulPut@v#5\fi
  \else
    \Absvec\MulPut@v\MulPut@l\@Div{#1}\MulPut@l\MulPut@l
    \Mulvec\MulPut@l\MulPut@v\MulPut@v
    \Addvec{#3}\MulPut@v#5\fi
  \emathPut#5}%
%
% 数直線描画
%   \suutyokusen<#0>[#1](#2)#3#4
%       #1 : [+] としたときは正の目盛には + をつける．
%       #2 : 目盛の刻み値（デフォルトは 1）
%       #3 : x の下限
%       #4 : x の上限
%   描画位置は \put 文で数直線の原点位置を指定する．
%
\newdimen\@tmpla%
\def\suutyokusen{\@ifnextchar<{\suu@tyokusen}{\@suutyokusen}}%
\def\suu@tyokusen<#1>{\setkeys{emP}{#1}\@suutyokusen}%
\def\@suutyokusen{\@ifnextchar[{\@@suutyokusen}{\@@suutyokusen[\empty]}}%
\def\@@suutyokusen[#1]{\@ifnextchar({\@@@suutyokusen[#1]}{%
    \@@@suutyokusen[#1](1)}}%
\def\@@@suutyokusen[#1](#2)#3#4{{%
    \scriptsize%                                文字サイズ
    \def\@xi{0}\edef\@orgx{#3}\edef\@endx{#4}%
    \Sub\@endx\@orgx\@wdx\Add\@wdx{1}\@wdxx%
    \Add\@orgx{-0.5}\@orgxx\Add\@endx{0.5}\@endxx%
    \begin{picture}(\@wdxx,1)%
    \Put{(\@endxx,0)}[e]{\yokozikukigou}%        軸名称
    \For\@xi{\@orgx}{\@endxx}{#2}\Do{%
        \setlength{\@tmpla}{\@xi pt}%
        {\thinlines\drawline(\@xi,.1)(\@xi,-.1)}%               目盛縦線
        \put(\@xi,-.4){\makebox(0,0){%
        \ifx +#1\ifdim\@tmpla>\z@$+$\fi\fi%
        $\strip@pt\@tmpla$}}}%
      \put(\@orgxx,0){\zikusensyu(0,0)(\@wdxx,0)}%
    \end{picture}}}%
%
% 不等式の解を数直線上に表示
%
%\KTkukan[#1]#2#3
%    #1 : 各区間のラベル指定オプション
%    #2 : 各区間を`;'区切りで並べる
%    #3 : 結果の区間
%
%    区間は
%        開区間   : (-3,5)
%        閉区間   : [-3,5]
%        半開区間 : (-3,5], [-3,5)
%        無限区間 : (,-3), (5,)
%      などと表す。
%      2つの区間の和集合は (,-3)|(5,) などのように，`|'を用いる
%    ラベル指定オプションは，
%        デフォルトは [auto] で，\maru1, \maru2, .....が付与される。
%        各不等式に \label がついているときは，ラベル名を`;'区切りで並べる。
%        [] と指定すれば，区間にラベルはつかない。
%        下の \kukantakasa を用いて，自由に配置してもよい。
%    区間を表す横罫線の y座標は \kukantakasa で，そのデフォルト値は 0.5
%    　　層を重ねるときは，その 2, 3, ... 倍となる。
%
\edef\kukantakasa{.5}%
\def\KTkukanTatiage#1{\Strsep{#1}{,}\KTo@ang\KTc@ang
  \Sub{180}\KTo@ang\KTo@ang@\Sub{180}\KTc@ang\KTc@ang@}%
\KTkukanTatiage{72,90}%
\def\KTpaintoption#1{\edef\KT@paintoption{#1}}%
\KTpaintoption{*}%
%
\define@key{KTkukan}{iro}{\edef\KTans@iro@{#1}}%
\define@key{KTkukan}{color}{\edef\KTans@iro@{#1}}%
\define@key{KTkukan}{paintcolor}{\edef\KTans@iro@{#1}}%
\define@key{KTkukan}{paintoption}{\edef\KT@paintoption{#1}}%
\define@key{KTkukan}{linethickness}{\KT@linethickness{#1}}%
\define@key{KTkukan}{kukantakasa}{\ukansan{#1}\kukantakasa}%
\define@key{KTkukan}{takasa}{\ukansan{#1}\kukantakasa}%
\define@key{KTkukan}{height}{\ukansan{#1}\kukantakasa}%
\define@key{KTkukan}{drawXaxis}{\ifnum #1=\z@\let\KTdrawXaxis\relax\fi}%
\define@key{KTkukan}{auto}[0]{%
  \edef\KT@auto{1}%
  \ifthenelse{\equal{#1}{*}}{}{\setcounter{enumKT}{#1}}%
}%
%
\newcounter{enumKT}%
%
\def\KTkukan{%
  \@ifundefined{@xscale}{}{%
%\typeout{xscale=\@xscale, yscale=\@yscale}%
    \ifthenelse{\not\equal{\@xscale}{1}}%
      {\errmessage{KTkukan: cannot use xscale.}{}}%
    \ifthenelse{\not\equal{\@yscale}{1}}%
      {\errmessage{KTkukan: cannot use yscale.}{}}%
  }%
  \@ifstar{\def\KT@lblsyu{1}\@KTkukan}{\def\KT@lblsyu{0}\@KTkukan}}%
\def\@KTkukan{%
  \@ifnextchar[{\@@KTkukan}{\@@KTkukan[auto]}}%
\def\@@KTkukan[#1]#2{%
  \@ifnextchar[{\@@@KTkukan[#1]{#2}}{\@@@KTkukan[#1]{#2}[\empty]}}%
\def\@@@KTkukan[#1]#2[#3]#4{\begingroup
%  \def\xy@hosei{}%
%
  \def\KTkukan@sub##1{%
    \Cfor{\edef\@kukans@sub{##1}}{\not\equal{\@kukans@sub}{}}{}\do{%
      \strsep\@kukans@sub{|}\@kukan\@kukans@sub%
      \headchar\@kukan\@kukan@l\@kukan@t
      \tailchar\@kukan@t\@kukan@m\@kukan@r
      \strsep\@kukan@m{,}\@kukan@a\@kukan@b
      \ifthenelse{\equal\@kukan@a{}}{%
        \edef\@kukan@A{(\xmin,0)}\edef\@kukan@AA{(\xmin,\@takasa)}%
      }{%
        \headchar\@kukan@a\@kukan@h\kukan@a@
        \if <\@kukan@h\relax
          \strsep\kukan@a@{>}\kukan@ang\@kukan@a
          \edef\@kukan@A{(\@kukan@a,0)}%
          \ifdim\@takasa\p@<\z@
            \Landk{(\xmin,\@takasa)}{(\xmax,\@takasa)}\@kukan@A{-\kukan@ang}\@kukan@AA
          \else
            \Landk{(\xmin,\@takasa)}{(\xmax,\@takasa)}\@kukan@A\kukan@ang\@kukan@AA
          \fi
          \if\@kukan@l(\relax
            \edefappend\KT@siromaru{\@kukan@A}%
          \else
            \edefappend\KT@kuromaru{\@kukan@A}%
          \fi
        \else
          \edef\@kukan@A{(\@kukan@a,0)}%
          \if\@kukan@l(\relax
            \ifdim\@takasa\p@<\z@
              \Landk{(\xmin,\@takasa)}{(\xmax,\@takasa)}\@kukan@A{-\KTo@ang}\@kukan@AA
            \else
              \Landk{(\xmin,\@takasa)}{(\xmax,\@takasa)}\@kukan@A\KTo@ang\@kukan@AA
            \fi
            \edefappend\KT@siromaru{\@kukan@A}%
          \else%\edef\@kukan@AA{(\@kukan@a,\@takasa)}%
            \ifdim\@takasa\p@<\z@
              \Landk{(\xmin,\@takasa)}{(\xmax,\@takasa)}\@kukan@A{-\KTc@ang}\@kukan@AA
            \else
              \Landk{(\xmin,\@takasa)}{(\xmax,\@takasa)}\@kukan@A\KTc@ang\@kukan@AA
            \fi
            \edefappend\KT@kuromaru{\@kukan@A}%
          \fi
        \fi
%        \Drawline{\@kukan@A\@kukan@AA}%
      }%
      \ifthenelse{\equal\@kukan@b{}}{%
        \edef\@kukan@B{(\xmax,0)}\edef\@kukan@BB{(\xmax,\@takasa)}%
      }{%
        \headchar\@kukan@b\@kukan@h\kukan@b@
        \if <\@kukan@h\relax
          \strsep\kukan@b@{>}\kukan@ang\@kukan@b
          \Sub{180}\kukan@ang\kukan@ang
          \edef\@kukan@B{(\@kukan@b,0)}%
          \ifdim\@takasa\p@<\z@
            \Landk{(\xmin,\@takasa)}{(\xmax,\@takasa)}\@kukan@B{-\kukan@ang}\@kukan@BB
          \else
            \Landk{(\xmin,\@takasa)}{(\xmax,\@takasa)}\@kukan@B\kukan@ang\@kukan@BB
          \fi
          \if\@kukan@r)\relax
            \edefappend\KT@siromaru{\@kukan@B}%
          \else
            \edefappend\KT@kuromaru{\@kukan@B}%
          \fi
        \else
          \edef\@kukan@B{(\@kukan@b,0)}%
          \if\@kukan@r)\relax
            \ifdim\@takasa\p@<\z@
              \Landk{(\xmin,\@takasa)}{(\xmax,\@takasa)}\@kukan@B{-\KTo@ang@}\@kukan@BB
            \else
              \Landk{(\xmin,\@takasa)}{(\xmax,\@takasa)}\@kukan@B\KTo@ang@\@kukan@BB
            \fi
            \edefappend\KT@siromaru{\@kukan@B}%
          \else%\edef\@kukan@BB{(\@kukan@b,\@takasa)}%
            \ifdim\@takasa\p@<\z@
              \Landk{(\xmin,\@takasa)}{(\xmax,\@takasa)}\@kukan@B{-\KTc@ang@}\@kukan@BB
            \else
              \Landk{(\xmin,\@takasa)}{(\xmax,\@takasa)}\@kukan@B\KTc@ang@\@kukan@BB
            \fi
            \edefappend\KT@kuromaru{\@kukan@B}%
          \fi
        \fi
%        \Drawline{\@kukan@B\@kukan@BB}%
      }%
      \ifthenelse{\equal\@kukan@a{}}{%
        \Drawline{\@kukan@AA\@kukan@BB\@kukan@B}%
      }{%
        \ifthenelse{\equal\@kukan@b{}}{%
          \Drawline{\@kukan@A\@kukan@AA\@kukan@BB}%
        }{%
          \Drawline{\@kukan@A\@kukan@AA\@kukan@BB\@kukan@B}%
        }%
      }%
      \ifthenelse{\equal{#1}\empty}{}{{\fboxsep=\z@
        \Tyuuten\@kukan@AA\@kukan@BB\KT@tmp
%        \emathPut\KT@tmp[c]{\colorbox{white}{\maru{\arabic{enumKT}}}}%
        \ifthenelse{\KT@auto>\z@}{%
          \emathPut\KT@tmp[c]{\colorbox{white}{\maru{\arabic{enumKT}}}}%
        }{%
          \ifthenelse{\equal\kukan@lbli\empty}{}{%
            \ifnum\KT@lblsyu>\z@
              \emathPut\KT@tmp[c]{\colorbox{white}{\kukan@lbli}}%
            \else
              \emathPut\KT@tmp[c]{\colorbox{white}{\eqref{\kukan@lbli}}}%
            \fi
          }%
        }%
      }}%
    }%
  }%
%
\def\KTkukan@sub@A{%
  \Cfor{\edef\@kukans{#4}}{\not\equal{\@kukans}{}}{}\do{%
    \Strsep\@kukans{|}\@kukan\@kukans%
    \headchar\@kukan\@kukan@l\@kukan@t
    \if <\@kukan@l\relax
      \strsep\@kukan@t{>}\kukan@opt\kukan@tmp
      \headchar\kukan@tmp\@kukan@l\@kukan@t
    \else
      \EMedef\kukan@opt{\KT@paintoption}%
    \fi
    \tailchar\@kukan@t\@kukan@m\@kukan@r
    \strsep\@kukan@m{,}\@kukan@a\@kukan@b
    \ifthenelse{\equal\@kukan@a{}}{%
      \edef\@kukan@A{(\xmin,0)}\edef\@kukan@AA{(\xmin,\kukantakasa)}%
    }{%
      \headchar\@kukan@a\@kukan@h\kukan@a@
      \if <\@kukan@h\relax
        \strsep\kukan@a@{>}\kukan@ang\@kukan@a
        \edef\@kukan@A{(\@kukan@a,0)}%
        \ifdim\kukantakasa\p@<\z@
          \Landk{(\xmin,\kukantakasa)}{(\xmax,\kukantakasa)}\@kukan@A{-\kukan@ang}\@kukan@AA
        \else
          \Landk{(\xmin,\kukantakasa)}{(\xmax,\kukantakasa)}\@kukan@A\kukan@ang\@kukan@AA
          \fi
      \else
        \edef\@kukan@A{(\@kukan@a,0)}%
        \if\@kukan@l(\relax
          \ifdim\kukantakasa\p@<\z@
            \Landk{(\xmin,\kukantakasa)}{(\xmax,\kukantakasa)}\@kukan@A{-\KTo@ang}\@kukan@AA
          \else
            \Landk{(\xmin,\kukantakasa)}{(\xmax,\kukantakasa)}\@kukan@A\KTo@ang\@kukan@AA
          \fi
        \else%\edef\@kukan@AA{(\@kukan@a,\kukantakasa)}%
          \ifdim\kukantakasa\p@<\z@
            \Landk{(\xmin,\kukantakasa)}{(\xmax,\kukantakasa)}\@kukan@A{-\KTc@ang}\@kukan@AA
          \else
            \Landk{(\xmin,\kukantakasa)}{(\xmax,\kukantakasa)}\@kukan@A\KTc@ang\@kukan@AA
          \fi
        \fi
      \fi
      \if\@kukan@l(\relax
        \edefappend\KT@siromaru{\@kukan@A}%
      \else
        \edefappend\KT@kuromaru{\@kukan@A}%
      \fi
    }%
    \ifthenelse{\equal\@kukan@b{}}{%
      \edef\@kukan@B{(\xmax,0)}\edef\@kukan@BB{(\xmax,\kukantakasa)}%
    }{%
      \headchar\@kukan@b\@kukan@h\kukan@b@
      \if <\@kukan@h\relax
        \strsep\kukan@b@{>}\kukan@ang\@kukan@b
        \Sub{180}\kukan@ang\kukan@ang
        \edef\@kukan@B{(\@kukan@b,0)}%
        \ifdim\kukantakasa\p@<\z@
          \Landk{(\xmin,\kukantakasa)}{(\xmax,\kukantakasa)}\@kukan@B{-\kukan@ang}\@kukan@BB
        \else
          \Landk{(\xmin,\kukantakasa)}{(\xmax,\kukantakasa)}\@kukan@B\kukan@ang\@kukan@BB
        \fi
      \else
        \edef\@kukan@B{(\@kukan@b,0)}%
        \if\@kukan@r)\relax
          \ifdim\kukantakasa\p@<\z@
            \Landk{(\xmin,\kukantakasa)}{(\xmax,\kukantakasa)}\@kukan@B{-\KTo@ang@}\@kukan@BB
          \else
            \Landk{(\xmin,\kukantakasa)}{(\xmax,\kukantakasa)}\@kukan@B\KTo@ang@\@kukan@BB
          \fi
        \else%\edef\@kukan@BB{(\@kukan@b,\kukantakasa)}%
          \ifdim\kukantakasa\p@<\z@
            \Landk{(\xmin,\kukantakasa)}{(\xmax,\kukantakasa)}\@kukan@B{-\KTc@ang@}\@kukan@BB
          \else
            \Landk{(\xmin,\kukantakasa)}{(\xmax,\kukantakasa)}\@kukan@B\KTc@ang@\@kukan@BB
          \fi
        \fi
      \fi
      \if\@kukan@r)\relax
        \edefappend\KT@siromaru{\@kukan@B}%
      \else
        \edefappend\KT@kuromaru{\@kukan@B}%
      \fi
    }%
    \vecXY\@kukan@AA\KT@xi\KT@yi
    \vecXY\@kukan@BB\KT@xii\KT@yii
    \ifdim\KT@xi\p@<\KT@xii\p@
     \edef\KT@tmp{\kukan@opt{\@kukan@A\@kukan@AA\@kukan@BB\@kukan@B\@kukan@A}}%
     \put(0,0){{\expandafter\emPaint\KT@tmp}}%
    \fi
  }%
}%
%
\def\KTkukan@sub@B{%
  \Cfor{\edef\@kukans{#4}}{\not\equal{\@kukans}{}}{}\do{%
    \Strsep\@kukans{|}\@kukan\@kukans%
    \headchar\@kukan\@kukan@l\@kukan@t
    \if <\@kukan@l\relax
      \strsep\@kukan@t{>}\kukan@opt\kukan@tmp
      \headchar\kukan@tmp\@kukan@l\@kukan@t
    \else
      \EMedef\kukan@opt{\KT@paintoption}%
    \fi
    \tailchar\@kukan@t\@kukan@m\@kukan@r
    \strsep\@kukan@m{,}\@kukan@a\@kukan@b
    \ifthenelse{\equal\@kukan@a{}}{%
      \edef\@kukan@A{(\xmin,0)}%
    }{%
      \headchar\@kukan@a\@kukan@h\kukan@a@
      \if <\@kukan@h\relax
        \strsep\kukan@a@{>}\kukan@ang\@kukan@a
      \fi
      \edef\@kukan@A{(\@kukan@a,0)}%
      \if\@kukan@l(\relax
        \edefappend\KT@siromaru{\@kukan@A}%
      \else
        \edefappend\KT@kuromaru{\@kukan@A}%
      \fi
    }%
    \ifthenelse{\equal\@kukan@b{}}{%
      \edef\@kukan@B{(\xmax,0)}%
    }{%
      \headchar\@kukan@b\@kukan@h\kukan@b@
      \if <\@kukan@h\relax
        \strsep\kukan@b@{>}\kukan@ang\@kukan@b
      \fi
      \edef\@kukan@B{(\@kukan@b,0)}%
      \if\@kukan@r)\relax
        \edefappend\KT@siromaru{\@kukan@B}%
      \else
        \edefappend\KT@kuromaru{\@kukan@B}%
      \fi
    }%
    \put(0,0){{%
      \ifnum\EMps@mode=\@ne
        \ifx\empty\KTans@iro@
          \Drawline{\@kukan@A\@kukan@B}%
        \else
          \Drawline<iro=\KTans@iro@>{\@kukan@A\@kukan@B}%
        \fi
      \else
        \ifx\empty\KTans@iro@\else\color{\KTans@iro@}\fi
        \Drawline{\@kukan@A\@kukan@B}%
      \fi
    }}%
  }%
}%
%
%
%
\edef\KT@auto{0}%
\let\KTdrawXaxis\drawXaxis
\ifx\empty #1\else
  \strchr{#1}{=}\KT@tmp
  \ifnum\KT@tmp>\z@\setkeys{KTkukan}{#1}\fi
\fi
\ifthenelse{\equal{#1}{auto}}{\edef\KT@auto{1}\setcounter{enumKT}{0}}{}%
%
%  解答区間塗り
  \edef\KT@kuromaru{}%
  \edef\KT@siromaru{}%
  \edef\KTans@iro@{\empty}%
  \ifx\empty #3\else\setkeys{KTkukan}{#3}\fi
  \KTkukan@sub@A
  \KTdrawXaxis
  \edef\KTans@kuromaru{\KT@kuromaru}%
  \edef\KTans@siromaru{\KT@siromaru}%
%
% 各区間表示
%\def\xy@hosei{}%\pause
  \edef\i@kukan{0}%
  \Cfor{\edef\@kukans{#2}\EMedef\kukan@lbl{#1}}{\not\equal{\@kukans}{}}{}\do{%
    \Strsep\@kukans{;}\@kukan\@kukans%
    \Incr\i@kukan\Mul\i@kukan\kukantakasa\@takasa
    \Strsep\kukan@lbl{;}\kukan@lbli\kukan@lbl
    \refstepcounter{enumKT}%
    \KTkukan@sub\@kukan
  }%
  \ifx\empty\KT@kuromaru\else\Kuromaru\KT@kuromaru\fi
  \ifx\empty\KT@siromaru\else\Siromaru\KT@siromaru\fi
%
% 解答区間表示
  \edef\KT@kuromaru{}%
  \edef\KT@siromaru{}%
  \KTkukan@sub@B
%
  \ifx\empty\KT@kuromaru
  \else
    \ifx\empty\KTans@iro@
      \Kuromaru\KT@kuromaru
    \else
      \Kuromaru<nuriiro=\KTans@iro@>\KT@kuromaru
    \fi
  \fi
  \ifx\empty\KT@siromaru
  \else
    \ifx\empty\KTans@iro@
      \Siromaru\KT@siromaru
    \else
      \ifnum\EMps@mode=\@ne
        \gsave
          \EMpsIrositei{\KTans@iro@}%
          \Siromaru\KT@siromaru
        \grestore
      \else
        \color{\KTans@iro@}%
        \Siromaru\KT@siromaru
      \fi
    \fi
  \fi
%
\endgroup
}%
%
\def\DPkukan{\begingroup
  \@ifstar{\edef\DPkukan@nuri{1}\@DPkukan}{\edef\DPkukan@nuri{0}\@DPkukan}}%
\def\@DPkukan{\@ifnextchar<{\DPkukan@}{\@@DPkukan}}%
\def\DPkukan@<#1>{\setkeys{KTkukan}{#1}\@@DPkukan}%
\def\@@DPkukan{\@ifnextchar[{\@@@DPkukan}{\@@@DPkukan[\empty]}}%
\def\@@@DPkukan[#1]#2{%
   \ifnum\DPkukan@nuri>\z@
     \KTkukan[#1]{#2}{#2}%
   \else
     \KTkukan[#1]{#2}{}%
   \fi
  \endgroup
}%
%
\def\KTkukans{\def\by@perl{\by@perl@}\@ifnextchar<{\KTkukans@}{\@KTkukans}}%
\def\KTkukans@<#1>{\setkeys{emP}{#1}\@KTkukans}%
\def\@KTkukans{\@ifnextchar[{\@@KTkukans}{\@@KTkukans[auto]}}%
\def\@@KTkukans[#1]#2#3{%
%
  \def\KTkukans@sub@pre##1{{%
    \Cfor{\edef\@kukans{##1}}{\not\equal{\@kukans}{}}{}\do{%
      \strsep\@kukans{|}\@kukan\@kukans%
      \headchar\@kukan\@kukan@l\@kukan@t
      \tailchar\@kukan@t\@kukan@m\@kukan@r
      \strsep\@kukan@m{,}\@kukan@a\@kukan@b
      \ifx\empty\@kukan@a\else\hairetukakunin{KT@tanten}{\@kukan@a}\dmy@\fi
      \ifx\empty\@kukan@b\else\hairetukakunin{KT@tanten}{\@kukan@b}\dmy@\fi
    }%
  }}%
%
  \def\KTkukans@sub##1{{%
    \Drawline{(\xmin,-\@takasa)(\xmax,-\@takasa)}%
    \Cfor{\edef\@kukans{##1}}{\not\equal{\@kukans}{}}{}\do{%
      \strsep\@kukans{|}\@kukan\@kukans%
      \headchar\@kukan\@kukan@l\@kukan@t
      \tailchar\@kukan@t\@kukan@m\@kukan@r
      \strsep\@kukan@m{,}\@kukan@a\@kukan@b
      \ifthenelse{\equal\@kukan@a{}}{%
        \edef\@kukan@A{(\xmin,-\@takasa)}%
      }{%
        \ifnum\by@perl>\z@\calcval[s]{\@kukan@a}\@kukan@a\fi
        \edef\@kukan@A{(\@kukan@a,-\@takasa)}%
      }%
      \ifthenelse{\equal\@kukan@b{}}{%
        \edef\@kukan@B{(\xmax,-\@takasa)}%
      }{%
        \ifnum\by@perl>\z@\calcval[s]{\@kukan@b}\@kukan@b\fi
        \edef\@kukan@B{(\@kukan@b,-\@takasa)}%
      }%
      {\Thicklines\Drawline{\@kukan@A\@kukan@B}}%
      \ifx\empty\@kukan@a\else
        \if\@kukan@l(\relax\Siromaru\@kukan@A\else\Kuromaru\@kukan@A\fi
      \fi
      \ifx\empty\@kukan@b\else
        \if\@kukan@r)\relax\Siromaru\@kukan@B\else\Kuromaru\@kukan@B\fi
      \fi
    }%
  }}%
%
  \edef\i@kukan{0}%
  \edef\kukantakasa{1}%
  \hairetusyokika{KT@tanten}%
  \Cfor{\edef\@kukans{#2}\edef\kukan@lbl{#1}}{\not\equal{\@kukans}{}}{}\do{%
    \strsep\@kukans{;}\@kukan\@kukans%
    \Incr\i@kukan
    \Mul\i@kukan\kukantakasa\@takasa
    \strsep\kukan@lbl{;}\kukan@lbli\kukan@lbl
    \KTkukans@sub@pre\@kukan
  }%
  \Mul\i@kukan\kukantakasa\@takasa
  \Addself\@takasa\kukantakasa
  \Cfor{\edef\KT@i{0}}{\KT@i<\KT@tantenN}{}\do{%
    \Incr\KT@i
    \EMedef\KT@x{\hairetu{KT@tanten}{\KT@i}}%
    \ifnum\by@perl>\z@\calcval[s]{\KT@x}\KT@x\fi
    \Hasen{(\KT@x,0)(\KT@x,-\@takasa)}%
  }%
  \edef\i@kukan{0}%
  \Cfor{\edef\@kukans{#2}\edef\kukan@lbl{#1}}{\not\equal{\@kukans}{}}{}\do{%
    \strsep\@kukans{;}\@kukan\@kukans%
    \Incr\i@kukan
    \Mul\i@kukan\kukantakasa\@takasa
    \strsep\kukan@lbl{;}\kukan@lbli\kukan@lbl
    \KTkukans@sub\@kukan
    \ifthenelse{\equal{#1}\empty}{}{%
        \ifthenelse{\equal{#1}{auto}}{%
          \Put{(\xmax,-\@takasa)}[e]{\maru\i@kukan}%
        }{%
          \ifthenelse{\equal\kukan@lbli\empty}{}{%
            \Put{(\xmax,-\@takasa)}[e]{\eqref\kukan@lbli}%
          }%
        }%
    }%
  }%
  \Addself\@takasa\kukantakasa
  \KTkukans@sub{#3}%
  \Put{(\xmax,-\@takasa)}[e]{答}%
  \def\by@perl{\by@perl@}%
}%
%
% 座標平面
% \begin{zahyou}(xmin,xmax)(ymin,ymax).....\end{zahyou}%
%   zahyou[#1][#2]<#3><#4><#5>(#6,#7)(#8,#9)
%     #1 : key=val
%       or : 横軸のラベル名   （デフォルトは [$x$]）
%     #2 : 縦軸のラベル名   （デフォルトは [$y$ ]）
%     #3 : 横軸ラベルの位置 （デフォルトは <(0,-3pt)[tl]> ）
%     #4 : 縦軸ラベルの位置 （デフォルトは <(0,0)[rt]> ）
%     #5 : 原点記号Oの位置  （デフォルトは <(-2pt,-3pt)[rt]> ）
%     (#6,#7) : xの範囲
%     (#8,#9) : yの範囲
%
\def\yokozikukigou{$x$}%
\def\tatezikukigou{$y$}%
\def\gentenkigou{O}%
\def\yokozikuhaiti{(0,-3pt)[rt]}%
\def\tatezikuhaiti{(-3pt,0)[rt]}%
\def\gentenhaiti{[sw]}%
\def\zikusensyu{\arrowdrawline}%
\def\zahyou@haiti@default{b}%
\def\zahyouhaiti#1{\def\zahyou@haiti@default{#1}}%
\def\xyminmax#1{%
  \ifthenelse{\equal{#1}{true}}{%
    \edef\true@xmin{\truexmin}%
    \edef\true@xmax{\truexmax}%
    \edef\true@ymin{\trueymin}%
    \edef\true@ymax{\trueymax}%
  }{%
    \edef\true@xmin{\xmin}%
    \edef\true@xmax{\xmax}%
    \edef\true@ymin{\ymin}%
    \edef\true@ymax{\ymax}%
  }%
}%
\def\zahyou{%
  \@ifundefined{OriginalPictureCmds}{%
    \let\sensyu\drawline
  }{%
%    \@ifundefined{pIIe@mode}{%
      \OriginalPictureCmds
      \let\sensyu\drawline
%    }{%
%      \let\drawline\polyline
%      \let\sensyu\polyline
%    }%
  }%
  \edef\hasenLG@opt{\empty}%
  \edef\hasen@opt{\empty}%
  \def\zahyou@haiti{\zahyou@haiti@default}%
  \def\zahyou@haiti@hosei{}%
  \def\ue@yohaku{0}%
  \def\sita@yohaku{0}%
  \def\migi@yohaku{0}%
  \def\hidari@yohaku{0}%
  \def\arrow@headsize{1}%
  \let\EMpsIrositei\color
  \z@hyou}%
\def\z@hyou{\@ifnextchar[{\@zahyou}{\@zahyou[\yokozikukigou]}}%
\def\@zahyou[#1]{%
  \@ifnextchar[{\@@zahyou[#1]}{\@@zahyou[#1][\tatezikukigou]}}%
\def\@@zahyou[#1][#2]{%
  \@ifnextchar<{\@@@zahyou[#1][#2]}{%
    \@@@zahyou[#1][#2]<\yokozikuhaiti>}}%
\def\@@@zahyou[#1][#2]<#3>{%\typeout{@@@zahyou}%
  \@ifnextchar<{\@@@@zahyou[#1][#2]<#3>}{%
    \@@@@zahyou[#1][#2]<#3><\tatezikuhaiti>}}%
\def\@@@@zahyou[#1][#2]<#3><#4>{\@ifnextchar<{\@@@@zahyou@[#1][#2]<#3><#4>}{%
  \@@@@zahyou@[#1][#2]<#3><#4><\gentenhaiti>}}%
\def\@@@@zahyou@[#1][#2]<#3><#4><#5>{%
  \@ifnextchar({\@@@@@zahyou[#1][#2]<#3><#4><#5>}{%
          \@@@@@zahyou[#1][#2]<#3><#4><#5>(\xmin,\xmax)(\ymin,\ymax)}}%
\def\@@@@@zahyou[#1][#2]<#3><#4><#5>(#6,#7)(#8,#9){\@ifundefined{everyzahyou}{\relax}{\everyzahyou}%
  \def\setlinejoin##1{\relax}%
  \Strchr{#1}{=}\zahyou@tmp
  \ifnum\zahyou@tmp>\z@
    \setkeys{emP}{#1}%
  \else
    \ifthenelse{\equal{#1}\empty}{}{\edef\yokozikukigou{#1}}%
    \ifthenelse{\equal{#2}\empty}{}{\edef\tatezikukigou{#2}}%
    \ifthenelse{\equal{#3}\empty}{}{\edef\yokozikuhaiti{#3}}%
    \ifthenelse{\equal{#4}\empty}{}{\edef\tatezikuhaiti{#4}}%
    \ifthenelse{\equal{#5}\empty}{}{\edef\gentenhaiti{#5}}%
  \fi
  \Strchr{#7}{,}\zahyou@tmp
  \ifnum\zahyou@tmp>\z@
    \errmessage{zahyou : illegal x-range}%
  \fi
  \Strchr{#9}{,}\zahyou@tmp
  \ifnum\zahyou@tmp>\z@
    \errmessage{zahyou : illegal y-range}%
  \fi
  \isnumber{#6}{\edef\xmin{#6}}{\fpcalcval{#6}\xmin}%
  \isnumber{#7}{\edef\xmax{#7}}{\fpcalcval{#7}\xmax}%
  \isnumber{#8}{\edef\ymin{#8}}{\fpcalcval{#8}\ymin}%
  \isnumber{#9}{\edef\ymax{#9}}{\fpcalcval{#9}\ymax}%
%  \@ifundefined{fpcalcval}{%
%    \edef\xmin{#6}\edef\xmax{#7}%
%    \edef\ymin{#8}\edef\ymax{#9}%
%  }{%
%    \fpcalcval{(#6)}\xmin
%    \fpcalcval{(#7)}\xmax
%    \fpcalcval{(#8)}\ymin
%    \fpcalcval{(#9)}\ymax
%  }%
%\edef\truexmin{\xmin}%
%\edef\trueymin{\ymin}%
%\edef\truexmax{\xmax}%
%\edef\trueymax{\ymax}%
%
%   emathPs.sty の \borderwidth への対応
\edef\truexmin{\xmin}%
\edef\trueymin{\ymin}%
\edef\truexmax{\xmax}%
\edef\trueymax{\ymax}%
\Sub\truexmax\truexmin\truexwd
\Sub\trueymax\trueymin\trueywd
\@ifundefined{border@width}{}{%
  \ifdim\border@width>\z@
    \@tempdima\border@width\@Div{\strip@pt\@tempdima}{\strip@pt\unitlength}\x@bd
    \Sub\xmin\x@bd\xmin\Add\xmax\x@bd\xmax
    \@tempdima\border@width\@Div{\strip@pt\@tempdima}{\strip@pt\unitlength}\y@bd
    \Sub\ymin\y@bd\ymin\Add\ymax\y@bd\ymax
  \fi
}%
\xyminmax{true}%
%
% picture 環境の設定
%
  \Sub\xmax\xmin\xwd
  \Add\xwd\migi@yohaku\xwd\Add\xwd\hidari@yohaku\xwd
  \Sub\xmin\hidari@yohaku\xmin@
  \Sub\ymax\ymin\ywd
  \Add\ywd\ue@yohaku\ywd\Add\ywd\sita@yohaku\ywd
  \Sub\ymin\sita@yohaku\ymin@
%\typeout{zahyou@haiti=\zahyou@haiti}%
  \if o\zahyou@haiti
    \hspace*{\xmin\unitlength}%
    \edef\zahyou@haiti{x}%
  \fi
  \if t\zahyou@haiti
   \@tempdima \ywd\unitlength
  \else\if x\zahyou@haiti
    \@tempdima \ymin@\unitlength
    \@tempdima=-\@tempdima
  \else\if c\zahyou@haiti
    \@tempdima \ywd\unitlength
    \divide \@tempdima \tw@
    \advance\@tempdima -0.5ex\relax
  \else
    \@tempdima\z@
  \fi\fi\fi
  \ifthenelse{\equal\zahyou@haiti@hosei\empty}{}{%
      \@tempdimb\zahyou@haiti@hosei
      \advance\@tempdima-\@tempdimb}%
  \leavevmode\lower\@tempdima\hbox\bgroup
  \changeArrowHeadSize{\arrow@headsize}%
  \ltxpicture(\xwd,\ywd)(\xmin@,\ymin@)%
  \def\O{(0,0)}%
  \def\O@@{(0,0)}%
  \def\XMAX{(\xmax,0)}%
  \def\XMIN{(\xmin,0)}%
  \def\YMAX{(0,\ymax)}%
  \def\YMIN{(0,\ymin)}%
  \def\LT{(\xmin,\ymax)}%
  \def\LB{(\xmin,\ymin)}%
  \def\RT{(\xmax,\ymax)}%
  \def\RB{(\xmax,\ymin)}%
  \def\trueXMAX{(\truexmax,0)}%
  \def\trueXMIN{(\truexmin,0)}%
  \def\trueYMAX{(0,\trueymax)}%
  \def\trueYMIN{(0,\trueymin)}%
  \def\trueLT{(\truexmin,\trueymax)}%
  \def\trueLB{(\truexmin,\trueymin)}%
  \def\trueRT{(\truexmax,\trueymax)}%
  \def\trueRB{(\truexmax,\trueymin)}%
  \def\truezenheimen{\trueLT\trueLB\trueRB\trueRT}%
  \def\zenheimen{\LT\LB\RB\RT}%
  \Add\xmax\migi@yohaku\xmaxY
  \Sub\xmin\hidari@yohaku\xminY
  \Add\ymax\ue@yohaku\ymaxY
  \Sub\ymin\sita@yohaku\yminY
  \def\zenheimenY{%
    (\xmaxY,\yminY)(\xmaxY,\ymaxY)(\xminY,\ymaxY)(\xminY,\yminY)}%
\ignorespaces
}%
\def\endzahyou{%
  \ifdrawaxis%
    \drawXYaxis
  \fi
  \endltxpicture
  \egroup\@ignoretrue
}%
%
\def\pIIezahyou{%
%  \ifcase\em@gdrv@num
%    \def\pIIe@mode{1}%
%  \or
%    \def\pIIe@mode{2}%
%  \or
%    \def\pIIe@mode{2}%
%  \fi
  \let\drawline\polyline
  \let\sensyu\polyline
  \let\zikusensyu\pIIearrowline
  \def\circle##1{%
    \@Div{##1}{2}\circ@r
    \pIIearc[0,360]\circ@r
  }%
  \def\arc##1##2##3{%
    \@Div{##1}{2}\arc@r
    \RadDeg{##2}\arc@s
    \RadDeg{##3}\arc@e
    \pIIearc[\arc@s,\arc@e]\arc@r
  }%
  \def\@arc##1##2##3##4{%
    \@Div{##1}{2}\arc@a
    \@Div{##2}{2}\arc@b
    \def\arc@X{\arc@a*cos(T)}%
    \def\arc@Y{\arc@b*sin(T)}%
    \ParamC<mint=##3,maxt=##4>\arc@X\arc@Y
  }%
  \let\Ph@clipDrawline\clipDrawline
  \def\clipDrawline{\roundcap\Ph@clipDrawline}%
  \let\Ph@yclipDrawline\yclipDrawline
  \def\yclipDrawline{\roundcap\Ph@yclipDrawline}%
  \let\Ph@xclipDrawline\xclipDrawline
  \def\xclipDrawline{\roundcap\Ph@xclipDrawline}%
  \let\enko\EMenko
%
  \zahyou
}%
\let\endpIIezahyou\endzahyou
%
% 座標軸を描画しない zahyou* 環境
\expandafter\def\csname zahyou*\endcsname{\drawaxisfalse\zahyou}%
\expandafter\def\csname endzahyou*\endcsname{\endzahyou\@ignoretrue}%
%
\expandafter\def\csname pIIezahyou*\endcsname{\drawaxisfalse\pIIezahyou}%
\expandafter\def\csname endpIIezahyou*\endcsname{\endpIIezahyou\@ignoretrue}%
%
%
%\def\drawXaxis{\Sub\xmax\xmin\xwd\put(\xmin,0){\vector(1,0){\xwd}}}%
%\def\drawYaxis{\Sub\ymax\ymin\ywd\put(0,\ymin){\vector(0,1){\ywd}}}%
\def\drawXaxis{\put(0,0){\ArrowLine{(\truexmin,0)}{(\truexmax,0)}}}%
\def\drawYaxis{\put(0,0){\ArrowLine{(0,\trueymin)}{(0,\trueymax)}}}%
\def\drawXYaxis{%
    \put(0,0){\zikusensyu(\truexmin,0)(\truexmax,0)}%
    \put(0,0){\zikusensyu(0,\trueymin)(0,\trueymax)}%
    \edef\zahyou@tmp{{(\truexmax,0)}\yokozikuhaiti}%
    \expandafter\emathPut\zahyou@tmp{\yokozikukigou}%
    \edef\zahyou@tmp{{(0,\trueymax)}\tatezikuhaiti}%
    \expandafter\emathPut\zahyou@tmp{\tatezikukigou}%
    \edef\zahyou@tmp{{(0,0)}\gentenhaiti}%
    \expandafter\emathPut\zahyou@tmp{\gentenkigou}%
}%
% 座標軸に目盛を打つ．
% \zahyouMemori[#1][#2]<#3>
%   #1 : g : グリッド
%        + : 格子点に +マーク
%        o : 格子点に黒丸
%        z : 座標軸上の格子点に +マーク（デフォルト）
%        n : なし
%   #2 : n : 目盛り数値なし
%   #3 : 刻み
\def\zahyouMemori{\@ifnextchar[{\@zahyouMemori}{\@zahyouMemori[z]}}%
\def\@zahyouMemori[#1]{\@ifnextchar[{\@@zahyouMemori[#1]}{%
    \@@zahyouMemori[#1][m]}}%
\def\@@zahyouMemori[#1][#2]{\@ifnextchar<{\@@@zahyouMemori[#1][#2]}{%
  \@@@zahyouMemori[#1][#2]<1>}}%
\def\@@@zahyouMemori[#1][#2]<#3>{{%
  \ifnum\EMps@mode=\@ne\gsave\fi
  \@tempdima=\def@memori@nagasa
  \@Div{\strip@pt\@tempdima}{\strip@pt\unitlength}\memori@nagasa
  \if g#1\relax{\@ifundefined{allinethickness}{}{\allinethickness{0.1pt}}%
    \setbox0=\hbox{\hasen(0,\trueymax)(0,\trueymin)}%
    \For\@x{#3}{\truexmax}{#3}\Do{\put(\@x,0){\copy0}}%
    \For\@x{-#3}{\truexmin}{-#3}\Do{\put(\@x,0){\copy0}}%
    \setbox0=\hbox{\hasen(\truexmax,0)(\truexmin,0)}%
    \For\@x{#3}{\trueymax}{#3}\Do{\put(0,\@x){\copy0}}%
    \For\@x{-#3}{\trueymin}{-#3}\Do{\put(0,\@x){\copy0}}}%
  \else\if +#1\relax
    \Cfor{\edef\zM@x{0}}{\lengthtest{\zM@x pt<\truexmax pt}}{\Incr[#3]\zM@x}\do{%
      \Cfor{\edef\zM@y{0}}{\lengthtest{\zM@y pt<\trueymax pt}}{\Incr[#3]\zM@y}\do{%
        \put(\zM@x,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}%
        \put(\zM@x,\zM@y){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}%
      \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\trueymin pt}}{\Incr[-#3]\zM@y}\do{%
        \put(\zM@x,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}%
        \put(\zM@x,\zM@y){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}}%
      \Cfor{\edef\zM@x{-#3}}{\lengthtest{\zM@x pt>\truexmin pt}}{\Incr[-#3]\zM@x}\do{%
      \Cfor{\edef\zM@y{0}}{\lengthtest{\zM@y pt<\trueymax pt}}{\Incr[#3]\zM@y}\do{%
        \put(\zM@x,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}%
        \put(\zM@x,\zM@y){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}%
      \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\trueymin pt}}{\Incr[-#3]\zM@y}\do{%
        \put(\zM@x,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}%
        \put(\zM@x,\zM@y){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}}%
  \else\if o#1\relax
    \Cfor{\edef\zM@x{0}}{\lengthtest{\zM@x pt<\truexmax pt}}{\Incr[#3]\zM@x}\do{%
      \Cfor{\edef\zM@y{0}}{\lengthtest{\zM@y pt<\trueymax pt}}{\Incr[#3]\zM@y}\do{%
        \Kuromaru[0.5pt]{(\zM@x,\zM@y)}}%
      \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\trueymin pt}}{\Incr[-#3]\zM@y}\do{%
        \Kuromaru[0.5pt]{(\zM@x,\zM@y)}}}%
      \Cfor{\edef\zM@x{-#3}}{\lengthtest{\zM@x pt>\truexmin pt}}{\Incr[-#3]\zM@x}\do{%
      \Cfor{\edef\zM@y{0}}{\lengthtest{\zM@y pt<\trueymax pt}}{\Incr[#3]\zM@y}\do{%
        \Kuromaru[0.5pt]{(\zM@x,\zM@y)}}%
      \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\trueymin pt}}{\Incr[-#3]\zM@y}\do{%
        \Kuromaru[0.5pt]{(\zM@x,\zM@y)}}}%
  \else\if z#1\relax
    \Cfor{\edef\zM@x{#3}}{\lengthtest{\zM@x pt<\truexmax pt}}{\Incr[#3]\zM@x}\do{%
      \put(\zM@x,0){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}%
    \Cfor{\edef\zM@x{-#3}}{\lengthtest{\zM@x pt>\truexmin pt}}{\Incr[-#3]\zM@x}\do{%
      \put(\zM@x,0){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}%
    \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\trueymin pt}}{\Incr[-#3]\zM@y}\do{%
      \put(0,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}}%
    \Cfor{\edef\zM@y{#3}}{\lengthtest{\zM@y pt<\trueymax pt}}{\Incr[#3]\zM@y}\do{%
      \put(0,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}}%
  \fi\fi\fi\fi
  \if m#2\relax
    \Cfor{\edef\zM@x{#3}}{\lengthtest{\zM@x pt<\truexmax pt}}{\Incr[#3]\zM@x}\do{%
      \emathPut{(\zM@x,0)}[s]{\zM@x}}%
    \Cfor{\edef\zM@x{-#3}}{\lengthtest{\zM@x pt>\truexmin pt}}{\Incr[-#3]\zM@x}\do{%
      \emathPut{(\zM@x,0)}[s]{$\zM@x$}}%
    \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\trueymin pt}}{\Incr[-#3]\zM@y}\do{%
      \emathPut{(0,\zM@y)}[w]{$\zM@y$}}%
    \Cfor{\edef\zM@y{#3}}{\lengthtest{\zM@y pt<\trueymax pt}}{\Incr[#3]\zM@y}\do{%
      \emathPut{(0,\zM@y)}[w]{\zM@y}}%
  \fi
  \ifnum\EMps@mode=\@ne\grestore\fi
}}%
%\def\@@@zahyouMemori[#1][#2]<#3>{{%
%  \@tempdima=\def@memori@nagasa
%  \@Div{\strip@pt\@tempdima}{\strip@pt\unitlength}\memori@nagasa
%  \if g#1\relax{\@ifundefined{allinethickness}{}{\allinethickness{0.1pt}}%
%    \setbox0=\hbox{\hasen(0,\ymax)(0,\ymin)}%
%    \For\@x{#3}{\xmax}{#3}\Do{\put(\@x,0){\copy0}}%
%    \For\@x{-#3}{\xmin}{-#3}\Do{\put(\@x,0){\copy0}}%
%    \setbox0=\hbox{\hasen(\xmax,0)(\xmin,0)}%
%    \For\@x{#3}{\ymax}{#3}\Do{\put(0,\@x){\copy0}}%
%    \For\@x{-#3}{\ymin}{-#3}\Do{\put(0,\@x){\copy0}}}%
%  \else\if +#1\relax
%    \Cfor{\edef\zM@x{0}}{\lengthtest{\zM@x pt<\xmax pt}}{\Incr[#3]\zM@x}\do{%
%      \Cfor{\edef\zM@y{0}}{\lengthtest{\zM@y pt<\ymax pt}}{\Incr[#3]\zM@y}\do{%%
%        \put(\zM@x,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}%
%        \put(\zM@x,\zM@y){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}%
%      \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\ymin pt}}{\Incr[-#3]\zM@y}\do{%
%        \put(\zM@x,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}%
%        \put(\zM@x,\zM@y){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}}%
%      \Cfor{\edef\zM@x{-#3}}{\lengthtest{\zM@x pt>\xmin pt}}{\Incr[-#3]\zM@x}\do{%
%      \Cfor{\edef\zM@y{0}}{\lengthtest{\zM@y pt<\ymax pt}}{\Incr[#3]\zM@y}\do{%%
%        \put(\zM@x,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}%
%        \put(\zM@x,\zM@y){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}%
%      \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\ymin pt}}{\Incr[-#3]\zM@y}\do{%
%        \put(\zM@x,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}%
%        \put(\zM@x,\zM@y){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}}%
%  \else\if o#1\relax
%    \Cfor{\edef\zM@x{0}}{\lengthtest{\zM@x pt<\xmax pt}}{\Incr[#3]\zM@x}\do{%
%      \Cfor{\edef\zM@y{0}}{\lengthtest{\zM@y pt<\ymax pt}}{\Incr[#3]\zM@y}\do{%%
%        \Kuromaru[0.5pt]{(\zM@x,\zM@y)}}%
%      \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\ymin pt}}{\Incr[-#3]\zM@y}\do{%
%        \Kuromaru[0.5pt]{(\zM@x,\zM@y)}}}%
%      \Cfor{\edef\zM@x{-#3}}{\lengthtest{\zM@x pt>\xmin pt}}{\Incr[-#3]\zM@x}\do{%
%      \Cfor{\edef\zM@y{0}}{\lengthtest{\zM@y pt<\ymax pt}}{\Incr[#3]\zM@y}\do{%%
%        \Kuromaru[0.5pt]{(\zM@x,\zM@y)}}%
%      \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\ymin pt}}{\Incr[-#3]\zM@y}\do{%
%        \Kuromaru[0.5pt]{(\zM@x,\zM@y)}}}%
%  \else\if z#1\relax
%    \Cfor{\edef\zM@x{#3}}{\lengthtest{\zM@x pt<\xmax pt}}{\Incr[#3]\zM@x}\do{%
%      \put(\zM@x,0){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}%
%    \Cfor{\edef\zM@x{-#3}}{\lengthtest{\zM@x pt>\xmin pt}}{\Incr[-#3]\zM@x}\do{%%
%      \put(\zM@x,0){\drawline(0,-\memori@nagasa)(0,\memori@nagasa)}}%
%    \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\ymin pt}}{\Incr[-#3]\zM@y}\do{%%
%      \put(0,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}}%
%    \Cfor{\edef\zM@y{#3}}{\lengthtest{\zM@y pt<\ymax pt}}{\Incr[#3]\zM@y}\do{%
%      \put(0,\zM@y){\drawline(-\memori@nagasa,0)(\memori@nagasa,0)}}%
%  \fi\fi\fi\fi
%  \if m#2\relax
%    \Cfor{\edef\zM@x{#3}}{\lengthtest{\zM@x pt<\xmax pt}}{\Incr[#3]\zM@x}\do{%
%      \emathPut{(\zM@x,0)}[s]{\zM@x}}%
%    \Cfor{\edef\zM@x{-#3}}{\lengthtest{\zM@x pt>\xmin pt}}{\Incr[-#3]\zM@x}\do{%%
%      \emathPut{(\zM@x,0)}[s]{$\zM@x$}}%
%    \Cfor{\edef\zM@y{-#3}}{\lengthtest{\zM@y pt>\ymin pt}}{\Incr[-#3]\zM@y}\do{%%
%      \emathPut{(0,\zM@y)}[w]{$\zM@y$}}%
%    \Cfor{\edef\zM@y{#3}}{\lengthtest{\zM@y pt<\ymax pt}}{\Incr[#3]\zM@y}\do{%
%      \emathPut{(0,\zM@y)}[w]{\zM@y}}%
%  \fi
%}}%
%
% 座標軸上任意位置に目盛
% \xmemori[#1]<#2>#3
% \ymemori[#1]<#2>#3
%   #1 : t = 座標軸の下に目盛
%        b =         上
%        \Put に対する任意の配置オプション
%   #2 : 目盛の文字
%        （省略すれば，#3 に指定したものが代用されます．）
%   #3 : 目盛の位置
%
\def\def@memori@nagasa{.5mm}%
\def\def@xmemori@nagasa{.5mm}%
\def\def@ymemori@nagasa{.5mm}%
\def\memorinagasa#1{\def\def@memori@nagasa{#1}%
  \def\def@xmemori@nagasa{#1}%
  \def\def@ymemori@nagasa{#1}%
}%
\def\xmemorinagasa#1{\def\def@xmemori@nagasa{#1}}%
\def\ymemorinagasa#1{\def\def@ymemori@nagasa{#1}}%
%
\def\xmemori{\edef\memori@nagasa{\def@memori@nagasa}\@ifstar{\edef\memori@nagasa{0pt}\xmemori@}{\xmemori@}}%
\def\xmemori@{\@ifnextchar[{\x@memori}{\x@memori[t]}}%
\def\x@memori[#1]{\@ifnextchar<{\x@@memori[#1]}{\x@@memori[#1]<\empty>}}%
\def\x@@memori[#1]<#2>#3{{%
  \@ifundefined{cPut}{}{\let\emathPut\cPut}%
    \ifx\empty#2\edef\memori@lbl{$#3$}\else\def\memori@lbl{$#2$}\fi%
    \@ifundefined{yunitlength}{%
      \ukansan\memori@nagasa\memori@u@pt
    }{%
      \uykansan\memori@nagasa\memori@u@pt
    }%
    \ifdim\def@memori@nagasa>\z@
      \put(0,0){\drawline(#3,-\memori@u@pt)(#3,\memori@u@pt)}%
    \fi
    \ifthenelse{\equal{#1}{t}}{%
      \emathPut{(#3,-\memori@u@pt)}(0,-2pt)[t]\memori@lbl
    }{%
      \ifthenelse{\equal{#1}{b}}{%
        \emathPut{(#3,\memori@u@pt)}(0,2pt)[b]\memori@lbl
      }{%
        \edef\xmemori@str{{(#3,0)}#1}%
        \expandafter\emathPut\xmemori@str\memori@lbl
      }%
    }%
}}%
%
\def\ymemori{\edef\memori@nagasa{\def@memori@nagasa}\@ifstar{\edef\memori@nagasa{0pt}\ymemori@}{\ymemori@}}%
\def\ymemori@{\@ifnextchar[{\y@memori}{\y@memori[r]}}%
\def\y@memori[#1]{\@ifnextchar<{\y@@memori[#1]}{\y@@memori[#1]<\empty>}}%
\def\y@@memori[#1]<#2>#3{{%
  \@ifundefined{cPut}{}{\let\emathPut\cPut}%
    \ifx\empty#2\edef\memori@lbl{$#3$}\else\def\memori@lbl{$#2$}\fi%
    \@ifundefined{xunitlength}{%
      \ukansan\memori@nagasa\memori@u@pt
    }{%
      \uxkansan\memori@nagasa\memori@u@pt
    }%
    \ifdim\def@memori@nagasa>\z@
      \put(0,0){\drawline(-\memori@u@pt,#3)(\memori@u@pt,#3)}%
    \fi
    \ifthenelse{\equal{#1}{r}}{%
      \emathPut{(-\memori@u@pt,#3)}(-2pt,0)[r]\memori@lbl
    }{%
      \ifthenelse{\equal{#1}{l}}{%
        \emathPut{(\memori@u@pt,#3)}(2pt,0)[l]\memori@lbl
      }{%
        \edef\ymemori@str{{(0,#3)}#1}%
        \expandafter\emathPut\ymemori@str\memori@lbl
      }%
    }%
}}%
%
% \rmemori
%
\def\rmemori(#1,#2)#3{%
  \ukansan\def@memori@nagasa\memori@u@pt
  \Add{#1}\memori@u@pt\rmemori@l\Rdef(\rmemori@l,#2)\rmemori@P
  \Sub{#1}\memori@u@pt\rmemori@l\Rdef(\rmemori@l,#2)\rmemori@Q
  \Drawline{\rmemori@P\rmemori@Q}%
  \Put\rmemori@P [r](6pt,#2)[c]{#3}%
}%
%
% \Memorisen
%
\define@key{emP}{height}{\edef\Ph@height{#1}}%
\define@key{emP}{depth}{\edef\Ph@depth{#1}}%
\define@key{emP}{char}{\EMedef\Ph@char{#1}}%
\edef\Ph@height@{3pt}%
\edef\Ph@depth@{3pt}%
\def\MemorisenHD#1#2{\edef\Memorisen@H@{#1}\edef\Memorisen@D@{#2}}%
\def\Memorisen{\begingroup
  \edef\Ph@height{\Ph@height@}%
  \edef\Ph@depth{\Ph@depth@}%
  \edef\Ph@char{\empty}
  \@ifnextchar<{\Memorisen@}{\@Memorisen}}%
\def\Memorisen@<#1>{\setkeys{emP}{#1}\@Memorisen}%
\def\@Memorisen#1#2{%
  \Subvec{#2}{#1}\Memorisen@v
  \Argvec\Memorisen@v\Memorisen@arg
  \Rotdef[\Ph@height]{#1}{#2}{90}\Memorisen@H
  \Rotdef[\Ph@depth]{#1}{#2}{-90}\Memorisen@D
  \ifx\empty\Ph@char
    \Drawline{\Memorisen@H\Memorisen@D}%
  \else
    \Put{#1}(0,0)[c]{\rotatebox{\Memorisen@arg}{\Ph@char}}%
  \fi
  \edef\temp@x{%
    \def\noexpand\MemorisenH{\Memorisen@H}\def\noexpand\MemorisenD{\Memorisen@D}}%
  \expandafter\endgroup\temp@x
}%
\def\@@memorisen#1#2{%
  \Subvec{#2}{#1}\Memorisen@v
  \Argvec\Memorisen@v\Memorisen@arg
  \Rotdef[\Ph@height]{#1}{#2}{90}\Memorisen@H
  \Rotdef[\Ph@depth]{#1}{#2}{-90}\Memorisen@D
  \ifx\empty\Ph@char
    \Drawline{\Memorisen@H\Memorisen@D}%
  \else
    \Put{#1}(0,0)[c]{\rotatebox{\Memorisen@arg}{\Ph@char}}%
  \fi
}%
\def\memorisen{\begingroup
  \edef\Ph@height{\Ph@height@}%
  \edef\Ph@depth{\Ph@depth@}%
  \edef\Ph@char{\empty}
  \@ifnextchar<{\memorisen@}{\@memorisen}}%
\def\memorisen@<#1>{\setkeys{emP}{#1}\@memorisen}%
\def\@memorisen#1{%
  \def\memorisen@sub(##1)(##2){%
    \edef\memorisen@sub@a{{(##1)}{(##2)}}%
%\typeout{a=\memorisen@sub@a}%
    \expandafter\@@memorisen\memorisen@sub@a
  }%
  \exfor[;]\memorisen@c:=#1\do{%
    \edef\memorisen@d{\memorisen@c}%
%\typeout{d=\memorisen@d}%
    \expandafter\memorisen@sub\memorisen@d
  }%
  \endgroup
}%
%
% 回転
%   \begin{Mawasu}#1#2
%     #1 : 回転の中心
%     #2 : 回転角
%
\def\Mawasu#1#2{%
  \vecXY{#1}\Mawasu@x\Mawasu@y
  \bgroup
  \iftdir
    \@tempdima\Mawasu@y\unitlength\@tempdima13.837\@tempdima%
    \@tempdimb\Mawasu@x\unitlength\@tempdimb13.837\@tempdimb%
  \else
    \@tempdima\Mawasu@x\unitlength\@tempdima13.837\@tempdima%
    \@tempdimb\Mawasu@y\unitlength\@tempdimb-13.837\@tempdimb%
  \fi
  \DegRad{#2}\@t\Mul{-1}\@t\@t
  \special{rt \@seisuu\@tempdima\space\@seisuu\@tempdimb\space\@t}%
}%
\def\endMawasu{\special{rt 0 0 0}\egroup}%
%
%
% 近似折れ線
% (0) 円弧を近似する折れ線
% \KinziEnko<#1>#2#3#4#5#6
%   #1 : 刻み値
%   #2 : 中心
%   #3 : 半径を直接与えるか
%        tuukaten=xx として，円弧の周上の一点を与える
%   #4 : 始め角を直接与えるか
%         hazimeten=xx として，中心を始点，xx を終点とするベクトルの
%         方向角を 始め角とするように指定する。
%   #5 : 終り角を直接与えるか
%         owariten=xx として，中心を始点，xx を終点とするベクトルの
%         方向角を 終り角とするように指定する。
%   #6 : 近似折れ線を受け取る制御綴
%
\def\KinziEnko{\@ifnextchar<{\KinziEnk@}{\KinziEnk@<\dt@default>}}%
\def\KinziEnk@<#1>#2#3#4#5#6{\begingroup
%    \define@key{emP}{tuukaten}{\Kyori{##1}{#2}\@hankei}%
%    \define@key{emP}{hazimeten}{%
%      \Subvec{##1}{#2}\KinziEnk@tmp\Argvec\KinziEnk@tmp\hazime@kaku}%
    \define@key{emP}{owariten}{%
      \Subvec{##1}{#2}\KinziEnk@tmp\Argvec\KinziEnk@tmp\owari@kaku
      \ifdim \YG@unit\p@>\z@
        \ifdim\owari@kaku pt<\hazime@kaku pt\Add{360}\owari@kaku\owari@kaku\fi
      \else
        \ifdim\owari@kaku pt>\hazime@kaku pt\Add{-360}\owari@kaku\owari@kaku\fi
      \fi
    }%
  \ifx\empty #1\relax
    \edef\YG@unit{\dt@default}%
  \else
    \ifthenelse{\equal{#1}{-}}{%
      \edef\YG@unit{-\dt@default}%
    }{%
      \edef\YG@unit{#1}%
    }%
  \fi
  \edef\hasen@opt{\empty}%
%  \edef\hazime@kaku{#4}%
%  \edef\owari@kaku{#5}%
  \edef\@tyuusin{#2}%
%  \edef\@hankei{#3}%
  \Strchr{#3}{=}\KinziEnk@tmp
  \ifnum\KinziEnk@tmp>\z@\setkeys{emP}{#3}\else
    \isnumber{#3}{\edef\@hankei{#3}}{\fpcalcval{#3}\@hankei}
  \fi
  \Strchr{#4}{=}\KinziEnk@tmp
  \ifnum\KinziEnk@tmp>\z@\setkeys{emP}{#4}\else
    \isnumber{#4}{\edef\hazime@kaku{#4}}{\fpcalcval{#4}\hazime@kaku}%
  \fi
  \Strchr{#5}{=}\KinziEnk@tmp
  \ifnum\KinziEnk@tmp>\z@\setkeys{emP}{#5}\else
    \isnumber{#5}{\edef\owari@kaku{#5}}{\fpcalcval{#5}\owari@kaku}%
  \fi
  \DegRad\hazime@kaku\kaku@s\DegRad\owari@kaku\kaku@e\def\@resen{}%
\ifdim\hazime@kaku\p@>\owari@kaku\p@
  \ifdim\YG@unit\p@>\z@
    \Mulself\YG@unit{-1}%
  \fi
\fi
  \For\@t\kaku@s\kaku@e{\YG@unit}\Do{\Cos\@t\@x\Mul\@x{\@hankei}\@x%
    \Sin\@t\@y\Mul\@y{\@hankei}\@y
    \Addvec{(\@x,\@y)}\@tyuusin\tmp@P
    \edef\@resen{\@resen\tmp@P}}%
  \Cos\kaku@e\@x\Mul\@x{\@hankei}\@x\Sin\kaku@e\@y\Mul\@y{\@hankei}\@y%
  \Addvec{(\@x,\@y)}\@tyuusin\tmp@P
  \edef\@resen{\@resen\tmp@P}%
  \edef\temp@x{\def\noexpand#6{\@resen}}%
  \expandafter\endgroup\temp@x}%
%
% 座標軸に平行な辺を持つ長方形の 斜線塗り
% \hatch<#1>[#2](#3,#4)(#5,#6)
% #1 : x軸方向間隔
% #2 : n = スラッシュ（デフォルト）
%    r = 逆スラッシュ
%        x = 交差
%    h = 水平
%    v = 鉛直
%    + = 十文字
% #3〜#6 : 対角頂点
%
\def\hatchrect{\@ifnextchar<{\@hatchrect}{\@hatchrect<.15>}}%
\def\@hatchrect<#1>{\@ifnextchar[{\@@hatchrect<#1>}{\@@hatchrect<#1>[n]}}%
\def\@@hatchrect<#1>[#2](#3,#4)(#5,#6){%
\ifdim #3pt<#5pt\relax%
  \edef\hatchrect@xi{#3}\edef\hatchrect@xii{#5}\else%
  \edef\hatchrect@xi{#5}\edef\hatchrect@xii{#3}\fi%
\ifdim #4pt<#6pt\relax%
  \edef\hatchrect@yi{#4}\edef\hatchrect@yii{#6}\else%
  \edef\hatchrect@yi{#6}\edef\hatchrect@yii{#4}\fi%
\Sub\hatchrect@yii\hatchrect@yi\mhatchrect@y
\Sub\hatchrect@xii\hatchrect@xi\mhatchrect@x
\edef\hatchrect@dx{#1}%
\edef\hatchrect@n{0}\edef\hatchrect@r{0}%
\edef\hatchrect@h{0}\edef\hatchrect@v{0}%
\ifx n#2\edef\hatchrect@n{1}\else
\ifx r#2\edef\hatchrect@r{1}\else
\ifx x#2\edef\hatchrect@n{1}\edef\hatchrect@r{1}\else
\ifx h#2\edef\hatchrect@h{1}\else
\ifx v#2\edef\hatchrect@v{1}\else
\ifx +#2\edef\hatchrect@h{1}\edef\hatchrect@v{1}%
\fi\fi\fi\fi\fi\fi
\if 1\hatchrect@n%
\For\hatchrect@x\hatchrect@xi\hatchrect@xii\hatchrect@dx\Do{%
  \mTyokusen[l]{(\hatchrect@x,\hatchrect@yi)}{%
    (\mhatchrect@x,\mhatchrect@y)}\hatchrect@x\hatchrect@xii}%
\For\hatchrect@x\hatchrect@xii\hatchrect@xi{-\hatchrect@dx}\Do{%
  \mTyokusen[l]{(\hatchrect@x,\hatchrect@yii)}{%
    (-\mhatchrect@x,-\mhatchrect@y)}\hatchrect@xi\hatchrect@x}%
\fi%
\if 1\hatchrect@r
\For\hatchrect@x\hatchrect@xi\hatchrect@xii\hatchrect@dx\Do{%
  \mTyokusen[l]{(\hatchrect@x,\hatchrect@yii)}{%
    (\mhatchrect@x,-\mhatchrect@y)}\hatchrect@x\hatchrect@xii}%
\For\hatchrect@x\hatchrect@xii\hatchrect@xi{-\hatchrect@dx}\Do{%
  \mTyokusen[l]{(\hatchrect@x,\hatchrect@yi)}{%
    (-\mhatchrect@x,\mhatchrect@y)}\hatchrect@xi\hatchrect@x}%
\fi
\if 1\hatchrect@h
\For\hatchrect@x\hatchrect@yi\hatchrect@yii\hatchrect@dx\Do{%
  \put(0,0){\sensyu(\hatchrect@xi,\hatchrect@x)(\hatchrect@xii,\hatchrect@x)}}%
\fi
\if 1\hatchrect@v
\For\hatchrect@x\hatchrect@xi\hatchrect@xii\hatchrect@dx\Do{%
  \put(0,0){\sensyu(\hatchrect@x,\hatchrect@yi)(\hatchrect@x,\hatchrect@yii)}}%
\fi
}%
%%
%% 訂正 \teisei の斜線位置の修正
%%    \teisei[#1](#2)#3[#4]<#5>
%%            #1: 線の引き方についてのオプション引数で，
%%                s : 斜線（／） [デフォルト] S : 二重斜線
%%                r : 斜線（＼）
%%                x : クロス
%%                h : 横線
%%                d : 横二本線
%%            #2: 線の色
%%            #3: 線を引く対象
%%            #4: 訂正後の文字列
%%            #5: 斜線の位置を修正するベクトル
%%                key=val の形式
%%                   dLT=(dx,dy), dLB=, dRT=, dRB= 右辺値は pt を単位とする数値
%%
%  \def\d@LT{(0,0)}%
%  \def\d@LB{(0,0)}%
%  \def\d@RT{(0,0)}%
%  \def\d@RB{(0,0)}%
%\define@key{emP}{teisei}{%
%  \edef\teisei@moziretu{#1}}%
%\define@key{emP}{houkou}{%
%  \edef\syasen@muki{#1}%
%  \if #1b\edef\syasen@muki{r}%
%  \fi
%}%
%\edef\iro@{\empty}%
%\edef\syasen@muki{s}%
%\edef\teisei@moziretu{\empty}%
%%
%\def\teisei{\begingroup
%  \def\d@LT{(0,0)}%
%  \def\d@LB{(0,0)}%
%  \def\d@RT{(0,0)}%
%  \def\d@RB{(0,0)}%
%  \@ifnextchar<{\t@eisei}{\t@@eisei}}%
%\def\t@eisei<#1>{\setkeys{emP}{#1}\@@@@teisei}%
%\def\@@@teisei[#1](#2)#3[#4]<#5>{%
%  \edef\syasen@muki{#1}%
%  \edef\iro@{#2}%
%  \edef\teisei@moziretu{#4}%
%  \ifthenelse{\equal{#5}\empty}{}{\setkeys{emP}{#5}}%
%  \@@@@teisei{#3}}%
%\def\@@@@teisei#1{\unitlength\p@
%  \ifmmode\setbox\EM@boxa\hbox{$#1$}\else\setbox\EM@boxa\hbox{#1}\fi
%  \edef\teisei@w{\strip@pt\wd\EM@boxa}%
%  \edef\teisei@h{\strip@pt\ht\EM@boxa}%
%  \edef\teisei@d{\strip@pt\dp\EM@boxa}%
%  \if\syasen@muki h\relax
%      \setlength{\templa}{\ht\EM@boxa-\dp\EM@boxa}\divide\templa by 2\relax
%      \edef\LT{(0,\strip@pt\templa)}%
%      \edef\LB{(0,\strip@pt\templa)}%
%      \edef\RT{(\strip@pt\wd\EM@boxa,\strip@pt\templa)}%
%      \edef\RB{(\strip@pt\wd\EM@boxa,\strip@pt\templa)}%
%  \else\if\syasen@muki d\relax
%      \setlength{\templa}{\ht\EM@boxa-\dp\EM@boxa}\divide\templa by 2\relax
%      \setlength{\templb}{\templa}\addtolength{\templb}{-0.8pt}%
%      \setlength{\templc}{\templa}\addtolength{\templc}{1.2pt}%
%      \edef\LT{(0,\strip@pt\templc)}%
%      \edef\RT{(\strip@pt\wd\EM@boxa,\strip@pt\templc)}%
%      \edef\LB{(0,\strip@pt\templb)}%
%      \edef\RB{(\strip@pt\wd\EM@boxa,\strip@pt\templb)}%
%  \else
%      \edef\LT{(0,\strip@pt\ht\EM@boxa)}%
%      \edef\LB{(0,-\strip@pt\dp\EM@boxa)}%
%      \edef\RT{(\strip@pt\wd\EM@boxa,\strip@pt\ht\EM@boxa)}%
%      \edef\RB{(\strip@pt\wd\EM@boxa,-\strip@pt\dp\EM@boxa)}%
%  \fi\fi
%  \Addvec\LT\d@LT\LT
%  \Addvec\LB\d@LB\LB
%  \Addvec\RT\d@RT\RT
%  \Addvec\RB\d@RB\RB
%  \ifx\empty\teisei@moziretu\relax
%    \leavevmode
%    {%
%      \box\EM@boxa\relax
%      \ifthenelse{\equal{\iro@}{white}}{}{%
%        \begin{picture}(0,0)%
%          \put(-\teisei@w,0){%
%            \ifx\empty\iro@\else\color{\iro@}\fi%
%            \if\syasen@muki r\relax
%              \Syasen{\LT\RB}%
%            \else\if\syasen@muki h\relax
%              \Syasen{\LT\RT}%
%            \else\if\syasen@muki d\relax
%              \Syasen{\LT\RT}%
%              \Syasen{\LB\RB}%
%            \else\if\syasen@muki x\relax
%              \Syasen{\LB\RT}%
%              \Syasen{\LT\RB}%
%            \else\if\syasen@muki S\relax
%              \put(0,1){\Syasen{\LB\RT}}%
%              \put(0,-1){\Syasen{\LB\RT}}%
%            \else
%              \Syasen{\LB\RT}%
%            \fi\fi\fi\fi\fi
%          }%
%        \end{picture}%
%      }%
%    }%
%  \else%
%    \ifmmode\setbox1\hbox{$\teisei@moziretu$}\else
%      \setbox1\hbox{\teisei@moziretu}\fi
%    \ensuremath{%\leavevmode
%      \hbox to \wd1{$\stackrel{\box1}{\box\EM@boxa%
%          \begin{picture}(0,0)%
%            \put(-\teisei@w,0){%
%              \ifx\empty\iro@\else\color{\iro@}\fi%
%              \if\syasen@muki r\relax
%                \Syasen{\LT\RB}%
%              \else\if\syasen@muki h\relax
%                \Syasen{\LT\RT}%
%              \else\if\syasen@muki d\relax
%                \Syasen{\LT\RT}%
%                \Syasen{\LB\RB}%
%              \else\if\syasen@muki x\relax
%                \Syasen{\LB\RT}%
%                \Syasen{\LT\RB}%
%              \else\if\syasen@muki S\relax
%                \put(0,1){\Syasen{\LB\RT}}%
%                \put(0,-1){\Syasen{\LB\RT}}%
%              \else
%                \Syasen{\LB\RT}%
%              \fi\fi\fi\fi\fi
%            }%
%          \end{picture}%
%     }$}\ignorespaces}%
%   \fi%
%  \endgroup\ignorespaces
%}%
%%
%\def\t@@eisei{%
%    \@ifnextchar[{\@teisei}{\@teisei[s]}}%
%\def\@teisei[#1]{%
%    \@ifnextchar({\@teisei@[#1]}{\@teisei@[#1](\empty)}}%
%\def\@teisei@[#1](#2)#3{%
%  \@ifnextchar[{\@@teisei[#1](#2)#3}{\@@teisei[#1](#2){#3}[\empty]}}%
%\def\@@teisei[#1](#2)#3[#4]{\@ifnextchar<{\@@@teisei[#1](#2){#3}[#4]}{%
%  \@@@teisei[#1](#2){#3}[#4]<\empty>}}%
%%\def\@@@teisei[#1](#2)#3[#4]<#5>{{\unitlength\p@
%%  \ifmmode\setbox\EM@boxa\hbox{$#3$}\else\setbox\EM@boxa\hbox{#3}\fi
%%  \edef\teisei@w{\strip@pt\wd\EM@boxa}%
%%  \edef\teisei@h{\strip@pt\ht\EM@boxa}%
%%  \edef\teisei@d{\strip@pt\dp\EM@boxa}%
%%  \if#1h\relax
%%      \setlength{\templa}{\ht\EM@boxa-\dp\EM@boxa}\divide\templa by 2\relax
%%      \edef\LT{(0,\strip@pt\templa)}%
%%      \edef\RT{(\strip@pt\wd\EM@boxa,\strip@pt\templa)}%
%%  \else\if#1d\relax
%%      \setlength{\templa}{\ht\EM@boxa-\dp\EM@boxa}\divide\templa by 2\relax
%%      \setlength{\templb}{\templa}\addtolength{\templb}{-0.8pt}%
%%      \setlength{\templc}{\templa}\addtolength{\templc}{1.2pt}%
%%      \edef\LT{(0,\strip@pt\templc)}%
%%      \edef\RT{(\strip@pt\wd\EM@boxa,\strip@pt\templc)}%
%%      \edef\LB{(0,\strip@pt\templb)}%
%%      \edef\RB{(\strip@pt\wd\EM@boxa,\strip@pt\templb)}%
%%  \else
%%      \edef\LT{(0,\strip@pt\ht\EM@boxa)}%
%%      \edef\LB{(0,-\strip@pt\dp\EM@boxa)}%
%%      \edef\RT{(\strip@pt\wd\EM@boxa,\strip@pt\ht\EM@boxa)}%
%%      \edef\RB{(\strip@pt\wd\EM@boxa,-\strip@pt\dp\EM@boxa)}%
%%  \fi\fi
%%  \ifx\empty#4\relax
%%    \leavevmode
%%    {%
%%      \box\EM@boxa\relax
%%      \ifthenelse{\equal{#2}{white}}{}{%
%%        \begin{picture}(0,0)%
%%          \put(-\teisei@w,0){%
%%            \ifx\empty#2\else\color{#2}\fi%
%%            \ifthenelse{\equal{#5}\empty}{}{\setkeys{emP}{#5}}%
%%            \if#1r\relax
%%              \Syasen{\LT\RB}%
%%            \else\if#1h\relax
%%              \Syasen{\LT\RT}%
%%            \else\if#1d\relax
%%              \Syasen{\LT\RT}%
%%              \Syasen{\LB\RB}%
%%            \else\if#1x\relax
%%              \Syasen{\LB\RT}%
%%              \Syasen{\LT\RB}%
%%            \else\if#1S\relax
%%              \put(0,1){\Syasen{\LB\RT}}%
%%              \put(0,-1){\Syasen{\LB\RT}}%
%%            \else
%%              \Syasen{\LB\RT}%
%%            \fi\fi\fi\fi\fi
%%          }%
%%        \end{picture}%
%%      }%
%%    }%
%%  \else%
%%    \ifmmode\setbox1\hbox{$#4$}\else\setbox1\hbox{#4}\fi
%%    \ensuremath{%
%%      \stackrel{\box1}%
%%        {\box\EM@boxa\relax{%
%%          \begin{picture}(0,0)%
%%            \put(-\teisei@w,0){%
%%              \ifx\empty#2\else\color{#2}\fi%
%%              \ifthenelse{\equal{#5}\empty}{}{\setkeys{emP}{#5}}%
%%              \if#1r\relax
%%                \Syasen{\LT\RB}%
%%              \else\if#1h\relax
%%                \Syasen{\LT\RT}%
%%              \else\if#1d\relax
%%                \Syasen{\LT\RT}%
%%                \Syasen{\LB\RB}%
%%              \else\if#1x\relax
%%                \Syasen{\LB\RT}%
%%                \Syasen{\LT\RB}%
%%              \else\if#1S\relax
%%                \put(0,1){\Syasen{\LB\RT}}%
%%                \put(0,-1){\Syasen{\LB\RT}}%
%%              \else
%%                \Syasen{\LB\RT}%
%%              \fi\fi\fi\fi\fi
%%            }%
%%          \end{picture}%
%%        }}%
%%    }%
%%   \fi%
%%}}%
%%
%%
%%
%
% 訂正 \teisei の斜線位置の修正
%    \teisei[#1](#2)#3[#4]<#5>
%            #1: 線の引き方についてのオプション引数で，
%                s : 斜線（／） [デフォルト] S : 二重斜線
%                r : 斜線（＼）
%                x : クロス
%                h : 横線
%                d : 横二本線
%            #2: 線の色
%            #3: 線を引く対象
%            #4: 訂正後の文字列
%            #5: 斜線の位置を修正するベクトル
%                key=val の形式
%                   dLT=(dx,dy), dLB=, dRT=, dRB= 右辺値は pt を単位とする数値
%
\def\teisei{%
    \@ifnextchar[{\@teisei}{\@teisei[s]}}%
\def\@teisei[#1]{%
    \@ifnextchar({\@teisei@[#1]}{\@teisei@[#1](\empty)}}%
\def\@teisei@[#1](#2)#3{%
  \@ifnextchar[{\@@teisei[#1](#2)#3}{\@@teisei[#1](#2){#3}[\empty]}}%
\def\@@teisei[#1](#2)#3[#4]{\@ifnextchar<{\@@@teisei[#1](#2){#3}[#4]}{%
  \@@@teisei[#1](#2){#3}[#4]<\empty>}}%
\def\@@@teisei[#1](#2)#3[#4]<#5>{{\unitlength\p@
  \ifmmode\setbox\EM@boxa\hbox{$#3$}\else\setbox\EM@boxa\hbox{#3}\fi
  \edef\teisei@w{\strip@pt\wd\EM@boxa}%
  \edef\teisei@h{\strip@pt\ht\EM@boxa}%
  \edef\teisei@d{\strip@pt\dp\EM@boxa}%
  \if#1h\relax
      \setlength{\templa}{\ht\EM@boxa-\dp\EM@boxa}\divide\templa by 2\relax
      \edef\LT{(0,\strip@pt\templa)}%
      \edef\RT{(\strip@pt\wd\EM@boxa,\strip@pt\templa)}%
  \else\if#1d\relax
      \setlength{\templa}{\ht\EM@boxa-\dp\EM@boxa}\divide\templa by 2\relax
      \setlength{\templb}{\templa}\addtolength{\templb}{-0.8pt}%
      \setlength{\templc}{\templa}\addtolength{\templc}{1.2pt}%
      \edef\LT{(0,\strip@pt\templc)}%
      \edef\RT{(\strip@pt\wd\EM@boxa,\strip@pt\templc)}%
      \edef\LB{(0,\strip@pt\templb)}%
      \edef\RB{(\strip@pt\wd\EM@boxa,\strip@pt\templb)}%
  \else
      \edef\LT{(0,\strip@pt\ht\EM@boxa)}%
      \edef\LB{(0,-\strip@pt\dp\EM@boxa)}%
      \edef\RT{(\strip@pt\wd\EM@boxa,\strip@pt\ht\EM@boxa)}%
      \edef\RB{(\strip@pt\wd\EM@boxa,-\strip@pt\dp\EM@boxa)}%
  \fi\fi
  \ifx\empty#4\relax
    \leavevmode
    {%
      \box\EM@boxa\relax
      \ifthenelse{\equal{#2}{white}}{}{%
        \begin{picture}(0,0)%
          \put(-\teisei@w,0){%
            \ifx\empty#2\else\color{#2}\fi%
            \ifthenelse{\equal{#5}\empty}{}{\setkeys{emP}{#5}}%
            \if#1r\relax
              \Syasen{\LT\RB}%
            \else\if#1h\relax
              \Syasen{\LT\RT}%
            \else\if#1d\relax
              \Syasen{\LT\RT}%
              \Syasen{\LB\RB}%
            \else\if#1x\relax
              \Syasen{\LB\RT}%
              \Syasen{\LT\RB}%
            \else\if#1S\relax
              \put(0,1){\Syasen{\LB\RT}}%
              \put(0,-1){\Syasen{\LB\RT}}%
            \else
              \Syasen{\LB\RT}%
            \fi\fi\fi\fi\fi
          }%
        \end{picture}%
      }%
    }%
  \else%
    \ifmmode\setbox1\hbox{$#4$}\else\setbox1\hbox{#4}\fi
    \ensuremath{%
      \stackrel{\box1}%
        {\box\EM@boxa\relax{%
          \begin{picture}(0,0)%
            \put(-\teisei@w,0){%
              \ifx\empty#2\else\color{#2}\fi%
              \ifthenelse{\equal{#5}\empty}{}{\setkeys{emP}{#5}}%
              \if#1r\relax
                \Syasen{\LT\RB}%
              \else\if#1h\relax
                \Syasen{\LT\RT}%
              \else\if#1d\relax
                \Syasen{\LT\RT}%
                \Syasen{\LB\RB}%
              \else\if#1x\relax
                \Syasen{\LB\RT}%
                \Syasen{\LT\RB}%
              \else\if#1S\relax
                \put(0,1){\Syasen{\LB\RT}}%
                \put(0,-1){\Syasen{\LB\RT}}%
              \else
                \Syasen{\LB\RT}%
              \fi\fi\fi\fi\fi
            }%
          \end{picture}%
        }}%
    }%
   \fi%
}}%
%%
%%  \Teisei[#1](#2)#3[#4]#5<#6>
%%            #1: 線の引き方についてのオプション引数で，
%%                s : 斜線（／） [デフォルト]
%%                r : 斜線（＼）
%%                h : 横線
%%                d : 横二本線
%%            #2: 線の色
%%            #3: 線を引く対象
%%            #4: 訂正後の文字位置
%%                   r = 右上 (=tr=rt)（デフォルト）
%%                   l = 左上 (=tl=lt)
%%                   t = 上
%%                   b = 下
%%                   rb=br=右下
%%                   lb=bl=左下
%%            #5: 訂正後の文字列 (scriptstyle)
%%            #6: 斜線の位置を修正するベクトル
%%
\def\Teisei{%
    \@ifnextchar[{\@Teisei}{\@Teisei[s]}}%
\def\@Teisei[#1]{%
    \@ifnextchar({\@Teisei@[#1]}{\@Teisei[#1](\empty)}}%
\def\@Teisei@[#1](#2)#3{%
  \@ifnextchar[{\@@Teisei[#1](#2){#3}}{\@@Teisei[#1](#2){#3}[r]}}%
\def\@@Teisei[#1](#2)#3[#4]#5{\@ifnextchar<{\@@@Teisei[#1](#2){#3}[#4]{#5}}{%
  \@@@Teisei[#1](#2){#3}[#4]{#5}<\empty>}}%
\def\@@@Teisei[#1](#2)#3[#4]#5<#6>{{%
    \edef\mozi@iti{0}%
%                           4  0  2
%                            {#3}%
%                           5  1  3
    \expandafter\@tfor\expandafter\@c\expandafter:\expandafter=#4%
    \do {\if r\@c\IAdd\mozi@iti{2}\mozi@iti\else
        \if l\@c\IAdd\mozi@iti{4}\mozi@iti\else
        \if b\@c\IAdd\mozi@iti{1}\mozi@iti\fi\fi\fi}%
    \ifx\empty#5\teisei[#1](#2){#3}{}<#6>\else%
    \ifcase\mozi@iti\overset{#5}{\teisei[#1](#2){#3}<#6>\relax}%
    \or\underset{#5}{\teisei[#1](#2){#3}<#6>\relax}%
    \or{\teisei[#1](#2){#3}<#6>\relax}^{\,{#5}}%
    \or{\teisei[#1](#2){#3}<#6>\relax}_{\,{#5}}%
    \or{}^{#5}{\teisei[#1](#2){#3}<#6>\relax}%
    \or{}_{#5}{\teisei[#1](#2){#3}<#6>\relax}\fi
    \fi
}}%
%
\define@key{emP}{teisei}{\EMedef\teisei@moziretu{#1}}%
\define@key{emP}{correct}{\EMedef\teisei@moziretu{#1}}%
\define@key{emP}{houkou}{%
  \edef\syasen@muki{#1}%
  \if #1b\edef\syasen@muki{r}%
  \fi
}%
\define@key{emP}{direction}{%
  \edef\syasen@muki{#1}%
  \if #1b\edef\syasen@muki{r}%
  \fi
}%
%
\def\emcancel{\begingroup
  \edef\iro@{\empty}%
  \edef\syasen@muki{s}%
  \edef\teisei@moziretu{\empty}%
  \def\d@LT{(0,0)}%
  \def\d@LB{(0,0)}%
  \def\d@RT{(0,0)}%
  \def\d@RB{(0,0)}%
  \@ifnextchar<{\t@eisei}{\t@@eisei}}%
\def\t@eisei<#1>{\ifx\empty #1\else\setkeys{emP}{#1}\fi\t@@eisei}%
\def\t@@eisei#1{\unitlength\p@
  \ifx\empty\teisei@moziretu\relax
    \t@@eisei@sub{#1}%
  \else
    \ifmmode\setbox1\hbox{$\teisei@moziretu$}\else
      \setbox1\hbox{\teisei@moziretu}\fi
    {\ensuremath{\stackrel{\box1}{\t@@eisei@sub{#1}}}}%
  \fi
  \endgroup\ignorespaces
}%
\def\embcancel{\@ifnextchar<{\@embcancel}{\@embcancel<\empty>}}%
\def\@embcancel<#1>#2{%
  \ifx\empty #1\relax
    \emcancel<direction=b>{#2}%
  \else
    \emcancel<direction=b,#1>{#2}%
  \fi
}%
%
\def\t@@eisei@sub#1{\unitlength\p@
  \ifmmode\setbox\EM@boxa\hbox{$#1$}\else\setbox\EM@boxa\hbox{#1}\fi
  \edef\teisei@w{\strip@pt\wd\EM@boxa}%
  \edef\teisei@h{\strip@pt\ht\EM@boxa}%
  \edef\teisei@d{\strip@pt\dp\EM@boxa}%
  \if\syasen@muki h\relax
      \setlength{\templa}{\ht\EM@boxa-\dp\EM@boxa}\divide\templa by 2\relax
      \edef\LT{(0,\strip@pt\templa)}%
      \edef\LB{(0,\strip@pt\templa)}%
      \edef\RT{(\strip@pt\wd\EM@boxa,\strip@pt\templa)}%
      \edef\RB{(\strip@pt\wd\EM@boxa,\strip@pt\templa)}%
  \else\if\syasen@muki d\relax
      \setlength{\templa}{\ht\EM@boxa-\dp\EM@boxa}\divide\templa by 2\relax
      \setlength{\templb}{\templa}\addtolength{\templb}{-0.8pt}%
      \setlength{\templc}{\templa}\addtolength{\templc}{1.2pt}%
      \edef\LT{(0,\strip@pt\templc)}%
      \edef\RT{(\strip@pt\wd\EM@boxa,\strip@pt\templc)}%
      \edef\LB{(0,\strip@pt\templb)}%
      \edef\RB{(\strip@pt\wd\EM@boxa,\strip@pt\templb)}%
  \else
      \edef\LT{(0,\strip@pt\ht\EM@boxa)}%
      \edef\LB{(0,-\strip@pt\dp\EM@boxa)}%
      \edef\RT{(\strip@pt\wd\EM@boxa,\strip@pt\ht\EM@boxa)}%
      \edef\RB{(\strip@pt\wd\EM@boxa,-\strip@pt\dp\EM@boxa)}%
  \fi\fi
  \Addvecself\LT\d@LT
  \Addvecself\LB\d@LB
  \Addvecself\RT\d@RT
  \Addvecself\RB\d@RB
  \leavevmode\box\EM@boxa\relax
  \ifthenelse{\equal{\iro@}{white}}{}{%
        \begin{picture}(0,0)%
          \put(-\teisei@w,0){%
            \ifx\empty\iro@\else\@iro{\iro@}\fi%
            \if\syasen@muki r\relax
              \Syasen{\LT\RB}%
            \else\if\syasen@muki h\relax
              \Syasen{\LT\RT}%
            \else\if\syasen@muki H\relax
              \Syasen{\LT\RT}%
              \Syasen{\LB\RB}%
            \else\if\syasen@muki x\relax
              \Syasen{\LB\RT}%
              \Syasen{\LT\RB}%
            \else\if\syasen@muki S\relax
              \put(0,1){\Syasen{\LB\RT}}%
              \put(0,-1){\Syasen{\LB\RT}}%
            \else
              \Syasen{\LB\RT}%
            \fi\fi\fi\fi\fi
          }%
        \end{picture}%
  }%
}%
%
\def\emCancel{\begingroup
  \edef\iro@{\empty}%
  \edef\syasen@muki{s}%
  \edef\teisei@moziretu{\empty}%
  \edef\mozi@iti{2}%
  \define@key{emP}{moziiti}{%
%                           4  0  2
%                            {#3}%
%                           5  1  3
    \edef\mozi@iti{0}%
    \expandafter\@tfor\expandafter\@c\expandafter:\expandafter=##1%
    \do {\if r\@c\IAdd\mozi@iti{2}\mozi@iti\else
        \if l\@c\IAdd\mozi@iti{4}\mozi@iti\else
        \if b\@c\IAdd\mozi@iti{1}\mozi@iti\fi\fi\fi}%
  }%
  \define@key{emP}{pos}{%
%                           4  0  2
%                            {#3}%
%                           5  1  3
    \edef\mozi@iti{0}%
    \expandafter\@tfor\expandafter\@c\expandafter:\expandafter=##1%
    \do {\if r\@c\IAdd\mozi@iti{2}\mozi@iti\else
        \if l\@c\IAdd\mozi@iti{4}\mozi@iti\else
        \if b\@c\IAdd\mozi@iti{1}\mozi@iti\fi\fi\fi}%
  }%
  \def\d@LT{(0,0)}%
  \def\d@LB{(0,0)}%
  \def\d@RT{(0,0)}%
  \def\d@RB{(0,0)}%
  \@ifnextchar<{\T@eisei}{\T@@eisei}}%
\def\T@eisei<#1>{\ifx\empty #1\else\setkeys{emP}{#1}\fi\T@@eisei}%
\def\T@@eisei#1#2{\unitlength\p@
    \ifx#2\t@@eisei@sub{#1}\else%
    \ifcase\mozi@iti\overset{#2}{\t@@eisei@sub{#1}}%
    \or\underset{#2}{\t@@eisei@sub{#1}}%
    \or{\t@@eisei@sub{#1}}^{\,{#2}}%
    \or{\t@@eisei@sub{#1}}_{\,{#2}}%
    \or{}^{#2}{\t@@eisei@sub{#1}}%
    \or{}_{#2}{\t@@eisei@sub{#1}}%
    \fi
\endgroup
}%
%
% 約分表示
%
\def\emreducefrac{\@ifnextchar<{\@emreducefrac}{\@emreducefrac<\empty>}}%
\def\@emreducefrac<#1>{\@ifnextchar<{\@@emreducefrac<#1>}{%
  \@@emreducefrac<#1><#1>}}%
\def\@@emreducefrac<#1><#2>#3#4{%
  \IYakubun{#3}{#4}\rdf@a\rdf@b
  \ifthenelse{\equal{#1}{\empty}}{%
    \bunsuu{\emCancel<pos=t>{#3}\rdf@a}{\emCancel<pos=b>{#4}\rdf@b}%
  }{%
    \bunsuu{\emCancel<#1>{#3}\rdf@a}{\emCancel<#2>{#4}\rdf@b}%
  }%
}
\let\reducefrac\emreducefrac
%
% \rotatebox を利用して斜線を引く
%
\def\rotateline(#1,#2)(#3,#4){%
  \Subvec{(#3,#4)}{(#1,#2)}\rotateln@v
  \Argvec\rotateln@v\rotateln@arg
  \Absvec\rotateln@v\rotateln@len
  \ifdim\rotateln@arg\p@=\z@
    \put(#1,#2){\vrule \@height \@halfwidth \@depth \@halfwidth 
      \@width \rotateln@len\unitlength}%
  \else
%    \put(#1,#2){\rotatebox{\rotateln@arg}{%
%      \vrule \@height \@halfwidth \@depth \@halfwidth 
%        \@width \rotateln@len\unitlength}}%
    \put(#1,#2){\rotatebox{\rotateln@arg}{\smash{\hbox to \z@{%
      \vrule \@height \@halfwidth \@depth \@halfwidth 
        \@width \rotateln@len\unitlength}}}}%
  \fi
}%
\def\Rotateline{\@ifnextchar<{\@Rotateline}{\@Rotateline<\empty>}}%
\def\@Rotateline<#1>#2{{%
  \ifx\empty #1\else\setkeys{emP}{#1}\fi
  \ifx\empty\iro@\else\@iro{\iro@}\fi
  \edef\Rotateline@tmp{#2}\expandafter\rotateline\Rotateline@tmp
}}%
\let\em@syasen\rotateline
\let\em@Syasen\Rotateline
\let\Syasen\Rotateline
%
\def\nullRotateline#1{\relax}%
%
%
\def\phLRarrow{\@ifnextchar<{\@phLRarrow}{\@phLRarrow<\empty>}}%
\def\@phLRarrow<#1>#2#3{\mathrel{{%
  \edef\ph@LR@w{2}%
  \edef\ph@LR@d{.1}%
  \edef\ph@LR@h{.4}%
  \setbox0=\hbox{\ensuremath{\scriptstyle #2}}%
  \setlength{\@tempdima}{\ht0+\dp0+\ph@LR@h em+2pt}%
  \setbox0=\hbox{\ensuremath{\scriptstyle #3}}%
  \setlength{\@tempdimb}{\ht0+\dp0-\ph@LR@d em+2pt}%
  \vrule width \z@ height \@tempdima depth \@tempdimb
  \begin{zahyou*}[ul=1em](0,2)(0,1)
    \tenretu*{ph@LR@A(0,\ph@LR@h);ph@LR@B(\ph@LR@w,\ph@LR@h);ph@LR@C(0,\ph@LR@d);ph@LR@D(\ph@LR@w,\ph@LR@d)}%
    \Tyuuten\ph@LR@A\ph@LR@B\ph@LR@AB
    \Tyuuten\ph@LR@C\ph@LR@D\ph@LR@CD
%
    \Put\ph@LR@AB(0,2pt)[b]{\ensuremath{\scriptstyle #2}}%
    \Put\ph@LR@CD(0,-2pt)[t]{\ensuremath{\scriptstyle #3}}%
    \Drawline<yazirusi=a>{\ph@LR@A\ph@LR@B}%
    \Drawline<yazirusi=r>{\ph@LR@C\ph@LR@D}%
  \end{zahyou*}}}%
}%
%
\def\emGyakuSankaku#1{%
  \hskip.02em\relax
  \begin{picture}(0,0)\relax
  \begin{zahyou*}[ul=1.05\zw,haiti=o](0,1)(-.15,.85)%
    \emPaint<nuriiro=white,border>{(0,.85)(1,.85)(.5,-.15)}%
  \end{zahyou*}%
  \end{picture}%
\@ifundefined{setdash}{}{\setdash{}}%
  \makebox[1.05\zw][c]{$\scriptstyle\text{#1}$}% size を ul と揃える
  \hskip.02em\relax
}%
\def\emSankaku{\@ifnextchar<{\@emSankaku}{\@emSankaku<\empty>}}%
\def\@emSankaku<#1>#2{{%
  \define@key{emP}{size}{\edef\emS@size{##1}}%
  \ifx\empty#1
    \edef\emS@size{1.05\zw}%
  \else
    \setkeys{emP}{#1}%
  \fi
  \ifx\empty#1
  \else
    \ifthenelse{\equal\emS@size{*}}{%
    \setbox0=\hbox{$\scriptstyle\text{#2}$}%
    \@tempdima=1.5\wd0
    \edef\emS@size{\the\@tempdima}%
    \vrule height .85\@tempdima depth .15\@tempdima width\z@
%\typeout{emSankaku: size=\emS@size}%\ssss
    }{%
    \@tempdima\emS@size
    \vrule height .85\@tempdima depth .15\@tempdima width\z@
    }%
  \fi
  \begin{picture}(0,0)\relax
  \hskip.02em\relax
  \begin{zahyou*}[ul=\emS@size,haiti=o](0,1)(-.15,.85)%
%    \Strlen{#1}\emSankaku@n
    \emPaint<nuriiro=white,border>{(0,-.15)(1,-.15)(.5,.85)}%
  \end{zahyou*}%
  \end{picture}%
\@ifundefined{setdash}{}{\setdash{}}%
  \makebox[\emS@size][c]{$\scriptstyle\text{#2}$}% size を ul と揃える
  \hskip.02em\relax
}}%
%
\def\emMaruSankaku#1{%
  \hskip.02em\relax
  \begin{zahyou*}[ul=1\zw](0,1)(0,1)
    \Strlen{#1}\emSankaku@n
    \ifnum\emSankaku@n>\@ne
      \Put{(.5,.333333)}(0,-1pt)[c]{$\scriptscriptstyle\text{#1}$}%
    \else
      \Put{(.5,.333333)}(0,0)[c]{$\scriptstyle\text{#1}$}%
    \fi
    \ovalTakakkei{.1\zw}{(0,0)(1,0)(.5,1)}%
  \end{zahyou*}%
  \hskip.02em\relax
}%
\def\emMaruGyakuSankaku#1{%
  \hskip.02em\relax
  \begin{zahyou*}[ul=1\zw](0,1)(0,1)
    \Strlen{#1}\emSankaku@n
    \ifnum\emSankaku@n>\@ne
      \Put{(.5,.666667)}(0,1pt)[c]{$\scriptscriptstyle\text{#1}$}%
    \else
      \Put{(.5,.666667)}(0,0)[c]{$\scriptstyle\text{#1}$}%
    \fi
    \ovalTakakkei{.1\zw}{(0,1)(.5,0)(1,1)}%
  \end{zahyou*}%
  \hskip.02em\relax
}%
%
\def\showGgrid{%
  \begin{picture}(0,0)%
  \begin{zahyou}[ul=10bp](0,40)(0,50)
    \zahyouMemori[g]
  \end{zahyou}\relax
  \end{picture}\ignorespaces}%
%
% フォント
%
\def\heikousihenkei{\@ifnextchar[{\@heikousihenkei}{\@heikousihenkei[1]}}
\def\@heikousihenkei[#1]{{% 平行四辺形 epic が必要
  \unitlength=.11ex\relax
  \unitlength=#1\unitlength
  \begin{picture}(17,12)%
%    \tenretu*{HS@A(1,2);HS@B(11,2);HS@C(16,11);HS@D(6,11)}%
    \tenretu*{HS@A(1,0);HS@B(11,0);HS@C(16,11);HS@D(6,11)}%
    \@tempdima=.008ex\relax
    \edef\HS@l{\strip@pt\@tempdima}%
    \Subvec\HS@C\HS@A\HS@AC\Mulvec\HS@l\HS@AC\HS@AC
    \Subvec\HS@D\HS@B\HS@BD\Mulvec\HS@l\HS@BD\HS@BD
    \Addvec\HS@A\HS@AC\HS@AA
    \Addvec\HS@B\HS@BD\HS@BB
    \Subvec\HS@C\HS@AC\HS@CC
    \Subvec\HS@D\HS@BD\HS@DD
    \Nuritubusi[\Nurizen]{\HS@A\HS@B\HS@C\HS@D\HS@A}%
    \Nuritubusi[0]{\HS@AA\HS@BB\HS@CC\HS@DD\HS@AA}%
    \Drawline{\HS@A\HS@B\HS@C\HS@D\HS@A}%
    \Drawline{\HS@AA\HS@BB\HS@CC\HS@DD\HS@AA}%
  \end{picture}}}%
%
% 一般の四角形を表す記号
\def\sikakkei{{\unitlength=.11ex\relax
  \begin{picture}(17,12)%
    \allinethickness{.1ex}%
    \drawline(1,2)(5,9)(12,12)(16,2)(1,2)%
  \end{picture}}}%
%
% 摂氏・華氏
%
\def\emKasi{%
\mbox{%
\kern.35\zw\relax
\begin{zahyou*}[ul=.2\zw](0,1)(0,1)
  \En{(.5,3.2)}{.5}%
\end{zahyou*}%
\resizebox{.68\zw}{\height}{F}%
}}%
\def\emSessi{%
\mbox{%
\kern.35\zw\relax
\begin{zahyou*}[ul=.2\zw](0,1)(0,1)
  \En{(.5,3.2)}{.5}%
\end{zahyou*}%
\resizebox{.68\zw}{\height}{C}%
}}%
%
% ⊿記号
%\def\Deruta{{\unitlength=.11ex\relax
\DeclareRobustCommand\Deruta{{%
  \unitlength=.11ex\relax
  \@ifundefined{xunitlength}{}{%
    \xunitlength=.11ex\relax
    \yunitlength=.11ex\relax}%
\begin{picture}(17,17)%
\put(0,-.8){% BBS #12120
  \@tempdima=.005em\relax
%  \advance\@tempdima1.89pt\relax
  \advance\@tempdima1.2pt\relax
  \edef\Deruta@w{\strip@pt\@tempdima}%
  \Mul{.25}\Deruta@w\Deruta@ww
  \Add{1}\Deruta@w\Deruta@Ay
  \Mul{1.4142}\Deruta@ww\Deruta@wwii
  \Add\Deruta@Ay\Deruta@wwii\Deruta@Ax
  \edef\Deruta@A{(\Deruta@Ax,\Deruta@Ay)}%
  \Mul{.7683}\Deruta@w\Deruta@Bx
  \Sub{12}\Deruta@Bx\Deruta@Bx
  \edef\Deruta@B{(\Deruta@Bx,\Deruta@Ay)}%
  \Mul{3.881}\Deruta@w\Deruta@Cx
  \Add\Deruta@Cx\Deruta@wwii\Deruta@Cx
  \Mul{0.363636}\Deruta@Cx\Deruta@Cx
  \Sub{16}\Deruta@Cx\Deruta@Cx
  \Sub\Deruta@Cx\Deruta@wwii\Deruta@Cy
  \edef\Deruta@C{(\Deruta@Cx,\Deruta@Cy)}%
  \Nuritubusi[\Nurizen]{(1,1)(12,1)(16,16)(1,1)}%
  \Nuritubusi[0]{\Deruta@A\Deruta@B\Deruta@C\Deruta@A}%
  \allinethickness{0.2pt}\Drawline{(1,1)(12,1)(16,16)(1,1)}%
}%
\end{picture}}}%
%
\def\EMshowbox#1{{%
  \@ifundefined{color}{\errmessage{EMshowbox: you must loads color.sty}}{}%
  \setbox0=\hbox{#1}%
  \edef\showbox@w{\strip@pt\wd0}%
  \edef\showbox@h{\strip@pt\ht0}%
  \edef\showbox@d{\strip@pt\dp0}%
  \unitlength=\p@
  \begin{picture}(0,0)\relax
    \put(0,0){\drawline(0,\showbox@h)(0,-\showbox@d)(\showbox@w,-\showbox@d)
      (\showbox@w,\showbox@h)(0,\showbox@h)}\relax
    {\color{red}\put(0,0){\drawline(0,0)(\showbox@w,0)}}\relax
  \end{picture}#1\relax
}}%
\let\showbox\EMshowbox
%
\def\longrightleftarrows{\@ifnextchar[{\@longrightleftarrows}{\@longrightleftarrows[2]}}%
\def\@longrightleftarrows[#1]{\mathrel{\scalebox{#1}[1]{$\rightleftarrows$}}}%
%
\@ifundefined{allinethickness}{}{\let\linethickness\allinethickness}%
%
%
%
% 別名
\let\Put\emathPut
\let\kyokuTyoku\Rdef
\let\Sinsyuku\Muldef
\let\Kaiten\Rotdef
\let\kaiten\rotdef
%
% 暫定措置
%    \RequirePackage{emathPb}%
%    \RequirePackage{emathPg}%
%
% xymtex.sty との併用
%
\AtBeginDocument{%
  \@ifundefined{tetrahedral}{}{\let\Put@Direct\ltxput}%
%  \@ifundefined{@xscale}{\def\@xscale{1}\def\@yscale{1}}{}%
%  \@ifundefined{mline}{\let\mline\lline}{}%
  \let\mline\lline
  \@ifundefined{load@tenretu}{}{%
    \IfFileExists{HenMozi.sty}{\RequirePackage{HenMozi}}{}%
    \IfFileExists{Buntenretu.sty}{\RequirePackage{Buntenretu}}{}%
    \IfFileExists{LandLretu.sty}{\RequirePackage{LandLretu}}{}%
    \IfFileExists{CandCretu.sty}{\RequirePackage{CandCretu}}{}%
    \IfFileExists{Taisyoutenretu.sty}{\RequirePackage{Taisyoutenretu}}{}%
    \IfFileExists{Kaitenretu.sty}{\RequirePackage{Kaitenretu}}{}%
    \IfFileExists{Ptenretu.sty}{\RequirePackage{Ptenretu}}{}%
    \IfFileExists{Rtenretu.sty}{\RequirePackage{Rtenretu}}{}%
  }%
}%
%
\endinput
%
%
%
%
%
\xy@hosei
